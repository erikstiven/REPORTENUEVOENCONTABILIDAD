<?php

require_once('codigo_de_barras/barcode.inc.php');
//set_time_limit(3000);
//ini_set('memory_limit', '20000M');
require_once 'html2pdf_v4.03/html2pdf.class.php';

function aproxima_digitos($para_aprox_num, $num_calcular){
    if ($para_aprox_num == 10 || $para_aprox_num == 1) {
        $pow = pow($para_aprox_num, abs(-2));
        $num_calcular = round($num_calcular / $pow) * $pow;
    }else if ($para_aprox_num == 2) {
        $num_calcular = round(floatval($num_calcular), 1);
    }

    return $num_calcular;
}

function envio_correo_PC($rutaPdf = '', $clpv_nom_clpv = '', $minv_serial = '', $correo = '') {
    include_once(path(DIR_INCLUDE) . "class.phpmailer.php");
    include_once(path(DIR_INCLUDE) . "class.smtp.php");
    global $DSN_Ifx, $DSN;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idSucursal = $_SESSION['U_SUCURSAL'];

    $sqlEmpr = "select empr_nom_empr, empr_dir_empr from saeempr where empr_cod_empr = $idEmpresa";

    if ($oIfxA->Query($sqlEmpr)) {
        $compania = $oIfxA->f("empr_nom_empr");
        $dirMatriz = trim($oIfx->f('empr_dir_empr'));
    }
    $oIfxA->Free();

	$prfa_sub_prfa = 'ORDEN DE COMPRA';
	
    $mail = new PHPMailer();
    $mail->IsSMTP();
    $mail->Mailer 		= "smtp";	 
	$mail->Host 		= "secure.emailsrvr.com";
	$mail->Port 		= 465;
	$mail->SMTPSecure	= 'ssl';
	$mail->SMTPAuth   	= true;
	$mail->Username 	= "admin@davinciroses.com";
	$mail->Password 	= "Ffa6v&+URX";		
	$mail->From 		= "admin@davinciroses.com";
	$mail->FromName 	= "Orden de Compra";
    
    $mail->Subject 		= $prfa_sub_prfa . ' ' . $docu . ' No.' . $serial;
    $mail->AltBody 		= "ORDEN DE COMPRA";
    $mail->IsHTML(true);
    $mail->CharSet 		= 'UTF-8';

    $sHtml = "<div style='width: 900px;'>
                        <table style='width:850px;'> 
                            <tr>
                                <td>Estimado Proveedor,  a continuacion adjuntamos la Orden Compra:</td>
                            </tr>
                            <tr>
                                <td></td>
                            </tr>
                        </table>
                        <br><br>
                        <table style='width:850px;'>
                            <tr> 
                                <td>Atentamente,</td>
                            </tr> 
                            <tr>&nbsp;</tr>
                            <tr>&nbsp;</tr>
                            <tr>
                                <td style='font-weight: bold;'>$compania</td>
                            </tr>
                            <tr>&nbsp;</tr>
                            <tr>
                                <td style='font-weight: bold;'>$dirMatriz</td>
                            </tr>
							
							<tr>
                                <td style='font-weight: bold;'>Recibe un cordial saludo,</td>
                            </tr>
							
							<tr>
                                <td style='font-weight: bold;'>Ing. Lorena Olmedo</td>
                            </tr>
							
							<tr>
                                <td style='font-weight: bold;'>Jefe Administrativa</td>
                            </tr>
							
                        </table>
                    </div>";


    $mail->MsgHTML($sHtml);
	
	$mail->AddAddress($correo, "Proveedor");
	$mail->AddAddress('contabilidad@davinciroses.com', "Contabilidad");
	$mail->AddAddress('admin@davinciroses.com',  "Administracion");
							
							
    $mail->AddAttachment($rutaPdf, 'ORDENCOMPRA_'.$minv_serial . '.pdf');

    if (!$mail->Send())
        return "Error: " . $mail->ErrorInfo;
    else
        return 'Mail enviado!';
}
//ENVIO CORREO COMPRAS GENERAL

function correo_compras_general($copia, $correo, $mensaje, $area, $adjuntos, $pedido,$asunto){
    //Definiciones
        global $DSN,$DSN_Ifx;
        session_start();
    
        $oCon = new Dbo;
        $oCon->DSN = $DSN;
        $oCon->Conectar();

        $oIfx = new Dbo;
        $oIfx->DSN = $DSN_Ifx;
        $oIfx->Conectar();
    
        $idempresa = $_SESSION['U_EMPRESA'];
        $idsucursal = $_SESSION['U_SUCURSAL'];
    
    //DATOS DE LA EMPRESA
    
        $sqlema="select empr_token_api, empr_nom_empr, empr_ema_test, empr_ema_sn from saeempr where empr_cod_empr=$idempresa";
    
        $empr_api_toke=consulta_string($sqlema,'empr_token_api',$oCon,'');
        $nomb_empresa=consulta_string($sqlema,'empr_nom_empr',$oCon,'');
        //CORREO DE PRUEBAS
        $test=consulta_string($sqlema,'empr_ema_sn',$oCon,'');
        if($test=='S'){
            $correo_prueba=trim(consulta_string($sqlema,'empr_ema_test',$oCon,''));
            $correo=array();
            array_push($correo,$correo_prueba);
            $copia=$correo_prueba;
        }
    
        //PARAMETROS ENVIO DE CORREOS
    $ctrlcomp=0;
        $sqlcorreo = "select server, port, auth, 
        config_email.user, pass, ssltls, mail
        from comercial.config_email
        where id_empresa = $idempresa and id_tipo=20 limit 1";
    
        if ($oCon->Query($sqlcorreo)) {
            if ($oCon->NumFilas() > 0) {
                $host = $oCon->f('server');
                $port = $oCon->f('port');
                $smtpauth = $oCon->f('auth');
                $userid = $oCon->f('user');
                $smtpsecure = $oCon->f('ssltls');
                $mailenvio = $oCon->f('mail');
                $password = $oCon->f('pass');
                $ctrlcomp++;
    
            }
        }
        $oCon->Free();
    if($ctrlcomp==0){
      
        $sqlcorreo = "select server, port, auth, 
        config_email.user, pass, ssltls, mail
        from comercial.config_email
        where id_empresa = $idempresa and id_tipo=1 limit 1";
    
        if ($oCon->Query($sqlcorreo)) {
            if ($oCon->NumFilas() > 0) {
                $host = $oCon->f('server');
                $port = $oCon->f('port');
                $smtpauth = $oCon->f('auth');
                $userid = $oCon->f('user');
                $smtpsecure = $oCon->f('ssltls');
                $mailenvio = $oCon->f('mail');
                $password = $oCon->f('pass');
                
            }
        }
        $oCon->Free();

    }
    
        //ARRAY ARCHVOS ADJUNTOS
        $adj = array();
    
        if (file_exists($adjuntos)) {
            $archivo = file_get_contents($adjuntos);
            $archivo = array("name" => basename($adjuntos), "content" => base64_encode($archivo));
            array_push($adj, $archivo);
        }
    
        //CONSTRUCCION PARAMETROS WEB SERVICE
    
        $headers = array(
            "Content-Type:application/json",
            "Token-Api:$empr_api_toke"
        );
    
        $correocc = array(trim($copia));

         //CORREOS COPIA POR SUCURSAL
     $sql_correo = "select prfa_mail1, prfa_mail2, prfa_mail3 from saeprfa where prfa_cod_empr = $idempresa and prfa_cod_sucu=$idsucursal and prfa_est_prfa = 'S' and prfa_cod_prfa =20";
     if ($oIfx->Query($sql_correo)) {
         if ($oIfx->NumFilas() > 0) {
             $prfa_mail1 = $oIfx->f('prfa_mail1');
             $prfa_mail2 = $oIfx->f('prfa_mail2');
             $prfa_mail3 = $oIfx->f('prfa_mail3');

            if(!empty($prfa_mail1)){
                array_push( $correocc,$prfa_mail1);
            }
            if(!empty($prfa_mail2)){
                array_push( $correocc,$prfa_mail2);
            }
            if(!empty($prfa_mail3)){
                array_push( $correocc,$prfa_mail3);
            }

             
         }
     }
     $oIfx->Free();


        $smtp_server = "{$host}:{$port}";
    
        $data = array(
            "smtp_server" => $smtp_server,
            "secure_type" => $smtpsecure,
            "username" => $userid,
            "password" => $password,
            "from_address" => $mailenvio,
            "to_address" =>  $correo,
            "to_cc" =>  $correocc,
            "title" => "  $asunto $nomb_empresa",
            "content" => $mensaje,
            "attachments" => $adj
        );
    
    
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
        curl_setopt($ch, CURLOPT_URL, URL_JIREH_WS_CORREOS."/api/v1/correo/enviar");
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        $respuesta = curl_exec($ch);
        curl_close($ch);
        $resultado = json_decode($respuesta,true);
        $mensaje = $resultado["msg"];
        $enviado = $resultado["result"];
    
        foreach($correo as $cor){
    
            $destinatarios.=$cor.' ';
        }
    
        if($enviado == true){
            $msg="Mail enviado a: $destinatarios";
        }else{
            $msg="Error al enviar email: $mensaje";
        }
    
    
        return $msg;
    
    
    
    }

    
//ADJUNTOS COBROS VENTA MOVIO
function adjuntos_cobros($idcobro, $clpv){
    global $DSN, $DSN_Ifx;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo ();
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();


    $oReturn = new xajaxResponse();

    $idempresa 	= $_SESSION['U_EMPRESA'];
    $idsucursal = $_SESSION['U_SUCURSAL'];



  

    ////CARGA DE ADJUNTOS////
    $k=1;
    $cols='';
    $sqlpedi="select  gein_adj_gein, gein_usu_web, gein_cod_fpag from saegein where gein_num_gein=$idcobro and gein_cod_clpv=$clpv and gein_cod_empr= $idempresa group by 1,2,3";
    if ($oIfx->Query($sqlpedi)) {
        if ($oIfx->NumFilas() > 0) {

        
            do {
                $gein_adj_gein =  $oIfx->f('gein_adj_gein');
                $gein_usu_web  =  $oIfx->f('gein_usu_web');
                if(empty($gein_usu_web)){
                    $gein_usu_web  = 0;
                }

  

            if(!empty($gein_adj_gein)){

                $ruta="../../modulos/venta_movil_cobros_v2/adjuntos_cobros/$gein_usu_web/$gein_adj_gein";

                if (!file_exists($ruta)) {
                    $ruta="../../modulos/venta_movil_cobros/adjuntos_cobros/$gein_usu_web/$gein_adj_gein";
                }
                
                
                if(preg_match("/jpg|png|PNG|jpeg|gif/",$ruta)){

                    $logo='<div>
                <img src="'. $ruta .'" class="img img-responsive">
                </div>';

                    $cols .= '<tr>
                    <td> '.$k.'</td>
                    <td><a href="'. $ruta .'" target="_blank" >'.$logo.'</a></td>
                    </tr>';
                }
                else{

                    $logo='<div>
                    <a href="'. $ruta.'" target="_blank" >'.$gein_adj_gein.'</a>
                    </div>';

                    $cols .= '<tr>
                    <td> '.$k.'</td>
                    <td> '.$logo.'</td>
                    </tr>';

                }

                
            }
            else{

            }


                $k++;
            }while ($oIfx->SiguienteRegistro());
            
        }
        
    }
    $oIfx->Free();
if(!empty($cols)){

    $sHtml .= '<table class="table table-striped table-bordered table-hover table-condensed" style="width: 90%; margin-bottom: 0px;" align="center">';
    $sHtml .= '<tr>
    <td class="info" >No.</td>
    <td class="info">Archivo</td>
    </tr>';
    $sHtml .=$cols;
    $sHtml .='</table>';

}
else{
    $sHtml='<div align="center"><span><font color="red">SIN ADJUNTOS</font></span></div>';  
}
   

    $modal .= '<div class="modal-dialog modal-lg" >
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">ADJUNTOS - SOLICITUD NRO: '.$idcobro.'</h4>
            </div>
    <div class="modal-body">
    <div class="table-responsive">';

   
   $modal .= $sHtml;
    $modal .='</div></div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
             </div>';


    return $modal;
}


/// impresion BIOMETRICO
function  impresion_biometrico_indi_old($id_empresa, $empleado, $fec_ini, $fec_fin) {
    //Definiciones
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oCon = new Dbo;
    $oCon -> DSN = $DSN;
    $oCon -> Conectar();



    $oIfx = new Dbo;
    $oIfx -> DSN = $DSN_Ifx;
    $oIfx -> Conectar();

    $oIfxA = new Dbo;
    $oIfxA -> DSN = $DSN_Ifx;
    $oIfxA -> Conectar();


    $oIfxB = new Dbo;
    $oIfxB -> DSN = $DSN_Ifx;
    $oIfxB -> Conectar();


    $oIfxC = new Dbo;
    $oIfxC -> DSN = $DSN_Ifx;
    $oIfxC -> Conectar();

    $oIfxD = new Dbo;
    $oIfxD -> DSN = $DSN_Ifx;
    $oIfxD -> Conectar();

    $oReturn = new xajaxResponse();


    $nombre_archivo = 'REPORTE_BIOMETRICO'.$fec_ini.'_'.$fec_fin;

    $sql = "select empr_nom_empr, empr_path_logo, empr_dir_empr from saeempr where empr_cod_empr = $id_empresa ";
    $empr_nom  = consulta_string_func($sql, 'empr_nom_empr', $oIfxA, '');
    $empr_path_logo  = consulta_string_func($sql, 'empr_path_logo', $oIfxA, '');
    $empr_dir_empr  = consulta_string_func($sql, 'empr_dir_empr', $oIfxA, '');

    $sql="select empl_nom_empl, empl_ape_empl from saeempl where empl_cod_empl='$empleado'";
    $empl_nom_empl  = consulta_string_func($sql, 'empl_nom_empl', $oIfxA, '');
    $empl_ape_empl  = consulta_string_func($sql, 'empl_ape_empl', $oIfxA, '');

    $table_op .='<table >';
    $table_op .='<tr>	
                        <td class="fecha_letra" style="width: 100%;"> '.htmlentities($empr_nom).'</td>
                    </tr>
                    <tr>	
                        <td class="fecha_letra" style="width: 100%;"> '.htmlentities($empr_dir_empr).'</td>
                    </tr>
                    <tr>	
                        <td class="fecha_letra" style="width: 100%;" >REPORTE DE HORAS TRABAJADAS</td>
                    </tr>
                    
                    <tr>	
                        <td  class="fecha_letra" style="width: 100%;" >'.$empleado.'-'.($empl_nom_empl).' '.$empl_ape_empl.' </td>
                    </tr> ';

    $table_op .='</table><br><br>
    <table align="center" border="1" cellspacing="0" cellpadding="0" style="width: 100%; border:1px solid black; border-radius: 5px; font-size:12px;">
    <tr>
        <td style="width: 5%;" class="bg-primary">N</td>
        <td style="width: 10%;">FECHA</td>
        <td style="width: 10%;">ENTRADA</td>
        <td style="width: 10%;">SALIDA ALMUERZO</td>
        <td style="width: 10%;">ENTRADA ALMUERZO</td>
        <td style="width: 10%;">SALIDA</td>
        <td style="width: 12%;">HORAS TRABAJADAS</td>
        <td style="width: 10%;">HORAS ATRASO</td>
        <td style="width: 10%;">HORAS EXTRAS</td>
    
    </tr>';


    //// datos empleado
    $fec_ini = $fec_ini != '' ? "'".$fec_ini."'" : 'NULL';
    $fec_fin = $fec_fin != '' ? "'".$fec_fin."'" : 'NULL';
    


    $sql = "SELECT (DATE_PART('hour', HORA_FIN::time - HORA_INICIO::time)) as horas, fecha_inicio, hora_inicio, hora_fin, almuerzo_inicio, almuerzo_fin
            from comercial.datos_reloj
            where 
                empl_cod_empl ='$empleado' and tipo='P' and 
                fecha_inicio BETWEEN $fec_ini and $fec_fin  GROUP BY empl_cod_empl, fecha_inicio, hora_inicio, hora_fin, almuerzo_inicio, almuerzo_fin  ORDER BY fecha_inicio";

    if($oCon->Query($sql)){
        if($oCon->NumFilas()>0){

            $t_horas=0;
            $t_extra=0;
            $t_falta=0;
            $t_valor=0;
            do{
                $i++;
                $horas=0;
                $extra=0;
                $falta=0;
                $valor=$oCon->f('horas');
                list($anio,$mes,$dia)=explode("-",$oCon->f('fecha_inicio'));
                $dia_tmp = diaSemana($anio, $mes, $dia);
                $almu=$oCon->f('almuerzo_inicio');
                if($almu=='00:00:00'){
                    $almu = null;
                }
                if(empty($_SESSION['RRHH_FERIADOS'][$oCon->f('fecha_inicio')])){
                    if($dia_tmp<6){
                        if($valor>=8){
                            $horas=8;
                            if(!empty($almu)){

                                $extra=($valor-9);
                                if($extra<0){
                                    $extra=0;
                                }
                            }else{
                                $extra=($valor-8);
                                if($extra<0){
                                    $extra=0;
                                }
                            }

                        }
                        else{
                            $horas=$valor;
                            $falta=(8-$valor);
                        }
                    }

                    if($dia_tmp=='6'){
                        if($valor>=4){
                            $horas=4;
                            $extra=($valor-4);
                        }
                        else{
                            $horas=$valor;
                            $falta=(4-$valor);
                        }
                    }

                    if($dia_tmp>6){
                        $extra=$valor;
                    }

                }else{
                    $extra=$valor;
                }




                $t_horas+=$horas;
                $t_extra+=$extra;
                $t_falta+=$falta;
                $t_valor+=$valor;
                $table_op.='<tr>
							<td>'.$i.'</td>
							<td>'.$oCon->f('fecha_inicio').'</td>
							<td>'.$oCon->f('hora_inicio').'</td>
							<td>'.$oCon->f('almuerzo_inicio').'</td>
							<td>'.$oCon->f('almuerzo_fin').'</td>
							<td>'.$oCon->f('hora_fin').'</td>
							<td>'.$horas.'</td>
							<td>'.$falta.'</td>
							<td>'.$extra.'</td>
						
						
						</tr>';
                $_SESSION['RRHH_FECHAS_BIO'][$oCon->f('fecha_inicio')]=$oCon->f('fecha_inicio');
            }while($oCon->SiguienteRegistro());
            $table_op.='<tr>
							<td class="bg-primary"colspan="6">TOTAL</td>
							
							<td class="bg-primary">'.$t_horas.'</td>
							<td class="bg-primary">'.$t_falta.'</td>
							<td class="bg-primary">'.$t_extra.'</td>
						
							
						</tr>';
        }
    }
    $table_op.='</table>';
    $legend.='<br><br><br>
    <table style="width:100%; font-size:11px;" border="0" >
        <tr>
            
            <td style="width:40%;">
                    _____________________________________________<br><br>
                    '.($empl_nom_empl).' '.$empl_ape_empl.' '.$empleado.'
              

            </td>
            <td></td>
        </tr>
    </table>';
    $documento .= '<page backimgw="0%" backtop="0mm" backbottom="0mm" backleft="0mm" backright="0mm">';
    $documento .= $table_op;
    $documento .= $legend;
    $documento .= '</page>';




    $html2pdf = new HTML2PDF('P', 'A4', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;

    return $documento;
}


/// impresion BIOMETRICO
function  impresion_biometrico_indi($id_empresa, $empleado, $fec_ini, $fec_fin) {
    //Definiciones
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oCon = new Dbo;
    $oCon -> DSN = $DSN;
    $oCon -> Conectar();


    $oConA = new Dbo;
    $oConA -> DSN = $DSN;
    $oConA -> Conectar();



    $oIfx = new Dbo;
    $oIfx -> DSN = $DSN_Ifx;
    $oIfx -> Conectar();

    $oIfxA = new Dbo;
    $oIfxA -> DSN = $DSN_Ifx;
    $oIfxA -> Conectar();


    $oReturn = new xajaxResponse();


    $nombre_archivo = 'REPORTE_BIOMETRICO'.$fec_ini.'_'.$fec_fin;

    $sql = "select empr_nom_empr, empr_path_logo, empr_dir_empr from saeempr where empr_cod_empr = $id_empresa ";
    $empr_nom  = consulta_string_func($sql, 'empr_nom_empr', $oIfxA, '');
    $empr_path_logo  = consulta_string_func($sql, 'empr_path_logo', $oIfxA, '');
    $empr_dir_empr  = consulta_string_func($sql, 'empr_dir_empr', $oIfxA, '');

    $sql="select empl_nom_empl, empl_ape_empl from saeempl where empl_cod_empl='$empleado'";
    $empl_nom_empl  = consulta_string_func($sql, 'empl_nom_empl', $oIfxA, '');
    $empl_ape_empl  = consulta_string_func($sql, 'empl_ape_empl', $oIfxA, '');

    $table_op .='<table >';
    $table_op .='<tr>	
                        <td class="fecha_letra" style="width: 100%;"> '.htmlentities($empr_nom).'</td>
                    </tr>
                    <tr>	
                        <td class="fecha_letra" style="width: 100%;"> '.htmlentities($empr_dir_empr).'</td>
                    </tr>
                    <tr>	
                        <td class="fecha_letra" style="width: 100%;" >REPORTE DE HORAS TRABAJADAS</td>
                    </tr>
                    
                    <tr>	
                        <td  class="fecha_letra" style="width: 100%;" >'.$empleado.'-'.($empl_nom_empl).' '.$empl_ape_empl.' </td>
                    </tr> ';

    $table_op .='</table><br><br>
    <table align="center" border="1" cellspacing="0" cellpadding="0" style="width: 100%; border:1px solid black; border-radius: 5px; font-size:12px;">
    <tr>
        <td style="width: 5%;" class="bg-primary">N</td>
        <td style="width: 10%;">FECHA</td>
        <td style="width: 10%;">ENTRADA</td>
        <td style="width: 10%;">SALIDA ALMUERZO</td>
        <td style="width: 10%;">ENTRADA ALMUERZO</td>
        <td style="width: 10%;">SALIDA</td>
        <td style="width: 12%;">HORAS TRABAJADAS</td>
        <td style="width: 10%;">HORAS ATRASO</td>
        <td style="width: 10%;">HORAS EXTRAS</td>
    
    </tr>';


    //// datos empleado
    $fec_ini = $fec_ini != '' ? "'".$fec_ini."'" : 'NULL';
    $fec_fin = $fec_fin != '' ? "'".$fec_fin."'" : 'NULL';
    




            $sql="select id_datos_reloj, empl_cod_empl, fecha_inicio,turno_id, DATE_PART( 'hour', HORA_FIN:: TIME - HORA_INICIO :: TIME ) * 60 + DATE_PART( 'minute', HORA_FIN :: TIME - HORA_INICIO :: TIME ) AS ran1, 
            DATE_PART( 'hour',  ALMUERZO_FIN:: TIME - ALMUERZO_INICIO :: TIME ) * 60 + DATE_PART( 'minute', ALMUERZO_FIN :: TIME - ALMUERZO_INICIO :: TIME ) AS almuerzo,
            hora_inicio, hora_fin, almuerzo_inicio, almuerzo_fin
            FROM comercial.datos_reloj where (tipo='P' or tipo='A') AND EMPL_COD_EMPL='$empleado' AND 
            fecha_inicio BETWEEN $fec_ini and $fec_fin GROUP BY 1,2,3,4,5,6,7,8,9,10  ORDER BY fecha_inicio, id_datos_reloj;";

    if($oCon->Query($sql)){
        if($oCon->NumFilas()>0){

            $t_horas=0;
            $t_extra=0;
            $t_falta=0;
            $t_valor=0;
            do{
                $i++;
                $horas_trabajadas=0;
				$horas_extras=0;
				$horas_faltas=0;//CONSULTA POR FECHA 
				////////////////////////////
				

				
							$turno_id= $oCon->f('turno_id');

                          //VERIFICA SI EL TURNO INCLUYE ALMUERZO
							$sqlal="select DATE_PART( 'HOUR',  TIME_ALM:: TIME )*60   +  DATE_PART( 'minute',  TIME_ALM:: TIME ) as tiempo_alm from comercial.turnos where turno_id=$turno_id";
							$tiempo_al=consulta_string($sqlal,'tiempo_alm',$oConA,0);
			
							//TIEMPO REAL ALMUERZO EMPLEADO 
							$almuerzo_empleado=$oCon->f('almuerzo');

							//HORAS TRABAJADAS REALES EMPLEADO
							$horas_empl= $oCon->f('ran1');
							if(empty($horas_empl)){
								$horas_empl=0;
							}

							//VALIDACION HORAS PASADAS LAS 23:59
							if($horas_empl<0){
								$horas_empl=1440+$horas_empl;
							}
							//RESTAMOS EL TIEMPO DEL ALMUERZO CONFIGURADO EN EL TURNO
							if($horas_empl>0){
								$horas_empl=$horas_empl-$tiempo_al;		
							}
								
			
							//CONSULTA LA CANTIIDAD DE HORAS EN BASE AL TURNO TURNO
							$sqltur="select  DATE_PART( 'hour',  FIN:: TIME - INICIO :: TIME ) * 60 + DATE_PART( 'minute', FIN :: TIME - INICIO :: TIME ) AS horas_turno 
							from comercial.turnos where turno_id= $turno_id";

								$horas_turno=consulta_string($sqltur,'horas_turno',$oConA,0);
								//VALIDACION HORAS PASADAS LAS 23:59
								if($horas_turno<0){
									$horas_turno=1440+$horas_turno;
								}
								//RESTAMOS EL TIEMPO DEL ALMUERZO CONFIGURADO EN EL TURNO

								$horas_turno=$horas_turno-$tiempo_al;

								$horas_turno_hh=floor($horas_turno/60);
								$horas_turno_min=$horas_turno-$horas_turno_hh*60;
										

										//VALIDACION HORAS FALTAS
			
										if($horas_empl<$horas_turno){

											$hfalta=$horas_turno-$horas_empl;
											$horas_faltas+=$hfalta;
											
											$color='style="background:#8f8f8f"';
										}
										else{
											$color='';
										}

										
										
										//CALCULO HORAS EXTRAS
										$textra=0;
										if($horas_empl>$horas_turno){
										
											$textra=floor(($horas_empl-$horas_turno)/60);
											$n=round(($horas_empl-$horas_turno)/60,2);
											$hextra = intval(($n-$textra)*60);
											
											if($hextra>=30){
												$textra++;
											}
											$horas_empl=$horas_turno;
											$minutos_horas_trabajadas=$horas_turno_min;
										}
									
										else{
											$th_empl=floor($horas_empl/60);
											$minutos_horas_trabajadas=$horas_empl-($th_empl*60);
										}

										
										
										
										$horas_extras+=$textra;
										$t_extra+=$horas_extras;

										$t_horas+=$horas_empl;
										
										$t_falta+=$horas_faltas;
										$minutos_falta=$horas_faltas-(floor($horas_faltas/60)*60);

										$horas_faltas=floor($horas_faltas/60);
										$horas_trabajadas+=floor(($horas_empl/60));


                $table_op.='<tr>
							<td>'.$i.'</td>
							<td>'.$oCon->f('fecha_inicio').'</td>
							<td>'.$oCon->f('hora_inicio').'</td>
							<td>'.$oCon->f('almuerzo_inicio').'</td>
							<td>'.$oCon->f('almuerzo_fin').'</td>
							<td>'.$oCon->f('hora_fin').'</td>
							<td>'.$horas_trabajadas.'</td>
							<td>'.$horas_faltas.'</td>
							<td>'.$textra.'</td>
						
						
						</tr>';
                $_SESSION['RRHH_FECHAS_BIO'][$oCon->f('id_datos_reloj')]=$oCon->f('id_datos_reloj');
            }while($oCon->SiguienteRegistro());

            $horas_trabajadas_hh=floor($t_horas/60);
						

						$horas_falta_hh=floor($t_falta/60);
						

            $table_op.='<tr>
							<td class="bg-primary"colspan="6">TOTAL</td>
							
							<td class="bg-primary">'.$horas_trabajadas_hh.'</td>
							<td class="bg-primary">'.$horas_falta_hh.'</td>
							<td class="bg-primary">'.$t_extra.'</td>
						
							
						</tr>';
        }
    }
    $table_op.='</table>';
    $legend.='<br><br><br>
    <table style="width:100%; font-size:11px;" border="0" >
        <tr>
            
            <td style="width:40%;">
                    _____________________________________________<br><br>
                    '.($empl_nom_empl).' '.$empl_ape_empl.' '.$empleado.'
              

            </td>
            <td></td>
        </tr>
    </table>';
    $documento .= '<page backimgw="0%" backtop="0mm" backbottom="0mm" backleft="0mm" backright="0mm">';
    $documento .= $table_op;
    $documento .= $legend;
    $documento .= '</page>';




    $html2pdf = new HTML2PDF('P', 'A4', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;

    return $documento;
}
function eliminar_tildes($cadena){

    //Codificamos la cadena en formato utf8 en caso de que nos de errores
    $cadena = utf8_encode($cadena);

    //Ahora reemplazamos las letras
    $cadena = str_replace(
        array('á', 'à', 'ä', 'â', 'ª', 'Á', 'À', 'Â', 'Ä'),
        array('a', 'a', 'a', 'a', 'a', 'A', 'A', 'A', 'A'),
        $cadena
    );

    $cadena = str_replace(
        array('é', 'è', 'ë', 'ê', 'É', 'È', 'Ê', 'Ë'),
        array('e', 'e', 'e', 'e', 'E', 'E', 'E', 'E'),
        $cadena );

    $cadena = str_replace(
        array('í', 'ì', 'ï', 'î', 'Í', 'Ì', 'Ï', 'Î'),
        array('i', 'i', 'i', 'i', 'I', 'I', 'I', 'I'),
        $cadena );

    $cadena = str_replace(
        array('ó', 'ò', 'ö', 'ô', 'Ó', 'Ò', 'Ö', 'Ô'),
        array('o', 'o', 'o', 'o', 'O', 'O', 'O', 'O'),
        $cadena );

    $cadena = str_replace(
        array('ú', 'ù', 'ü', 'û', 'Ú', 'Ù', 'Û', 'Ü'),
        array('u', 'u', 'u', 'u', 'U', 'U', 'U', 'U'),
        $cadena );

    $cadena = str_replace(
        array('ñ', 'Ñ', 'ç', 'Ç'),
        array('n', 'N', 'c', 'C'),
        $cadena
    );

    return $cadena;
}

function ultimo_costo_func_2($empresa, $sucursal, $cod_prod, $bodega, $fecha, $Conexion) {
    $sql = "select prbo_uco_prod from saeprbo  where prbo_cod_empr = $empresa and
				prbo_cod_bode = $bodega and
				prbo_cod_prod = '$cod_prod' ";
    //echo $sql;exit;
    $costo = 0;
    $costo = consulta_string_func($sql, 'prbo_uco_prod', $Conexion, 0);
    if ($costo < 0) {
        $costo = 0;
    }
    return $costo;
}


// MODAL CORREOS SOLICITUDES DE COMPRA Y PAGO

function correo_compras_pago(){
    global $DSN, $DSN_Ifx;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo ();
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $fu = new Formulario;
    $fu->DSN = $DSN;


    $idempresa  = $_SESSION['U_EMPRESA'];
    $idsucursal = $_SESSION['U_SUCURSAL'];

    $oReturn = new xajaxResponse();


    //ADJUNTOS
    $fu->AgregarCampoArchivo('archivoCorreo', 'Archivo|LEFT', false, '', 100, 100, '');

    $sHtml  = '<div id="mostrarmodalcorreo" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">ENVIO - CORREOS</h4>
            </div>
            <div class="modal-body">';

    $sHtml .= '
	
      <div class="col-md-12">
      <div class="form-row">

      <div class="col-md-10">
              <label class="control-label" for="correo">* Correos:</label>                                
                 

                  <input type="text" class="form-control input-sm" placeholder="PARA VARIOS CORREOS SEPARE CON (;)" id="correo" 
                      name="correo"  onkeyup="form1.correo.value=form1.correo.value.toUpperCase();"/>
                               
          </div>
       </div>
       </div>

       <div class="col-md-12">
      <div class="form-row">

          <div class="col-md-8">
              <label class="control-label" for="asunto">* Asunto:</label>    
                  <input type="text" class="form-control input-sm" placeholder="ESCRIBA EL ASUNTO" id="asunto" 
                  name="asunto"  onkeyup="form1.asunto.value=form1.asunto.value.toUpperCase();"/>
    
                                               
          </div>

        </div>
        </div>


        <div class="col-md-12">
        <div class="form-row">


          <div class="col-md-8">
              <label class="control-label" for="mensaje">* Mensaje:</label>                                
                  

                  <textarea name="mensaje" class="form-control input-sm" id="mensaje" rows="5" cols="50" placeholder="ESCRIBA EL MENSAJE"></textarea>
                      
                                       
          </div>

          </div>
          </div>

          <div class="col-md-12">
          <div class="form-row">


          <div class="col-md-12">
          <label class="control-label" for="archivoCorreo"> Adjuntos</label>                                
              <div class="input-group">

              '.$fu->ObjetoHtml('archivoCorreo').'    
              </div>                                
        </div>

        

        </div>
        </div>';

    $sHtml .= '          </div>
                          <div class="modal-footer">
                          
                              <button type="button" class="btn btn-primary" onclick="enviar_correo();">Enviar</button>
                              <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
                             
                          </div>
                      </div>
                  </div>
               </div>';


    return $sHtml;


}

//SOLICITUD DE COMPRA - PAGOS
function detalle_sol_compras($codpgs){

    global $DSN, $DSN_Ifx;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo();
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();



    //SELECCION NUMERO DE FACTURA

    $sql="select dpgs_ncom_dpgs,dpgs_pruc_dpgs from saedpgs where dpgs_cod_pgs=$codpgs";
    $ncom=consulta_string($sql,'dpgs_ncom_dpgs',$oCon,0);
    $ruc=consulta_string($sql,'dpgs_pruc_dpgs',$oCon,0);

    //CODIGO DEL CLPV
    $sql="select clpv_cod_clpv from saeclpv where clpv_ruc_clpv='$ruc'";
    $clpv=consulta_string($sql,'clpv_cod_clpv',$oCon,0);

    //CODIGO ASTO
    $sql="select dmcp_cod_asto from saedmcp where clpv_cod_clpv=$clpv and dmcp_num_fac='$ncom'";
    $asto=consulta_string($sql,'dmcp_cod_asto',$oCon,0);


    //CODIGO DE LA SOLICITUD DE COMPRA SAEMINV

    $sql="select minv_cod_pedi from saeminv where minv_comp_cont='$asto'";

    $cod_pedi=consulta_string($sql,'minv_cod_pedi',$oCon,0);

    if($cod_pedi==0){
        $sql="select fprv_cod_pedi from saefprv where fprv_cod_asto='$asto'";
        $cod_pedi=consulta_string($sql,'fprv_cod_pedi',$oCon,0);
    }



    if($cod_pedi!=0){
        $sesion=session_id();
        $frame='<iframe src="../historial_pedidos/historial.php?sesionId='.$sesion.'&mOp=true&mVer=false&codsol='.$cod_pedi.'" frameborder="0" style="overflow:hidden;height:100%;width:100%" height="100%" width="100%"></iframe>';
    }
    else{

        $frame='<div align="center"><span><font color="red">PAGO SIN SOLICITUD DE COMPRA</font></span></div>';
    }

    $modal  ='<div id="mostrarmodal" class="modal fade" role="dialog">
                    <div class="modal-dialog " style="width:90%">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                <h4 class="modal-title">DETALLE - SOLICITUD DE COMPRA</h4>
                            </div>
                            <div class="modal-body">';
    $modal .= $frame;
    $modal .='          </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                 </div>';

    return $modal;

}


//ESTADOS SOLCITUDES DE COMPRA

function estado_solcompra($id,$tipo){

    global $DSN, $DSN_Ifx;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}
    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $sql="select nombre,color from comercial.cre_estados_compras where est_sol=$id";
    $est=consulta_string($sql,'nombre',$oCon,'');
    $color=consulta_string($sql,'color',$oCon,'');

    if($tipo==1){
        $estado='<div class="btn-'.$color.' text-center">'.$est.'</div>';
    }
    else if($tipo==2){
        $estado='<div class=\"btn-'.$color.' text-center\">'.$est.'</div>';

    }

    return $estado;
}


function detalle_tecnico_compras($codpedi,$cedusua){

    global $DSN, $DSN_Ifx;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo ();
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();


    $oReturn = new xajaxResponse();

    $idempresa 	= $_SESSION['U_EMPRESA'];
    $idsucursal = $_SESSION['U_SUCURSAL'];


    $sHtml .= '<table class="table table-striped table-bordered table-hover table-condensed" style="width: 90%; margin-bottom: 0px;" align="center">';
    $sHtml .= '<tr>
	<td class="info" >No.</td>
    <td class="info" >Bodega</td>
	<td class="info">C&oacute;digo</td>
	<td class="info">Producto</td>
    <td class="info">Detalle</td>
    <td class="info">Centro de Costos</td>
    <td class="info">Cantidad</td>
    <td class="info">Costo</td>
    <td class="info">Total</td>
    <td class="info">Presupuesto</td>
    <td class="info">Aprobador VIT1</td>
    <td class="info">Detalle T&eacute;cnico VIT1</td>
    <td class="info">Autorizado</td>
    <td class="info">Aprobador VIT2</td>
    <td class="info">Detalle T&eacute;cnico VIT2</td>
    <td class="info">Autorizado</td>
    </tr>';


    ////CARGA DE ADJUNTOS////
    $k=1;
    $sqlpedi="select * from saedped where dped_cod_pedi=$codpedi and dped_cod_empr= $idempresa and 
    (dped_cod_empl='$cedusua' or dped_cod_rtec='$cedusua')";

    $colortdr='';
    $colorrev='';
    if ($oIfx->Query($sqlpedi)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $ped_cod=$oIfx->f('dped_cod_dped');
                //bodega
                $cbode=$oIfx->f('dped_cod_bode');
                $sqlbo="select bode_nom_bode from saebode where bode_cod_bode=$cbode";
                $nbode=consulta_string_func($sqlbo, 'bode_nom_bode', $oIfxA, '');

                //Código producto
                $citem=$oIfx->f('dped_cod_prod');
                //Nombre del producto
                $sqlitem = "select prod_nom_prod from saeprod where prod_cod_prod='$citem'";
                $nprod=consulta_string_func($sqlitem, 'prod_nom_prod', $oIfxA, 0);

                $ccos=$oIfx->f('dped_cod_ccos');

                $sql = "select ccosn_nom_ccosn from saeccosn where ccosn_cod_ccosn='$ccos'";
                $centro=consulta_string_func($sql, 'ccosn_nom_ccosn', $oIfxA, '');


                //detalle porducto
                $det=$oIfx->f('dped_det_dped');


                //TDR SI/NO
                $autec=$oIfx->f('dped_raut_tecn');
                $estadotec=$oIfx->f('dped_avt1_dped');

                //Responsable TDRS
                $rtec=$oIfx->f('dped_cod_empl');

                // detalle TDRs
                $tec=$oIfx->f('dped_aut_tecn');

                if($autec=='SI'){
                    $sql="select concat(usuario_nombre,' ',usuario_apellido) as apenomb, firma_empl from comercial.usuario where empl_cod_empl='$rtec'";
                    $nombtec=consulta_string_func($sql, 'apenomb', $oIfxA, '');

                    if($estadotec=='S'){

                        $colortdr='bgcolor="green"';
                        $nombtec='<font color="white">'.$nombtec.'</font>';
                        $atec='<font color="white">SI</font>';
                    }
                    else{


                        $colortdr='bgcolor="red"';
                        $nombtec='<font color="white">'.$nombtec.'</font>';
                        $atec='<font color="white">NO</font>';
                    }


                }
                else{
                    $nombtec='';
                    $colortdr='';
                    $atec='';
                }

                //Revisión Tecnica SI/NO
                $rautec=$oIfx->f('dped_sn_rtec');
                $estadortec=$oIfx->f('dped_avt2_dped');

                //Responsable Revisión Técnica
                $rtec1=$oIfx->f('dped_cod_rtec');

                //detalle Revisión Técnica
                $drtec=$oIfx->f('dped_det_rtec');

                if( $rautec=='SI'){
                    $sql="select concat(usuario_nombre,' ',usuario_apellido) as apenomb, firma_empl from comercial.usuario where empl_cod_empl='$rtec1'";
                    $nombtec1=consulta_string_func($sql, 'apenomb', $oIfxA, '');


                    if($estadortec=='S'){

                        $colorrev='bgcolor="green"';
                        $nombtec1='<font color="white">'.$nombtec1.'</font>';
                        $artec='<font color="white">SI</font>';

                    }
                    else{


                        $colorrev='bgcolor="red"';
                        $nombtec1='<font color="white">'.$nombtec1.'</font>';
                        $artec='<font color="white">NO</font>';
                    }

                }
                else{
                    $nombtec1='';
                    $colorrev='';
                    $artec='';
                }




                //cantidad
                $cant=$oIfx->f('dped_can_ped');
                $cant=round($cant,2);
                //costo
                $cos=$oIfx->f('dped_prc_dped');
                $cos=number_format($cos,2);
                //total
                $total=$oIfx->f('dped_tot_dped');
                $total=number_format($total,2);
                //presupuesto
                $pres=$oIfx->f('dped_pre_dped');
                $pres=number_format($pres,2);



                $sHtml .='<tr>';
                $sHtml .='<td align="center">'.$k.'</td>';
                $sHtml .='<td align="center">'.$nbode.'</td>';
                $sHtml .='<td align="center">'.$citem.'</td>';
                $sHtml .='<td align="center">'.$nprod.'</td>';
                $sHtml .='<td align="justify">'.$det.'</td>';
                $sHtml .='<td align="center">'.$centro.'</td>';
                $sHtml .='<td align="center">'.$cant.'</td>';
                $sHtml .='<td align="center">'.$cos.'</td>';
                $sHtml .='<td align="center">'.$total.'</td>';
                $sHtml .='<td align="center">'.$pres.'</td>';
                $sHtml .='<td '.$colortdr.' align="center">'.$nombtec.'</td>';
                $sHtml .='<td align="justify">'.$tec.'</td>';
                $sHtml .='<td '.$colortdr.' align="center">'.$atec.'</td>';
                $sHtml .='<td '.$colorrev.' align="center">'.$nombtec1.'</td>';
                $sHtml .='<td align="justify">'.$drtec.'</td>';
                $sHtml .='<td '.$colorrev.' align="center">'.$artec.'</td>';
                $sHtml .='</tr>';
                $k++;
            }while ($oIfx->SiguienteRegistro());
        }
    }

    $stotal="select sum(dped_tot_dped) as total from saedped where dped_cod_pedi=$codpedi";
    $totalped=consulta_string_func($stotal, 'total', $oIfxA, 0);
    $totalped=number_format($totalped,2);

    $stotal="select sum(dped_pre_dped) as totalpre from saedped where dped_cod_pedi=$codpedi";
    $totalpre=consulta_string_func($stotal, 'totalpre', $oIfxA, 0);
    $totalpre=number_format($totalpre,2);

    $sHtml .='<tr>';
    $sHtml .='<td align="right" colspan="7"><b>Total:</b></td>';
    $sHtml .='<td align="center">'.$totalped.'</td>';
    $sHtml .='<td align="center">'.$totalpre.'</td>';
    $sHtml .='</tr>';

    $sHtml .='</table>';

    $modal  ='<div id="mostrarmodal" class="modal fade" role="dialog">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">DETALLE - SOLICITUD DE COMPRA</h4>
                        </div>
                        <div class="modal-body">
                        <div class="table-responsive">';
    $modal .= $sHtml;
    $modal .='   </div>       </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
             </div>';


    return $modal;
}


//ADJUNTOS SOLCITUDES DE COMPRAS
function adjuntos_compras($codpedi){
    global $DSN, $DSN_Ifx;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo ();
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();


    $oReturn = new xajaxResponse();

    $idempresa 	= $_SESSION['U_EMPRESA'];
    $idsucursal = $_SESSION['U_SUCURSAL'];

    $sqlc="select pedi_carea_pedi from saepedi where pedi_cod_pedi=$codpedi";
    $codsol=consulta_string($sqlc,'pedi_carea_pedi',$oCon,'');

    $sHtml .= '<table class="table table-striped table-bordered table-hover table-condensed" style="width: 90%; margin-bottom: 0px;" align="center">';
    $sHtml .= '<tr>
	<td class="info" >No.</td>
	<td class="info">Cod Item</td>
	<td class="info">Producto</td>
    <td class="info">Detalle</td>
	<td class="info" align="center">Adjuntos</td></tr>';


    ////CARGA DE ADJUNTOS////
    $k=1;
    $sqlpedi="select * from saedped where dped_cod_pedi=$codpedi and dped_cod_empr= $idempresa";
    if ($oIfx->Query($sqlpedi)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $ped_cod=$oIfx->f('dped_cod_dped');
                //Cod prod
                $citem=$oIfx->f('dped_cod_prod');



                //$nprod=($oIfx->f('dped_prod_nom'));

                //Nombre del producto
                $sqlitem = "select prod_nom_prod from saeprod where prod_cod_prod='$citem'";
                $nprod=consulta_string_func($sqlitem, 'prod_nom_prod', $oIfxA, 0);


                $detalle=$oIfx->f('dped_det_dped');


                $sHtml .='<tr>';
                $sHtml .='<td align="center">'.$k.'</td>';
                $sHtml .='<td align="center">'.$ped_cod.'</td>';
                $sHtml .='<td align="center">'.$nprod.'</td>';
                $sHtml .='<td align="center">'.$detalle.'</td>';

                $sHtml .='<td align="right" valign="top">';
                $sHtml .='<table class="table table-striped table-bordered table-hover table-condensed" style="width: 100%; margin-bottom: 0px;" align="center">';
                $sHtml .='<tr>
				<td class="info" >N.-</td>
				<td class="info" >Ruta</td>
				</tr>';


                $sqladj="select ruta,titulo from comercial.adjuntos_pedido_compras where id_ped='$ped_cod' ";
                $i=1;
                if ($oCon->Query($sqladj)) {
                    if ($oCon->NumFilas() > 0) {
                        do {
                            $ruta = $oCon->f('ruta');
                            $arc_img="../../Include/Clases/Formulario/Plugins/reloj/$ruta";

                            $archivos="../../Include/Clases/Formulario/Plugins/reloj/$ruta";

                            if(file_exists($arc_img)){
                                $imagen=$arc_img;
                            }else{
                                $imagen='';
                            }
                            $logo='';
                            $x='0px';
                            if(preg_match("/jpg|png|PNG|jpeg|gif/",$ruta)){

                                $logo='<div>
                            <img src="'. $imagen .'" style="
                            width:200px;
                            object-fit; contain;">
                            </div>';
                                $x='0px';

                                $sHtml .= '<tr>
                    <td> '.$i.'</td>
                    <td><a href="'. $archivos .'" target="_blank" >'.$logo.'</a>
                     </td>
                    </tr>';
                            }
                            else{

                                $logo='<div>
                    <a href="'. $archivos .'" target="_blank" >'.$ruta.'</a>
                    </div>';

                                $sHtml .= '<tr>
                    <td> '.$i.'</td>
                    <td> '.$logo.'</td>
                    </tr>';

                            }
                            $i++;

                        } while ($oCon->SiguienteRegistro());
                    }
                    else{
                        $sHtml .='<tr><td colspan="2" align="center"><font color="red"><stong>SIN ADJUNTOS</strong></font></td></tr>';
                    }
                }
                $sHtml .='</table></td>';
                $sHtml .='</tr>';
                $k++;
            }while ($oIfx->SiguienteRegistro());
        }
    }

    $sHtml .='</table>';

    $modal  ='<div id="mostrarmodal" class="modal fade" role="dialog">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4 class="modal-title">ADJUNTOS - SOLICITUD DE COMPRA: '.$codsol.'</h4>
                        </div>
                        <div class="modal-body">
                        <div class="table-responsive">';
    $modal .= $sHtml;
    $modal .='</div></div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
             </div>';


    return $modal;
}


function ruta_adjuntos($pedi)
{

    global $DSN, $DSN_Ifx;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $oIfx = new Dbo ();
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oReturn = new xajaxResponse();

    $idempresa  = $_SESSION['U_EMPRESA'];


    $ruta='';
    $sql_ped="select dped_cod_dped from saedped where dped_cod_pedi=$pedi;";
    if ($oIfx->Query($sql_ped)) {
        if ($oIfx->NumFilas() > 0) {
            do {

                $ped=$oIfx->f('dped_cod_dped');
                $sqladj="select ruta from comercial.adjuntos_pedido_compras where id_ped='$ped'";


                if ($oCon->Query($sqladj)) {
                    if ($oCon->NumFilas() > 0) {
                        do {

                            $ruta.=$oCon->f('ruta').':';
                        }while ($oCon->SiguienteRegistro());
                    }
                }
            }while ($oIfx->SiguienteRegistro());
        }

    }

    return $ruta;


}
function formatear_cadena($cadena){
    $badchar=array(
        // control characters
        chr(0), chr(1), chr(2), chr(3), chr(4), chr(5), chr(6), chr(7), chr(8), chr(9), chr(10),
        chr(11), chr(12), chr(13), chr(14), chr(15), chr(16), chr(17), chr(18), chr(19), chr(20),
        chr(21), chr(22), chr(23), chr(24), chr(25), chr(26), chr(27), chr(28), chr(29), chr(30),
        chr(31),
        chr(127)
    );

    return str_replace($badchar, '', $cadena);
}


function dias_pasados($fecha_inicial,$fecha_final)
{
    $dias = (strtotime($fecha_inicial)-strtotime($fecha_final))/86400;
    $dias = abs($dias); $dias = floor($dias);
    return $dias;
}

//FUNCIONES MODULO MANTENIMIENTO

////

function nomb_mes($mes){

    if($mes=='01'){
        $mes='enero';
    }
    elseif($mes=='02'){
        $mes='febrero';
    }
    elseif($mes=='03'){
        $mes='marzo';
    }
    elseif($mes=='04'){
        $mes='abril';
    }
    elseif($mes=='05'){
        $mes='mayo';
    }
    elseif($mes=='06'){
        $mes='junio';
    }
    elseif($mes=='07'){
        $mes='julio';
    }
    elseif($mes=='08'){
        $mes='agosto';
    }
    elseif($mes=='09'){
        $mes='septiembre';
    }
    elseif($mes=='10'){
        $mes='octubre';
    }
    elseif($mes=='11'){
        $mes='noviembre';
    }
    elseif($mes=='12'){
        $mes='diciembre';
    }

    return $mes;
}
function logo_mensaje_correo($mensaje,$area){
    global $DSN, $DSN_Ifx;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $oIfx = new Dbo ();
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oReturn = new xajaxResponse();

    $idempresa  = $_SESSION['U_EMPRESA'];
    $idsucursal = $_SESSION['U_SUCURSAL'];


    //LOGO DEL REPORTE

    $sql = "select empr_img_rep from saeempr where empr_cod_empr =  $idempresa ";

    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $empr_path_logo = $oIfx->f('empr_img_rep');
            $empr_color = $oIfx->f('empr_web_color');
        }
    }
    $oIfx->Free();



    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;



    $arc_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];


    if (file_exists($arc_img)) {
        $imagen = $arc_img;
        /*$contenido = file_get_contents($imagen);
        $imagen_base64 = base64_encode($contenido);
        $imagen_base64 = "data:image/png;base64,".$imagen_base64;*/

        $imgData = base64_encode(file_get_contents($arc_img));
        $imagen_base64 = 'data: ' . mime_content_type($arc_img) . ';base64,' . $imgData;
    } else {
        $imagen = '';
    }

    $logo = '';
    $x = '0px';
    if ($imagen != '') {

        $empr_logo = '<div>
        <img src="' . $imagen_base64 . '" style="
        width:300px;">
        </div>';
        $x = '0px';
    }
    else{
        $empr_logo ='<span><font color="red">SIN LOGO</font></span>';
    }

//PLANTILLA CORREO

    $msj='
<table align="center">
<tr>
<td align="left"><div><img src="cid:cruzroja01" style="
width:300px;"></div></td>
<br>
</tr>
</table>

<table style="width: 50%; border: 1px solid black; border-radius: 5px;" align="center">
<tr>
<td>
    <table style="width: 100%;" align="center">
    <tr>
    <td style="font-size:30px;" align="center">
    <strong> Estimado Usuario:<br></strong>
    </td>
    </tr>
    <tr>
    <td style="font-size:25px; border-top:1" ><p align="justify">
    '.$mensaje.'
    </p>
    </td>
    </tr>
    <tr>
    <td style="font-size:28px;" align="center"><strong><i>'.$area.'</i></strong></td>
    </tr>
    </table>
</td>
</tr>
</table>';

    return $msj;

}

function form_detalle_vehiculo($id){

    global $DSN, $DSN_Ifx;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo ();
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $oReturn = new xajaxResponse();

    $idempresa  = $_SESSION['U_EMPRESA'];
    $idsucursal = $_SESSION['U_SUCURSAL'];

    $sqlveh="select *from saevehm where vehm_cod_vehm=$id";

    if ($oIfx->Query($sqlveh)) {
        if ($oIfx->NumFilas() > 0) {

            $placa=$oIfx->f('vehm_plac_vehm');
            $nombre= $oIfx->f('vehm_nom_empl');
            $ced= $oIfx->f('vehm_cod_empl');
            $marca= $oIfx->f('vehm_marc_vehm');
            $modelo=$oIfx->f('vehm_mode_vehm');
            $color= $oIfx->f('vehm_col_vehm');
            $afab= $oIfx->f('vehm_afac_vehm');
            $chasis= $oIfx->f('vehm_ncha_vehm');
            $motor= $oIfx->f('vehm_nmot_vehm');
        }
    }

    $modal  ='<div id="ModalDetalle" class="modal fade" role="dialog">
                  <div class="modal-dialog" style="width:40%" >
                      <div class="modal-content">
                          <div class="modal-header">
                              <button type="button" class="close" data-dismiss="modal">&times;</button>
                              <h4 class="modal-title">DETALLE - VEHICULO</h4>
                          </div>
                          <div class="modal-body" >';
    $modal .='
      <div class="form-group row">
      <label for="static1" class="col-sm-4 col-form-label">Placa:</label>
      <div class="col-sm-8">
        '.$placa.'
      </div>
      </div>
  
    <div class="form-group row">
      <label for="static2" class="col-sm-4 col-form-label">Marca - Modelo:</label>
      <div class="col-sm-8">
      '.$marca.' '.$modelo.'
      </div>
    </div>
    
    <div class="form-group row">
    <label for="static3" class="col-sm-4 col-form-label">Color:</label>
    <div class="col-sm-8">
    '.$color.' 
    </div>
    </div>
  
    <div class="form-group row">
    <label for="static4" class="col-sm-4 col-form-label">A&ntilde;o de Fabricaci&oacute;n:</label>
    <div class="col-sm-8">
    '.$afab.' 
    </div>
    </div>
      
    <div class="form-group row">
    <label for="static5" class="col-sm-4 col-form-label">No. Chasis:</label>
    <div class="col-sm-8">
    '.$chasis.' 
    </div>
    </div>
  
    <div class="form-group row">
    <label for="static6" class="col-sm-4 col-form-label">No. Motor:</label>
    <div class="col-sm-8">
    '.$motor.' 
    </div>
    </div>
  
    <div class="form-group row">
    <label for="static7" class="col-sm-4 col-form-label">Propietario:</label>
    <div class="col-sm-8">
    '.$nombre.' 
    </div>
    </div>
  
    <div class="form-group row">
    <label for="static8" class="col-sm-4 col-form-label">Identificaci&oacute;n:</label>
    <div class="col-sm-8">
    '.$ced.' 
    </div>
  </div>
    ';
    $modal .='          </div>
                          <div class="modal-footer">
                              <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
                          </div>
                      </div>
                  </div>
               </div>';

    return $modal;

}


//FUNCIONES MODULO TRANSACCIONES COMPRAS


//EXTRACCION DE FIRMAS Y NOMBRES

function firma_nomb_empleado($ced)
{

    //Definiciones
    global $DSN_Ifx, $DSN;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();


    //FIRMA
    //$sqlf = "select  empl_fir_empl from saeempl where empl_cod_empl='$ced'";


    if(empty($ced)){
        $logo = '<strong><font color="red">SIN FIRMA</font></strong><br>';
        $gaf='<strong><font color="red">SIN NOMBRE</font></strong>';

    }
    else{

        $sqlf="select concat(usuario_nombre,' ',usuario_apellido) as apenomb, firma_empl from comercial.usuario where empl_cod_empl='$ced' ";


        $firma = consulta_string_func($sqlf, 'firma_empl', $oIfx, '');

        $fir = substr($firma, 3);

        if (empty($fir)) {

            $logo = '<strong><font color="red">SIN FIRMA</font></strong><br>';

        } else {

            $arc_img = DIR_FACTELEC . "Include/Clases/Formulario/Plugins/reloj/$fir";

            if (file_exists($arc_img)) {

                if(preg_match("/jpg|png|PNG|jpeg|gif/",$fir)){
                    $logo = '<div>
           <img src="' . $arc_img . '" width="100">
           </div>';
                }
                else{
                    $logo = '<strong><font color="red">FORMATO DE IMAGEN NO VALIDA</font> <br> <font color="blue">LAS EXTENSIONES DE ARCHIVO PERMITIDAS SON:</font> .jpg, .jpeg, .png, .gif</strong><br>';
                }

            } else {

                $logo = '<strong><font color="red">SIN FIRMA</font></strong><br>';
            }


        }


        //NOMBRES

        $gaf = consulta_string_func($sqlf, 'apenomb', $oIfx, '');


    }

    $array_firma [] = array($logo, $gaf);


    return $array_firma;


}


function envio_correo_periodo($correo,$mensaje,$soli){

    require_once('class.phpmailer.php');
    require_once('class.smtp.php');

    //Definiciones
    global $DSN;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $idempresa = $_SESSION['U_EMPRESA'];

    $sqlema="select empr_token_api, empr_img_rep, empr_nom_empr, empr_ema_test, empr_ema_sn from saeempr where empr_cod_empr=$idempresa";
    $empr_api_toke=consulta_string($sqlema,'empr_token_api',$oCon,'');
    $test=consulta_string($sqlema,'empr_ema_sn',$oCon,'');
    $imgmsj=consulta_string($sqlema,'empr_img_rep',$oCon,'');

    $arc_img = DIR_FACTELEC . "Include/Clases/Formulario/Plugins/reloj/" . basename($imgmsj);


    if (file_exists($arc_img)) {

        $extension = pathinfo($arc_img, PATHINFO_EXTENSION);
        $archivo = file_get_contents($arc_img);
        $imagen_base64=base64_encode($archivo);
    } else {
        $imagen_base64=null;
    }
    $imagencorreo=$imagen_base64;

    $nomb_empresa=consulta_string($sqlema,'empr_nom_empr',$oCon,'');

    if($test=='S'){
        $correo=consulta_string($sqlema,'empr_ema_test',$oCon,'');
        $copia=$correo;
    }


    $sqlcorreo = "select server, port, auth, 
   config_email.user, pass, ssltls, mail
   from comercial.config_email
   where id_empresa = $idempresa";

    if ($oCon->Query($sqlcorreo)) {
        if ($oCon->NumFilas() > 0) {
            $host = $oCon->f('server');
            $port = $oCon->f('port');
            $smtpauth = $oCon->f('auth');
            $userid = $oCon->f('user');
            $smtpsecure = $oCon->f('ssltls');
            $mailenvio = $oCon->f('mail');
            $password = $oCon->f('pass');

        }
    }
    $oCon->Free();

    $adjuntos = explode(":", $adjuntos);

    $adj = array();

//CONSTRUCCION PARAMETROS WEB SERVICE

    $headers = array(
        "Content-Type:application/json",
        "Token-Api:$empr_api_toke"
    );

    $correo = array(trim($correo));
    $smtp_server = "{$host}:{$port}";

    $data = array(
        "smtp_server" => $smtp_server,
        "secure_type" => $smtpsecure,
        "username" => $userid,
        "password" => $password,
        "from_address" => $mailenvio,
        "to_address" =>  $correo,
        "title" => "BIENVENIDOS AL SISTEMA INTEGRAL DE $nomb_empresa",
        "content" => $mensaje,
        "attachments" => $adj,
        "images" => array(array("image_id"=>"<cruzroja01>", "content"=>$imagencorreo))

    );


    $ch = curl_init();
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_URL, URL_JIREH_WS_CORREOS."/api/v1/correo/enviar");
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $respuesta = curl_exec($ch);
    curl_close($ch);
    $resultado = json_decode($respuesta,true);
    $mensaje = $resultado["msg"];
    $enviado = $resultado["result"];


    $correo=$correo[0];
    if($enviado == true){
        $msg="Mail enviado a: $correo";
    }else{
        $msg="Error al enviar email: $mensaje";
    }


    return $msg;



}

function envio_correo_csret($copia, $correo, $mensaje,  $adjuntos, $asunto)
{
    // require_once('class.phpmailer.php');
    //require_once('class.smtp.php');

    //Definiciones
    global $DSN;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $idempresa = $_SESSION['U_EMPRESA'];

    $sqlema="select empr_token_api, empr_img_rep, empr_nom_empr, empr_ema_test, empr_ema_sn from saeempr where empr_cod_empr=$idempresa";
    $test=consulta_string($sqlema,'empr_ema_sn',$oCon,'');
    $imgmsj=consulta_string($sqlema,'empr_img_rep',$oCon,'');
    $empr_api_toke=consulta_string($sqlema,'empr_token_api',$oCon,'');

    $arc_img = DIR_FACTELEC . "Include/Clases/Formulario/Plugins/reloj/" . basename($imgmsj);


    if (file_exists($arc_img)) {

        $extension = pathinfo($arc_img, PATHINFO_EXTENSION);
        $archivo = file_get_contents($arc_img);
        $imagen_base64=base64_encode($archivo);
    } else {
        $imagen_base64=null;
    }

    $imagencorreo=$imagen_base64;

    $nomb_empresa=consulta_string($sqlema,'empr_nom_empr',$oCon,'');

    if($test=='S'){
        $correo=consulta_string($sqlema,'empr_ema_test',$oCon,'');
        $copia=$correo;
    }


    $sqlcorreo = "select server, port, auth, 
    config_email.user, pass, ssltls, mail
    from comercial.config_email
    where id_empresa = $idempresa";

    if ($oCon->Query($sqlcorreo)) {
        if ($oCon->NumFilas() > 0) {
            $host = $oCon->f('server');
            $port = $oCon->f('port');
            $smtpauth = $oCon->f('auth');
            $userid = $oCon->f('user');
            $smtpsecure = $oCon->f('ssltls');
            $mailenvio = $oCon->f('mail');
            $password = $oCon->f('pass');

        }
    }
    $oCon->Free();

    $adjuntos = explode(":", $adjuntos);

    $adj = array();



    if (count($adjuntos) == 1) {

        for ($i = 0; $i < count($adjuntos); $i++) {

            if(!empty($adjuntos[$i])){
                $ruta = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $adjuntos[$i];

                if (file_exists($ruta)) {
                    $archivo = file_get_contents($ruta);
                    $archivo = array("name" => $adjuntos[$i], "content" => base64_encode($archivo));

                    array_push($adj, $archivo);
                }
            }

        }

    } else {
        for ($i = 0; $i < count($adjuntos) - 1; $i++) {

            if(!empty($adjuntos[$i])){
                $ruta = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $adjuntos[$i];

                if (file_exists($ruta)) {

                    $archivo = file_get_contents($ruta);
                    $archivo = array("name" => $adjuntos[$i], "content" => base64_encode($archivo));

                    array_push($adj, $archivo);
                }
            }

        }
    }


    //CONSTRUCCION PARAMETROS WEB SERVICE

    $headers = array(
        "Content-Type:application/json",
        "Token-Api:$empr_api_toke"
    );

    $correo = array(trim($correo));
    $correocc = array(trim($copia));
    $smtp_server = "{$host}:{$port}";

    $data = array(
        "smtp_server" => $smtp_server,
        "secure_type" => $smtpsecure,
        "username" => $userid,
        "password" => $password,
        "from_address" => $mailenvio,
        "to_address" =>  $correo,
        "to_cc" =>  $correocc,
        "title" => "BIENVENIDOS AL SISTEMA INTEGRAL DE $nomb_empresa $asunto",
        "content" => $mensaje,
        "attachments" => $adj,
        "images" => array(array("image_id"=>"<cruzroja01>", "content"=>$imagencorreo))

    );


    $ch = curl_init();
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_URL, URL_JIREH_WS_CORREOS."/api/v1/correo/enviar");
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $respuesta = curl_exec($ch);
    curl_close($ch);
    $resultado = json_decode($respuesta,true);
    $mensaje = $resultado["msg"];
    $enviado = $resultado["result"];


    $correo=$correo[0];
    if($enviado == true){
        $msg="Mail enviado a: $correo";
    }else{
        $msg="Error al enviar email: $mensaje";
    }


    return $msg;
}


function envio_correo_compras($copia, $correo, $mensaje, $area, $adjuntos, $pedido, $comp, $repdj)
{
    //Definiciones
    global $DSN;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $idempresa = $_SESSION['U_EMPRESA'];

    //DATOS DE LA EMPRESA

    $sqlema="select empr_token_api, empr_img_rep, empr_nom_empr, empr_ema_test, empr_ema_sn from saeempr where empr_cod_empr=$idempresa";

    $imgmsj=consulta_string($sqlema,'empr_img_rep',$oCon,'');
    $empr_api_toke=consulta_string($sqlema,'empr_token_api',$oCon,'');
    $nomb_empresa=consulta_string($sqlema,'empr_nom_empr',$oCon,'');
    //CORREO DE PRUEBAS
    $test=consulta_string($sqlema,'empr_ema_sn',$oCon,'');
    if($test=='S'){
        $correo=consulta_string($sqlema,'empr_ema_test',$oCon,'');
        $copia=$correo;
    }
    //LOGO DE LA EMPRESA PARA CORREOS
    $arc_img = DIR_FACTELEC . "Include/Clases/Formulario/Plugins/reloj/" . basename($imgmsj);


    if (file_exists($arc_img)) {
        $extension = pathinfo($arc_img, PATHINFO_EXTENSION);
        $archivo = file_get_contents($arc_img);
        $imagen_base64=base64_encode($archivo);

    } else {
        $imagen_base64=null;
    }
    $imagencorreo=$imagen_base64;

    //PARAMETROS ENVIO DE CORREOS

    $sqlcorreo = "select server, port, auth, 
    config_email.user, pass, ssltls, mail
    from comercial.config_email
    where id_empresa = $idempresa";

    if ($oCon->Query($sqlcorreo)) {
        if ($oCon->NumFilas() > 0) {
            $host = $oCon->f('server');
            $port = $oCon->f('port');
            $smtpauth = $oCon->f('auth');
            $userid = $oCon->f('user');
            $smtpsecure = $oCon->f('ssltls');
            $mailenvio = $oCon->f('mail');
            $password = $oCon->f('pass');

        }
    }
    $oCon->Free();

    //ARRAY ARCHVOS ADJUNTOS
    $adj = array();


    //IMPRESION VALIDACION DE ENVIO DE PARAMETROS
    //echo $host.' '.$port.' '.$smtpsecure.' '.$mailenvio.' '.$correo.' '.$password;exit;

    //ARCHIVOS - FORMATOS CRE- CONVOCATORIA A PROVEEDORES, CUADRO COMPARATIVO, SOLICITUD

    if (preg_match("/convocatoria/", $pedido)) {
        $ruta1 = DIR_FACTELEC . 'Include/archivos/convocatoria_compras/' . $pedido;
        if (file_exists($ruta1)) {
            $archivo = file_get_contents($ruta1);
            $archivo = array("name" => $pedido, "content" => base64_encode($archivo));
            array_push($adj, $archivo);
        }

    } elseif (preg_match("/cuadro_comparativo/", $pedido)) {
        $ruta1 = DIR_FACTELEC . 'Include/archivos/comparativo_compras/' . $pedido;
        if (file_exists($ruta1)) {
            $archivo = file_get_contents($ruta1);
            $archivo = array("name" => $pedido, "content" => base64_encode($archivo));
            array_push($adj, $archivo);
        }
    } elseif (preg_match("/solicitud/", $pedido)) {
        $ruta1 = DIR_FACTELEC . 'Include/archivos/solicitudes_compras/' . $pedido;
        if (file_exists($ruta1)) {
            $archivo = file_get_contents($ruta1);
            $archivo = array("name" => $pedido, "content" => base64_encode($archivo));
            array_push($adj, $archivo);
        }
    }
    //ADJUNTOS SOLICITUD

    $adjuntos = explode(":", $adjuntos);

    if (count($adjuntos) == 1) {

        for ($i = 0; $i < count($adjuntos); $i++) {

            if(!empty($adjuntos[$i])){
                $ruta = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $adjuntos[$i];

                if (file_exists($ruta)) {
                    $archivo = file_get_contents($ruta);
                    $archivo = array("name" => $adjuntos[$i], "content" => base64_encode($archivo));

                    array_push($adj, $archivo);
                }
            }

        }

    } else {
        for ($i = 0; $i < count($adjuntos) - 1; $i++) {

            if(!empty($adjuntos[$i])){
                $ruta = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $adjuntos[$i];

                if (file_exists($ruta)) {

                    $archivo = file_get_contents($ruta);
                    $archivo = array("name" => $adjuntos[$i], "content" => base64_encode($archivo));

                    array_push($adj, $archivo);
                }
            }

        }
    }
    //FORMATSO ORDEN DE COMPRA - ADJUDICACION PROVEEDOR

    if (!empty($repdj)) {
        if (file_exists($repdj)) {
            $archivo = file_get_contents($repdj);
            //$archivo= basename($repdj).'::'.base64_encode($archivo);
            //$archivo= '"name"=>'.basename($repdj).',"content"=>'.base64_encode($archivo).'';
            $archivo = array("name" => basename($repdj), "content" => base64_encode($archivo));

            array_push($adj, $archivo);
        }
    }

    if (!empty($comp)) {
        if (file_exists($comp)) {
            $archivo = file_get_contents($comp);
            //$archivo= basename($comp).'::'.base64_encode($archivo);
            //$archivo= '"name"=>'.basename($comp).',"content"=>'.base64_encode($archivo).'';
            $archivo = array("name" => basename($comp), "content" => base64_encode($archivo));

            array_push($adj, $archivo);
        }

    }

    //CONSTRUCCION PARAMETROS WEB SERVICE

    $headers = array(
        "Content-Type:application/json",
        "Token-Api:$empr_api_toke"
    );

    $correo = array(trim($correo));
    $correocc = array(trim($copia));
    $smtp_server = "{$host}:{$port}";

    $data = array(
        "smtp_server" => $smtp_server,
        "secure_type" => $smtpsecure,
        "username" => $userid,
        "password" => $password,
        "from_address" => $mailenvio,
        "to_address" =>  $correo,
        "to_cc" =>  $correocc,
        "title" => "BIENVENIDOS AL SISTEMA INTEGRAL DE $nomb_empresa - GESTION DE COMPRAS",
        "content" => $mensaje,
        "attachments" => $adj,
        "images" => array(array("image_id"=>"<cruzroja01>", "content"=>$imagencorreo))

    );


    $ch = curl_init();
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_URL, URL_JIREH_WS_CORREOS."/api/v1/correo/enviar");
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $respuesta = curl_exec($ch);
    curl_close($ch);
    $resultado = json_decode($respuesta,true);
    $mensaje = $resultado["msg"];
    $enviado = $resultado["result"];


    $correo=$correo[0];
    if($enviado == true){
        $msg="Mail enviado a: $correo";
    }else{
        $msg="Error al enviar email: $mensaje";
    }


    return $msg;

}

function envio_correo_pagos($copia, $correo, $mensaje, $area, $adjuntos, $pedido, $comp, $repdj)
{
    require_once('class.phpmailer.php');
    require_once('class.smtp.php');

    //Definiciones
    global $DSN;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $idempresa = $_SESSION['U_EMPRESA'];

    $sqlcorreo = "select server, port, auth, 
    config_email.user, pass, ssltls, mail
    from comercial.config_email
    where id_empresa = $idempresa";
    if ($oCon->Query($sqlcorreo)) {
        if ($oCon->NumFilas() > 0) {
            $host = $oCon->f('server');
            $port = $oCon->f('port');
            $smtpauth = $oCon->f('auth');
            $userid = $oCon->f('user');
            $smtpsecure = $oCon->f('ssltls');
            $mailenvio = $oCon->f('mail');
            $password = $oCon->f('pass');
        }
    }
    $oCon->Free();


    $sqlema="select empr_token_api, empr_img_rep, empr_nom_empr, empr_ema_test, empr_ema_sn from saeempr where empr_cod_empr=$idempresa";
    $test=consulta_string($sqlema,'empr_ema_sn',$oCon,'');
    $nomb_empresa=consulta_string($sqlema,'empr_nom_empr',$oCon,'');
    $imgmsj=consulta_string($sqlema,'empr_img_rep',$oCon,'');
    $empr_api_toke=consulta_string($sqlema,'empr_token_api',$oCon,'');

    $arc_img = DIR_FACTELEC . "Include/Clases/Formulario/Plugins/reloj/" . basename($imgmsj);


    if (file_exists($arc_img)) {

        $extension = pathinfo($arc_img, PATHINFO_EXTENSION);
        $archivo = file_get_contents($arc_img);
        $imagen_base64=base64_encode($archivo);
    } else {
        $imagen_base64=null;
    }
    $imagencorreo=$imagen_base64;


    if($test=='S'){
        $correo=consulta_string($sqlema,'empr_ema_test',$oCon,'');
        $copia=$correo;
    }

    $adjuntos = explode(":", $adjuntos);

    $adj = array();


    if (file_exists($pedido)) {
        $archivo = file_get_contents($pedido);
        $archivo = array("name" => basename($pedido), "content" => base64_encode($archivo));
        array_push($adj, $archivo);
    }

    if (count($adjuntos) == 1) {

        for ($i = 0; $i < count($adjuntos); $i++) {
            if(!empty($adjuntos[$i])){
                $ruta = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $adjuntos[$i];

                if (file_exists($ruta)) {
                    $archivo = file_get_contents($ruta);
                    $archivo = array("name" => $adjuntos[$i], "content" => base64_encode($archivo));

                    array_push($adj, $archivo);
                }
            }
        }

    } else {
        for ($i = 0; $i < count($adjuntos) - 1; $i++) {

            if(!empty($adjuntos[$i])){
                $ruta = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $adjuntos[$i];

                if (file_exists($ruta)) {
                    $archivo = file_get_contents($ruta);
                    $archivo = array("name" => $adjuntos[$i], "content" => base64_encode($archivo));

                    array_push($adj, $archivo);
                }

            }

        }

    }


    $headers = array(
        "Content-Type:application/json",
        "Token-Api:$empr_api_toke"
    );

    $correo = array(trim($correo));
    $correocc = array(trim($copia));
    $smtp_server = "{$host}:{$port}";

    $data = array(
        "smtp_server" => $smtp_server,
        "secure_type" => $smtpsecure,
        "username" => $userid,
        "password" => $password,
        "from_address" => $mailenvio,
        "to_address" =>  $correo,
        "to_cc" =>  $correocc,
        "title" => "BIENVENIDOS AL SISTEMA INTEGRAL DE $nomb_empresa - GESTION DE PAGOS",
        "content" => $mensaje,
        "attachments" => $adj,
        "images" => array(array("image_id"=>"<cruzroja01>", "content"=>$imagencorreo))

    );


    $ch = curl_init();
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_URL, URL_JIREH_WS_CORREOS."/api/v1/correo/enviar");
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $respuesta = curl_exec($ch);
    curl_close($ch);
    $resultado = json_decode($respuesta,true);
    $mensaje = $resultado["msg"];
    $enviado = $resultado["result"];


    $correo=$correo[0];
    if($enviado == true){
        $msg="Mail enviado a: $correo";
    }else{
        $msg="Error al enviar email: $mensaje";
    }


    return $msg;
}


function envio_correo_adj_notificacion_solicitud($email, $asunto, $html, $adjuntos, $ruta = 'modulos/auto_soli_pagen/adjuntos/')
{

    include_once(path(DIR_INCLUDE) . "class.phpmailer.php");
    include_once(path(DIR_INCLUDE) . "class.smtp.php");
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    //variables de session
    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_nom_empr, empr_dir_empr from saeempr where empr_cod_empr = $idEmpresa";
    $empr_nom_empr = consulta_string($sql, 'empr_nom_empr', $oIfx, '');

    $sqlSmtp = "select server, port, auth, 
			user, pass, ssltls, 
			mail 
			from comercial.config_email
			where id_empresa = $idEmpresa and
			id_tipo =1";
    if ($oCon->Query($sqlSmtp)) {
        if ($oCon->NumFilas() > 0) {
            $host = $oCon->f('server');
            $port = $oCon->f('port');
            $smtpauth = $oCon->f('auth');
            $userid = $oCon->f('mail');
            $smtpsecure = $oCon->f('ssltls');
            $mailenvio = $oCon->f('mail');
            $password = $oCon->f('pass');
        }
    }
    $oCon->Free();


    $headers = array(
        "Content-Type:application/json",
        "Token-Api:e02e580c-9020-40f8-8c57-f14ffb1bdadf"
    );

    $adj = array();

    if ($adjuntos->success == 1) {
        foreach ($adjuntos->files as $adjunto) {
            $ruta = DIR_FACTELEC . $ruta.$adjunto;

            if (file_exists($ruta)) {
                $archivo = file_get_contents($ruta);
                $archivo= basename($ruta).'::'.base64_encode($archivo);
                array_push($adj, $archivo);
            }

        }
    }

    $data = array(
        "host" => $host,
        "port" => $port,
        "secure_type" => $smtpsecure,
        "from_address" => $mailenvio,
        "from_name" => $mailenvio,
        "to_address" =>  $email, //correo destinatario
        "subject" => $asunto,
        "username" => $userid,
        "password" => $password,
        "body" => $html,
        "archivo_ride" => '',
        "archivo_xml" => '',
        "multiples_adjuntos" =>$adj,
        //"multiples_imagenes" => array(),
//        "guia_pdf" => ""
    );

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_URL, URL_JIREH_WS."/api/correo/enviar");
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $respuesta = curl_exec($ch);
//    print_r($respuesta);exit;
    $resultado = json_decode($respuesta,true);
    $enviado = $resultado["enviado"];


    if($enviado == true){
        return 1;
    }else{
        return "Error al enviar email";
    }

}




///////////////////////////////////////////////////////////////////////////////////////////////////////////////


function busca_maetab($oCon = '', $tabla = '', $codigo = '', $campo = '')
{
    if ($oCon == '' || $tabla == '' || $codigo == '' || $campo == '')
        return false;
    else {
        $Sql = 'SELECT * FROM comercial.MAETAB WHERE NUMTAB = "?" AND CODTAB = ? ';
        $data = array($tabla, $codigo);
        if ($oCon->Query($Sql, $data))
            return $oCon->f($campo);
        else
            return false;
    }
}
function busca_maetab1($oCon = '', $tabla = '', $codigo = '', $campo = '')
{
    if ($oCon == '' || $tabla == '' || $codigo == '' || $campo == '')
        return false;
    else {
        $Sql = 'SELECT * FROM soporte.MAETAB WHERE NUMTAB = ? AND CODTAB = ? ';
        $data = array($tabla, $codigo);
        if ($oCon->Query($Sql, $data))
            return $oCon->f($campo);
        else
            return false;
    }
}

function busca_usuario($oCon = '', $condicion = '')
{
    if ($oCon == '' || $condicion == '')
        return false;
    else {
        $Sql = 'SELECT * FROM comercial.USUARIO WHERE USUARIO_ID = ?';
        $data = array($condicion);
        if ($oCon->Query($Sql, $data))
            return $oCon->f('usuario_nombre') . ' ' . $oCon->f('usuario_apellido');
        else
            return 'No Registrado';
    }
}

function busca_empresa($oCon = '', $condicion = '')
{
    if ($oCon == '' || $condicion == '')
        return false;
    else {
        $Sql = 'SELECT * FROM comercial.EMPRESA WHERE EMPRESA_ID = ?';
        $data = array($condicion);
        if ($oCon->Query($Sql, $data))
            return $oCon->f('empresa_nombre');
        else
            return 'No Registrada';
    }
}

/* * ******************************************
  @ Alerta
  + Muestra en pantalla mensajes de:
  + Error => 0
  + Ok => 1
  + Advertencia => 2
  + Interrogacion => 3
  + Informacion => 4
  + en formatos txt, html o js de acuerdo a como
  + se la setee, trabaja en conjunto con la
  = funcion error.
  +
 * ****************************************** */

function Alerta($mensaje = 'Funcion Alerta([Mensaje], [Titulo], [Opcion])', $tituloMsg = 'No se pasaron parametros', $tipo = 2, $formato = 'hmtl', $bReturn = false)
{
    $path = $_COOKIE["JIREH_IMAGENES"] . "iconos/";
    switch ($tipo) {
        case 0:
            $icono = $path . "ico_error.png";
            $titulo = " ";
            $color = "CC0000";
            $colorTitulo = "FFFFFF";
            $colorMsg = "CC0000";
            break;
        case 1:
            $icono = $path . "ico_ok.png";
            $titulo = " ";
            $color = "009900";
            $colorTitulo = "FFFFFF";
            $colorMsg = "009900";
            break;
        case 2:
            $icono = $path . "ico_advertencia.png";
            $titulo = " ";
            $color = "FFCC33";
            $colorTitulo = "FFFFFF";
            $colorMsg = "FF9900";
            break;
        case 3:
            $icono = $path . "ico_atencion.png";
            $titulo = " ";
            $color = "FF9900";
            $colorTitulo = "FFFFFF";
            $colorMsg = "FF9900";
            break;
        case 4:
            $icono = $path . "ico_info.png";
            $titulo = " ";
            $color = "006699";
            $colorTitulo = "FFFFFF";
            $colorMsg = "006699";
            break;
    }
    $titulo .= $tituloMsg;
    switch ($formato) {
        case 'html':
            $alerta = '<br>
				<table width="50%" border="1" align="center" cellpadding="2" cellspacing="0" bordercolor="#' . $color . '">
				  <tr>
					<td width="375" bgcolor="#' . $color . '" align="left">
					 <img src="' . $icono . '" align="absmiddle">
					 <font size="2em" color="#' . $colorTitulo . '">' . $titulo . '</font>
					</td>
				  </tr>
				  <tr>
					<td><div align="center"><font size="1em" color="#' . $colorMsg . '">' . $mensaje . '</font></div></td>
				  </tr>
				</table><br>';
            break;
        case 'txt':
            $alerta = '
					<br>
					<div align="center">
						<font size="2" color="#' . $colorMsg . '">' . $titulo . '<br>' . $mensaje . '</font>
					</div>
					<br>';
            break;
        case 'js':
            $alerta = '<script>alert("' . $titulo . '  ' . $mensaje . '")</script>';
            break;
    }
    if ($bReturn)
        return $alerta;
    else
        echo($alerta);
}

function getIP()
{

    if ($_SERVER['HTTP_X_FORWARDED_FOR'] != '') {
        $client_ip = (!empty($_SERVER['REMOTE_ADDR'])) ?
            $_SERVER['REMOTE_ADDR'] :
            ((!empty($_ENV['REMOTE_ADDR'])) ?
                $_ENV['REMOTE_ADDR'] :
                "unknown");

        // los proxys van a�adiendo al final de esta cabecera
        // las direcciones ip que van "ocultando". Para localizar la ip real
        // del usuario se comienza a mirar por el principio hasta encontrar
        // una direcci�n ip que no sea del rango privado. En caso de no
        // encontrarse ninguna se toma como valor el REMOTE_ADDR

        $entries = explode('[, ]', $_SERVER['HTTP_X_FORWARDED_FOR']);

        reset($entries);
        while (list(, $entry) = each($entries)) {
            $entry = trim($entry);
            if (preg_match("/^([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)/", $entry, $ip_list)) {
                $private_ip = array(
                    '/^0\./',
                    '/^127\.0\.0\.1/',
                    '/^192\.168\..*/',
                    '/^172\.((1[6-9])|(2[0-9])|(3[0-1]))\..*/',
                    '/^10\..*/');

                $found_ip = preg_replace($private_ip, $client_ip, $ip_list[1]);

                if ($client_ip != $found_ip) {
                    $client_ip = $found_ip;
                    break;
                }
            }
        }
    } else {
        $client_ip = (!empty($_SERVER['REMOTE_ADDR'])) ?
            $_SERVER['REMOTE_ADDR'] :
            ((!empty($_ENV['REMOTE_ADDR'])) ?
                $_ENV['REMOTE_ADDR'] :
                "unknown");
    }

    return $client_ip;
}

function permisos($oCon = '', $perfil = '')
{
    /*
      LEYENDA PERMISOS
      0- SIMPLE
      1- GUARDAR
      2- MODIFICAR
      3- RESET CLAVE
      4- IMPRIMIR
      5- ASIGNAR
      6- AUTO ASIGNAR
      7- FINALIZAR
      8- NEGAR
      9- OBSERVACIONES
      10- ASIGNAR CLIENTE

     */

    if ($oCon == '' || $perfil == '')
        return false;
    else {
        $Sql = 'SELECT * FROM comercial.PERFIL WHERE PERFIL_ID = ?';
        $data = array($perfil);
        if ($oCon->Query($Sql, $data)) {
            $Permisos = NULL;
            $nPermisos = strlen($oCon->f('perfil_permisos'));
            for ($i = 0; $i < $nPermisos; $i++) {
                if (substr($oCon->f('perfil_permisos'), $i, 1) == '1')
                    $Permisos[$i] = true;
                else
                    $Permisos[$i] = false;
            }
            return $Permisos;
        } else
            return false;
    }
}

function cmb_horas(&$fu, $nombre, $tipo)
{
    if ($tipo == 'hh') {
        for ($i = 0; $i <= 23; $i++) {
            if ($i < 10)
                $fu->AgregarOpcionCampoLista($nombre, '0' . $i, '0' . $i);
            else
                $fu->AgregarOpcionCampoLista($nombre, $i, $i);
        }
    } elseif ($tipo == 'mm') {
        for ($i = 0; $i <= 59; $i++) {
            if ($i < 10)
                $fu->AgregarOpcionCampoLista($nombre, '0' . $i, '0' . $i);
            else
                $fu->AgregarOpcionCampoLista($nombre, $i, $i);
        }
    }
}

function genera_niveles_menu($oCon = '', $nivel = '', $codigo = '')
{
    if ($oCon == '' || $nivel == '')
        return false;
    else {
        $limite = ($nivel / 2) - 1;
        $menu = 'MENU :: <a href="javascript:;" onclick="xajax_genera_menu()">Principal</a> ';
        $codMenu = '';
        for ($i = 0; $i < $limite; $i++) {
            $codMenu .= substr($codigo, ($i * 2), 2);
            $Sql = 'SELECT * FROM comercial.MENU WHERE MENU_CODIGO = ?';
            $data = array($codMenu);
            if ($oCon->Query($Sql, $data)) {
                $niv = (strlen($oCon->f('menu_codigo')) + 2);
                $cod = $oCon->f('menu_codigo');
                $menu .= '/ <a href="javascript:;" onclick="xajax_genera_menu(' . $niv . ',\'' . $cod . '\')" >' . $oCon->f('menu_nombre') . '</a> ';
                $oCon->Free();
            }
        }
        $menu .= ' ';
        return $menu;
    }
}

function cargar_titulo($oCon = '', $menu_cod)
{
    if ($oCon == '')
        global $oCon;
    $oCon->Conectar();
    $Sql = "SELECT MENU_AYUDA_TITULO FROM comercial.MENU WHERE MENU_CODIGO =?";
    $data = array($menu_cod);
    if ($oCon->Query($Sql, $data)) {
        return $oCon->f("menu_ayuda_titulo");
        $oCon->free;
    } else
        return '';
}

function tiempo_horas($Tiempo)
{


    $fullDays = floor($Tiempo / (60 * 60 * 24));
    $fullHours = floor(($Tiempo - ($fullDays * 60 * 60 * 24)) / (60 * 60));
    $fullMinutes = floor(($Tiempo - ($fullDays * 60 * 60 * 24) - ($fullHours * 60 * 60)) / 60);
    $fullSeconds = floor(($Tiempo - ($fullDays * 60 * 60 * 24) - ($fullHours * 60 * 60) - ($fullMinutes * 60)));
    $Tiempo = $fullDays . ' dd ' . $fullHours . ' hh ' . $fullMinutes . ' mm ' . $fullSeconds . ' ss';
    return $Tiempo;
}

// funciones para pormato de fechas
function traducir_fecha($sistema, $val)
{
    if ($val != '') {
        $A = strftime('%A', strtotime($val));
        $d = strftime('%d', strtotime($val));
        $B = strftime('%B', strtotime($val));
        $Y = strftime('%Y', strtotime($val));
    } else {
        $A = strftime('%A');
        $d = strftime('%d');
        $B = strftime('%B');
        $Y = strftime('%Y');
    }
    if ($sistema == 'L') {
        switch ($A) {
            case 'Monday':
                $dia = 'Lunes';
                break;
            case 'Tuesday':
                $dia = 'Martes';
                break;
            case 'Wednesday':
                $dia = 'Miercoles';
                break;
            case 'Thursday':
                $dia = 'Jueves';
                break;
            case 'Friday':
                $dia = 'Viernes';
                break;
            case 'Saturday':
                $dia = 'Sabado';
                break;
            case 'Sunday':
                $dia = 'Domingo';
                break;
            default:
                $dia = $A;
        }
        switch ($B) {
            case 'January':
                $mes = 'Enero';
                break;
            case 'February':
                $mes = 'Febrero';
                break;
            case 'March':
                $mes = 'Marzo';
                break;
            case 'April':
                $mes = 'Abril';
                break;
            case 'May':
                $mes = 'Mayo';
                break;
            case 'June':
                $mes = 'Junio';
                break;
            case 'July':
                $mes = 'Julio';
                break;
            case 'August':
                $mes = 'Agosto';
                break;
            case 'September ':
                $mes = 'Septiembre';
                break;
            case 'October':
                $mes = 'Octubre';
                break;
            case 'November':
                $mes = 'Noviembre';
                break;
            case 'December':
                $mes = 'Diciembre';
                break;
            default:
                $mes = $B;
        }
        $fecha = $dia . ", " . $d . " de " . $mes . " de " . $Y;
    } else {
        $fecha = $A . ", " . $d . " de " . $B . " de " . $Y;
    }
    return $fecha;
}

function retorna_fecha($sistema, $val)
{
    if ($val != '') {
        $A = strftime('%A', strtotime($val));
        $d = strftime('%d', strtotime($val));
        $B = strftime('%B', strtotime($val));
        $Y = strftime('%Y', strtotime($val));
    } else {
        $A = strftime('%A');
        $d = strftime('%d');
        $B = strftime('%B');
        $Y = strftime('%Y');
    }
    if ($sistema == 'L') {
        switch ($A) {
            case 'Monday':
                $dia = 'Lunes';
                break;
            case 'Tuesday':
                $dia = 'Martes';
                break;
            case 'Wednesday':
                $dia = 'Miercoles';
                break;
            case 'Thursday':
                $dia = 'Jueves';
                break;
            case 'Friday':
                $dia = 'Viernes';
                break;
            case 'Saturday':
                $dia = 'Sabado';
                break;
            case 'Sunday':
                $dia = 'Domingo';
                break;
            default:
                $dia = $A;
        }
        switch ($B) {
            case 'January':
                $mes = 'Enero';
                break;
            case 'February':
                $mes = 'Febrero';
                break;
            case 'March':
                $mes = 'Marzo';
                break;
            case 'April':
                $mes = 'Abril';
                break;
            case 'May':
                $mes = 'Mayo';
                break;
            case 'June':
                $mes = 'Junio';
                break;
            case 'July':
                $mes = 'Julio';
                break;
            case 'August':
                $mes = 'Agosto';
                break;
            case 'September ':
                $mes = 'Septiembre';
                break;
            case 'October':
                $mes = 'Octubre';
                break;
            case 'November':
                $mes = 'Noviembre';
                break;
            case 'December':
                $mes = 'Diciembre';
                break;
            default:
                $mes = $B;
        }
        $fecha = $dia . ", " . $d . " de " . $mes . " de " . $Y;
    } else {
        $fecha = $A . ", " . $d . " de " . $B . " de " . $Y;
    }
    return $fecha;
}

function traducir_fecha_corta($sistema, $val)
{

    if ($val != '') {
        $posicion = strpos($val, '/');
        if ($posicion == 2) {
            $d = substr($val, 0, 2);
            $B = substr($val, 3, 2);
            $Y = substr($val, 7, 4);
            //echo $d."--".$B."--".$Y;
        } else {
            $d = substr($val, 9, 2);
            $B = substr($val, 5, 3);
            $Y = substr($val, 0, 4);
        }
    } else {

        $d = strftime('%d');
        $B = strftime('%b');
        $Y = strftime('%Y');
    }
    if ($sistema == 'L') {
        switch ($B) {
            case 'Jan':
                $mes = 'Ene';
                break;
            case 'Feb':
                $mes = 'Feb';
                break;
            case 'Mar':
                $mes = 'Mar';
                break;
            case 'Apr':
                $mes = 'Abr';
                break;
            case 'May':
                $mes = 'May';
                break;
            case 'Jun':
                $mes = 'Jun';
                break;
            case 'Jul':
                $mes = 'Jul';
                break;
            case 'Aug':
                $mes = 'Ago';
                break;
            case 'Sep':
                $mes = 'Sep';
                break;
            case 'Oct':
                $mes = 'Oct';
                break;
            case 'Nov':
                $mes = 'Nov';
                break;
            case 'Dec':
                $mes = 'Dic';
                break;
            default:
                $mes = $B;
        }
        $fecha = $d . "/" . strtoupper($mes) . "/" . $Y;
    } else {
        $fecha = $d . "/" . strtoupper($B) . "/" . $Y;
    }
    return $fecha;
}

function traducir_fecha_larga($sistema, $val)
{

    if ($val != '') {
        $posicion = strpos($val, '/');
        if ($posicion == 2) {
            $d = substr($val, 0, 2);
            $B = substr($val, 3, 2);
            $Y = substr($val, 7, 4);
            //echo $d."--".$B."--".$Y;
        } else {
            $d = substr($val, 9, 2);
            $B = substr($val, 5, 3);
            $Y = substr($val, 0, 4);
        }
    } else {

        $d = strftime('%d');
        $B = strftime('%b');
        $Y = strftime('%Y');
    }

    switch (strtoupper($B)) {
        case 'JAN':
            $mes = 'Enero';
            break;
        case 'ENE':
            $mes = 'Enero';
            break;
        case 'FEB':
            $mes = 'Febrero';
            break;
        case 'MAR':
            $mes = 'Marzo';
            break;
        case 'APR':
            $mes = 'Abril';
            break;
        case 'ABR':
            $mes = 'Abril';
            break;
        case 'MAY':
            $mes = 'Mayo';
            break;
        case 'JUN':
            $mes = 'Junio';
            break;
        case 'JUL':
            $mes = 'Julio';
            break;
        case 'AUG':
            $mes = 'Agosto';
            break;
        case 'AGO':
            $mes = 'Agosto';
            break;
        case 'SEP':
            $mes = 'Septiembre';
            break;
        case 'OCT':
            $mes = 'Octubre';
            break;
        case 'NOV':
            $mes = 'Noviembre';
            break;
        case 'DEC':
            $mes = 'Diciembre';
            break;
        case 'DIC':
            $mes = 'Diciembre';
            break;
        default:
            $mes = $B;
    }
    $fecha = $d . " de " . strtoupper($mes) . " de " . $Y;

    return $fecha;
}

// fin funciones formato de fechas
//Funcion Burbujas Ayuda

function burbuja_ayuda($sTexto = '', $sTitulo = 'Ayuda')
{
    $sHtml = 'onMouseOver="drc(\'' . $sTexto . '\', \'' . $sTitulo . '\'); return true;" onMouseOut="nd(); return true;"';
    return $sHtml;
}

//////////////////////////////////////////////
// funcion replica mail
function get_replica_mail($iCaso = 0, &$aUsuariosMail, &$sMensajeUsuarios)
{
    global $DSN;
    $oC = new Dbo;
    $oC->DSN = $DSN;
    // Obtiene los usuarios a los que replica los mensajes
    if ($iCaso != 0) {
        $oC->Conectar();
        $Sql = 'SELECT * FROM comercial.MAIL WHERE ID = ?';
        $Data = array($iCaso);
        if ($oC->Query($Sql, $Data)) {
            $sMensajeUsuarios['mensaje'] = $oC->f('mensaje');
            $sMensajeUsuarios['replica'] = $oC->f('msg_replica');
            if ($oC->f('perfil') == 'S') {
                $aPerfiles = explode(':', $oC->f('perfiles'));
                $oC->Free();
                $cont = 0;
                for ($i = 0; $i < count($aPerfiles); $i++) {
                    $Sql = 'SELECT * FROM comercial.USUARIO WHERE PERFIL_ID=?';
                    $Data = array($aPerfiles[$i]);
                    if ($oC->Query($Sql, $Data)) {
                        do {
                            if ($oC->f('usuario_id') != '') {
                                $aUsuariosMail[$cont]['id'] = $oC->f('usuario_id');
                                $aUsuariosMail[$cont]['nombre'] = $oC->f('usuario_nombre') . ' ' . $oC->f('usuario_apellido');
                                $aUsuariosMail[$cont]['email'] = $oC->f('usuario_email');
                                $cont++;
                            }
                        } while ($oC->SiguienteRegistro());
                        $oC->Free();
                    }
                }
            } else {
                $aUsuarios = explode(':', $oC->f('usuarios'));
                $oC->Free();
                $cont = 0;
                for ($i = 0; $i < count($aPerfiles); $i++) {
                    $Sql = 'SELECT * FROM comercial.USUARIO WHERE USUARIO_ID=?';
                    $Data = array($aUsuarios[$i]);
                    if ($oC->Query($Sql, $Data)) {
                        do {
                            if ($oC->f('usuario_id') != '') {
                                $aUsuariosMail[$cont]['id'] = $oC->f('usuario_id');
                                $aUsuariosMail[$cont]['nombre'] = $oC->f('usuario_nombre') . ' ' . $oC->f('usuario_apellido');
                                $aUsuariosMail[$cont]['email'] = $oC->f('usuario_email');
                                $cont++;
                            }
                        } while ($oC->SiguienteRegistro());
                        $oC->Free();
                    }
                }
            }
        }
        $oC->Desconectar();
    }
}

// funcion variables reemplazo
function get_reemplazo(&$aBusca, &$aReemplaza, $aInfo = '')
{
    $aBusca = array('{usuario_nuevo_nombre_completo}',
        '{usuario_nuevo_usuario}',
        '{usuario_nuevo_clave}',
        '{usuario_nuevo_perfil}',
        '{usuario_nuevo_empresa}',
        '{usuario_nuevo_departamento}',
        '{usuario_log_usuario}',
        '{usuario_log_nombre_completo}',
        '{usuario_log_empresa}',
        '{usuario-log_departamento}',
        '{usuario_log_perfil}',
        '{servidor_fecha}',
        '{servidor_hora}',
        '{aplicacion_nombre_completo}',
        '{aplicacion_empresa}',
        '{aplicacion_url}');

    $aReemplaza = array($aInfo['usuario_nuevo_nombre_completo'],
        $aInfo['usuario_nuevo_usuario'],
        $aInfo['usuario_nuevo_clave'],
        $aInfo['usuario_nuevo_perfil'],
        $aInfo['usuario_nuevo_empresa'],
        $_SESSION["U_NOMBRECOMPLETO"],
        traducir_fecha('L', date(Y) . '/' . date(m) . '/' . date(d)),
        date("H:i:s"),
        '',
        'daniel');
}

// funcion envia mail
function envia_mail($iCaso = 0, $sInfo = '')
{
    $aUsuarios = array();
    $aMensajes = array();
    get_replica_mail($iCaso, $aUsuarios, $aMensajes);
    for ($i = 0; $i < count($aUsuariosMail); $i++) {
        echo $aUsuarios[$i]['id'];
        echo $aUsuarios[$i]['nombre'];
        echo $aUsuarios[$i]['email'] . '<br>';
    }

    $sMensajes['replica'] = str_replace($aBusca, $aReemplaza, $sMensajeUsuarios);

    echo $sMensajes['replica'];
    // Fin Obtiene los usuarios a los que replica los mensajes
    switch ($iCaso) {
        case 1:

            break;
    }
}

//funcion para cambio de clase segun valor

function estilo_valor($valort, $valorg)
{
    if ($valort < $valorg) {
        $class = 'azul';
        return $class;
    } elseif ($valort == $valorg) {
        $class = 'verde';
        return $class;
    } else {
        $class = 'rojo';
        return $class;
    }
}

// Mostramos con formato de miles y centavos a un valor entero
function formatoPlata($numero, $centavos = 1)
{ // centavos: 0=nunk, 1=si es necesario, 2=100pre
    if (is_numeric($numero)) { // numero
        if (!$numero) { // cero
            $plata = ($centavos == 2 ? '0,00' : '0'); // salida cero
        } else { // valor
            if (floor($numero) == $numero) { // todo el numero
                $plata = number_format($numero, ($centavos == 2 ? 2 : 0), ",", "."); // formato
            } else { // centavos
                $plata = number_format(round($numero, 2), ($centavos == 0 ? 0 : 2), ",", "."); // formato
            } // entero o decimal
        } // valor
        return $plata;
    } // numero
}

// formatplata
//sacamos Porcentaje de un valor
function porcentaje($total, $parte, $redondear = 2)
{
    if ($total == 0) {
        //$parte=1;
        $total = 1;
    }
    return round($parte / $total * 100, $redondear);
}

//fin porcentaje
//sacamos promedio desde un porcentaje
function promedio($total, $parte)
{
    return ($total / 100 * $parte);
}

// validador de cedula
function validar_cedula($cedula, $mostrar_error = 0)
{
    // Verificamos si lo ingresado son  numeros
    $msn = '';
    // verificamos si el numero de cedula tiene 10 digitos
    if (strlen($cedula) == '10' || strlen($cedula) == '13') {
        // verificamos si los dos primeros digitos son inferiores a 24 y superiores a 1
        $c = substr($cedula, 0, 2); // extraemos los primeros digitos
        // hacemos la verificacion
        if ($c >= '1' && $c <= '24') {

            // verificamos si el tercer digito es menor a 6
            if ($cedula[2] < 6) {

                // calculamos el digito de control
                $imp = "0"; // ponemos a cero los impares
                $par = "0"; // los pares
                $c = 0; // variable temporal
                $d = 0; // otra

                for ($i = 0; $i < 9; $i++) {
                    if ($i % 2 == 0) {
                        if (($cedula[$i] * 2) > 9) {
                            // le restamos 9 si la suma es superior a 9 a la multiplicacion por 2
                            $c = ($cedula[$i] * 2) - 9;
                        } else {
                            // si no pues multiplicamos por dos y ya
                            $c = ($cedula[$i] * 2);
                        }
                        $imp = $c + $imp;
                    } else {
                        if (($cedula[$i] * 1) > 9) {
                            // si es superior a 9 le restamos 9 a la multiplicacion por 1
                            $d = ($cedula[$i] * 1) - 9;
                        } else {
                            // si no pues solo multiplicamos
                            $d = ($cedula[$i] * 1);
                        }
                        $par = $d + $par;
                    }
                } // fin for sumamos resultados de los pares e impares
                $suma = $par + $imp;

                //Descontamos la decena superior
                $z = 0;
                while ($suma % 10 != 0) {
                    $suma++;
                    $z++;
                }

                // comparamos si el ultimo digito de la cedula es igual al resultado obtenido.
                if ($z == $cedula[9]) {

                    if ($mostrar_error == 1) {
                        $msn = "OK";
                    } else {
                        return TRUE;
                    } // cedula correcta
                    // damos errores todo el resto
                } else {
                    if ($mostrar_error == 1) {
                        $msn = "El ultimo numero (digito de control) no es correcto... ";
                    } else {
                        return FALSE;
                    }
                }
            } else {
                if ($mostrar_error == 1) {
                    $msn = "El tercer digito debe ser inferior a 6 (0,1,2,3,4,5)... ";
                } else {
                    return FALSE;
                }
            }
        } else {
            if ($mostrar_error == 1) {
                $msn = "Los dos primeros numeros deben ser superior a 1 e inferior o igual a 24.. ";
            } else {
                return FALSE;
            }
        }
    } else {
        if ($mostrar_error == 1) {
            $msn = "El numero ingresado no tiene 10 o 13 digitos... ";
        } else {
            return FALSE;
        }
    }  // el largo es diferente de 10 digitos

    return $msn;
}

// fin de la function

function calcular_edad($fechanacimiento)
{
    $nacimiento = new DateTime($fechanacimiento);
    $ahora = new DateTime(date("Y-m-d"));
    $diferencia = $ahora->diff($nacimiento);
    return $diferencia->format("%y");
}

function acento_func($palabra)
{
//    $search = array('�', '�', '�?');
//    $replace = array('O', 'O', '&ntilde;');
//    $palabra = str_replace($search, $replace, $palabra);
    return $palabra;
}

/* * ******************************************
  +
  SUMA DIAS A UNA FECHA X, PERO LA FECHA DE PARAMETRO ES YY-MM-DD
 * Y EL RESULTADO ES EN YY-MM-DD
  +
 * ****************************************** */

function sumar_dias_func($fecha, $ndias)
{
    $nuevafecha = date("Y-m-d", strtotime($fecha.'+ '.$ndias.' days'));
    return ($nuevafecha);
}

function sumar_dias_func_roma($fecha, $ndias)
{
    $nuevafecha = date("Y-m-d", strtotime($fecha.'+ '.$ndias.' days'));
    return ($nuevafecha);
}


function sumar_dias_post($fecha, $ndias){
    $nuevafecha = date("Y-m-d", strtotime($fecha."+ ".$ndias." days"));
    return ($nuevafecha);
}

function fecha_mysql_func($fecha)
{
    /*$fecha_array = explode('/', $fecha);
    $m = $fecha_array[0];
    $y = $fecha_array[2];
    $d = $fecha_array[1];

    return ($d . '/' . $m . '/' . $y);*/
    return $fecha;
}

function fecha_mysql_func_($fecha)
{
    $fecha_array = explode('/', $fecha);
    $m = $fecha_array[0];
    $y = $fecha_array[2];
    $d = $fecha_array[1];

    return ($y . '/' . $m . '/' . $d);
}

function consulta_string_func($sql, $campo, $Conexion, $defecto)
{

    $resultado = 0;
    if ($Conexion->Query($sql)) {
        if ($Conexion->NumFilas() > 0) {
            $resultado = $Conexion->f($campo);
            if (empty($resultado)) {
                $resultado = $defecto;
            }
        } else {
            $resultado = $defecto;
        }
    }
    $Conexion->Free();
    return $resultado;
}

function secuencial($op, $serie, $as_codigo_pedido, $ceros_sql)
{
//string
    $ls_codigo;
    $ceros;
    $ls_codigos;

    //integer
    $li_codigo;
    $ceros1;
    $ll_numeros;
    $ll_codigo;

    if (isset($as_codigo_pedido) or $as_codigo_pedido == '') {
        $li_codigo = ($as_codigo_pedido);

        $li_codigo = 0;
    } else {
        $li_codigo = $as_codigo_pedido;
    }

    $li_codigo = $as_codigo_pedido;

    $li_codigo = $li_codigo + 1;
    $ll_numeros = strlen(($li_codigo));
    $ceros = cero_mas_func('0', $ceros_sql);
    $ceros1 = strlen($ceros);
    $ll_codigo = $ceros1 - $ll_numeros;

    switch ($op) {
        case 1:
            // secuencial user
            $ls_codigos = $serie . '-' . (cero_mas_func('0', $ll_codigo)) . ($li_codigo);
            break;
        case 2:
            // secuencial normal
            $ls_codigos = (cero_mas_func('0', $ll_codigo)) . ($li_codigo);
            break;
    }

    return $ls_codigos;
}

function cero_mas_func($caracter, $num)
{
    if ($num > 0) {
        for ($i = 1; $i <= $num; $i++) {
            $arreglo[$i] = $caracter;
        }

        foreach ($arreglo as $key => $Valor) {
            $cadena .= $Valor;
        }
    } else {
        $cadena = '';
    }

    return $cadena;
}

class EnLetras
{

    var $Void = "";
    var $SP = " ";
    var $Dot = ".";
    var $Zero = "0";
    var $Neg = "Menos";

    function ValorEnLetras($x, $Moneda)
    {
        $s = "";
        $Ent = "";
        $Frc = "";
        $Signo = "";

        if (floatVal($x) < 0)
            $Signo = $this->Neg . " ";
        else
            $Signo = "";

        if (intval(number_format($x, 2, '.', '')) != $x) //<- averiguar si tiene decimales
            $s = number_format($x, 2, '.', '');
        else
            $s = number_format($x, 2, '.', '');

        $Pto = strpos($s, $this->Dot);

        if ($Pto === false) {
            $Ent = $s;
            $Frc = $this->Void;
        } else {
            $Ent = substr($s, 0, $Pto);
            $Frc = substr($s, $Pto + 1);
        }

        if ($Ent == $this->Zero || $Ent == $this->Void)
            $s = "Cero ";
        elseif (strlen($Ent) > 7) {
            $s = $this->SubValLetra(intval(substr($Ent, 0, strlen($Ent) - 6))) .
                "Millones " . $this->SubValLetra(intval(substr($Ent, -6, 6)));
        } else {
            $s = $this->SubValLetra(intval($Ent));
        }

        if (substr($s, -9, 9) == "Millones " || substr($s, -7, 7) == "Mill�n ")
            $s = $s . "de ";

        $s = $s . $Moneda;

        if ($Frc != $this->Void) {
            $s = $s . " " . $Frc . "/100";
            //$s = $s . " " . $Frc . "/100";
        }
        $letrass = $Signo . $s . " ctvs";
        return ($Signo . $s . " ctvs");
    }

    function ValorEnLetrasMonePeru($x, $Moneda)
    {
        $s = "";
        $Ent = "";
        $Frc = "";
        $Signo = "";

        if (floatVal($x) < 0)
            $Signo = $this->Neg . " ";
        else
            $Signo = "";

        if (intval(number_format($x, 2, '.', '')) != $x) //<- averiguar si tiene decimales
            $s = number_format($x, 2, '.', '');
        else
            $s = number_format($x, 2, '.', '');

        $Pto = strpos($s, $this->Dot);

        if ($Pto === false) {
            $Ent = $s;
            $Frc = $this->Void;
        } else {
            $Ent = substr($s, 0, $Pto);
            $Frc = substr($s, $Pto + 1);
        }

        if ($Ent == $this->Zero || $Ent == $this->Void)
            $s = "Cero ";
        elseif (strlen($Ent) > 7) {
            $s = $this->SubValLetra(intval(substr($Ent, 0, strlen($Ent) - 6))) .
                "Millones " . $this->SubValLetra(intval(substr($Ent, -6, 6)));
        } else {
            $s = $this->SubValLetra(intval($Ent));
        }

        if (substr($s, -9, 9) == "Millones " || substr($s, -7, 7) == "Millï¿½n ")
            $s = $s . "de ";
            if(preg_match("/DOLAR/i",$Moneda)){

                //$Moneda='DOLARES';
                $s = $s . ' CON';
            }
            else{
                $s = $s . 'CON';
            }

        if ($Frc != $this->Void) {
            $s = $s . " " . $Frc . "/100";
            //$s = $s . " " . $Frc . "/100";
        }
        //if(preg_match("/DOLAR/i",$Moneda)){
          //  $Moneda='ctvs';
        //}
	
        $letrass = $Signo . $s . ' '.$Moneda;
        return ($Signo . $s . ' '.$Moneda);
    }



    function ValorEnLetrasMone($x, $Moneda)
    {
        $s = "";
        $Ent = "";
        $Frc = "";
        $Signo = "";

        if (floatVal($x) < 0)
            $Signo = $this->Neg . " ";
        else
            $Signo = "";

        if (intval(number_format($x, 2, '.', '')) != $x) //<- averiguar si tiene decimales
            $s = number_format($x, 2, '.', '');
        else
            $s = number_format($x, 2, '.', '');

        $Pto = strpos($s, $this->Dot);

        if ($Pto === false) {
            $Ent = $s;
            $Frc = $this->Void;
        } else {
            $Ent = substr($s, 0, $Pto);
            $Frc = substr($s, $Pto + 1);
        }

        if ($Ent == $this->Zero || $Ent == $this->Void)
            $s = "Cero ";
        elseif (strlen($Ent) > 7) {
            $s = $this->SubValLetra(intval(substr($Ent, 0, strlen($Ent) - 6))) .
                "Millones " . $this->SubValLetra(intval(substr($Ent, -6, 6)));
        } else {
            $s = $this->SubValLetra(intval($Ent));
        }

        if (substr($s, -9, 9) == "Millones " || substr($s, -7, 7) == "Mill�n ")
            $s = $s . "de ";
            if($Moneda=='DOLARES'){
                $s = $s . $Moneda. ' CON';
            }
            elseif(preg_match("/BOLIVAR/i",$Moneda)){
                $s = $s . $Moneda. ' CON';
            }
            else{
                $s = $s . 'CON';
            }

        if ($Frc != $this->Void) {

            if(preg_match("/BOLIVAR/i",$Moneda)){
                $formatterES = new NumberFormatter("es", NumberFormatter::SPELLOUT);
                $Frc=$formatterES->format( $Frc);
                $s = $s . " " . $Frc;
            }
            else{
                $s = $s . " " . $Frc . "/100";
            }
           
        }
        if($Moneda=='DOLARES'){
            $Moneda='ctvs';
        }
        if(preg_match("/BOLIVAR/i",$Moneda)){
            $Moneda='centimos';
        }
       
        $letrass = $Signo . $s . ' '.$Moneda;
        

        return ($Signo . $s . ' '.$Moneda);
    }

    function SubValLetra($numero)
    {
        $Ptr = "";
        $n = 0;
        $i = 0;
        $x = "";
        $Rtn = "";
        $Tem = "";

        $x = trim("$numero");
        $n = strlen($x);

        $Tem = $this->Void;
        $i = $n;

        while ($i > 0) {
            $Tem = $this->Parte(intval(substr($x, $n - $i, 1) .
                str_repeat($this->Zero, $i - 1)));
            if ($Tem != "Cero")
                $Rtn .= $Tem . $this->SP;
            $i = $i - 1;
        }


        //--------------------- GoSub FiltroMil ------------------------------
        $Rtn = str_replace(" Mil Mil", " Un Mil", $Rtn);
        while (1) {
            $Ptr = strpos($Rtn, "Mil ");
            if (!($Ptr === false)) {
                if (!(strpos($Rtn, "Mil ", $Ptr + 1) === false))
                    $this->ReplaceStringFrom($Rtn, "Mil ", "", $Ptr);
                else
                    break;
            } else
                break;
        }

        //--------------------- GoSub FiltroCiento ------------------------------
        $Ptr = -1;
        do {
            $Ptr = strpos($Rtn, "Cien ", $Ptr + 1);
            if (!($Ptr === false)) {
                $Tem = substr($Rtn, $Ptr + 5, 1);
                if ($Tem == "M" || $Tem == $this->Void)
                    ;
                else
                    $this->ReplaceStringFrom($Rtn, "Cien", "Ciento", $Ptr);
            }
        } while (!($Ptr === false));

        //--------------------- FiltroEspeciales ------------------------------
        $Rtn = str_replace("Diez Un", "Once", $Rtn);
        $Rtn = str_replace("Diez Dos", "Doce", $Rtn);
        $Rtn = str_replace("Diez Tres", "Trece", $Rtn);
        $Rtn = str_replace("Diez Cuatro", "Catorce", $Rtn);
        $Rtn = str_replace("Diez Cinco", "Quince", $Rtn);
        $Rtn = str_replace("Diez Seis", "Dieciseis", $Rtn);
        $Rtn = str_replace("Diez Siete", "Diecisiete", $Rtn);
        $Rtn = str_replace("Diez Ocho", "Dieciocho", $Rtn);
        $Rtn = str_replace("Diez Nueve", "Diecinueve", $Rtn);
        $Rtn = str_replace("Veinte Un", "Veintiun", $Rtn);
        $Rtn = str_replace("Veinte Dos", "Veintidos", $Rtn);
        $Rtn = str_replace("Veinte Tres", "Veintitres", $Rtn);
        $Rtn = str_replace("Veinte Cuatro", "Veinticuatro", $Rtn);
        $Rtn = str_replace("Veinte Cinco", "Veinticinco", $Rtn);
        $Rtn = str_replace("Veinte Seis", "Veintiseis", $Rtn);
        $Rtn = str_replace("Veinte Siete", "Veintisiete", $Rtn);
        $Rtn = str_replace("Veinte Ocho", "Veintiocho", $Rtn);
        $Rtn = str_replace("Veinte Nueve", "Veintinueve", $Rtn);

        //--------------------- FiltroUn ------------------------------
        if (substr($Rtn, 0, 1) == "M")
            $Rtn = "Un " . $Rtn;
        //--------------------- Adicionar Y ------------------------------
        for ($i = 65; $i <= 88; $i++) {
            if ($i != 77)
                $Rtn = str_replace("a " . Chr($i), "* y " . Chr($i), $Rtn);
        }
        $Rtn = str_replace("*", "a", $Rtn);
        return ($Rtn);
    }

    function ReplaceStringFrom(&$x, $OldWrd, $NewWrd, $Ptr)
    {
        $x = substr($x, 0, $Ptr) . $NewWrd . substr($x, strlen($OldWrd) + $Ptr);
    }

    function Parte($x)
    {
        $Rtn = '';
        $t = '';
        $i = '';
        do {
            switch ($x) {
                case 0:
                    $t = "Cero";
                    break;
                case 1:
                    $t = "Un";
                    break;
                case 2:
                    $t = "Dos";
                    break;
                case 3:
                    $t = "Tres";
                    break;
                case 4:
                    $t = "Cuatro";
                    break;
                case 5:
                    $t = "Cinco";
                    break;
                case 6:
                    $t = "Seis";
                    break;
                case 7:
                    $t = "Siete";
                    break;
                case 8:
                    $t = "Ocho";
                    break;
                case 9:
                    $t = "Nueve";
                    break;
                case 10:
                    $t = "Diez";
                    break;
                case 20:
                    $t = "Veinte";
                    break;
                case 30:
                    $t = "Treinta";
                    break;
                case 40:
                    $t = "Cuarenta";
                    break;
                case 50:
                    $t = "Cincuenta";
                    break;
                case 60:
                    $t = "Sesenta";
                    break;
                case 70:
                    $t = "Setenta";
                    break;
                case 80:
                    $t = "Ochenta";
                    break;
                case 90:
                    $t = "Noventa";
                    break;
                case 100:
                    $t = "Cien";
                    break;
                case 200:
                    $t = "Doscientos";
                    break;
                case 300:
                    $t = "Trescientos";
                    break;
                case 400:
                    $t = "Cuatrocientos";
                    break;
                case 500:
                    $t = "Quinientos";
                    break;
                case 600:
                    $t = "Seiscientos";
                    break;
                case 700:
                    $t = "Setecientos";
                    break;
                case 800:
                    $t = "Ochocientos";
                    break;
                case 900:
                    $t = "Novecientos";
                    break;
                case 1000:
                    $t = "Mil";
                    break;
                case 1000000:
                    $t = "Millon";
                    break;
            }

            if ($t == $this->Void) {
                $i = $i + 1;
                $x = $x / 1000;
                if ($x == 0)
                    $i = 0;
            } else
                break;
        } while ($i != 0);

        $Rtn = $t;
        switch ($i) {
            case 0:
                $t = $this->Void;
                break;
            case 1:
                $t = " Mil";
                break;
            case 2:
                $t = " Millones";
                break;
            case 3:
                $t = " Billones";
                break;
        }
        return ($Rtn . $t);
    }

}

function consulta_string($sql, $campo, $Conexion, $defecto)
{

    $total_mes_stock = 0;
    if ($Conexion->Query($sql)) {
        if ($Conexion->NumFilas() > 0) {
            $total_mes_stock = $Conexion->f($campo);
            if (empty($total_mes_stock)) {
                $total_mes_stock = $defecto;
            }
        } else {
            $total_mes_stock = $defecto;
        }
    }
    $Conexion->Free();
    return $total_mes_stock;
}

function varchInfor($cadena = '')
{
//    $cadena = utf8_decode($cadena);
    $arraCade = str_split($cadena);

    $cadeRetu .= "'";
    for ($i = 0; $i < count($arraCade); $i++) {

        if ($arraCade[$i] == "'")
            $cadeRetu .= "'||\"" . $arraCade[$i] . "\"||'";
        else
            $cadeRetu .= $arraCade[$i];
    }

    $cadeRetu .= "'";

    return $cadeRetu;
}

function varchJavas($cadena = '')
{
    $cadena = htmlentities($cadena);
    $arraCade = str_split($cadena);

    $cadeRetu .= "'";
    for ($i = 0; $i < count($arraCade); $i++) {

        if ($arraCade[$i] == "'")
            $cadeRetu .= "\\" . "$arraCade[$i]";
        else
            $cadeRetu .= $arraCade[$i];
    }

    $cadeRetu .= "'";

    return $cadeRetu;
}

function verificaremail($email)
{
    if (!ereg("^([a-zA-Z0-9._]+)@([a-zA-Z0-9.-]+).([a-zA-Z]{2,4})$", $email)) {
        return FALSE;
    } else {
        return TRUE;
    }
}

function costo_promedio_func($empresa, $sucursal, $cod_prod, $bodega, $fecha, $Conexion)
{
    $sqling = "SELECT SUM(dmov_can_dmov * dmov_cun_dmov) as sumacosto, SUM(dmov_can_dmov) as sumacant
    from saedmov, saeminv 
    join saedefi on minv_cod_tran = defi_cod_tran AND minv_cod_sucu = defi_cod_sucu and minv_cod_empr = defi_cod_empr 
    where minv_num_comp = dmov_num_comp 
    and dmov_cod_prod = '$cod_prod' 
    and minv_fmov <= '$fecha' 
    and minv_cod_empr = $empresa 
    and minv_cod_sucu = $sucursal 
    and (dmov_cod_bode = $bodega and defi_tip_defi not in ('6') OR dmov_bod_envi = $bodega and defi_tip_defi in ('6'))
    and dmov_cod_sucu = $sucursal 
    and minv_cod_tran in (select t.tran_cod_tran from saetran t, saedefi d  where
                            t.tran_cod_tran = d.defi_cod_tran and
                            t.tran_cod_empr = $empresa and
                            t.tran_cod_sucu = $sucursal and
                            t.tran_cod_modu = 10 and
                            d.defi_cod_empr = $empresa and
                            d.defi_tip_defi in ('0', '5', '6') and 
                            d.defi_cod_modu = 10)";
    
    $sqlegr = "SELECT SUM(dmov_can_dmov * dmov_cun_dmov) as sumacosto, SUM(dmov_can_dmov) as sumacant
												from saedmov, saeminv 
												where minv_num_comp = dmov_num_comp 
												and dmov_cod_prod = '$cod_prod' 
												and minv_fmov <= '$fecha' 
												and minv_cod_empr = $empresa 
												and minv_cod_sucu = $sucursal 
												and (dmov_cod_bode = $bodega) 
												and dmov_cod_sucu = $sucursal 
												and minv_cod_tran in (select t.tran_cod_tran from saetran t, saedefi d  where
																		t.tran_cod_tran = d.defi_cod_tran and
																		t.tran_cod_empr = $empresa and
																		t.tran_cod_sucu = $sucursal and
																		t.tran_cod_modu = 10 and
																		d.defi_cod_empr = $empresa and
																		d.defi_tip_defi in ('1','6') and 
																		d.defi_cod_modu = 10)";
    
    $Sumacosto = consulta_string_func($sqling, 'sumacosto', $Conexion, 0) - consulta_string_func($sqlegr, 'sumacosto', $Conexion, 0);
	$Sumacant = consulta_string_func($sqling, 'sumacant', $Conexion, 0) - consulta_string_func($sqlegr, 'sumacant', $Conexion, 0);
    $costo = 0;
    if ($Sumacant > 0 )
    {
        $costo = round(($Sumacosto / $Sumacant), 6);
    }

    //echo $costo; exit;
    return $costo;
}

function ultimo_costo_func($empresa, $sucursal, $cod_prod, $bodega, $fecha, $Conexion)
{
    $sql = "SELECT prbo_uco_prod from saeprbo where prbo_cod_bode = $bodega and prbo_cod_prod = '$cod_prod'";
    $costo = 0;
    $costo = consulta_string_func($sql, 'prbo_uco_prod', $Conexion, 0);
    if ($costo < 0) {
        $costo = 0;
    }
    return $costo;
}

function ultimo_cant_func($empresa, $sucursal, $cod_prod, $bodega, $fecha, $Conexion)
{
    $sql = "select COALESCE(cost_can_cost ,0) as costo from saecost Where
                cost_cod_bode   = $bodega and
                cost_cod_prod   = '$cod_prod' AND
                cost_cod_empr  = $empresa and
                cost_cod_sucu  = $sucursal and
                cost_cod_cost  = ( select max(cost_cod_cost)  From saecost   Where
                                        cost_cod_bode = $bodega and
                                        cost_cod_prod= '$cod_prod'  and
                                        cost_fec_cost <= '$fecha' AND
                                        cost_cod_empr = $empresa and
                                        cost_cod_sucu = $sucursal  and
                                        cost_val_unit > 0 ) ";
    $costo = 0;
    $costo = consulta_string_func($sql, 'costo', $Conexion, 0);
    if ($costo < 0) {
        $costo = 0;
    }
    return $costo;
}

function cambioFecha($fecha = '', $fechIni = '', $fechFina = '')
{
    $fecha = explode('-', $fecha);
    $fechIni = explode('-', $fechIni);
    $fechFina = explode('-', $fechFina);

    if (count($fecha) == 3 && count($fechIni) == 3 && count($fechFina) == 3) {
        for ($i = 0; $i < count($fechIni); $i++) {
            if (strtoupper($fechIni[$i]) == 'DD')
                $dia = $fecha[$i];
            else if (strtoupper($fechIni[$i]) == 'MM')
                $mes = $fecha[$i];
            else if (strtoupper($fechIni[$i]) == 'AAAA')
                $a_o = $fecha[$i];
        }

        for ($i = 0; $i < count($fechFina); $i++) {
            if (strtoupper($fechFina[$i]) == 'DD')
                $resu .= $dia . '-';
            else if (strtoupper($fechFina[$i]) == 'MM')
                $resu .= $mes . '-';
            else if (strtoupper($fechFina[$i]) == 'AAAA')
                $resu .= $a_o . '-';
        }
    } else
        return '--/--/--/';

    $resu = substr($resu, 0, -1);
    return $resu;
}
function certificado_laboral()
{

    global $DSN, $DSN_Ifx;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}


    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo();
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oIfxB = new Dbo();
    $oIfxB->DSN = $DSN_Ifx;
    $oIfxB->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $idempresa 	= $_SESSION['U_EMPRESA'];
    $idsucursal = $_SESSION['U_SUCURSAL'];
    $identifiacion = $_SESSION['U_IDEN'];
    $cargo=$_SESSION['U_CARGO'];

    //var_dump ($id); exit;


    //LOGOS DEL REPORTE

    // var_dump($identifiacion); exit;


    $sql = "select empr_path_logo,empr_web_color, empr_rrhh_nom, empr_nom_empr,empr_cod_ciud from saeempr where empr_cod_empr =  $idempresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $empr_path_logo = $oIfx->f('empr_path_logo');
            $empr_color = $oIfx->f('empr_web_color');
            $rrhh = $oIfx->f('empr_rrhh_nom');
            $nom_empr = $oIfx->f('empr_nom_empr');
            $ciud_empr = $oIfx->f('empr_cod_ciud');

        }
    }

    $sql_empl = "select empl_ape_nomb,empl_cod_sexo from saeempl where empl_cod_empl='$identifiacion'";
    if ($oIfx->Query($sql_empl)) {
        if ($oIfx->NumFilas() > 0) {

            $emplnom = $oIfx->f('empl_ape_nomb');

            $sexo = $oIfx->f('empl_cod_sexo');

        }
    }
    $xx='el';
    $y='la';

    if($sexo='M'){
        $sexo=''.$xx.' Sr.';

    }else{
        $sexo=''.$y.' Sra.';
    }
    $oIfx->Free();

    $sql_ciud="select ciud_nom_ciud from saeciud where ciud_cod_ciud=$ciud_empr";
    $ciud_empr=consulta_string($sql_ciud,'ciud_nom_ciud',$oIfxA,'');

    $sql_cargo="select estr_des_estr ,esem_fec_ingr , esem_fec_sali  from saeestr, saeesem where estr_cod_estr=esem_cod_estr and esem_cod_empl='$identifiacion' and esem_cod_estr='$cargo'";
    $cargo=consulta_string($sql_cargo,'estr_des_estr',$oIfxA,'');
    $ingreso=consulta_string($sql_cargo,'esem_fec_ingr',$oIfxA,'');
    $salida =consulta_string($sql_cargo,'esem_fec_sali',$oIfxA,'');

    $fecha=explode('-',$ingreso);
    $ianio=$fecha[0];
    $imes=$fecha[1];
    $imes=nomb_mes($imes);
    $idia=$fecha[2];

    $entrada="$idia de $imes del $ianio";


    if(empty($salida)){
        $salida='la presente fecha';
        $tra='trabaja';
    }else{
        $tra='trabajó';
        $fecha=explode('-',$salida);
        $sanio=$fecha[0];
        $smes=$fecha[1];
        $smes=nomb_mes($smes);
        $sdia=$fecha[2];
    }


    //var_dump($cargo);exit;
    $arc_img = DIR_FACTELEC . "Include/Clases/Formulario/Plugins/reloj/" . basename($empr_path_logo);
    //echo $arc_img; exit;
    if (file_exists($arc_img)) {
        $imagen = $arc_img;
    } else {
        $imagen = '';
    }
    $logo = '';
    $x = '0px';

    if ($imagen != '') {

        $logo = '<div>
            <img src="' . $imagen . '" style="
            width:200px;
            object-fit; contain;">
            </div>';
        $x = '0px';
    }else{
        $logo = '<div>
        <h1 style="color:#FF0000">SIN LOGO</h1>
        </div>';
    }





    $formatter = new EnLetras();

    $dia=date('d');

    $mes=nomb_mes(date('m'));
    $anio=date('Y');




    $html=<<<EOD
<div>$logo</div>
<br>
<p align ="center">
<h1><u>CERTIFICADO LABORAL
</u></h1></p>
<br><br><br>
<p align ="left">
$ciud_empr, $dia de $mes del $anio 
</p>

<br>
<p style style="line-height: 200%">Por medio del presente certifico que  $sexo <b> $emplnom</b>, con número de identificacion <b>$identifiacion</b>, 
$tra para la empresa <b>$nom_empr</b>, desde <b>$entrada</b> hasta  <b>$salida</b>, desempeñando el cargo de <b> $cargo.</b><br></p> El interesado puede hacer uso del presente certificado dentro de los marcos legales
establecidos.<font size></p>


<br><br>Atentamente,<br><br><br><br><br><br><br><br>






<p align="left";style style="line-height: 200%">$rrhh<br>
<b>GERENTE DE TALENTO HUMANO <br>
$nom_empr<b></p>


EOD;


    $pdf = new TCPDF('P', 'mm', 'A4', true, 'UTF-8', false);
    $pdf->setPrintHeader(false);
    $pdf->setFooterFont(Array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));
    $pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);
    //$pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);
    $pdf->SetMargins(10,5, 10, true);
    $pdf->SetFooterMargin(PDF_MARGIN_FOOTER);
    // set auto page breaks
    $pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);
    // set image scale factor
    $pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);
    // set font
    $pdf->SetFont('helvetica', 'N', 10);
    // add a page
    $pdf->AddPage();

    $pdf->writeHTMLCell(0, 0, '', '',$html, 0, 1, 0, true, '', true);


    $docu='certificado-laboral-'.$identifiacion.'-'.date('YmdHis').'.pdf';

    $ruta=  DIR_FACTELEC . 'modulos/rrhh_ficha_empleado/certificados/'.$docu;


    $pdf->Output($ruta, 'F');
    return $html;


}

function certificado_laboral_cesante()
{

    global $DSN, $DSN_Ifx;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}


    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo();
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oIfxB = new Dbo();
    $oIfxB->DSN = $DSN_Ifx;
    $oIfxB->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $idempresa 	= $_SESSION['U_EMPRESA'];
    $idsucursal = $_SESSION['U_SUCURSAL'];
    $identifiacion = $_SESSION['U_IDEN'];
    $cargo=$_SESSION['U_CARGO'];

    //var_dump ($id); exit;


    //LOGOS DEL REPORTE

    // var_dump($identifiacion); exit;


    $sql = "select empr_path_logo,empr_web_color, empr_rrhh_nom, empr_nom_empr,empr_cod_ciud from saeempr where empr_cod_empr =  $idempresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $empr_path_logo = $oIfx->f('empr_path_logo');
            $empr_color = $oIfx->f('empr_web_color');
            $rrhh = $oIfx->f('empr_rrhh_nom');
            $nom_empr = $oIfx->f('empr_nom_empr');
            $ciud_empr = $oIfx->f('empr_cod_ciud');

        }
    }

    $sql_empl = "select empl_ape_nomb,empl_cod_sexo from saeempl where empl_cod_empl='$identifiacion'";
    if ($oIfx->Query($sql_empl)) {
        if ($oIfx->NumFilas() > 0) {

            $emplnom = $oIfx->f('empl_ape_nomb');

            $sexo = $oIfx->f('empl_cod_sexo');

        }
    }
    $xx='el';
    $y='la';

    if($sexo='M'){
        $sexo=''.$xx.' Sr.';

    }else{
        $sexo=''.$y.' Sra.';
    }
    $oIfx->Free();

    $sql_ciud="select ciud_nom_ciud from saeciud where ciud_cod_ciud=$ciud_empr";
    $ciud_empr=consulta_string($sql_ciud,'ciud_nom_ciud',$oIfxA,'');

    $sql_cargo="select estr_des_estr ,esem_fec_ingr , esem_fec_sali  from saeestr, saeesem where estr_cod_estr=esem_cod_estr and esem_cod_empl='$identifiacion' and esem_cod_estr='$cargo'";
    $cargo=consulta_string($sql_cargo,'estr_des_estr',$oIfxA,'');
    $ingreso=consulta_string($sql_cargo,'esem_fec_ingr',$oIfxA,'');
    $salida =consulta_string($sql_cargo,'esem_fec_sali',$oIfxA,'');

    $fecha=explode('-',$ingreso);
    $ianio=$fecha[0];
    $imes=$fecha[1];
    $imes=nomb_mes($imes);
    $idia=$fecha[2];

    $entrada="$idia de $imes del $ianio";


    if(empty($salida)){
        $salida='la presente fecha';
        $tra='trabaja';
    }else{
        $tra='trabajó';
        $fecha=explode('-',$salida);
        $sanio=$fecha[0];
        $smes=$fecha[1];
        $smes=nomb_mes($smes);
        $sdia=$fecha[2];
    }


    //var_dump($cargo);exit;
    $arc_img = DIR_FACTELEC . "Include/Clases/Formulario/Plugins/reloj/" . basename($empr_path_logo);
    //echo $arc_img; exit;
    if (file_exists($arc_img)) {
        $imagen = $arc_img;
    } else {
        $imagen = '';
    }
    $logo = '';
    $x = '0px';

    if ($imagen != '') {

        $logo = '<div>
            <img src="' . $imagen . '" style="
            width:200px;
            object-fit; contain;">
            </div>';
        $x = '0px';
    }else{
        $logo = '<div>
        <h1 style="color:#FF0000">SIN LOGO</h1>
        </div>';
    }





    $formatter = new EnLetras();

    $dia=date('d');

    $mes=nomb_mes(date('m'));
    $anio=date('Y');




    $html=<<<EOD
<div>$logo</div>
<br>
<p align ="center">
<h1><u>CERTIFICADO LABORAL
</u></h1></p>
<br><br><br>
<p align ="left">
$ciud_empr, $dia de $mes del $anio 
</p>

<br>
<p style style="line-height: 200%">Por medio del presente certifico que  $sexo <b> $emplnom</b>, con número de identificacion <b>$identifiacion</b>, 
$tra para la empresa <b>$nom_empr</b>, desde <b>$entrada</b> hasta  <b>$salida</b>, desempeñando el cargo de <b> $cargo.</b><br></p> El interesado puede hacer uso del presente certificado dentro de los marcos legales
establecidos.<font size></p>


<br><br>Atentamente,<br><br><br><br><br><br><br><br>






<p align="left";style style="line-height: 200%">$rrhh<br>
<b>GERENTE DE TALENTO HUMANO <br>
$nom_empr<b></p>


EOD;


    $pdf = new TCPDF('P', 'mm', 'A4', true, 'UTF-8', false);
    $pdf->setPrintHeader(false);
    $pdf->setFooterFont(Array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));
    $pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);
    //$pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);
    $pdf->SetMargins(10,5, 10, true);
    $pdf->SetFooterMargin(PDF_MARGIN_FOOTER);
    // set auto page breaks
    $pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);
    // set image scale factor
    $pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);
    // set font
    $pdf->SetFont('helvetica', 'N', 10);
    // add a page
    $pdf->AddPage();

    $pdf->writeHTMLCell(0, 0, '', '',$html, 0, 1, 0, true, '', true);


    $docu='certificado-laboral-'.$identifiacion.'-'.date('YmdHis').'.pdf';

    $ruta=  DIR_FACTELEC . 'modulos/rrhh_ficha_empleado/certificados/'.$docu;


    $pdf->Output($ruta, 'F');
    return $html;


}


function reporte_factura_respaldo($id = '', $nombre_archivo = '', $idSucursal ='', &$rutaPdf = '') {
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    // $idSucursal = $_SESSION['U_SUCURSAL'];


    $sql = "select empr_sn_conta, empr_cod_pais, empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr,empr_tel_resp, empr_ac1_empr, empr_ac2_empr, empr_mai_empr
                                            from saeempr where empr_cod_empr = $idEmpresa ";


    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            $tel_empresa = $oIfx->f('empr_tel_resp');
            $empr_mai_empr = $oIfx->f('empr_mai_empr');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
            $empr_ac1_empr = $oIfx->f('empr_ac1_empr');
            $empr_ac2_empr = $oIfx->f('empr_ac2_empr');
            $empr_cod_pais = $oIfx->f('empr_cod_pais');
            $empr_sn_conta = $oIfx->f('empr_sn_conta');
        }
    }
    $oIfx->Free();

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis, sucu_telf_secu  from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
            $sucu_telf_secu = $oIfx->f('sucu_telf_secu');
        }
    }
    $oIfx->Free();

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }

    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;



    // $path_logo_img = DIR_FACTELEC . 'imagenes/logos/' . $path_img[$count];
    $path_logo_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];


    $logo .= '<table style="width: 100%; margin: 0px;">';
    $logo .= '<tr>';
    $logo .= '<b><td align="center" style="width: 55%; border:1px solid black; border-radius: 5px; margin: 0px;">';
    $logo .= '<table align="center" style="margin: 0px;">';
    $logo .= '<tr><td style="margin-top: 0px;"><img width="300px;" height="150px;" src="' . $path_logo_img . '"></td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 20px;" width="300">' . $razonSocial . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 16px;">RUC : ' . $ruc_empr . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 14px;">TELEFONO : ' . $sucu_telf_secu . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 14px;" width="500">DIRECCION : ' . $dirMatriz . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';

    //selecciona sucursales y direcciones
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa LIMIT 1 ";
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                $logo .= '<tr><td align="center" style="font-size: 12px" width="500">' . $sucu_nom_sucu . ':' . htmlentities($sucu_dir_sucu) . '</td></tr>';
            } while ($oIfx->SiguienteRegistro());
        }
    }

    if(!empty($empr_ac2_empr)){
        $empr_ac2_empr = 'AGENTE DE RETENCION Nro. '.$empr_ac2_empr;
    }

    $logo .= '<tr><td>&nbsp;</td></tr>';
    //$logo .= '<tr><td align="center" style="font-size: 12px;">Contribuyente Especial #:' . $empr_num_resu . '</td></tr>';
    if($empr_conta_sn=='SI'){
        if($empr_sn_conta=='S'){
            $empr_sn_conta ='SI';
        }
        else{
            $empr_sn_conta ='NO';
        }
        $logo .= '<tr><td align="center" style="font-size: 12px;">Obligado a llevar Contabilidad :' . $empr_sn_conta . '</td></tr>';
    }
    //CONTRIBUYENTE REGIMEN MICROEMPRESA
    //ACTIVIDADES DE OPERACIONES  EN SISTEMAS DE DIST
    //$logo .= '<tr><td align="center" style="font-size: 12px;">CONTRIBUYENTE REGIMEN MICROEMPRESA</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 12px;">' . $empr_ac1_empr . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    //$logo .= '<tr><td align="center" style="font-size: 12px;">AGENTE DE RETENCION RESOLUCION Nro. NAC-DNCRASC20-00000001</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 12px;">'.$empr_ac2_empr.'</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= ' </table>';
    $logo .= '</td></b>';

    $sqlFac = "select * from saefact where fact_cod_fact = $id;";

    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $fact_nse_fact = $oIfx->f('fact_nse_fact');
                $fact_num_preimp = $oIfx->f('fact_num_preimp');
                $fact_auto_sri = $oIfx->f('fact_auto_sri');
                $fact_fech_sri = $oIfx->f('fact_fech_sri');
                $fact_nom_cliente = $oIfx->f('fact_nom_cliente');
                $fact_fech_fact = fecha_mysql_func($oIfx->f('fact_fech_fact'));
                $fact_ruc_clie = $oIfx->f('fact_ruc_clie');
                $fact_tlf_cliente = $oIfx->f('fact_tlf_cliente');
                $fact_dir_clie = htmlentities($oIfx->f('fact_dir_clie'));
                $fact_email_clpv = str_replace(' ', '', $oIfx->f("fact_email_clpv"));
                $fact_con_miva = $oIfx->f('fact_con_miva');
                $fact_sin_miva = $oIfx->f('fact_sin_miva');
                $fact_tot_fact = $oIfx->f('fact_tot_fact');
                $fact_iva = $oIfx->f('fact_iva');
                $fact_ice = $oIfx->f('fact_ice');
                $fact_clav_sri  = $oIfx->f('fact_clav_sri');
                $fact_dsg_valo  = $oIfx->f('fact_dsg_valo');
                $fact_cm1_fact  = $oIfx->f("fact_cm1_fact");
                $fact_cm2_fact  = $oIfx->f("fact_cm2_fact");
                $fact_cm4_fact  = $oIfx->f("fact_cm4_fact");
                $orden_compra   = $oIfx->f("fact_opc_fact");
                $fact_cod_clpv  = $oIfx->f("fact_cod_clpv");
                $fact_cod_ccli  = $oIfx->f("fact_cod_ccli");
                $fact_dia_plazo = $oIfx->f("fact_dia_fact");
                $fact_fech_venc = fecha_mysql_func($oIfx->f("fact_fech_venc"));
                $fact_cm3_fact  = $oIfx->f("fact_cm3_fact");
                $fact_cod_contr = $oIfx->f("fact_cod_contr");

                $id_usuario_w = $oIfx->f("fact_user_web");
                $sql = "select usuario_user, usuario_nombre, usuario_apellido  from comercial.usuario where usuario_id = '$id_usuario_w' ";
                if($oCon->Query($sql)){
                    if($oCon->NumFilas() > 0){
                        $usuario=$codigo = $oCon->f('usuario_nombre').' '.$oCon->f('usuario_apellido');
                    }
                }


                $logo .= '<b><td style="width: 45%; border: 1px solid black; border-radius: 5px;" align="center">';
                $logo .= ' <table align="center" style="font-size: 15px;">';
                $logo .= ' <tr>';
                $logo .= '<td style="border-bottom: 1px inset black;">FACTURA</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>SERIE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . substr($fact_nse_fact, 0, 3) . '-' . substr($fact_nse_fact, 3, 6) . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="font-size: 17px; color: red; border-bottom: 1;">' . $fact_num_preimp . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fact_auto_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1">FECHA AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fact_fech_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1" >AMBIENTE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $ambiente_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td style="border-top:1" >EMISION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $emision_sri . '</td>';
                $logo .= ' </tr>';

                //verifica si existe clave de acceso
                if ($fact_clav_sri != '') {
                    $nombArch = $fact_nse_fact . $fact_num_preimp;
                    //$nombArch = '0112201401179141325300110010010000048101234567818';
                    $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';

                    new barCodeGenrator($fact_clav_sri, 1, $rutaCodi, 450, 100, true);

                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="center" style="font-size: 12px;">CLAVE DE ACCESO</td>';
                    $logo .= '</tr>';
                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="center"> <img width="400px;" src="' . $rutaCodi . '"/></td>';
                    $logo .= '</tr>';
                }

                $logo .= ' </table>';
                $logo .= '</td></b>';
                $logo .= '</tr>';
                $logo .= '</table>';
                $logo .= ' <br>';

                $cliente .= ' <table style="width: 100%; border:1px solid black; border-radius: 5px; padding: 2px; font-size: 15x;">';
                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10%;">CLIENTE:</td></b>';
                $cliente .= ' <td style="width: 48%; ">' . $fact_nom_cliente . '</td>';
                $cliente .= ' <b><td style="width: 13%; ">FECHA EMISION:</td></b>';
                $cliente .= ' <td style="width: 29% ">' . $fact_fech_fact . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% ">RUC:</td></b>';
                $cliente .= ' <td style="width: 48% ">' . $fact_ruc_clie . '</td>';
                $cliente .= ' <b><td style="width: 13% ">TELEFONO:</td></b>';
                $cliente .= ' <td style="width: 29% ">' . $fact_tlf_cliente . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% ">DIRECCION:</td></b>';
                $cliente .= ' <td style="width: 48% ">' . $fact_dir_clie . '</td>';
                $cliente .= ' <b><td style="width: 13% ">EMAIL:</td></b>';
                $cliente .= ' <td style="width: 29% ">' . $fact_email_clpv . '</td>';
                $cliente .= ' </tr>';
                $cliente .= ' </table>';

                $cliente .= ' <br>';
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $oIfx->Free();

    $sqlDeta = "select * from saedfac where dfac_cod_fact = $id and 
                dfac_cod_sucu = $idSucursal and 
                dfac_cod_empr = $idEmpresa  ";

    $deta .= ' <table style="width: 100%; font-size: 13px; border-radius: 5px; border-collapse: collapse;" border="1">';
    $deta .= ' <tr>';
    $deta .= ' <b> <td style="width: 16%;" align="center">CODIGO</td> </b>';
    $deta .= ' <b> <td style="width: 30%;" align="center">DESCRIPCION</td> </b>';
    $deta .= ' <b> <td style="width: 20%;" align="center">DETALLE</td> </b>';
    $deta .= ' <b> <td style="width:  8%;" align="center">CANT.</td> </b>';
    $deta .= ' <b> <td style="width:  8%;" align="center">PRECIO</td> </b>';
    $deta .= ' <b> <td style="width:  8%;" align="center">DSCTO %</td> </b>';
    $deta .= ' <b> <td style="width: 10%;" align="center">TOTAL</td> </b>';
    $deta .= ' </tr>';

    if ($oIfx->Query($sqlDeta)) {
        if ($oIfx->NumFilas() > 0) {
            $porcIva = '';
            do {
                $dfac_cod_prod = $oIfx->f('dfac_cod_prod');
                $dfac_nom_prod = $oIfx->f('dfac_nom_prod');
                $dfac_cant_dfac = $oIfx->f('dfac_cant_dfac');
                $dfac_precio_dfac = $oIfx->f('dfac_precio_dfac');
                $dfac_des1_dfac = $oIfx->f('dfac_des1_dfac');
                $dfac_des2_dfac = $oIfx->f('dfac_des2_dfac');
                $dfac_por_dsg = $oIfx->f('dfac_por_dsg');
                $dfac_mont_total = $oIfx->f('dfac_mont_total');
                $dfac_num_comp = $oIfx->f('dfac_tip_dfac');
                $dfac_por_iva = $oIfx->f('dfac_por_iva');
                $dfac_det_dfac = $oIfx->f('dfac_det_dfac');

                if ($dfac_por_iva > 0) {
                    $porcIva = $dfac_por_iva;
                }

                $descuento = $dfac_des1_dfac + $dfac_des2_dfac + $dfac_por_dsg;
                if ($descuento > 0)
                    $descuento = ($dfac_precio_dfac * $dfac_cant_dfac) - ($dfac_mont_total);
                else
                    $descuento = 0;

                $totalDescuento = $totalDescuento + $descuento;

                $deta .= ' <tr>';
                $deta .= ' <td style="width: 16%;">' . $dfac_cod_prod . '</td>';
                $deta .= ' <td style="width: 30%;">' . $dfac_nom_prod . '</td>';
                $deta .= ' <td style="width: 20%;">' . $dfac_det_dfac . '</td>';
                $deta .= ' <td style="width: 8%;" align="right">' . number_format($dfac_cant_dfac, 4, '.', ',') . '</td>';
                $deta .= ' <td style="width: 8%;" align="right">' . number_format($dfac_precio_dfac, 4, '.', ',') . '</td>';
                $deta .= ' <td style="width: 8%;" align="right">' . round($dfac_des1_dfac, 0) . '</td>';
                $deta .= ' <td style="width: 10%;" align="right">' . number_format($dfac_mont_total, 4, '.', ',') . '</td>';
                $deta .= ' </tr>';
            }while ($oIfx->SiguienteRegistro());
        }
    }

    $deta .= ' </table>';

    $totales .= ' <table style="width: 100%; font-size: 13px; margin-top: 3px; border-radius: 5px; border-collapse: collapse;"  border=1 align="right">';


    $totales .= ' <tr>';
    $totales .= ' <b> <td>SUBTOTAL ' . round($porcIva) . ' %:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_con_miva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>SUBTOTAL 0%:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_sin_miva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>SUBTOTAL SIN IMPUESTOS:</td> </b>';
    $totales .= ' <td style="width: 10%;" align="right">' . number_format($fact_con_miva-$fact_ice, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>TOTAL DESCUENTO:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>IVA ' . round($porcIva) . '%:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_iva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>ICE:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_ice, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>TOTAL:</td> </b>';
    $fact_tot_fact = $fact_con_miva + $fact_iva;
    $totales .= ' <td align="right">' . number_format($fact_tot_fact, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' </table>';


    $sqltmp ='';
    if (!empty($fact_cod_contr)) {
        $sqltmp ="id_contrato = $fact_cod_contr AND";
    }

    $total = number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_fle_fact + $fact_otr_fact + $fact_fin_fact - $totalDescuento, 2, '.', '');
    $V = new EnLetras();
    $con_letra = strtoupper($V->ValorEnLetras($total, 'dolar'));

    //query forma de pago
    $sqlFPago = "select fp.fpag_cod_fpagop, fx.fxfp_val_fxfp, fx.fxfp_num_dias,
				fpg.fpagop_des_fpagop
				from saefact f, saefxfp fx, saefpag fp, saefpagop fpg
				where 
                f.fact_cod_fact = fx.fxfp_cod_fact and
				fp.fpag_cod_fpag = fx.fxfp_cod_fpag and
                f.fact_cod_empr = fpg.fpagop_cod_empr and
				fp.fpag_cod_fpagop = fpg.fpagop_cod_fpagop and
				f.fact_cod_empr = $idEmpresa and
				f.fact_cod_sucu = $idSucursal and
				f.fact_cod_fact = $id";
    if ($oIfx->Query($sqlFPago)) {
        if ($oIfx->NumFilas() > 0) {
            $tablePago .= '<table style="width: 60%; border-collapse: collapse; margin-top: 10px;" border="1">';
            $tablePago .= '<tr>';
            $tablePago .= '<th style="width: 70%;">FORMA PAGO</th>';
            $tablePago .= '<th style="width: 30%;">VALOR</th>';
            $tablePago .= '</tr>';
            do {
                $fpag_cod_fpagop    = $oIfx->f('fpag_cod_fpagop');
                $fxfp_val_fxfp      = $oIfx->f('fxfp_val_fxfp');
                $fxfp_num_dias      = $oIfx->f('fxfp_num_dias');
                $fpagop_des_fpagop  = $oIfx->f('fpagop_des_fpagop');

                $tablePago .= '<tr>';
                $tablePago .= '<td style="width: 70%;">' . $fpag_cod_fpagop . ' ' . htmlentities($fpagop_des_fpagop) . '</td>';
                $tablePago .= '<td style="width: 30%;" align="right">' . number_format($fxfp_val_fxfp, 2, '.', '') . '</td>';
                $tablePago .= '</tr>';
            } while ($oIfx->SiguienteRegistro());
            $tablePago .= '</table>';
        }
    }
    $oIfx->Free();

    if($empr_cod_pais==1){
        $msjCliente = "<p>Para la atencion de reclamos NO resueltos por el prestador, ingrese su reclamo al 
                link: <a href='#'>http://reclamoconsumidor.arcotel.gob.ec/osTicket</a>, o para informacion 
                comuniquese con el numero telefonico 1800 567 567</p>";

        $msjRet = "LE INFORMAMOS QUE DE NO SER ENTREGADA LA RETENCION DENTRO DE LOS 5 PRIMEROS DIAS DE LA FECHA DE EMISION DE LA FACTURA
            O ESCANEADA AL CORREO '".$empr_mai_empr."' SE DEBERA CANCELAR EL VALOR TOTAL DE LA FACTURA DE ACUERDO AL ART. 50 DE LA LRTI";
    }else{
        $msjCliente = "";
        $msjRet = "";
    }

    // LEEYNDA
    $tableLeyenda .= '<br /> <br /> <br />';
    $tableLeyenda .= '<table style="width: 98%; border-collapse: collapse; margin-top: 10px;" border="0">';
    $tableLeyenda .= '<tr>';
    $tableLeyenda .= '<td style="width: 98%;" align="center">'.$msjCliente.'</td>';
    $tableLeyenda .= '</tr>';
    $tableLeyenda .= '<tr><td>&nbsp;</td></tr>';
    $tableLeyenda .= '<tr><td>&nbsp;</td></tr>';
    $tableLeyenda .= '<tr><td>&nbsp;</td></tr>';
    $tableLeyenda .= '<tr>';
    $tableLeyenda .= '<td style="width: 98%;" align="justify">'.$msjRet.'</td>';
    $tableLeyenda .= '</tr>';
    $tableLeyenda .= '</table>';

    $legend = '<page_footer>
        <table align="center" style="width: 80%">
            <tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">Este comprobante electronico ha sido generado a traves de Sisconti S.A. - Facturacion Electronica</td>
            </tr>
			<tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">www.sisconti.com</td>
            </tr>
        </table>
    </page_footer>';

    $documento .= '<page backimgw="70%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
    $documento .= $logo . $cliente . $deta . $totales . $tablePago. $tableLeyenda;
    $documento .= $legend;
    $documento .= '</page>';


    //file_put_contents("C:/prueba/documento.html", $documento);

    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;

    return $documento;
}


function reporte_factura($id = '', $nombre_archivo = '', $idSucursal ='', &$rutaPdf = '') {
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    //$idSucursal = $_SESSION['U_SUCURSAL'];

     //CAMPOS APROBACION
     $sqlgein="SELECT count(*) as conteo
     FROM INFORMATION_SCHEMA.COLUMNS
     WHERE COLUMN_NAME = 'empr_fac_empr' AND TABLE_NAME = 'saeempr'";
     $ctralter=consulta_string($sqlgein,'conteo',$oCon,0);
     if($ctralter==0){
         $sqlalter="alter table saeempr add  empr_fac_empr varchar(1)";
         $oCon->QueryT($sqlalter);
     }


     $sqlgein="SELECT count(*) as conteo
     FROM INFORMATION_SCHEMA.COLUMNS
     WHERE COLUMN_NAME = 'empr_det_fac' AND TABLE_NAME = 'saeempr'";
     $ctralter=consulta_string($sqlgein,'conteo',$oCon,0);
     if($ctralter==0){
         $sqlalter="alter table saeempr add  empr_det_fac text";
         $oCon->QueryT($sqlalter);
     }

    
    $sql = "SELECT  empr_sn_conta, empr_cod_pais, empr_cm1_empr, empr_rimp_sn, 
                    empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, 
                    empr_num_resu, empr_path_logo, empr_iva_empr,empr_tel_resp, 
                    empr_ac1_empr, empr_ac2_empr, empr_mai_empr, empr_tip_empr, empr_cm2_empr,
                    empr_fac_empr, empr_det_fac, empr_cta_sn, empr_det_cta,
                    empr_rinf_sn,  empr_det_rinf
                    from saeempr where empr_cod_empr = $idEmpresa ";

    
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            $tel_empresa = $oIfx->f('empr_tel_resp');
            $empr_mai_empr = $oIfx->f('empr_mai_empr');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';
            $empr_rimp_sn = $oIfx->f('empr_rimp_sn');
            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
            $empr_ac1_empr = $oIfx->f('empr_ac1_empr');
            $empr_ac2_empr = $oIfx->f('empr_ac2_empr');
            $empr_cm1_empr = $oIfx->f('empr_cm1_empr');
            $empr_cod_pais = $oIfx->f('empr_cod_pais');
            $empr_tip_empr = $oIfx->f('empr_tip_empr');
            $empr_cm2_empr = $oIfx->f('empr_cm2_empr');
            $empr_sn_conta = $oIfx->f('empr_sn_conta');


            $obfact=$oIfx->f('empr_fac_empr');
            $obdetfact=$oIfx->f('empr_det_fac');
            //INFORMACION BANCARIA
            $empr_cta_sn=$oIfx->f('empr_cta_sn');
            $empr_det_cta=$oIfx->f('empr_det_cta');
            //INFORMACION ADICIONAL
            $empr_rinf_sn=$oIfx->f('empr_rinf_sn');
            $empr_det_rinf=$oIfx->f('empr_det_rinf');
            
        }
    }
    $oIfx->Free();

    //VALIDACION DETALLE- CONVERSION

    $sqlfa="select para_dfa_para, para_conv_sn from saepara where para_cod_empr= $idEmpresa and para_cod_sucu=$idSucursal";
    $para_dfa_para=consulta_string($sqlfa,'para_dfa_para',$oCon,'');
    $para_conv_sn=consulta_string($sqlfa,'para_conv_sn',$oCon,'');
    

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis, sucu_telf_secu  from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
            $sucu_telf_secu = $oIfx->f('sucu_telf_secu');
        }
    }
    $oIfx->Free();

    //VALIDACION SUSCURSALES

    $sqls="select count(*) as cont from saesucu";
    $contsucu=consulta_string($sqls,'cont',$oIfx,0);

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }

    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;



    // $path_logo_img = DIR_FACTELEC . 'imagenes/logos/' . $path_img[$count];
    $path_logo_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];
    if (file_exists($path_logo_img)) {
        //echo "El fichero $nombre_fichero existe";
    } else {
        //echo "El fichero $nombre_fichero no existe";
        $path_logo_img = "https://turbologo.com/articles/wp-content/uploads/2019/05/no-logo.png";
    }
    //https://turbologo.com/articles/wp-content/uploads/2019/05/no-logo.png


    $logo .= '<table style="width: 100%; margin: 0px;">';
    $logo .= '<tr>';
    $logo .= '<td align="center" style="width: 55%; border:1px solid black; border-radius: 5px; margin: 0px;">';
    $logo .= '<table width: 55%; valign="center" style="margin: 0px;">';
    $logo .= '<tr><td style="margin-top: 0px;"><img width="250px;"  src="' . $path_logo_img . '"></td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="left" style="font-size: 15px;" width="300"><b>Emisor:</b> ' . $razonSocial . '</td></tr>';

    $sqlxml = "select ixml_tit_ixml, ixml_det_ixml from saeixml where ixml_cod_empr=$idEmpresa 
				and ixml_est_deleted ='S' and ixml_sn_pdf='S' order by ixml_ord_ixml";

				if ($oIfx->Query($sqlxml)) {
					if ($oIfx->NumFilas() > 0) {
						do {
							$titulo  = $oIfx->f('ixml_tit_ixml');
							$detalle = $oIfx->f('ixml_det_ixml');
                            $logo .= '<tr><td align="left" style="font-size: 14px;" width="300"><b>'.$titulo.'</b> ' . $detalle . '</td></tr>';
						} while ($oIfx->SiguienteRegistro());
					}
				}
	$oIfx->Free();


    //$logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>RUC:</b> ' . $ruc_empr . '</td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="left" style="font-size: 13px;" width="500"><b>Matriz:</b> ' . $dirMatriz . '</td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';


    //selecciona sucursales y direcciones
    $sql_sucu_matriz = "select sucu_dir_sucu from saesucu where sucu_nom_sucu ='MATRIZ'";
    $matriz = consulta_string($sql_sucu_matriz, 'sucu_dir_sucu', $oIfx, '');
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    $emprce="select empr_num_resu from saeempr where empr_cod_empr=$idEmpresa";
    $contribuyente= consulta_string($emprce, 'empr_num_resu', $oIfx, '');
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                //$logo .= '<tr><td align="center" style="font-size: 12px">' . $sucu_nom_sucu . ': ' . htmlentities($sucu_dir_sucu) . '</td></tr>';
                //$logo .= '<tr><td align="center" style="font-size: 13px">SUCURSAL : ' . $sucu_nom_sucu . '</td></tr>';

                ///$logo .= '<tr><td style="position:top; width:50px;"><h4>Direccion Matriz:</h4></td></tr><br>';
                //$logo .= '<tr><td>' . htmlentities($dirMatriz) . '</td></tr>';
                if( $contsucu>1){
                    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>Sucursal:</b> ' . $sucu_nom_sucu . '</td></tr>';

                    $logo .= '<tr><td align="left" style="font-size: 13px;" width="500" ><b>Direcci&oacute;n Sucursal:</b>' . $sucu_dir_sucu.'</td></tr>';
                }





            } while ($oIfx->SiguienteRegistro());
        }
    }
    //$logo .= '<tr><td>&nbsp;</td></tr>';

    //DATOS ADICIONALES
    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>Correo:</b> ' .  $empr_mai_empr . '</td></tr>';

    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>Tel&eacute;fono:</b> ' . $sucu_telf_secu . '</td></tr>';


    if ($empr_tip_empr == 'S') {
        $logo .= '<tr><td align="left" style="font-size: 12px;"><b>Contribuyente Especial #:</b> ' . $empr_num_resu . '</td></tr>';
    }//fin if*/
    /*if($empr_conta_sn=='SI'){
        $logo .= '<tr><td align="center" style="font-size: 12px;"><b>Contribuyente Especial #:</b> '.$contribuyente.'</td></tr>';
    }*/

    if(!empty($empr_ac2_empr)){
        $empr_ac2_empr = '<b>Agente de Retención Resolución Nro:</b> '.$empr_ac2_empr;
    }
    /*else{
        $empr_ac2_empr ='<b>AGENTE DE RETENCI&Oacute;N:</b> NO';
    }*/


    if($empr_conta_sn=='SI'){
        if($empr_sn_conta=='S'){
            $empr_sn_conta ='SI';
        }
        else{
            $empr_sn_conta ='NO';
        }
        $logo .= '<tr><td align="left" style="font-size: 12px;"><b>Obligado a llevar Contabilidad :</b> ' . $empr_sn_conta . '</td></tr>';
    }
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    if($empr_rimp_sn=="S"){
        $logo .= '<tr><td align="left" style="font-size: 12px;"><b>CONTRIBUYENTE R&Eacute;GIMEN RIMPE</b></td></tr>';
    }
    $logo .= '<tr><td align="left" style="font-size: 12px;">'.$empr_ac2_empr.'</td></tr>';

    if(!empty($empr_cm2_empr)){
        $logo .= '<tr><td align="left" style="font-size: 12px;"><b>'.$empr_cm2_empr.'</b></td></tr>';
    }

    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= ' </table>';
    $logo .= '</td>';

   
    $sqlgein = "SELECT count(*) as conteo
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE COLUMN_NAME = 'json_cab_pedi' AND TABLE_NAME = 'apipedi' AND TABLE_SCHEMA='apicomercial'";
    $ctralter = consulta_string($sqlgein, 'conteo', $oCon, 0);


    $sqlFac = "select * from saefact where fact_cod_fact = $id;";

    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $fact_nse_fact = $oIfx->f('fact_nse_fact');
                $fact_num_preimp = $oIfx->f('fact_num_preimp');
                $fact_auto_sri = $oIfx->f('fact_auto_sri');
                $fact_fech_sri = $oIfx->f('fact_fech_sri');
                $fact_nom_cliente = $oIfx->f('fact_nom_cliente');
                $fact_fech_fact = fecha_mysql_func($oIfx->f('fact_fech_fact'));
                $fact_ruc_clie = $oIfx->f('fact_ruc_clie');
                $fact_tlf_cliente = $oIfx->f('fact_tlf_cliente');
                $fact_dir_clie = htmlentities($oIfx->f('fact_dir_clie'));
                $fact_email_clpv = str_replace(' ', '', $oIfx->f("fact_email_clpv"));
                $fact_con_miva = $oIfx->f('fact_con_miva');
                $fact_sin_miva = $oIfx->f('fact_sin_miva');
                $fact_tot_fact = $oIfx->f('fact_tot_fact');
                $fact_iva = $oIfx->f('fact_iva');
                $fact_ice = $oIfx->f('fact_ice');
                $fact_fina_fact = $oIfx->f('fact_fina_fact');
                $fact_clav_sri  = $oIfx->f('fact_clav_sri');
                $fact_dsg_valo  = $oIfx->f('fact_dsg_valo');
                $fact_cm1_fact  = trim($oIfx->f("fact_cm1_fact"));
                $fact_cm2_fact  = $oIfx->f("fact_cm2_fact");
                $fact_cod_pac  = $oIfx->f("fact_cod_pac");
                
                $fact_cm4_fact  = $oIfx->f("fact_cm4_fact");
                $orden_compra   = $oIfx->f("fact_opc_fact");
                $fact_cod_clpv  = $oIfx->f("fact_cod_clpv");
                $fact_cod_ccli  = $oIfx->f("fact_cod_ccli");
                $fact_dia_plazo = $oIfx->f("fact_dia_fact");
                $fact_fech_venc = fecha_mysql_func($oIfx->f("fact_fech_venc"));
                $fact_cm3_fact  = $oIfx->f("fact_cm3_fact");
                $fact_cod_contr = $oIfx->f("fact_cod_contr");

                if(strlen($fact_auto_sri) == 0 || $fact_auto_sri == NULL){
                    $fact_auto_sri = "<strong style='color:red;'>(AUTORIZACION REQUERIDA)</strong>";
                }

                if(strlen($fact_fech_sri) > 0 || $fact_fech_sri != NULL){
                    $fact_fech_sri = new DateTime($fact_fech_sri);
                    $fact_fech_sri = $fact_fech_sri->format('d-m-Y H:i:s');
                }else {
                    $fact_fech_sri = "<strong style='color:red;'>(AUTORIZACION REQUERIDA)</strong>";
                }


                $id_usuario_w = $oIfx->f("fact_user_web");
                $sql = "select usuario_user, usuario_nombre, usuario_apellido  from comercial.usuario where usuario_id = '$id_usuario_w' ";
                if($oCon->Query($sql)){
                    if($oCon->NumFilas() > 0){
                        $usuario=$codigo = $oCon->f('usuario_nombre').' '.$oCon->f('usuario_apellido');
                    }
                }

                $fact_tip_vent = $oIfx->f("fact_tip_vent");
                $sql = "select tcmp_cod_tcmp, tcmp_des_tcmp from saetcmp where tcmp_cod_tcmp = '$fact_tip_vent';";
                $tipo_text_fac= consulta_string($sql,'tcmp_des_tcmp', $oCon,'FACTURA');


                 //VALIDACION CODIGO DE ORDEN PEDIDOS FOOTLOOSE

                if ($ctralter != 0){
                    $fact_cod_pedf=$oIfx->f("fact_cod_pedf");
                    if(empty($fact_cod_pedf)){
                        $fact_cod_pedf='NULL';
                    }        

                    $sql="select pedi_id_json from saepedf where pedf_cod_pedf=$fact_cod_pedf";
                    $id_json=consulta_string($sql,'pedi_id_json', $oCon,'');

               

                    ///CODIGO DE LA ORDEN "codigo_order"
                    $sqlor="select json_cab_pedi from apicomercial.apipedi where json_id_pedi='$id_json'";
                    if ($oCon->Query($sqlor)) {
                        if ($oCon->NumFilas() > 0) {
                            $json_cab_pedi=json_decode($oCon->f('json_cab_pedi',false));
                            $codigo_orden=$json_cab_pedi->codigo_order;
        
                             
                        }
                        else{
                            $codigo_orden='';
                        }
                    }
                    
                        
                    }
                    else{
                        $codigo_orden="";
                    }

                $logo .= '<b><td style="width: 45%; border: 1px solid black; border-radius: 5px;" align="center">';
                $logo .= ' <table align="center" style="font-size: 15px;">';
                $logo .= ' <tr>';
                $logo .= '<td style="border-bottom: 1px inset black;">'.$tipo_text_fac.'</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>SERIE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . substr($fact_nse_fact, 0, 3) . '-' . substr($fact_nse_fact, 3, 6) . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="font-size: 17px; color: red; border-bottom: 1;">' . $fact_num_preimp . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fact_auto_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1">FECHA AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fact_fech_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1" >AMBIENTE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $ambiente_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td style="border-top:1" >EMISION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $emision_sri . '</td>';
                $logo .= ' </tr>';

                //verifica si existe clave de acceso
                if ($fact_clav_sri != '') {
                    $nombArch = $fact_nse_fact . $fact_num_preimp;
                    //$nombArch = '0112201401179141325300110010010000048101234567818';
                    $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';

                    new barCodeGenrator($fact_clav_sri, 1, $rutaCodi, 450, 100, true);

                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="center" style="font-size: 12px;">CLAVE DE ACCESO</td>';
                    $logo .= '</tr>';
                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="center"> <img width="400px;" src="' . $rutaCodi . '"/></td>';
                    $logo .= '</tr>';
                }

                $logo .= ' </table>';
                $logo .= '</td></b>';
                $logo .= '</tr>';
                $logo .= '</table>';
                $logo .= ' <br>';

                $cliente .= ' <table style="width: 100%; border:1px solid black; border-radius: 5px; padding: 2px; font-size: 15x;">';
                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10%;">CLIENTE:</td></b>';
                $cliente .= ' <td style="width: 40%; ">' . $fact_nom_cliente . '</td>';
                $cliente .= ' <b><td style="width: 13%; ">FECHA EMISION:</td></b>';
                $cliente .= ' <td style="width: 37% ">' . $fact_fech_fact . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% ">RUC:</td></b>';
                $cliente .= ' <td style="width: 40% ">' . $fact_ruc_clie . '</td>';
                $cliente .= ' <b><td style="width: 13% ">TELEFONO:</td></b>';
                $cliente .= ' <td style="width: 37% ">' . $fact_tlf_cliente . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% ">DIRECCION:</td></b>';
                $cliente .= ' <td style="width: 40% ">' . $fact_dir_clie . '</td>';
                $cliente .= ' <b><td style="width: 13% ">EMAIL:</td></b>';
                $cliente .= ' <td style="width: 37% ">' . $fact_email_clpv . '</td>';
                $cliente .= ' </tr>';

                if(!empty($codigo_orden)){
                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% ">CODIGO DE ORDEN:</td></b>';
                $cliente .= ' <td style="width: 90% " colspan="3">' . $codigo_orden . '</td>';

                $cliente .= ' </tr>';
                }


                // -------------------------------------------------------------------------
                // campos fedexport solucion temporal borrar
                // -------------------------------------------------------------------------
                if($ruc_empr == 1790312143001 || $ruc_empr == 1791870158001){

                    if(!empty($fact_cod_pac)){
                        if(empty($orden_compra)){
                            $sql_oc = "SELECT orden_compra from contrato_clpv where id_clpv = $fact_cod_clpv and
                                        id_empresa = $idEmpresa";
                            $orden_compra = consulta_string_func($sql_oc, 'orden_compra', $oIfxA, '');
                        }
                    }
                    

                        $cliente .= ' <tr>';
                        $cliente .= ' <b><td style="width: 10% "></td></b>';
                        $cliente .= ' <td style="width: 48% "></td>';
                        $cliente .= ' <b><td style="width: 13% ">ORDEN DE COMPRA:</td></b>';
                        $cliente .= ' <td style="width: 29% ">' . $orden_compra . '</td>';
                        $cliente .= ' </tr>';
                    
                }
                // -------------------------------------------------------------------------
                // FIn campos fedexport solucion temporar borrar
                // -------------------------------------------------------------------------


                $cliente .= ' </table>';

                $cliente .= ' <br>';
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $oIfx->Free();

    $sqlDeta = "select * from saedfac where dfac_cod_fact = $id and 
                dfac_cod_sucu = $idSucursal and 
                dfac_cod_empr = $idEmpresa  ";


    $deta .= ' <table style="width: 100%; font-size: 13px; border-radius: 5px; border-collapse: collapse;" border="1">';
    $deta .= ' <tr>';
    $deta .= ' <b> <td style="width: 16%;" align="center">CODIGO</td> </b>';
    if($ctralter != 0){
        $deta .= ' <b> <td style="width: 12%;" align="center">CODIGO UNICO</td> </b>';
    }
    if($para_dfa_para==1){

    if($ctralter != 0){
        $deta .= ' <b> <td style="width: 38%;" align="center">DESCRIPCION</td> </b>';
    }
    else{
        $deta .= ' <b> <td style="width: 50%;" align="center">DESCRIPCION</td> </b>';
    }

    }
    else{
        if($ctralter != 0){
            $deta .= ' <b> <td style="width: 18%;" align="center">DESCRIPCION</td> </b>';
        }
        else{
            $deta .= ' <b> <td style="width: 30%;" align="center">DESCRIPCION</td> </b>';
        }
       
    }
    if($para_dfa_para==0){
    $deta .= ' <b> <td style="width: 20%;" align="center">DETALLE</td> </b>';
    }
    $deta .= ' <b> <td style="width:  8%;" align="center">CANT.</td> </b>';
    $deta .= ' <b> <td style="width:  8%;" align="center">PRECIO</td> </b>';
    $deta .= ' <b> <td style="width:  8%;" align="center">DSCTO</td> </b>';
    $deta .= ' <b> <td style="width: 10%;" align="center">TOTAL</td> </b>';
    $deta .= ' </tr>';
    $total_cant=0;
    
    if ($oIfx->Query($sqlDeta)) {
        if ($oIfx->NumFilas() > 0) {
            $porcIva = '';
            do {
                $dfac_cod_prod = $oIfx->f('dfac_cod_prod');
                $dfac_cod_lote = $oIfx->f('dfac_cod_lote');
                $dfac_nom_prod = $oIfx->f('dfac_nom_prod');
                $dfac_cant_dfac = $oIfx->f('dfac_cant_dfac');
                $total_cant+=$dfac_cant_dfac;
                $dfac_precio_dfac = $oIfx->f('dfac_precio_dfac');
                $dfac_des1_dfac = $oIfx->f('dfac_des1_dfac');
                $dfac_des2_dfac = $oIfx->f('dfac_des2_dfac');
                $dfac_por_dsg = $oIfx->f('dfac_por_dsg');
                $dfac_mont_total = $oIfx->f('dfac_mont_total');
                $dfac_num_comp = $oIfx->f('dfac_tip_dfac');
                $dfac_por_iva = $oIfx->f('dfac_por_iva');
                $dfac_det_dfac = $oIfx->f('dfac_det_dfac');
                $dfac_cant_conv = $oIfx->f('dfac_cant_conv');

                if ($dfac_por_iva > 0) {
                    $porcIva = $dfac_por_iva;
                }

                //CAMPO APLICACION - ACTUALMENTE SOLO ES UTILIZADO POR LA EMPRESA LUBAMAQUI
                $sql_prod="SELECT prod_apli_prod from saeprod where prod_cod_prod='$dfac_cod_prod' and (prod_apli_prod is not null and prod_apli_prod !='')";
                $apli_prod = trim(consulta_string_func($sql_prod, 'prod_apli_prod', $oIfxA, ''));
                if(!empty($apli_prod)){
                    $dfac_det_dfac = $dfac_det_dfac.'<br><div style="font-size:70%">'.$apli_prod.'</div>';
                }
                
            

                $sql="SELECT empr_menu_sucu from saeempr where empr_cod_empr=$idEmpresa";
                $detalle_sn = consulta_string_func($sql, 'empr_menu_sucu', $oIfxA, '');
                

                if($detalle_sn=='S'){
                    $sql_prod="SELECT prod_det_prod from saeprod where prod_cod_prod='$dfac_cod_prod'";
                    //echo $sql;exit;
                    $dfac_nom_prod = consulta_string_func($sql_prod, 'prod_det_prod', $oIfxA, '');
                    $dfac_det_dfac=$dfac_nom_prod;
                }

                //echo $dfac_nom_prod;exit;
                

                //echo $detalle_sn;exit;
               

                //echo $dfac_nom_prod;exit;

                $descuento = $dfac_des1_dfac + $dfac_des2_dfac + $dfac_por_dsg;
                if ($descuento > 0)
                    $descuento = ($dfac_precio_dfac * $dfac_cant_dfac) - ($dfac_mont_total);
                else
                    $descuento = 0;

                $totalDescuento = $totalDescuento + $descuento;


                if ($dfac_por_dsg > 0) {
                    $descuento1 = ($dfac_precio_dfac * $dfac_cant_dfac * $dfac_des1_dfac) / 100;
                    $descuento2 = 0;
                    $descuento3 = 0;

                    $dfac_mont_total = number_format((($dfac_precio_dfac * $dfac_cant_dfac) - ($descuento1 + $descuento2 + $descuento3)), 2, '.', '');

                }

                $dfac_det_dfac=str_replace(',',', ',$dfac_det_dfac);
                $dfac_nom_prod=str_replace(',',', ',$dfac_nom_prod);


                $deta .= ' <tr>';
                $deta .= ' <td style="width: 16%;">' . $dfac_cod_prod . '</td>';
                if($ctralter != 0){
                    $deta .= ' <td style="width: 12%;">' . $dfac_cod_lote . '</td>';
                }
                if($para_dfa_para==1){
                    if(empty($dfac_det_dfac)){
                        $dfac_det_dfac=$dfac_nom_prod;
                    }
                    if($ctralter != 0){
                        $deta .= ' <td style="width: 38%;">' . $dfac_det_dfac . '</td>';
                      }
                    else{
                            $deta .= ' <td style="width: 50%;">' . $dfac_det_dfac . '</td>';  
                        }

                  
                }
                

                if($para_dfa_para==0){
                    if($ctralter != 0){
                        $deta .= ' <td style="width: 18%;">' . $dfac_nom_prod . '</td>';

                    }
                    else{
                        $deta .= ' <td style="width: 30%;">' . $dfac_nom_prod . '</td>';  
                    }
              
                    $deta .= ' <td style="width: 20%;">' . $dfac_det_dfac . '</td>';  
              
                }
             $total=number_format($dfac_cant_dfac*$dfac_precio_dfac,4,'.',',');
                if(empty($dfac_des1_dfac)){
                    $dfac_des1_dfac=0;
                }
                $descuento=$total*$dfac_des1_dfac/100;

                /*$total_con_des=$total-$descuento;

                if($total>=$dfac_mont_total){
                    $total_dfac=$total_con_des;
                }else{
                    $total_dfac=$dfac_mont_total;
                }*/

                if($para_conv_sn=='S'){
                    if(round($dfac_cant_conv,2)>0){
                        $dfac_cant_dfac= $dfac_cant_conv;
                        $dfac_precio_dfac=$dfac_mont_total/$dfac_cant_dfac;
                    }  
                }

                
                $deta .= ' <td style="width: 8%;" align="right">' . number_format($dfac_cant_dfac, 4, '.', ',') . '</td>';
                $deta .= ' <td style="width: 8%;" align="right">' . number_format($dfac_precio_dfac, 4, '.', ',') . '</td>';
                $deta .= ' <td style="width: 8%;" align="right">' . number_format($descuento, 4, '.', ',') . '</td>';
                $deta .= ' <td style="width: 10%;" align="right">' . number_format($dfac_mont_total, 4, '.', ',') . '</td>';
                $deta .= ' </tr>';
            }while ($oIfx->SiguienteRegistro());
            if($ruc_empr == '0190020304001' || $ruc_empr == '0190314294001'){
                $deta .= ' <tr>';
                $deta .= ' <td  colspan="2" align="right">TOTAL CANT:</td>';
                $deta .= ' <td  align="right">' . number_format($total_cant, 4, '.', ',') . '</td>';
                $deta .= ' <td></td>';
                $deta .= ' <td></td>';
                $deta .= ' <td></td>';
                $deta .= ' </tr>';
            

            }
        }
    }

    $deta .= ' </table>';


    // VERIFICAMOS SI LA EMPRESA ES BABYS Y LE QUITAMOS EL COMENTARIO DE LA FACTURA
    if($ruc_empr != '1720115524001' || $$ruc_empr != '1793217385001' ){
        if(!empty($fact_cm1_fact)){
            $fact_cm1_fact='<b>Observaciones:</b> '.$fact_cm1_fact;
        }
    }else{
        $fact_cm1_fact = '';
    }
    
    $totales .='<table style="width: 100%;  font-size: 13px; margin-top: 3px;  align="center">';
    $totales .='<tr>
    <td  style="width: 50%; align="left"> '.$fact_cm1_fact.' </td>
    <td style="width: 50%; align="left">';

    $totales .= ' <table style="width: 195%; font-size: 13px; border-radius: 5px; border-collapse: collapse;"  border=1 align="right">';
    $totales .= ' <tr>';
    $totales .= ' <b> <td style="width: 25%;">SUBTOTAL:</td> </b>';
    $totales .= ' <td style="width: 10%;" align="right">' . number_format($fact_con_miva+$fact_sin_miva+$fact_dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>DESCUENTO:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td style="width: 25%;">SUBTOTAL SIN IMPUESTOS:</td> </b>';
    $totales .= ' <td style="width: 10%;" align="right">' . number_format($fact_con_miva+$fact_sin_miva-$fact_ice, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>IVA ' . round($porcIva) . '%:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_iva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>ICE:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_ice, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>IRBP:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_val_irbp, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>INTERES:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_fina_fact, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>TOTAL:</td> </b>';
    $fact_tot_fact = $fact_con_miva + $fact_iva+$fact_sin_miva + $fact_val_irbp + $fact_fina_fact;
    $totales .= ' <td align="right">' . number_format($fact_tot_fact, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' </table>';


    $totales.='</td>
    </tr>';
    $totales .='</table>';



    $sqltmp ='';
    if (!empty($fact_cod_contr)) {
        $sqltmp ="id_contrato = $fact_cod_contr AND";
    }

    $total = number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_fle_fact + $fact_otr_fact + $fact_fin_fact - $totalDescuento, 2, '.', '');
    $V = new EnLetras();
    $con_letra = strtoupper($V->ValorEnLetras($total, 'dolar'));

    //query forma de pago
    $sqlFPago = "select fp.fpag_cod_fpagop, fx.fxfp_val_fxfp, fx.fxfp_num_dias,
				fpg.fpagop_des_fpagop
				from saefact f, saefxfp fx, saefpag fp, saefpagop fpg
				where 
                f.fact_cod_fact = fx.fxfp_cod_fact and
				fp.fpag_cod_fpag = fx.fxfp_cod_fpag and
                f.fact_cod_empr = fpg.fpagop_cod_empr and
				fp.fpag_cod_fpagop = fpg.fpagop_cod_fpagop and
				f.fact_cod_empr = $idEmpresa and
				f.fact_cod_sucu = $idSucursal and
				f.fact_cod_fact = $id order by fx.fxfp_cod_fxfp";
    if ($oIfx->Query($sqlFPago)) {
        if ($oIfx->NumFilas() > 0) {
            $tablePago .= '<table style="width: 60%; border-collapse: collapse; margin-top: 10px;" border="1">';
            $tablePago .= '<tr>';
            $tablePago .= '<th style="width: 70%;">FORMA PAGO</th>';
            $tablePago .= '<th style="width: 30%;">VALOR</th>';
            $tablePago .= '<th style="width: 30%;">PLAZO</th>';
            $tablePago .= '<th style="width: 30%;">UNIDAD</th>';
            $tablePago .= '</tr>';
            do {
                $fpag_cod_fpagop    = $oIfx->f('fpag_cod_fpagop');
                $fxfp_val_fxfp      = $oIfx->f('fxfp_val_fxfp');
                $fxfp_num_dias      = $oIfx->f('fxfp_num_dias');
                $fpagop_des_fpagop  = $oIfx->f('fpagop_des_fpagop');

                $tablePago .= '<tr>';
                $tablePago .= '<td style="width: 70%;">' . $fpag_cod_fpagop . ' ' . htmlentities($fpagop_des_fpagop) . '</td>';
                $tablePago .= '<td style="width: 30%;" align="right">' . number_format($fxfp_val_fxfp, 2, '.', '') . '</td>';
                $tablePago .= '<td style="width: 30%;" align="right">' . round($fxfp_num_dias) . '</td>';
                $tablePago .= '<td style="width: 30%;" align="right">dias</td>';
                
                $tablePago .= '</tr>';
            } while ($oIfx->SiguienteRegistro());
            $tablePago .= '</table>';
        }
    }
    $oIfx->Free();

    if(!empty($empr_cm1_empr)){
        $msjCliente = $empr_cm1_empr;

        $msjCliente=str_replace('&&&correo&&&',$empr_mai_empr,$msjCliente);

        // LEEYNDA
        $tableLeyenda .= '<br /> <br /> <br />';
        $tableLeyenda .= '<table style="width: 98%; border-collapse: collapse; margin-top: 10px;" border="0">';
        $tableLeyenda .= '<tr>';
        $tableLeyenda .= '<td style="width: 98%;" align="center">'.$msjCliente.'</td>';
        $tableLeyenda .= '</tr>';
        $tableLeyenda .= '</table>';


    }

    if($obfact=='S'){

        $tableLeyenda .= '<table style="width: 98%; border-collapse: collapse; margin-top: 0px;" border="0">';
        $tableLeyenda .= '<tr>';
        $tableLeyenda .= '<td style="width: 98%;" align="left">'.$obdetfact.'</td>';
        $tableLeyenda .= '</tr>';
        $tableLeyenda .= '</table>';

    }

    
    if( $empr_cta_sn =='S'){
        $tableLeyenda .=$empr_det_cta;
    }

    if( $empr_rinf_sn =='S'){
        $tableLeyenda .=$empr_det_rinf;
    }


    $legend = '<page_footer>
            <div style="text-align:center;color: #6B6565; background-color: transparent;">Este comprobante electronico ha sido generado a traves de Sisconti S.A. - Facturacion Electronica<br>www.sisconti.com.ec</div>
    </page_footer>';

    $documento .= '<page backimgw="70%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
    $documento .= $logo . $cliente . $deta . $totales . $tablePago. $tableLeyenda;
    $documento .= $legend;
    $documento .= '</page>';

   

    //file_put_contents("C:/prueba/documento.html", $documento);

    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;

    return $documento;
}


function reporte_factura_alterno($id = '', $nombre_archivo = '', $idSucursal ='', &$rutaPdf = '') {
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    //$idSucursal = $_SESSION['U_SUCURSAL'];


    $sql = "select empr_sn_conta, empr_cod_pais,empr_cm1_empr, empr_rimp_sn, empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr,empr_tel_resp, empr_ac1_empr, empr_ac2_empr, empr_mai_empr, empr_tip_empr
                                            from saeempr where empr_cod_empr = $idEmpresa ";


    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            $tel_empresa = $oIfx->f('empr_tel_resp');
            $empr_mai_empr = $oIfx->f('empr_mai_empr');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';
            $empr_rimp_sn = $oIfx->f('empr_rimp_sn');
            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
            $empr_ac1_empr = $oIfx->f('empr_ac1_empr');
            $empr_ac2_empr = $oIfx->f('empr_ac2_empr');
            $empr_cm1_empr = $oIfx->f('empr_cm1_empr');
            $empr_cod_pais = $oIfx->f('empr_cod_pais');
            $empr_tip_empr = $oIfx->f('empr_tip_empr');
            $empr_sn_conta = $oIfx->f('empr_sn_conta');

        }
    }
    $oIfx->Free();

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis, sucu_telf_secu  from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
            $sucu_telf_secu = $oIfx->f('sucu_telf_secu');
        }
    }
    $oIfx->Free();

    //VALIDACION SUSCURSALES

    $sqls="select count(*) as cont from saesucu";
    $contsucu=consulta_string($sqls,'cont',$oIfx,0);

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }

    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;



    // $path_logo_img = DIR_FACTELEC . 'imagenes/logos/' . $path_img[$count];
    $path_logo_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];


    $logo .= '<table style="width: 100%; margin: 0px;">';
    $logo .= '<tr>';
    $logo .= '<td align="center" style="width: 55%; border:1px solid black; border-radius: 5px; margin: 0px;">';
    $logo .= '<table width: 55%; valign="center" style="margin: 0px;">';
    $logo .= '<tr><td style="margin-top: 0px;"><img width="300px;" height="150px;" src="' . $path_logo_img . '"></td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="left" style="font-size: 15px;" width="300"><b>Emisor:</b> ' . $razonSocial . '</td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>RUC:</b> ' . $ruc_empr . '</td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="left" style="font-size: 13px;" width="500"><b>Matriz:</b> ' . $dirMatriz . '</td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';


    //selecciona sucursales y direcciones
    $sql_sucu_matriz = "select sucu_dir_sucu from saesucu where sucu_nom_sucu ='MATRIZ'";
    $matriz = consulta_string($sql_sucu_matriz, 'sucu_dir_sucu', $oIfx, '');
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    $emprce="select empr_num_resu from saeempr where empr_cod_empr=$idEmpresa";
    $contribuyente= consulta_string($emprce, 'empr_num_resu', $oIfx, '');
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                //$logo .= '<tr><td align="center" style="font-size: 12px">' . $sucu_nom_sucu . ': ' . htmlentities($sucu_dir_sucu) . '</td></tr>';
                //$logo .= '<tr><td align="center" style="font-size: 13px">SUCURSAL : ' . $sucu_nom_sucu . '</td></tr>';

                ///$logo .= '<tr><td style="position:top; width:50px;"><h4>Direccion Matriz:</h4></td></tr><br>';
                //$logo .= '<tr><td>' . htmlentities($dirMatriz) . '</td></tr>';
                if( $contsucu>1){
                    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>Sucursal:</b> ' . $sucu_nom_sucu . '</td></tr>';

                    $logo .= '<tr><td align="left" style="font-size: 13px;" width="500" ><b>Direcci&oacute;n Sucursal:</b>' . $sucu_dir_sucu.'</td></tr>';
                }





            } while ($oIfx->SiguienteRegistro());
        }
    }
    //$logo .= '<tr><td>&nbsp;</td></tr>';

    //DATOS ADICIONALES
    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>Correo:</b> ' .  $empr_mai_empr . '</td></tr>';

    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>Tel&eacute;fono:</b> ' . $sucu_telf_secu . '</td></tr>';


    if ($empr_tip_empr == 'S') {
        $logo .= '<tr><td align="left" style="font-size: 12px;"><b>Contribuyente Especial #:</b> ' . $empr_num_resu . '</td></tr>';
    }//fin if*/
    /*if($empr_conta_sn=='SI'){
        $logo .= '<tr><td align="center" style="font-size: 12px;"><b>Contribuyente Especial #:</b> '.$contribuyente.'</td></tr>';
    }*/

    if(!empty($empr_ac2_empr)){
        $empr_ac2_empr = '<b>Agente de Retención Resolución Nro:</b> '.$empr_ac2_empr;
    }
    /*else{
        $empr_ac2_empr ='<b>AGENTE DE RETENCI&Oacute;N:</b> NO';
    }*/


    if($empr_conta_sn=='SI'){
        if($empr_sn_conta=='S'){
            $empr_sn_conta ='SI';
        }
        else{
            $empr_sn_conta ='NO';
        }
        $logo .= '<tr><td align="left" style="font-size: 12px;"><b>Obligado a llevar Contabilidad :</b> ' . $empr_sn_conta . '</td></tr>';
    }
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    if($empr_rimp_sn=="S"){
        $logo .= '<tr><td align="left" style="font-size: 12px;"><b>CONTRIBUYENTE R&Eacute;GIMEN RIMPE</b></td></tr>';
    }
    $logo .= '<tr><td align="left" style="font-size: 12px;">'.$empr_ac2_empr.'</td></tr>';

    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= ' </table>';
    $logo .= '</td>';

    $sqlFac = "select * from saefact where fact_cod_fact = $id;";

    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $fact_nse_fact = $oIfx->f('fact_nse_fact');
                $fact_num_preimp = $oIfx->f('fact_num_preimp');
                $fact_auto_sri = $oIfx->f('fact_auto_sri');
                $fact_fech_sri = $oIfx->f('fact_fech_sri');
                $fact_nom_cliente = $oIfx->f('fact_nom_cliente');
                $fact_fech_fact = fecha_mysql_func($oIfx->f('fact_fech_fact'));
                $fact_ruc_clie = $oIfx->f('fact_ruc_clie');
                $fact_tlf_cliente = $oIfx->f('fact_tlf_cliente');
                $fact_dir_clie = htmlentities($oIfx->f('fact_dir_clie'));
                $fact_email_clpv = str_replace(' ', '', $oIfx->f("fact_email_clpv"));
                $fact_con_miva = $oIfx->f('fact_con_miva');
                $fact_sin_miva = $oIfx->f('fact_sin_miva');
                $fact_tot_fact = $oIfx->f('fact_tot_fact');
                $fact_iva = $oIfx->f('fact_iva');
                $fact_ice = $oIfx->f('fact_ice');
                $fact_clav_sri  = $oIfx->f('fact_clav_sri');
                $fact_dsg_valo  = $oIfx->f('fact_dsg_valo');
                $fact_cm1_fact  = trim($oIfx->f("fact_cm1_fact"));
                $fact_cm2_fact  = $oIfx->f("fact_cm2_fact");
                $fact_cm4_fact  = $oIfx->f("fact_cm4_fact");
                $orden_compra   = $oIfx->f("fact_opc_fact");
                $fact_cod_clpv  = $oIfx->f("fact_cod_clpv");
                $fact_cod_ccli  = $oIfx->f("fact_cod_ccli");
                $fact_dia_plazo = $oIfx->f("fact_dia_fact");
                $fact_fech_venc = fecha_mysql_func($oIfx->f("fact_fech_venc"));
                $fact_cm3_fact  = $oIfx->f("fact_cm3_fact");
                $fact_cod_contr = $oIfx->f("fact_cod_contr");

                $id_usuario_w = $oIfx->f("fact_user_web");
                if(empty($id_usuario_w)){
                    $id_usuario_w ='NULL';
                }
                $sql = "select usuario_user, usuario_nombre, usuario_apellido  from comercial.usuario where usuario_id = $id_usuario_w";
                if($oCon->Query($sql)){
                    if($oCon->NumFilas() > 0){
                        $usuario=$codigo = $oCon->f('usuario_nombre').' '.$oCon->f('usuario_apellido');
                    }
                }



                $fact_tip_vent = $oIfx->f("fact_tip_vent");
                $sql = "select tcmp_cod_tcmp, tcmp_des_tcmp from saetcmp where tcmp_cod_tcmp = '$fact_tip_vent';";
                $tipo_text_fac= consulta_string($sql,'tcmp_des_tcmp', $oCon,'FACTURA');


                $logo .= '<b><td style="width: 45%; border: 1px solid black; border-radius: 5px;" align="center">';
                $logo .= ' <table align="center" style="font-size: 15px;">';
                $logo .= ' <tr>';
                $logo .= '<td style="border-bottom: 1px inset black;">'.$tipo_text_fac.'</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>SERIE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . substr($fact_nse_fact, 0, 3) . '-' . substr($fact_nse_fact, 3, 6) . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="font-size: 17px; color: red; border-bottom: 1;">' . $fact_num_preimp . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fact_auto_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1">FECHA AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fact_fech_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1" >AMBIENTE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $ambiente_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td style="border-top:1" >EMISION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $emision_sri . '</td>';
                $logo .= ' </tr>';

                //verifica si existe clave de acceso
                if ($fact_clav_sri != '') {
                    $nombArch = $fact_nse_fact . $fact_num_preimp;
                    //$nombArch = '0112201401179141325300110010010000048101234567818';
                    $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';

                    new barCodeGenrator($fact_clav_sri, 1, $rutaCodi, 450, 100, true);

                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="center" style="font-size: 12px;">CLAVE DE ACCESO</td>';
                    $logo .= '</tr>';
                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="center"> <img width="400px;" src="' . $rutaCodi . '"/></td>';
                    $logo .= '</tr>';
                }

                $logo .= ' </table>';
                $logo .= '</td></b>';
                $logo .= '</tr>';
                $logo .= '</table>';
                $logo .= ' <br>';

                $cliente .= ' <table style="width: 100%; border:1px solid black; border-radius: 5px; padding: 2px; font-size: 15x;">';
                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10%;">CLIENTE:</td></b>';
                $cliente .= ' <td style="width: 48%; ">' . $fact_nom_cliente . '</td>';
                $cliente .= ' <b><td style="width: 13%; ">FECHA EMISION:</td></b>';
                $cliente .= ' <td style="width: 29% ">' . $fact_fech_fact . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% ">RUC:</td></b>';
                $cliente .= ' <td style="width: 48% ">' . $fact_ruc_clie . '</td>';
                $cliente .= ' <b><td style="width: 13% ">TELEFONO:</td></b>';
                $cliente .= ' <td style="width: 29% ">' . $fact_tlf_cliente . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% ">DIRECCION:</td></b>';
                $cliente .= ' <td style="width: 48% ">' . $fact_dir_clie . '</td>';
                $cliente .= ' <b><td style="width: 13% ">EMAIL:</td></b>';
                $cliente .= ' <td style="width: 29% ">' . $fact_email_clpv . '</td>';
                $cliente .= ' </tr>';
                $cliente .= ' </table>';

                $cliente .= ' <br>';
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $oIfx->Free();

    $sqlDeta = "select * from saedfac where dfac_cod_fact = $id and 
                dfac_cod_sucu = $idSucursal and 
                dfac_cod_empr = $idEmpresa  ";

    $deta .= ' <table style="width: 100%; font-size: 13px; border-radius: 5px; border-collapse: collapse;" border="1">';
    $deta .= ' <tr>';
    $deta .= ' <b> <td style="width: 16%;" align="center">CODIGO</td> </b>';
    $deta .= ' <b> <td style="width: 30%;" align="center">DESCRIPCION</td> </b>';
    $deta .= ' <b> <td style="width: 20%;" align="center">DETALLE</td> </b>';
    $deta .= ' <b> <td style="width:  8%;" align="center">CANT.</td> </b>';
    $deta .= ' <b> <td style="width:  8%;" align="center">PRECIO</td> </b>';
    $deta .= ' <b> <td style="width:  8%;" align="center">DSCTO %</td> </b>';
    $deta .= ' <b> <td style="width: 10%;" align="center">TOTAL</td> </b>';
    $deta .= ' </tr>';

    if ($oIfx->Query($sqlDeta)) {
        if ($oIfx->NumFilas() > 0) {
            $porcIva = '';
            do {
                $dfac_cod_prod = $oIfx->f('dfac_cod_prod');
                $dfac_nom_prod = $oIfx->f('dfac_nom_prod');
                $dfac_cant_dfac = $oIfx->f('dfac_cant_dfac');
                $dfac_precio_dfac = $oIfx->f('dfac_precio_dfac');
                $dfac_des1_dfac = $oIfx->f('dfac_des1_dfac');
                $dfac_des2_dfac = $oIfx->f('dfac_des2_dfac');
                $dfac_por_dsg = $oIfx->f('dfac_por_dsg');
                $dfac_mont_total = $oIfx->f('dfac_mont_total');
                $dfac_num_comp = $oIfx->f('dfac_tip_dfac');
                $dfac_por_iva = $oIfx->f('dfac_por_iva');
                $dfac_det_dfac = $oIfx->f('dfac_det_dfac');

                if ($dfac_por_iva > 0) {
                    $porcIva = $dfac_por_iva;
                }

                $descuento = $dfac_des1_dfac + $dfac_des2_dfac + $dfac_por_dsg;
                if ($descuento > 0)
                    $descuento = ($dfac_precio_dfac * $dfac_cant_dfac) - ($dfac_mont_total);
                else
                    $descuento = 0;

                /** Consulta codigo alterno **/
                $sql_alt = "select prod_alt_clie from saeprod 
                        where prod_cod_prod = '$dfac_cod_prod' and prod_alt_clie is not null limit 1;";
                $codigo_alterno = consulta_string($sql_alt, 'prod_alt_clie', $oIfx2, '');

                if(!$codigo_alterno){
                    $codigo_alterno = $dfac_cod_prod;
                }

                $totalDescuento = $totalDescuento + $descuento;

                if ($dfac_por_dsg > 0) {
                    $descuento1 = ($dfac_precio_dfac * $dfac_cant_dfac * $dfac_des1_dfac) / 100;
                    $descuento2 = 0;
                    $descuento3 = 0;

                    $dfac_mont_total = number_format((($dfac_precio_dfac * $dfac_cant_dfac) - ($descuento1 + $descuento2 + $descuento3)), 2, '.', '');

                }


                $deta .= ' <tr>';
                $deta .= ' <td style="width: 16%;">' . $codigo_alterno . '</td>';
                $deta .= ' <td style="width: 30%;">' . $dfac_nom_prod . '</td>';
                $deta .= ' <td style="width: 20%;">' . $dfac_det_dfac . '</td>';
                $deta .= ' <td style="width: 8%;" align="right">' . number_format($dfac_cant_dfac, 4, '.', ',') . '</td>';
                $deta .= ' <td style="width: 8%;" align="right">' . number_format($dfac_precio_dfac, 4, '.', ',') . '</td>';
                $deta .= ' <td style="width: 8%;" align="right">' . round($dfac_des1_dfac, 0) . '</td>';
                $deta .= ' <td style="width: 10%;" align="right">' . number_format($dfac_mont_total, 4, '.', ',') . '</td>';
                $deta .= ' </tr>';
            }while ($oIfx->SiguienteRegistro());
        }
    }

    $deta .= ' </table>';

    if(!empty($fact_cm1_fact)){
        $fact_cm1_fact='<b>Observaciones:</b> '.$fact_cm1_fact;
    }

    $totales .='<table style="width: 100%;  font-size: 13px; margin-top: 3px;  align="center">';
    $totales .='<tr>
    <td  style="width: 50%; align="left"> '.$fact_cm1_fact.' </td>
    <td style="width: 50%; align="left">';

    $totales .= ' <table style="width: 195%; font-size: 13px; border-radius: 5px; border-collapse: collapse;"  border=1 align="right">';



    $totales .= ' <tr>';
    $totales .= ' <b> <td style="width: 25%;">SUBTOTAL:</td> </b>';
    $totales .= ' <td style="width: 10%;" align="right">' . number_format($fact_con_miva+$fact_sin_miva+$fact_dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>DESCUENTO:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td style="width: 25%;">SUBTOTAL SIN IMPUESTOS:</td> </b>';
    $totales .= ' <td style="width: 10%;" align="right">' . number_format($fact_con_miva+$fact_sin_miva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>IVA ' . round($porcIva) . '%:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_iva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>ICE:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_ice, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>IRBP:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_val_irbp, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>TOTAL:</td> </b>';
    $fact_tot_fact = $fact_con_miva + $fact_iva+$fact_sin_miva + $fact_val_irbp;
    $totales .= ' <td align="right">' . number_format($fact_tot_fact, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' </table>';


    $totales.='</td>
    </tr>';
    $totales .='</table>';



    $sqltmp ='';
    if (!empty($fact_cod_contr)) {
        $sqltmp ="id_contrato = $fact_cod_contr AND";
    }

    $total = number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_fle_fact + $fact_otr_fact + $fact_fin_fact - $totalDescuento, 2, '.', '');
    $V = new EnLetras();
    $con_letra = strtoupper($V->ValorEnLetras($total, 'dolar'));

    //query forma de pago
    $sqlFPago = "select fp.fpag_cod_fpagop, fx.fxfp_val_fxfp, fx.fxfp_num_dias,
				fpg.fpagop_des_fpagop
				from saefact f, saefxfp fx, saefpag fp, saefpagop fpg
				where 
                f.fact_cod_fact = fx.fxfp_cod_fact and
				fp.fpag_cod_fpag = fx.fxfp_cod_fpag and
                f.fact_cod_empr = fpg.fpagop_cod_empr and
				fp.fpag_cod_fpagop = fpg.fpagop_cod_fpagop and
				f.fact_cod_empr = $idEmpresa and
				f.fact_cod_sucu = $idSucursal and
				f.fact_cod_fact = $id";
    if ($oIfx->Query($sqlFPago)) {
        if ($oIfx->NumFilas() > 0) {
            $tablePago .= '<table style="width: 60%; border-collapse: collapse; margin-top: 10px;" border="1">';
            $tablePago .= '<tr>';
            $tablePago .= '<th style="width: 70%;">FORMA PAGO</th>';
            $tablePago .= '<th style="width: 30%;">VALOR</th>';
            $tablePago .= '</tr>';
            do {
                $fpag_cod_fpagop    = $oIfx->f('fpag_cod_fpagop');
                $fxfp_val_fxfp      = $oIfx->f('fxfp_val_fxfp');
                $fxfp_num_dias      = $oIfx->f('fxfp_num_dias');
                $fpagop_des_fpagop  = $oIfx->f('fpagop_des_fpagop');

                $tablePago .= '<tr>';
                $tablePago .= '<td style="width: 70%;">' . $fpag_cod_fpagop . ' ' . htmlentities($fpagop_des_fpagop) . '</td>';
                $tablePago .= '<td style="width: 30%;" align="right">' . number_format($fxfp_val_fxfp, 2, '.', '') . '</td>';
                $tablePago .= '</tr>';
            } while ($oIfx->SiguienteRegistro());
            $tablePago .= '</table>';
        }
    }
    $oIfx->Free();

    if(!empty($empr_cm1_empr)){
        $msjCliente = $empr_cm1_empr;

        $msjCliente=str_replace('&&&correo&&&',$empr_mai_empr,$msjCliente);

        // LEEYNDA
        $tableLeyenda .= '<br /> <br /> <br />';
        $tableLeyenda .= '<table style="width: 98%; border-collapse: collapse; margin-top: 10px;" border="0">';
        $tableLeyenda .= '<tr>';
        $tableLeyenda .= '<td style="width: 98%;" align="center">'.$msjCliente.'</td>';
        $tableLeyenda .= '</tr>';
        $tableLeyenda .= '</table>';


    }


    $legend = '<page_footer>
        <table align="center" style="width: 80%">
            <tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">Este comprobante electronico ha sido generado a traves de Sisconti S.A. - Facturacion Electronica</td>
            </tr>
			<tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">www.sisconti.com</td>
            </tr>
        </table>
    </page_footer>';

    $documento .= '<page backimgw="70%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
    $documento .= $logo . $cliente . $deta . $totales . $tablePago. $tableLeyenda;
    $documento .= $legend;
    $documento .= '</page>';


    //file_put_contents("C:/prueba/documento.html", $documento);

    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;

    return $documento;
}

/**
 * FORMATOS CRE
 */
function reporte_factura_alterno_cre($id = '', $nombre_archivo = '', $idSucursal = '', $bandera_c = 0)
{
    //Definiciones
    global $DSN_Ifx;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();


    $oIfxB = new Dbo;
    $oIfxB->DSN = $DSN_Ifx;
    $oIfxB->Conectar();


    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();

    $oIfxD = new Dbo;
    $oIfxD->DSN = $DSN_Ifx;
    $oIfxD->Conectar();

    $oReturn = new xajaxResponse();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    // $idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_sn_conta, empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr
                                            from saeempr where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S') {
                $empr_conta_sn = 'SI';
            }else {
                $empr_conta_sn = 'NO';
            }

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
            $empr_sn_conta = $oIfx->f('empr_sn_conta');
            
        }
    }
    $oIfx->Free();

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis  from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
        }
    }
    $oIfx->Free();

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }


    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;
    $arc_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];
    //echo $arc_img;exit;
    if (file_exists($arc_img)) {
        $imagen = $arc_img;
    } else {
        $imagen = '';
    }

    $logo = '';
    $x = '0px';
    if ($imagen != '') {

        $empr_logo = '<div align="left">
                        <img src="' . $imagen . '" style="
                        width:70px;">
                        </div>';
        $x = '0px';
    }
    else{
        $empr_logo ='<span><font color="red">SIN LOGO </font></span>';
    }


    //FORMATO DE FACTURA

    //selecciona sucursales y direcciones
    $sucursal_dir = '';
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                $sucursal_dir .= $sucu_nom_sucu;
                $sucursal_dir .= '<br>' . ($sucu_dir_sucu);
            } while ($oIfx->SiguienteRegistro());
        }
    }


    $table_fact = '<table  align="left" border="0"   style="width: 100%;  margin-top: 0px; " >';
    if ($empr_path_logo != '') {
        $table_fact .= '<tr>
                                <td align="left">' . $empr_logo . '</td>
                                <td align="right" style="color: black;" ><font size="7">
                                          '.$sucursal_dir.' <br>
                                          Contribuyente Especial #:' . $empr_num_resu . ' <br>';

                                          if($empr_conta_sn=='SI'){
                                            if($empr_sn_conta=='S'){
                                                $empr_sn_conta ='SI';
                                            }
                                            else{
                                                $empr_sn_conta ='NO';
                                            }
    
                                              $table_fact.='Obligado a llevar Contabilidad : ' . $empr_sn_conta . '';
                                          }

                                       
                                      
                            $table_fact.='</font></td>
                                </tr>';

                                $sqlxml = "select ixml_tit_ixml, ixml_det_ixml from saeixml where ixml_cod_empr=$idEmpresa 
                                and ixml_est_deleted ='S' and ixml_sn_pdf='S' order by ixml_ord_ixml";
                
                                if ($oIfx->Query($sqlxml)) {
                                    if ($oIfx->NumFilas() > 0) {
                                        do {
                                            $titulo  = $oIfx->f('ixml_tit_ixml');
                                            $detalle = $oIfx->f('ixml_det_ixml');
                                            $table_fact .= '<tr>
                                            <td align="left">&nbsp;</td>
                                            <td align="right" style="font-size: 7;" width="250"><b>'.$titulo.'</b> ' . $detalle . '</td></tr>';
                                        } while ($oIfx->SiguienteRegistro());
                                    }
                                }
                    $oIfx->Free();
                    
                                    
                    $table_fact .= '<tr><td colspan="2"  ><hr></td></tr>';
    }
    $table_fact .= '</table>';


    //consulta consumidor final
    $sql_consu = "select clpv_cod_clpv, clpv_nom_clpv, clpv_ruc_clpv, clpv_cod_vend, clpv_pre_ven 
                from saeclpv where clv_con_clpv = '07' and clpv_clopv_clpv = 'CL' and 
			    clpv_nom_clpv like ('CONSUMID%') and clpv_cod_empr = $idEmpresa";
    $cosumidor_clpv = consulta_string($sql_consu, 'clpv_cod_clpv', $oIfxA, 0);

    $sqlFac = "select * from saefact where fact_cod_fact = $id and fact_cod_sucu = $idSucursal and fact_cod_empr = $idEmpresa ";

    $consumido_final = 0;
    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $fact_cod_fact = $oIfx->f('fact_cod_fact');
                $fact_nse_fact = $oIfx->f('fact_nse_fact');
                $fact_num_preimp = $oIfx->f('fact_num_preimp');
                $fact_nom_cliente = $oIfx->f('fact_nom_cliente');
                $fact_fech_fact = ($oIfx->f('fact_fech_fact'));
                $fact_ruc_clie = $oIfx->f('fact_ruc_clie');
                $fact_tlf_cliente = $oIfx->f('fact_tlf_cliente');
                $fact_dir_clie = ($oIfx->f('fact_dir_clie'));
                $fact_email_clpv = str_replace(' ', '', $oIfx->f("fact_email_clpv"));
                $fact_con_miva = $oIfx->f('fact_con_miva');
                $fact_sin_miva = $oIfx->f('fact_sin_miva');
                $fact_tot_fact = $oIfx->f('fact_tot_fact');
                $fact_iva = $oIfx->f('fact_iva');
                $fact_ice = $oIfx->f('fact_ice');
                $fact_clav_sri = $oIfx->f('fact_clav_sri');
                $fact_dsg_valo = $oIfx->f('fact_dsg_valo');
                $fact_cm1_fact = $oIfx->f("fact_cm1_fact");
                $fact_cm2_fact = $oIfx->f("fact_cm2_fact");
                $fact_cm4_fact = $oIfx->f("fact_cm4_fact");
                $orden_compra = $oIfx->f("fact_opc_fact");
                $fact_cod_clpv = $oIfx->f("fact_cod_clpv");
                $fact_cod_ccli = $oIfx->f("fact_cod_ccli");
                $fact_dia_plazo = $oIfx->f("fact_dia_fact");
                $fact_val_irbp = $oIfx->f("fact_val_irbp");
                $fact_tipo_convenio = $oIfx->f("fact_tipo_convenio");
                $fact_cod_guia = $oIfx->f("fact_cod_guia");

                $fact_fle_fact = $oIfx->f('fact_fle_fact');
                $fact_otr_fact = $oIfx->f('fact_otr_fact');
                $bandera_paciente = 0;
                $guia_ruc_clie = '';
                $guia_nom_cliente = '';
                if($fact_cod_guia){
                    $sqlPaciente = "select guia_cod_clpv, guia_ruc_clie, guia_nom_cliente from saeguia where guia_cod_guia in ($fact_cod_guia) and guia_alb_tipo = '1' limit 1;";
                    if ($oIfxB->Query($sqlPaciente)) {
                        if ($oIfxB->NumFilas() > 0) {
                            $bandera_paciente = 1;
                            $guia_cod_clpv = $oIfxB->f('guia_cod_clpv');
                            $guia_ruc_clie = $oIfxB->f('guia_ruc_clie');
                            $guia_nom_cliente = $oIfxB->f('guia_nom_cliente');
                        }
                    }
                    $oIfxB->Free();
                }

                $fact_tip_vent = $oIfx->f("fact_tip_vent");
                $sql = "select tcmp_cod_tcmp, tcmp_des_tcmp from saetcmp where tcmp_cod_tcmp = '$fact_tip_vent';";
                $tipo_text_fac= consulta_string($sql,'tcmp_des_tcmp', $oIfxB,'FACTURA');


                $table_fact .= '<table style="width: 100%;" border="0" style="border-collapse: collapse;">';

                $table_fact .= ' <tr>
                                 <td class="fecha_letra" align="left" >R.U.C: '.$ruc_empr.'</td>
                                 <td class="fecha_letra" align="left" >'.$tipo_text_fac.' No: '.substr($fact_nse_fact, 0, 3) . '-' . substr($fact_nse_fact, 3, 6) .'-'.$fact_num_preimp.'</td>
                                 </tr>';

                $table_fact .= ' <tr>
                                 <td class="fecha_letra" align="left" >NÚMERO DE AUTORIZACIÓN:</td>
                                 <td class="fecha_letra" align="left" ></td>
                                 </tr>';
                $table_fact .='</table>';


                $table_fact .= '<table align="left" style="width: 100%; border:1px solid black; border-radius: 5px; margin-top: 20px;">';
                $table_fact .= '<tr>
                                              <td  bgcolor="black" style="width:100%"><font color="white">'.$fact_clav_sri.'</font></td>
                                         </tr>';
                $table_fact .='</table>';


                $table_fact .= '<table style="width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">';

                $table_fact .= ' <tr>
                                 <td class="fecha_letra" align="left" >AMBIENTE: '.$ambiente_sri.'</td>
                                 <td class="fecha_letra" align="left" >EMISIÓN: '.$emision_sri.'</td>
                                 </tr>';

                $table_fact .= ' <tr>
                                 <td class="fecha_letra" align="left" >CLAVE DE ACCESO:</td>
                                 <td class="fecha_letra" align="left" ></td>
                                 </tr>';
                $table_fact .='</table>';

                if ($fact_clav_sri != '') {
                    $nombArch = $fact_nse_fact . $fact_num_preimp;
                    $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';

                    new barCodeGenrator($fact_clav_sri, 1, $rutaCodi, 450, 70, true);


                    $table_fact .= '<table style="width: 100%; height: 80%; margin-top: 0px;" border="0" style="border-collapse: collapse;">';
                    $table_fact .= '<tr>
                                              <td  style="width:100%; height: 80%;"> <img src="' . $rutaCodi . '"/></td>
                                         </tr>';
                    $table_fact .='</table>';

                }


                /**
                 * INFORMACION CABECERA
                 */
                $table_fact .= '<br><br><table bgcolor="#C9C2C1" align="left" style="width: 100%; border:3px solid black; ">';
                $table_fact .='<tr>
                                           <td style="font-size:90%;" style="width:15%"><strong>Cliente:</strong></td>
                                           <td style="font-size:90%;" style="width:50%">'. ($fact_nom_cliente).'</td>
                                           <td style="font-size:90%;" style="width:12%"><strong>RUC/CI:</strong></td>
                                           <td style="font-size:90%;" style="width:23%">'.$fact_ruc_clie.'</td>
                                        </tr>';

                $table_fact .='<tr>
                                           <td><strong>Fecha Emisión:</strong></td>
                                           <td>'.$fact_fech_fact.'</td>
                                           <td></td>
                                           <td></td>
                                        </tr>';

                $table_fact .='</table>';

                /**
                 * INFORMACION ADICIONAL
                 */
                $convenio_html = '';
                if($fact_tipo_convenio){
                    $sqlOpc = "select nombre from comercial.cre_tipo_convenio where id = $fact_tipo_convenio;";
                    $convenio_ = consulta_string($sqlOpc, 'nombre', $oIfxA, '');
                    $convenio_html = '<br>Acuerdo: '.$convenio_;
                }

                $paciente_html = '';
                if($bandera_paciente){
                    $paciente_html .= '<br>Paciente: '.$guia_nom_cliente;
                    $paciente_html .= '<br>Ruc/Ci: '.$guia_ruc_clie;
                }

                $sql = "select 
                        fxf.fxfp_val_fxfp as tot,
                        fpa.fpag_des_fpag as pag
                        from saefxfp fxf
                        inner join saefpag fpa on fxf.fxfp_cod_fpag = fpa.fpag_cod_fpag
                        where fxfp_cod_fact = $fact_cod_fact and fxfp_cod_empr = $idEmpresa;";
                $forma_html = '';
                if ($oIfxB->Query($sql)) {
                    if ($oIfxB->NumFilas() > 0) {
                        $tot = number_format($oIfxB->f('tot'),2,'.','');
                        $pag = $oIfxB->f('pag');
                        $forma_html .= "<br>FORMA DE PAGO: $pag <br>MONTO: $tot";
                    }
                }
                $oIfxB->Free();

                $fact_dir_clie = ($fact_dir_clie);
                $adicional_info = "<strong>Información Adicional: </strong>
                 $convenio_html 
                 <br>Dirección:  $fact_dir_clie
                 <br>Teléfono:  $fact_tlf_cliente
                 <br>e-mail:  $fact_email_clpv
                 $paciente_html
                 $forma_html
                 <br>Glosa:  $fact_cm1_fact
                 ";

            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();


    /**
     *
     */

    $sqlDeta = "select 
dfac_cod_prod,
dfac_nom_prod,
sum(dfac_cant_dfac) as dfac_cant_dfac,
dfac_precio_dfac,
dfac_des1_dfac,
dfac_des2_dfac,
sum(dfac_mont_total) as dfac_mont_total,
dfac_tip_dfac,
dfac_por_iva,
dfac_det_dfac,
dfac_por_dsg
from saedfac where dfac_cod_fact = $id and dfac_cod_sucu = $idSucursal and dfac_cod_empr = $idEmpresa
GROUP BY
dfac_cod_prod,
dfac_nom_prod,
dfac_cant_dfac,
dfac_precio_dfac,
dfac_des1_dfac,
dfac_des2_dfac,
dfac_mont_total,
dfac_tip_dfac,
dfac_por_iva,
dfac_det_dfac,
dfac_por_dsg ";



    $deta = '<br><br> <table style="width: 100%; font-size: 8px; border-radius: 5px; border-collapse: collapse;" border="1">';
    $deta .= ' <tr  bgcolor="#C9C2C1">';
    $deta .= ' <td style="width: 15%;" align="center">Cod.</td>';
    $deta .= ' <td style="width: 10%;" align="center">Cantidad</td>';
    $deta .= ' <td style="width: 34%;" align="center">Descripción</td>';
    $deta .= ' <td style="width: 15%;" align="center">P/Unit.</td>';
    $deta .= ' <td style="width: 11%;" align="center">Descto %.</td>';
    $deta .= ' <td style="width: 15%;" align="center">P/Total</td>';
    $deta .= ' </tr>';

    if ($oIfx->Query($sqlDeta)) {
        if ($oIfx->NumFilas() > 0) {

            do {
                $dfac_cod_prod = $oIfx->f('dfac_cod_prod');
                $dfac_nom_prod = $oIfx->f('dfac_nom_prod');
                $dfac_cant_dfac = $oIfx->f('dfac_cant_dfac');
                $dfac_precio_dfac = $oIfx->f('dfac_precio_dfac');
                $dfac_des1_dfac = $oIfx->f('dfac_des1_dfac');
                $dfac_des2_dfac = $oIfx->f('dfac_des2_dfac');
                $dfac_por_dsg = $oIfx->f('dfac_por_dsg');
                $dfac_mont_total = $oIfx->f('dfac_mont_total');
                $dfac_num_comp = $oIfx->f('dfac_tip_dfac');
                $dfac_por_iva = $oIfx->f('dfac_por_iva');
                $dfac_det_dfac = $oIfx->f('dfac_det_dfac');

                $descuento = $dfac_des1_dfac + $dfac_des2_dfac + $dfac_por_dsg;
                if ($descuento > 0) {
                    $descuento = ($dfac_precio_dfac * $dfac_cant_dfac) - ($dfac_mont_total);
                } else {
                    $descuento = 0;
                }

                $totalDescuento = $totalDescuento + $descuento;

                if ($dfac_por_dsg > 0) {
                    $descuento1 = ($dfac_precio_dfac * $dfac_cant_dfac * $dfac_des1_dfac) / 100;
                    $descuento2 = 0;
                    $descuento3 = 0;

                    $dfac_mont_total = number_format((($dfac_precio_dfac * $dfac_cant_dfac) - ($descuento1 + $descuento2 + $descuento3)), 2, '.', '');

                }

                $deta .= ' <tr>';
                $deta .= ' <td style="width: 15%; font-size: 6px;">' . $dfac_cod_prod . '</td>';
                $deta .= ' <td style="width: 10%; font-size: 7px;" align="right">' . number_format($dfac_cant_dfac, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 34%; font-size: 6px;">' . $dfac_nom_prod . '</td>';
                $deta .= ' <td style="width: 15%; font-size: 7px;" align="right">' . number_format($dfac_precio_dfac, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 11%; font-size: 7px;" align="right">' . round($dfac_des1_dfac, 0) . '</td>';
                $deta .= ' <td style="width: 15%; font-size: 7px;" align="right">' . number_format($dfac_mont_total, 2, '.', ',') . '</td>';
                $deta .= ' </tr>';
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $deta .= ' </table>';

    $porcIva = 12;

    $totales = ' <table  bgcolor="#C9C2C1" style="font-size: 8px; border-collapse: collapse;"  border="1" align="right">';

    $totales .= ' <tr>';
    $totales .= ' <td style="width: 60%;">SUBTOTAL:</td>';
    $totales .= ' <td style="width: 40%;" align="right">' . number_format($fact_con_miva+$fact_sin_miva+$fact_dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>DESCUENTO:</td>';
    $totales .= ' <td align="right">' . number_format($fact_dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>SUBTOTAL SIN IMPUESTOS:</td>';
    $totales .= ' <td align="right">' . number_format($fact_con_miva+$fact_sin_miva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>IVA ' . round($porcIva) . '%:</td>';
    $totales .= ' <td align="right">' . number_format($fact_iva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>ICE:</td>';
    $totales .= ' <td align="right">' . number_format($fact_ice, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>IRBP:</td>';
    $totales .= ' <td align="right">' . number_format($fact_val_irbp, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>TOTAL:</td>';
    $totales .= ' <td align="right">' . number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_ice + $fact_val_irbp + $fact_fle_fact +$fact_otr_fact , 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' </table>';

    /**
     *
     */
    $table_fact .= $deta;

    $table_fact .= '<br><br><table border="0" style="font-size: 5px; border-collapse: collapse;">';
    $table_fact .= '<tr>
                      <td style="width: 55%;" align="left" >'.$adicional_info.'</td>
                      <td style="width: 46%;" align="right" >'.$totales.'</td>
                    </tr>';
    $table_fact .= '</table>';


//    $table_fact .= ' <br><br>
//                        <table style="width: 100%; "  border="0" align="left" >
//                            <tr>
//
//                                <td style="width: 70%;" align="center">
//                                    _________________________________________________ <br>
//                                      <font size="7"> '.$fact_nom_cliente.'</font>
//                                     <br><br>
//                                </td>
//
//                            </tr>
//                    </table>';


    $fecha_Actual=date('Y-m-d H:i:s');
    $table_fact .= '<br><table style="font-size: 5px; width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">';
    $table_fact .= '<tr>
                          <td style="font-size:70%;" class="fecha_letra" align="left" width="100%;">
                          <p align="justify">_________________________________________________________________</p>
                           <font size="5"> '.$fact_nom_cliente.'</font><br><br><br>
                          </td>
                     </tr>';
    $table_fact .= '<tr>
                                                    <td style="font-size:70%;" class="fecha_letra" align="left" width="100%;"><p align="justify">Fecha y Hora de impresión: '.$fecha_Actual.'</p></td>
                                                </tr>';
    $table_fact .= '</table>';






    $documento = '<page backimgw="10%" backtop="10mm" backbottom="10mm" backleft="10mm" backright="10mm">';

    if(!$bandera_c){
        $documento.='<table style="width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">
<tr>
<td valign="top" style="width: 49%;">'.$table_fact.'</td>
<td valign="top" style="width: 2%;"></td>
<td valign="top" style="width: 49%;">'.$table_fact.'</td>
</tr>
</table>';
    }else{
        $documento.='<table style="width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">
<tr>
<td valign="top" style="width: 100%;">'.$table_fact.'</td>
</tr>
</table>';
    }


    $documento .= '</page>';



    return $documento;
}

function reporte_factura_alterno_cre_vertical($id = '', $nombre_archivo = '', $idSucursal = '',  &$rutaPdf = '')
{
    //Definiciones
    global $DSN_Ifx;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();


    $oIfxB = new Dbo;
    $oIfxB->DSN = $DSN_Ifx;
    $oIfxB->Conectar();


    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();

    $oIfxD = new Dbo;
    $oIfxD->DSN = $DSN_Ifx;
    $oIfxD->Conectar();

    $oReturn = new xajaxResponse();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    // $idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_sn_conta, empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr
                                            from saeempr where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S') {
                $empr_conta_sn = 'SI';
            }else {
                $empr_conta_sn = 'NO';
            }

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
            $empr_sn_conta = $oIfx->f('empr_sn_conta');
        }
    }
    $oIfx->Free();

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis  from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
        }
    }
    $oIfx->Free();

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }


    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;
    $arc_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];
    //echo $arc_img;exit;
    if (file_exists($arc_img)) {
        $imagen = $arc_img;
    } else {
        $imagen = '';
    }

    $logo = '';
    $x = '0px';
    if ($imagen != '') {

        $empr_logo = '<div align="left">
                        <img src="' . $imagen . '" style="
                        width:70px;">
                        </div>';
        $x = '0px';
    }
    else{
        $empr_logo ='<span><font color="red">SIN LOGO</font></span>';
    }


    //FORMATO DE FACTURA

    //selecciona sucursales y direcciones
    $sucursal_dir = '';
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                $sucursal_dir .= $sucu_nom_sucu;
                $sucursal_dir .= '<br>' . ($sucu_dir_sucu);
            } while ($oIfx->SiguienteRegistro());
        }
    }


    //    $table_fact = '<table  align="left" border="0"   style="width: 100%;  margin-top: 0px; " >';
    //    if ($empr_path_logo != '') {
    //        $table_fact .= '<tr>
    //                                <td align="left">' . $empr_logo . '</td>
    //                                <td align="right" style="color: black;" ><font size="7">
    //                                          '.$sucursal_dir.' <br>
    //                                          Contribuyente Especial #:' . $empr_num_resu . ' <br>
    //                                          Obligado a llevar Contabilidad :' . $empr_conta_sn . '
    //
    //                                </font></td>
    //                                </tr>
    //
    //                                    <tr><td colspan="2"  ><hr></td></tr>';
    //    }
    //    $table_fact .= '</table>';


    //consulta consumidor final
    $sql_consu = "select clpv_cod_clpv, clpv_nom_clpv, clpv_ruc_clpv, clpv_cod_vend, clpv_pre_ven 
                from saeclpv where clv_con_clpv = '07' and clpv_clopv_clpv = 'CL' and 
			    clpv_nom_clpv like ('CONSUMID%') and clpv_cod_empr = $idEmpresa";
    $cosumidor_clpv = consulta_string($sql_consu, 'clpv_cod_clpv', $oIfxA, 0);

    $sqlFac = "select * from saefact where fact_cod_fact = $id and fact_cod_sucu = $idSucursal and fact_cod_empr = $idEmpresa ";

    $consumido_final = 0;

    $logo .= '<table style="width: 100%;">';
    $logo .= '<tr>';
    $logo .= '<td align="center" style="width: 50%; border:1px solid black;">';
    $logo .= '<table align="center">';
    $logo .= '<tr><td><br><br><img width="200px;" height="160px;" src="' . $imagen . '"></td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 9px; white-space:nowrap;">' . $razonSocial . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 9px;">RUC : ' . $ruc_empr . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';

    //selecciona sucursales y direcciones
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                //$logo .= '<tr><td align="center" style="font-size: 12px">' . $sucu_nom_sucu . ': ' . ($sucu_dir_sucu) . '</td></tr>';
                $logo .= '<tr><td align="center" style="font-size: 9px">SUCURSAL : ' . $sucu_nom_sucu . '</td></tr>';
                $logo .= '<tr><td align="center" style="font-size: 9px">' . ($sucu_dir_sucu) . '</td></tr>';
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $logo .= '<tr><td>&nbsp;</td></tr>';

    
    if($empr_conta_sn=='SI'){

        if($empr_sn_conta=='S'){
            $empr_sn_conta ='SI';
        }
        else{
            $empr_sn_conta ='NO';
        }

        $logo .= '<tr><td align="center" style="font-size: 8px;">Obligado a llevar Contabilidad :' . $empr_sn_conta . '<br><br></td></tr>';
    }

    $logo .= ' </table>';
    $logo .= '</td>';


    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $fact_cod_fact = $oIfx->f('fact_cod_fact');
                $fact_nse_fact = $oIfx->f('fact_nse_fact');
                $fact_num_preimp = $oIfx->f('fact_num_preimp');
                $fact_nom_cliente = $oIfx->f('fact_nom_cliente');
                $fact_fech_fact = ($oIfx->f('fact_fech_fact'));
                $fact_ruc_clie = $oIfx->f('fact_ruc_clie');
                $fact_tlf_cliente = $oIfx->f('fact_tlf_cliente');
                $fact_dir_clie = ($oIfx->f('fact_dir_clie'));
                $fact_email_clpv = str_replace(' ', '', $oIfx->f("fact_email_clpv"));
                $fact_con_miva = $oIfx->f('fact_con_miva');
                $fact_sin_miva = $oIfx->f('fact_sin_miva');
                $fact_tot_fact = $oIfx->f('fact_tot_fact');
                $fact_iva = $oIfx->f('fact_iva');
                $fact_ice = $oIfx->f('fact_ice');
                $fact_clav_sri = $oIfx->f('fact_clav_sri');
                $fact_dsg_valo = $oIfx->f('fact_dsg_valo');
                $fact_cm1_fact = $oIfx->f("fact_cm1_fact");
                $fact_cm2_fact = $oIfx->f("fact_cm2_fact");
                $fact_cm4_fact = $oIfx->f("fact_cm4_fact");
                $orden_compra = $oIfx->f("fact_opc_fact");
                $fact_cod_clpv = $oIfx->f("fact_cod_clpv");
                $fact_cod_ccli = $oIfx->f("fact_cod_ccli");
                $fact_dia_plazo = $oIfx->f("fact_dia_fact");
                $fact_val_irbp = $oIfx->f("fact_val_irbp");
                $fact_tipo_convenio = $oIfx->f("fact_tipo_convenio");
                $fact_auto_sri = $oIfx->f("fact_auto_sri");
                $fact_fech_sri = $oIfx->f("fact_fech_sri");
                $fact_cod_guia = $oIfx->f("fact_cod_guia");
                $fact_fle_fact = $oIfx->f('fact_fle_fact');
                $fact_otr_fact = $oIfx->f('fact_otr_fact');

                $bandera_paciente = 0;
                $guia_ruc_clie = '';
                $guia_nom_cliente = '';
                if($fact_cod_guia){
                    $sqlPaciente = "select guia_cod_clpv, guia_ruc_clie, guia_nom_cliente from saeguia where guia_cod_guia in ($fact_cod_guia) and guia_alb_tipo = '1' limit 1;";
                    if ($oIfxB->Query($sqlPaciente)) {
                        if ($oIfxB->NumFilas() > 0) {
                            $bandera_paciente = 1;
                            $guia_cod_clpv = $oIfxB->f('guia_cod_clpv');
                            $guia_ruc_clie = $oIfxB->f('guia_ruc_clie');
                            $guia_nom_cliente = $oIfxB->f('guia_nom_cliente');
                        }
                    }
                    $oIfxB->Free();
                }


                $fact_tip_vent = $oIfx->f("fact_tip_vent");
                $sql = "select tcmp_cod_tcmp, tcmp_des_tcmp from saetcmp where tcmp_cod_tcmp = '$fact_tip_vent';";
                $tipo_text_fac= consulta_string($sql,'tcmp_des_tcmp', $oIfxB,'FACTURA');

                $logo .= '<td style="width: 50%; border: 1px solid black; border-radius: 1px;" align="center">';
                $logo .= ' <table align="center" style="font-size: 9px;">';
                $logo .= ' <tr>';
                $logo .= '<td><br><br>'.$tipo_text_fac.'<hr></td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>SERIE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . substr($fact_nse_fact, 0, 3) . '-' . substr($fact_nse_fact, 3, 6) . ' </td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="font-size: 9px; color: red;">' . $fact_num_preimp . '<hr></td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fact_auto_sri . '<hr></td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>FECHA AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fact_fech_sri . '<hr></td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>AMBIENTE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $ambiente_sri . '<hr></td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>EMISION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $emision_sri . '<hr></td>';
                $logo .= ' </tr>';

                //verifica si existe clave de acceso
                if ($fact_clav_sri != '') {
                    $nombArch = $fact_nse_fact . $fact_num_preimp;
                    //$nombArch = '0112201401179141325300110010010000048101234567818';
                    $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';

                    new barCodeGenrator($fact_clav_sri, 1, $rutaCodi, 450, 100, true);

                    $logo .= '<tr>';
                    $logo .= '<td>CLAVE DE ACCESO:</td>';
                    $logo .= '</tr>';
                    $logo .= '<tr>';
                    $logo .= '<td align="center"> <img width="350px;" src="' . $rutaCodi . '"/></td>';
                    $logo .= '</tr>';
                }

                $logo .= ' </table>';
                $logo .= '</td>';
                $logo .= '</tr>';
                $logo .= '</table>';
                $logo .= ' <br>';


                $table_fact .= $logo;

                /**
                 * INFORMACION CABECERA
                 */
                $table_fact .= '<br><br><table bgcolor="#C9C2C1" align="left" style="width: 100%; border:3px solid black; ">';
                $table_fact .='<tr>
                                           <td style="font-size:90%;" style="width:15%"><strong>Cliente:</strong></td>
                                           <td style="font-size:90%;" style="width:50%">'. ($fact_nom_cliente).'</td>
                                           <td style="font-size:90%;" style="width:12%"><strong>RUC/CI:</strong></td>
                                           <td style="font-size:90%;" style="width:23%">'.$fact_ruc_clie.'</td>
                                        </tr>';

                $table_fact .='<tr>
                                           <td><strong>Fecha Emisión:</strong></td>
                                           <td>'.$fact_fech_fact.'</td>
                                           <td></td>
                                           <td></td>
                                        </tr>';

                $table_fact .='</table>';

                /**
                 * INFORMACION ADICIONAL
                 */
                $convenio_html = '';
                if($fact_tipo_convenio){
                    $sqlOpc = "select nombre from comercial.cre_tipo_convenio where id = $fact_tipo_convenio;";
                    $convenio_ = consulta_string($sqlOpc, 'nombre', $oIfxA, '');
                    $convenio_html = '<br>Acuerdo: '.$convenio_;
                }

                $paciente_html = '';
                if($bandera_paciente){  
                    $paciente_html .= '<br><strong>Paciente:</strong> '.$guia_nom_cliente;
                    $paciente_html .= '<br><strong>Ruc/Ci:</strong> '.$guia_ruc_clie;
                }

                $sql = "select 
                        fxf.fxfp_val_fxfp as tot,
                        fpa.fpag_des_fpag as pag
                        from saefxfp fxf
                        inner join saefpag fpa on fxf.fxfp_cod_fpag = fpa.fpag_cod_fpag
                        where fxfp_cod_fact = $fact_cod_fact and fxfp_cod_empr = $idEmpresa;";
                $forma_html = '';
                if ($oIfxB->Query($sql)) {
                    if ($oIfxB->NumFilas() > 0) {
                        $tot = number_format($oIfxB->f('tot'),2,'.','');
                        $pag = $oIfxB->f('pag');
                        $forma_html .= "<br><strong>Forma de pago:</strong> $pag <br><strong>Monto:</strong> $tot";
                    }
                }
                $oIfxB->Free();

                $fact_dir_clie = ($fact_dir_clie);
                $adicional_info = '
                <div style="
                width: 100%;
                height: auto;
                text-align: left;
                line-height: 10px;
                vertical-align: center;
                white-space: nowrap;
                overflow: hidden;
                font-size:10px;"><strong>Información Adicional: </strong>
                    '.$convenio_html.'<br> 
                    <br><strong>Dirección:</strong>  '.$fact_dir_clie.'
                    <br><strong>Teléfono:</strong>  '.$fact_tlf_cliente.'
                    <br><strong>e-mail:</strong>  '.$fact_email_clpv.'
                    '.$paciente_html.'
                    '.$forma_html.'
                    <br><strong>Glosa:</strong>  '.($fact_cm1_fact?$fact_cm1_fact:"").'
                 </div>
                 ';

            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    //    print_r($logo);Exit;

        /**
         *
         */

    $sqlDeta = "SELECT
                        case
                            when prod_alt_clie is null then dfac_cod_prod
                            when prod_alt_clie = '' then dfac_cod_prod
                            else prod_alt_clie end                       
                         AS dfac_cod_prod,
                        dfac_nom_prod,
                        SUM ( dfac_cant_dfac ) AS dfac_cant_dfac,
                        dfac_precio_dfac,
                        dfac_des1_dfac,
                        dfac_des2_dfac,
                        SUM ( dfac_mont_total ) AS dfac_mont_total,
                        dfac_tip_dfac,
                        dfac_por_iva,
                        dfac_det_dfac,
                        dfac_por_dsg,
                        cl.clpv_clopv_clpv 
                    FROM
                        saedfac df
                        INNER JOIN saeprod pr ON df.dfac_cod_prod = pr.prod_cod_prod AND pr.prod_cod_sucu = dfac_cod_sucu
                        INNER JOIN saeclpv cl on cl.clpv_cod_clpv = pr.prod_cod_clpv and cl.clpv_cod_empr = dfac_cod_empr

                    WHERE dfac_cod_fact = $id and dfac_cod_sucu = $idSucursal and dfac_cod_empr = $idEmpresa
                        
                    GROUP BY
                        dfac_cod_prod,
                        dfac_nom_prod,
                        dfac_cant_dfac,
                        dfac_precio_dfac,
                        dfac_des1_dfac,
                        dfac_des2_dfac,
                        dfac_mont_total,
                        dfac_tip_dfac,
                        dfac_por_iva,
                        dfac_det_dfac,
                        dfac_por_dsg,
                        prod_alt_clie,
                        clpv_clopv_clpv";

    // $sqlDeta = "select 
    //             dfac_cod_prod,
    //             dfac_nom_prod,
    //             sum(dfac_cant_dfac) as dfac_cant_dfac,
    //             dfac_precio_dfac,
    //             dfac_des1_dfac,
    //             dfac_des2_dfac,
    //             sum(dfac_mont_total) as dfac_mont_total,
    //             dfac_tip_dfac,
    //             dfac_por_iva,
    //             dfac_det_dfac,
    //             dfac_por_dsg
    //             from saedfac 
    //             where dfac_cod_fact = $id and dfac_cod_sucu = $idSucursal and dfac_cod_empr = $idEmpresa
    //             GROUP BY
    //             dfac_cod_prod,
    //             dfac_nom_prod,
    //             dfac_cant_dfac,
    //             dfac_precio_dfac,
    //             dfac_des1_dfac,
    //             dfac_des2_dfac,
    //             dfac_mont_total,
    //             dfac_tip_dfac,
    //             dfac_por_iva,
    //             dfac_det_dfac,
    //             dfac_por_dsg ";



    $deta = '<br><br> <table style="width: 100%; font-size: 8px; border-radius: 5px; border-collapse: collapse;" border="1">';
    $deta .= ' <tr  bgcolor="#C9C2C1">';
    $deta .= ' <td style="width: 15%;" align="center">Cod.</td>';
    $deta .= ' <td style="width: 10%;" align="center">Cantidad</td>';
    $deta .= ' <td style="width: 34%;" align="center">Descripción</td>';
    $deta .= ' <td style="width: 15%;" align="center">P/Unit.</td>';
    $deta .= ' <td style="width: 11%;" align="center">Descto %.</td>';
    $deta .= ' <td style="width: 15%;" align="center">P/Total</td>';
    $deta .= ' </tr>';

    if ($oIfx->Query($sqlDeta)) {
        if ($oIfx->NumFilas() > 0) {

            do {
                $dfac_cod_prod = $oIfx->f('dfac_cod_prod');
                $dfac_nom_prod = $oIfx->f('dfac_nom_prod');
                $dfac_cant_dfac = $oIfx->f('dfac_cant_dfac');
                $dfac_precio_dfac = $oIfx->f('dfac_precio_dfac');
                $dfac_des1_dfac = $oIfx->f('dfac_des1_dfac');
                $dfac_des2_dfac = $oIfx->f('dfac_des2_dfac');
                $dfac_por_dsg = $oIfx->f('dfac_por_dsg');
                $dfac_mont_total = $oIfx->f('dfac_mont_total');
                $dfac_num_comp = $oIfx->f('dfac_tip_dfac');
                $dfac_por_iva = $oIfx->f('dfac_por_iva');
                $dfac_det_dfac = $oIfx->f('dfac_det_dfac');

                $descuento = $dfac_des1_dfac + $dfac_des2_dfac + $dfac_por_dsg;
                if ($descuento > 0) {
                    $descuento = ($dfac_precio_dfac * $dfac_cant_dfac) - ($dfac_mont_total);
                } else {
                    $descuento = 0;
                }

                $totalDescuento = $totalDescuento + $descuento;

                if ($dfac_por_dsg > 0) {
                    $descuento1 = ($dfac_precio_dfac * $dfac_cant_dfac * $dfac_des1_dfac) / 100;
                    $descuento2 = 0;
                    $descuento3 = 0;

                    $dfac_mont_total = number_format((($dfac_precio_dfac * $dfac_cant_dfac) - ($descuento1 + $descuento2 + $descuento3)), 2, '.', '');

                }


                $deta .= ' <tr>';
                $deta .= ' <td style="width: 15%; font-size: 8px;">' . $dfac_cod_prod . '</td>';
                $deta .= ' <td style="width: 10%; font-size: 8px;" align="right">' . number_format($dfac_cant_dfac, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 34%; font-size: 8px;">' . $dfac_nom_prod . '</td>';
                $deta .= ' <td style="width: 15%; font-size: 8px;" align="right">' . number_format($dfac_precio_dfac, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 11%; font-size: 8px;" align="right">' . round($dfac_des1_dfac, 0) . '</td>';
                $deta .= ' <td style="width: 15%; font-size: 8px;" align="right">' . number_format($dfac_mont_total, 2, '.', ',') . '</td>';
                $deta .= ' </tr>';
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $deta .= ' </table>';

    $porcIva = 12;

    $totales = ' <table  bgcolor="#C9C2C1" style="font-size: 8px; border-collapse: collapse;"  border="1" align="right">';

    $totales .= ' <tr>';
    $totales .= ' <td style="width: 60%;" >SUBTOTAL:</td>';
    $totales .= ' <td style="width: 40%;" align="right">' . number_format($fact_con_miva+$fact_sin_miva+$fact_dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>DESCUENTO:</td>';
    $totales .= ' <td align="right">' . number_format($fact_dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>SUBTOTAL SIN IMPUESTOS:</td>';
    $totales .= ' <td align="right">' . number_format($fact_con_miva+$fact_sin_miva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>IVA ' . round($porcIva) . '%:</td>';
    $totales .= ' <td align="right">' . number_format($fact_iva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>ICE:</td>';
    $totales .= ' <td align="right">' . number_format($fact_ice, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>IRBP:</td>';
    $totales .= ' <td align="right">' . number_format($fact_val_irbp, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>TOTAL:</td>';
    $totales .= ' <td align="right">' . number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_ice + $fact_val_irbp+ $fact_fle_fact +$fact_otr_fact, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' </table>';

    /**
     *
     */
    $table_fact .= $deta;

    $table_fact .= '<br><br><table border="0" style="font-size: 5px; border-collapse: collapse;">';
    $table_fact .= '<tr>
                      <td style="width: 55%;" align="left" >'.$adicional_info.'</td>
                      <td style="width: 46%;" align="right" >'.$totales.'</td>
                    </tr>';
    $table_fact .= '</table>';


    //    $table_fact .= ' <br><br>
    //                        <table style="width: 100%; "  border="0" align="left" >
    //                            <tr>
    //
    //                                <td style="width: 70%;" align="center">
    //                                    _________________________________________________ <br>
    //                                      <font size="7"> '.$fact_nom_cliente.'</font>
    //                                     <br><br>
    //                                </td>
    //
    //                            </tr>
    //                    </table>';


    $fecha_Actual=date('Y-m-d H:i:s');
    $table_fact .= '<br><table style="font-size: 5px; width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">';
    $table_fact .= '<tr>
                          <td style="font-size:70%;" class="fecha_letra" align="left" width="100%;">
                          <p align="justify">_________________________________________________________________</p>
                           <font size="5"> '.$fact_nom_cliente.'</font><br><br><br>
                          </td>
                     </tr>';
    $table_fact .= '<tr>
                                                    <td style="font-size:70%;" class="fecha_letra" align="left" width="100%;"><p align="justify">Fecha y Hora de impresión: '.$fecha_Actual.'</p></td>
                                                </tr>';
    $table_fact .= '</table>';






    $documento = '<page backimgw="10%" backtop="10mm" backbottom="10mm" backleft="10mm" backright="10mm">';

    $documento.='<table style="width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">
    <tr>
    <td valign="top" style="width: 100%;">'.$table_fact.'</td>
    </tr>
    </table>';

    $documento .= '</page>';

    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $rutaPdf = $ruta;

    return $documento;
}

function reporte_factura_alterno_cre_vertical_sri($id = '', $nombre_archivo = '', $idSucursal = '',  &$rutaPdf = '')
{
    //Definiciones
    global $DSN_Ifx;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();


    $oIfxB = new Dbo;
    $oIfxB->DSN = $DSN_Ifx;
    $oIfxB->Conectar();


    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();

    $oIfxD = new Dbo;
    $oIfxD->DSN = $DSN_Ifx;
    $oIfxD->Conectar();

    $oReturn = new xajaxResponse();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    // $idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_sn_conta,empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr
                                            from saeempr where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S') {
                $empr_conta_sn = 'SI';
            }else {
                $empr_conta_sn = 'NO';
            }

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
            $empr_sn_conta = $oIfx->f('empr_sn_conta');
        }
    }
    $oIfx->Free();

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis  from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
        }
    }
    $oIfx->Free();

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }


    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;
    $arc_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];
    //echo $arc_img;exit;
    if (file_exists($arc_img)) {
        $imagen = $arc_img;
    } else {
        $imagen = '';
    }

    $logo = '';
    $x = '0px';
    if ($imagen != '') {

        $empr_logo = '<div align="left">
                        <img src="' . $imagen . '" style="
                        width:70px;">
                        </div>';
        $x = '0px';
    }
    else{
        $empr_logo ='<span><font color="red">SIN LOGO</font></span>';
    }


    //FORMATO DE FACTURA

    //selecciona sucursales y direcciones
    $sucursal_dir = '';
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                $sucursal_dir .= $sucu_nom_sucu;
                $sucursal_dir .= '<br>' . ($sucu_dir_sucu);
            } while ($oIfx->SiguienteRegistro());
        }
    }


//    $table_fact = '<table  align="left" border="0"   style="width: 100%;  margin-top: 0px; " >';
//    if ($empr_path_logo != '') {
//        $table_fact .= '<tr>
//                                <td align="left">' . $empr_logo . '</td>
//                                <td align="right" style="color: black;" ><font size="7">
//                                          '.$sucursal_dir.' <br>
//                                          Contribuyente Especial #:' . $empr_num_resu . ' <br>
//                                          Obligado a llevar Contabilidad :' . $empr_conta_sn . '
//
//                                </font></td>
//                                </tr>
//
//                                    <tr><td colspan="2"  ><hr></td></tr>';
//    }
//    $table_fact .= '</table>';


    //consulta consumidor final
    $sql_consu = "select clpv_cod_clpv, clpv_nom_clpv, clpv_ruc_clpv, clpv_cod_vend, clpv_pre_ven 
                from saeclpv where clv_con_clpv = '07' and clpv_clopv_clpv = 'CL' and 
			    clpv_nom_clpv like ('CONSUMID%') and clpv_cod_empr = $idEmpresa";
    $cosumidor_clpv = consulta_string($sql_consu, 'clpv_cod_clpv', $oIfxA, 0);

    $sqlFac = "select * from saefact where fact_cod_fact = $id and fact_cod_sucu = $idSucursal and fact_cod_empr = $idEmpresa ";

    $consumido_final = 0;

    $logo .= '<table style="width: 100%;">';
    $logo .= '<tr>';
    $logo .= '<td align="center" style="width: 50%; border:1px solid black;">';
    $logo .= '<table align="center">';
    $logo .= '<tr><td><br><br><img width="200px;" height="160px;" src="' . $imagen . '"></td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 18px; white-space:nowrap;">' . $razonSocial . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 18px;">RUC : ' . $ruc_empr . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';

    //selecciona sucursales y direcciones
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                //$logo .= '<tr><td align="center" style="font-size: 12px">' . $sucu_nom_sucu . ': ' . ($sucu_dir_sucu) . '</td></tr>';
                $logo .= '<tr><td align="center" style="font-size: 18px">SUCURSAL : ' . $sucu_nom_sucu . '</td></tr>';
                $logo .= '<tr><td align="center" style="font-size: 18px">' . ($sucu_dir_sucu) . '</td></tr>';
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $logo .= '<tr><td>&nbsp;</td></tr>';

    if($empr_conta_sn=='SI'){
        if($empr_sn_conta=='S'){
            $empr_sn_conta ='SI';
        }
        else{
            $empr_sn_conta ='NO';
        }
        $logo .= '<tr><td align="center" style="font-size: 18px;">Obligado a llevar Contabilidad :' . $empr_sn_conta . '<br><br></td></tr>';
    }

    
    $logo .= ' </table>';
    $logo .= '</td>';


    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $fact_cod_fact = $oIfx->f('fact_cod_fact');
                $fact_nse_fact = $oIfx->f('fact_nse_fact');
                $fact_num_preimp = $oIfx->f('fact_num_preimp');
                $fact_nom_cliente = $oIfx->f('fact_nom_cliente');
                $fact_fech_fact = ($oIfx->f('fact_fech_fact'));
                $fact_ruc_clie = $oIfx->f('fact_ruc_clie');
                $fact_tlf_cliente = $oIfx->f('fact_tlf_cliente');
                $fact_dir_clie = ($oIfx->f('fact_dir_clie'));
                $fact_email_clpv = str_replace(' ', '', $oIfx->f("fact_email_clpv"));
                $fact_con_miva = $oIfx->f('fact_con_miva');
                $fact_sin_miva = $oIfx->f('fact_sin_miva');
                $fact_tot_fact = $oIfx->f('fact_tot_fact');
                $fact_iva = $oIfx->f('fact_iva');
                $fact_ice = $oIfx->f('fact_ice');
                $fact_clav_sri = $oIfx->f('fact_clav_sri');
                $fact_dsg_valo = $oIfx->f('fact_dsg_valo');
                $fact_cm1_fact = $oIfx->f("fact_cm1_fact");
                $fact_cm2_fact = $oIfx->f("fact_cm2_fact");
                $fact_cm4_fact = $oIfx->f("fact_cm4_fact");
                $orden_compra = $oIfx->f("fact_opc_fact");
                $fact_cod_clpv = $oIfx->f("fact_cod_clpv");
                $fact_cod_ccli = $oIfx->f("fact_cod_ccli");
                $fact_dia_plazo = $oIfx->f("fact_dia_fact");
                $fact_val_irbp = $oIfx->f("fact_val_irbp");
                $fact_tipo_convenio = $oIfx->f("fact_tipo_convenio");
                $fact_auto_sri = $oIfx->f("fact_auto_sri");
                $fact_fech_sri = $oIfx->f("fact_fech_sri");
                $fact_cod_guia = $oIfx->f("fact_cod_guia");
                $fact_fle_fact = $oIfx->f('fact_fle_fact');
                $fact_otr_fact = $oIfx->f('fact_otr_fact');

                $bandera_paciente = 0;
                $guia_ruc_clie = '';
                $guia_nom_cliente = '';
                if($fact_cod_guia){
                    $sqlPaciente = "select guia_cod_clpv, guia_ruc_clie, guia_nom_cliente from saeguia where guia_cod_guia in ($fact_cod_guia) and guia_alb_tipo = '1' limit 1;";
                    if ($oIfxB->Query($sqlPaciente)) {
                        if ($oIfxB->NumFilas() > 0) {
                            $bandera_paciente = 1;
                            $guia_cod_clpv = $oIfxB->f('guia_cod_clpv');
                            $guia_ruc_clie = $oIfxB->f('guia_ruc_clie');
                            $guia_nom_cliente = $oIfxB->f('guia_nom_cliente');
                        }
                    }
                    $oIfxB->Free();
                }


                $fact_tip_vent = $oIfx->f("fact_tip_vent");
                $sql = "select tcmp_cod_tcmp, tcmp_des_tcmp from saetcmp where tcmp_cod_tcmp = '$fact_tip_vent';";
                $tipo_text_fac= consulta_string($sql,'tcmp_des_tcmp', $oIfxB,'FACTURA');

                $logo .= '<td style="width: 50%; border: 1px solid black; border-radius: 1px;" align="center">';
                $logo .= ' <table align="center" style="font-size: 18px;" cellpadding="2">';
                $logo .= ' <tr>';
                $logo .= '<td><br><br>'.$tipo_text_fac.'<hr></td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>SERIE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . substr($fact_nse_fact, 0, 3) . '-' . substr($fact_nse_fact, 3, 6) . ' </td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="font-size: 18px; color: red;">' . $fact_num_preimp . '<hr></td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fact_auto_sri . '<hr></td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>FECHA AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fact_fech_sri . '<hr></td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>AMBIENTE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $ambiente_sri . '<hr></td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>EMISION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $emision_sri . '<hr></td>';
                $logo .= ' </tr>';

                //verifica si existe clave de acceso
                if ($fact_clav_sri != '') {
                    $nombArch = $fact_nse_fact . $fact_num_preimp;
                    //$nombArch = '0112201401179141325300110010010000048101234567818';
                    $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';

                    new barCodeGenrator($fact_clav_sri, 1, $rutaCodi, 450, 100, true);

                    $logo .= '<tr>';
                    $logo .= '<td>CLAVE DE ACCESO:</td>';
                    $logo .= '</tr>';
                    $logo .= '<tr>';
                    $logo .= '<td align="center"> <img width="350px;" src="' . $rutaCodi . '"/></td>';
                    $logo .= '</tr>';
                }

                $logo .= ' </table>';
                $logo .= '</td>';
                $logo .= '</tr>';
                $logo .= '</table>';
                $logo .= ' <br>';


                $table_fact .= $logo;

                /**
                 * INFORMACION CABECERA
                 */
                $table_fact .= '<br><br><table bgcolor="#C9C2C1" align="left" style="width: 100%; border:3px solid black; " cellpadding="2">';
                $table_fact .='<tr>
                                           <td style="font-size:90%;" style="width:15%"><strong>Cliente:</strong></td>
                                           <td style="font-size:90%;" style="width:50%">'. ($fact_nom_cliente).'</td>
                                           <td style="font-size:90%;" style="width:12%"><strong>RUC/CI:</strong></td>
                                           <td style="font-size:90%;" style="width:23%">'.$fact_ruc_clie.'</td>
                                        </tr>';

                $table_fact .='<tr>
                                           <td><strong>Fecha Emisión:</strong></td>
                                           <td>'.$fact_fech_fact.'</td>
                                           <td></td>
                                           <td></td>
                                        </tr>';

                $table_fact .='</table>';

                /**
                 * INFORMACION ADICIONAL
                 */
                $convenio_html = '';
                if($fact_tipo_convenio){
                    $sqlOpc = "select nombre from comercial.cre_tipo_convenio where id = $fact_tipo_convenio;";
                    $convenio_ = consulta_string($sqlOpc, 'nombre', $oIfxA, '');
                    $convenio_html = '<br>Acuerdo: '.$convenio_;
                }

                $paciente_html = '';
                if($bandera_paciente){
                    $paciente_html .= '<br>Paciente: '.$guia_nom_cliente;
                    $paciente_html .= '<br>Ruc/Ci: '.$guia_ruc_clie;
                }

                $sql = "select 
                        fxf.fxfp_val_fxfp as tot,
                        fpa.fpag_des_fpag as pag
                        from saefxfp fxf
                        inner join saefpag fpa on fxf.fxfp_cod_fpag = fpa.fpag_cod_fpag
                        where fxfp_cod_fact = $fact_cod_fact and fxfp_cod_empr = $idEmpresa;";
                $forma_html = '';
                if ($oIfxB->Query($sql)) {
                    if ($oIfxB->NumFilas() > 0) {
                        $tot = number_format($oIfxB->f('tot'),2,'.','');
                        $pag = $oIfxB->f('pag');
                        $forma_html .= "<br>FORMA DE PAGO: $pag <br>MONTO: $tot";
                    }
                }
                $oIfxB->Free();

                $fact_dir_clie = ($fact_dir_clie);
                $adicional_info = "<strong>Información Adicional: </strong>
                 $convenio_html 
                 <br>Dirección:  $fact_dir_clie
                 <br>Teléfono:  $fact_tlf_cliente
                 <br>e-mail:  $fact_email_clpv
                 $paciente_html
                 $forma_html
                 <br>Glosa:  $fact_cm1_fact
                 ";

            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

//    print_r($logo);Exit;

    /**
     *
     */

    $sqlDeta = "select 
dfac_cod_prod,
dfac_nom_prod,
sum(dfac_cant_dfac) as dfac_cant_dfac,
dfac_precio_dfac,
dfac_des1_dfac,
dfac_des2_dfac,
sum(dfac_mont_total) as dfac_mont_total,
dfac_tip_dfac,
dfac_por_iva,
dfac_det_dfac
from saedfac where dfac_cod_fact = $id and dfac_cod_sucu = $idSucursal and dfac_cod_empr = $idEmpresa
GROUP BY
dfac_cod_prod,
dfac_nom_prod,
dfac_cant_dfac,
dfac_precio_dfac,
dfac_des1_dfac,
dfac_des2_dfac,
dfac_mont_total,
dfac_tip_dfac,
dfac_por_iva,
dfac_det_dfac ";



    $deta = '<br><br> <table style="width: 100%; font-size: 18px; border-radius: 5px; border-collapse: collapse;" border="1" cellpadding="2">';
    $deta .= ' <tr  bgcolor="#C9C2C1">';
    $deta .= ' <td style="width: 15%;" align="center">Cod.</td>';
    $deta .= ' <td style="width: 10%;" align="center">Cantidad</td>';
    $deta .= ' <td style="width: 34%;" align="center">Descripción</td>';
    $deta .= ' <td style="width: 15%;" align="center">P/Unit.</td>';
    $deta .= ' <td style="width: 11%;" align="center">Descto.</td>';
    $deta .= ' <td style="width: 15%;" align="center">P/Total</td>';
    $deta .= ' </tr>';

    if ($oIfx->Query($sqlDeta)) {
        if ($oIfx->NumFilas() > 0) {

            do {
                $dfac_cod_prod = $oIfx->f('dfac_cod_prod');
                $dfac_nom_prod = $oIfx->f('dfac_nom_prod');
                $dfac_cant_dfac = $oIfx->f('dfac_cant_dfac');
                $dfac_precio_dfac = $oIfx->f('dfac_precio_dfac');
                $dfac_des1_dfac = $oIfx->f('dfac_des1_dfac');
                $dfac_des2_dfac = $oIfx->f('dfac_des2_dfac');
                $dfac_por_dsg = $oIfx->f('dfac_por_dsg');
                $dfac_mont_total = $oIfx->f('dfac_mont_total');
                $dfac_num_comp = $oIfx->f('dfac_tip_dfac');
                $dfac_por_iva = $oIfx->f('dfac_por_iva');
                $dfac_det_dfac = $oIfx->f('dfac_det_dfac');

                $descuento = $dfac_des1_dfac + $dfac_des2_dfac + $dfac_por_dsg;
                if ($descuento > 0) {
                    $descuento = ($dfac_precio_dfac * $dfac_cant_dfac) - ($dfac_mont_total);
                } else {
                    $descuento = 0;
                }

                $totalDescuento = $totalDescuento + $descuento;

                $deta .= ' <tr>';
                $deta .= ' <td style="width: 15%; font-size: 18px;">' . $dfac_cod_prod . '</td>';
                $deta .= ' <td style="width: 10%; font-size: 18px;" align="right">' . number_format($dfac_cant_dfac, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 34%; font-size: 17px;">' . $dfac_nom_prod . '</td>';
                $deta .= ' <td style="width: 15%; font-size: 18px;" align="right">' . number_format($dfac_precio_dfac, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 11%; font-size: 18px;" align="right">' . round($dfac_des1_dfac, 0) . '</td>';
                $deta .= ' <td style="width: 15%; font-size: 18px;" align="right">' . number_format($dfac_mont_total, 2, '.', ',') . '</td>';
                $deta .= ' </tr>';
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $deta .= ' </table>';

    $porcIva = 12;

    $totales = ' <table  bgcolor="#C9C2C1" style="font-size: 17px; border-collapse: collapse;"  border="1" align="right" cellpadding="2">';

    $totales .= ' <tr>';
    $totales .= ' <td style="width: 60%;" >SUB SIN IMPTOS:</td>';
    $totales .= ' <td style="width: 40%;" align="right">' . number_format($fact_tot_fact, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';

    $totales .= ' <td>SUBTOTAL ' . round($porcIva) . ' %:</td>';
    $totales .= ' <td align="right">' . number_format($fact_con_miva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>SUBTOTAL 0%:</td>';
    $totales .= ' <td align="right">' . number_format($fact_sin_miva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>DESCUENTO:</td>';
    $totales .= ' <td align="right">' . number_format($fact_dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>IVA ' . round($porcIva) . '%:</td>';
    $totales .= ' <td align="right">' . number_format($fact_iva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>ICE:</td>';
    $totales .= ' <td align="right">' . number_format($fact_ice, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>IRBP:</td>';
    $totales .= ' <td align="right">' . number_format($fact_val_irbp, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>TOTAL:</td>';
    $totales .= ' <td align="right">' . number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_ice + $fact_val_irbp+ $fact_fle_fact +$fact_otr_fact, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' </table>';

    /**
     *
     */
    $table_fact .= $deta;

    $table_fact .= '<br><br><table border="0" style="font-size: 18px; border-collapse: collapse;">';
    $table_fact .= '<tr>
                      <td style="width: 55%;" align="left" >'.$adicional_info.'</td>
                      <td style="width: 46%;" align="right" >'.$totales.'</td>
                    </tr>';
    $table_fact .= '</table>';


//    $table_fact .= ' <br><br>
//                        <table style="width: 100%; "  border="0" align="left" >
//                            <tr>
//
//                                <td style="width: 70%;" align="center">
//                                    _________________________________________________ <br>
//                                      <font size="7"> '.$fact_nom_cliente.'</font>
//                                     <br><br>
//                                </td>
//
//                            </tr>
//                    </table>';


    $fecha_Actual=date('Y-m-d H:i:s');
    $table_fact .= '<br><table style="font-size: 5px; width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">';
    $table_fact .= '<tr>
                          <td style="font-size:70%;" class="fecha_letra" align="left" width="100%;">
                          <p align="justify">_________________________________________________________________</p>
                           <font size="5"> '.$fact_nom_cliente.'</font><br><br><br>
                          </td>
                     </tr>';
    $table_fact .= '<tr>
                                                    <td style="font-size:70%;" class="fecha_letra" align="left" width="100%;"><p align="justify">Fecha y Hora de impresión: '.$fecha_Actual.'</p></td>
                                                </tr>';
    $table_fact .= '</table>';






    $documento = '<page backimgw="10%" backtop="10mm" backbottom="10mm" backleft="10mm" backright="10mm">';

    $documento.='<table style="width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">
<tr>
<td valign="top" style="width: 100%;">'.$table_fact.'</td>
</tr>
</table>';

    $documento .= '</page>';

    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $rutaPdf = $ruta;
    /**GUARDADO ARCHIVO **/

    $pdf = new TCPDF('P', 'mm', 'A4', true, 'UTF-8', false);
    $pdf->setPrintHeader(false);
    $pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);
    //$pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);
    $pdf->SetMargins(10,10, 10, true);
    // set auto page breaks
    $pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);
    // set image scale factor
    $pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);
    // set font
    $pdf->SetFont('helvetica', 'N', 8);
    // add a page
    $pdf->AddPage();

    $pdf->writeHTMLCell(0, 0, '', '',$documento, 0, 1, 0, true, '', true);

    $pdf->Output($ruta,'F');


    return $documento;
}

function reporte_nota_credito_alterno_cre($id = '', $nombre_archivo = '', $idSucursal = ', $bandera_c = 0')
{
    //Definiciones
    global $DSN_Ifx;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();


    $oIfxB = new Dbo;
    $oIfxB->DSN = $DSN_Ifx;
    $oIfxB->Conectar();


    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();

    $oIfxD = new Dbo;
    $oIfxD->DSN = $DSN_Ifx;
    $oIfxD->Conectar();

    $oReturn = new xajaxResponse();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    // $idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_sn_conta, empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr
                                            from saeempr where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S') {
                $empr_conta_sn = 'SI';
            }else {
                $empr_conta_sn = 'NO';
            }

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
            $empr_sn_conta = $oIfx->f('empr_sn_conta');
            
        }
    }
    $oIfx->Free();

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis  from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
        }
    }
    $oIfx->Free();

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }


    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;
    $arc_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];
    //echo $arc_img;exit;
    if (file_exists($arc_img)) {
        $imagen = $arc_img;
    } else {
        $imagen = '';
    }

    $logo = '';
    $x = '0px';
    if ($imagen != '') {

        $empr_logo = '<div align="left">
                        <img src="' . $imagen . '" style="
                        width:70px;">
                        </div>';
        $x = '0px';
    }
    else{
        $empr_logo ='<span><font color="red">SIN LOGO</font></span>';
    }


    //FORMATO DE FACTURA

    //selecciona sucursales y direcciones
    $sucursal_dir = '';
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                $sucursal_dir .= $sucu_nom_sucu;
                $sucursal_dir .= '<br>' . ($sucu_dir_sucu);
            } while ($oIfx->SiguienteRegistro());
        }
    }


    $table_fact = '<table  align="left" border="0"   style="width: 100%;  margin-top: 0px; " >';
    if ($empr_path_logo != '') {
        $table_fact .= '<tr>
                                <td align="left">' . $empr_logo . '</td>
                                <td align="right" style="color: black;" ><font size="7">
                                          '.$sucursal_dir.' <br>
                                          Contribuyente Especial #:' . $empr_num_resu . ' <br>';

                                        if($empr_conta_sn=='SI'){
                                            if($empr_sn_conta=='S'){
                                                $empr_sn_conta ='SI';
                                            }
                                            else{
                                                $empr_sn_conta ='NO';
                                            }
                                            $table_fact.='Obligado a llevar Contabilidad : ' . $empr_sn_conta . '';
                                        }

                                        
                                      
                                $table_fact.='</font></td>
                                </tr>
                                    
                                    <tr><td colspan="2"  ><hr></td></tr>';
    }
    $table_fact .= '</table>';


    //consulta consumidor final
    $sql_consu = "select clpv_cod_clpv, clpv_nom_clpv, clpv_ruc_clpv, clpv_cod_vend, clpv_pre_ven 
                from saeclpv where clv_con_clpv = '07' and clpv_clopv_clpv = 'CL' and 
			    clpv_nom_clpv like ('CONSUMID%') and clpv_cod_empr = $idEmpresa";
    $cosumidor_clpv = consulta_string($sql_consu, 'clpv_cod_clpv', $oIfxA, 0);

    $sqlFac = "select * from saencre where ncre_cod_ncre = $id and ncre_cod_sucu = $idSucursal and ncre_cod_empr = $idEmpresa ";

    $consumido_final = 0;
    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $fact_nse_fact = $oIfx->f('ncre_nse_ncre');
                $fact_num_preimp = $oIfx->f('ncre_num_preimp');
                $fact_nom_cliente = $oIfx->f('ncre_nom_cliente');
                $fact_fech_fact = ($oIfx->f('ncre_fech_fact'));
                $fact_ruc_clie = $oIfx->f('ncre_ruc_clie');
                $fact_tlf_cliente = $oIfx->f('ncre_tlf_cliente');
                $fact_dir_clie = ($oIfx->f('ncre_dir_clie'));
                $fact_email_clpv = str_replace(' ', '', $oIfx->f("ncre_email_clpv"));
                $fact_con_miva = $oIfx->f('ncre_con_miva');
                $fact_sin_miva = $oIfx->f('ncre_sin_miva');
                $fact_tot_fact = $oIfx->f('ncre_tot_fact');
                $fact_iva = $oIfx->f('ncre_iva');
                $fact_ice = $oIfx->f('ncre_ice');
                $fact_clav_sri = $oIfx->f('ncre_clav_sri');
                $fact_dsg_valo = $oIfx->f('ncre_dsg_valo');
                $ncre_cm2_ncre = $oIfx->f("ncre_cm2_ncre");
                $ncre_cm1_ncre = $oIfx->f("ncre_cm1_ncre");
                $fact_cod_clpv = $oIfx->f("ncre_cod_clpv");
                $fact_val_irbp = $oIfx->f("ncre_val_irbp");
                $ncre_cod_fact = $oIfx->f("ncre_cod_fact");


                $bandera_paciente = 0;
                $guia_ruc_clie = '';
                $guia_nom_cliente = '';

                if ($ncre_cod_fact == '') {
                    $ncre_cod_fact = 0;
                }


                $sql = "select fact_nse_fact, fact_num_preimp, fact_fech_fact,
						fact_cm2_fact
						from saefact 
						where fact_cod_empr = $idEmpresa and 
						fact_cod_fact = $ncre_cod_fact";

                $numero_fac = "";
                if ($oIfxD->Query($sql)) {
                    if ($oIfxD->NumFilas() > 0) {
                        $fact_nse_fact_in = $oIfxD->f('fact_nse_fact');
                        $fact_num_preimp_in = $oIfxD->f('fact_num_preimp');
                        $fact_fech_fact_in = fecha_mysql_func($oIfxD->f('fact_fech_fact'));
                        $fact_cm2_fact_in = $oIfxD->f('fact_cm2_fact');

                        $nse = substr($fact_nse_fact_in, 0, 3);
                        $pto = substr($fact_nse_fact_in, 3, 6);
                        $numero_fac =  $nse . '-' . $pto . '-' . $fact_num_preimp_in;
                    } else {
                        if ($ncre_cod_fact == 0) {
                            $sqlNcre = "select ncre_nse_ncre, ncre_cod_aux, ncre_fec_emfa from saencre where 
                                    ncre_cod_ncre = $id and 
                                    ncre_cod_empr = $idEmpresa and 
                                    ncre_cod_sucu = $idSucursal";
                            if ($oIfxD->Query($sqlNcre)) {
                                if ($oIfxD->NumFilas() > 0) {
                                    $fact_nse_fact_in = $oIfxD->f('ncre_nse_ncre');
                                    $numero_fac = $oIfxD->f('ncre_cod_aux');
                                    $fact_fech_fact_in = $oIfxD->f('ncre_fec_emfa');
                                }
                            }
                        }
                    }
                }
                $oIfxD->Free();

//                $date = date_create($fact_fech_fact);
//                $fact_fech_fact = date_format($date,'d/m/Y');
//
//                $cliente .= ' <tr>';
//                $cliente .= ' <b><td style="width: 10% "> NUMERO : </td></b>';
//                $cliente .= ' <td style="width: 48% ">' .$numero_fac . '</td>';
//                $cliente .= ' <b><td style="width: 13% "> FECHA : </td></b>';
//                $cliente .= ' <td style="width: 29% ">' . $fact_fech_fact . '</td>';
//                $cliente .= ' </tr>';


                $table_fact .= '<table style="width: 100%;" border="0" style="border-collapse: collapse;">';

                $table_fact .= ' <tr>
                                 <td class="fecha_letra" align="left" >R.U.C: '.$ruc_empr.'</td>
                                 <td class="fecha_letra" align="left" >NOTA CREDITO No: '.substr($fact_nse_fact, 0, 3) . '-' . substr($fact_nse_fact, 3, 6) .'-'.$fact_num_preimp.'</td>
                                 </tr>';

                $table_fact .= ' <tr>
                                 <td class="fecha_letra" align="left" >NÚMERO DE AUTORIZACIÓN:</td>
                                 <td class="fecha_letra" align="left" ></td>
                                 </tr>';
                $table_fact .='</table>';


                $table_fact .= '<table align="left" style="width: 100%; border:1px solid black; border-radius: 5px; margin-top: 20px;">';
                $table_fact .= '<tr>
                                              <td  bgcolor="black" style="width:100%"><font color="white">'.$fact_clav_sri.'</font></td>
                                         </tr>';
                $table_fact .='</table>';


                $table_fact .= '<table style="width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">';

                $table_fact .= ' <tr>
                                 <td class="fecha_letra" align="left" >AMBIENTE: '.$ambiente_sri.'</td>
                                 <td class="fecha_letra" align="left" >EMISIÓN: '.$emision_sri.'</td>
                                 </tr>';

                $table_fact .= ' <tr>
                                 <td class="fecha_letra" align="left" >FACTURA AFECTA: '.$numero_fac.'</td>
                                 <td class="fecha_letra" align="left" >FECHA FACTURA: '.$fact_fech_fact_in.'</td>
                                 </tr>';

                $table_fact .= ' <tr>
                                 <td class="fecha_letra" align="left" >CLAVE DE ACCESO:</td>
                                 <td class="fecha_letra" align="left" ></td>
                                 </tr>';
                $table_fact .='</table>';

                if ($fact_clav_sri != '') {
                    $nombArch = $fact_nse_fact . $fact_num_preimp;
                    $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';

                    new barCodeGenrator($fact_clav_sri, 1, $rutaCodi, 450, 70, true);


                    $table_fact .= '<table style="width: 100%; height: 80%; margin-top: 0px;" border="0" style="border-collapse: collapse;">';
                    $table_fact .= '<tr>
                                              <td  style="width:100%; height: 80%;"> <img src="' . $rutaCodi . '"/></td>
                                         </tr>';
                    $table_fact .='</table>';

                }


                /**
                 * INFORMACION CABECERA
                 */
                $table_fact .= '<br><br><table bgcolor="#C9C2C1" align="left" style="width: 100%; border:3px solid black; ">';
                $table_fact .='<tr>
                                           <td style="font-size:90%;" style="width:15%"><strong>Cliente:</strong></td>
                                           <td style="font-size:90%;" style="width:50%">'. ($fact_nom_cliente).'</td>
                                           <td style="font-size:90%;" style="width:12%"><strong>RUC/CI:</strong></td>
                                           <td style="font-size:90%;" style="width:23%">'.$fact_ruc_clie.'</td>
                                        </tr>';

                $table_fact .='<tr>
                                           <td><strong>Fecha Emisión:</strong></td>
                                           <td>'.$fact_fech_fact.'</td>
                                           <td></td>
                                           <td></td>
                                        </tr>';

                $table_fact .='</table>';

                $convenio_html = '';
                $paciente_html = '';
                $forma_html = '';


                $fact_dir_clie = ($fact_dir_clie);
                $adicional_info = "<strong>Información Adicional: </strong>
                 $convenio_html
                 <br>Dirección:  $fact_dir_clie
                 <br>Teléfono:  $fact_tlf_cliente
                 <br>e-mail:  $fact_email_clpv
                 $paciente_html
                 $forma_html
                 <br>Glosa:  $ncre_cm2_ncre
                 <br>Motivo:  $ncre_cm1_ncre
                 ";

            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();



    $sqlDeta = "select
dncr_cod_prod,
dncr_nom_prod,
sum(dncr_cant_dfac) as dncr_cant_dfac,
dncr_precio_dfac,
dncr_des1_dfac,
dncr_des2_dfac,
sum(dncr_mont_total) as dncr_mont_total,
dncr_por_iva
from saedncr where dncr_cod_ncre = $id and dncr_cod_sucu = $idSucursal and dncr_cod_empr = $idEmpresa
GROUP BY
dncr_cod_prod,
dncr_nom_prod,
dncr_cant_dfac,
dncr_precio_dfac,
dncr_des1_dfac,
dncr_des2_dfac,
dncr_mont_total,
dncr_por_iva";




    $deta = '<br><br> <table style="width: 100%; font-size: 8px; border-radius: 5px; border-collapse: collapse;" border="1">';
    $deta .= ' <tr  bgcolor="#C9C2C1">';
    $deta .= ' <td style="width: 15%;" align="center">Cod.</td>';
    $deta .= ' <td style="width: 10%;" align="center">Cantidad</td>';
    $deta .= ' <td style="width: 34%;" align="center">Descripción</td>';
    $deta .= ' <td style="width: 15%;" align="center">P/Unit.</td>';
    $deta .= ' <td style="width: 11%;" align="center">Descto.</td>';
    $deta .= ' <td style="width: 15%;" align="center">P/Total</td>';
    $deta .= ' </tr>';

    if ($oIfx->Query($sqlDeta)) {
        if ($oIfx->NumFilas() > 0) {

            do {
                $dfac_cod_prod = $oIfx->f('dncr_cod_prod');
                $dfac_nom_prod = $oIfx->f('dncr_nom_prod');
                $dfac_cant_dfac = $oIfx->f('dncr_cant_dfac');
                $dfac_precio_dfac = $oIfx->f('dncr_precio_dfac');
                $dfac_des1_dfac = $oIfx->f('dncr_des1_dfac');
                $dfac_des2_dfac = $oIfx->f('dncr_des2_dfac');
                $dfac_por_dsg = 0;
                $dfac_mont_total = $oIfx->f('dncr_mont_total');
                $dfac_por_iva = $oIfx->f('dncr_por_iva');

                $descuento = $dfac_des1_dfac + $dfac_des2_dfac + $dfac_por_dsg;
                if ($descuento > 0) {
                    $descuento = ($dfac_precio_dfac * $dfac_cant_dfac) - ($dfac_mont_total);
                } else {
                    $descuento = 0;
                }

                $totalDescuento = $totalDescuento + $descuento;

                $deta .= ' <tr>';
                $deta .= ' <td style="width: 15%; font-size: 6px;">' . $dfac_cod_prod . '</td>';
                $deta .= ' <td style="width: 10%; font-size: 7px;" align="right">' . number_format($dfac_cant_dfac, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 34%; font-size: 6px;">' . $dfac_nom_prod . '</td>';
                $deta .= ' <td style="width: 15%; font-size: 7px;" align="right">' . number_format($dfac_precio_dfac, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 11%; font-size: 7px;" align="right">' . round($dfac_des1_dfac, 0) . '</td>';
                $deta .= ' <td style="width: 15%; font-size: 7px;" align="right">' . number_format($dfac_mont_total, 2, '.', ',') . '</td>';
                $deta .= ' </tr>';
            } while ($oIfx->SiguienteRegistro());
        }
    }



    $deta .= ' </table>';

    $porcIva = 12;

    $totales = ' <table  bgcolor="#C9C2C1" style="font-size: 8px; border-collapse: collapse;"  border="1" align="right">';

    $totales .= ' <tr>';
    $totales .= ' <td style="width: 60%;" >SUB SIN IMPTOS:</td>';
    $totales .= ' <td style="width: 40%;" align="right">' . number_format($fact_tot_fact, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';

    $totales .= ' <td>SUBTOTAL ' . round($porcIva) . ' %:</td>';
    $totales .= ' <td align="right">' . number_format($fact_con_miva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>SUBTOTAL 0%:</td>';
    $totales .= ' <td align="right">' . number_format($fact_sin_miva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>DESCUENTO:</td>';
    $totales .= ' <td align="right">' . number_format($fact_dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>IVA ' . round($porcIva) . '%:</td>';
    $totales .= ' <td align="right">' . number_format($fact_iva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>ICE:</td>';
    $totales .= ' <td align="right">' . number_format($fact_ice, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>IRBP:</td>';
    $totales .= ' <td align="right">' . number_format($fact_val_irbp, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>TOTAL:</td>';
    $totales .= ' <td align="right">' . number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_ice + $fact_val_irbp, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' </table>';

    /**
     *
     */
    $table_fact .= $deta;

    $table_fact .= '<br><br><table border="0" style="font-size: 5px; border-collapse: collapse;">';
    $table_fact .= '<tr>
                      <td style="width: 55%;" align="left" >'.$adicional_info.'</td>
                      <td style="width: 46%;" align="right" >'.$totales.'</td>
                    </tr>';
    $table_fact .= '</table>';


    $fecha_Actual=date('Y-m-d H:i:s');
    $table_fact .= '<br><table style="font-size: 5px; width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">';
    $table_fact .= '<tr>
                          <td style="font-size:70%;" class="fecha_letra" align="left" width="100%;">
                          <p align="justify">_________________________________________________________________</p>
                           <font size="5"> '.$fact_nom_cliente.'</font><br><br><br>
                          </td>
                     </tr>';
    $table_fact .= '<tr>
                                                    <td style="font-size:70%;" class="fecha_letra" align="left" width="100%;"><p align="justify">Fecha y Hora de impresión: '.$fecha_Actual.'</p></td>
                                                </tr>';
    $table_fact .= '</table>';






    $documento = '<page backimgw="10%" backtop="10mm" backbottom="10mm" backleft="10mm" backright="10mm">';

    if(!$bandera_c){
        $documento.='<table style="width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">
<tr>
<td valign="top" style="width: 49%;">'.$table_fact.'</td>
<td valign="top" style="width: 2%;"></td>
<td valign="top" style="width: 49%;">'.$table_fact.'</td>
</tr>
</table>';
    }else{
        $documento.='<table style="width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">
<tr>
<td valign="top" style="width: 100%;">'.$table_fact.'</td>
</tr>
</table>';
    }


    $documento .= '</page>';



    return $documento;
}

function reporte_nota_credito_alterno_cre_vertical($id = '', $nombre_archivo = '', $idSucursal = '',  &$rutaPdf = '')
{
    //Definiciones
    global $DSN_Ifx;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();


    $oIfxB = new Dbo;
    $oIfxB->DSN = $DSN_Ifx;
    $oIfxB->Conectar();


    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();

    $oIfxD = new Dbo;
    $oIfxD->DSN = $DSN_Ifx;
    $oIfxD->Conectar();

    $oReturn = new xajaxResponse();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    // $idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_sn_conta, empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr
                                            from saeempr where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S') {
                $empr_conta_sn = 'SI';
            }else {
                $empr_conta_sn = 'NO';
            }

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
            $empr_sn_conta = $oIfx->f('empr_sn_conta');
        }
    }
    $oIfx->Free();

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis  from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
        }
    }
    $oIfx->Free();

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }


    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;
    $arc_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];
    //echo $arc_img;exit;
    if (file_exists($arc_img)) {
        $imagen = $arc_img;
    } else {
        $imagen = '';
    }

    $logo = '';
    $x = '0px';
    if ($imagen != '') {

        $empr_logo = '<div align="left">
                        <img src="' . $imagen . '" style="
                        width:70px;">
                        </div>';
        $x = '0px';
    }
    else{
        $empr_logo ='<span><font color="red">SIN LOGO</font></span>';
    }


    //FORMATO DE FACTURA

    //selecciona sucursales y direcciones
    $sucursal_dir = '';
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                $sucursal_dir .= $sucu_nom_sucu;
                $sucursal_dir .= '<br>' . ($sucu_dir_sucu);
            } while ($oIfx->SiguienteRegistro());
        }
    }


    $table_fact = '<table  align="left" border="0"   style="width: 100%;  margin-top: 0px; " >';
    if ($empr_path_logo != '') {
        $table_fact .= '<tr>
                                <td align="left">' . $empr_logo . '</td>
                                <td align="right" style="color: black;" ><font size="7">
                                          '.$sucursal_dir.' <br>
                                          Contribuyente Especial #:' . $empr_num_resu . ' <br>';

                                        if($empr_conta_sn=='SI'){
                                            if($empr_sn_conta=='S'){
                                                $empr_sn_conta ='SI';
                                            }
                                            else{
                                                $empr_sn_conta ='NO';
                                            }
                                            $table_fact.='Obligado a llevar Contabilidad : ' . $empr_sn_conta . '';
                                        }

                                      
                                $table_fact.='</font></td>
                                </tr>
                                    
                                    <tr><td colspan="2"  ><hr></td></tr>';
    }
    $table_fact .= '</table>';


    //consulta consumidor final
    $sql_consu = "select clpv_cod_clpv, clpv_nom_clpv, clpv_ruc_clpv, clpv_cod_vend, clpv_pre_ven 
                from saeclpv where clv_con_clpv = '07' and clpv_clopv_clpv = 'CL' and 
			    clpv_nom_clpv like ('CONSUMID%') and clpv_cod_empr = $idEmpresa";
    $cosumidor_clpv = consulta_string($sql_consu, 'clpv_cod_clpv', $oIfxA, 0);

    $sqlFac = "select * from saencre where ncre_cod_ncre = $id and ncre_cod_sucu = $idSucursal and ncre_cod_empr = $idEmpresa ";

    $consumido_final = 0;
    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $fact_nse_fact = $oIfx->f('ncre_nse_ncre');
                $fact_num_preimp = $oIfx->f('ncre_num_preimp');
                $fact_nom_cliente = $oIfx->f('ncre_nom_cliente');
                $fact_fech_fact = ($oIfx->f('ncre_fech_fact'));
                $fact_ruc_clie = $oIfx->f('ncre_ruc_clie');
                $fact_tlf_cliente = $oIfx->f('ncre_tlf_cliente');
                $fact_dir_clie = ($oIfx->f('ncre_dir_clie'));
                $fact_email_clpv = str_replace(' ', '', $oIfx->f("ncre_email_clpv"));
                $fact_con_miva = $oIfx->f('ncre_con_miva');
                $fact_sin_miva = $oIfx->f('ncre_sin_miva');
                $fact_tot_fact = $oIfx->f('ncre_tot_fact');
                $fact_iva = $oIfx->f('ncre_iva');
                $fact_ice = $oIfx->f('ncre_ice');
                $fact_clav_sri = $oIfx->f('ncre_clav_sri');
                $fact_dsg_valo = $oIfx->f('ncre_dsg_valo');
                $ncre_cm2_ncre = $oIfx->f("ncre_cm2_ncre");
                $ncre_cm1_ncre = $oIfx->f("ncre_cm1_ncre");
                $fact_cod_clpv = $oIfx->f("ncre_cod_clpv");
                $fact_val_irbp = $oIfx->f("ncre_val_irbp");
                $ncre_cod_fact = $oIfx->f("ncre_cod_fact");


                $bandera_paciente = 0;
                $guia_ruc_clie = '';
                $guia_nom_cliente = '';

                if ($ncre_cod_fact == '') {
                    $ncre_cod_fact = 0;
                }


                $sql = "select fact_nse_fact, fact_num_preimp, fact_fech_fact,
						fact_cm2_fact
						from saefact 
						where fact_cod_empr = $idEmpresa and 
						fact_cod_fact = $ncre_cod_fact";

                $numero_fac = "";
                if ($oIfxD->Query($sql)) {
                    if ($oIfxD->NumFilas() > 0) {
                        $fact_nse_fact_in = $oIfxD->f('fact_nse_fact');
                        $fact_num_preimp_in = $oIfxD->f('fact_num_preimp');
                        $fact_fech_fact_in = fecha_mysql_func($oIfxD->f('fact_fech_fact'));
                        $fact_cm2_fact_in = $oIfxD->f('fact_cm2_fact');

                        $nse = substr($fact_nse_fact_in, 0, 3);
                        $pto = substr($fact_nse_fact_in, 3, 6);
                        $numero_fac =  $nse . '-' . $pto . '-' . $fact_num_preimp_in;
                    } else {
                        if ($ncre_cod_fact == 0) {
                            $sqlNcre = "select ncre_nse_ncre, ncre_cod_aux, ncre_fec_emfa from saencre where 
                                    ncre_cod_ncre = $id and 
                                    ncre_cod_empr = $idEmpresa and 
                                    ncre_cod_sucu = $idSucursal";
                            if ($oIfxD->Query($sqlNcre)) {
                                if ($oIfxD->NumFilas() > 0) {
                                    $fact_nse_fact_in = $oIfxD->f('ncre_nse_ncre');
                                    $numero_fac = $oIfxD->f('ncre_cod_aux');
                                    $fact_fech_fact_in = $oIfxD->f('ncre_fec_emfa');
                                }
                            }
                        }
                    }
                }
                $oIfxD->Free();

//                $date = date_create($fact_fech_fact);
//                $fact_fech_fact = date_format($date,'d/m/Y');
//
//                $cliente .= ' <tr>';
//                $cliente .= ' <b><td style="width: 10% "> NUMERO : </td></b>';
//                $cliente .= ' <td style="width: 48% ">' .$numero_fac . '</td>';
//                $cliente .= ' <b><td style="width: 13% "> FECHA : </td></b>';
//                $cliente .= ' <td style="width: 29% ">' . $fact_fech_fact . '</td>';
//                $cliente .= ' </tr>';


                $table_fact .= '<table style="width: 100%;" border="0" style="border-collapse: collapse;">';

                $table_fact .= ' <tr>
                                 <td class="fecha_letra" align="left" >R.U.C: '.$ruc_empr.'</td>
                                 <td class="fecha_letra" align="left" >NOTA CREDITO No: '.substr($fact_nse_fact, 0, 3) . '-' . substr($fact_nse_fact, 3, 6) .'-'.$fact_num_preimp.'</td>
                                 </tr>';

                $table_fact .= ' <tr>
                                 <td class="fecha_letra" align="left" >NÚMERO DE AUTORIZACIÓN:</td>
                                 <td class="fecha_letra" align="left" ></td>
                                 </tr>';
                $table_fact .='</table>';


                $table_fact .= '<table align="left" style="width: 100%; border:1px solid black; border-radius: 5px; margin-top: 20px;">';
                $table_fact .= '<tr>
                                              <td  bgcolor="black" style="width:100%"><font color="white">'.$fact_clav_sri.'</font></td>
                                         </tr>';
                $table_fact .='</table>';


                $table_fact .= '<table style="width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">';

                $table_fact .= ' <tr>
                                 <td class="fecha_letra" align="left" >AMBIENTE: '.$ambiente_sri.'</td>
                                 <td class="fecha_letra" align="left" >EMISIÓN: '.$emision_sri.'</td>
                                 </tr>';

                $table_fact .= ' <tr>
                                 <td class="fecha_letra" align="left" >FACTURA AFECTA: '.$numero_fac.'</td>
                                 <td class="fecha_letra" align="left" >FECHA FACTURA: '.$fact_fech_fact_in.'</td>
                                 </tr>';

                $table_fact .= ' <tr>
                                 <td class="fecha_letra" align="left" >CLAVE DE ACCESO:</td>
                                 <td class="fecha_letra" align="left" ></td>
                                 </tr>';
                $table_fact .='</table>';

                if ($fact_clav_sri != '') {
                    $nombArch = $fact_nse_fact . $fact_num_preimp;
                    $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';

                    new barCodeGenrator($fact_clav_sri, 1, $rutaCodi, 450, 70, true);


                    $table_fact .= '<table style="width: 100%; height: 80%; margin-top: 0px;" border="0" style="border-collapse: collapse;">';
                    $table_fact .= '<tr>
                                              <td  style="width:100%; height: 80%;"> <img src="' . $rutaCodi . '"/></td>
                                         </tr>';
                    $table_fact .='</table>';

                }


                /**
                 * INFORMACION CABECERA
                 */
                $table_fact .= '<br><br><table bgcolor="#C9C2C1" align="left" style="width: 100%; border:3px solid black; ">';
                $table_fact .='<tr>
                                           <td style="font-size:90%;" style="width:15%"><strong>Cliente:</strong></td>
                                           <td style="font-size:90%;" style="width:50%">'. ($fact_nom_cliente).'</td>
                                           <td style="font-size:90%;" style="width:12%"><strong>RUC/CI:</strong></td>
                                           <td style="font-size:90%;" style="width:23%">'.$fact_ruc_clie.'</td>
                                        </tr>';

                $table_fact .='<tr>
                                           <td><strong>Fecha Emisión:</strong></td>
                                           <td>'.$fact_fech_fact.'</td>
                                           <td></td>
                                           <td></td>
                                        </tr>';

                $table_fact .='</table>';

                $convenio_html = '';
                $paciente_html = '';
                $forma_html = '';


                $fact_dir_clie = ($fact_dir_clie);
                $adicional_info = "<strong>Información Adicional: </strong>
                 $convenio_html
                 <br>Dirección:  $fact_dir_clie
                 <br>Teléfono:  $fact_tlf_cliente
                 <br>e-mail:  $fact_email_clpv
                 $paciente_html
                 $forma_html
                 <br>Glosa:  $ncre_cm2_ncre
                 <br>Motivo:  $ncre_cm1_ncre
                 ";

            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();



    $sqlDeta = "select
dncr_cod_prod,
dncr_nom_prod,
sum(dncr_cant_dfac) as dncr_cant_dfac,
dncr_precio_dfac,
dncr_des1_dfac,
dncr_des2_dfac,
sum(dncr_mont_total) as dncr_mont_total,
dncr_por_iva
from saedncr where dncr_cod_ncre = $id and dncr_cod_sucu = $idSucursal and dncr_cod_empr = $idEmpresa
GROUP BY
dncr_cod_prod,
dncr_nom_prod,
dncr_cant_dfac,
dncr_precio_dfac,
dncr_des1_dfac,
dncr_des2_dfac,
dncr_mont_total,
dncr_por_iva";




    $deta = '<br><br> <table style="width: 100%; font-size: 8px; border-radius: 5px; border-collapse: collapse;" border="1">';
    $deta .= ' <tr  bgcolor="#C9C2C1">';
    $deta .= ' <td style="width: 15%;" align="center">Cod.</td>';
    $deta .= ' <td style="width: 10%;" align="center">Cantidad</td>';
    $deta .= ' <td style="width: 34%;" align="center">Descripción</td>';
    $deta .= ' <td style="width: 15%;" align="center">P/Unit.</td>';
    $deta .= ' <td style="width: 11%;" align="center">Descto.</td>';
    $deta .= ' <td style="width: 15%;" align="center">P/Total</td>';
    $deta .= ' </tr>';

    if ($oIfx->Query($sqlDeta)) {
        if ($oIfx->NumFilas() > 0) {

            do {
                $dfac_cod_prod = $oIfx->f('dncr_cod_prod');
                $dfac_nom_prod = $oIfx->f('dncr_nom_prod');
                $dfac_cant_dfac = $oIfx->f('dncr_cant_dfac');
                $dfac_precio_dfac = $oIfx->f('dncr_precio_dfac');
                $dfac_des1_dfac = $oIfx->f('dncr_des1_dfac');
                $dfac_des2_dfac = $oIfx->f('dncr_des2_dfac');
                $dfac_por_dsg = 0;
                $dfac_mont_total = $oIfx->f('dncr_mont_total');
                $dfac_por_iva = $oIfx->f('dncr_por_iva');

                $descuento = $dfac_des1_dfac + $dfac_des2_dfac + $dfac_por_dsg;
                if ($descuento > 0) {
                    $descuento = ($dfac_precio_dfac * $dfac_cant_dfac) - ($dfac_mont_total);
                } else {
                    $descuento = 0;
                }

                $totalDescuento = $totalDescuento + $descuento;

                $deta .= ' <tr>';
                $deta .= ' <td style="width: 15%; font-size: 6px;">' . $dfac_cod_prod . '</td>';
                $deta .= ' <td style="width: 10%; font-size: 7px;" align="right">' . number_format($dfac_cant_dfac, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 34%; font-size: 6px;">' . $dfac_nom_prod . '</td>';
                $deta .= ' <td style="width: 15%; font-size: 7px;" align="right">' . number_format($dfac_precio_dfac, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 11%; font-size: 7px;" align="right">' . round($dfac_des1_dfac, 0) . '</td>';
                $deta .= ' <td style="width: 15%; font-size: 7px;" align="right">' . number_format($dfac_mont_total, 2, '.', ',') . '</td>';
                $deta .= ' </tr>';
            } while ($oIfx->SiguienteRegistro());
        }
    }



    $deta .= ' </table>';

    $porcIva = 12;

    $totales = ' <table  bgcolor="#C9C2C1" style="font-size: 8px;"  border="1" align="right">';

    $totales .= ' <tr>';
    $totales .= ' <td style="width: 60%;" >SUB SIN IMPTOS:</td>';
    $totales .= ' <td style="width: 40%;" align="right">' . number_format($fact_tot_fact, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';

    $totales .= ' <td>SUBTOTAL ' . round($porcIva) . ' %:</td>';
    $totales .= ' <td align="right">' . number_format($fact_con_miva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>SUBTOTAL 0%:</td>';
    $totales .= ' <td align="right">' . number_format($fact_sin_miva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>DESCUENTO:</td>';
    $totales .= ' <td align="right">' . number_format($fact_dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>IVA ' . round($porcIva) . '%:</td>';
    $totales .= ' <td align="right">' . number_format($fact_iva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>ICE:</td>';
    $totales .= ' <td align="right">' . number_format($fact_ice, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>IRBP:</td>';
    $totales .= ' <td align="right">' . number_format($fact_val_irbp, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>TOTAL:</td>';
    $totales .= ' <td align="right">' . number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_ice + $fact_val_irbp, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' </table>';

    /**
     *
     */
    $table_fact .= $deta;

    $table_fact .= '<br><br><table border="0" style="font-size: 10px; border-collapse: collapse;">';
    $table_fact .= '<tr>
                      <td style="width: 55%; font-size:70%;" align="left" >'.$adicional_info.'</td>
                      <td style="width: 46%; font-size:70%;" align="right" >'.$totales.'</td>
                    </tr>';
    $table_fact .= '</table>';


    $fecha_Actual=date('Y-m-d H:i:s');
    $table_fact .= '<br><table style="font-size: 5px; width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">';
    $table_fact .= '<tr>
                          <td style="font-size:70%;" class="fecha_letra" align="left" width="100%;">
                          <p align="justify">_________________________________________________________________</p>
                           <font size="5"> '.$fact_nom_cliente.'</font><br><br><br>
                          </td>
                     </tr>';
    $table_fact .= '<tr>
                                                    <td style="font-size:70%;" class="fecha_letra" align="left" width="100%;"><p align="justify">Fecha y Hora de impresión: '.$fecha_Actual.'</p></td>
                                                </tr>';
    $table_fact .= '</table>';






    $documento = '<page backimgw="10%" backtop="10mm" backbottom="10mm" backleft="10mm" backright="10mm">';
    $documento.='<table style="width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">
<tr>
<td valign="top" style="width: 100%;">'.$table_fact.'</td>
</tr>
</table>';

    $documento .= '</page>';


    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $rutaPdf = $ruta;

    return $documento;
}

function reporte_nota_credito_alterno_cre_vertical_sri($id = '', $nombre_archivo = '', $idSucursal = '',  &$rutaPdf = '')
{
    //Definiciones
    global $DSN_Ifx;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();


    $oIfxB = new Dbo;
    $oIfxB->DSN = $DSN_Ifx;
    $oIfxB->Conectar();


    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();

    $oIfxD = new Dbo;
    $oIfxD->DSN = $DSN_Ifx;
    $oIfxD->Conectar();

    $oReturn = new xajaxResponse();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    // $idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_sn_conta, empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr
                                            from saeempr where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S') {
                $empr_conta_sn = 'SI';
            }else {
                $empr_conta_sn = 'NO';
            }

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
            $empr_sn_conta = $oIfx->f('empr_sn_conta');
        }
    }
    $oIfx->Free();

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis  from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
        }
    }
    $oIfx->Free();

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }


    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;
    $arc_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];
    //echo $arc_img;exit;
    if (file_exists($arc_img)) {
        $imagen = $arc_img;
    } else {
        $imagen = '';
    }

    $logo = '';
    $x = '0px';
    if ($imagen != '') {

        $empr_logo = '<div align="left">
                        <img src="' . $imagen . '" style="
                        width:70px;">
                        </div>';
        $x = '0px';
    }
    else{
        $empr_logo ='<span><font color="red">SIN LOGO</font></span>';
    }


    //FORMATO DE FACTURA

    //selecciona sucursales y direcciones
    $sucursal_dir = '';
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                $sucursal_dir .= $sucu_nom_sucu;
                $sucursal_dir .= '<br>' . ($sucu_dir_sucu);
            } while ($oIfx->SiguienteRegistro());
        }
    }


    $table_fact = '<table  align="left" border="0"   style="width: 100%;  margin-top: 0px; " >';
    if ($empr_path_logo != '') {
        $table_fact .= '<tr>
                                <td align="left">' . $empr_logo . '</td>
                                <td align="right" style="color: black;" ><font size="7">
                                          '.$sucursal_dir.' <br>
                                          Contribuyente Especial #:' . $empr_num_resu . ' <br>';
                                          if($empr_conta_sn=='SI'){
                                            if($empr_sn_conta=='S'){
                                                $empr_sn_conta ='SI';
                                            }
                                            else{
                                                $empr_sn_conta ='NO';
                                            }
                                            $table_fact.='Obligado a llevar Contabilidad : ' . $empr_sn_conta . '';
                                        }

                                      
                                $table_fact.='</font></td>
                                </tr>
                                    
                                    <tr><td colspan="2"  ><hr></td></tr>';
    }
    $table_fact .= '</table>';


    //consulta consumidor final
    $sql_consu = "select clpv_cod_clpv, clpv_nom_clpv, clpv_ruc_clpv, clpv_cod_vend, clpv_pre_ven 
                from saeclpv where clv_con_clpv = '07' and clpv_clopv_clpv = 'CL' and 
			    clpv_nom_clpv like ('CONSUMID%') and clpv_cod_empr = $idEmpresa";
    $cosumidor_clpv = consulta_string($sql_consu, 'clpv_cod_clpv', $oIfxA, 0);

    $sqlFac = "select * from saencre where ncre_cod_ncre = $id and ncre_cod_sucu = $idSucursal and ncre_cod_empr = $idEmpresa ";

    $consumido_final = 0;
    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $fact_nse_fact = $oIfx->f('ncre_nse_ncre');
                $fact_num_preimp = $oIfx->f('ncre_num_preimp');
                $fact_nom_cliente = $oIfx->f('ncre_nom_cliente');
                $fact_fech_fact = ($oIfx->f('ncre_fech_fact'));
                $fact_ruc_clie = $oIfx->f('ncre_ruc_clie');
                $fact_tlf_cliente = $oIfx->f('ncre_tlf_cliente');
                $fact_dir_clie = ($oIfx->f('ncre_dir_clie'));
                $fact_email_clpv = str_replace(' ', '', $oIfx->f("ncre_email_clpv"));
                $fact_con_miva = $oIfx->f('ncre_con_miva');
                $fact_sin_miva = $oIfx->f('ncre_sin_miva');
                $fact_tot_fact = $oIfx->f('ncre_tot_fact');
                $fact_iva = $oIfx->f('ncre_iva');
                $fact_ice = $oIfx->f('ncre_ice');
                $fact_clav_sri = $oIfx->f('ncre_clav_sri');
                $fact_dsg_valo = $oIfx->f('ncre_dsg_valo');
                $ncre_cm2_ncre = $oIfx->f("ncre_cm2_ncre");
                $ncre_cm1_ncre = $oIfx->f("ncre_cm1_ncre");
                $fact_cod_clpv = $oIfx->f("ncre_cod_clpv");
                $fact_val_irbp = $oIfx->f("ncre_val_irbp");
                $ncre_cod_fact = $oIfx->f("ncre_cod_fact");


                $bandera_paciente = 0;
                $guia_ruc_clie = '';
                $guia_nom_cliente = '';

                if ($ncre_cod_fact == '') {
                    $ncre_cod_fact = 0;
                }


                $sql = "select fact_nse_fact, fact_num_preimp, fact_fech_fact,
						fact_cm2_fact
						from saefact 
						where fact_cod_empr = $idEmpresa and 
						fact_cod_fact = $ncre_cod_fact";

                $numero_fac = "";
                if ($oIfxD->Query($sql)) {
                    if ($oIfxD->NumFilas() > 0) {
                        $fact_nse_fact_in = $oIfxD->f('fact_nse_fact');
                        $fact_num_preimp_in = $oIfxD->f('fact_num_preimp');
                        $fact_fech_fact_in = fecha_mysql_func($oIfxD->f('fact_fech_fact'));
                        $fact_cm2_fact_in = $oIfxD->f('fact_cm2_fact');

                        $nse = substr($fact_nse_fact_in, 0, 3);
                        $pto = substr($fact_nse_fact_in, 3, 6);
                        $numero_fac =  $nse . '-' . $pto . '-' . $fact_num_preimp_in;
                    } else {
                        if ($ncre_cod_fact == 0) {
                            $sqlNcre = "select ncre_nse_ncre, ncre_cod_aux, ncre_fec_emfa from saencre where 
                                    ncre_cod_ncre = $id and 
                                    ncre_cod_empr = $idEmpresa and 
                                    ncre_cod_sucu = $idSucursal";
                            if ($oIfxD->Query($sqlNcre)) {
                                if ($oIfxD->NumFilas() > 0) {
                                    $fact_nse_fact_in = $oIfxD->f('ncre_nse_ncre');
                                    $numero_fac = $oIfxD->f('ncre_cod_aux');
                                    $fact_fech_fact_in = $oIfxD->f('ncre_fec_emfa');
                                }
                            }
                        }
                    }
                }
                $oIfxD->Free();

//                $date = date_create($fact_fech_fact);
//                $fact_fech_fact = date_format($date,'d/m/Y');
//
//                $cliente .= ' <tr>';
//                $cliente .= ' <b><td style="width: 10% "> NUMERO : </td></b>';
//                $cliente .= ' <td style="width: 48% ">' .$numero_fac . '</td>';
//                $cliente .= ' <b><td style="width: 13% "> FECHA : </td></b>';
//                $cliente .= ' <td style="width: 29% ">' . $fact_fech_fact . '</td>';
//                $cliente .= ' </tr>';


                $table_fact .= '<table style="width: 100%;" border="0" style="border-collapse: collapse;">';

                $table_fact .= ' <tr>
                                 <td class="fecha_letra" align="left" >R.U.C: '.$ruc_empr.'</td>
                                 <td class="fecha_letra" align="left" >NOTA CREDITO No: '.substr($fact_nse_fact, 0, 3) . '-' . substr($fact_nse_fact, 3, 6) .'-'.$fact_num_preimp.'</td>
                                 </tr>';

                $table_fact .= ' <tr>
                                 <td class="fecha_letra" align="left" >NÚMERO DE AUTORIZACIÓN:</td>
                                 <td class="fecha_letra" align="left" ></td>
                                 </tr>';
                $table_fact .='</table>';


                $table_fact .= '<table align="left" style="width: 100%; border:1px solid black; border-radius: 5px; margin-top: 20px;">';
                $table_fact .= '<tr>
                                              <td  bgcolor="black" style="width:100%"><font color="white">'.$fact_clav_sri.'</font></td>
                                         </tr>';
                $table_fact .='</table>';


                $table_fact .= '<table style="width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">';

                $table_fact .= ' <tr>
                                 <td class="fecha_letra" align="left" >AMBIENTE: '.$ambiente_sri.'</td>
                                 <td class="fecha_letra" align="left" >EMISIÓN: '.$emision_sri.'</td>
                                 </tr>';

                $table_fact .= ' <tr>
                                 <td class="fecha_letra" align="left" >FACTURA AFECTA: '.$numero_fac.'</td>
                                 <td class="fecha_letra" align="left" >FECHA FACTURA: '.$fact_fech_fact_in.'</td>
                                 </tr>';

                $table_fact .= ' <tr>
                                 <td class="fecha_letra" align="left" >CLAVE DE ACCESO:</td>
                                 <td class="fecha_letra" align="left" ></td>
                                 </tr>';
                $table_fact .='</table>';

                if ($fact_clav_sri != '') {
                    $nombArch = $fact_nse_fact . $fact_num_preimp;
                    $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';

                    new barCodeGenrator($fact_clav_sri, 1, $rutaCodi, 450, 70, true);


                    $table_fact .= '<table style="width: 100%; height: 80%; margin-top: 0px;" border="0" style="border-collapse: collapse;">';
                    $table_fact .= '<tr>
                                              <td  style="width:100%; height: 80%;"> <img src="' . $rutaCodi . '"/></td>
                                         </tr>';
                    $table_fact .='</table>';

                }


                /**
                 * INFORMACION CABECERA
                 */
                $table_fact .= '<br><br><table bgcolor="#C9C2C1" align="left" style="width: 100%; border:3px solid black; ">';
                $table_fact .='<tr>
                                           <td style="font-size:90%;" style="width:15%"><strong>Cliente:</strong></td>
                                           <td style="font-size:90%;" style="width:50%">'. ($fact_nom_cliente).'</td>
                                           <td style="font-size:90%;" style="width:12%"><strong>RUC/CI:</strong></td>
                                           <td style="font-size:90%;" style="width:23%">'.$fact_ruc_clie.'</td>
                                        </tr>';

                $table_fact .='<tr>
                                           <td><strong>Fecha Emisión:</strong></td>
                                           <td>'.$fact_fech_fact.'</td>
                                           <td></td>
                                           <td></td>
                                        </tr>';

                $table_fact .='</table>';

                $convenio_html = '';
                $paciente_html = '';
                $forma_html = '';


                $fact_dir_clie = ($fact_dir_clie);
                $adicional_info = "<strong>Información Adicional: </strong>
                 $convenio_html
                 <br>Dirección:  $fact_dir_clie
                 <br>Teléfono:  $fact_tlf_cliente
                 <br>e-mail:  $fact_email_clpv
                 $paciente_html
                 $forma_html
                 <br>Glosa:  $ncre_cm2_ncre
                 <br>Motivo:  $ncre_cm1_ncre
                 ";

            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();



    $sqlDeta = "select
dncr_cod_prod,
dncr_nom_prod,
sum(dncr_cant_dfac) as dncr_cant_dfac,
dncr_precio_dfac,
dncr_des1_dfac,
dncr_des2_dfac,
sum(dncr_mont_total) as dncr_mont_total,
dncr_por_iva
from saedncr where dncr_cod_ncre = $id and dncr_cod_sucu = $idSucursal and dncr_cod_empr = $idEmpresa
GROUP BY
dncr_cod_prod,
dncr_nom_prod,
dncr_cant_dfac,
dncr_precio_dfac,
dncr_des1_dfac,
dncr_des2_dfac,
dncr_mont_total,
dncr_por_iva";




    $deta = '<br><br> <table style="width: 100%; font-size: 18px;" border="1" cellpadding="2">';
    $deta .= ' <tr  bgcolor="#C9C2C1">';
    $deta .= ' <td style="width: 15%;" align="center">Cod.</td>';
    $deta .= ' <td style="width: 10%;" align="center">Cantidad</td>';
    $deta .= ' <td style="width: 34%;" align="center">Descripción</td>';
    $deta .= ' <td style="width: 15%;" align="center">P/Unit.</td>';
    $deta .= ' <td style="width: 11%;" align="center">Descto.</td>';
    $deta .= ' <td style="width: 15%;" align="center">P/Total</td>';
    $deta .= ' </tr>';

    if ($oIfx->Query($sqlDeta)) {
        if ($oIfx->NumFilas() > 0) {

            do {
                $dfac_cod_prod = $oIfx->f('dncr_cod_prod');
                $dfac_nom_prod = $oIfx->f('dncr_nom_prod');
                $dfac_cant_dfac = $oIfx->f('dncr_cant_dfac');
                $dfac_precio_dfac = $oIfx->f('dncr_precio_dfac');
                $dfac_des1_dfac = $oIfx->f('dncr_des1_dfac');
                $dfac_des2_dfac = $oIfx->f('dncr_des2_dfac');
                $dfac_por_dsg = 0;
                $dfac_mont_total = $oIfx->f('dncr_mont_total');
                $dfac_por_iva = $oIfx->f('dncr_por_iva');

                $descuento = $dfac_des1_dfac + $dfac_des2_dfac + $dfac_por_dsg;
                if ($descuento > 0) {
                    $descuento = ($dfac_precio_dfac * $dfac_cant_dfac) - ($dfac_mont_total);
                } else {
                    $descuento = 0;
                }

                $totalDescuento = $totalDescuento + $descuento;

                $deta .= ' <tr>';
                $deta .= ' <td style="width: 15%; font-size: 17px;">' . $dfac_cod_prod . '</td>';
                $deta .= ' <td style="width: 10%; font-size: 18px;" align="right">' . number_format($dfac_cant_dfac, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 34%; font-size: 17px;">' . $dfac_nom_prod . '</td>';
                $deta .= ' <td style="width: 15%; font-size: 18px;" align="right">' . number_format($dfac_precio_dfac, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 11%; font-size: 18px;" align="right">' . round($dfac_des1_dfac, 0) . '</td>';
                $deta .= ' <td style="width: 15%; font-size: 18px;" align="right">' . number_format($dfac_mont_total, 2, '.', ',') . '</td>';
                $deta .= ' </tr>';
            } while ($oIfx->SiguienteRegistro());
        }
    }



    $deta .= ' </table>';

    $porcIva = 12;

    $totales = ' <table  bgcolor="#C9C2C1" style="font-size: 17px;"  border="1" align="right" cellpadding="2">';

    $totales .= ' <tr>';
    $totales .= ' <td style="width: 60%;" >SUB SIN IMPTOS:</td>';
    $totales .= ' <td style="width: 40%;" align="right">' . number_format($fact_tot_fact, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';

    $totales .= ' <td>SUBTOTAL ' . round($porcIva) . ' %:</td>';
    $totales .= ' <td align="right">' . number_format($fact_con_miva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>SUBTOTAL 0%:</td>';
    $totales .= ' <td align="right">' . number_format($fact_sin_miva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>DESCUENTO:</td>';
    $totales .= ' <td align="right">' . number_format($fact_dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>IVA ' . round($porcIva) . '%:</td>';
    $totales .= ' <td align="right">' . number_format($fact_iva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>ICE:</td>';
    $totales .= ' <td align="right">' . number_format($fact_ice, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>IRBP:</td>';
    $totales .= ' <td align="right">' . number_format($fact_val_irbp, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>TOTAL:</td>';
    $totales .= ' <td align="right">' . number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_ice + $fact_val_irbp, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' </table>';

    /**
     *
     */
    $table_fact .= $deta;

    $table_fact .= '<br><br><table border="0" style="font-size: 10px; border-collapse: collapse;">';
    $table_fact .= '<tr>
                      <td style="width: 55%; font-size: 18px;" align="left" >'.$adicional_info.'</td>
                      <td style="width: 46%; font-size:70%;" align="right" >'.$totales.'</td>
                    </tr>';
    $table_fact .= '</table>';


    $fecha_Actual=date('Y-m-d H:i:s');
    $table_fact .= '<br><table style="font-size: 5px; width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">';
    $table_fact .= '<tr>
                          <td style="font-size:70%;" class="fecha_letra" align="left" width="100%;">
                          <p align="justify">_________________________________________________________________</p>
                           <font size="5"> '.$fact_nom_cliente.'</font><br><br><br>
                          </td>
                     </tr>';
    $table_fact .= '<tr>
                                                    <td style="font-size:70%;" class="fecha_letra" align="left" width="100%;"><p align="justify">Fecha y Hora de impresión: '.$fecha_Actual.'</p></td>
                                                </tr>';
    $table_fact .= '</table>';






    $documento = '<page backimgw="10%" backtop="10mm" backbottom="10mm" backleft="10mm" backright="10mm">';
    $documento.='<table style="width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">
<tr>
<td valign="top" style="width: 100%;">'.$table_fact.'</td>
</tr>
</table>';

    $documento .= '</page>';


    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $rutaPdf = $ruta;

    /**GUARDADO ARCHIVO **/

    $pdf = new TCPDF('P', 'mm', 'A4', true, 'UTF-8', false);
    $pdf->setPrintHeader(false);
    $pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);
    //$pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);
    $pdf->SetMargins(10,10, 10, true);
    // set auto page breaks
    $pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);
    // set image scale factor
    $pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);
    // set font
    $pdf->SetFont('helvetica', 'N', 8);
    // add a page
    $pdf->AddPage();

    $pdf->writeHTMLCell(0, 0, '', '',$documento, 0, 1, 0, true, '', true);

    $pdf->Output($ruta,'F');


    return $documento;
}

function reporte_factura_alterno_cre_preimpreso_old($id = '', $nombre_archivo = '', $idSucursal = '', $bandera_c = 0)
{
    //Definiciones
    global $DSN_Ifx;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();


    $oIfxB = new Dbo;
    $oIfxB->DSN = $DSN_Ifx;
    $oIfxB->Conectar();


    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();

    $oIfxD = new Dbo;
    $oIfxD->DSN = $DSN_Ifx;
    $oIfxD->Conectar();

    $oReturn = new xajaxResponse();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    // $idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr
                                            from saeempr where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S') {
                $empr_conta_sn = 'SI';
            }else {
                $empr_conta_sn = 'NO';
            }

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
        }
    }
    $oIfx->Free();


    $arc_img = DIR_FACTELEC . 'Include/cre_logo.png';
    //echo $arc_img;exit;
    if (file_exists($arc_img)) {
        $imagen = $arc_img;
    } else {
        $imagen = '';
    }

    $logo = '';
    $x = '0px';
    if ($imagen != '') {

        $empr_logo = '<img src="' . $imagen . '" width="70" height="70">';
        $x = '0px';
    }
    else{
        $empr_logo ='<span><font color="red">SIN LOGO</font></span>';
    }


    //FORMATO DE FACTURA

    $sqlFac = "select * from saefact where fact_cod_fact = $id and fact_cod_sucu = $idSucursal and fact_cod_empr = $idEmpresa ";
    $table_fact = '';
    $consumido_final = 0;
    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $fact_nse_fact = $oIfx->f('fact_nse_fact');
                $fact_num_preimp = $oIfx->f('fact_num_preimp');
                $fact_nom_cliente = $oIfx->f('fact_nom_cliente');
                $fact_fech_fact = ($oIfx->f('fact_fech_fact'));
                $fact_ruc_clie = $oIfx->f('fact_ruc_clie');
                $fact_tlf_cliente = $oIfx->f('fact_tlf_cliente');
                $fact_dir_clie = ($oIfx->f('fact_dir_clie'));
                $fact_email_clpv = str_replace(' ', '', $oIfx->f("fact_email_clpv"));
                $fact_con_miva = $oIfx->f('fact_con_miva');
                $fact_sin_miva = $oIfx->f('fact_sin_miva');
                $fact_tot_fact = $oIfx->f('fact_tot_fact');
                $fact_iva = $oIfx->f('fact_iva');
                $fact_ice = $oIfx->f('fact_ice');
                $fact_clav_sri = $oIfx->f('fact_clav_sri');
                $fact_dsg_valo = $oIfx->f('fact_dsg_valo');
                $fact_cm1_fact = $oIfx->f("fact_cm1_fact");
                $fact_cm2_fact = $oIfx->f("fact_cm2_fact");
                $fact_cm4_fact = $oIfx->f("fact_cm4_fact");
                $orden_compra = $oIfx->f("fact_opc_fact");
                $fact_cod_clpv = $oIfx->f("fact_cod_clpv");
                $fact_cod_ccli = $oIfx->f("fact_cod_ccli");
                $fact_dia_plazo = $oIfx->f("fact_dia_fact");
                $fact_val_irbp = $oIfx->f("fact_val_irbp");
                $fact_tipo_convenio = $oIfx->f("fact_tipo_convenio");
                $fact_cod_guia = $oIfx->f("fact_cod_guia");
                $fact_fle_fact = $oIfx->f('fact_fle_fact');
                $fact_otr_fact = $oIfx->f('fact_otr_fact');



                /**
                 * INFORMACION CABECERA
                 */

                $table_fact .= '<table  align="left" border="0"   style="width: 100%;  margin-top: 0px; " >';
                if ($empr_path_logo != '') {
                    $table_fact .= '<tr>
                                <td align="left" style="width: 5%; ">' . $empr_logo . '</td>
                                <td align="left" style="width: 45%; ">
                                   <font size="16"><b>'.$razonSocial.' </b></font> <br>
                                   <font size="10">  RUC: '.$ruc_empr.' </font>
                                </td>
                                <td align="left" style="width: 30%;">
                                   <font size="14"><b> FACTURA &nbsp;&nbsp;&nbsp;&nbsp; '.substr($fact_nse_fact, 0, 3) . '-' . substr($fact_nse_fact, 3, 6).' </b></font><br>
                                   <font size="10"><b> Autorización S.R.I &nbsp; '.$fact_clav_sri.'</b></font>
                                </td>
                                <td align="left" style="width: 20%; color:red;">
                                   <font size="15"><b> Nº  '.$fact_num_preimp.' </b></font>
                                </td>
                        </tr>';
                }

                $table_fact .= '<tr>
                                <td align="left" style="width: 50%; ">
                                   <font size="9"><b>Matriz: </b>El Dorado * Antonio Elizalde y Av Gran Colombia, esquina</font> <br>
                                   <font size="9"><b>Telfs: </b>2582480 <b>* Fax: </b> (593-2) 2570424  * Quito - Ecuador </font>
                                </td>
                                <td align="left" style="width: 50%;">
                                   <font size="9"><b> '.$razonSocial.'</b></font> <br>
                                   <font size="7"><b> CONTRIBUYENTE ESPECIAL SEGUN RESOLUCION Nº 636 DEL 29-12-2005</b></font> <br>
                                   <font size="7"><b> "AGENTE DE RETENCIÓN No. de Resolución 636"</b></font> 
                                </td>
                        </tr>';
                $table_fact .= '</table>';

                $table_fact .= '<br><br><table style="width: 100%; border:1px solid black; font-size: 9px;"  cellpadding="1" cellspacing="2" >';
                $table_fact .='<tr>
                                   <td style="width:10%;"><b>SEÑOR (ES):</b></td>
                                   <td style="width:40%; text-align: left">'. ($fact_nom_cliente).'</td>
                                   <td style="width:50%;" colspan="2"></td>
                               </tr>';
                $table_fact .='<tr>
                                   <td style="width:10%;"><b>R.U.C/C.I:</b></td>
                                   <td style="width:40%; text-align: left">'. ($fact_ruc_clie).'</td>
                                   <td style="width:20%;"><b>INSTITUCION:</b></td>
                                   <td style="width:30%; text-align: left"></td>
                               </tr>';
                $table_fact .='<tr>
                                   <td style="width:10%;"><b>DIRECCION:</b></td>
                                   <td style="width:40%; text-align: left">'. ($fact_dir_clie).'</td>
                                   <td style="width:20%;"><b>DEPARTAMENTO:</b></td>
                                   <td style="width:30%; text-align: left"></td>
                               </tr>';
                $table_fact .='<tr>
                                   <td style="width:10%;"><b>TELEFONO:</b></td>
                                   <td style="width:40%; text-align: left">'. ($fact_tlf_cliente).'</td>
                                   <td style="width:20%;"><b>FECHA:</b></td>
                                   <td style="width:30%; text-align: left">'. ($fact_fech_fact).'</td>
                               </tr>';



                $table_fact .='</table>';

            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();


    /**
     *
     */

    $sqlDeta = "select
dfac_cod_prod,
dfac_nom_prod,
sum(dfac_cant_dfac) as dfac_cant_dfac,
dfac_precio_dfac,
dfac_des1_dfac,
dfac_des2_dfac,
sum(dfac_mont_total) as dfac_mont_total,
dfac_tip_dfac,
dfac_por_iva,
dfac_det_dfac
from saedfac where dfac_cod_fact = $id and dfac_cod_sucu = $idSucursal and dfac_cod_empr = $idEmpresa
GROUP BY
dfac_cod_prod,
dfac_nom_prod,
dfac_cant_dfac,
dfac_precio_dfac,
dfac_des1_dfac,
dfac_des2_dfac,
dfac_mont_total,
dfac_tip_dfac,
dfac_por_iva,
dfac_det_dfac ";



    $deta = '<br><br> <table style="width: 100%; border:1px solid black; font-size: 11px;" cellpadding="1" cellspacing="2" bordercolor="#000000">';
    $deta .= ' <tr>';
    $deta .= ' <td style="width: 55%;" align="center"><font size="9"><b> DETALLE </b></font> </td>';
    $deta .= ' <td style="width: 15%;" align="right"><font size="9"><b> CANTIDAD </b></font></td>';
    $deta .= ' <td style="width: 15%;" align="right"><font size="9"><b> VALOR UNITARIO </b></font></td>';
    $deta .= ' <td style="width: 15%;" align="right"><font size="9"><b> VALOR TOTAL </b></font></td>';
    $deta .= ' </tr>';
    $deta .= ' </table>';

    $deta .= '<table style="width: 100%; border:1px solid black; font-size: 11px;"  cellpadding="1" cellspacing="1" >';

    $deta .= ' <tr>';
    $deta .= ' <td colspan="4"></td>';
    $deta .= ' </tr>';
    if ($oIfx->Query($sqlDeta)) {
        if ($oIfx->NumFilas() > 0) {

            do {
                $dfac_cod_prod = $oIfx->f('dfac_cod_prod');
                $dfac_nom_prod = $oIfx->f('dfac_nom_prod');
                $dfac_cant_dfac = $oIfx->f('dfac_cant_dfac');
                $dfac_precio_dfac = $oIfx->f('dfac_precio_dfac');
                $dfac_des1_dfac = $oIfx->f('dfac_des1_dfac');
                $dfac_des2_dfac = $oIfx->f('dfac_des2_dfac');
                $dfac_por_dsg = $oIfx->f('dfac_por_dsg');
                $dfac_mont_total = $oIfx->f('dfac_mont_total');
                $dfac_num_comp = $oIfx->f('dfac_tip_dfac');
                $dfac_por_iva = $oIfx->f('dfac_por_iva');
                $dfac_det_dfac = $oIfx->f('dfac_det_dfac');

                $descuento = $dfac_des1_dfac + $dfac_des2_dfac + $dfac_por_dsg;
                if ($descuento > 0) {
                    $descuento = ($dfac_precio_dfac * $dfac_cant_dfac) - ($dfac_mont_total);
                } else {
                    $descuento = 0;
                }

                $totalDescuento = $totalDescuento + $descuento;

                $deta .= ' <tr>';
                $deta .= ' <td style="width: 55%; font-size: 9px;" align="left">' . $dfac_nom_prod . '</td>';
                $deta .= ' <td style="width: 15%; font-size: 9px;" align="right">' . number_format($dfac_cant_dfac, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 15%; font-size: 9px;" align="right">' . number_format($dfac_precio_dfac, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 15%; font-size: 9px;" align="right">' . number_format($dfac_mont_total, 2, '.', ',') . '</td>';
                $deta .= ' </tr>';
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $deta .= ' <tr>';
    $deta .= ' <td colspan="4"></td>';
    $deta .= ' </tr>';

    $deta .= ' </table>';

    $porcIva = 12;

    $totales = ' <br><br><table  border="0" align="center" style="border-collapse: collapse;">';

    $totales .= ' <tr>';
    $totales .= ' <td style="width: 60%;" >SUB SIN IMPTOS:</td>';
    $totales .= ' <td style="width: 40%;" align="right">' . number_format($fact_tot_fact, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';

    $totales .= ' <td>SUBTOTAL ' . round($porcIva) . ' %:</td>';
    $totales .= ' <td align="right">' . number_format($fact_con_miva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>SUBTOTAL 0%:</td>';
    $totales .= ' <td align="right">' . number_format($fact_sin_miva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>IVA ' . round($porcIva) . '%:</td>';
    $totales .= ' <td align="right">' . number_format($fact_iva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td>TOTAL:</td>';
    $totales .= ' <td align="right">' . number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_ice + $fact_val_irbp+ $fact_fle_fact +$fact_otr_fact, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' </table>';

    /**
     *
     */
    $table_fact .= $deta;


    $adicional_info .= '<table style="width: 100%; "  border="0" align="left" >
                            <tr>

                                <td style="width: 50%;" align="center">
                                   <br><br>   <br><br>   <br>
                                    ______________________________ <br>
                                      <font size="7"> CLIENTE </font>
                                     <br><br>
                                </td>
                                
                                <td style="width: 50%;" align="center">
                                   <br><br>   <br><br>   <br> 
                                    _______________________________<br>
                                      <font size="7"> EMISOR </font>
                                     <br><br>
                                </td>

                            </tr>
                    </table>';


    $table_fact .= '<table  style="width: 100%; border:1px solid black; font-size: 11px;"  cellpadding="1" cellspacing="1" border="0">';
    $table_fact .= '<tr>
                      <td style="width: 65%;" align="center" >'.$adicional_info.'</td>
                      <td style="width: 35%;" align="center" >'.$totales.'</td>
                    </tr>';
    $table_fact .= '</table>';










    $documento = '<page backimgw="10%" backtop="10mm" backbottom="10mm" backleft="10mm" backright="10mm">';

    $documento.='<table style="width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">
<tr>
<td valign="top" style="width: 76%;">'.$table_fact.'</td>
</tr>
</table>';

    $documento .= '</page>';



    return $documento;
}

//ESPACIOS EN BLANCO
function espacios ($cant)
{
    $n="";
    for ($i=0; $i <=$cant ; $i++) {
        $n.="&nbsp;";
    }
    return $n;
}

function reporte_nota_credito_alterno_preimpreso($id = '', $nombre_archivo = '', $idSucursal = '', $bandera_c = 0)
{
    //Definiciones
    global $DSN_Ifx;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();


    $oIfxB = new Dbo;
    $oIfxB->DSN = $DSN_Ifx;
    $oIfxB->Conectar();


    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();

    $oIfxD = new Dbo;
    $oIfxD->DSN = $DSN_Ifx;
    $oIfxD->Conectar();

    $oReturn = new xajaxResponse();


    $idEmpresa = $_SESSION['U_EMPRESA'];

    $sql = "select empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr
                                            from saeempr where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S') {
                $empr_conta_sn = 'SI';
            }else {
                $empr_conta_sn = 'NO';
            }

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
        }
    }
    $oIfx->Free();

    $formatter = new EnLetras();
    //FORMATO NOTA DE CREDITO
    $sqlFac = "select * from saencre where ncre_cod_ncre = $id and ncre_cod_sucu = $idSucursal and ncre_cod_empr = $idEmpresa ";

    $consumido_final = 0;
    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $fact_nse_fact = $oIfx->f('ncre_nse_ncre');
                $fact_num_preimp = $oIfx->f('ncre_num_preimp');
                $fact_nom_cliente = $oIfx->f('ncre_nom_cliente');
                $fact_fech_fact = ($oIfx->f('ncre_fech_fact'));
                if(!empty($fact_fech_fact)){
                    $dia_fech=date('d', strtotime($fact_fech_fact));
                    $mes_fech=date('m', strtotime($fact_fech_fact));
                    $mes_fech=strtoupper(nomb_mes($mes_fech));
                    $anio_fech=date('Y', strtotime($fact_fech_fact));
                }
                else{
                    $dia_fech='';
                    $mes_fech='';
                    $anio_fech='';
                }

                $fact_ruc_clie = $oIfx->f('ncre_ruc_clie');
                $fact_tlf_cliente = $oIfx->f('ncre_tlf_cliente');
                $fact_dir_clie = ($oIfx->f('ncre_dir_clie'));
                $fact_email_clpv = str_replace(' ', '', $oIfx->f("ncre_email_clpv"));
                $fact_con_miva = $oIfx->f('ncre_con_miva');
                $fact_sin_miva = $oIfx->f('ncre_sin_miva');
                $fact_tot_fact = $oIfx->f('ncre_tot_fact');
                $fact_iva = $oIfx->f('ncre_iva');
                $fact_ice = $oIfx->f('ncre_ice');
                $fact_clav_sri = $oIfx->f('ncre_clav_sri');
                $fact_dsg_valo = $oIfx->f('ncre_dsg_valo');
                $ncre_cm2_ncre = $oIfx->f("ncre_cm2_ncre");
                $ncre_cm1_ncre = $oIfx->f("ncre_cm1_ncre");
                $fact_cod_clpv = $oIfx->f("ncre_cod_clpv");
                $fact_val_irbp = $oIfx->f("ncre_val_irbp");
                $ncre_cod_fact = $oIfx->f("ncre_cod_fact");


                $bandera_paciente = 0;
                $guia_ruc_clie = '';
                $guia_nom_cliente = '';

                if ($ncre_cod_fact == '') {
                    $ncre_cod_fact = 0;
                }


                $sql = "select fact_nse_fact, fact_num_preimp, fact_fech_fact,
						fact_cm2_fact
						from saefact 
						where fact_cod_empr = $idEmpresa and 
						fact_cod_fact = $ncre_cod_fact";

                $numero_fac = "";
                if ($oIfxD->Query($sql)) {
                    if ($oIfxD->NumFilas() > 0) {
                        $fact_nse_fact_in = $oIfxD->f('fact_nse_fact');
                        $fact_num_preimp_in = $oIfxD->f('fact_num_preimp');
                        $fact_fech_fact_in = fecha_mysql_func($oIfxD->f('fact_fech_fact'));
                        $fact_cm2_fact_in = $oIfxD->f('fact_cm2_fact');

                        $nse = substr($fact_nse_fact_in, 0, 3);
                        $pto = substr($fact_nse_fact_in, 3, 6);
                        $numero_fac =  $nse . '-' . $pto . '-' . $fact_num_preimp_in;
                    } else {
                        if ($ncre_cod_fact == 0) {
                            $sqlNcre = "select ncre_nse_ncre, ncre_cod_aux, ncre_fec_emfa from saencre where 
                                    ncre_cod_ncre = $id and 
                                    ncre_cod_empr = $idEmpresa and 
                                    ncre_cod_sucu = $idSucursal";
                            if ($oIfxD->Query($sqlNcre)) {
                                if ($oIfxD->NumFilas() > 0) {
                                    $fact_nse_fact_in = $oIfxD->f('ncre_nse_ncre');
                                    $numero_fac = $oIfxD->f('ncre_cod_aux');
                                    $fact_fech_fact_in = $oIfxD->f('ncre_fec_emfa');
                                }
                            }
                        }
                    }
                }
                $oIfxD->Free();


                //FACTURA AFECTA

                /* $table_fact .= ' <tr>
                                  <td class="fecha_letra" align="left" >FACTURA AFECTA: '.$numero_fac.'</td>
                                  <td class="fecha_letra" align="left" >FECHA FACTURA: '.$fact_fech_fact_in.'</td>
                                  </tr>';*/



                /**
                 * INFORMACION CABECERA
                 */
                $table_fact .= '<table style="width: 94%; "  cellpadding="1" cellspacing="1" border="0">';
                $table_fact .='<tr>
                    <td style="width:3%;"></td>
                    <td style="width:97%; height:63px; font-size: 12px;text-align: right" colspan="3">'.substr($fact_nse_fact, 0, 3) . '-' . substr($fact_nse_fact, 3, 6) .'-'.$fact_num_preimp.'</td>
                    </tr>';

                $table_fact .='<tr>
                                   <td style="width:3%;"></td>
                                   <td style="width:97%; height:15px; font-size: 12px; text-align: left" colspan="3">'. ($fact_nom_cliente).'</td>
                               </tr>';
                $table_fact .='<tr>
                                   <td style="width:3%;"></td>
                                   <td style="width:37%; height:15px; font-size: 12px; text-align: left">'. ($fact_ruc_clie).'</td>
                                   <td style="width:24%;"></td>
                                   <td style="width:36%; height:15px; font-size: 12px; text-align: left">'. ($razonSocial) .'</td>
                               </tr>';
                $table_fact .='<tr>
                                   <td style="width:3%;"></td>
                                   <td style="width:37%; height:15px; font-size: 12px; text-align: left">'. ($fact_dir_clie).'</td>
                                   <td style="width:24%; "></td>
                                   <td style="width:36%; height:15px; font-size: 12px; text-align: left">TESORERIA</td>
                               </tr>';
                $table_fact .='<tr>
                                   <td style="width:3%;"></td>
                                   <td style="width:37%; height:15px; font-size: 12px; text-align: left">'. ($fact_tlf_cliente).'</td>
                                   <td style="width:24%;"></td>
                                   <td style="width:36%; height:15px; font-size: 12px; text-align: left">'.$dia_fech.' DE '.$mes_fech.' DE '.$anio_fech.'</td>
                               </tr>';

                $table_fact .='</table>';


                $fact_dir_clie = ($fact_dir_clie);


            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();



    $sqlDeta = "select
    dncr_cod_prod,
    dncr_nom_prod,
    sum(dncr_cant_dfac) as dncr_cant_dfac,
    dncr_precio_dfac,
    dncr_des1_dfac,
    dncr_des2_dfac,
    sum(dncr_mont_total) as dncr_mont_total,
    dncr_por_iva
    from saedncr where dncr_cod_ncre = $id and dncr_cod_sucu = $idSucursal and dncr_cod_empr = $idEmpresa
    GROUP BY
    dncr_cod_prod,
    dncr_nom_prod,
    dncr_cant_dfac,
    dncr_precio_dfac,
    dncr_des1_dfac,
    dncr_des2_dfac,
    dncr_mont_total,
    dncr_por_iva";

    $deta .= '<table style="width: 100%; margin-top: 40px;"   cellpadding="1" cellspacing="1" border="0">';
    $deta .='<tr><td style="height:120px;">';
    $deta .= '<table style="width: 96%; "  align="left" cellpadding="1" cellspacing="1" border="0">';


    if ($oIfx->Query($sqlDeta)) {
        if ($oIfx->NumFilas() > 0) {

            do {
                $dfac_cod_prod = $oIfx->f('dncr_cod_prod');
                $dfac_nom_prod = $oIfx->f('dncr_nom_prod');
                $dfac_cant_dfac = $oIfx->f('dncr_cant_dfac');
                $dfac_precio_dfac = $oIfx->f('dncr_precio_dfac');
                $dfac_des1_dfac = $oIfx->f('dncr_des1_dfac');
                $dfac_des2_dfac = $oIfx->f('dncr_des2_dfac');
                $dfac_por_dsg = 0;
                $dfac_mont_total = $oIfx->f('dncr_mont_total');
                $dfac_por_iva = $oIfx->f('dncr_por_iva');

                $descuento = $dfac_des1_dfac + $dfac_des2_dfac + $dfac_por_dsg;
                if ($descuento > 0) {
                    $descuento = ($dfac_precio_dfac * $dfac_cant_dfac) - ($dfac_mont_total);
                } else {
                    $descuento = 0;
                }

                $totalDescuento = $totalDescuento + $descuento;


                $deta .= ' <tr>';
                $deta .= ' <td style="width: 53%; font-size: 12px;" align="left">' . $dfac_nom_prod . '</td>';
                $deta .= ' <td style="width: 17%; font-size: 13px;" align="right">' . number_format($dfac_cant_dfac, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 15%; font-size: 13px;" align="right">' . number_format($dfac_precio_dfac, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 15%; font-size: 13px;" align="right">' . number_format($dfac_mont_total, 2, '.', ',') . '</td>';
                $deta .= ' </tr>';

            } while ($oIfx->SiguienteRegistro());

            $deta .= ' <tr>';
            $deta .= ' <td style="width: 53%; font-size: 12px;" align="right"><br>DESCUENTO</td>';
            $deta .= ' <td style="width: 17%; font-size: 13px;" align="right"></td>';
            $deta .= ' <td style="width: 15%; font-size: 13px;" align="right"></td>';
            $deta .= ' <td style="width: 15%; font-size: 13px;" align="right"><br>'.$totalDescuento.'</td>';
            $deta .= ' </tr>';
        }
    }

    $deta .= ' </table>';
    $deta .='</td></tr>';
    $deta .= ' </table>';

    $porcIva = 12;
    $totales = '<table   style="width: 100%;" border="0" align="center" cellpadding="0" cellspacing="0" >';

    $totales .= ' <tr>';

    $totales .= ' <td style="width: 95%; height:2px;font-size: 13px;" align="right">' . number_format($fact_tot_fact, 2, '.', ',') . '</td>';
    $totales .= ' <td style="width: 5%;" ></td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';

    $totales .= ' <td  style="width: 95%; height:2px;font-size: 13px;" align="right">' . number_format($fact_sin_miva, 2, '.', ',') . '</td>';
    $totales .= ' <td></td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <td  style="width: 95%; height:2px;font-size: 13px;" align="right">' . number_format($fact_iva, 2, '.', ',') . '</td>';
    $totales .= ' <td></td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <td style="width: 95%; height:2px;font-size: 13px;" align="right">' . number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_ice + $fact_val_irbp+ $fact_fle_fact +$fact_otr_fact, 2, '.', ',') . '</td>';
    $totales .= ' <td></td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td style="width: 95%; height:2px;font-size: 13px;" align="right"></td>';
    $totales .= ' <td></td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td style="width: 95%; height:2px;font-size: 13px;" align="right"></td>';
    $totales .= ' <td></td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <td style="width: 95%; height:2px;font-size: 13px;" align="right">' . number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_ice + $fact_val_irbp+ $fact_fle_fact +$fact_otr_fact, 2, '.', ',') . '</td>';
    $totales .= ' <td></td>';
    $totales .= ' </tr>';
    $totales .= ' </table>';

    $table_fact .= $deta;


    $total=$fact_con_miva + $fact_sin_miva + $fact_iva + $fact_ice + $fact_val_irbp+ $fact_fle_fact +$fact_otr_fact;
    $total=round($total,2);
    $valtotal=$formatter->ValorEnLetras($total,'d&oacute;lares');

    $adicional_info .= '<table style="width: 100%; "  border="0" align="left" cellpadding="0" cellspacing="0">
                            <tr>
                                <td  style="width: 100%;height:15px; font-size: 12px;" align="left">'.espacios(43).''.$ncre_cm2_ncre.' MOTIVO: '.$ncre_cm1_ncre.'</td>
                            </tr>
                            <tr>
                                <td  style="width: 100%;height:18px;font-size: 12px;" align="left">'.espacios(12).''.$valtotal.'</td>
                            </tr>
                    </table>';


    $table_fact .= '<table  style="width: 96%; "  cellpadding="1" cellspacing="1" border="0">';
    $table_fact .= '<tr>
                      <td style="width: 52%;" align="center" >'.$adicional_info.'</td>
                      <td valign="bottom" style="width: 48%;height:115px;" align="center" >'.$totales.'</td>
                    </tr>';
    $table_fact .= '</table>';

    ////////////////////////////////////////////////////////////////////////////////////

    $documento = '<page backimgw="10%" backtop="19mm" backbottom="10mm" backleft="2mm" backright="10mm">';

    $documento.='<table style="width: 100%;" border="0" style="border-collapse: collapse;">
<tr>
<td valign="top" style="width: 100%;">'.$table_fact.'</td>
</tr>
</table>';

    $documento .= '</page>';



    return $documento;
}


function reporte_factura_alterno_cre_preimpreso($id = '', $nombre_archivo = '', $idSucursal = '', $bandera_c = 0)
{
    //Definiciones
    global $DSN_Ifx;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();


    $oIfxB = new Dbo;
    $oIfxB->DSN = $DSN_Ifx;
    $oIfxB->Conectar();


    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();

    $oIfxD = new Dbo;
    $oIfxD->DSN = $DSN_Ifx;
    $oIfxD->Conectar();

    $oReturn = new xajaxResponse();


    $idEmpresa = $_SESSION['U_EMPRESA'];

    $sql = "select empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr
    from saeempr where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S') {
                $empr_conta_sn = 'SI';
            }else {
                $empr_conta_sn = 'NO';
            }

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
        }
    }
    $oIfx->Free();

    //FORMATO DE FACTURA

    $sqlFac = "select * from saefact where fact_cod_fact = $id and fact_cod_sucu = $idSucursal and fact_cod_empr = $idEmpresa ";

    $table_fact = '';
    $consumido_final = 0;
    $formatter = new EnLetras();
    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $fact_nse_fact = $oIfx->f('fact_nse_fact');
                $fact_num_preimp = $oIfx->f('fact_num_preimp');

                $nse = substr($fact_nse_fact, 0, 3);
                $pto = substr($fact_nse_fact, 3, 6);
                $numero_fac =  $nse . '-' . $pto . '-' . $fact_num_preimp;


                $fact_nom_cliente = $oIfx->f('fact_nom_cliente');
                $fact_fech_fact = ($oIfx->f('fact_fech_fact'));
                if(!empty($fact_fech_fact)){
                    $dia_fech=date('d', strtotime($fact_fech_fact));
                    $mes_fech=date('m', strtotime($fact_fech_fact));
                    $mes_fech=strtoupper(nomb_mes($mes_fech));
                    $anio_fech=date('Y', strtotime($fact_fech_fact));
                }
                else{
                    $dia_fech='';
                    $mes_fech='';
                    $anio_fech='';
                }
                $fact_ruc_clie = $oIfx->f('fact_ruc_clie');
                $fact_tlf_cliente = $oIfx->f('fact_tlf_cliente');
                $fact_dir_clie = ($oIfx->f('fact_dir_clie'));
                $fact_email_clpv = str_replace(' ', '', $oIfx->f("fact_email_clpv"));
                $fact_con_miva = $oIfx->f('fact_con_miva');
                $fact_sin_miva = $oIfx->f('fact_sin_miva');
                $fact_tot_fact = $oIfx->f('fact_tot_fact');
                $fact_iva = $oIfx->f('fact_iva');
                $fact_ice = $oIfx->f('fact_ice');
                $fact_clav_sri = $oIfx->f('fact_clav_sri');
                $fact_dsg_valo = $oIfx->f('fact_dsg_valo');
                $fact_cm1_fact = $oIfx->f("fact_cm1_fact");
                $fact_cm2_fact = $oIfx->f("fact_cm2_fact");
                $fact_cm4_fact = $oIfx->f("fact_cm4_fact");
                $orden_compra = $oIfx->f("fact_opc_fact");
                $fact_cod_clpv = $oIfx->f("fact_cod_clpv");
                $fact_cod_ccli = $oIfx->f("fact_cod_ccli");
                if(!empty($fact_cod_ccli)){
                    $sqlcli="select ccli_nom_conta from saeccli where ccli_cod_ccli=$fact_cod_ccli";
                    $subcliente=consulta_string($sqlcli,'ccli_nom_conta',$oIfxA,'');
                }
                else{
                    $subcliente='';
                }

                $fact_dia_plazo = $oIfx->f("fact_dia_fact");
                $fact_val_irbp = $oIfx->f("fact_val_irbp");
                $fact_tipo_convenio = $oIfx->f("fact_tipo_convenio");
                $fact_cod_guia = $oIfx->f("fact_cod_guia");
                $fact_fle_fact = $oIfx->f('fact_fle_fact');
                $fact_otr_fact = $oIfx->f('fact_otr_fact');


                $sql = "select 
                        fxf.fxfp_val_fxfp as tot,
                        fpa.fpag_des_fpag as pag
                        from saefxfp fxf
                        inner join saefpag fpa on fxf.fxfp_cod_fpag = fpa.fpag_cod_fpag
                        where fxfp_cod_fact = $id and fxfp_cod_empr = $idEmpresa;";
                $forma_html = '';
                if ($oIfxB->Query($sql)) {
                    if ($oIfxB->NumFilas() > 0) {
                        $tot = number_format($oIfxB->f('tot'),2,'.','');
                        $pag = $oIfxB->f('pag');
                        $forma_html .= "<br>FORMA DE PAGO: $pag <br>MONTO: $tot";
                    }
                }
                $oIfxB->Free();


                /**
                 * INFORMACION CABECERA
                 */

                $table_fact .= '<table style="width: 100%; "  cellpadding="1" cellspacing="1" border="0">';
                $table_fact .='<tr>
                    <td style="width:11%;"></td>
                    <td style="width:89%; height:77px; font-size: 12px;text-align: right">'. ($numero_fac).'</td>
                    </tr>';
                $table_fact .='</table>';

                $table_fact .= '<table style="width: 100%; "  cellpadding="1" cellspacing="1" border="0">';
                $table_fact .='<tr>
                                   <td style="width:6%;"></td>
                                   <td style="width:94%; height:11px; font-size: 12px; text-align: left" colspan="3">'. ($fact_nom_cliente).'</td>
                               </tr>';
                $table_fact .='<tr>
                                   <td style="width:3%;"></td>
                                   <td style="width:40%; height:11px; font-size: 12px; text-align: left">'. ($fact_ruc_clie).'</td>
                                   <td style="width:15%;"></td>
                                   <td style="width:42%; height:11px; font-size: 12px; text-align: left">'. ($razonSocial) .'</td>
                               </tr>';
                $table_fact .='<tr>
                                   <td style="width:3%;"></td>
                                   <td style="width:40%; height:11px; font-size: 12px; text-align: left">'. ($fact_dir_clie).'</td>
                                   <td style="width:15%; text-align: left"></td>
                                   <td style="width:42%;height:11px; font-size: 12px; text-align: left">TESORERIA</td>
                               </tr>';
                $table_fact .='<tr>
                                   <td style="width:3%;"></td>
                                   <td style="width:40%; height:11px; font-size: 12px; text-align: left">'. ($fact_tlf_cliente).'</td>
                                   <td style="width:15%;"></td>
                                   <td style="width:42%; height:11px; font-size: 12px; text-align: left">'.$dia_fech.' DE '.$mes_fech.' DE '.$anio_fech.'</td>
                               </tr>';

                $table_fact .='</table>';

            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();


    /**
     *
     */

    $sqlDeta = "select
    dfac_cod_prod,
    dfac_nom_prod,
    sum(dfac_cant_dfac) as dfac_cant_dfac,
    dfac_precio_dfac,
    dfac_des1_dfac,
    dfac_des2_dfac,
    sum(dfac_mont_total) as dfac_mont_total,
    dfac_tip_dfac,
    dfac_por_iva,
    dfac_det_dfac
    from saedfac where dfac_cod_fact = $id and dfac_cod_sucu = $idSucursal and dfac_cod_empr = $idEmpresa
    GROUP BY
    dfac_cod_prod,
    dfac_nom_prod,
    dfac_cant_dfac,
    dfac_precio_dfac,
    dfac_des1_dfac,
    dfac_des2_dfac,
    dfac_mont_total,
    dfac_tip_dfac,
    dfac_por_iva,
    dfac_det_dfac ";

//ALTO TABLA TOTALES


//$i=1;
    $deta .= '<table style="width: 100%; margin-top: 60px;"   cellpadding="1" cellspacing="1" border="0">';
    $deta .='<tr><td style="height:325px;">';
    $deta .= '<table style="width: 96%; "  align="left" cellpadding="1" cellspacing="1" border="0">';
    if ($oIfx->Query($sqlDeta)) {
        if ($oIfx->NumFilas() > 0) {

            do {
                $dfac_cod_prod = $oIfx->f('dfac_cod_prod');
                $dfac_nom_prod = $oIfx->f('dfac_nom_prod');
                $dfac_cant_dfac = $oIfx->f('dfac_cant_dfac');
                $dfac_precio_dfac = $oIfx->f('dfac_precio_dfac');
                $dfac_des1_dfac = $oIfx->f('dfac_des1_dfac');
                $dfac_des2_dfac = $oIfx->f('dfac_des2_dfac');
                $dfac_por_dsg = $oIfx->f('dfac_por_dsg');
                $dfac_mont_total = $oIfx->f('dfac_mont_total');
                $dfac_num_comp = $oIfx->f('dfac_tip_dfac');
                $dfac_por_iva = $oIfx->f('dfac_por_iva');
                $dfac_det_dfac = $oIfx->f('dfac_det_dfac');

                $descuento = $dfac_des1_dfac + $dfac_des2_dfac + $dfac_por_dsg;
                if ($descuento > 0) {
                    $descuento = ($dfac_precio_dfac * $dfac_cant_dfac) - ($dfac_mont_total);
                } else {
                    $descuento = 0;
                }

                $totalDescuento = $totalDescuento + $descuento;

                $deta .= ' <tr>';
                $deta .= ' <td style="width: 53%; font-size: 12px;" align="left">'.$dfac_cod_prod.' ' . $dfac_nom_prod . '</td>';
                $deta .= ' <td style="width: 17%; font-size: 13px;" align="right">' . number_format($dfac_cant_dfac, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 15%; font-size: 13px;" align="right">' . number_format($dfac_precio_dfac, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 15%; font-size: 13px;" align="right">' . number_format($dfac_mont_total, 2, '.', ',') . '</td>';
                $deta .= ' </tr>';
                $i++;
            } while ($oIfx->SiguienteRegistro());

            $deta .= ' <tr>';
            $deta .= ' <td style="width: 53%; font-size: 12px;" align="right"><br>DESCUENTO</td>';
            $deta .= ' <td style="width: 17%; font-size: 13px;" align="right"></td>';
            $deta .= ' <td style="width: 15%; font-size: 13px;" align="right"></td>';
            $deta .= ' <td style="width: 15%; font-size: 13px;" align="right"><br>'.$totalDescuento.'</td>';
            $deta .= ' </tr>';

            $deta .= ' <tr>';
            $deta .= ' <td style="width: 53%; font-size: 12px;" align="left">'.$forma_html.'</td>';
            $deta .= ' <td style="width: 17%; font-size: 13px;" align="right"></td>';
            $deta .= ' <td style="width: 15%; font-size: 13px;" align="right"></td>';
            $deta .= ' <td style="width: 15%; font-size: 13px;" align="right"></td>';
            $deta .= ' </tr>';

        }
    }

    $deta .= ' </table>';

    $deta .='</td></tr>';

    $deta .= ' </table>';

    $porcIva = 12;

    $totales = '<table   style="width: 100%; " border="0" align="center" cellpadding="1" cellspacing="1" >';

    $totales .= ' <tr>';

    $totales .= ' <td style="width: 95%; height:19px;font-size: 13px;" align="right">' . number_format($fact_tot_fact, 2, '.', ',') . '</td>';
    $totales .= ' <td style="width: 5%;" ></td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';

    $totales .= ' <td  style="width: 95%; height:19px;font-size: 13px;" align="right">' . number_format($fact_sin_miva, 2, '.', ',') . '</td>';
    $totales .= ' <td></td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <td  style="width: 95%; height:19px;font-size: 13px;" align="right">' . number_format($fact_iva, 2, '.', ',') . '</td>';
    $totales .= ' <td></td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <td style="width: 95%; height:19px;font-size: 13px;" align="right">' . number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_ice + $fact_val_irbp+ $fact_fle_fact +$fact_otr_fact, 2, '.', ',') . '</td>';
    $totales .= ' <td></td>';
    $totales .= ' </tr>';
    $totales .= ' </table>';

    /**
     *
     */
    $table_fact .= $deta;


    $total=$fact_con_miva + $fact_sin_miva + $fact_iva + $fact_ice + $fact_val_irbp+ $fact_fle_fact +$fact_otr_fact;
    $total=round($total,2);
    $valtotal=$formatter->ValorEnLetras($total,'d&oacute;lares');

    $adicional_info .= '<table style="width: 100%; "  border="0" align="left" cellpadding="1" cellspacing="1">
                            <tr>
                                <td  style="width: 100%;font-size: 13px;" align="left">'.espacios(3).''.$valtotal.'</td>
                            </tr>
                            <tr>
                            <td  style="width: 100%;font-size: 12px;" align="left">'.$fact_cm1_fact.'</td>
                        </tr>
                            
                    </table>';


    $table_fact .= '<table  style="width: 100%; "  cellpadding="1" cellspacing="1" border="0">';
    $table_fact .= '<tr>
                      <td style="width: 52%;" align="center" >'.$adicional_info.'</td>
                      <td style="width: 48%;" align="center" >'.$totales.'</td>
                    </tr>';
    $table_fact .= '</table>';




    $documento = '<page backimgw="10%" backtop="5.5mm" backbottom="10mm" backleft="9mm" backright="10mm">';

    $documento.='<table style="width: 100%;" border="0" style="border-collapse: collapse;">
<tr>
<td valign="top" style="width: 100%;">'.$table_fact.'</td>
</tr>
</table>';

    $documento .= '</page>';


    return $documento;
}

/**
 * FIN FORMATOS CRE
 */


function reporte_factura_invoice($id = '', $nombre_archivo = '', &$rutaPdf = '')
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    //variables de session
    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_nom_empr, empr_ruc_empr , empr_dir_empr, 
			empr_mai_empr, empr_tel_resp, empr_path_logo, empr_cpo_empr
			from saeempr where empr_cod_empr = $idEmpresa";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            $empr_mai_empr = $oIfx->f('empr_mai_empr');
            $empr_tel_resp = $oIfx->f('empr_tel_resp');
            $empr_cpo_empr = $oIfx->f('empr_cpo_empr');
        }
    }
    $oIfx->Free();

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis  
			from saesucu 
			where sucu_cod_empr = $idEmpresa and 
			sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
        }
    }
    $oIfx->Free();

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }


    $sqlFac = "select * from saefact where fact_cod_fact = $id and fact_cod_sucu = $idSucursal and fact_cod_empr = $idEmpresa";

    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {
            $fact_num_preimp = $oIfx->f('fact_num_preimp');
            $fact_fech_fact = cambioFecha($oIfx->f('fact_fech_fact'), 'mm/dd/aaaa', 'aaaa/mm/dd');
            $fact_nse_fact = $oIfx->f('fact_nse_fact');
            $fact_auto_sri = $oIfx->f('fact_auto_sri');
            $fact_fech_sri = $oIfx->f('fact_fech_sri');
            $fact_nom_cliente = $oIfx->f('fact_nom_cliente');
            $fact_ruc_clie = $oIfx->f('fact_ruc_clie');
            $fact_tlf_cliente = $oIfx->f('fact_tlf_cliente');
            $fact_dir_clie = htmlentities($oIfx->f('fact_dir_clie'));
            $fact_email_clpv = $oIfx->f('fact_email_clpv');
            $fact_con_miva = $oIfx->f('fact_con_miva');
            $fact_sin_miva = $oIfx->f('fact_sin_miva');
            $fact_tot_fact = $oIfx->f('fact_tot_fact');
            $fact_iva = $oIfx->f('fact_iva');
            $fact_clav_sri = $oIfx->f('fact_clav_sri');
            $fact_msn = $oIfx->f('fact_cm1_fact');
            $fact_term_expor = $oIfx->f('fact_term_expor');
            $fact_cod_pais = $oIfx->f('fact_cod_pais');
            $fact_cod_ffue = $oIfx->f('fact_cod_ffue');
            $fact_fec_emb = fecha_mysql_func($oIfx->f('fact_fec_emb'));
            $fact_prto_emb = $oIfx->f('fact_prto_emb');
            $fact_prto_dest = $oIfx->f('fact_prto_dest');
            $fact_fle_fact = $oIfx->f('fact_fle_fact');
            $fact_otr_fact = $oIfx->f('fact_otr_fact');
            $fact_fin_fact = $oIfx->f('fact_fin_fact');
            $fact_awb_fact = $oIfx->f('fact_awb_fact');
            $fact_hawb_fact = $oIfx->f('fact_hawb_fact');
            $fact_cod_ccli = $oIfx->f('fact_cod_ccli');
            $fact_cod_clpv = $oIfx->f('fact_cod_clpv');
            $fact_cod_acar = $oIfx->f('fact_cod_acar');
            $fact_cod_laer = $oIfx->f('fact_cod_laer');
            $fact_cod_cufr = $oIfx->f('fact_cod_cufr');
            $fact_cm4_fact = $oIfx->f('fact_cm4_fact');

            if (!empty($fact_cod_ccli)) {
                $sqlCcli = "select ccli_cod_ccli, ccli_nom_conta, ccli_dire_ccli, ccli_tlf1_ccli
						from saeccli
						where ccli_cod_clpv = $fact_cod_clpv and
						ccli_cod_ccli = $fact_cod_ccli and
						ccli_cod_empr = $idEmpresa";
                if ($oIfxA->Query($sqlCcli)) {
                    if ($oIfxA->NumFilas() > 0) {
                        $ccli_nom_conta = $oIfxA->f('ccli_nom_conta');
                        $ccli_dire_ccli = $oIfxA->f('ccli_dire_ccli');
                        $ccli_tlf1_ccli = $oIfxA->f('ccli_tlf1_ccli');
                    }
                }
                $oIfxA->Free();
            } else {
                $ccli_nom_conta = $fact_nom_cliente;
                $ccli_dire_ccli = $fact_dir_clie;
                $ccli_tlf1_ccli = $fact_tlf_cliente;
            }

            //forma de pago
            $sqlFPago = "select fxfp_num_dias from saefxfp
					where fxfp_cod_empr = $idEmpresa and
					fxfp_cod_sucu = $idSucursal and
					fxfp_cod_fact = $id";
            $fxfp_num_dias = consulta_string($sqlFPago, 'fxfp_num_dias', $oIfxA, '');

            $fechaFPago = sumar_dias_func($fact_fech_fact, $fxfp_num_dias);

            //PAIS
            if (empty($fact_cod_pais)) {
                $fact_cod_pais = 0;
            }
            $sql_pais = "select pais_des_pais from saepais where pais_cod_pais = $fact_cod_pais";
            $pais = consulta_string_func($sql_pais, 'pais_des_pais', $oIfxA, '--');

            //EMBARQUE ORIGEN
            $sql_emb_1 = "select prto_des_prto from saeprto where prto_cod_prto = $fact_prto_emb";
            $prto_1 = consulta_string_func($sql_emb_1, 'prto_des_prto', $oIfxA, '--');

            //EMBARQUE DESTINO
            $sql_emb_2 = "select prto_des_prto from saeprto where prto_cod_prto = $fact_prto_dest";
            $prto_2 = consulta_string_func($sql_emb_2, 'prto_des_prto', $oIfxA, '--');

            if ($fact_prto_dest == 9) {
                $term = $fact_term_expor . '-' . $prto_2;
            } else {
                $term = $fact_term_expor;
            }
            // DAE
            $sql_fue = "select ffue_fue_ffue    from saeffue where
							ffue_cod_ffue  = '$fact_cod_ffue' ";
            $dae = consulta_string_func($sql_fue, 'ffue_fue_ffue', $oIfxA, '');

            //agencia carguera
            if (empty($fact_cod_acar)) {
                $fact_cod_acar = 0;
            }

            $sqlAcar = "select acar_nom_acar from saeacar where acar_cod_acar = $fact_cod_acar";
            $acar_nom_acar = consulta_string($sqlAcar, 'acar_nom_acar', $oIfxA, '');

            //linea aerea
            if (empty($fact_cod_laer)) {
                $fact_cod_laer = 0;
            }

            $sqlLaer = "select laer_nom_laer from saelaer where laer_cod_laer = $fact_cod_laer";
            $laer_nom_laer = consulta_string($sqlLaer, 'laer_nom_laer', $oIfxA, '');

            //fue
            if (empty($fact_term_expor)) {
                $fact_term_expor = 0;
            }

            $sqlTerm = "select nombre from incoterm where id = $fact_term_expor";
            $incoterm = consulta_string($sqlTerm, 'nombre', $oCon, '');

            //cuarto frio
            if (empty($fact_cod_cufr)) {
                $fact_cod_cufr = 0;
            }

            $sqlCFrio = "select cufr_nom_cufr from saecufr where cufr_cod_cufr = $fact_cod_cufr";
            $cufr_nom_cufr = consulta_string($sqlCFrio, 'cufr_nom_cufr', $oIfxA, '');

            $logo .= '<table style="width: 100%;" align="center">';
            $logo .= '<tr>';
            $logo .= '<b><td style="font-size: 20px">INVOICE ' . $fact_num_preimp . '</td></b>';
            $logo .= '</tr>';
            $logo .= '</table>';
            $logo .= '<table style="width: 100%;" align="left">';
            $logo .= '<tr>';
            $logo .= '<td align="left"><img src="/var/www\JirehWeb\WebApp\imagenes\logos\kiara.jpg" style="width: 170px; height: 150px;"/></td>';
            $logo .= '</tr>';
            $logo .= '</table>';
            $logo .= '<table style="width: 100%; margin-top: 10px;" align="center">';
            $logo .= '<tr><td style="font-size: 25px; font-style: italic;" colspan="2">' . $razonSocial . '</td>';
            $logo .= '<b><td align="left" style="width: 18%; font-size: 20px;">Date:</td></b>';
            $logo .= '<td align="left" style="width: 20%; font-size: 21px;">' . $fact_fech_fact . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr><td style="font-size: 18px; font-style: italic;" colspan="2">' . $dirMatriz . '</td>';
            $logo .= '<b><td align="left" style="width: 18%; font-size: 20px;">Packing List:</td></b>';
            $logo .= '<td align="left" style="width: 20%; font-size: 21px;">' . substr($fact_cm4_fact, 10, 10) . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr><td style="font-size: 18px; font-style: italic;" colspan="2">SANGOLQUI - ECUADOR</td>';
            $logo .= '<b><td align="left" style="width: 18%; font-size: 20px;">CTRY. DEST:</td></b>';
            $logo .= '<td align="left" style="width: 20%; font-size: 21px;">' . $pais . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr><td style="font-size: 18px; font-style: italic;" colspan="2">' . $empr_mai_empr . '</td>';
            $logo .= '<b><td align="left" style="width: 18%; font-size: 20px;">CITY:</td></b>';
            $logo .= '<td align="left" style="width: 20%; font-size: 21px;">' . $prto_2 . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr><td style="font-size: 18px; font-style: italic;" colspan="2">' . $empr_cpo_empr . '' . $empr_tel_resp . '</td>';
            $logo .= '<b><td align="left" style="width: 18%; font-size: 20px;">FUE:</td></b>';
            $logo .= '<td align="left" style="width: 20%; font-size: 21px;">' . $dae . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr><td style="font-size: 18px; font-style: italic;" colspan="2">PRODUCT OF ECUADOR</td>';
            $logo .= '<b><td align="left" style="width: 18%; font-size: 20px;">M. A.W.B.:</td></b>';
            $logo .= '<td align="left" style="width: 20%; font-size: 21px;">' . $fact_awb_fact . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<b><td align="left" style="width: 11%; font-size: 20px;">CLIENT:</td></b>';
            $logo .= '<td align="left" style="width: 51%; font-size: 21px;">' . $fact_nom_cliente . '</td>';
            $logo .= '<b><td align="left" style="width: 18%; font-size: 20px;">H. A.W.B.:</td></b>';
            $logo .= '<td align="left" style="width: 20%; font-size: 21px;">' . $fact_hawb_fact . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<b><td align="left" style="width: 11%; font-size: 20px;">ADDRESS:</td></b>';
            $logo .= '<td align="left" style="width: 51%; font-size: 20px;">' . $fact_dir_clie . '</td>';
            $logo .= '<b><td align="left" style="width: 18%; font-size: 20px;">CARGO AGENCY:</td></b>';
            $logo .= '<td align="left" style="width: 20%; font-size: 21px;">' . $acar_nom_acar . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<b><td align="left" style="width: 11%; font-size: 20px;">PHONE:</td></b>';
            $logo .= '<td align="left" style="width: 51%; font-size: 21px;">' . $fact_tlf_cliente . '</td>';
            $logo .= '<b><td align="left" style="width: 18%; font-size: 20px;">C. ROOM:</td></b>';
            $logo .= '<td align="left" style="width: 20%; font-size: 21px;">' . $cufr_nom_cufr . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<b><td align="left" style="width: 11%; font-size: 20px;">CONSIGNE:</td></b>';
            $logo .= '<td align="left" style="width: 51%; font-size: 21px;">' . $ccli_nom_conta . '</td>';
            $logo .= '<b><td align="left" style="width: 18%; font-size: 20px;">AIR LINE:</td></b>';
            $logo .= '<td align="left" style="width: 20%; font-size: 21px;">' . $laer_nom_laer . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<b><td align="left" style="width: 11%; font-size: 20px;">ADDRESS:</td></b>';
            $logo .= '<td align="left" style="width: 51%; font-size: 20px;">' . $ccli_dire_ccli . '</td>';
            $logo .= '<b><td align="left" style="width: 18%; font-size: 20px;">DUE DATE:</td></b>';
            $logo .= '<td align="left" style="width: 20%; font-size: 21px;">' . $fechaFPago . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<b><td align="left" style="width: 11%; font-size: 20px;">PHONE:</td></b>';
            $logo .= '<td align="left" style="width: 51%; font-size: 21px;">' . $ccli_tlf1_ccli . '</td>';
            $logo .= '<b><td align="left" style="width: 18%; font-size: 19px;">TYPE OF SALE:</td></b>';
            $logo .= '<td align="left" style="width: 20%; font-size: 20px;">' . $incoterm . '</td>';
            $logo .= '</tr>';
            $logo .= '</table>';
        }
    }
    $oIfx->Free();

    $deta .= '<table align="center" border="1" style="width: 100%; border-collapse: collapse; margin-top: 23px;">';

    //query caja
    $sqlCaja = "select caja_cod_caja, caja_nom_caja from saecaja where caja_cod_finc = $idEmpresa";
    if ($oIfx->Query($sqlCaja)) {
        if ($oIfx->NumFilas() > 0) {
            unset($arrayCaja);
            do {
                $arrayCaja[$oIfx->f('caja_cod_caja')] = $oIfx->f('caja_nom_caja');
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    //query grupo
    $sqlGrpr = "select grpr_cod_grpr, grpr_des_grpr from saegrpr where grpr_cod_empr = $idEmpresa";
    if ($oIfx->Query($sqlGrpr)) {
        if ($oIfx->NumFilas() > 0) {
            unset($arrayGrpr);
            do {
                $arrayGrpr[$oIfx->f('grpr_cod_grpr')] = $oIfx->f('grpr_des_grpr');
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    //query marca
    $sqlMarc = "select marc_cod_marc, marc_des_marc from saemarc where  marc_cod_empr = $idEmpresa";
    if ($oIfx->Query($sqlMarc)) {
        if ($oIfx->NumFilas() > 0) {
            unset($arrayMarc);
            do {
                $arrayMarc[$oIfx->f('marc_cod_marc')] = $oIfx->f('marc_des_marc');
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    $sqlDeta = "select * from saedfac 
				where dfac_cod_fact = $id and 
				dfac_cod_sucu = $idSucursal and 
				dfac_cod_empr = $idEmpresa 
				order by  dfac_cod_dfact";

    if ($oIfx->Query($sqlDeta)) {
        if ($oIfx->NumFilas() > 0) {
            $deta .= ' <tr>';
            $deta .= ' <b> <td align="center" style="width: 4%;  font-size: 17px;">Box</td> </b>';
            $deta .= ' <b> <td align="center" style="width: 6%;  font-size: 17px;">Order</td> </b>';
            $deta .= ' <b> <td align="center" style="width: 9%;  font-size: 17px;">Box T.</td> </b>';
            $deta .= ' <b> <td align="center" style="width: 11%; font-size: 17px;">Id</td> </b>';
            $deta .= ' <b> <td align="center" style="width: 23%; font-size: 17px;">Description</td> </b>';
            $deta .= ' <b> <td align="center" style="width: 9%;  font-size: 17px;">Size</td> </b>';
            $deta .= ' <b> <td align="center" style="width: 7%;  font-size: 17px;">Bun/Box</td> </b>';
            $deta .= ' <b> <td align="center" style="width: 6%;  font-size: 17px;">T.Bun</td> </b>';
            $deta .= ' <b> <td align="center" style="width: 6%;  font-size: 17px;">SxB</td> </b>';
            $deta .= ' <b> <td align="center" style="width: 6%;  font-size: 17px;">Stems</td> </b>';
            $deta .= ' <b> <td align="center" style="width: 6%;  font-size: 17px;">Price</td> </b>';
            $deta .= ' <b> <td align="center" style="width: 7%;  font-size: 17px;">Total</td> </b>';
            $deta .= ' </tr>';
            $totalCajas = 0;
            $totalTallos = 0;
            $granTotal = 0;
            $totalPrecio = 0;
            unset($arrayBucle);
            $i = 1;
            do {
                $dfac_cod_prod = $oIfx->f('dfac_cod_prod');
                $dfac_nom_prod = $oIfx->f('dfac_nom_prod');
                $dfac_cant_dfac = $oIfx->f('dfac_cant_dfac');
                $dfac_precio_dfac = $oIfx->f('dfac_precio_dfac');
                $dfac_des1_dfac = $oIfx->f('dfac_des1_dfac');
                $dfac_des2_dfac = $oIfx->f('dfac_des2_dfac');
                $dfac_por_dsg = $oIfx->f('dfac_por_dsg');
                $dfac_mont_total = $oIfx->f('dfac_mont_total');
                $dfac_cod_alt = $oIfx->f('dfac_cod_alt');
                $dfac_num_caja = round($oIfx->f('dfac_num_caja'));
                $dfac_cod_caja = $oIfx->f('dfac_cod_caja');
                $dfac_cod_grpr = $oIfx->f('dfac_cod_grpr');
                $dfac_cod_marc = $oIfx->f('dfac_cod_marc');
                $dfac_precio_tall = $oIfx->f('dfac_precio_tall');
                $dfac_cant_emp = $oIfx->f('dfac_cant_emp');
                $dfac_ord_caja = $oIfx->f('dfac_ord_caja');
                $dfac_det_dfac = $oIfx->f('dfac_det_dfac');


                $arrayBucle[$i] = $dfac_ord_caja;

                if ($i > 1) {
                    if ($arrayBucle[$i] != $arrayBucle[$i - 1]) {
                        $dfac_num_caja = round($oIfx->f('dfac_num_caja'));
                    } else {
                        $dfac_num_caja = '';
                    }
                }

                $descuento = $dfac_des1_dfac + $dfac_des2_dfac + $dfac_por_dsg;
                if ($descuento > 0)
                    $descuento = ($dfac_precio_dfac * $dfac_cant_dfac) - ($dfac_mont_total);
                else
                    $descuento = 0;

                $totalDescuento = $totalDescuento + $descuento;

                //tallos
                $tallos = $dfac_cant_dfac * $arrayMarc[$dfac_cod_marc];

                //array cajas


                $deta .= ' <tr>';
                $deta .= ' <td style="font-size: 18px; width: 4%;" align="right">' . $dfac_num_caja . '</td>';
                $deta .= ' <td style="font-size: 18px; width: 6%;" align="right">' . $dfac_ord_caja . '</td>';
                $deta .= ' <td style="font-size: 18px; width: 9%;">' . substr($arrayCaja[$dfac_cod_caja], 0, 9) . '</td>';
                $deta .= ' <td style="font-size: 18px; width: 11%;">' . substr($dfac_det_dfac, 0, 9) . '</td>';
                $deta .= ' <td style="font-size: 18px; width: 23%;">' . substr($dfac_nom_prod, 0, 20) . '</td>';
                $deta .= ' <td style="font-size: 18px; width: 9%;">' . substr($arrayGrpr[$dfac_cod_grpr], 0, 7) . '</td>';
                $deta .= ' <td style="font-size: 18px; width: 7%;" align="right">' . number_format($dfac_cant_emp, 0, '.', ',') . '</td>';
                $deta .= ' <td style="font-size: 18px; width: 6%;" align="right">' . number_format($dfac_cant_dfac, 0, '.', ',') . '</td>';
                $deta .= ' <td style="font-size: 18px; width: 6%;" align="right">' . $arrayMarc[$dfac_cod_marc] . '</td>';
                $deta .= ' <td style="font-size: 18px; width: 6%;" align="right">' . number_format($tallos, 0, '.', ',') . '</td>';
                $deta .= ' <td style="font-size: 18px; width: 6%;" align="right">' . number_format($dfac_precio_tall, 2, '.', ',') . '</td>';
                $deta .= ' <td style="font-size: 18px; width: 7%;" align="right">' . number_format($dfac_mont_total, 2, '.', ',') . '</td>';
                $deta .= ' </tr>';

                $totalCajas += $dfac_cant_dfac;
                $totalTallos += $tallos;
                $granTotal += $dfac_mont_total;
                $totalPrecio += $dfac_precio_tall;

                $i++;
            } while ($oIfx->SiguienteRegistro());

            $divTallos = $totalPrecio / $i;

            $deta .= ' <tr>';
            $deta .= ' <td style="font-size: 18px;"></td>';
            $deta .= ' <td style="font-size: 18px;"></td>';
            $deta .= ' <td style="font-size: 18px;"></td>';
            $deta .= ' <td style="font-size: 18px;"></td>';
            $deta .= ' <td style="font-size: 18px; font-weight: bold;">Totals:</td>';
            $deta .= ' <td style="font-size: 18px;"></td>';
            $deta .= ' <td style="font-size: 18px;" align="right"></td>';
            $deta .= ' <td style="font-size: 18px; font-weight: bold;" align="right">' . number_format($totalCajas, 0, '.', ',') . '</td>';
            $deta .= ' <td style="font-size: 18px;" align="right"></td>';
            $deta .= ' <td style="font-size: 18px; font-weight: bold;" align="right">' . number_format($totalTallos, 0, '.', ',') . '</td>';
            $deta .= ' <td style="font-size: 18px; font-weight: bold;" align="right">' . number_format($dfac_precio_tall, 2, '.', ',') . '</td>';
            $deta .= ' <td style="font-size: 18px; font-weight: bold;" align="right">' . number_format($granTotal, 2, '.', ',') . '</td>';
            $deta .= ' </tr>';

            if ($fact_iva > 0 || $fact_fle_fact > 0) {

                if ($fact_iva > 0) {
                    $deta .= ' <tr>';
                    $deta .= ' <td colspan="9"></td>';
                    $deta .= ' <td style="font-size: 17px; font-weight: bold;" align="right" colspan="2">IVA: </td>';
                    $deta .= ' <td style="font-size: 17px; font-weight: bold;" align="right">' . number_format($fact_iva, 2, '.', ',') . '</td>';
                    $deta .= ' </tr>';
                }//fin if

                if ($fact_fle_fact > 0) {
                    $deta .= ' <tr>';
                    $deta .= ' <td colspan="9"></td>';
                    $deta .= ' <td style="font-size: 17px; font-weight: bold;" align="right" colspan="2">FLETE: </td>';
                    $deta .= ' <td style="font-size: 17px; font-weight: bold;" align="right">' . number_format($fact_fle_fact, 2, '.', ',') . '</td>';
                    $deta .= ' </tr>';
                }//fin if

                $deta .= ' <tr>';
                $deta .= ' <td colspan="9"></td>';
                $deta .= ' <td style="font-size: 17px; font-weight: bold;" align="right" colspan="2">GRAND TOTAL: </td>';
                $deta .= ' <td style="font-size: 17px; font-weight: bold;" align="right">' . number_format($granTotal + $fact_iva + $fact_fle_fact, 2, '.', ',') . '</td>';
                $deta .= ' </tr>';
            }//fin if
        }
    }
    $oIfx->Free();

    $deta .= ' </table>';

    $sqlCajas = "select dfac_ord_caja, dfac_cod_caja, min(dfac_cod_dfact) as dfac_cod_dfact,
				(select sum( t.dfac_num_caja)  from saedfac t  where
				t.dfac_cod_fact   =  $id and
				t.dfac_cod_dfact = saedfac.dfac_cod_dfact	
				) as caja
				from saedfac where dfac_cod_fact = $id
				group by 1, 2 , 4 order by 2";

    if ($oIfx->Query($sqlCajas)) {
        if ($oIfx->NumFilas() > 0) {
            unset($arrayBoxs);
            unset($arrayBoxsValor);
            do {
                $dfac_ord_caja = $oIfx->f('dfac_ord_caja');
                $dfac_cod_caja = $oIfx->f('dfac_cod_caja');
                $dfac_cod_dfact = $oIfx->f('dfac_cod_dfact');
                $caja = $oIfx->f('caja');

                $arrayBoxs[$dfac_cod_caja] = array($dfac_cod_caja, $caja);
                $arrayBoxsValor[$dfac_cod_caja] += $caja;
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    if (count($arrayBoxs) > 0) {
        $totales .= '<table style="width: 100%; margin-top: 23px;">';
        $totales .= '<tr>';
        $totales .= '<td align="center" style="width: 16%; font-size: 16px;">Box Type</td>';
        $totales .= '<td align="center" style="width: 7%; font-size: 16px;">Qtty.</td>';
        $totales .= '<td align="center" style="width: 16%; font-size: 16px;">Weight Volume(KG)</td>';
        $totales .= '<td align="center" style="width: 16%; font-size: 16px;">Weight Gross(KG)</td>';
        $totales .= '</tr>';
        $totales .= '</table>';

        $totales .= '<table border="1" style="width: 100%; border-collapse: collapse;">';

        $totalBox = 0;
        $totalPesoNeto = 0;
        $totalPesoBruto = 0;
        foreach ($arrayBoxs as $val) {
            $codCaja = $val[0];
            $numCaja = $arrayBoxsValor[$codCaja];

            if (!empty($codCaja)) {
                $sqlCaja = "select caja_cant_caja, caja_fac_caja from saecaja where caja_cod_caja = $codCaja";
                if ($oIfx->Query($sqlCaja)) {
                    if ($oIfx->NumFilas() > 0) {
                        $caja_cant_caja = $oIfx->f('caja_cant_caja'); //peso neto
                        $caja_fac_caja = $oIfx->f('caja_fac_caja'); //peso bruto
                    }
                }
                $oIfx->Free();
            }

            $pesoNeto = $numCaja * $caja_cant_caja;
            $pesoBruto = $numCaja * $caja_fac_caja;

            $totales .= '<tr>';
            $totales .= '<td style="width: 16%; font-size: 18px;" align="left">' . $arrayCaja[$codCaja] . '</td>';
            $totales .= '<td style="width: 7%; font-size: 18px;" align="right">' . number_format($arrayBoxsValor[$codCaja], 2, '.', ',') . '</td>';
            $totales .= '<td style="width: 16%; font-size: 18px;" align="right">' . number_format($pesoNeto, 2, '.', ',') . '</td>';
            $totales .= '<td style="width: 16%; font-size: 18px;" align="right">' . number_format($pesoBruto, 2, '.', ',') . '</td>';
            $totales .= '</tr>';

            $totalBox += $numCaja;
            $totalPesoNeto += $pesoNeto;
            $totalPesoBruto += $pesoBruto;
        }//fin foreach
        $totales .= '<tr>';
        $totales .= '<td style="font-size: 18px; font-weight: bold;" align="left">FULL TOTAL</td>';
        $totales .= '<td style="font-size: 18px; font-weight: bold;" align="right">' . number_format($totalBox, 2, '.', ',') . '</td>';
        $totales .= '<td style="font-size: 18px; font-weight: bold;" align="right">' . number_format($totalPesoNeto, 2, '.', ',') . '</td>';
        $totales .= '<td style="font-size: 18px; font-weight: bold;" align="right">' . number_format($totalPesoBruto, 2, '.', ',') . '</td>';
        $totales .= '</tr>';
        $totales .= '</table>';

        $totales .= '<table border="1" style="border-collapse: collapse; width: 100%;" align="right">';
        $totales .= '<tr>';
        $totales .= '<td style="font-size: 18px; font-weight: bold; width: 43%;" align="left">"The flowers and plants on this invoices were grown in Ecuador"</td>';
        $totales .= '</tr>';
        $totales .= '</table>';
    }//fin if
    //firmas
    $firmas .= '<table style="width: 90%; margin-top: 100px;" align="center">';
    $firmas .= '<tr>';
    $firmas .= '<td style="width:20%;" align="center">_________________________</td>';
    $firmas .= '<td style="width:15%;" align="center"></td>';
    $firmas .= '<td style="width:20%;" align="center">_________________________</td>';
    $firmas .= '<td style="width:15%;" align="center"></td>';
    $firmas .= '<td style="width:20%;" align="center">_________________________</td>';
    $firmas .= '</tr>';
    $firmas .= '<tr>';
    $firmas .= '<td style="width:20%; font-size: 19px;" align="center">Authorized</td>';
    $firmas .= '<td style="width:15%; font-size: 19px;" align="center"></td>';
    $firmas .= '<td style="width:20%; font-size: 19px;" align="center">Reviewed</td>';
    $firmas .= '<td style="width:15%; font-size: 19px;" align="center"></td>';
    $firmas .= '<td style="width:20%; font-size: 19px;" align="center">Received</td>';
    $firmas .= '</tr>';
    $firmas .= '</table>';

    $documento .= '<page backtop="10mm" backbottom="10mm" backleft="5mm" backright="10mm">';
    $documento .= $logo . $cliente . $deta . $totales . $firmas;
    $documento .= '</page>';

    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;


    //eliminaArchivos(DIR_FACTELEC . 'Include/archivos/');

    return $documento;
}

function reporte_factura_commercial($id = '', $nombre_archivo = '', &$rutaPdf = '')
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    //variables de session
    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_nom_empr, empr_ruc_empr , empr_dir_empr, 
			empr_mai_empr, empr_tel_resp, empr_path_logo, empr_fax_empr,
			empr_cod_cesa, empr_cod_aduna
			from saeempr where empr_cod_empr = $idEmpresa";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            $empr_mai_empr = $oIfx->f('empr_mai_empr');
            $empr_tel_resp = $oIfx->f('empr_tel_resp');
            $empr_fax_empr = $oIfx->f('empr_fax_empr');
            $empr_cod_cesa = $oIfx->f('empr_cod_cesa');
            $empr_cod_aduna = $oIfx->f('empr_cod_aduna');
        }
    }
    $oIfx->Free();

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis  
			from saesucu 
			where sucu_cod_empr = $idEmpresa and 
			sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
        }
    }
    $oIfx->Free();

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }


    $sqlFac = "select * from saefact where fact_cod_fact = $id and fact_cod_sucu = $idSucursal and fact_cod_empr = $idEmpresa";

    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {

            $fact_num_preimp = $oIfx->f('fact_num_preimp');
            $fact_fech_fact = fecha_mysql_func($oIfx->f('fact_fech_fact'));
            $fact_nse_fact = $oIfx->f('fact_nse_fact');
            $fact_auto_sri = $oIfx->f('fact_auto_sri');
            $fact_fech_sri = $oIfx->f('fact_fech_sri');
            $fact_nom_cliente = $oIfx->f('fact_nom_cliente');
            $fact_ruc_clie = $oIfx->f('fact_ruc_clie');
            $fact_tlf_cliente = $oIfx->f('fact_tlf_cliente');
            $fact_dir_clie = htmlentities($oIfx->f('fact_dir_clie'));
            $fact_email_clpv = $oIfx->f('fact_email_clpv');
            $fact_con_miva = $oIfx->f('fact_con_miva');
            $fact_sin_miva = $oIfx->f('fact_sin_miva');
            $fact_tot_fact = $oIfx->f('fact_tot_fact');
            $fact_iva = $oIfx->f('fact_iva');
            $fact_clav_sri = $oIfx->f('fact_clav_sri');
            $fact_msn = $oIfx->f('fact_cm1_fact');
            $fact_term_expor = $oIfx->f('fact_term_expor');
            $fact_cod_pais = $oIfx->f('fact_cod_pais');
            $fact_cod_ffue = $oIfx->f('fact_cod_ffue');
            $fact_fec_emb = fecha_mysql_func($oIfx->f('fact_fec_emb'));
            $fact_prto_emb = $oIfx->f('fact_prto_emb');
            $fact_prto_dest = $oIfx->f('fact_prto_dest');
            $fact_fle_fact = $oIfx->f('fact_fle_fact');
            $fact_otr_fact = $oIfx->f('fact_otr_fact');
            $fact_fin_fact = $oIfx->f('fact_fin_fact');
            $fact_awb_fact = $oIfx->f('fact_awb_fact');
            $fact_hawb_fact = $oIfx->f('fact_hawb_fact');
            $fact_cod_ccli = $oIfx->f('fact_cod_ccli');
            $fact_cod_clpv = $oIfx->f('fact_cod_clpv');
            $fact_cod_acar = $oIfx->f('fact_cod_acar');
            $fact_cod_laer = $oIfx->f('fact_cod_laer');
            $fact_cod_cufr = $oIfx->f('fact_cod_cufr');
            $fact_cod_empl = $oIfx->f('fact_cod_empl');

            if (!empty($fact_cod_ccli)) {
                $sqlCcli = "select ccli_cod_ccli, ccli_nom_conta, ccli_dire_ccli, ccli_tlf1_ccli
						from saeccli
						where ccli_cod_clpv = $fact_cod_clpv and
						ccli_cod_ccli = $fact_cod_ccli and
						ccli_cod_empr = $idEmpresa";
                if ($oIfxA->Query($sqlCcli)) {
                    if ($oIfxA->NumFilas() > 0) {
                        $ccli_nom_conta = $oIfxA->f('ccli_nom_conta');
                        $ccli_dire_ccli = $oIfxA->f('ccli_dire_ccli');
                        $ccli_tlf1_ccli = $oIfxA->f('ccli_tlf1_ccli');
                    }
                }
                $oIfxA->Free();
            } else {
                $ccli_nom_conta = $fact_nom_cliente;
                $ccli_dire_ccli = $fact_dir_clie;
                $ccli_tlf1_ccli = $fact_tlf_cliente;
            }


            //PAIS
            if (empty($fact_cod_pais)) {
                $fact_cod_pais = 0;
            }

            $sql_pais = "select pais_des_pais from saepais where pais_cod_pais = $fact_cod_pais";
            $pais = consulta_string_func($sql_pais, 'pais_des_pais', $oIfxA, '--');

            //EMBARQUE ORIGEN
            $sql_emb_1 = "select prto_des_prto from saeprto where prto_cod_prto = $fact_prto_emb";
            $prto_1 = consulta_string_func($sql_emb_1, 'prto_des_prto', $oIfxA, '--');

            //EMBARQUE DESTINO
            $sql_emb_2 = "select prto_des_prto from saeprto where prto_cod_prto = $fact_prto_dest";
            $prto_2 = consulta_string_func($sql_emb_2, 'prto_des_prto', $oIfxA, '--');

            if ($fact_prto_dest == 9) {
                $term = $fact_term_expor . '-' . $prto_2;
            } else {
                $term = $fact_term_expor;
            }
            // DAE
            $sql_fue = "select ffue_fue_ffue    from saeffue where
							ffue_cod_ffue  = '$fact_cod_ffue' ";
            $dae = consulta_string_func($sql_fue, 'ffue_fue_ffue', $oIfxA, '');

            //agencia carguera
            if (empty($fact_cod_acar)) {
                $fact_cod_acar = 0;
            }

            $sqlAcar = "select acar_nom_acar from saeacar where acar_cod_acar = $fact_cod_acar";
            $acar_nom_acar = consulta_string($sqlAcar, 'acar_nom_acar', $oIfxA, '');

            //linea aerea
            if (empty($fact_cod_laer)) {
                $fact_cod_laer = 0;
            }

            $sqlLaer = "select laer_nom_laer from saelaer where laer_cod_laer = $fact_cod_laer";
            $laer_nom_laer = consulta_string($sqlLaer, 'laer_nom_laer', $oIfxA, '');

            //fue
            if (empty($fact_term_expor)) {
                $fact_term_expor = 0;
            }

            $sqlTerm = "select nombre from incoterm where id = $fact_term_expor";
            $incoterm = consulta_string($sqlTerm, 'nombre', $oCon, '');

            //cuarto frio
            if (empty($fact_cod_cufr)) {
                $fact_cod_cufr = 0;
            }

            $sqlCFrio = "select cufr_nom_cufr from saecufr where cufr_cod_cufr = $fact_cod_cufr";
            $cufr_nom_cufr = consulta_string($sqlCFrio, 'cufr_nom_cufr', $oIfxA, '');

            //query empleado
            $sqlEmpleado = "select empl_ape_nomb from saeempl where empl_cod_empl = '$fact_cod_empl'";
            $empl_ape_nomb = consulta_string($sqlEmpleado, 'empl_ape_nomb', $oIfxA, '');

            //farm code
            if ($fact_cod_pais == 8) {
                $farmCode = $empr_cod_aduna;
            } else {
                $farmCode = $empr_cod_cesa;
            }

            $logo .= '<table style="width: 100%;" align="center">';
            $logo .= '<tr>';
            $logo .= '<b><td style="font-size: 24px">COMMERCIAL INVOICE No. ' . $fact_num_preimp . '</td></b>';
            $logo .= '</tr>';
            $logo .= '</table>';
            $logo .= '<table style="width: 100%; margin-top: 10px;" align="center">';
            $logo .= '<tr>';

            $logo .= '<td style="width: 50%;" align="left" valign="top">';
            $logo .= '<table style="width: 100%;">';
            $logo .= '<tr>';
            $logo .= '<td align="center" style="font-size: 16px; font-weight: bold; width: 100%;">Shipper Name and Address</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td style="font-size: 22px; font-weight: bold; border-top: 1px solid #000; border-left: 1px solid #000; border-right: 1px solid #000;">' . $razonSocial . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td style="font-size: 20px; border-left: 1px solid #000; border-right: 1px solid #000;">' . $dirMatriz . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td style="font-size: 20px; font-weight: bold; border-left: 1px solid #000; border-right: 1px solid #000;">QUITO - ECUADOR</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td style="font-size: 20px; font-weight: bold; border-bottom: 1px solid #000; border-left: 1px solid #000; border-right: 1px solid #000;">PHONE: ' . $empr_tel_resp . ' &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FAX: ' . $empr_fax_empr . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td align="center" style="font-size: 16px; font-weight: bold; width: 100%;">Marketing Name</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td align="center" valign="middle" style="font-size: 22px; font-weight: bold; border: 1px solid #000; height: 40px;">KIARA FLOWERS</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td align="center" style="font-size: 16px; font-weight: bold; width: 100%;">Consignee Name and Address</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td style="font-size: 22px; font-weight: bold; border-top: 1px solid #000; border-left: 1px solid #000; border-right: 1px solid #000;">' . $ccli_nom_conta . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td style="font-size: 22px; border-left: 1px solid #000; border-right: 1px solid #000; width: 100%;">' . $ccli_dire_ccli . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td style="font-size: 22px; border-left: 1px solid #000; border-right: 1px solid #000;">' . $pais . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td style="font-size: 22px; border-left: 1px solid #000; border-right: 1px solid #000;">' . $prto_2 . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td style="font-size: 22px; border-left: 1px solid #000; border-right: 1px solid #000;">PHONE: ' . $ccli_tlf1_ccli . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td style="font-size: 22px; border-left: 1px solid #000; border-right: 1px solid #000;">FAX:</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td style="font-size: 22px; border-bottom: 1px solid #000; border-left: 1px solid #000; border-right: 1px solid #000;">ATT:</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td style="font-size: 18px;">Consigment: <span style="border-bottom: 1px solid #000;"> </span> </td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td style="font-size: 18px;">Fixed Price: <span style="border-bottom: 1px solid #000;"> X </span> </td>';
            $logo .= '</tr>';
            $logo .= '</table>';
            $logo .= '</td>';

            $logo .= '<td style="width: 50%;" align="right" valign="top">';
            $logo .= '<table style="width: 100%;">';
            $logo .= '<tr>';
            $logo .= '<td align="center" style="font-size: 16px; font-weight: bold; width: 50%;">Farm Code</td>';
            $logo .= '<td align="center" style="font-size: 16px; font-weight: bold; width: 50%;">Date</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td align="center" style="font-size: 22px; width: 50%; border: 1px solid #000; height: 21px;">' . $farmCode . '</td>';
            $logo .= '<td align="center" style="font-size: 22px; width: 50%; border: 1px solid #000;">' . $fact_fech_fact . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr><td colspan="2"></td></tr>';
            $logo .= '<tr><td colspan="2"></td></tr>';
            $logo .= '<tr>';
            $logo .= '<td align="center" style="font-size: 16px; font-weight: bold; width: 50%;">Incoterm</td>';
            $logo .= '<td align="center" style="font-size: 16px; font-weight: bold; width: 50%;">Country Code</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td align="center" style="font-size: 22px; width: 50%; border: 1px solid #000; height: 21px;">' . $incoterm . '</td>';
            $logo .= '<td align="center" style="font-size: 22px; width: 50%; border: 1px solid #000;">EC</td>';
            $logo .= '</tr>';
            $logo .= '<tr><td colspan="2"></td></tr>';
            $logo .= '<tr><td colspan="2"></td></tr>';
            $logo .= '<tr>';
            $logo .= '<td align="center" style="font-size: 16px; font-weight: bold; width: 100%; height: 21px;" colspan="2">Master AWB No.</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td align="center" style="font-size: 22px; border: 1px solid #000; height: 21px;" colspan="2">' . $fact_awb_fact . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr><td colspan="2"></td></tr>';
            $logo .= '<tr><td colspan="2"></td></tr>';
            $logo .= '<tr>';
            $logo .= '<td align="center" style="font-size: 16px; font-weight: bold; width: 100%; height: 21px;" colspan="2">House AWB No.</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td align="center" style="font-size: 22px; border: 1px solid #000; height: 21px;" colspan="2">' . $fact_hawb_fact . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr><td colspan="2"></td></tr>';
            $logo .= '<tr><td colspan="2"></td></tr>';
            $logo .= '<tr>';
            $logo .= '<td align="center" style="font-size: 16px; font-weight: bold; width: 100%; height: 21px;" colspan="2">Airline</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td align="center" style="font-size: 22px; border: 1px solid #000; height: 21px;" colspan="2">' . $laer_nom_laer . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr><td colspan="2"></td></tr>';
            $logo .= '<tr><td colspan="2"></td></tr>';
            $logo .= '<tr>';
            $logo .= '<td align="center" style="font-size: 16px; font-weight: bold; width: 100%; height: 21px;" colspan="2">Freight Forwarder</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td align="center" style="font-size: 22px; border: 1px solid #000; height: 21px;" colspan="2">' . $acar_nom_acar . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr><td colspan="2"></td></tr>';
            $logo .= '<tr><td colspan="2"></td></tr>';
            $logo .= '<tr>';
            $logo .= '<td align="center" style="font-size: 16px; font-weight: bold; width: 50%;">R.U.C. No.</td>';
            $logo .= '<td align="center" style="font-size: 16px; font-weight: bold; width: 50%;">DAE No.</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td align="center" style="font-size: 22px; width: 50%; border: 1px solid #000; height: 21px;">' . $ruc_empr . '</td>';
            $logo .= '<td align="center" style="font-size: 22px; width: 50%; border: 1px solid #000; height: 21px;">' . $dae . '</td>';
            $logo .= '</tr>';
            $logo .= '</table>';
            $logo .= '</td>';
            $logo .= '</tr>';
            $logo .= '</table>';
        }
    }
    $oIfx->Free();

    //query caja
    $sqlCaja = "select caja_cod_caja, caja_nom_caja from saecaja where caja_cod_finc = $idEmpresa";
    if ($oIfx->Query($sqlCaja)) {
        if ($oIfx->NumFilas() > 0) {
            unset($arrayCaja);
            do {
                $arrayCaja[$oIfx->f('caja_cod_caja')] = $oIfx->f('caja_nom_caja');
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    //query grupo
    $sqlGrpr = "select grpr_cod_grpr, grpr_des_grpr from saegrpr where grpr_cod_empr = $idEmpresa";
    if ($oIfx->Query($sqlGrpr)) {
        if ($oIfx->NumFilas() > 0) {
            unset($arrayGrpr);
            do {
                $arrayGrpr[$oIfx->f('grpr_cod_grpr')] = $oIfx->f('grpr_des_grpr');
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    //query marca
    $sqlMarc = "select marc_cod_marc, marc_des_marc from saemarc where  marc_cod_empr = $idEmpresa";
    if ($oIfx->Query($sqlMarc)) {
        if ($oIfx->NumFilas() > 0) {
            unset($arrayMarc);
            do {
                $arrayMarc[$oIfx->f('marc_cod_marc')] = $oIfx->f('marc_des_marc');
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    $sqlDeta = "select * from saedfac 
				where dfac_cod_fact = $id and 
				dfac_cod_sucu = $idSucursal and 
				dfac_cod_empr = $idEmpresa 
				order by dfac_num_caja, dfac_cod_caja, dfac_cod_dfact";
    if ($oIfx->Query($sqlDeta)) {
        if ($oIfx->NumFilas() > 0) {
            $totalCajas = 0;
            $totalTallos = 0;
            $granTotal = 0;
            unset($arrayBoxs);
            unset($arrayTallos);
            unset($arrayTallosTotal);
            unset($arrayValorCaja);
            do {
                $dfac_cod_prod = $oIfx->f('dfac_cod_prod');
                $dfac_nom_prod = $oIfx->f('dfac_nom_prod');
                $dfac_cant_dfac = $oIfx->f('dfac_cant_dfac');
                $dfac_precio_dfac = $oIfx->f('dfac_precio_dfac');
                $dfac_des1_dfac = $oIfx->f('dfac_des1_dfac');
                $dfac_des2_dfac = $oIfx->f('dfac_des2_dfac');
                $dfac_por_dsg = $oIfx->f('dfac_por_dsg');
                $dfac_mont_total = $oIfx->f('dfac_mont_total');
                $dfac_cod_alt = $oIfx->f('dfac_cod_alt');
                $dfac_num_caja = round($oIfx->f('dfac_num_caja'));
                $dfac_cod_caja = $oIfx->f('dfac_cod_caja');
                $dfac_cod_grpr = $oIfx->f('dfac_cod_grpr');
                $dfac_cod_marc = $oIfx->f('dfac_cod_marc');
                $dfac_precio_tall = $oIfx->f('dfac_precio_tall');

                $arrayValorCaja[$dfac_cod_caja] += $dfac_num_caja;

                $descuento = $dfac_des1_dfac + $dfac_des2_dfac + $dfac_por_dsg;
                if ($descuento > 0)
                    $descuento = ($dfac_precio_dfac * $dfac_cant_dfac) - ($dfac_mont_total);
                else
                    $descuento = 0;

                $totalDescuento = $totalDescuento + $descuento;

                //tallos
                $tallos = $dfac_cant_dfac * $arrayMarc[$dfac_cod_marc];

                //array cajas
                $arrayBoxs[$dfac_cod_caja] = array($dfac_num_caja, $dfac_cod_caja, $dfac_cant_dfac, $tallos, $dfac_precio_tall, $dfac_mont_total);

                $arrayTallos[$dfac_cod_caja] += $tallos;
                $arrayTallosTotal[$dfac_cod_caja] += $dfac_mont_total;
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    $sqlCajas = "select dfac_ord_caja, dfac_cod_caja, min(dfac_cod_dfact) as dfac_cod_dfact,
				(select sum( t.dfac_num_caja)  from saedfac t  where
				t.dfac_cod_fact   =  $id and
				t.dfac_cod_dfact = saedfac.dfac_cod_dfact	
				) as caja
				from saedfac where dfac_cod_fact = $id
				group by 1, 2 , 4 order by 2";

    if ($oIfx->Query($sqlCajas)) {
        if ($oIfx->NumFilas() > 0) {
            unset($arrayBoxs_);
            unset($arrayBoxsValor_);
            do {
                $dfac_ord_caja = $oIfx->f('dfac_ord_caja');
                $dfac_cod_caja = $oIfx->f('dfac_cod_caja');
                $dfac_cod_dfact = $oIfx->f('dfac_cod_dfact');
                $caja = $oIfx->f('caja');

                $arrayBoxs_[$dfac_cod_caja] = array($dfac_cod_caja, $caja);
                $arrayBoxsValor_[$dfac_cod_caja] += $caja;
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    if (count($arrayBoxs) > 0) {
        $totales .= '<table border="1" style="width: 100%; border-collapse: collapse; margin-top: 30px;" align="center">';
        $totales .= '<tr>';
        $totales .= ' <b> <td align="center" style="width: 8%; font-size: 15px;">Pieces Type</td> </b>';
        $totales .= ' <b> <td align="center" style="width: 7%; font-size: 15px;">Total Pieces</td> </b>';
        $totales .= ' <b> <td align="center" style="width: 10%; font-size: 15px;">Eq. Full Boxes</td> </b>';
        $totales .= ' <b> <td align="center" style="width: 18%; font-size: 15px;">Product Description</td> </b>';
        $totales .= ' <b> <td align="center" style="width: 5%; font-size: 15px;">SPI</td> </b>';
        $totales .= ' <b> <td align="center" style="width: 8%; font-size: 15px;">HTS #</td> </b>';
        $totales .= ' <b> <td align="center" style="width: 8%; font-size: 15px;">NANDINA</td> </b>';
        $totales .= ' <b> <td align="center" style="width: 8%; font-size: 15px;">Total Units</td> </b>';
        $totales .= ' <b> <td align="center" style="width: 8%; font-size: 15px;">Stems / Bunch</td> </b>';
        $totales .= ' <b> <td align="center" style="width: 7%; font-size: 15px;">Unit Price</td> </b>';
        $totales .= ' <b> <td align="center" style="width: 8%; font-size: 15px;">Total Value USD</td> </b>';
        $totales .= '</tr>';
        $totalBox = 0;
        $totalUnits = 0;
        $totalSumas = 0;
        $totalPesoNeto = 0;
        $totalPesoBruto = 0;
        foreach ($arrayBoxs as $val) {
            $codCaja = $val[1];
            $dfac_cant_dfac = $val[2];
            $tallos = $val[3];
            $dfac_precio_tall = $val[4];
            $dfac_mont_total = $val[5];

            $numCaja = $arrayBoxsValor_[$codCaja];

            if (!empty($codCaja)) {
                $sqlCaja = "select caja_cant_caja, caja_fac_caja from saecaja where caja_cod_caja = $codCaja";
                if ($oIfx->Query($sqlCaja)) {
                    if ($oIfx->NumFilas() > 0) {
                        $caja_cant_caja = $oIfx->f('caja_cant_caja'); //peso neto
                        $caja_fac_caja = $oIfx->f('caja_fac_caja'); //peso bruto
                    }
                }
                $oIfx->Free();
            }

            $pesoNeto = $numCaja * $caja_cant_caja;
            $pesoBruto = $numCaja * $caja_fac_caja;

            $totales .= '<tr>';
            $totales .= '<td style="font-size: 18px;" align="left">' . substr($arrayCaja[$codCaja], 0, 8) . '</td>';
            $totales .= '<td style="font-size: 18px;" align="right">' . $arrayBoxsValor_[$codCaja] . '</td>';
            $totales .= '<td style="font-size: 18px;" align="right">' . $arrayBoxsValor_[$codCaja] . '</td>';
            $totales .= '<td style="font-size: 18px;" align="left">Rosas Preservadas</td>';
            $totales .= '<td style="font-size: 18px;" align="left"></td>';
            $totales .= '<td style="font-size: 18px;" align="left">0603.90.00.00</td>';
            $totales .= '<td style="font-size: 18px;" align="left">0603.90.00.00</td>';
            $totales .= '<td style="font-size: 18px;" align="right">' . number_format($arrayTallos[$codCaja], 0, '.', ',') . '</td>';
            $totales .= '<td style="font-size: 18px;" align="left">Stems</td>';
            $totales .= '<td style="font-size: 18px;" align="right">' . number_format($dfac_precio_tall, 2, '.', ',') . '</td>';
            $totales .= '<td style="font-size: 18px;" align="right">' . number_format($arrayTallosTotal[$codCaja], 2, '.', ',') . '</td>';
            $totales .= '</tr>';

            $totalBox += $numCaja;
            $totalUnits += $arrayTallos[$codCaja];
            $totalSumas += $arrayTallosTotal[$codCaja];
            $totalPesoNeto += $pesoNeto;
            $totalPesoBruto += $pesoBruto;
        }//fin foreach
        $totales .= '<tr>';
        $totales .= '<td style="font-size: 16px; font-weight: bold; border-left: 0px; border-bottom: 0px;" align="left">TOTAL</td>';
        $totales .= '<td style="font-size: 16px; font-weight: bold;" align="right">' . $totalBox . '</td>';
        $totales .= '<td style="font-size: 16px; font-weight: bold;" align="right">' . $totalBox . '</td>';
        $totales .= '<td style="font-size: 16px; border-left: 0px; border-bottom: 0px;"" align="left" colspan="4">Weight Volume: ' . $totalPesoNeto . ' Kg. &nbsp;&nbsp; Weight Gross: ' . $totalPesoBruto . ' Kg.</td>';
        $totales .= '<td style="font-size: 16px; font-weight: bold;" align="right">' . number_format($totalUnits, 0, '.', ',') . '</td>';
        $totales .= '<td style="font-size: 16px; font-weight: bold;" align="left">Stems</td>';
        $totales .= '<td style="font-size: 16px; font-weight: bold; border-left: 0px; border-bottom: 0px;"" align="right"></td>';
        $totales .= '<td style="font-size: 16px; font-weight: bold;" align="right">' . number_format($totalSumas, 2, '.', ',') . '</td>';
        $totales .= '</tr>';
        $totales .= '</table>';
    }//fin if
    //firmas
    $firmas .= '<page_footer>';
    $firmas .= '<table style="width: 100%; margin-top: 100px;" align="center">';
    $firmas .= '<tr>';
    $firmas .= '<td align="left" style="width: 5%; font-weight: bold; font-size: 14px;">Bill To:</td>';
    $firmas .= '<td align="left" style="border: 1px solid #000; width: 45%; height: 17px; font-size: 20px;">' . $ccli_nom_conta . '</td>';
    $firmas .= '<td style="width: 50%; border: 1px inset black; font-size: 19px; font-weight: bold;" align="left" valign="top" rowspan="2">"The flowers and plants on this invoices were grown in Ecuador"</td>';
    $firmas .= '</tr>';
    $firmas .= '<tr>';
    $firmas .= '<td align="center" style="font-weight: bold; height: 19px; font-size: 16px;" colspan="2">Name and Title of Person Preparing invoice</td>';
    $firmas .= '</tr>';
    $firmas .= '<tr>';
    $firmas .= '<td align="left" style="border: 1px inset black; height: 17px; font-size: 20px;" colspan="2">MARIA CLARA RIOFRIO &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SALES ASSISTANT</td>';
    $firmas .= '</tr>';
    $firmas .= '<tr>';
    $firmas .= '<td style="border: 1px inset black; height: 70px;" colspan="2"></td>';
    $firmas .= '<td style="border: 1px inset black; height: 70px;"></td>';
    $firmas .= '</tr>';
    $firmas .= '<tr>';
    $firmas .= '<td align="center" style="border: 1px inset black; font-size: 16px;" colspan="2">Customs Use Only</td>';
    $firmas .= '<td align="center" style="border: 1px inset black; font-size: 16px;">USDA. Aphis P.P.Q Use Only</td>';
    $firmas .= '</tr>';
    $firmas .= '</table>';
    $firmas .= '</page_footer>';

    $documento .= '<page backtop="10mm" backbottom="10mm" backleft="10mm" backright="10mm">';
    $documento .= $logo . $cliente . $deta . $totales;
    $documento .= $firmas;
    $documento .= '</page>';

    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;


    //eliminaArchivos(DIR_FACTELEC . 'Include/archivos/');

    return $documento;
}

function reporte_factura_export($id = '', $nombre_archivo = '', $idSucursal ='', &$rutaPdf = '') {
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    //$idSucursal = $_SESSION['U_SUCURSAL'];

    //CAMPOS APROBACION
    $sqlgein="SELECT count(*) as conteo
     FROM INFORMATION_SCHEMA.COLUMNS
     WHERE COLUMN_NAME = 'empr_fac_empr' AND TABLE_NAME = 'saeempr'";
    $ctralter=consulta_string($sqlgein,'conteo',$oCon,0);
    if($ctralter==0){
        $sqlalter="alter table saeempr add  empr_fac_empr varchar(1)";
        $oCon->QueryT($sqlalter);
    }


    $sqlgein="SELECT count(*) as conteo
     FROM INFORMATION_SCHEMA.COLUMNS
     WHERE COLUMN_NAME = 'empr_det_fac' AND TABLE_NAME = 'saeempr'";
    $ctralter=consulta_string($sqlgein,'conteo',$oCon,0);
    if($ctralter==0){
        $sqlalter="alter table saeempr add  empr_det_fac text";
        $oCon->QueryT($sqlalter);
    }

    //VALIDAICON DETALLE

    $sqlfa="select para_dfa_para from saepara where para_cod_empr= $idEmpresa and para_cod_sucu=$idSucursal";
    $para_dfa_para=consulta_string($sqlfa,'para_dfa_para',$oCon,'');

    $sqlfa="select empr_fac_empr, empr_det_fac from saeempr where empr_cod_empr=$idEmpresa ";
    $obfact=consulta_string($sqlfa,'empr_fac_empr',$oCon,'');
    $obdetfact=consulta_string($sqlfa,'empr_det_fac',$oCon,'');

    $sql = "select empr_sn_conta, empr_cod_pais,empr_cm1_empr, empr_rimp_sn, empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr,empr_tel_resp, empr_ac1_empr, empr_ac2_empr, empr_mai_empr, empr_tip_empr
                                            from saeempr where empr_cod_empr = $idEmpresa ";


    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            $tel_empresa = $oIfx->f('empr_tel_resp');
            $empr_mai_empr = $oIfx->f('empr_mai_empr');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';
            $empr_rimp_sn = $oIfx->f('empr_rimp_sn');
            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
            $empr_ac1_empr = $oIfx->f('empr_ac1_empr');
            $empr_ac2_empr = $oIfx->f('empr_ac2_empr');
            $empr_cm1_empr = $oIfx->f('empr_cm1_empr');
            $empr_cod_pais = $oIfx->f('empr_cod_pais');
            $empr_tip_empr = $oIfx->f('empr_tip_empr');
            $empr_sn_conta = $oIfx->f('empr_sn_conta');
        }
    }
    $oIfx->Free();

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis, sucu_telf_secu  from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
            $sucu_telf_secu = $oIfx->f('sucu_telf_secu');
        }
    }
    $oIfx->Free();

    //VALIDACION SUSCURSALES

    $sqls="select count(*) as cont from saesucu";
    $contsucu=consulta_string($sqls,'cont',$oIfx,0);

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }

    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;



    // $path_logo_img = DIR_FACTELEC . 'imagenes/logos/' . $path_img[$count];
    $path_logo_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];
    if (file_exists($path_logo_img)) {
        //echo "El fichero $nombre_fichero existe";
    } else {
        //echo "El fichero $nombre_fichero no existe";
        $path_logo_img = "https://turbologo.com/articles/wp-content/uploads/2019/05/no-logo.png";
    }
    
    
    $logo .= '<table style="width: 100%; margin: 0px;">';
    $logo .= '<tr>';
    $logo .= '<td align="center" style="width: 55%; border:1px solid black; border-radius: 5px; margin: 0px;">';
    $logo .= '<table width: 55%; valign="center" style="margin: 0px;">';
    $logo .= '<tr><td style="margin-top: 0px;"><img width="250px;"  src="' . $path_logo_img . '"></td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="left" style="font-size: 15px;" width="300"><b>Emisor:</b> ' . $razonSocial . '</td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>RUC:</b> ' . $ruc_empr . '</td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="left" style="font-size: 13px;" width="500"><b>Matriz:</b> ' . $dirMatriz . '</td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';


    //selecciona sucursales y direcciones
    $sql_sucu_matriz = "select sucu_dir_sucu from saesucu where sucu_nom_sucu ='MATRIZ'";
    $matriz = consulta_string($sql_sucu_matriz, 'sucu_dir_sucu', $oIfx, '');
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    $emprce="select empr_num_resu from saeempr where empr_cod_empr=$idEmpresa";
    $contribuyente= consulta_string($emprce, 'empr_num_resu', $oIfx, '');
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                //$logo .= '<tr><td align="center" style="font-size: 12px">' . $sucu_nom_sucu . ': ' . htmlentities($sucu_dir_sucu) . '</td></tr>';
                //$logo .= '<tr><td align="center" style="font-size: 13px">SUCURSAL : ' . $sucu_nom_sucu . '</td></tr>';

                ///$logo .= '<tr><td style="position:top; width:50px;"><h4>Direccion Matriz:</h4></td></tr><br>';
                //$logo .= '<tr><td>' . htmlentities($dirMatriz) . '</td></tr>';
                if( $contsucu>1){
                    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>Sucursal:</b> ' . $sucu_nom_sucu . '</td></tr>';

                    $logo .= '<tr><td align="left" style="font-size: 13px;" width="500" ><b>Direcci&oacute;n Sucursal:</b>' . $sucu_dir_sucu.'</td></tr>';
                }





            } while ($oIfx->SiguienteRegistro());
        }
    }
    //$logo .= '<tr><td>&nbsp;</td></tr>';

    //DATOS ADICIONALES
    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>Correo:</b> ' .  $empr_mai_empr . '</td></tr>';

    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>Tel&eacute;fono:</b> ' . $sucu_telf_secu . '</td></tr>';


    if ($empr_tip_empr == 'S') {
        $logo .= '<tr><td align="left" style="font-size: 12px;"><b>Contribuyente Especial #:</b> ' . $empr_num_resu . '</td></tr>';
    }//fin if*/
    /*if($empr_conta_sn=='SI'){
        $logo .= '<tr><td align="center" style="font-size: 12px;"><b>Contribuyente Especial #:</b> '.$contribuyente.'</td></tr>';
    }*/

    if(!empty($empr_ac2_empr)){
        $empr_ac2_empr = '<b>Agente de Retención Resolución Nro:</b> '.$empr_ac2_empr;
    }
    /*else{
        $empr_ac2_empr ='<b>AGENTE DE RETENCI&Oacute;N:</b> NO';
    }*/


    if($empr_conta_sn=='SI'){
        if($empr_sn_conta=='S'){
            $empr_sn_conta ='SI';
        }
        else{
            $empr_sn_conta ='NO';
        }
        $logo .= '<tr><td align="left" style="font-size: 12px;"><b>Obligado a llevar Contabilidad :</b> ' . $empr_sn_conta . '</td></tr>';
    }
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    if($empr_rimp_sn=="S"){
        $logo .= '<tr><td align="left" style="font-size: 12px;"><b>CONTRIBUYENTE R&Eacute;GIMEN RIMPE</b></td></tr>';
    }
    $logo .= '<tr><td align="left" style="font-size: 12px;">'.$empr_ac2_empr.'</td></tr>';

    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= ' </table>';
    $logo .= '</td>';

    $sqlFac = "select * from saefact where fact_cod_fact = $id;";

    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $fact_nse_fact = $oIfx->f('fact_nse_fact');
                $fact_num_preimp = $oIfx->f('fact_num_preimp');
                $fact_auto_sri = $oIfx->f('fact_auto_sri');
                $fact_fech_sri = $oIfx->f('fact_fech_sri');
                $fact_nom_cliente = $oIfx->f('fact_nom_cliente');
                $fact_fech_fact = fecha_mysql_func($oIfx->f('fact_fech_fact'));
                $fact_ruc_clie = $oIfx->f('fact_ruc_clie');
                $fact_tlf_cliente = $oIfx->f('fact_tlf_cliente');
                $fact_dir_clie = htmlentities($oIfx->f('fact_dir_clie'));
                $fact_email_clpv = str_replace(' ', '', $oIfx->f("fact_email_clpv"));
                $fact_con_miva = $oIfx->f('fact_con_miva');
                $fact_sin_miva = $oIfx->f('fact_sin_miva');
                $fact_tot_fact = $oIfx->f('fact_tot_fact');
                $fact_iva = $oIfx->f('fact_iva');
                $fact_ice = $oIfx->f('fact_ice');
                $fact_clav_sri  = $oIfx->f('fact_clav_sri');
                $fact_dsg_valo  = $oIfx->f('fact_dsg_valo');
                $fact_cm1_fact  = trim($oIfx->f("fact_cm1_fact"));
                $fact_cm2_fact  = $oIfx->f("fact_cm2_fact");
                $fact_cm4_fact  = $oIfx->f("fact_cm4_fact");
                $orden_compra   = $oIfx->f("fact_opc_fact");
                $fact_cod_clpv  = $oIfx->f("fact_cod_clpv");
                $fact_cod_ccli  = $oIfx->f("fact_cod_ccli");
                $fact_dia_plazo = $oIfx->f("fact_dia_fact");
                $fact_fech_venc = fecha_mysql_func($oIfx->f("fact_fech_venc"));
                $fact_cm3_fact  = $oIfx->f("fact_cm3_fact");
                $fact_cod_contr = $oIfx->f("fact_cod_contr");

                $fact_term_expor = $oIfx->f('fact_term_expor');
                if(empty($fact_term_expor)){
                    $fact_term_expor='NULL';
                }
                $fact_cod_pais = $oIfx->f('fact_cod_pais');
                $fact_cod_ffue = $oIfx->f('fact_cod_ffue');
                if(empty($fact_cod_ffue)){
                    $fact_cod_ffue='NULL';
                }
                $fact_fec_emb = $oIfx->f('fact_fec_emb');
                $fact_prto_emb = $oIfx->f('fact_prto_emb');
                if(empty($fact_prto_emb)){
                    $fact_prto_emb='NULL';
                }
                $fact_prto_dest = $oIfx->f('fact_prto_dest');
                if(empty($fact_prto_dest)){
                    $fact_prto_dest='NULL';
                }
                $fact_fle_fact = $oIfx->f('fact_fle_fact');
                $fact_otr_fact = $oIfx->f('fact_otr_fact');
                $fact_fin_fact = $oIfx->f('fact_fin_fact');

                $id_usuario_w = $oIfx->f("fact_user_web");
                $sql = "select usuario_user, usuario_nombre, usuario_apellido  from comercial.usuario where usuario_id = '$id_usuario_w' ";
                if($oCon->Query($sql)){
                    if($oCon->NumFilas() > 0){
                        $usuario=$codigo = $oCon->f('usuario_nombre').' '.$oCon->f('usuario_apellido');
                    }
                }

                //PAIS
                if ($fact_cod_pais == '') {
                    $fact_cod_pais = 0;
                }
                $sql_pais = "select pais_des_pais from saepais where pais_cod_pais = $fact_cod_pais";
                $pais = consulta_string_func($sql_pais, 'pais_des_pais', $oIfxA, '--');

                //EMBARQUE ORIGEN
                $sql_emb_1 = "select prto_des_prto from saeprto where prto_cod_prto = $fact_prto_emb";
                $prto_1 = consulta_string_func($sql_emb_1, 'prto_des_prto', $oIfxA, '--');

                //EMBARQUE DESTINO
                $sql_emb_2 = "select prto_des_prto from saeprto where prto_cod_prto = $fact_prto_dest";
                $prto_2 = consulta_string_func($sql_emb_2, 'prto_des_prto', $oIfxA, '--');

                // Icoterm
                $sql_tem = "select id, nombre from comercial.incoterm where id = $fact_term_expor;";
                $term = consulta_string_func($sql_tem, 'nombre', $oIfxA, '');

                // DAE
                $sql_fue = "select ffue_fue_ffue    from saeffue where
                                ffue_cod_ffue  = $fact_cod_ffue ";
                $dae = consulta_string_func($sql_fue, 'ffue_fue_ffue', $oIfxA, '');


                $logo .= '<b><td style="width: 45%; border: 1px solid black; border-radius: 5px;" align="center">';
                $logo .= ' <table align="center" style="font-size: 15px;">';
                $logo .= ' <tr>';
                $logo .= '<td style="border-bottom: 1px inset black;">FACTURA</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>SERIE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . substr($fact_nse_fact, 0, 3) . '-' . substr($fact_nse_fact, 3, 6) . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="font-size: 17px; color: red; border-bottom: 1;">' . $fact_num_preimp . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fact_auto_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1">FECHA AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fact_fech_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1" >AMBIENTE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $ambiente_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td style="border-top:1" >EMISION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $emision_sri . '</td>';
                $logo .= ' </tr>';

                //verifica si existe clave de acceso
                if ($fact_clav_sri != '') {
                    $nombArch = $fact_nse_fact . $fact_num_preimp;
                    //$nombArch = '0112201401179141325300110010010000048101234567818';
                    $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';

                    new barCodeGenrator($fact_clav_sri, 1, $rutaCodi, 450, 100, true);

                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="center" style="font-size: 12px;">CLAVE DE ACCESO</td>';
                    $logo .= '</tr>';
                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="center"> <img width="400px;" src="' . $rutaCodi . '"/></td>';
                    $logo .= '</tr>';
                }

                $logo .= ' </table>';
                $logo .= '</td></b>';
                $logo .= '</tr>';
                $logo .= '</table>';
                $logo .= ' <br>';

                $cliente .= ' <table style="width: 100%; border:1px solid black; border-radius: 5px; padding: 2px; font-size: 15x;">';
                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10%;">CLIENTE:</td></b>';
                $cliente .= ' <td style="width: 48%; ">' . $fact_nom_cliente . '</td>';
                $cliente .= ' <b><td style="width: 13%; ">FECHA EMISION:</td></b>';
                $cliente .= ' <td style="width: 29% ">' . $fact_fech_fact . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% ">RUC:</td></b>';
                $cliente .= ' <td style="width: 48% ">' . $fact_ruc_clie . '</td>';
                $cliente .= ' <b><td style="width: 13% ">TELEFONO:</td></b>';
                $cliente .= ' <td style="width: 29% ">' . $fact_tlf_cliente . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% ">DIRECCION:</td></b>';
                $cliente .= ' <td style="width: 48% ">' . $fact_dir_clie . '</td>';
                $cliente .= ' <b><td style="width: 13% ">EMAIL:</td></b>';
                $cliente .= ' <td style="width: 29% ">' . $fact_email_clpv . '</td>';
                $cliente .= ' </tr>';


                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% "> PAIS ORIGEN: </td></b>';
                $cliente .= ' <td style="width: 48% ">ECUADOR</td>';
                $cliente .= ' <b><td style="width: 13% "> PUERTO ORIGEN : </td></b>';
                $cliente .= ' <td style="width: 29% ">' . $prto_1 . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% ">FECHA EMB: </td></b>';
                $cliente .= ' <td style="width: 48% ">' . $fact_fec_emb . '</td>';
                $cliente .= ' <td style="width: 13% "></td>';
                $cliente .= ' <td style="width: 29% "></td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% "> PAIS DESTINO: </td></b>';
                $cliente .= ' <td style="width: 48% ">' . $pais . '</td>';
                $cliente .= ' <b><td style="width: 13% "> PUERTO DESTINO: </td></b>';
                $cliente .= ' <td style="width: 29% ">' . $prto_2 . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% "> INCOTERM: </td></b>';
                $cliente .= ' <td style="width: 48% ">' . $term . '</td>';
                $cliente .= ' <td style="width: 13% "></td>';
                $cliente .= ' <td style="width: 29% "></td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% "> DAE: </td></b>';
                $cliente .= ' <td style="width: 48% ">' . $dae . '</td>';
                $cliente .= ' <td style="width: 13% "></td>';
                $cliente .= ' <td style="width: 29% "></td>';
                $cliente .= ' </tr>';


                // -------------------------------------------------------------------------
                // campos fedexport solucion temporal borrar
                // -------------------------------------------------------------------------
                if($ruc_empr == 1790312143001 || $ruc_empr == 1791870158001){

                    $sql_oc = "SELECT orden_compra from contrato_clpv where id_clpv = $fact_cod_clpv and
                                id_empresa = $idEmpresa";
                    $orden_compra = consulta_string_func($sql_oc, 'orden_compra', $oIfxA, '');

                    $cliente .= ' <tr>';
                    $cliente .= ' <b><td style="width: 10% ">:</td></b>';
                    $cliente .= ' <td style="width: 48% "></td>';
                    $cliente .= ' <b><td style="width: 13% ">ORDEN DE COMPRA:</td></b>';
                    $cliente .= ' <td style="width: 29% ">' . $orden_compra . '</td>';
                    $cliente .= ' </tr>';

                }
                // -------------------------------------------------------------------------
                // FIn campos fedexport solucion temporar borrar
                // -------------------------------------------------------------------------


                $cliente .= ' </table>';

                $cliente .= ' <br>';
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $oIfx->Free();

    $sqlDeta = "select * from saedfac where dfac_cod_fact = $id and 
                dfac_cod_sucu = $idSucursal and 
                dfac_cod_empr = $idEmpresa  ";

    $deta .= ' <table style="width: 100%; font-size: 13px; border-radius: 5px; border-collapse: collapse;" border="1">';
    $deta .= ' <tr>';
    $deta .= ' <b> <td style="width: 16%;" align="center">CODIGO</td> </b>';
    
    $deta .= ' <b> <td style="width: 15%;" align="center">COD. CLIENTE</td> </b>';
    
    $deta .= ' <b> <td style="width: 35%;" align="center">DESCRIPCION</td> </b>';
    
    $deta .= ' <b> <td style="width:  8%;" align="center">CANT.</td> </b>';
    $deta .= ' <b> <td style="width:  8%;" align="center">PRECIO</td> </b>';
    $deta .= ' <b> <td style="width:  8%;" align="center">DSCTO %</td> </b>';
    $deta .= ' <b> <td style="width: 10%;" align="center">TOTAL</td> </b>';
    $deta .= ' </tr>';

    $total_cant=0;

    if ($oIfx->Query($sqlDeta)) {
        if ($oIfx->NumFilas() > 0) {
            $porcIva = '';
            do {
                $dfac_cod_prod = $oIfx->f('dfac_cod_prod');
                $dfac_nom_prod = $oIfx->f('dfac_nom_prod');
                $dfac_cant_dfac = $oIfx->f('dfac_cant_dfac');
                $total_cant+=$dfac_cant_dfac;
                $dfac_precio_dfac = $oIfx->f('dfac_precio_dfac');
                $dfac_des1_dfac = $oIfx->f('dfac_des1_dfac');
                $dfac_des2_dfac = $oIfx->f('dfac_des2_dfac');
                $dfac_por_dsg = $oIfx->f('dfac_por_dsg');
                $dfac_mont_total = $oIfx->f('dfac_mont_total');
                $dfac_num_comp = $oIfx->f('dfac_tip_dfac');
                $dfac_por_iva = $oIfx->f('dfac_por_iva');
                $dfac_det_dfac = $oIfx->f('dfac_det_dfac');

                if ($dfac_por_iva > 0) {
                    $porcIva = $dfac_por_iva;
                }

                $descuento = $dfac_des1_dfac + $dfac_des2_dfac + $dfac_por_dsg;
                if ($descuento > 0)
                    $descuento = ($dfac_precio_dfac * $dfac_cant_dfac) - ($dfac_mont_total);
                else
                    $descuento = 0;

                $totalDescuento = $totalDescuento + $descuento;


                if ($dfac_por_dsg > 0) {
                    $descuento1 = ($dfac_precio_dfac * $dfac_cant_dfac * $dfac_des1_dfac) / 100;
                    $descuento2 = 0;
                    $descuento3 = 0;

                    $dfac_mont_total = number_format((($dfac_precio_dfac * $dfac_cant_dfac) - ($descuento1 + $descuento2 + $descuento3)), 2, '.', '');

                }

                $dfac_det_dfac=str_replace(',',', ',$dfac_det_dfac);
                $dfac_nom_prod=str_replace(',',', ',$dfac_nom_prod);

                $deta .= ' <tr>';
                $deta .= ' <td style="width: 16%;">' . $dfac_cod_prod . '</td>';
                $deta .= ' <td style="width: 15%;">' . $dfac_det_dfac . '</td>';
                $deta .= ' <td style="width: 35%;">' . $dfac_nom_prod . '</td>';
                $deta .= ' <td style="width: 8%;" align="right">' . number_format($dfac_cant_dfac, 4, '.', ',') . '</td>';
                $deta .= ' <td style="width: 8%;" align="right">' . number_format($dfac_precio_dfac, 4, '.', ',') . '</td>';
                $deta .= ' <td style="width: 8%;" align="right">' . round($dfac_des1_dfac, 0) . '</td>';
                $deta .= ' <td style="width: 10%;" align="right">' . number_format($dfac_mont_total, 4, '.', ',') . '</td>';
                $deta .= ' </tr>';
            
            }while ($oIfx->SiguienteRegistro());
            $deta .= ' <tr>';
            $deta .= ' <td colspan="3" align="right">TOTAL CANT:</td>';
            $deta .= ' <td  align="right">' . number_format($total_cant, 4, '.', ',') . '</td>';
            $deta .= '<td></td>';
            $deta .= '<td></td>';
            $deta .= '<td></td>';
            $deta .= ' </tr>';
        }
    }

    $deta .= ' </table>';

    if(!empty($fact_cm1_fact)){
        $fact_cm1_fact='<b>Observaciones:</b> '.$fact_cm1_fact;
    }

    $totales .='<table style="width: 100%;  font-size: 13px; margin-top: 3px;  align="center">';
    $totales .='<tr>
    <td  style="width: 50%; align="left"> '.$fact_cm1_fact.' </td>
    <td style="width: 50%; align="left">';

    $totales .= ' <table style="width: 195%; font-size: 13px; border-radius: 5px; border-collapse: collapse;"  border=1 align="right">';



    $totales .= ' <tr>';
    $totales .= ' <b> <td style="width: 25%;">SUBTOTAL:</td> </b>';
    $totales .= ' <td style="width: 10%;" align="right">' . number_format($fact_con_miva+$fact_sin_miva+$fact_dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>DESCUENTO:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td style="width: 25%;">SUBTOTAL SIN IMPUESTOS:</td> </b>';
    $totales .= ' <td style="width: 10%;" align="right">' . number_format($fact_con_miva+$fact_sin_miva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>IVA ' . round($porcIva) . '%:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_iva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>ICE:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_ice, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>IRBP:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_val_irbp, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>FLETE INTERNACIONAL:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_fle_fact, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>SEGURO INTERNACIONAL:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_otr_fact, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>GASTO TRANSPORTE:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_fin_fact, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>TOTAL:</td> </b>';
    $fact_tot_fact = $fact_con_miva + $fact_iva+ $fact_sin_miva + $fact_val_irbp + $fact_fle_fact + $fact_otr_fact + $fact_fin_fact;
    $totales .= ' <td align="right">' . number_format($fact_tot_fact, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' </table>';



    $totales.='</td>
    </tr>';
    $totales .='</table>';



    $sqltmp ='';
    if (!empty($fact_cod_contr)) {
        $sqltmp ="id_contrato = $fact_cod_contr AND";
    }

    $total = number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_fle_fact + $fact_otr_fact + $fact_fin_fact - $totalDescuento, 2, '.', '');
    $V = new EnLetras();
    $con_letra = strtoupper($V->ValorEnLetras($total, 'dolar'));

    //query forma de pago
    $sqlFPago = "select fp.fpag_cod_fpagop, fx.fxfp_val_fxfp, fx.fxfp_num_dias,
				fpg.fpagop_des_fpagop
				from saefact f, saefxfp fx, saefpag fp, saefpagop fpg
				where 
                f.fact_cod_fact = fx.fxfp_cod_fact and
				fp.fpag_cod_fpag = fx.fxfp_cod_fpag and
                f.fact_cod_empr = fpg.fpagop_cod_empr and
				fp.fpag_cod_fpagop = fpg.fpagop_cod_fpagop and
				f.fact_cod_empr = $idEmpresa and
				f.fact_cod_sucu = $idSucursal and
				f.fact_cod_fact = $id";
    if ($oIfx->Query($sqlFPago)) {
        if ($oIfx->NumFilas() > 0) {
            $tablePago .= '<table style="width: 60%; border-collapse: collapse; margin-top: 10px;" border="1">';
            $tablePago .= '<tr>';
            $tablePago .= '<th style="width: 70%;">FORMA PAGO</th>';
            $tablePago .= '<th style="width: 30%;">VALOR</th>';
            $tablePago .= '</tr>';
            do {
                $fpag_cod_fpagop    = $oIfx->f('fpag_cod_fpagop');
                $fxfp_val_fxfp      = $oIfx->f('fxfp_val_fxfp');
                $fxfp_num_dias      = $oIfx->f('fxfp_num_dias');
                $fpagop_des_fpagop  = $oIfx->f('fpagop_des_fpagop');

                $tablePago .= '<tr>';
                $tablePago .= '<td style="width: 70%;">' . $fpag_cod_fpagop . ' ' . htmlentities($fpagop_des_fpagop) . '</td>';
                $tablePago .= '<td style="width: 30%;" align="right">' . number_format($fxfp_val_fxfp, 2, '.', '') . '</td>';
                $tablePago .= '</tr>';
            } while ($oIfx->SiguienteRegistro());
            $tablePago .= '</table>';
        }
    }
    $oIfx->Free();

    if(!empty($empr_cm1_empr)){
        $msjCliente = $empr_cm1_empr;

        $msjCliente=str_replace('&&&correo&&&',$empr_mai_empr,$msjCliente);

        // LEEYNDA
        $tableLeyenda .= '<br /> <br /> <br />';
        $tableLeyenda .= '<table style="width: 98%; border-collapse: collapse; margin-top: 10px;" border="0">';
        $tableLeyenda .= '<tr>';
        $tableLeyenda .= '<td style="width: 98%;" align="center">'.$msjCliente.'</td>';
        $tableLeyenda .= '</tr>';
        $tableLeyenda .= '</table>';


    }

    if($obfact=='S'){

        $tableLeyenda .= '<table style="width: 98%; border-collapse: collapse; margin-top: 0px;" border="0">';
        $tableLeyenda .= '<tr>';
        $tableLeyenda .= '<td style="width: 98%;" align="left">'.$obdetfact.'</td>';
        $tableLeyenda .= '</tr>';
        $tableLeyenda .= '</table>';

    }

    $legend = '<page_footer>
        <table align="center" style="width: 80%">
            <tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">Este comprobante electronico ha sido generado a traves de Sisconti S.A. - Facturacion Electronica</td>
            </tr>
			<tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">www.sisconti.com</td>
            </tr>
        </table>
    </page_footer>';

    $documento .= '<page backimgw="70%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
    $documento .= $logo . $cliente . $deta . $totales . $tablePago. $tableLeyenda;
    $documento .= $legend;
    $documento .= '</page>';


    //file_put_contents("C:/prueba/documento.html", $documento);

    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;

    return $documento;
}


function reporte_notaDebito($id = '', $nombre_archivo = '', &$rutaPdf = '')
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    $sqls="select fact_cod_sucu from saefact where fact_cod_fact = $id ";
    $idSucursal =consulta_string($sqls,'fact_cod_sucu',$oIfx,0);
    //$idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_sn_conta, empr_iva_empr, empr_ac2_empr, empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo
                                            from saeempr where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_ac2_empr = trim($oIfx->f('empr_ac2_empr'));
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
            $empr_sn_conta = $oIfx->f('empr_sn_conta');
            
        }
    }
    $oIfx->Free();

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis  from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
        }
    }
    $oIfx->Free();


    //VALIDACION SUSCURSALES

    $sqls="select count(*) as cont from saesucu";
    $contsucu=consulta_string($sqls,'cont',$oIfx,0);

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }


    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;
    //$path_logo_img = DIR_FACTELEC . 'imagenes/logos/' . $path_img[$count];
    $path_logo_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];
    $razonSocial = '';

    

    $emprce="select empr_num_resu,empr_nom_empr from saeempr where empr_cod_empr=$idEmpresa";
    $contribuyente= consulta_string($emprce, 'empr_num_resu', $oIfx, '');
    $razonSocial= consulta_string($emprce, 'empr_nom_empr', $oIfx, '');
    $logo .= '<table style="width: 100%; margin: 0px;">';
    $logo .= '<tr>';
    $logo .= '<b><td align="center" style="width: 50%; border:1px solid black; border-radius: 5px; margin: 0px;">';
    $logo .= '<table align="center" style="margin: 0px;">';
    $logo .= '<tr><td style="margin-top: 0px;"><img width="250px;"  src="' . $path_logo_img . '"></td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 16px; white-space:nowrap;">' . $razonSocial . '</td></tr>';

    $sqlxml = "select ixml_tit_ixml, ixml_det_ixml from saeixml where ixml_cod_empr=$idEmpresa 
				and ixml_est_deleted ='S' and ixml_sn_pdf='S' order by ixml_ord_ixml";

				if ($oIfx->Query($sqlxml)) {
					if ($oIfx->NumFilas() > 0) {
						do {
							$titulo  = $oIfx->f('ixml_tit_ixml');
							$detalle = $oIfx->f('ixml_det_ixml');
                            $logo .= '<tr><td align="center" style="font-size: 14px;" width="300">' . $detalle . '</td></tr>';
						} while ($oIfx->SiguienteRegistro());
					}
				}
	$oIfx->Free();
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 16px;">RUC : ' . $ruc_empr . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';

//selecciona sucursales y direcciones
    $sql_sucu_matriz = "select sucu_dir_sucu from saesucu where sucu_nom_sucu ='MATRIZ'";
    $matriz = consulta_string($sql_sucu_matriz, 'sucu_dir_sucu', $oIfx, '');
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    $emprce="select empr_num_resu from saeempr where empr_cod_empr=$idEmpresa";
    $contribuyente= consulta_string($emprce, 'empr_num_resu', $oIfx, '');

    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                //$logo .= '<tr><td align="center" style="font-size: 12px">' . $sucu_nom_sucu . ': ' . htmlentities($sucu_dir_sucu) . '</td></tr>';
                //$logo .= '<tr><td align="center" style="font-size: 13px">SUCURSAL : ' . $sucu_nom_sucu . '</td></tr>';

                $logo .= '<tr><td style="position:top; whidth:50px;"><h4>Direccion Matriz:</h4></td></tr><br>';
                $logo .= '<tr><td>' . htmlentities($dirMatriz) . '</td></tr>';
                if( $contsucu>1){
                    $logo .= '<tr><td align="center" style="font-size: 13px">SUCURSAL : ' . $sucu_nom_sucu . '</td></tr>';

                    $logo .= '<tr><td><h4>Direccion Sucursal:</h4>' . htmlentities($sucu_dir_sucu) . '</td></tr>';
                }


                if($empr_conta_sn=='SI'){
                    $logo .= '<tr><td> Contribuyente Especial:'.$contribuyente.'</td></tr>';
                }
            } while ($oIfx->SiguienteRegistro());
        }
    }
    
    if (!empty($empr_num_resu)) {
        $logo .= '<tr><td align="center" style="font-size: 12px;"><b>Contribuyente Especial #:</b> ' . $empr_num_resu . '</td></tr>';
    }
    $logo .= '<tr><td>&nbsp;</td></tr>';    //$logo .= '<tr><td align="center" style="font-size: 12px;">Contribuyente Especial #:' . $empr_num_resu . '</td></tr>';
    
    if($empr_conta_sn=='SI'){
        if($empr_sn_conta=='S'){
            $empr_sn_conta ='SI';
        }
        else{
            $empr_sn_conta ='NO';
        }
        $logo .= '<tr><td align="center" style="font-size: 12px;">Obligado a llevar Contabilidad :' . $empr_sn_conta . '</td></tr>';
    }
    

    //echo $empr_ac2_empr; exit;
    if(!empty($empr_ac2_empr))
    {
        $logo .= '<tr><td align="center" style="font-size: 12px;">Agente de Retención Resolución No. ' . $empr_ac2_empr . '</td></tr>';
    }
    $logo .= ' </table>';
    $logo .= '</td></b>';


    $sqlFac = "select * from saefact where fact_cod_fact = $id and fact_cod_sucu = $idSucursal and fact_cod_empr = $idEmpresa";
    
    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $fact_nse_fact = $oIfx->f('fact_nse_fact');
                $fact_num_preimp = $oIfx->f('fact_num_preimp');
                $fact_auto_sri = $oIfx->f('fact_auto_sri');
                $fact_fech_sri = $oIfx->f('fact_fech_sri');
                $fact_nom_cliente = $oIfx->f('fact_nom_cliente');
                $fact_fech_fact = $oIfx->f('fact_fech_fact');
                $fact_ruc_clie = $oIfx->f('fact_ruc_clie');
                $fact_tlf_cliente = $oIfx->f('fact_tlf_cliente');
                $fact_dir_clie = $oIfx->f('fact_dir_clie');
                $fact_email_clpv = $oIfx->f('fact_email_clpv');
                $fact_con_miva = $oIfx->f('fact_con_miva');
                $fact_sin_miva = $oIfx->f('fact_sin_miva');
                $fact_tot_fact = $oIfx->f('fact_tot_fact');
                $fact_iva = $oIfx->f('fact_iva');
                $fact_aux_preimp = $oIfx->f('fact_aux_preimp');
                $fact_fec_emis_aux = $oIfx->f('fact_fec_emis_aux');
                $fact_clav_sri = $oIfx->f('fact_clav_sri');
                $fact_cm1_fact = trim($oIfx->f('fact_cm1_fact'));

                $logo .= '<b><td style="width: 45%; border: 1px solid black; border-radius: 5px;" align="center">';
                $logo .= ' <table align="center" style="font-size: 15px;">';
                $logo .= ' <tr>';
                $logo .= '<td style="border-bottom: 1px inset black;">NOTA DE DEBITO</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>SERIE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . substr($fact_nse_fact, 0, 3) . '-' . substr($fact_nse_fact, 3, 6) . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="font-size: 17px; color: red; border-bottom: 1;">' . $fact_num_preimp . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fact_auto_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1">FECHA AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fact_fech_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1" >AMBIENTE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $ambiente_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td style="border-top:1" >EMISION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $emision_sri . '</td>';
                $logo .= ' </tr>';


                //verifica si existe clave de acceso
                if ($fact_clav_sri != '') {
                    $nombArch = $fact_nse_fact . $fact_num_preimp;
                    //$nombArch = '0112201401179141325300110010010000048101234567818';
                    $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';
                    
                    new barCodeGenrator($fact_clav_sri, 1, $rutaCodi, 450, 100, true);

                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="right" style="font-size: 12px;">CLAVE DE ACCESO</td>';
                    $logo .= '</tr>';
                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="right"> <img width="350px;" src="' . $rutaCodi . '"/></td>';
                    $logo .= '</tr>';
                }

                $logo .= ' </table>';
                $logo .= '</td></b>';
                $logo .= '</tr>';
                $logo .= '</table>';
                $logo .= ' <br>';

                $cliente .= ' <table style="width: 100%; border:1px solid black; border-radius: 5px; padding: 2px; font-size: 15x;">';
                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10%"> CLIENTE : </td></b>';
                $cliente .= ' <td style="width: 48% ">' . $fact_nom_cliente . '</td>';
                $cliente .= ' <b><td style="width: 13% "> FECHA EMISION : </td></b>';
                $cliente .= ' <td style="width: 29% ">' . $fact_fech_fact . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% "> RUC : </td></b>';
                $cliente .= ' <td style="width: 48% ">' . $fact_ruc_clie . '</td>';
                $cliente .= ' <b><td style="width: 13% "> TELEFONO : </td></b>';
                $cliente .= ' <td style="width: 29% ">' . $fact_tlf_cliente . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% "> DIRECCION : </td></b>';
                $cliente .= ' <td style="width: 48% ">' . $fact_dir_clie . '</td>';
                $cliente .= ' <b><td style="width: 13% "> EMAIL : </td></b>';
                $cliente .= ' <td style="width: 29% ">' . $fact_email_clpv . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td colspan="3" align ="center"> DATOS FACTURA A MODIFICAR </td></b>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% "> NUMERO : </td></b>';
                $cliente .= ' <td style="width: 48% ">' . $fact_aux_preimp . '</td>';
                $cliente .= ' <b><td style="width: 13% "> FECHA : </td></b>';
                $cliente .= ' <td style="width: 29% ">' . $fact_fec_emis_aux . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' </table>';

                $cliente .= ' <br><br><br>';
                

            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    $sqlDeta = "select * from saedfac where dfac_cod_fact = $id and dfac_cod_sucu = $idSucursal and dfac_cod_empr = $idEmpresa ";
    //echo $sqlDeta; exit;
    $deta .= ' <table style="width: 100%;">';

    $deta .= ' <tr>';
    $deta .= ' <b> <td style="width: 10%;  border: 1px inset black;">CODIGO</td> </b>';
    $deta .= ' <b> <td style="width: 60%;  border: 1px inset black;">DESCRIPCION</td> </b>';
    $deta .= ' <b> <td style="width: 10%;  border: 1px inset black;">CANTIDAD</td> </b>';
    $deta .= ' <b> <td style="width: 10%;  border: 1px inset black;">P.UNITARIO</td> </b>';
    $deta .= ' <b> <td style="width: 10%;  border: 1px inset black;">SUB TOTAL</td> </b>';
    $deta .= ' </tr>';

    if ($oIfx->Query($sqlDeta)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $dfac_cod_prod = $oIfx->f('dfac_cod_prod');
                $dfac_nom_prod = $oIfx->f('dfac_nom_prod');
                $dfac_det_dfac = $oIfx->f('dfac_det_dfac');
                $dfac_cant_dfac = $oIfx->f('dfac_cant_dfac');
                $dfac_precio_dfac = $oIfx->f('dfac_precio_dfac');
                $dfac_mont_total = $oIfx->f('dfac_mont_total');

                $deta .= ' <tr>';
                $deta .= ' <td style="width: 10%; border: 1px inset black; ">' . $dfac_cod_prod . '</td>';
                $deta .= ' <td style="width: 60%; border: 1px inset black; ">' . $dfac_nom_prod . '</td>';
                $deta .= ' <td align="right" style="width: 10%; border: 1px inset black; ">' . $dfac_cant_dfac . '</td>';
                $deta .= ' <td align="right" style="width: 10%; border: 1px inset black; ">' . number_format($dfac_precio_dfac, 2, '.', '') . '</td>';
                $deta .= ' <td align="right" style="width: 10%; border: 1px inset black; ">' . number_format($dfac_mont_total, 2, '.', '') . '</td>';
                $deta .= ' </tr>';
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $deta .= ' </table>';
    /*$fecha2 = '2017-05-31';
     

    $calculoFecha = compararFechasIva($fact_fech_fact, $fecha2);

    $tmpIva = '';
    if ($calculoFecha > 0) {
        $tmpIva = 12;
    } else {
        $tmpIva = 12;
    }*/
    $observaciones .= ' <table style="width: 50%;"  border=0 align="right">';
    $observaciones .= ' <tr>';
    $observaciones .= ' <b> <td>OBSERVACIONES : </td> </b>';
    $observaciones .= ' <td align="left" style="width: 10%;">' . $fact_cm1_fact . '</td>';
    $observaciones .= ' </tr>';
    $observaciones .= ' </table>';

    $totales .='<table style="width: 100%;  font-size: 13px; margin-top: 3px;  align="center">';
    $totales .='<tr>
    <td  style="width: 50%; align="left"> <b> OBSERVACIONES : </b> '.$fact_cm1_fact.' </td>
    <td style="width: 50%; align="left">';


    $totales .= ' <table style="width: 195%;"  border=1 align="right">';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>SUBTOTAL SIN IMPUESTOS : </td> </b>';
    $totales .= ' <td align="right" style="width: 10%;">' . number_format($fact_tot_fact, 2) . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>SUBTOTAL  IVA ' . round($empr_iva_empr,0) . '% : </td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_con_miva, 2, '.', '') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>SUBTOTAL  IVA 0 % : </td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_sin_miva, 2, '.', '') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>IVA  ' . round($empr_iva_empr,0) . '% : </td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_iva, 2, '.', '') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>TOTAL :  </td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_con_miva + $fact_sin_miva + $fact_iva, 2, '.', '') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' </table>';
    
    $totales.='</td>
    </tr>';
    $totales .='</table>';
    $total = number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_ice + $fact_val_irbp + $fact_fle_fact + $fact_otr_fact + $fact_fin_fact - $totalDescuento, 2, '.', '');
    
    $V = new EnLetras();
    $con_letra = strtoupper($V->ValorEnLetras($total, 'dolar'));
    
    //query forma de pago
    $sqlFPago = "select fp.fpag_cod_fpagop, fx.fxfp_val_fxfp, fx.fxfp_num_dias,
				fpg.fpagop_des_fpagop
				from saefact f, saefxfp fx, saefpag fp, saefpagop fpg
				where f.fact_cod_fact = fx.fxfp_cod_fact and
				fp.fpag_cod_fpag = fx.fxfp_cod_fpag and
                                f.fact_cod_empr = fpg.fpagop_cod_empr and
				fp.fpag_cod_fpagop = fpg.fpagop_cod_fpagop and
				f.fact_cod_empr = $idEmpresa and
				f.fact_cod_sucu = $idSucursal and
				f.fact_cod_fact = $id";
    
    if ($oIfx->Query($sqlFPago)) {
        if ($oIfx->NumFilas() > 0) {
            $tablePago .= '<table style="width: 60%; border-collapse: collapse;" border="1">';
            $tablePago .= '<tr>';
            $tablePago .= '<th style="width: 70%;">FORMA PAGO</th>';
            $tablePago .= '<th style="width: 30%;">VALOR</th>';
            $tablePago .= '</tr>';
            do {
                $fpag_cod_fpagop = $oIfx->f('fpag_cod_fpagop');
                $fxfp_val_fxfp = $oIfx->f('fxfp_val_fxfp');
                $fxfp_num_dias = $oIfx->f('fxfp_num_dias');
                $fpagop_des_fpagop = $oIfx->f('fpagop_des_fpagop');

                $tablePago .= '<tr>';
                $tablePago .= '<td style="width: 70%;">' . $fpag_cod_fpagop . ' ' . htmlentities($fpagop_des_fpagop) . '</td>';
                $tablePago .= '<td style="width: 30%;" align="right">' . number_format($fxfp_val_fxfp, 2, '.', '') . '</td>';
                $tablePago .= '</tr>';
            } while ($oIfx->SiguienteRegistro());
            $tablePago .= '</table>';
        }
    }
    $oIfx->Free();

    /*$msjCliente = "<p>Para la atencion de reclamos NO resueltos por el prestador, ingrese su reclamo al
					link: <a href='#'>http://reclamoconsumidor.arcotel.gob.ec/osTicket</a>, o para informacion
					comuniquese con el numero telefonico 1800 567 567</p>";*/
    // LEEYNDA
    
    $tableLeyenda .= '<br /> <br /> <br />';
    $tableLeyenda .= '<table style="width: 98%; border-collapse: collapse; margin-top: 10px;" border="0">';
    $tableLeyenda .= '<tr>';
    $tableLeyenda .= '<td style="width: 98%;" align="center">' . $msjCliente . '</td>';
    $tableLeyenda .= '</tr>';
    $tableLeyenda .= '</table>';

    $legend = '<page_footer>
        <table align="center" style="width: 80%">
            <tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">Este comprobante electronico ha sido generado a traves de Sisconti S.A. - Facturacion Electronica</td>
            </tr>
			<tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">www.sisconti.com.ec</td>
            </tr>
        </table>
    </page_footer>';


    $documento .= '<page backimgw="70%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
    $documento .= $logo . $cliente . $deta . $totales;
    $documento .= '</page>';

    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;


    //eliminaArchivos(DIR_FACTELEC . 'Include/archivos/');

    return $documento;
}

function reporte_notaCredito($id = '', $nombre_archivo = '', $idSucursal, &$rutaPdf = '') {
//   echo "entróooooo"; exit;

    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();

    $oIfx3 = new Dbo;
    $oIfx3->DSN = $DSN_Ifx;
    $oIfx3->Conectar();

    $idEmpresa = $_SESSION['U_EMPRESA'];
    //$idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_sn_conta, empr_ac2_empr, empr_nom_empr, empr_ruc_empr, 
			empr_dir_empr, empr_conta_sn, 
			empr_num_resu, empr_path_logo, 
			empr_iva_empr
			from saeempr 
			where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $porcIva = $oIfx->f('empr_iva_empr');
            $empr_ac2_empr =trim($oIfx->f('empr_ac2_empr'));
            $empr_sn_conta =$oIfx->f('empr_sn_conta');
        }
    }
    $oIfx->Free();

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis  from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
        }
    }
    $oIfx->Free();


    //VALIDACION SUSCURSALES

    $sqls="select count(*) as cont from saesucu";
    $contsucu=consulta_string($sqls,'cont',$oIfx,0);

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }
    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;
    //$path_logo_img = DIR_FACTELEC . 'imagenes/logos/' . $path_img[$count];
    $path_logo_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];
    $razonSocial = '';


    $emprce="select empr_num_resu,empr_nom_empr from saeempr where empr_cod_empr=$idEmpresa";
    $contribuyente= consulta_string($emprce, 'empr_num_resu', $oIfx, '');
    $razonSocial= consulta_string($emprce, 'empr_nom_empr', $oIfx, '');
    $logo .= '<table style="width: 100%; margin: 0px;">';
    $logo .= '<tr>';
    $logo .= '<b><td align="center" style="width: 55%; border:1px solid black; border-radius: 5px; margin: 0px;">';
    $logo .= '<table align="center" style="margin: 0px;">';
    $logo .= '<tr><td style="margin-top: 0px;"><img width="250px;"  src="' . $path_logo_img . '"></td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 16px; white-space:nowrap;" width="300">' . $razonSocial . '</td></tr>';
    $sqlxml = "select ixml_tit_ixml, ixml_det_ixml from saeixml where ixml_cod_empr=$idEmpresa 
				and ixml_est_deleted ='S' and ixml_sn_pdf='S' order by ixml_ord_ixml";

				if ($oIfx->Query($sqlxml)) {
					if ($oIfx->NumFilas() > 0) {
						do {
							$titulo  = $oIfx->f('ixml_tit_ixml');
							$detalle = $oIfx->f('ixml_det_ixml');
                            $logo .= '<tr><td align="center" style="font-size: 14px;" width="300">' . $detalle . '</td></tr>';
						} while ($oIfx->SiguienteRegistro());
					}
				}
	$oIfx->Free();
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 16px;">RUC : ' . $ruc_empr . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';

    //selecciona sucursales y direcciones
    $sql_sucu_matriz = "select sucu_dir_sucu from saesucu where sucu_nom_sucu ='MATRIZ'";
    $matriz = consulta_string($sql_sucu_matriz, 'sucu_dir_sucu', $oIfx, '');
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    $emprce="select empr_num_resu from saeempr where empr_cod_empr=$idEmpresa";
    $contribuyente= consulta_string($emprce, 'empr_num_resu', $oIfx, '');
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                //$logo .= '<tr><td align="center" style="font-size: 12px">' . $sucu_nom_sucu . ': ' . htmlentities($sucu_dir_sucu) . '</td></tr>';
                //$logo .= '<tr><td align="center" style="font-size: 13px">SUCURSAL : ' . $sucu_nom_sucu . '</td></tr>';

                $logo .= '<tr><td style="position:top;" ><h4>Direccion Matriz:</h4></td></tr><br>';
                $logo .= '<tr><td width="500">' . htmlentities($dirMatriz) . '</td></tr>';
                if( $contsucu>1){
                    $logo .= '<tr><td align="center" style="font-size: 13px">SUCURSAL : ' . $sucu_nom_sucu . '</td></tr>';

                    $logo .= '<tr><td width="500"><h4>Direccion Sucursal:</h4>' . htmlentities($sucu_dir_sucu) . '</td></tr>';
                }


                if($empr_conta_sn=='SI'){
                    $logo .= '<tr><td> Contribuyente Especial:'.$contribuyente.'</td></tr>';
                }
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $logo .= '<tr><td>&nbsp;</td></tr>';
    if (!empty($empr_num_resu)) {
        $logo .= '<tr><td align="center" style="font-size: 12px;"><b>Contribuyente Especial #:</b> ' . $empr_num_resu . '</td></tr>';
    }
    
    //$logo .= '<tr><td align="center" style="font-size: 12px;">Contribuyente Especial #:' . $empr_num_resu . '</td></tr>';
    if($empr_conta_sn=='SI'){
        if($empr_sn_conta=='S'){
            $empr_sn_conta ='SI';
        }
        else{
            $empr_sn_conta ='NO';
        }
        $logo .= '<tr><td align="center" style="font-size: 12px;">Obligado a llevar Contabilidad :' . $empr_sn_conta . '</td></tr>';
    }
    if(!empty($empr_ac2_empr))
    {
        $logo .= '<tr><td align="center" style="font-size: 12px;">Agente de Retención Resolución No. ' . $empr_ac2_empr . '</td></tr>';
    }
    $logo .= ' </table>';
    $logo .= '</td></b>';

    $sqlFac = "select * from saencre where ncre_cod_ncre = $id and ncre_cod_sucu = $idSucursal and ncre_cod_empr = $idEmpresa ";

    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $ncre_nse_ncre = $oIfx->f('ncre_nse_ncre');
                $ncre_num_preimp = $oIfx->f('ncre_num_preimp');
                $ncre_auto_sri = $oIfx->f('ncre_auto_sri');
                $ncre_fech_sri = $oIfx->f('ncre_fech_sri');
                $ncre_fech_docu = $oIfx->f('ncre_fech_docu');
                $ncre_nom_cliente = $oIfx->f('ncre_nom_cliente');
                //$ncre_fech_fact = fecha_mysql_func($oIfx->f('ncre_fech_fact'));
                $ncre_fech_fact = $oIfx->f('ncre_fech_fact');
                $ncre_ruc_clie = $oIfx->f('ncre_ruc_clie');
                $ncre_tlf_cliente = $oIfx->f('ncre_tlf_cliente');
                $ncre_dir_clie = $oIfx->f('ncre_dir_clie');
                $ncre_email_clpv = $oIfx->f('ncre_email_clpv');
                $ncre_con_miva = $oIfx->f('ncre_con_miva');
                $ncre_sin_iva = $oIfx->f('ncre_sin_miva');
                $ncre_cod_fact = $oIfx->f('ncre_cod_fact');
                $ncre_iva = $oIfx->f('ncre_iva');
                $ncre_ice = $oIfx->f('ncre_ice');
                $ncre_cm1_ncre = $oIfx->f('ncre_cm1_ncre');
                $ncre_cm2_ncre = $oIfx->f('ncre_cm2_ncre');
                $ncre_clav_sri = $oIfx->f('ncre_clav_sri');

                $date = date_create($ncre_fech_fact);
                $ncre_fech_fact = date_format($date,'d/m/Y');


                $logo .= '<b><td style="width: 45%; border: 1px solid black; border-radius: 5px;" align="center">';
                $logo .= ' <table align="center" style="font-size: 15px;">';
                $logo .= ' <tr>';
                $logo .= '<td style="border-bottom: 1px inset black;">NOTA DE CREDITO</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="">SERIE:</td><';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="">' . substr($ncre_nse_ncre, 0, 3) . '-' . substr($ncre_nse_ncre, 3, 6) . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="font-size: 17px; color: red;">' . $ncre_num_preimp . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1">AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $ncre_auto_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1" >FECHA AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $ncre_fech_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1" >AMBIENTE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $ambiente_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td style="border-top:1">EMISION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $emision_sri . '</td>';
                $logo .= ' </tr>';

                if ($ncre_clav_sri != '') {
                    $nombArch = $ncre_nse_ncre . $ncre_num_preimp;
                    $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';

                    new barCodeGenrator($ncre_clav_sri, 1, $rutaCodi, 450, 100, true);

                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="right" style="font-size: 12px;">CLAVE DE ACCESO</td>';
                    $logo .= '</tr>';
                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="right"> <img width="350px;" src="' . $rutaCodi . '"/></td>';
                    $logo .= '</tr>';
                }

                $logo .= ' </table>';
                $logo .= '</td></b>';
                $logo .= '</tr>';
                $logo .= '</table>';
                $logo .= '<br>';

                $cliente .= ' <table style="width: 100%; border:1px solid black; border-radius: 5px; padding: 2px; font-size: 15x;">';
                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 14%"> CLIENTE : </td></b>';
                $cliente .= ' <td style="width: 48% ">' . utf8_decode($ncre_nom_cliente) . '</td>';
                $cliente .= ' <b><td style="width: 13% "> FECHA EMISION : </td></b>';
                $cliente .= ' <td style="width: 25% ">' . $ncre_fech_fact . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 14% "> RUC : </td></b>';
                $cliente .= ' <td style="width: 48% ">' . $ncre_ruc_clie . '</td>';
                $cliente .= ' <b><td style="width: 13% "> TELEFONO : </td></b>';
                $cliente .= ' <td style="width: 25% ">' . $ncre_tlf_cliente . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 14% "> DIRECCION : </td></b>';
                $cliente .= ' <td style="width: 48% ">' . utf8_decode($ncre_dir_clie) . '</td>';
                $cliente .= ' <b><td style="width: 13% "> EMAIL : </td></b>';
                $cliente .= ' <td style="width: 25% ">' . $ncre_email_clpv . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td colspan="4"> COMPROBANTE QUE MODIFICA : </td></b>';
                $cliente .= ' </tr>';

                //DATOS DE LA EMPRESA

                if ($ncre_cod_fact == '') {
                    $ncre_cod_fact = 0;
                }

                $sql = "select fact_nse_fact, fact_num_preimp, fact_fech_fact,
						fact_cm2_fact
						from saefact 
						where fact_cod_empr = $idEmpresa and 
						fact_cod_fact = $ncre_cod_fact";
                // var_dump($sql);exit;


                $numero_fac = "";
                if ($oIfx2->Query($sql)) {
                    if ($oIfx2->NumFilas() > 0) {
                        $fact_nse_fact = $oIfx2->f('fact_nse_fact');
                        $fact_num_preimp = $oIfx2->f('fact_num_preimp');
                        $fact_fech_fact = fecha_mysql_func($oIfx2->f('fact_fech_fact'));
                        $fact_cm2_fact = $oIfx2->f('fact_cm2_fact');

                        $nse = substr($fact_nse_fact, 0, 3);
                        $pto = substr($fact_nse_fact, 3, 6);
                        $numero_fac =  $nse . '-' . $pto . '-' . $fact_num_preimp;
                    } else {
                        if ($ncre_cod_fact == 0) {
                            $sqlNcre = "select ncre_nse_ncre, ncre_cod_aux, ncre_fec_emfa from saencre where 
                                    ncre_cod_ncre = $id and 
                                    ncre_cod_empr = $idEmpresa and 
                                    ncre_cod_sucu = $idSucursal";
                            if ($oIfx2->Query($sqlNcre)) {
                                if ($oIfx2->NumFilas() > 0) {
                                    $fact_nse_fact = $oIfx2->f('ncre_nse_ncre');
                                    $numero_fac = $oIfx2->f('ncre_cod_aux');
                                    //$fact_fech_fact = fecha_sri($oIfx2->f('ncre_fec_emfa'));
                                    $fact_fech_fact = $oIfx2->f('ncre_fec_emfa');
                                }
                            }

                            if(!empty($ncre_fech_docu)){
                                $fact_fech_fact =date('Y-m-d', strtotime($ncre_fech_docu));
                            }

                        }else{
                            $nse = substr($fact_nse_fact, 0, 3);
                            $pto = substr($fact_nse_fact, 3, 6);
                            $numero_fac =  $nse . '-' . $pto . '-' . $fact_num_preimp;
                        }
                    }
                }
                $oIfx2->Free();

                $date = date_create($fact_fech_fact);
                $fact_fech_fact = date_format($date,'d/m/Y');

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 14% "> NUMERO : </td></b>';
                $cliente .= ' <td style="width: 48% ">' .$numero_fac . '</td>';
                $cliente .= ' <b><td style="width: 13% "> FECHA : </td></b>';
                $cliente .= ' <td style="width: 25% ">' . $fact_fech_fact . '</td>';
                $cliente .= ' </tr>';


                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 14% "> MOTIVO : </td></b>';
                $cliente .= ' <td style="width: 48% ">' . $ncre_cm1_ncre . '</td>';
                $cliente .= ' <b><td style="width: 13% "> ORDEN COMPRA : </td></b>';
                $cliente .= ' <td style="width: 25% ">' . $fact_cm2_fact . '</td>';
                $cliente .= ' </tr>';

                if(!empty($ncre_cm2_ncre)){
                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 14% "> OBSERVACIONES : </td></b>';
                $cliente .= ' <td style="width: 48% ">' . $ncre_cm2_ncre . '</td>';
                $cliente .= ' <b><td style="width: 13% "> </td></b>';
                $cliente .= ' <td style="width: 25% "> </td>';
                $cliente .= ' </tr>';
                }

                $cliente .= ' </table>';

                $cliente .= ' <br>';
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    $sqlDeta = "select * from saedncr where dncr_cod_ncre = $id and dncr_cod_sucu = $idSucursal and dncr_cod_empr = $idEmpresa ";

    $deta .= ' <table style="width: 100%; font-size: 13px; border-radius: 5px; border-collapse: collapse;" border="1">';
    $deta .= ' <tr>';
    $deta .= ' <b> <td style="width: 16%;  border: 1px inset black;">CODIGO</td> </b>';
    $deta .= ' <b> <td style="width: 10%;  border: 1px inset black;">LOTE</td> </b>';
    $deta .= ' <b> <td style="width: 10%;  border: 1px inset black;">FECHA CAD.</td> </b>';
    $deta .= ' <b> <td style="width: 30%;  border: 1px inset black;">DESCRIPCION</td> </b>';
    $deta .= ' <b> <td style="width:  8%;  border: 1px inset black;">CANT.</td> </b>';
    $deta .= ' <b> <td style="width:  8%;  border: 1px inset black;">PRECIO</td> </b>';
    $deta .= ' <b> <td style="width:  8%;  border: 1px inset black;">DSCTO</td> </b>';
    $deta .= ' <b> <td style="width: 10%;  border: 1px inset black;">TOTAL</td> </b>';
    $deta .= ' </tr>';


    if ($oIfx->Query($sqlDeta)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $dncr_cod_prod = $oIfx->f('dncr_cod_prod');
                $dncr_nom_prod = $oIfx->f('dncr_nom_prod');
                $dncr_cant_dfac = $oIfx->f('dncr_cant_dfac');
                $dncr_precio_dfac = $oIfx->f('dncr_precio_dfac');
                $dncr_des1_dfac = $oIfx->f('dncr_des1_dfac');
                $dncr_por_dsg = $oIfx->f('dncr_por_dsg');
                $dncr_mont_total = $oIfx->f('dncr_mont_total');
                $dncr_cod_lote = $oIfx->f('dncr_cod_lote');
                $dncr_num_comp = $oIfx->f('dncr_tip_dncr');
                $dncr_lote_fcad = $oIfx->f('dncr_lote_fcad');
                $dncr_por_iva = $oIfx->f('dncr_por_iva');

                if (empty($dncr_num_comp)) {
                    $dncr_num_comp = 0;
                }

                /*// FECHA CADUCIDAD
                $sql = "select  dmov_cod_prod, dmov_cod_lote, dmov_cad_lote from saedmov where
                                dmov_num_comp = $dncr_num_comp and
                                dmov_cod_empr = $idEmpresa and
                                dmov_cod_sucu = $idSucursal and
                                dmov_cod_prod = '$dncr_cod_prod' ";
                $cad_lote = consulta_string_func($sql, 'dmov_cad_lote', $oIfx2, '');*/

                if($dncr_por_iva > 0){
                    $porcIva = $dncr_por_iva;
                }

                if (!empty($dncr_lote_fcad)) {
                    //$dncr_lote_fcad = fecha_mysql_func($dncr_lote_fcad);
                    $date = date_create($dncr_lote_fcad);
                    $fact_fech_fact = date_format($date,'d/m/Y');
                }

                if (empty($dncr_nom_prod)) {
                    $sqlProducto = "select prod_nom_prod from saeprod where 
                                        prod_cod_prod = '$dncr_cod_prod' and
                                        prod_cod_empr = $idEmpresa and 
                                        prod_cod_sucu = $idSucursal ";
                    $dncr_nom_prod = consulta_string_func($sqlProducto, 'prod_nom_prod', $oIfx3, '');
                }// fin if

                $descuento = $dncr_des1_dfac + $dncr_por_dsg;
                if ($descuento > 0)
                    $descuento = ($dncr_precio_dfac * $dncr_cant_dfac) - ($dncr_mont_total);
                else
                    $descuento = 0;

                $totalDescuento = $totalDescuento + $descuento;

                $dncr_nom_prod=str_replace(',',', ',$dncr_nom_prod);


                //CAMPO APLICACION - ACTUALMENTE SOLO ES UTILIZADO POR LA EMPRESA LUBAMAQUI
                $sql_prod="SELECT prod_apli_prod from saeprod where prod_cod_prod='$dncr_cod_prod' and (prod_apli_prod is not null and prod_apli_prod !='')";
                $apli_prod = trim(consulta_string_func($sql_prod, 'prod_apli_prod', $oIfx3, ''));
                if(!empty($apli_prod)){
                    $dncr_nom_prod = $dncr_nom_prod.'<br><div style="font-size:70%">'.$apli_prod.'</div>';
                }

                $deta .= ' <tr>';
                $deta .= ' <td style="width: 16%; border: 1px inset black; ">' . $dncr_cod_prod . '</td>';
                $deta .= ' <td style="width: 10%; border: 1px inset black; ">' . $dncr_cod_lote . '</td>';
                $deta .= ' <td style="width: 10%; border: 1px inset black; ">' . $dncr_lote_fcad . '</td>';
                $deta .= ' <td style="width: 30%; border: 1px inset black; ">' . $dncr_nom_prod . '</td>';
                $deta .= ' <td style="width:  8%; border: 1px inset black; " align="right">' . number_format($dncr_cant_dfac, 4, '.', ',') . '</td>';
                $deta .= ' <td style="width:  8%; border: 1px inset black; " align="right">' . number_format($dncr_precio_dfac, 4, '.', ',') . '</td>';
                $deta .= ' <td style="width:  8%; border: 1px inset black; " align="right">' . number_format($dncr_des1_dfac, 4, '.', ',') . '</td>';
                $deta .= ' <td style="width: 10%; border: 1px inset black; " align="right">' . number_format($dncr_mont_total, 2, '.', '') . '</td>';
                $deta .= ' </tr>';
            }while ($oIfx->SiguienteRegistro());
        }
    }

    $deta .= ' </table>';

    $totales .= ' <table style="width: 100%; font-size: 13px; margin-top: 3px; border-radius: 5px;  border-collapse: collapse;"  border=1 align="right">';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>SUBTOTAL SIN IMPUESTOS: </td> </b>';
    $totales .= ' <td style="width: 10%;" align="right">' . number_format($ncre_con_miva + $ncre_sin_iva +$ncre_ice, 2) . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>SUBTOTAL  IVA ' . round($porcIva)  . '%: </td> </b>';
    $totales .= ' <td align="right">' . number_format($ncre_con_miva, 2, '.', '') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>SUBTOTAL  IVA 0%: </td> </b>';
    $totales .= ' <td align="right">' . number_format($ncre_sin_iva, 2, '.', '') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>DESCUENTO: </td> </b>';
    $totales .= ' <td align="right">' . number_format($totalDescuento, 2, '.', '') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>ICE : </td> </b>';
    $totales .= ' <td align="right">' . number_format($ncre_ice, 2, '.', '') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>IVA ' . round($porcIva)  . '%: </td> </b>';
    $totales .= ' <td align="right">' . number_format($ncre_iva, 2, '.', '') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>TOTAL:  </td> </b>';
    $totales .= ' <td align="right">' . number_format($ncre_iva + $ncre_con_miva + $ncre_sin_iva + $ncre_ice, 2, '.', '') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' </table>';

    $total = number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_fle_fact + $fact_otr_fact + $fact_fin_fact - $totalDescuento, 2, '.', '');
    $V = new EnLetras();
    $con_letra = strtoupper($V->ValorEnLetras($total, 'dolar'));

    $legend = '<page_footer>
        <table align="center" style="width: 80%">
            <tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">Este comprobante electronico ha sido generado a traves de Sisconti S.A. - Facturacion Electronica</td>
            </tr>
			<tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">www.sisconti.com.ec</td>
            </tr>
        </table>
    </page_footer>';


    $documento .= '<page backimgw="70%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
    $documento .= $logo . $cliente . $deta . $totales;
    $documento .= $legend;
    $documento .= '</page>';

    $html2pdf = new HTML2PDF('P', 'A3', 'fr', array(5,5,5,5));
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;


    /////eliminaArchivos(DIR_FACTELEC . 'include/archivos/');
    //var_dump ($documento); exit;
    return $documento;
}


function reporte_guiaRemision( $id = '', $nombre_archivo = '', $idSucursal, &$rutaPdf = '')
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfx1 = new Dbo;
    $oIfx1->DSN = $DSN_Ifx;
    $oIfx1->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    //$idSucursal = $_SESSION['U_SUCURSAL'];


    $sql = "select empr_sn_conta, empr_ac2_empr, empr_rimp_sn,empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo
                                            from saeempr where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_ac2_empr = trim($oIfx->f('empr_ac2_empr'));
            $empr_rimp_sn = $oIfx->f('empr_rimp_sn');
            $empr_sn_conta = $oIfx->f('empr_sn_conta');
        }
    }
    $oIfx->Free();

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis, sucu_dir_sucu  
			from saesucu 
			where sucu_cod_empr = $idEmpresa and 
			sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
            $sucu_dir = $oIfx->f('sucu_dir_sucu');
        }
    }
    $oIfx->Free();


    //VALIDACION SUSCURSALES

    $sqls="select count(*) as cont from saesucu";
    $contsucu=consulta_string($sqls,'cont',$oIfx,0);

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }



    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;
    //$path_logo_img = DIR_FACTELEC . 'imagenes/logos/' . $path_img[$count];
    $path_logo_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];


    $rutaImagen =  $_SERVER['DOCUMENT_ROOT']."/".DIR_INCLUDE.'Clases/Formulario/plugins/reloj/' . basename($empr_path_logo);

    $emprce="select empr_num_resu,empr_nom_empr from saeempr where empr_cod_empr=$idEmpresa";
    $contribuyente= consulta_string($emprce, 'empr_num_resu', $oIfx, '');
    $razonSocial= consulta_string($emprce, 'empr_nom_empr', $oIfx, '');
    $logo .= '<table style="width: 100%; margin: 0px;">';
    $logo .= '<tr>';
    $logo .= '<b><td align="center" style="width: 50%; border:1px solid black; border-radius: 5px; margin: 0px;">';
    $logo .= '<table align="center" style="margin: 0px;">';
    $logo .= '<tr><td style="margin-top: 0px;"><img width="250px;"  src="' . $path_logo_img . '"></td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 16px; white-space:nowrap;" width="480" >' . $razonSocial . '</td></tr>';
    
    $sqlxml = "select ixml_tit_ixml, ixml_det_ixml from saeixml where ixml_cod_empr=$idEmpresa 
				and ixml_est_deleted ='S' and ixml_sn_pdf='S' order by ixml_ord_ixml";

				if ($oIfx->Query($sqlxml)) {
					if ($oIfx->NumFilas() > 0) {
						do {
							$titulo  = $oIfx->f('ixml_tit_ixml');
							$detalle = $oIfx->f('ixml_det_ixml');
                            $logo .= '<tr><td align="center" style="font-size: 14px;" width="300">' . $detalle . '</td></tr>';
						} while ($oIfx->SiguienteRegistro());
					}
				}
	$oIfx->Free();

    //$logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 16px;">RUC : ' . $ruc_empr . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';

//selecciona sucursales y direcciones
    $sql_sucu_matriz = "select sucu_dir_sucu from saesucu where sucu_nom_sucu ='MATRIZ'";
    $matriz = consulta_string($sql_sucu_matriz, 'sucu_dir_sucu', $oIfx, '');
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    $emprce="select empr_num_resu from saeempr where empr_cod_empr=$idEmpresa";
    $contribuyente= consulta_string($emprce, 'empr_num_resu', $oIfx, '');
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                //$logo .= '<tr><td align="center" style="font-size: 12px">' . $sucu_nom_sucu . ': ' . htmlentities($sucu_dir_sucu) . '</td></tr>';
                //$logo .= '<tr><td align="center" style="font-size: 13px">SUCURSAL : ' . $sucu_nom_sucu . '</td></tr>';

                $logo .= '<tr><td style="position:top; " width="480"><h4>Direccion Matriz:</h4></td></tr><br>';
                $logo .= '<tr><td width="480">' . htmlentities($dirMatriz) . '</td></tr>';
                if( $contsucu>1){
                    $logo .= '<tr><td align="center" style="font-size: 13px" width="480">SUCURSAL : ' . $sucu_nom_sucu . '</td></tr>';

                    $logo .= '<tr><td width="480"><h4>Direccion Sucursal:</h4>' . htmlentities($sucu_dir_sucu) . '</td></tr>';
                }


                if($empr_conta_sn=='SI'){
                    $logo .= '<tr><td> Contribuyente Especial:'.$contribuyente.'</td></tr>';
                }
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $logo .= '<tr><td>&nbsp;</td></tr>';

    if (!empty($empr_num_resu)) {
        $logo .= '<tr><td align="center" style="font-size: 12px;"><b>Contribuyente Especial #:</b> ' . $empr_num_resu . '</td></tr>';
    }

    //$logo .= '<tr><td align="center" style="font-size: 12px;">Contribuyente Especial #:' . $empr_num_resu . '</td></tr>';
    if($empr_conta_sn=='SI'){
        if($empr_sn_conta=='S'){
            $empr_sn_conta ='SI';
        }
        else{
            $empr_sn_conta ='NO';
        }
        $logo .= '<tr><td align="center" style="font-size: 12px;">Obligado a llevar Contabilidad :' . $empr_sn_conta . '</td></tr>';
    }
    if($empr_rimp_sn=="S"){
        $logo .= '<tr><td align="center" style="font-size: 12px;"><b>CONTRIBUYENTE R&Eacute;GIMEN RIMPE</b></td></tr>';
    }

    if(!empty($empr_ac2_empr))
    {
        $logo .= '<tr><td align="center" style="font-size: 12px;">Agente de Retención Resolución No. ' . $empr_ac2_empr . '</td></tr>';
    }
    $logo .= ' </table>';
    $logo .= '</td></b>';

    $sqlFac = "select * from saeguia where guia_cod_guia= $id and guia_cod_sucu = $idSucursal and guia_cod_empr = $idEmpresa ";

    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $guia_nse_guia = $oIfx->f('guia_nse_guia');
                $guia_num_preimp = $oIfx->f('guia_num_preimp');
                $guia_auto_sri = $oIfx->f('guia_auto_sri');
                $guia_fech_sri = $oIfx->f('guia_fech_sri');
                $guia_nom_cliente = $oIfx->f('guia_nom_cliente');
                $guia_fech_guia = fecha_mysql_func($oIfx->f('guia_fech_guia'));
                $guia_ruc_clie = $oIfx->f('guia_ruc_clie');
                $guia_tlf_cliente = $oIfx->f('guia_tlf_cliente');
                $guia_dir_clie = $oIfx->f('guia_dir_clie');
                $guia_email_clpv = $oIfx->f('guia_email_clpv');
                //$ncre_cod_fact = $oIfx->f('ncre_cod_fact');
                $guia_cm3_guia = $oIfx->f('guia_cm3_guia');
                $guia_cod_trta = $oIfx->f('guia_cod_trta');
                $guia_num_plac = $oIfx->f('guia_num_plac');
                $guia_hos_guia = $oIfx->f('guia_hos_guia');
                $guia_hol_guia = $oIfx->f('guia_hol_guia');
                $guia_clav_sri = $oIfx->f('guia_clav_sri');
                $guia_sal_guia = $oIfx->f('guia_sal_guia');
                $guia_cod_ccli = $oIfx->f('guia_cod_ccli');
                $guia_cod_clpv = $oIfx->f('guia_cod_clpv');
                $guia_cm1_guia = $oIfx->f('guia_cm1_guia');
                $guia_pto_partida = $oIfx->f('guia_alb_origen');
                $guia_ruta_guia = $oIfx->f('guia_laar_guia');
                $guia_ciu_ori = $oIfx->f('guia_ciu_ori');
                $guia_ciu_des = $oIfx->f('guia_ciu_des');
                $guia_tip_entr = $oIfx->f('guia_tip_entr'); 
                $guia_peso_bruto = $oIfx->f('guia_peso_bruto'); 
                // ciudades
                $sql = "select ciud_cod_ciud, ciud_nom_ciud  from saeciud where ciud_cod_ciud = '$guia_ciu_ori' ";
                $ciud_ori = consulta_string($sql, 'ciud_nom_ciud', $oIfx2, '');

                $sql = "select ciud_cod_ciud, ciud_nom_ciud  from saeciud where ciud_cod_ciud = '$guia_ciu_des' ";
                $ciud_des = consulta_string($sql, 'ciud_nom_ciud', $oIfx2, '');


                $logo .= '<b><td style="width: 49%; border: 1px solid black; border-radius: 5px;" align="center">';
                $logo .= ' <table align="center" style="font-size: 15px;">';
                $logo .= ' <tr>';
                $logo .= '<td style="border-bottom: 1px inset black;">GUIA DE REMISION</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>SERIE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . substr($guia_nse_guia, 0, 3) . '-' . substr($guia_nse_guia, 3, 6) . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="font-size: 17px; color: red; border-bottom: 1;">' . $guia_num_preimp . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $guia_auto_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top: 1;">FECHA AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $guia_fech_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1">AMBIENTE: </td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $ambiente_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td style="border-top:1">EMISION: </td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $emision_sri . '</td>';
                $logo .= ' </tr>';

                if ($guia_clav_sri != '') {
                    $nombArch = $guia_nse_guia . $guia_num_preimp;
                    $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';

                    new barCodeGenrator($guia_clav_sri, 1, $rutaCodi, 450, 100, true);

                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="right" style="font-size: 12px;">CLAVE DE ACCESO:</td>';
                    $logo .= '</tr>';
                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="right"> <img width="350px;" src="' . $rutaCodi . '"/></td>';
                    $logo .= '</tr>';
                }

                $logo .= ' </table>';
                $logo .= '</td></b>';
                $logo .= '</tr>';
                $logo .= '</table>';
                $logo .= ' <br>';


                //DATOS DEL TRANSPORTISTA
                if (!empty($guia_cod_trta)) {
                    $sqlTran = "select * from saetrta where trta_cod_trta = $guia_cod_trta and trta_cod_empr = $idEmpresa ";
                } else {
                    $sqlTran = "select * from saetrta where trta_cid_trta = '$guia_sal_guia' and trta_cod_empr = $idEmpresa ";
                }

                $transportista .= ' <table style="width: 100%; border:1px solid black; border-radius: 5px; padding: 2px; font-size: 15x;">';
                $transportista .= ' <tr>';
                $transportista .= ' <b><td colspan="4"> DATOS DEL TRANSPORTISTA : </td></b>';
                $transportista .= ' </tr>';

                if ($oIfx2->Query($sqlTran)) {
                    if ($oIfx2->NumFilas() > 0) {
                        do {
                            //$oReturn->alert('si');
                            $trta_nom_trta = $oIfx2->f("trta_nom_trta");
                            $trta_cid_trta = $oIfx2->f("trta_cid_trta");

                            $transportista .= ' <tr>';
                            $transportista .= ' <b><td style="width: 13%"> NOMBRE:</td></b>';
                            $transportista .= ' <td style="width: 50% ">' . utf8_decode($trta_nom_trta) . '</td>';
                            $transportista .= ' <b><td style="width: 9% "> RUC/CI:</td></b>';
                            $transportista .= ' <td style="width: 28% ">' . $trta_cid_trta . '</td>';
                            $transportista .= ' </tr>';

                            $transportista .= ' <tr>';
                            $transportista .= ' <b><td style="width: 13% "> PARTIDA:</td></b>';
                            $transportista .= ' <td style="width: 50% ">' . utf8_decode($guia_pto_partida) . '</td>';
                            $transportista .= ' <b><td style="width: 9% "> PLACA:</td></b>';
                            $transportista .= ' <td style="width: 28% ">' . $guia_num_plac . '</td>';
                            $transportista .= ' </tr>';

                            $transportista .= ' <tr>';
                            $transportista .= ' <b><td style="width: 13% "> FECHA INICIO:</td></b>';
                            $transportista .= ' <td style="width: 50% ">' . fecha_mysql_func($guia_hos_guia) . '</td>';
                            $transportista .= ' <b><td style="width: 9% "> FECHA FIN:</td></b>';
                            $transportista .= ' <td style="width: 28% ">' . fecha_mysql_func($guia_hol_guia) . '</td>';
                            $transportista .= ' </tr>';
                        } while ($oIfx2->SiguienteRegistro());
                    }
                }

                $transportista .= ' </table>';
                $transportista .= ' <br>';
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    if (!empty($guia_cod_ccli)) {
        $sqlCcli = "select ccli_cod_ccli, ccli_nom_conta, ccli_dire_ccli
                    from saeccli
                    where ccli_cod_clpv = $guia_cod_clpv and
                    ccli_cod_ccli = $guia_cod_ccli and
                    ccli_cod_empr = $idEmpresa";
        if ($oIfx->Query($sqlCcli)) {
            if ($oIfx->NumFilas() > 0) {
                $ccli_nom_conta = $oIfx->f('ccli_nom_conta');
                $ccli_dire_ccli = $oIfx->f('ccli_dire_ccli');
            }
        }
        $oIfx->Free();
    }

    $sqlOpc = "select pedf_opc_pedf from saepedf where
			   pedf_num_preimp = (select guia_ped_guia from saeguia where guia_cod_guia = $id
			   and guia_cod_empr = $idEmpresa and guia_cod_sucu = $idSucursal)
			   and pedf_cod_empr = $idEmpresa and pedf_cod_sucu = $idSucursal and
			   pedf_cod_clpv = $guia_cod_clpv";
    $pedf_opc_pedf = consulta_string($sqlOpc, 'pedf_opc_pedf', $oIfx, '');

//SI L;A CONFIGURACION ES GUIA-FACTURA O PEDIDO-GUIA
    $para_sec_para = consulta_string("select para_sec_para from saepara where para_cod_empr = $idEmpresa
                                                and para_cod_sucu =$idSucursal", "para_sec_para", $oIfx2, '');

    $sqlDetaGuia = "select dgui_fac_dgui from saedgui where dgui_cod_guia = $id and dgui_cod_empr = $idEmpresa
                    and dgui_cod_sucu = $idSucursal group by dgui_fac_dgui";

    
                    $destinatario = '';

                    $destinatario .= ' <table style="width: 100%; border:1px solid black; border-radius: 5px; padding: 2px; font-size: 15x;">';
        
                    $destinatario .= ' <tr>';
                    $destinatario .= ' <b><td colspan="4"> DATOS DEL DESTINATARIO:</td></b>';
                    $destinatario .= ' </tr>';
        
                    $destinatario .= ' <tr>';
                    $destinatario .= ' <b><td style="width: 13%"> NOMBRE:</td></b>';
                    $destinatario .= ' <td style="width: 50% ">' . utf8_decode($guia_nom_cliente) . '</td>';
                    $destinatario .= ' <b><td style="width: 9% "> RUC/CI:</td></b>';
                    $destinatario .= ' <td style="width: 28% ">' . $guia_ruc_clie . '</td>';
                    $destinatario .= ' </tr>';
        
                    $destinatario .= ' <tr>';
                    $destinatario .= ' <b><td style="width: 13%"> DESTINO:</td></b>';
                    $destinatario .= ' <td style="width: 50% ">' . utf8_decode($ciud_des) . '</td>';
                    $destinatario .= ' <b><td style="width: 9% "> DIRECCION:</td></b>';
                    $destinatario .= ' <td style="width: 28% ">' . $guia_dir_clie . '</td>';
                    $destinatario .= ' </tr>';
        
                    $destinatario .= ' <tr>';
                    $destinatario .= ' <b><td style="width: 13% "> MOTIVO:</td></b>';
                    $destinatario .= ' <td style="width: 50% ">' . $guia_cm3_guia . '</td>';
                    $destinatario .= ' <b><td style="width: 9% "> CORREO:</td></b>';
                    $destinatario .= ' <td style="width: 28% ">' . $guia_email_clpv . '</td>';
                    $destinatario .= ' </tr>';

                    $destinatario .= ' <tr>';
                    $destinatario .= ' <b><td style="width: 13% "> RUTA:</td></b>';
                    $destinatario .= ' <td style="width: 50% ">' . $guia_ruta_guia . '</td>';
                    $destinatario .= ' <b><td style="width: 9% "> LLEGADA.:</td></b>';
                    $destinatario .= ' <td style="width: 28% ">' . $guia_tip_entr . '</td>';
                    $destinatario .= ' </tr>';
        
                    $destinatario .= ' <tr>';
                    $destinatario .= ' <b><td style="width: 13% "> OBSERVACION:</td></b>';
                    $destinatario .= ' <td style="width: 50% ">' . $guia_cm1_guia . '</td>';
                    $destinatario .= ' <b><td style="width: 9% "> PESO(KG):</td></b>';
                    $destinatario .= ' <td style="width: 28% ">' . number_format($guia_peso_bruto, 2, '.', ',') . '</td>';
                    $destinatario .= ' </tr>';

    if ($oIfx->Query($sqlDetaGuia)) {
        if ($oIfx->NumFilas() > 0) {

          
            do {
             

                $dgui_fac_dgui = $oIfx->f("dgui_fac_dgui");

             

                if ($dgui_fac_dgui != '' && $para_sec_para == 1) {
                    $sqlFact = "select fact_nse_fact, fact_num_preimp, fact_auto_sri, fact_fech_fact from saefact where
                                    fact_cod_fact = $dgui_fac_dgui and fact_cod_empr = $idEmpresa and fact_cod_sucu = $idSucursal";

                    if ($oIfx2->Query($sqlFact)) {
                        if ($oIfx2->NumFilas() > 0) {
                            do {
                                $serie = substr($oIfx2->f("fact_nse_fact"), 0, 3);
                                $ptoEmi = substr($oIfx2->f("fact_nse_fact"), 3, 3);
                                $fact_num_preimp = $oIfx2->f("fact_num_preimp");
                                $fact_auto_sri = $oIfx2->f("fact_auto_sri");
                                $fact_fech_fact = $oIfx2->f("fact_fech_fact");

                                $numDocSustento = $serie . '-' . $ptoEmi . '-' . $fact_num_preimp;

                                $destinatario .= ' <tr>';
                                $destinatario .= ' <b><td colspan="3"> DATOS DE LA FACTURA QUE APLICA:</td></b>';
                                $destinatario .= ' </tr>';

                                $destinatario .= ' <tr>';
                                $destinatario .= ' <b><td style="width: 13%"> NUMERO:</td></b>';
                                $destinatario .= ' <td style="width: 50% ">' . $numDocSustento . '</td>';
                                $destinatario .= ' <b><td style="width: 15% "> FECHA:</td></b>';
                                $destinatario .= ' <td style="width: 22% ">' . $fact_fech_fact . '</td>';
                                $destinatario .= ' </tr>';

                                $destinatario .= ' <tr>';
                                $destinatario .= ' <b><td style="width: 13%"> AUTORIZACION:</td></b>';
                                $destinatario .= ' <td style="width: 50% ">' . $fact_auto_sri . '</td>';
                                $destinatario .= ' </tr>';
                            } while ($oIfx2->SiguienteRegistro());
                        }
                    }
                    $sqlDeta = "select dgui_cod_prod, dgui_cant_dgui, dgui_nom_prod, dgui_cod_lote from saedgui where dgui_fac_dgui = '$dgui_fac_dgui' and dgui_cod_guia = $id
                                    and dgui_cod_empr = $idEmpresa and dgui_cod_sucu = $idSucursal";
                } else if ($dgui_fac_dgui == '' && $para_sec_para == 1)
                    $sqlDeta = "select dgui_cod_prod, dgui_cant_dgui, dgui_nom_prod, dgui_cod_lote from saedgui where (dgui_fac_dgui = ''  or  dgui_fac_dgui is null ) and dgui_cod_guia = $id
                                    and dgui_cod_empr = $idEmpresa and dgui_cod_sucu = $idSucursal";
                else
                    $sqlDeta = "select dgui_cod_prod, dgui_cant_dgui, dgui_nom_prod, dgui_cod_lote from saedgui where dgui_cod_guia = $id
                                    and dgui_cod_empr = $idEmpresa and dgui_cod_sucu = $idSucursal";

               // $destinatario .= ' </table>';
               // $destinatario .= ' <br>';
                $oIfx2->Free();

                if ($oIfx2->Query($sqlDeta)) {
                    if ($oIfx2->NumFilas() > 0) {
                        $detalle = '';

                        $detalle .= ' <table style="width: 100%; font-size: 12px; border-radius: 5px; border-collapse: collapse;" border="1">';
                        $detalle .= ' <tr>';
                        $detalle .= ' <b> <td style="width: 15%;  border: 1px inset black;" align="center">CODIGO</td> </b>';
                        $detalle .= ' <b> <td style="width: 25%;  border: 1px inset black;" align="center"> PRODUCTO</td> </b>';
                        $detalle .= ' <b> <td style="width: 50%;  border: 1px inset black;" align="center">DESCRIPCION</td> </b>';
                        $detalle .= ' <b> <td style="width: 10%;  border: 1px inset black;" align="center">CANTIDAD</td> </b>';
                        $detalle .= ' </tr>';
                        $a = 0;
                        do {
                            $codigoInterno = $codigoAdicional = $oIfx2->f("dgui_cod_prod");

                           // $sql="SELECT tipo_merc, cantidad from agricola.despacho_prod";
                            $sqlprod="select prod_nom_prod from saeprod where prod_cod_prod='$codigoInterno' and prod_cod_empr=$idEmpresa";
                            $producto = consulta_string($sqlprod, 'prod_nom_prod', $oIfx1, '');

                            $cantidad = $oIfx2->f("dgui_cant_dgui");
                            $descripcion = $oIfx2->f("dgui_nom_prod");
                            $lote = $oIfx2->f("dgui_cod_lote");

                            $detalle .= ' <tr>';
                            $detalle .= ' <td style="width: 15%; border: 1px inset black;" align="center">' . $codigoInterno . '</td>';
                            $detalle .= ' <td style="width: 25%; border: 1px inset black;">' . $producto . '</td>';
                            $detalle .= ' <td style="width: 50%; border: 1px inset black;">' . $descripcion . '</td>';
                            $detalle .= ' <td style="width: 10%; border: 1px inset black;" align="right">' . round($cantidad, 0) . '</td>';
                            $detalle .= ' </tr>';

                            $a = $a + $cantidad;
                        } while ($oIfx2->SiguienteRegistro());
                    }
                }


                $detalle .= ' <tr>';
                $detalle .= ' <td style="width: 15%;"></td>';
                $detalle .= ' <td style="width: 25%;"></td>';
                $detalle .= ' <td style="width: 50%;" align="right"></td>';
                $detalle .= ' <b><td style="width: 10%;" align="right">' . number_format($a, 2, '.', ',') . '</td></b>';
                $detalle .= ' </tr>';
                $detalle .= ' </table>';

                $oIfx2->Free();

              
                /* $detalle .= ' </td>';
                  $detalle .= ' </tr>';
                  $detalle .= ' </table>'; */
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $destinatario .= ' </table>';

    $documentos .= $destinatario . $detalle;

    

    $oIfx->Free();

    $total = number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_fle_fact + $fact_otr_fact + $fact_fin_fact - $totalDescuento, 2, '.', '');
    $V = new EnLetras();
    $con_letra = strtoupper($V->ValorEnLetras($total, 'dolar'));

    /* $totales .= '<table style="width: 100%;">';
      $totales .= '<tr>';
      $totales .= '<td>TOTAL :  </td>';
      $totales .= '<td>' . $con_letra . '</td>';
      $totales .= '</tr>';
      $totales .= '</tr>';
      $totales .= '</table>'; */

    $legend = '<page_footer>
        <table align="center" style="width: 80%">
            <tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">Este comprobante electronico ha sido generado a traves de Sisconti S.A. - Facturacion Electronica</td>
            </tr>
			<tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">www.sisconti.com.ec</td>
            </tr>
        </table>
    </page_footer>';

    $documento .= '<page backimgw="70%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
    $documento .= $logo . $transportista . $documentos;
    $documento .= $legend;
    $documento .= '</page>';

    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;


    //eliminaArchivos(DIR_FACTELEC . 'Include/archivos/');

    return $documento;
}



function reporte_guiaRemision_ANT($id = '', $nombre_archivo = '', $idSucursal, &$rutaPdf = '')
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    //$idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_sn_conta, empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo
                                            from saeempr where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_sn_conta = $oIfx->f('empr_sn_conta');
        }
    }
    $oIfx->Free();

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis, sucu_dir_sucu  
			from saesucu 
			where sucu_cod_empr = $idEmpresa and 
			sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
            $sucu_dir = $oIfx->f('sucu_dir_sucu');
        }
    }
    $oIfx->Free();

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }


    $logo .= '<table style="width: 100%; margin: 0px;">';
    $logo .= '<tr>';
    $logo .= '<b><td align="center" style="width: 60%; border:1px solid black; border-radius: 5px; margin: 0px;">';
    $logo .= '<table align="center" style="margin: 0px;">';
    $logo .= '<tr><td style="margin-top: 0px;"><img width="200px;" height="150px;" src="' . $empr_path_logo . '"></td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 20px;">' . $razonSocial . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 16px;">RUC : ' . $ruc_empr . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';

    //selecciona sucursales y direcciones
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa";
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                //$logo .= '<tr><td align="center" style="font-size: 13px">' . $sucu_nom_sucu . ': ' . htmlentities($sucu_dir_sucu) . '</td></tr>';
                $logo .= '<tr><td align="center" style="font-size: 13px">SUCURSAL : ' . $sucu_nom_sucu . '</td></tr>';
                $logo .= '<tr><td align="center" style="font-size: 13px">' . htmlentities($sucu_dir_sucu) . '</td></tr>';
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    $logo .= '<tr><td>&nbsp;</td></tr>';
    //$logo .= '<tr><td align="center" style="font-size: 12px;">Contribuyente Especial #:' . $empr_num_resu . '</td></tr>';
    if($empr_conta_sn=='SI'){
        if($empr_sn_conta=='S'){
            $empr_sn_conta ='SI';
        }
        else{
            $empr_sn_conta ='NO';
        }
        $logo .= '<tr><td align="center" style="font-size: 12px;">Obligado a llevar Contabilidad :' . $empr_sn_conta . '</td></tr>';
    }
    $logo .= ' </table>';
    $logo .= '</td></b>';

    $sqlFac = "select * from saeguia where guia_cod_guia = $id and guia_cod_sucu = $idSucursal and guia_cod_empr = $idEmpresa ";

    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $guia_nse_guia = $oIfx->f('guia_nse_guia');
                $guia_num_preimp = $oIfx->f('guia_num_preimp');
                $guia_auto_sri = $oIfx->f('guia_auto_sri');
                $guia_fech_sri = $oIfx->f('guia_fech_sri');
                $guia_nom_cliente = $oIfx->f('guia_nom_cliente');
                $guia_fech_guia = fecha_mysql_func($oIfx->f('guia_fech_guia'));
                $guia_ruc_clie = $oIfx->f('guia_ruc_clie');
                $guia_tlf_cliente = $oIfx->f('guia_tlf_cliente');
                $guia_dir_clie = $oIfx->f('guia_dir_clie');
                $guia_email_clpv = $oIfx->f('guia_email_clpv');
                //$ncre_cod_fact = $oIfx->f('ncre_cod_fact');
                $guia_cm3_guia = $oIfx->f('guia_cm3_guia');
                $guia_cod_trta = $oIfx->f('guia_cod_trta');
                $guia_num_plac = $oIfx->f('guia_num_plac');
                $guia_hos_guia = $oIfx->f('guia_hos_guia');
                $guia_hol_guia = $oIfx->f('guia_hol_guia');
                $guia_clav_sri = $oIfx->f('guia_clav_sri');
                $guia_sal_guia = $oIfx->f('guia_sal_guia');
                $guia_cod_ccli = $oIfx->f('guia_cod_ccli');
                $guia_cod_clpv = $oIfx->f('guia_cod_clpv');
                $guia_cm1_guia = $oIfx->f('guia_cm1_guia');

                $logo .= '<b><td style="width: 40%; border: 1px solid black; border-radius: 5px;" align="center">';
                $logo .= ' <table align="center" style="font-size: 15px;">';
                $logo .= ' <tr>';
                $logo .= '<td style="border-bottom: 1px inset black;">GUIA DE REMISION</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>SERIE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . substr($guia_nse_guia, 0, 3) . '-' . substr($guia_nse_guia, 3, 6) . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="font-size: 17px; color: red; border-bottom: 1;">' . $guia_num_preimp . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $guia_auto_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top: 1;">FECHA AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $guia_fech_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1">AMBIENTE: </td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $ambiente_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td style="border-top:1">EMISION: </td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $emision_sri . '</td>';
                $logo .= ' </tr>';

                if ($guia_clav_sri != '') {
                    $nombArch = $guia_nse_guia . $guia_num_preimp;
                    $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';

                    new barCodeGenrator($guia_clav_sri, 1, $rutaCodi, 450, 100, true);

                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="right" style="font-size: 12px;">CLAVE DE ACCESO:</td>';
                    $logo .= '</tr>';
                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="right"> <img width="350px;" src="' . $rutaCodi . '"/></td>';
                    $logo .= '</tr>';
                }

                $logo .= ' </table>';
                $logo .= '</td></b>';
                $logo .= '</tr>';
                $logo .= '</table>';
                $logo .= ' <br>';


                //DATOS DEL TRANSPORTISTA
                if (!empty($guia_cod_trta)) {
                    $sqlTran = "select * from saetrta where trta_cod_trta = '$guia_cod_trta' and trta_cod_empr = $idEmpresa ";
                } else {
                    $sqlTran = "select * from saetrta where trta_cid_trta = '$guia_sal_guia' and trta_cod_empr = $idEmpresa ";
                }

                $transportista .= ' <table style="width: 100%; border:1px solid black; border-radius: 5px; padding: 2px; font-size: 15x;">';
                $transportista .= ' <tr>';
                $transportista .= ' <b><td colspan="4"> DATOS DEL TRANSPORTISTA : </td></b>';
                $transportista .= ' </tr>';

                if ($oIfx2->Query($sqlTran)) {
                    if ($oIfx2->NumFilas() > 0) {
                        do {
                            //$oReturn->alert('si');
                            $trta_nom_trta = $oIfx2->f("trta_nom_trta");
                            $trta_cid_trta = $oIfx2->f("trta_cid_trta");

                            $transportista .= ' <tr>';
                            $transportista .= ' <b><td style="width: 13%"> NOMBRE:</td></b>';
                            $transportista .= ' <td style="width: 50% ">' . utf8_decode($trta_nom_trta) . '</td>';
                            $transportista .= ' <b><td style="width: 15% "> RUC/CI:</td></b>';
                            $transportista .= ' <td style="width: 22% ">' . $trta_cid_trta . '</td>';
                            $transportista .= ' </tr>';

                            $transportista .= ' <tr>';
                            $transportista .= ' <b><td style="width: 13% "> PARTIDA:</td></b>';
                            $transportista .= ' <td style="width: 50% ">' . utf8_decode($sucu_dir) . '</td>';
                            $transportista .= ' <b><td style="width: 15% "> PLACA:</td></b>';
                            $transportista .= ' <td style="width: 22% ">' . $guia_num_plac . '</td>';
                            $transportista .= ' </tr>';

                            $transportista .= ' <tr>';
                            $transportista .= ' <b><td style="width: 13% "> FECHA INICIO:</td></b>';
                            $transportista .= ' <td style="width: 50% ">' . fecha_mysql_func($guia_hos_guia) . '</td>';
                            $transportista .= ' <b><td style="width: 15% "> FECHA FIN:</td></b>';
                            $transportista .= ' <td style="width: 22% ">' . fecha_mysql_func($guia_hol_guia) . '</td>';
                            $transportista .= ' </tr>';
                        } while ($oIfx2->SiguienteRegistro());
                    }
                }

                $transportista .= ' </table>';
                $transportista .= ' <br>';
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    if (!empty($guia_cod_ccli)) {
        $sqlCcli = "select ccli_cod_ccli, ccli_nom_conta, ccli_dire_ccli
                    from saeccli
                    where ccli_cod_clpv = $guia_cod_clpv and
                    ccli_cod_ccli = $guia_cod_ccli and
                    ccli_cod_empr = $idEmpresa";
        if ($oIfx->Query($sqlCcli)) {
            if ($oIfx->NumFilas() > 0) {
                $ccli_nom_conta = $oIfx->f('ccli_nom_conta');
                $ccli_dire_ccli = $oIfx->f('ccli_dire_ccli');
            }
        }
        $oIfx->Free();
    }

    $sqlOpc = "select pedf_opc_pedf from saepedf where
			   pedf_num_preimp = (select guia_ped_guia from saeguia where guia_cod_guia = $id
			   and guia_cod_empr = $idEmpresa and guia_cod_sucu = $idSucursal)
			   and pedf_cod_empr = $idEmpresa and pedf_cod_sucu = $idSucursal and
			   pedf_cod_clpv = $guia_cod_clpv";
    $pedf_opc_pedf = consulta_string($sqlOpc, 'pedf_opc_pedf', $oIfx, '');

//SI L;A CONFIGURACION ES GUIA-FACTURA O PEDIDO-GUIA
    $para_sec_para = consulta_string("select para_sec_para from saepara where para_cod_empr = $idEmpresa
                                                and para_cod_sucu =$idSucursal", "para_sec_para", $oIfx2, '');

    $sqlDetaGuia = "select dgui_fac_dgui from saedgui where dgui_cod_guia = $id and dgui_cod_empr = $idEmpresa
                    and dgui_cod_sucu = $idSucursal group by dgui_fac_dgui";

    if ($oIfx->Query($sqlDetaGuia)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $destinatario = '';

                $dgui_fac_dgui = $oIfx->f("dgui_fac_dgui");

                $destinatario .= ' <table style="width: 100%; border:1px solid black; border-radius: 5px; padding: 2px; font-size: 15x;">';

                $destinatario .= ' <tr>';
                $destinatario .= ' <b><td colspan="4"> DATOS DEL DESTINATARIO:</td></b>';
                $destinatario .= ' </tr>';

                $destinatario .= ' <tr>';
                $destinatario .= ' <b><td style="width: 13%"> NOMBRE:</td></b>';
                $destinatario .= ' <td style="width: 50% ">' . utf8_decode($guia_nom_cliente) . '</td>';
                $destinatario .= ' <b><td style="width: 15% "> RUC/CI:</td></b>';
                $destinatario .= ' <td style="width: 22% ">' . $guia_ruc_clie . '</td>';
                $destinatario .= ' </tr>';

                $destinatario .= ' <tr>';
                $destinatario .= ' <b><td style="width: 13%"> DESTINO:</td></b>';
                $destinatario .= ' <td style="width: 50% ">' . utf8_decode($ccli_dire_ccli) . '</td>';
                $destinatario .= ' </tr>';

                $destinatario .= ' <tr>';
                $destinatario .= ' <b><td style="width: 13% "> MOTIVO:</td></b>';
                $destinatario .= ' <td style="width: 50% ">' . $guia_cm3_guia . '</td>';
                $destinatario .= ' <b><td style="width: 15% "> ESTAB.:</td></b>';
                $destinatario .= ' <td style="width: 22% ">' . $ccli_nom_conta . '</td>';
                $destinatario .= ' </tr>';

                $destinatario .= ' <tr>';
                $destinatario .= ' <b><td style="width: 13% "> CORREO:</td></b>';
                $destinatario .= ' <td style="width: 50% ">' . $guia_email_clpv . '</td>';
                $destinatario .= ' <b><td style="width: 15% "> ORDEN COMPRA:</td></b>';
                $destinatario .= ' <td style="width: 22% ">' . $pedf_opc_pedf . '</td>';
                $destinatario .= ' </tr>';

                $destinatario .= ' <tr>';
                $destinatario .= ' <b><td style="width: 13% "> NOTA:</td></b>';
                $destinatario .= ' <td style="width: 50% ">' . $guia_cm1_guia . '</td>';
                $destinatario .= ' </tr>';

                if ($dgui_fac_dgui != '' && $para_sec_para == 1) {
                    $sqlFact = "select fact_nse_fact, fact_num_preimp, fact_auto_sri, fact_fech_fact from saefact where
                                    fact_cod_fact = $dgui_fac_dgui and fact_cod_empr = $idEmpresa and fact_cod_sucu = $idSucursal";

                    if ($oIfx2->Query($sqlFact)) {
                        if ($oIfx2->NumFilas() > 0) {
                            do {
                                $serie = substr($oIfx2->f("fact_nse_fact"), 0, 3);
                                $ptoEmi = substr($oIfx2->f("fact_nse_fact"), 3, 3);
                                $fact_num_preimp = $oIfx2->f("fact_num_preimp");
                                $fact_auto_sri = $oIfx2->f("fact_auto_sri");
                                $fact_fech_fact = $oIfx2->f("fact_fech_fact");

                                $numDocSustento = $serie . '-' . $ptoEmi . '-' . $fact_num_preimp;

                                $destinatario .= ' <tr>';
                                $destinatario .= ' <b><td colspan="3"> DATOS DE LA FACTURA QUE APLICA:</td></b>';
                                $destinatario .= ' </tr>';

                                $destinatario .= ' <tr>';
                                $destinatario .= ' <b><td style="width: 13%"> NUMERO:</td></b>';
                                $destinatario .= ' <td style="width: 50% ">' . $numDocSustento . '</td>';
                                $destinatario .= ' <b><td style="width: 15% "> FECHA:</td></b>';
                                $destinatario .= ' <td style="width: 22% ">' . $fact_fech_fact . '</td>';
                                $destinatario .= ' </tr>';

                                $destinatario .= ' <tr>';
                                $destinatario .= ' <b><td style="width: 13%"> AUTORIZACION:</td></b>';
                                $destinatario .= ' <td style="width: 50% ">' . $fact_auto_sri . '</td>';
                                $destinatario .= ' </tr>';
                            } while ($oIfx2->SiguienteRegistro());
                        }
                    }
                    $sqlDeta = "select dgui_cod_prod, dgui_cant_dgui, dgui_nom_prod from saedgui where dgui_fac_dgui = '$dgui_fac_dgui' and dgui_cod_guia = $id
                                    and dgui_cod_empr = $idEmpresa and dgui_cod_sucu = $idSucursal";
                } else if ($dgui_fac_dgui == '' && $para_sec_para == 1)
                    $sqlDeta = "select dgui_cod_prod, dgui_cant_dgui, dgui_nom_prod, dgui_cod_lote from saedgui where (dgui_fac_dgui = ''  or  dgui_fac_dgui is null ) and dgui_cod_guia = $id
                                    and dgui_cod_empr = $idEmpresa and dgui_cod_sucu = $idSucursal";
                else
                    $sqlDeta = "select dgui_cod_prod, dgui_cant_dgui, dgui_nom_prod, dgui_cod_lote from saedgui where dgui_cod_guia = $id
                                    and dgui_cod_empr = $idEmpresa and dgui_cod_sucu = $idSucursal";

                $destinatario .= ' </table>';
                $destinatario .= ' <br>';
                $oIfx2->Free();

                if ($oIfx2->Query($sqlDeta)) {
                    if ($oIfx2->NumFilas() > 0) {
                        $detalle = '';

                        $detalle .= ' <table style="width: 100%; font-size: 13px; border-radius: 5px; border-collapse: collapse;" border="1">';
                        $detalle .= ' <tr>';
                        $detalle .= ' <b> <td style="width: 18%;  border: 1px inset black;">CODIGO</td> </b>';
                        $detalle .= ' <b> <td style="width: 10;  border: 1px inset black;">LOTE</td> </b>';
                        $detalle .= ' <b> <td style="width: 40%;  border: 1px inset black;">DESCRIPCION</td> </b>';
                        $detalle .= ' <b> <td style="width: 10%;  border: 1px inset black;">CANTIDAD</td> </b>';
                        $detalle .= ' <b> <td style="width: 10%;  border: 1px inset black;">N.- CAJAS</td> </b>';
                        $detalle .= ' <b> <td style="width: 12%;  border: 1px inset black;">N.- UNIDADES</td> </b>';
                        $detalle .= ' </tr>';
                        do {
                            $codigoInterno = $codigoAdicional = $oIfx2->f("dgui_cod_prod");
                            $cantidad = $oIfx2->f("dgui_cant_dgui");
                            $descripcion = $oIfx2->f("dgui_nom_prod");
                            $lote = $oIfx2->f("dgui_cod_lote");

                            $detalle .= ' <tr>';
                            $detalle .= ' <td style="width: 18%; border: 1px inset black;">' . $codigoInterno . '</td>';
                            $detalle .= ' <td style="width: 10%; border: 1px inset black;">' . $lote . '</td>';
                            $detalle .= ' <td style="width: 40%; border: 1px inset black;">' . $descripcion . '</td>';
                            $detalle .= ' <td style="width: 10%; border: 1px inset black;" align="right">' . round($cantidad, 0) . '</td>';
                            $detalle .= ' <td style="width: 10%; border: 1px inset black;"></td>';
                            $detalle .= ' <td style="width: 12%; border: 1px inset black;"></td>';
                            $detalle .= ' </tr>';
                        } while ($oIfx2->SiguienteRegistro());
                        $detalle .= ' </table>';
                        $detalle .= ' <br><br><br>';
                    }
                }
                $oIfx2->Free();

                $documentos .= $destinatario . $detalle;
                /* $detalle .= ' </td>';
                  $detalle .= ' </tr>';
                  $detalle .= ' </table>'; */
            } while ($oIfx->SiguienteRegistro());
        }
    }

    //$destinatario .= ' </table>';

    $oIfx->Free();

    $total = number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_fle_fact + $fact_otr_fact + $fact_fin_fact - $totalDescuento, 2, '.', '');
    $V = new EnLetras();
    $con_letra = strtoupper($V->ValorEnLetras($total, 'dolar'));

    /* $totales .= '<table style="width: 100%;">';
      $totales .= '<tr>';
      $totales .= '<td>TOTAL :  </td>';
      $totales .= '<td>' . $con_letra . '</td>';
      $totales .= '</tr>';
      $totales .= '</table>'; */

    $legend = '<page_footer>
        <table align="center" style="width: 80%">
            <tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">Este comprobante electronico ha sido generado a traves de Sisconti S.A. - Facturacion Electronica</td>
            </tr>
			<tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">www.sisconti.com.ec</td>
            </tr>
        </table>
    </page_footer>';

    $documento .= '<page backimgw="70%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
    $documento .= $logo . $transportista . $documentos;
    $documento .= $legend;
    $documento .= '</page>';

    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;


    //eliminaArchivos(DIR_FACTELEC . 'Include/archivos/');

    return $documento;
}

function reporte_guiaRemisionFlor($id = '', $nombre_archivo = '', &$rutaPdf = '')
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();

    $oIfx3 = new Dbo;
    $oIfx3->DSN = $DSN_Ifx;
    $oIfx3->Conectar();

    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_sn_conta, empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo
                                            from saeempr where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_sn_conta = $oIfx->f('empr_sn_conta');
        }
    }
    $oIfx->Free();

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis  from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
        }
    }
    $oIfx->Free();

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }


    $logo .= '<table style="width: 100%; margin: 0px;">';
    $logo .= '<tr>';
    $logo .= '<b><td align="center" style="width: 60%; border:1px solid black; border-radius: 5px; margin: 0px;">';
    $logo .= '<table align="center" style="margin: 0px;">';
    $logo .= '<tr><td style="margin-top: 0px;"><img width="200px;" height="150px;" src="' . $empr_path_logo . '"></td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 20px;">' . $razonSocial . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 16px;">RUC : ' . $ruc_empr . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 14px;">RUC : ' . $dirMatriz . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 12px;">Contribuyente Especial #:' . $empr_num_resu . '</td></tr>';
    if($empr_conta_sn=='SI'){
        if($empr_sn_conta=='S'){
            $empr_sn_conta ='SI';
        }
        else{
            $empr_sn_conta ='NO';
        }
        $logo .= '<tr><td align="center" style="font-size: 12px;">Obligado a llevar Contabilidad :' . $empr_sn_conta . '</td></tr>';
    }

    $logo .= ' </table>';
    $logo .= '</td></b>';

    $sqlFac = "select * from saegref where gref_cod_gref = $id and gref_cod_sucu = $idSucursal and gref_cod_empr = $idEmpresa ";

    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $gref_cod_gref = $oIfx->f('gref_cod_gref');
                $gref_nse_gref = $oIfx->f('gref_nse_gref');
                $graf_num_guia = $oIfx->f('graf_num_guia');
                $gref_auto_sri = $oIfx->f('gref_auto_sri');
                $gref_fech_sri = $oIfx->f('gref_fech_sri');
                $gref_cod_clpv = $oIfx->f('gref_cod_clpv');
                $gref_fec_emis = fecha_mysql_func($oIfx->f('gref_fec_emis'));
                $guia_tlf_cliente = $oIfx->f('guia_tlf_cliente');
                $guia_dir_clie = $oIfx->f('guia_dir_clie');
                $gref_email_clpv = $oIfx->f('gref_email_clpv');
                $guia_cm3_guia = $oIfx->f('gref_mot_tras');
                $gref_nom_trans = $oIfx->f('gref_nom_trans');
                $guia_num_plac = $oIfx->f('guia_num_plac');
                $gref_fec_sal = $oIfx->f('gref_fec_sali');
                $gref_fec_lleg = $oIfx->f('gref_fec_lleg');
                $gref_clav_sri = $oIfx->f('gref_clav_sri');
                $gref_dir_ccli = $oIfx->f('gref_dir_ccli');
                $gref_dir_part = $oIfx->f('gref_dir_part');

                //query datos del cliente
                $sql = "select clpv_ruc_clpv, clpv_nom_clpv from saeclpv
                        where clpv_cod_clpv = $gref_cod_clpv and
                        clpv_cod_empr = $idEmpresa";
                if ($oIfx2->Query($sql)) {
                    if ($oIfx2->NumFilas() > 0) {
                        $clpv_ruc_clpv = $oIfx2->f('clpv_ruc_clpv');
                        $clpv_nom_clpv = $oIfx2->f('clpv_nom_clpv');
                    }
                }


                $logo .= '<b><td style="width: 40%; border: 1px solid black; border-radius: 5px;" align="center">';
                $logo .= ' <table align="center" style="font-size: 15px;">';
                $logo .= ' <tr>';
                $logo .= '<td style="border-bottom: 1px inset black;">GUIA DE REMISION</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>SERIE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . substr($gref_nse_gref, 0, 3) . '-' . substr($gref_nse_gref, 3, 6) . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="font-size: 17px; color: red; border-bottom: 1;">' . $graf_num_guia . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $gref_auto_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top: 1;">FECHA AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $gref_fech_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1">AMBIENTE: </td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $ambiente_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td style="border-top:1">EMISION: </td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $emision_sri . '</td>';
                $logo .= ' </tr>';

                if ($gref_clav_sri != '') {
                    $nombArch = $gref_nse_gref . $graf_num_guia;
                    $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';

                    new barCodeGenrator($gref_clav_sri, 1, $rutaCodi, 450, 100, true);

                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="right" style="font-size: 12px;">CLAVE DE ACCESO:</td>';
                    $logo .= '</tr>';
                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="right"> <img width="350px;" src="' . $rutaCodi . '"/></td>';
                    $logo .= '</tr>';
                }

                $logo .= ' </table>';
                $logo .= '</td></b>';
                $logo .= '</tr>';
                $logo .= '</table>';
                $logo .= ' <br>';


                //DATOS DEL TRANSPORTISTA
                if (!empty($gref_nom_trans)) {
                    $sqlTran = "select * from saetrta where trta_cod_trta = '$gref_nom_trans' and trta_cod_empr = $idEmpresa ";
                }

                $transportista .= ' <table style="width: 100%; border:1px solid black; border-radius: 5px; padding: 2px; font-size: 15x;">';
                $transportista .= ' <tr>';
                $transportista .= ' <b><td colspan="4"> DATOS DEL TRANSPORTISTA : </td></b>';
                $transportista .= ' </tr>';

                if ($oIfx2->Query($sqlTran)) {
                    if ($oIfx2->NumFilas() > 0) {
                        do {
                            //$oReturn->alert('si');
                            $trta_nom_trta = $oIfx2->f("trta_nom_trta");
                            $trta_cid_trta = $oIfx2->f("trta_cid_trta");
                            $trta_plc_cami = $oIfx2->f("trta_plc_cami");

                            $transportista .= ' <tr>';
                            $transportista .= ' <b><td style="width: 13%"> NOMBRE:</td></b>';
                            $transportista .= ' <td style="width: 50% ">' . htmlentities($trta_nom_trta) . '</td>';
                            $transportista .= ' <b><td style="width: 15% "> RUC/CI:</td></b>';
                            $transportista .= ' <td style="width: 22% ">' . $trta_cid_trta . '</td>';
                            $transportista .= ' </tr>';

                            $transportista .= ' <tr>';
                            $transportista .= ' <b><td style="width: 13% "> PARTIDA:</td></b>';
                            $transportista .= ' <td style="width: 50% ">' . htmlentities($gref_dir_ccli) . '</td>';
                            $transportista .= ' <b><td style="width: 15% "> PLACA:</td></b>';
                            $transportista .= ' <td style="width: 22% ">' . $trta_plc_cami . '</td>';
                            $transportista .= ' </tr>';

                            $transportista .= ' <tr>';
                            $transportista .= ' <b><td style="width: 13% "> FECHA INICIO:</td></b>';
                            $transportista .= ' <td style="width: 50% ">' . fecha_mysql_func($gref_fec_sal) . '</td>';
                            $transportista .= ' <b><td style="width: 15% "> FECHA FIN:</td></b>';
                            $transportista .= ' <td style="width: 22% ">' . fecha_mysql_func($gref_fec_lleg) . '</td>';
                            $transportista .= ' </tr>';
                        } while ($oIfx2->SiguienteRegistro());
                    }
                }

                $transportista .= ' </table>';
                $transportista .= ' <br>';
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();


    //SI LA CONFIGURACION ES GUIA-FACTURA O PEDIDO-GUIA
    $para_sec_para = consulta_string("select para_sec_para from saepara where para_cod_empr = $idEmpresa
                                                and para_cod_sucu = $idSucursal", "para_sec_para", $oIfx2, '');

    $sqlDetaGuia = "select dguf_cod_fpak from saedguf where dguf_cod_gref = $id and dguf_cod_empr = $idEmpresa
                    and dguf_cod_sucu = $idSucursal";

    if ($oIfx->Query($sqlDetaGuia)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $destinatario = '';
                $destinatario .= ' <table style="width: 100%; border:1px solid black; border-radius: 5px; padding: 2px; font-size: 15x;">';

                $destinatario .= ' <tr>';
                $destinatario .= ' <b><td colspan="4"> DATOS DEL DESTINATARIO:</td></b>';
                $destinatario .= ' </tr>';

                $destinatario .= ' <tr>';
                $destinatario .= ' <b><td style="width: 13%"> NOMBRE:</td></b>';
                $destinatario .= ' <td style="width: 50% ">' . htmlentities($clpv_nom_clpv) . '</td>';
                $destinatario .= ' <b><td style="width: 15% "> RUC/CI:</td></b>';
                $destinatario .= ' <td style="width: 22% ">' . $clpv_ruc_clpv . '</td>';
                $destinatario .= ' </tr>';

                $destinatario .= ' <tr>';
                $destinatario .= ' <b><td style="width: 13%"> DESTINO:</td></b>';
                $destinatario .= ' <td style="width: 50% ">' . htmlentities($gref_dir_part) . '</td>';
                $destinatario .= ' </tr>';

                $destinatario .= ' <tr>';
                $destinatario .= ' <b><td style="width: 13% "> MOTIVO:</td></b>';
                $destinatario .= ' <td style="width: 50% ">' . $guia_cm3_guia . '</td>';
                $destinatario .= ' </tr>';

                $destinatario .= ' <tr>';
                $destinatario .= ' <b><td style="width: 13% "> CORREO:</td></b>';
                $destinatario .= ' <td style="width: 50% ">' . $gref_email_clpv . '</td>';
                $destinatario .= ' </tr>';

                $dguf_cod_fpak = $oIfx->f("dguf_cod_fpak");

                if ($dgui_fac_dgui != '' && $para_sec_para == 1) {
                    $sqlFact = "select fact_nse_fact, fact_num_preimp, fact_auto_sri, fact_fech_fact from saefact where
                                    fact_cod_fact = $dguf_cod_fpak and fact_cod_empr = $idEmpresa and fact_cod_sucu = $idSucursal";

                    if ($oIfx2->Query($sqlFact)) {
                        if ($oIfx2->NumFilas() > 0) {
                            do {
                                $serie = substr($oIfx2->f("fact_nse_fact"), 0, 3);
                                $ptoEmi = substr($oIfx2->f("fact_nse_fact"), 3, 3);
                                $fact_num_preimp = $oIfx2->f("fact_num_preimp");
                                $fact_auto_sri = $oIfx2->f("fact_auto_sri");
                                $fact_fech_fact = $oIfx2->f("fact_fech_fact");

                                $numDocSustento = $serie . '-' . $ptoEmi . '-' . $fact_num_preimp;

                                $destinatario .= ' <tr>';
                                $destinatario .= ' <b><td colspan="3"> DATOS DE LA FACTURA QUE APLICA:</td></b>';
                                $destinatario .= ' </tr>';

                                $destinatario .= ' <tr>';
                                $destinatario .= ' <b><td style="width: 13%"> NUMERO:</td></b>';
                                $destinatario .= ' <td style="width: 50% ">' . $numDocSustento . '</td>';
                                $destinatario .= ' <b><td style="width: 15% "> FECHA:</td></b>';
                                $destinatario .= ' <td style="width: 22% ">' . $fact_fech_fact . '</td>';
                                $destinatario .= ' </tr>';

                                $destinatario .= ' <tr>';
                                $destinatario .= ' <b><td style="width: 13%"> AUTORIZACION:</td></b>';
                                $destinatario .= ' <td style="width: 50% ">' . $fact_auto_sri . '</td>';
                                $destinatario .= ' </tr>';
                            } while ($oIfx2->SiguienteRegistro());
                        }
                    }
                    $sqlDeta = "select dguf_cod_ramo, dguf_can_dguf, dguf_cod_vard from saedguf where dguf_cod_gref = $gref_cod_gref and dguf_cod_fpak = $dguf_cod_fpak
                                    and dguf_cod_empr = $idEmpresa and dguf_cod_sucu = $idSucursal";
                } else if ($dguf_cod_fpak == '' && $para_sec_para == 1)
                    $sqlDeta = "select dguf_cod_ramo, dguf_can_dguf, dguf_cod_vard from saedguf where dguf_cod_gref = $gref_cod_gref and (dguf_cod_fpak is null or dguf_cod_fpak = '') 
                                    and dguf_cod_empr = $idEmpresa and dguf_cod_sucu = $idSucursal";
                else
                    $sqlDeta = "select dguf_cod_ramo, dguf_can_dguf, dguf_cod_vard from saedguf where dguf_cod_gref = $gref_cod_gref 
                                    and dguf_cod_empr = $idEmpresa and dguf_cod_sucu = $idSucursal";


                $destinatario .= ' </table>';
                $destinatario .= ' <br>';
                $oIfx2->Free();
                if ($oIfx2->Query($sqlDeta)) {
                    if ($oIfx2->NumFilas() > 0) {
                        $detalle = '';

                        $detalle .= ' <table align="center" style="width: 100%; font-size: 13px; border-radius: 5px;" border="1">';
                        $detalle .= ' <tr>';
                        $detalle .= ' <b> <td style="width: 30%;  border: 1px inset black;" align="center">CODIGO</td> </b>';
                        $detalle .= ' <b> <td style="width: 50%;  border: 1px inset black;" align="center">DESCRIPCION</td> </b>';
                        $detalle .= ' <b> <td style="width: 20%;  border: 1px inset black;" align="center">CANTIDAD</td> </b>';
                        $detalle .= ' </tr>';
                        $total = 0;
                        do {
                            $dguf_cod_ramo = $oIfx2->f("dguf_cod_ramo");
                            $dguf_can_dguf = $oIfx2->f("dguf_can_dguf");
                            $dguf_cod_vard = $oIfx2->f("dguf_cod_vard");

                            //query producto
                            $sql = "select v.vard_nom_vard, e.espe_nom_espe from saevard v, saeespe e
                                    where
                                    v.vard_cod_espe = e.espe_cod_espe and
                                    v.vard_cod_finc = e.finc_cod_finc and
                                    v.vard_cod_vard = '$dguf_cod_vard'";
                            $vard_nom_vard = consulta_string($sql, 'vard_nom_vard', $oIfx3, '');
                            $espe_nom_espe = consulta_string($sql, 'espe_nom_espe', $oIfx3, '');

                            $detalle .= ' <tr>';
                            $detalle .= ' <td style="width: 30%; border: 1px inset black;">' . $dguf_cod_ramo . '</td>';
                            $detalle .= ' <td style="width: 50%; border: 1px inset black;">' . $espe_nom_espe . ' ' . $vard_nom_vard . ' </td>';
                            $detalle .= ' <td style="width: 20%; border: 1px inset black;" align="right">' . round($dguf_can_dguf, 0) . '</td>';
                            $detalle .= ' </tr>';
                            $total = $total + $dguf_can_dguf;
                        } while ($oIfx2->SiguienteRegistro());
                        $detalle .= ' <tr>';
                        $detalle .= ' <td colspan="2" align="right">TOTAL</td>';
                        $detalle .= ' <td align="right">' . round($total, 0) . '</td>';
                        $detalle .= ' </tr>';
                        $detalle .= ' </table>';
                        $detalle .= ' <br><br><br>';
                    }
                }
                $oIfx2->Free();
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $documentos .= $destinatario . $detalle;


    $oIfx->Free();


    $legend = '<page_footer>
        <table align="center" style="width: 80%">
            <tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">Este comprobante electronico ha sido generado a traves de Sisconti S.A. - Facturacion Electronica</td>
            </tr>
			<tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">www.sisconti.com.ec</td>
            </tr>
        </table>
    </page_footer>';

    $documento .= '<page backimgw="70%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
    $documento .= $logo . $transportista . $documentos;
    $documento .= $legend;
    $documento .= '</page>';

    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;


    //eliminaArchivos(DIR_FACTELEC . 'Include/archivos/');

    return $documento;
}

function reporte_retencionGasto($id = '', $nombre_archivo = '', &$rutaPdf = '', $clpv = 0, $num_fact = '', $ejer = 0, $asto = '', $fec_emis = '', $idSucursal)
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    //$idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_sn_conta, empr_nom_empr, empr_rimp_sn, empr_ruc_empr , empr_dir_empr,
            empr_conta_sn, empr_num_resu, empr_path_logo, empr_ac1_empr, empr_ac2_empr,
            empr_mai_empr, empr_cm2_empr,
            empr_tip_empr,empr_fax_empr
            from saeempr 
            where empr_cod_empr = $idEmpresa ";

    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_tip_empr = $oIfx->f('empr_tip_empr');
            $empr_ac1_empr = $oIfx->f('empr_ac1_empr');
            $empr_ac2_empr = trim($oIfx->f('empr_ac2_empr'));
            $empr_fax_empr = $oIfx->f('empr_fax_empr');
            $empr_rimp_sn = $oIfx->f('empr_rimp_sn');

            // email
            $empr_mai_empr = $oIfx->f('empr_mai_empr');
            // web
            $empr_cm2_empr = $oIfx->f('empr_cm2_empr');
            $empr_sn_conta = $oIfx->f('empr_sn_conta');
        }
    }
    $oIfx->Free();

    //$empr_ac2_empr = $empr_tip_empr;

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis  from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
        }
    }
    $oIfx->Free();


    //VALIDACION SUSCURSALES

    $sqls="select count(*) as cont from saesucu";
    $contsucu=consulta_string($sqls,'cont',$oIfx,0);

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }


    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;
    $path_logo_img = DIR_FACTELEC.'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];

    $logo = '<table style="width: 100%; margin: 0px;">';
    $logo .= '<tr>';
    $logo .= '<b><td align="center" style="width: 57%; border:1px solid black; border-radius: 5px; margin: 0px;">';
    $logo .= '<table align="center" style="margin: 0px;">';
    $logo .= '<tr><td style="margin-top: 0px;"><img width="250px;"  src="' . $path_logo_img . '"></td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 20px;" width="300">' . $razonSocial . '</td></tr>';

    $sqlxml = "select ixml_tit_ixml, ixml_det_ixml from saeixml where ixml_cod_empr=$idEmpresa 
				and ixml_est_deleted ='S' and ixml_sn_pdf='S' order by ixml_ord_ixml";

				if ($oIfx->Query($sqlxml)) {
					if ($oIfx->NumFilas() > 0) {
						do {
							$titulo  = $oIfx->f('ixml_tit_ixml');
							$detalle = $oIfx->f('ixml_det_ixml');
                            $logo .= '<tr><td align="center" style="font-size: 14px;" width="300">' . $detalle . '</td></tr>';
						} while ($oIfx->SiguienteRegistro());
					}
				}
	$oIfx->Free();
   // $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 16px;">RUC : ' . $ruc_empr . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';

    //selecciona sucursales y direcciones
    $sql_sucu_matriz = "select sucu_dir_sucu from saesucu where sucu_nom_sucu ='MATRIZ'";
    $matriz = consulta_string($sql_sucu_matriz, 'sucu_dir_sucu', $oIfx, '');
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    $emprce="select empr_num_resu from saeempr where empr_cod_empr=$idEmpresa";
    $contribuyente= consulta_string($emprce, 'empr_num_resu', $oIfx, '');
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                //$logo .= '<tr><td align="center" style="font-size: 12px">' . $sucu_nom_sucu . ': ' . htmlentities($sucu_dir_sucu) . '</td></tr>';
                //$logo .= '<tr><td align="center" style="font-size: 13px">SUCURSAL : ' . $sucu_nom_sucu . '</td></tr>';

                $logo .= '<tr><td style="position:top; whidth:50px;"><h4>Direccion Matriz:</h4></td></tr><br>';
                $logo .= '<tr><td>' . htmlentities($dirMatriz) . '</td></tr>';
                $logo .= '<tr><td>Telefono: ' . ($empr_fax_empr) . '</td></tr>';
                if( $contsucu>1){
                    $logo .= '<tr><td align="center" style="font-size: 13px">SUCURSAL : ' . $sucu_nom_sucu . '</td></tr>';

                    $logo .= '<tr><td><h4>Direccion Sucursal:</h4>' . htmlentities($sucu_dir_sucu) . '</td></tr>';
                }



            } while ($oIfx->SiguienteRegistro());
        }
    }
    $logo .= '<tr><td>&nbsp;</td></tr>';

    if ($empr_tip_empr == 'S') {
        $logo .= '<tr><td align="center" style="font-size: 12px;">Contribuyente Especial #:' . $empr_num_resu . '</td></tr>';
    }//fin if

    if(!empty($empr_ac2_empr)){
        $empr_ac2_empr = 'Agente de Retención Resolución Nro. '.$empr_ac2_empr;
    }

    if (!empty($empr_num_resu)) {
        $logo .= '<tr><td align="center" style="font-size: 13px;"><b>Contribuyente Especial #:</b> ' . $empr_num_resu . '</td></tr>';
    }

    if($empr_conta_sn=='SI'){
        if($empr_sn_conta=='S'){
            $empr_sn_conta ='SI';
        }
        else{
            $empr_sn_conta ='NO';
        }
        $logo .= '<tr><td align="center" style="font-size: 12px;">Obligado a llevar Contabilidad :' . $empr_sn_conta . '</td></tr>';
    }
    if($empr_rimp_sn=="S"){
        $logo .= '<tr><td align="center" style="font-size: 12px;"><b>CONTRIBUYENTE R&Eacute;GIMEN RIMPE</b></td></tr>';
    }

    //$logo .= '<tr><td align="center" style="font-size: 12px;">CONTRIBUYENTE REGIMEN MICROEMPRESA</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 12px;">' . $empr_ac1_empr . '</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 12px;">'.$empr_ac2_empr.'</td></tr>';

    if(!empty($empr_mai_empr)){
        $logo .= '<tr><td align="center" style="font-size: 12px;">'.$empr_mai_empr.'</td></tr>';
    }

    if(!empty($empr_cm2_empr)){
        $logo .= '<tr><td align="center" style="font-size: 12px;">'.$empr_cm2_empr.'</td></tr>';
    }

    
    $logo .= ' </table>';
    $logo .= '</td></b>';

    $sqlRet = "select * from saefprv  where
                    fprv_cod_empr = $idEmpresa and 
                    fprv_cod_sucu = $idSucursal  and 
                    fprv_cod_clpv = $clpv and 
                    fprv_num_fact = '$num_fact' and 
                    fprv_cod_ejer = '$ejer' and  
                    fprv_cod_asto = '$asto' and  
                    fprv_fec_emis = '$fec_emis' ";

    if ($oIfx->Query($sqlRet)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $fprv_num_fact = $oIfx->f('fprv_num_fact');
                $fprv_fec_emis = fecha_mysql_func($oIfx->f('fprv_fec_emis'));
                $fprv_fec_regc = fecha_mysql_func($oIfx->f('fprv_fec_regc'));
                $fecha_retencion = $oIfx->f('fprv_rete_fec');
                if(!empty($fecha_retencion)){
                    $fecha_retencion=date('Y-m-d', strtotime($fecha_retencion));
                }

                if(empty($fecha_retencion))
                {
                    $fecha_retencion =$fprv_fec_regc;
                } 
                $fprv_cod_rtf1 = $oIfx->f('fprv_cod_rtf1');
                $fprv_cod_rtf2 = $oIfx->f('fprv_cod_rtf2');
                $fprv_cod_riva1 = $oIfx->f('fprv_cod_riva1');
                $fprv_cod_riva2 = $oIfx->f('fprv_cod_riva2');
                $fprv_por_ret1 = $oIfx->f('fprv_por_ret1');
                $fprv_por_ret2 = $oIfx->f('fprv_por_ret2');
                $fprv_val_ret1 = $oIfx->f('fprv_val_ret1');
                $fprv_val_ret2 = $oIfx->f('fprv_val_ret2');
                $fprv_por_iva1 = $oIfx->f('fprv_por_iva1');
                $fprv_por_iva2 = $oIfx->f('fprv_por_iva2');
                $fprv_val_iva1 = $oIfx->f('fprv_val_iva1');
                $fprv_val_iva2 = $oIfx->f('fprv_val_iva2');
                $fprv_num_seri = $oIfx->f('fprv_num_seri');
                $fprv_num_rete = $oIfx->f('fprv_num_rete');
                $fprv_val_bas1 = $oIfx->f('fprv_val_bas1');
                $fprv_val_bas2 = $oIfx->f('fprv_val_bas2');
                $fprv_val_bas3 = $oIfx->f('fprv_val_bas3');
                $fprv_val_bas4 = $oIfx->f('fprv_val_bas4');
                $fprv_ruc_prov = $oIfx->f('fprv_ruc_prov');
                $fprv_ser_rete = $oIfx->f('fprv_ser_rete');
                $fprv_auto_sri = $oIfx->f('fprv_auto_sri');
                $fprv_fech_sri = $oIfx->f('fprv_fech_sri');
                $fprv_email_clpv = $oIfx->f('fprv_email_clpv');
                $fprv_clav_sri = $oIfx->f('fprv_clav_sri');
                $fprv_nom_clpv = $oIfx->f('fprv_nom_clpv');
                $fprv_dir_clpv = $oIfx->f('fprv_dir_clpv');
                $fprv_tel_clpv = $oIfx->f('fprv_tel_clpv');
                $fprv_cod_clpv = $oIfx->f('fprv_cod_clpv');
                $fprv_cod_tran = $oIfx->f('fprv_cod_tran');

                //ruc si no existe
                if (empty($fprv_ruc_prov)) {
                    $sql_ruc = "select clpv_ruc_clpv from saeclpv where clpv_cod_clpv = $clpv and clpv_cod_empr = $idEmpresa ";
                    $fprv_ruc_prov = consulta_string_func($sql_ruc, 'clpv_ruc_clpv', $oIfx2, '');
                }

                //nom si no existe
                if (empty($fprv_nom_clpv)) {
                    $sql_nom = "select clpv_nom_clpv from saeclpv where clpv_cod_clpv = $clpv and clpv_cod_empr = $idEmpresa ";
                    $fprv_nom_clpv = consulta_string_func($sql_nom, 'clpv_nom_clpv', $oIfx2, '');
                }

                // direccion
                if (empty($fprv_dir_clpv)) {
                    $sql = "select min( dire_dir_dire ) as dire  from saedire where
                            dire_cod_empr = $idEmpresa and
                            dire_cod_clpv = $clpv ";
                    $fprv_dir_clpv = consulta_string_func($sql, 'dire', $oIfx2, '');
                }

                // telefono
                if (empty($fprv_tel_clpv)) {
                    $sql = "select min( tlcp_tlf_tlcp ) as telf  from saetlcp where
                            tlcp_cod_empr = $idEmpresa and
                            tlcp_cod_clpv = $clpv ";
                    $fprv_tel_clpv = consulta_string_func($sql, 'telf', $oIfx2, '');
                }

                // email
                if (empty($fprv_email_clpv)) {
                    $sql = "select min( emai_ema_emai ) as ema  from saeemai where
                            emai_cod_empr = $idEmpresa and
                            emai_cod_clpv = $clpv";
                    $fprv_email_clpv = consulta_string_func($sql, 'ema', $oIfx2, '');
                }

                //TIPO DE COMPROBANTE
                $sql_tran = "select tr.tran_cod_tran,
                                    t.tcmp_des_tcmp from
                                     saetcmp t, saetran tr
                                    where 
                                    tr.trans_tip_comp = t.tcmp_cod_tcmp and
                                    tr.tran_cod_tran = '$fprv_cod_tran' AND
                                    tr.tran_cod_empr = $idEmpresa and
                                    tr.tran_cod_sucu = $idSucursal and
                                    tr.tran_cod_modu = 4";
                $tip_comp = consulta_string_func($sql_tran, 'tcmp_des_tcmp', $oIfx2, 0);
                //$tip_comp = substr($tip_comp, 0, 50);

                $logo .= '<b><td style="width: 40%; border: 1px solid black; border-radius: 5px;" align="center">';
                $logo .= ' <table align="center" style="font-size: 15px;">';
                $logo .= ' <tr>';
                $logo .= '<td style="border-bottom: 1px inset black;">COMPROBANTE DE RETENCION</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>SERIE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . substr($fprv_ser_rete, 0, 3) . '-' . substr($fprv_ser_rete, 3, 6) . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="font-size: 17px; color: red; border-bottom: 1;">' . $fprv_num_rete . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fprv_auto_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1" >FECHA AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fprv_fech_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1" >AMBIENTE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $ambiente_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td style="border-top:1" >EMISION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $emision_sri . '</td>';
                $logo .= ' </tr>';

                if ($fprv_clav_sri != '') {
                    $nombArch = $fprv_ser_rete . $fprv_num_rete;
                    $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';

                    new barCodeGenrator($fprv_clav_sri, 1, $rutaCodi, 450, 100, true);


                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="right" style="font-size: 12px;">CLAVE DE ACCESO:</td>';
                    $logo .= '</tr>';
                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="right"> <img width="350px;" src="' . $rutaCodi . '"/></td>';
                    $logo .= '</tr>';
                }

                $logo .= ' </table>';
                $logo .= '</td></b>';
                $logo .= '</tr>';
                $logo .= '</table>';
                $logo .= ' <br>';
                $fprv_fec_emis = str_replace('/', '', $fprv_fec_emis);
                $fecha_retencion = str_replace('/', '', $fecha_retencion);
                $cliente .= ' <table style="width: 100%; border:1px solid black; border-radius: 5px; padding: 2px; font-size: 15x;">';
                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 13%"> PROVEEDOR:</td></b>';
                $cliente .= ' <td style="width: 50% ">' . htmlentities($fprv_nom_clpv) . '</td>';
                $cliente .= ' <b><td style="width: 15% "> FECHA EMISION:</td></b>';
                $cliente .= ' <td style="width: 22% ">' . $fecha_retencion . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 13% "> RUC:</td></b>';
                $cliente .= ' <td style="width: 50% ">' . $fprv_ruc_prov . '</td>';
                $cliente .= ' <b><td style="width: 15% "> TELEFONO:</td></b>';
                $cliente .= ' <td style="width: 22% ">' . $fprv_tel_clpv . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 13% ">DIRECCION:</td></b>';
                $cliente .= ' <td style="width: 50% ">' . htmlentities($fprv_dir_clpv) . '</td>';
                $cliente .= ' <b><td style="width: 15%">EMAIL:</td></b>';
                $cliente .= ' <td style="width: 22% ">' . $fprv_email_clpv . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' </table>';
                $cliente .= ' <br>';
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    $deta .= ' <table style="width: 100%; font-size: 13px; border-radius: 5px;">';
    $deta .= ' <tr>';
    $deta .= ' <b> <td align=center style="width: 15%;  border: 1px inset black;">COMPROBANTE</td> </b>';
    $deta .= ' <b> <td align=center style="width: 25%;  border: 1px inset black;">NUMERO</td> </b>';
    $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">FECHA EMISION</td> </b>';
    $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">BASE IMPONIBLE</td> </b>';
    $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">IMPUESTO</td> </b>';
    $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">CODIGO</td> </b>';
    $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">PORCENTAJE</td> </b>';
    $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">VALOR</td> </b>';
    $deta .= ' </tr>';
    $deta .= ' <tr><td style="border-left:1; border-right:1; height:20px" colspan=8></td></tr>';

    if ($fprv_val_ret1 > 0 || $fprv_cod_rtf1 != '') {
        $deta .= ' <tr>';
        $deta .= ' <td align=center style="width: 15%; border-left:1; ">' . htmlentities($tip_comp) . '</td>';
        $deta .= ' <td align=center style="width: 25%; ">' . substr($fprv_num_seri, 0, 3) . '-' . substr($fprv_num_seri, 3, 6) . '-' . $fprv_num_fact . '</td>';
        $deta .= ' <td align=center style="width: 10%; ">' . $fprv_fec_emis . '</td>';
        $deta .= ' <td align=center style="width: 10%; ">' . number_format($fprv_val_bas1, 2, '.', '') . '</td>';
        $deta .= ' <td align=center style="width: 10%; ">RENTA</td>';
        $deta .= ' <td align=center style="width: 10%; ">' . $fprv_cod_rtf1 . '</td>';
        $deta .= ' <td align=center style="width: 10%; ">' . $fprv_por_ret1 . ' %' . '</td>';
        $deta .= ' <td align=center style="width: 10%; border-right:1;">' . number_format($fprv_val_ret1, 2, '.', '') . '</td>';
        $deta .= ' </tr>';
        $total += $fprv_val_ret1;
    }

    if ($fprv_val_ret2 > 0 || $fprv_cod_rtf2 != '') {
        $deta .= ' <tr>';
        $deta .= ' <td align=center style="width: 15%; border-left:1; ">' . htmlentities($tip_comp) . '</td>';
        $deta .= ' <td align=center style="width: 25%; ">' . substr($fprv_num_seri, 0, 3) . '-' . substr($fprv_num_seri, 3, 6) . '-' . $fprv_num_fact . '</td>';
        $deta .= ' <td align=center style="width: 10%; ">' . $fprv_fec_emis . '</td>';
        $deta .= ' <td align=center style="width: 10%; ">' . number_format($fprv_val_bas2, 2, '.', '') . '</td>';
        $deta .= ' <td align=center style="width: 10%; ">RENTA</td>';
        $deta .= ' <td align=center style="width: 10%; ">' . $fprv_cod_rtf2 . '</td>';
        $deta .= ' <td align=center style="width: 10%; ">' . $fprv_por_ret2 . ' %' . '</td>';
        $deta .= ' <td align=center style="width: 10%; border-right:1; ">' . number_format($fprv_val_ret2, 2, '.', '') . '</td>';
        $deta .= ' </tr>';
        $total += $fprv_val_ret2;
    }

    if ($fprv_val_iva1 > 0 || $fprv_cod_riva1 != '') {
        $deta .= ' <tr>';
        $deta .= ' <td align=center style="width: 15%; border-left:1; ">' . htmlentities($tip_comp) . '</td>';
        $deta .= ' <td align=center style="width: 25%; ">' . substr($fprv_num_seri, 0, 3) . '-' . substr($fprv_num_seri, 3, 6) . '-' . $fprv_num_fact . '</td>';
        $deta .= ' <td align=center style="width: 10%; ">' . $fprv_fec_emis . '</td>';
        $deta .= ' <td align=center style="width: 10%; ">' . number_format($fprv_val_bas3, 2, '.', '') . '</td>';
        $deta .= ' <td align=center style="width: 10%; ">IVA</td>';
        $deta .= ' <td align=center style="width: 10%; ">' . $fprv_cod_riva1 . '</td>';
        $deta .= ' <td align=center style="width: 10%; ">' . $fprv_por_iva1 . ' %' . '</td>';
        $deta .= ' <td align=center style="width: 10%; border-right:1; ">' . number_format($fprv_val_iva1, 2, '.', '') . '</td>';
        $deta .= ' </tr>';
        $total += $fprv_val_iva1;
    }

    if ($fprv_val_iva2 > 0 || $fprv_cod_riva2 != '') {
        $deta .= ' <tr>';
        $deta .= ' <td align=center style="width: 15%; border-left:1;">' . htmlentities($tip_comp) . '</td>';
        $deta .= ' <td align=center style="width: 25%; ">' . substr($fprv_num_seri, 0, 3) . '-' . substr($fprv_num_seri, 3, 6) . '-' . $fprv_num_fact . '</td>';
        $deta .= ' <td align=center style="width: 10%; ">' . $fprv_fec_emis . '</td>';
        $deta .= ' <td align=center style="width: 10%; ">' . number_format($fprv_val_bas4, 2, '.', '') . '</td>';
        $deta .= ' <td align=center style="width: 10%; ">IVA</td>';
        $deta .= ' <td align=center style="width: 10%; ">' . $fprv_cod_riva2 . '</td>';
        $deta .= ' <td align=center style="width: 10%; ">' . $fprv_por_iva2 . ' %' . '</td>';
        $deta .= ' <td align=center style="width: 10%; border-right:1; ">' . number_format($fprv_val_iva2, 2, '.', '') . '</td>';
        $deta .= ' </tr>';
        $total += $fprv_val_iva2;
    }


    $deta .= ' <tr><td style="border-left:1; border-right:1; height:20px" colspan=8></td></tr>';

    $deta .= ' <tr>';
    $deta .= ' <td style="border-top:1"></td>';
    $deta .= ' <td style="border-top:1"></td>';
    $deta .= ' <td style="border-top:1"></td>';
    $deta .= ' <td style="border-top:1"></td>';
    $deta .= ' <td style="border-top:1"></td>';
    $deta .= ' <td style="border-top:1"></td>';
    $deta .= ' <b><td align=right style="border: 1px inset black;">TOTAL : </td></b>';
    $deta .= ' <b><td align=center style="border: 1px inset black;">' . number_format($total, 2, '.', '') . '</td></b>';
    $deta .= ' </tr>';
    $deta .= ' </table>';

    /*$total = number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_fle_fact + $fact_otr_fact + $fact_fin_fact - $totalDescuento, 2, '.', '');
    $V = new EnLetras();
    $con_letra = strtoupper($V->ValorEnLetras($total, 'dolar'));

     $totales .= '<table style="width: 100%;">';
      $totales .= '<tr>';
      $totales .= '<td>TOTAL :  </td>';
      $totales .= '<td>' . $con_letra . '</td>';
      $totales .= '</tr>';
      $totales .= '</table>'; */

    $legend = '<page_footer>
        <table align="center" style="width: 80%">
            <tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">Este comprobante electronico ha sido generado a traves de Sisconti S.A. - Facturacion Electronica</td>
            </tr>
			<tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">www.sisconti.com.ec</td>
            </tr>
        </table>
    </page_footer>';

    $documento .= '<page backimgw="70%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
    $documento .= $logo . $cliente . $deta;
    $documento .= $legend;
    $documento .= '</page>';

    if (!empty($nombre_archivo)) {

        $html2pdf = new HTML2PDF('P', 'A3', 'fr');
        $html2pdf->WriteHTML($documento);
        $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
        $html2pdf->Output($ruta, 'F');
        $rutaPdf = $ruta;

    }


    //eliminaArchivos(DIR_FACTELEC . 'Include/archivos/');

    return $documento;
}



function reporte_retencionInve($id = '', $nombre_archivo = '', &$rutaPdf = '', $clpv = 0, $num_fact = '', $ejer = 0, $asto = '', $fec_emis = '', $idSucursal) {
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();

    $idEmpresa = $_SESSION['U_EMPRESA'];
    //$idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_sn_conta, empr_nom_empr, empr_rimp_sn, empr_ruc_empr , empr_dir_empr,
            empr_conta_sn, empr_num_resu, empr_path_logo, empr_ac1_empr, empr_ac2_empr
            empr_tip_empr,empr_fax_empr, empr_mai_empr, empr_cm2_empr
            from saeempr 
            where empr_cod_empr = $idEmpresa ";

    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_tip_empr = $oIfx->f('empr_tip_empr');
            $empr_ac1_empr = $oIfx->f('empr_ac1_empr');
            $empr_ac2_empr = trim($oIfx->f('empr_ac2_empr'));
            $empr_fax_empr = $oIfx->f('empr_fax_empr');
            $empr_rimp_sn = $oIfx->f('empr_rimp_sn');
            $empr_cm2_empr = $oIfx->f('empr_cm2_empr');
            $empr_mai_empr = $oIfx->f('empr_mai_empr');
            $empr_sn_conta = $oIfx->f('empr_sn_conta');
        }
    }
    $oIfx->Free();

    //$empr_ac2_empr = $empr_tip_empr;

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis  from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
        }
    }
    $oIfx->Free();


    //VALIDACION SUSCURSALES

    $sqls="select count(*) as cont from saesucu";
    $contsucu=consulta_string($sqls,'cont',$oIfx,0);

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }


    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;
    $path_logo_img = DIR_FACTELEC.'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];

    $logo = '<table style="width: 100%; margin: 0px;">';
    $logo .= '<tr>';
    $logo .= '<b><td align="center" style="width: 57%; border:1px solid black; border-radius: 5px; margin: 0px;">';
    $logo .= '<table align="center" style="margin: 0px;">';
    $logo .= '<tr><td style="margin-top: 0px;"><img width="250px;"  src="' . $path_logo_img . '"></td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 20px;" width="300">' . $razonSocial . '</td></tr>';

    $sqlxml = "select ixml_tit_ixml, ixml_det_ixml from saeixml where ixml_cod_empr=$idEmpresa 
				and ixml_est_deleted ='S' and ixml_sn_pdf='S' order by ixml_ord_ixml";

				if ($oIfx->Query($sqlxml)) {
					if ($oIfx->NumFilas() > 0) {
						do {
							$titulo  = $oIfx->f('ixml_tit_ixml');
							$detalle = $oIfx->f('ixml_det_ixml');
                            $logo .= '<tr><td align="center" style="font-size: 14px;" width="300">' . $detalle . '</td></tr>';
						} while ($oIfx->SiguienteRegistro());
					}
				}
	$oIfx->Free();
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 16px;">RUC : ' . $ruc_empr . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';

    //selecciona sucursales y direcciones
    $sql_sucu_matriz = "select sucu_dir_sucu from saesucu where sucu_nom_sucu ='MATRIZ'";
    $matriz = consulta_string($sql_sucu_matriz, 'sucu_dir_sucu', $oIfx, '');
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    $emprce="select empr_num_resu from saeempr where empr_cod_empr=$idEmpresa";
    $contribuyente= consulta_string($emprce, 'empr_num_resu', $oIfx, '');
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                //$logo .= '<tr><td align="center" style="font-size: 12px">' . $sucu_nom_sucu . ': ' . htmlentities($sucu_dir_sucu) . '</td></tr>';
                //$logo .= '<tr><td align="center" style="font-size: 13px">SUCURSAL : ' . $sucu_nom_sucu . '</td></tr>';

                $logo .= '<tr><td style="position:top; whidth:50px;"><h4>Direccion Matriz:</h4></td></tr><br>';
                $logo .= '<tr><td>' . htmlentities($dirMatriz) . '</td></tr>';
                $logo .= '<tr><td>Telefono: ' . ($empr_fax_empr) . '</td></tr>';
                if( $contsucu>1){
                    $logo .= '<tr><td align="center" style="font-size: 13px">SUCURSAL : ' . $sucu_nom_sucu . '</td></tr>';

                    $logo .= '<tr><td><h4>Direccion Sucursal:</h4>' . htmlentities($sucu_dir_sucu) . '</td></tr>';
                }



            } while ($oIfx->SiguienteRegistro());
        }
    }
    $logo .= '<tr><td>&nbsp;</td></tr>';

    if ($empr_tip_empr == 'S') {
        $logo .= '<tr><td align="center" style="font-size: 12px;">Contribuyente Especial #:' . $empr_num_resu . '</td></tr>';
    }//fin if

    if(!empty($empr_ac2_empr)){
        $empr_ac2_empr = 'Agente de Retención Resolución Nro. '.$empr_ac2_empr;
    }

    if (!empty($empr_num_resu)) {
        $logo .= '<tr><td align="center" style="font-size: 13px;"><b>Contribuyente Especial #:</b> ' . $empr_num_resu . '</td></tr>';
    }

    if($empr_conta_sn=='SI'){
        if($empr_sn_conta=='S'){
            $empr_sn_conta ='SI';
        }
        else{
            $empr_sn_conta ='NO';
        }
        $logo .= '<tr><td align="center" style="font-size: 12px;">Obligado a llevar Contabilidad :' . $empr_sn_conta . '</td></tr>';
    }

    if($empr_rimp_sn=="S"){
        $logo .= '<tr><td align="center" style="font-size: 12px;"><b>CONTRIBUYENTE R&Eacute;GIMEN RIMPE</b></td></tr>';
    }

    //$logo .= '<tr><td align="center" style="font-size: 12px;">CONTRIBUYENTE REGIMEN MICROEMPRESA</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 12px;">' . $empr_ac1_empr . '</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 12px;">'.$empr_ac2_empr.'</td></tr>';
    
    if(!empty($empr_mai_empr)){
        $logo .= '<tr><td align="center" style="font-size: 12px;">'.$empr_mai_empr.'</td></tr>';
    }

    if(!empty($empr_cm2_empr)){
        $logo .= '<tr><td align="center" style="font-size: 12px;">'.$empr_cm2_empr.'</td></tr>';
    }
    
    $logo .= ' </table>';
    $logo .= '</td></b>';

    $sqlRet = "select * from saeret where
                        rete_cod_asto = '$asto' and
                        ret_num_fact = '$num_fact' and
                        asto_cod_empr = $idEmpresa and
                        asto_cod_sucu = $idSucursal  and
                        asto_cod_ejer = $ejer  and
                        ret_cod_clpv  = $clpv ";
    if ($oIfx->Query($sqlRet)) {
        if ($oIfx->NumFilas() > 0) {

            $deta .= ' <table style="width: 100%; font-size: 13px; border-radius: 5px;">';
            $deta .= ' <tr>';
            $deta .= ' <b> <td align=center style="width: 15%;  border: 1px inset black;">COMPROBANTE</td> </b>';
            $deta .= ' <b> <td align=center style="width: 25%;  border: 1px inset black;">NUMERO</td> </b>';
            $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">FECHA EMISION</td> </b>';
            $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">BASE IMPONIBLE</td> </b>';
            $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">IMPUESTO</td> </b>';
            $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">CODIGO</td> </b>';
            $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">PORCENTAJE</td> </b>';
            $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">VALOR</td> </b>';
            $deta .= ' </tr>';
            $deta .= ' <tr><td style="border-left:1; border-right:1; height:20px" colspan=8></td></tr>';

            $asto_cod_ejer = $oIfx->f('asto_cod_ejer');
            $ret_cod_clpv = $oIfx->f('ret_cod_clpv');
            $ret_num_fact = $oIfx->f('ret_num_fact');

            //CONSULTAMOS LA SERIE Y NUMERO DEL DOCUMENTO QUE APLICA LA RETENCION
            /* $sqlFact = "select minv_ser_docu, minv_fmov, minv_clav_sri, minv_auto_sri, minv_fech_sri,
                                   minv_cod_tran
                               from saeminv where
                               minv_cod_empr = $idEmpresa and
                               minv_cod_sucu = $idSucursal and
                               minv_cod_ejer =  $asto_cod_ejer and
                               minv_cod_clpv = $ret_cod_clpv and
                               minv_fac_prov = '$ret_num_fact' and
                               minv_comp_cont = '$asto'";*/
            $sqlFact = "select r.asto_cod_sucu, r.rete_cod_asto, m.minv_fmov, r.ret_ser_ret, r.ret_num_ret, 
							r.rete_nom_benf, r.rete_dire_benf, m.minv_ser_docu, 
							r.ret_num_fact, sum(r.ret_valor) as total, r.ret_cod_clpv, 
							r.asto_cod_ejer, m.minv_erro_sri, r.ret_email_clpv, m.minv_num_comp,
							c.clv_con_clpv, m.minv_aprob_sri, m.minv_clav_sri, m.minv_cod_tran,
							m.minv_auto_sri, m.minv_fech_sri,m.minv_fec_ret
							from saeminv m, saeret r, saeasto a  , saeclpv c where
							c.clpv_cod_clpv = m.minv_cod_clpv and
							c.clpv_cod_clpv = r.ret_cod_clpv and
							c.clpv_cod_empr = $idEmpresa and
							m.minv_cod_sucu = r.asto_cod_sucu and
							m.minv_cod_empr = r.asto_cod_empr and
							a.asto_cod_sucu = r.asto_cod_sucu and
							c.clpv_clopv_clpv = 'PV' and
							m.minv_cod_clpv = r.ret_cod_clpv and
							m.minv_cod_ejer = r.asto_cod_ejer and
							a.asto_cod_ejer = r.asto_cod_ejer and
							m.minv_fac_prov = r.ret_num_fact and
							a.asto_cod_asto = r.rete_cod_asto  and
							a.asto_cod_asto = m.minv_comp_cont and
							m.minv_comp_cont = r.rete_cod_asto and
							m.minv_cod_empr = $idEmpresa and
							m.minv_est_minv <> '0' and
							r.asto_cod_empr = $idEmpresa and
							a.asto_cod_empr = $idEmpresa and
							a.asto_est_asto <> 'AN' and 
							m.minv_comp_cont = '$asto' and  minv_fac_prov = '$ret_num_fact'
							group by r.asto_cod_sucu, r.ret_num_fact, r.ret_ser_ret, r.ret_num_ret, 
							r.rete_nom_benf,r.rete_dire_benf, m.minv_fmov, 
							m.minv_ser_docu, r.rete_cod_asto, r.ret_cod_clpv, 
							r.asto_cod_ejer,m.minv_erro_sri,r.ret_email_clpv, m.minv_num_comp, c.clv_con_clpv,
							m.minv_aprob_sri, m.minv_clav_sri, minv_cod_tran, m.minv_auto_sri, m.minv_fech_sri, m.minv_fec_ret
							order by r.ret_num_ret ";
            //echo $sqlFact;exit;
            if ($oIfx2->Query($sqlFact)) {
                if ($oIfx2->NumFilas() > 0) {
                    $minv_ser_docu = $oIfx2->f('minv_ser_docu');
                    $minv_fmov = fecha_mysql_func($oIfx2->f('minv_fmov'));
                    $minv_clav_sri = $oIfx2->f('minv_clav_sri');
                    $minv_auto_sri = $oIfx2->f('minv_auto_sri');
                    $minv_fech_sri = $oIfx2->f('minv_fech_sri');
                    $minv_cod_tran = $oIfx2->f('minv_cod_tran');
                    $serie_ret = $oIfx2->f("ret_ser_ret");
                    $retencion = $oIfx2->f("ret_num_ret");
                    $fecha_emis = $oIfx2->f("minv_fmov");

                    $minv_fec_ret = $oIfx2->f("minv_fec_ret");
                    if(!empty($minv_fec_ret)){
                        $minv_fec_ret=date('Y-m-d', strtotime($minv_fec_ret));
                    }

                    if(empty($minv_fec_ret)) $minv_fec_ret=$minv_fmov;
                    $minv_clav_sri = generaClaveAccesoSri($oIfxA, '07', $idEmpresa, $idSucursal, $minv_fec_ret, $serie_ret, $retencion);
                }
            }

            do {
                $ret_cta_ret = $oIfx->f('ret_cta_ret');
                $ret_porc_ret = $oIfx->f('ret_porc_ret');
                $ret_bas_imp = $oIfx->f('ret_bas_imp');
                $ret_valor = $oIfx->f('ret_valor');
                $ret_num_ret = $oIfx->f('ret_num_ret');
                $ret_nom_clpv = $oIfx->f('ret_nom_clpv');
                $rete_dire_benf = $oIfx->f('rete_dire_benf');
                $rete_telf_benf = $oIfx->f('rete_telf_benf');
                $rete_ruci_benf = $oIfx->f('rete_ruci_benf');
                $ret_num_fact = $oIfx->f('ret_num_fact');
                $ret_ser_ret = $oIfx->f('ret_ser_ret');
                $ret_email_clpv = $oIfx->f('ret_email_clpv');

                //TIPO DE COMPROBANTE
                $sql_tran = "select d.defi_cod_tran, t.tcmp_des_tcmp from saedefi d, saetcmp t where
									d.defi_tip_comp = t.tcmp_cod_tcmp and
									d.defi_cod_empr = $idEmpresa and
									d.defi_cod_sucu = $idSucursal and
									d.defi_cod_tran = '$minv_cod_tran'";
                //echo $sql_tran;exit;
                $tip_comp = consulta_string_func($sql_tran, 'tcmp_des_tcmp', $oIfxA, 0);
                //$tip_comp = substr($tip_comp, 0, 50);
                //TIPO DE RETENCION
                if ($ret_cta_ret == '') {
                    $ret_cta_ret = 0;
                }
                $sql_rete = "select tret_ban_retf from saetret where tret_cod = '$ret_cta_ret'";
                $tipo_rete = consulta_string_func($sql_rete, 'tret_ban_retf', $oIfxA, 0);

                if ($tipo_rete == 'RI') {
                    $tipo_rete = 'IVA';
                } elseif ($tipo_rete == 'IR') {
                    $tipo_rete = 'RENTA';
                }

                $deta .= ' <tr>';
                $deta .= ' <td align=center style="width: 15%; border-left:1; ">' . htmlentities($tip_comp) . '</td>';
                $deta .= ' <td align=center style="width: 25%; ">' . substr($minv_ser_docu, 0, 3) . '-' . substr($minv_ser_docu, 3, 6) . '-' . $ret_num_fact . '</td>';
                $deta .= ' <td align=center style="width: 10%; ">' . $minv_fmov . '</td>';
                $deta .= ' <td align=center style="width: 10%; ">' . number_format($ret_bas_imp, 2, '.', '') . '</td>';
                $deta .= ' <td align=center style="width: 10%; ">' . $tipo_rete . '</td>';
                $deta .= ' <td align=center style="width: 10%; ">' . $ret_cta_ret . '</td>';
                $deta .= ' <td align=center style="width: 10%; ">' . $ret_porc_ret . ' %' . '</td>';
                $deta .= ' <td align=center style="width: 10%; border-right:1;">' . number_format($ret_valor, 2, '.', '') . '</td>';
                $deta .= ' </tr>';
                $total += $ret_valor;
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    $deta .= ' <tr><td style="border-left:1; border-right:1; height:20px" colspan=8></td></tr>';

    $deta .= ' <tr>';
    $deta .= ' <td style="border-top:1"></td>';
    $deta .= ' <td style="border-top:1"></td>';
    $deta .= ' <td style="border-top:1"></td>';
    $deta .= ' <td style="border-top:1"></td>';
    $deta .= ' <td style="border-top:1"></td>';
    $deta .= ' <td style="border-top:1"></td>';
    $deta .= ' <b><td align=right style="border: 1px inset black;">TOTAL : </td></b>';
    $deta .= ' <b><td align=center style="border: 1px inset black;">' . number_format($total, 2, '.', '') . '</td></b>';
    $deta .= ' </tr>';

    $deta .= ' </table>';

    $logo .= '<b><td style="width: 40%; border: 1px solid black; border-radius: 5px;" align="center">';
    $logo .= ' <table align="center" style="font-size: 15px;">';
    $logo .= ' <tr>';
    $logo .= '<td style="border-bottom: 1px inset black;">COMPROBANTE DE RETENCION</td>';
    $logo .= ' </tr>';
    $logo .= ' <tr>';
    $logo .= '<td>SERIE:</td><';
    $logo .= ' </tr>';
    $logo .= ' <tr>';
    $logo .= '<td>' . substr($ret_ser_ret, 0, 3) . '-' . substr($ret_ser_ret, 3, 6) . '</td>';
    $logo .= ' </tr>';
    $logo .= ' <tr>';
    $logo .= '<td style="font-size: 17px; color: red; border-bottom: 1;">' . $ret_num_ret . '</td>';
    $logo .= ' </tr>';
    $logo .= ' <tr>';
    $logo .= '<td>AUTORIZACION : </td>';
    $logo .= ' </tr>';
    $logo .= ' <tr>';
    $logo .= '<td>' . $minv_auto_sri . '</td>';
    $logo .= ' </tr>';
    $logo .= ' <tr>';
    $logo .= '<td style="border-top:1" >FECHA AUTORIZACION : </td>';
    $logo .= ' </tr>';
    $logo .= ' <tr>';
    $logo .= '<td>' . $minv_fech_sri . '</td>';
    $logo .= ' </tr>';
    $logo .= ' <tr>';
    $logo .= '<td style="border-top:1" >AMBIENTE: </td>';
    $logo .= ' </tr>';
    $logo .= ' <tr>';
    $logo .= ' <td>' . $ambiente_sri . '</td>';
    $logo .= ' </tr>';
    $logo .= ' <tr>';
    $logo .= ' <td style="border-top:1" >EMISION: </td>';
    $logo .= ' </tr>';
    $logo .= ' <tr>';
    $logo .= '<td>' . $emision_sri . '</td>';
    $logo .= ' </tr>';

    if ($minv_clav_sri != '') {
        $nombArch = $ret_ser_ret . $ret_num_ret;
        $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';

        new barCodeGenrator($minv_clav_sri, 1, $rutaCodi, 450, 100, true);

        $logo .= '<tr>';
        $logo .= '<td colspan=2 align="right" style="font-size: 12px;">CLAVE DE ACCESO:</td>';
        $logo .= '</tr>';
        $logo .= '<tr>';
        $logo .= '<td colspan=2 align="right"> <img width="350px;" src="' . $rutaCodi . '"/></td>';
        $logo .= '</tr>';
    }

    //retencion inventario
    if (empty($ret_nom_clpv)) {
        $sql_clie = "select clpv_nom_clpv from saeclpv where clpv_cod_clpv = $ret_cod_clpv and clpv_cod_empr = $idEmpresa ";
        $ret_nom_clpv = consulta_string_func($sql_clie, 'clpv_nom_clpv', $oIfx2, '');
    }
    if (empty($rete_ruci_benf)) {
        $sql_ruc = "select clpv_ruc_clpv from saeclpv where clpv_cod_clpv = $ret_cod_clpv and clpv_cod_empr = $idEmpresa ";
        $rete_ruci_benf = consulta_string_func($sql_ruc, 'clpv_ruc_clpv', $oIfx2, '');
    }

    // direccion
    if (empty($rete_dire_benf)) {
        $sql = "select min( dire_dir_dire ) as dire  from saedire where
                 dire_cod_empr = $idEmpresa and
                dire_cod_clpv = $ret_cod_clpv";
        $rete_dire_benf = consulta_string_func($sql, 'dire', $oIfx2, '');
    }

    // telefono
    if (empty($rete_telf_benf)) {
        $sql = "select min( tlcp_tlf_tlcp ) as telf  from saetlcp where
                tlcp_cod_empr = $idEmpresa and
                tlcp_cod_clpv = $ret_cod_clpv";
        $rete_telf_benf = consulta_string_func($sql, 'telf', $oIfx2, '');
    }

    // email
    if (empty($ret_email_clpv)) {
        $sql = "select min( emai_ema_emai ) as ema  from saeemai where
                emai_cod_empr = $idEmpresa and
                emai_cod_clpv = $ret_cod_clpv";
        $ret_email_clpv = consulta_string_func($sql, 'ema', $oIfx2, '');
    }

    $logo .= ' </table>';
    $logo .= '</td></b>';
    $logo .= '</tr>';
    $logo .= '</table>';
    $logo .= ' <br>';

    $cliente .= ' <table style="width: 100%; border:1px solid black; border-radius: 5px; padding: 2px; font-size: 15x;">';
    $cliente .= ' <tr>';
    $cliente .= ' <b><td style="width: 13%"> PROVEEDOR:</td></b>';
    $cliente .= ' <td style="width: 50% ">' . htmlentities($ret_nom_clpv) . '</td>';
    $cliente .= ' <b><td style="width: 15% "> FECHA EMISION:</td></b>';
    $cliente .= ' <td style="width: 22% ">' . $minv_fec_ret . '</td>';
    $cliente .= ' </tr>';

    $cliente .= ' <tr>';
    $cliente .= ' <b><td style="width: 13% "> RUC:</td></b>';
    $cliente .= ' <td style="width: 50% ">' . $rete_ruci_benf . '</td>';
    $cliente .= ' <b><td style="width: 15% "> TELEFONO:</td></b>';
    $cliente .= ' <td style="width: 22% ">' . $rete_telf_benf . '</td>';
    $cliente .= ' </tr>';

    $cliente .= ' <tr>';
    $cliente .= ' <b><td style="width: 13% "> DIRECCION:</td></b>';
    $cliente .= ' <td style="width: 50% ">' . htmlentities($rete_dire_benf) . '</td>';
    $cliente .= ' <b><td style="width: 15% "> EMAIL:</td></b>';
    $cliente .= ' <td style="width: 22% ">' . $ret_email_clpv . '</td>';
    $cliente .= ' </tr>';
    $cliente .= ' </table>';
    $cliente .= ' <br>';

    $total = number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_fle_fact + $fact_otr_fact + $fact_fin_fact - $totalDescuento, 2, '.', '');
    $V = new EnLetras();
    $con_letra = strtoupper($V->ValorEnLetras($total, 'dolar'));

    /* $totales .= '<table style="width: 100%;">';
      $totales .= '<tr>';
      $totales .= '<td>TOTAL :  </td>';
      $totales .= '<td>' . $con_letra . '</td>';
      $totales .= '</tr>';
      $totales .= '</table>'; */


    $legend = '<page_footer>
        <table align="center" style="width: 80%">
            <tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">Este comprobante electronico ha sido generado a traves de Sisconti S.A. - Facturacion Electronica</td>
            </tr>
			<tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">www.sisconti.com.ec</td>
            </tr>
        </table>
    </page_footer>';

    $documento .= '<page backimgw="70%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
    $documento .= $logo . $cliente . $deta;
    $documento .= $legend;
    $documento .= '</page>';

    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;

    return $documento;
}

/*
//06-mar-2020
function reporte_retencionInve($id = '', $nombre_archivo = '', &$rutaPdf = '', $clpv = 0, $num_fact = '', $ejer = 0, $asto = '', $fec_emis = '', $idSucursal) {
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();

    $idEmpresa = $_SESSION['U_EMPRESA'];
    //$idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_nom_empr, empr_ruc_empr , empr_dir_empr,
            empr_conta_sn, empr_num_resu, empr_path_logo,
            empr_tip_empr
            from saeempr
            where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_tip_empr = $oIfx->f('empr_tip_empr');
        }
    }
    $oIfx->Free();

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis  from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
        }
    }
    $oIfx->Free();

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }


    $logo .= '<table style="width: 100%; margin: 0px;">';
    $logo .= '<tr>';
    $logo .= '<b><td align="center" style="width: 60%; border:1px solid black; border-radius: 5px; margin: 0px;">';
    $logo .= '<table align="center" style="margin: 0px;">';
    $logo .= '<tr><td style="margin-top: 0px;"><img width="200px;" height="150px;" src="' . $empr_path_logo . '"></td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 20px;">' . $razonSocial . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 16px;">RUC : ' . $ruc_empr . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';

    //selecciona sucursales y direcciones
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa";
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                $logo .= '<tr><td align="center" style="font-size: 13px">' . $sucu_nom_sucu . ': ' . htmlentities($sucu_dir_sucu) . '</td></tr>';
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $logo .= '<tr><td>&nbsp;</td></tr>';

    if ($empr_tip_empr == 'S') {
        $logo .= '<tr><td align="center" style="font-size: 12px;">Contribuyente Especial #:' . $empr_num_resu . '</td></tr>';
    }//fin if

    $logo .= '<tr><td align="center" style="font-size: 12px;">Obligado a llevar Contabilidad :' . $empr_conta_sn . '</td></tr>';
    $logo .= ' </table>';
    $logo .= '</td></b>';

    $sqlRet = "select * from saeret where
                        rete_cod_asto = '$asto' and
                        ret_num_fact = '$num_fact' and
                        asto_cod_empr = $idEmpresa and
                        asto_cod_sucu = $idSucursal  and
                        asto_cod_ejer = $ejer  and
                        ret_cod_clpv  = $clpv ";
    if ($oIfx->Query($sqlRet)) {
        if ($oIfx->NumFilas() > 0) {

            $deta .= ' <table style="width: 100%; font-size: 13px; border-radius: 5px;">';
            $deta .= ' <tr>';
            $deta .= ' <b> <td align=center style="width: 15%;  border: 1px inset black;">COMPROBANTE</td> </b>';
            $deta .= ' <b> <td align=center style="width: 25%;  border: 1px inset black;">NUMERO</td> </b>';
            $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">FECHA EMISION</td> </b>';
            $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">BASE IMPONIBLE</td> </b>';
            $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">IMPUESTO</td> </b>';
            $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">CODIGO</td> </b>';
            $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">PORCENTAJE</td> </b>';
            $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">VALOR</td> </b>';
            $deta .= ' </tr>';
            $deta .= ' <tr><td style="border-left:1; border-right:1; height:20px" colspan=8></td></tr>';

            $asto_cod_ejer = $oIfx->f('asto_cod_ejer');
            $ret_cod_clpv = $oIfx->f('ret_cod_clpv');
            $ret_num_fact = $oIfx->f('ret_num_fact');

            //CONSULTAMOS LA SERIE Y NUMERO DEL DOCUMENTO QUE APLICA LA RETENCION
            $sqlFact = "select minv_ser_docu, minv_fmov, minv_clav_sri, minv_auto_sri, minv_fech_sri,
								minv_cod_tran
                            from saeminv where
                            minv_cod_empr = $idEmpresa and
                            minv_cod_sucu = $idSucursal and
                            minv_cod_ejer =  $asto_cod_ejer and
                            minv_cod_clpv = $ret_cod_clpv and
                            minv_fac_prov = '$ret_num_fact' and
							minv_comp_cont = '$asto'";
            if ($oIfx2->Query($sqlFact)) {
                if ($oIfx2->NumFilas() > 0) {
                    $minv_ser_docu = $oIfx2->f('minv_ser_docu');
                    $minv_fmov = fecha_mysql_func($oIfx2->f('minv_fmov'));
                    $minv_clav_sri = $oIfx2->f('minv_clav_sri');
                    $minv_auto_sri = $oIfx2->f('minv_auto_sri');
                    $minv_fech_sri = $oIfx2->f('minv_fech_sri');
                    $minv_cod_tran = $oIfx2->f('minv_cod_tran');
                }
            }

            do {
                $ret_cta_ret = $oIfx->f('ret_cta_ret');
                $ret_porc_ret = $oIfx->f('ret_porc_ret');
                $ret_bas_imp = $oIfx->f('ret_bas_imp');
                $ret_valor = $oIfx->f('ret_valor');
                $ret_num_ret = $oIfx->f('ret_num_ret');
                $ret_nom_clpv = $oIfx->f('ret_nom_clpv');
                $rete_dire_benf = $oIfx->f('rete_dire_benf');
                $rete_telf_benf = $oIfx->f('rete_telf_benf');
                $rete_ruci_benf = $oIfx->f('rete_ruci_benf');
                $ret_num_fact = $oIfx->f('ret_num_fact');
                $ret_ser_ret = $oIfx->f('ret_ser_ret');
                $ret_email_clpv = $oIfx->f('ret_email_clpv');

                //TIPO DE COMPROBANTE
                $sql_tran = "select d.defi_cod_tran, t.tcmp_des_tcmp from saedefi d, saetcmp t where
									d.defi_tip_comp = t.tcmp_cod_tcmp and
									d.defi_cod_empr = $idEmpresa and
									d.defi_cod_sucu = $idSucursal and
									d.defi_cod_tran = '$minv_cod_tran'";
                $tip_comp = consulta_string_func($sql_tran, 'tcmp_des_tcmp', $oIfxA, 0);
                //$tip_comp = substr($tip_comp, 0, 50);
                //TIPO DE RETENCION
                if ($ret_cta_ret == '') {
                    $ret_cta_ret = 0;
                }
                $sql_rete = "select tret_ban_retf from saetret where tret_cod = '$ret_cta_ret'";
                $tipo_rete = consulta_string_func($sql_rete, 'tret_ban_retf', $oIfxA, 0);

                if ($tipo_rete == 'RI') {
                    $tipo_rete = 'IVA';
                } elseif ($tipo_rete == 'IR') {
                    $tipo_rete = 'RENTA';
                }

                $deta .= ' <tr>';
                $deta .= ' <td align=center style="width: 15%; border-left:1; ">' . htmlentities($tip_comp) . '</td>';
                $deta .= ' <td align=center style="width: 25%; ">' . substr($minv_ser_docu, 0, 3) . '-' . substr($minv_ser_docu, 3, 6) . '-' . $ret_num_fact . '</td>';
                $deta .= ' <td align=center style="width: 10%; ">' . $minv_fmov . '</td>';
                $deta .= ' <td align=center style="width: 10%; ">' . number_format($ret_bas_imp, 2, '.', '') . '</td>';
                $deta .= ' <td align=center style="width: 10%; ">' . $tipo_rete . '</td>';
                $deta .= ' <td align=center style="width: 10%; ">' . $ret_cta_ret . '</td>';
                $deta .= ' <td align=center style="width: 10%; ">' . $ret_porc_ret . ' %' . '</td>';
                $deta .= ' <td align=center style="width: 10%; border-right:1;">' . number_format($ret_valor, 2, '.', '') . '</td>';
                $deta .= ' </tr>';
                $total += $ret_valor;
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    $deta .= ' <tr><td style="border-left:1; border-right:1; height:20px" colspan=8></td></tr>';

    $deta .= ' <tr>';
    $deta .= ' <td style="border-top:1"></td>';
    $deta .= ' <td style="border-top:1"></td>';
    $deta .= ' <td style="border-top:1"></td>';
    $deta .= ' <td style="border-top:1"></td>';
    $deta .= ' <td style="border-top:1"></td>';
    $deta .= ' <td style="border-top:1"></td>';
    $deta .= ' <b><td align=right style="border: 1px inset black;">TOTAL : </td></b>';
    $deta .= ' <b><td align=center style="border: 1px inset black;">' . number_format($total, 2, '.', '') . '</td></b>';
    $deta .= ' </tr>';

    $deta .= ' </table>';

    $logo .= '<b><td style="width: 40%; border: 1px solid black; border-radius: 5px;" align="center">';
    $logo .= ' <table align="center" style="font-size: 15px;">';
    $logo .= ' <tr>';
    $logo .= '<td style="border-bottom: 1px inset black;">COMPROBANTE DE RETENCION</td>';
    $logo .= ' </tr>';
    $logo .= ' <tr>';
    $logo .= '<td>SERIE:</td><';
    $logo .= ' </tr>';
    $logo .= ' <tr>';
    $logo .= '<td>' . substr($ret_ser_ret, 0, 3) . '-' . substr($ret_ser_ret, 3, 6) . '</td>';
    $logo .= ' </tr>';
    $logo .= ' <tr>';
    $logo .= '<td style="font-size: 17px; color: red; border-bottom: 1;">' . $ret_num_ret . '</td>';
    $logo .= ' </tr>';
    $logo .= ' <tr>';
    $logo .= '<td>AUTORIZACION : </td>';
    $logo .= ' </tr>';
    $logo .= ' <tr>';
    $logo .= '<td>' . $minv_auto_sri . '</td>';
    $logo .= ' </tr>';
    $logo .= ' <tr>';
    $logo .= '<td style="border-top:1" >FECHA AUTORIZACION : </td>';
    $logo .= ' </tr>';
    $logo .= ' <tr>';
    $logo .= '<td>' . $minv_fech_sri . '</td>';
    $logo .= ' </tr>';
    $logo .= ' <tr>';
    $logo .= '<td style="border-top:1" >AMBIENTE: </td>';
    $logo .= ' </tr>';
    $logo .= ' <tr>';
    $logo .= ' <td>' . $ambiente_sri . '</td>';
    $logo .= ' </tr>';
    $logo .= ' <tr>';
    $logo .= ' <td style="border-top:1" >EMISION: </td>';
    $logo .= ' </tr>';
    $logo .= ' <tr>';
    $logo .= '<td>' . $emision_sri . '</td>';
    $logo .= ' </tr>';

    if ($minv_clav_sri != '') {
        $nombArch = $ret_ser_ret . $ret_num_ret;
        $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';

        new barCodeGenrator($minv_clav_sri, 1, $rutaCodi, 450, 100, true);

        $logo .= '<tr>';
        $logo .= '<td colspan=2 align="right" style="font-size: 12px;">CLAVE DE ACCESO:</td>';
        $logo .= '</tr>';
        $logo .= '<tr>';
        $logo .= '<td colspan=2 align="right"> <img width="350px;" src="' . $rutaCodi . '"/></td>';
        $logo .= '</tr>';
    }

    //retencion inventario
    if (empty($ret_nom_clpv)) {
        $sql_clie = "select clpv_nom_clpv from saeclpv where clpv_cod_clpv = $ret_cod_clpv and clpv_cod_empr = $idEmpresa ";
        $ret_nom_clpv = consulta_string_func($sql_clie, 'clpv_nom_clpv', $oIfx2, '');
    }
    if (empty($rete_ruci_benf)) {
        $sql_ruc = "select clpv_ruc_clpv from saeclpv where clpv_cod_clpv = $ret_cod_clpv and clpv_cod_empr = $idEmpresa ";
        $rete_ruci_benf = consulta_string_func($sql_ruc, 'clpv_ruc_clpv', $oIfx2, '');
    }

    // direccion
    if (empty($rete_dire_benf)) {
        $sql = "select min( dire_dir_dire ) as dire  from saedire where
                 dire_cod_empr = $idEmpresa and
                dire_cod_clpv = $ret_cod_clpv";
        $rete_dire_benf = consulta_string_func($sql, 'dire', $oIfx2, '');
    }

    // telefono
    if (empty($rete_telf_benf)) {
        $sql = "select min( tlcp_tlf_tlcp ) as telf  from saetlcp where
                tlcp_cod_empr = $idEmpresa and
                tlcp_cod_clpv = $ret_cod_clpv";
        $rete_telf_benf = consulta_string_func($sql, 'telf', $oIfx2, '');
    }

    // email
    if (empty($ret_email_clpv)) {
        $sql = "select min( emai_ema_emai ) as ema  from saeemai where
                emai_cod_empr = $idEmpresa and
                emai_cod_clpv = $ret_cod_clpv";
        $ret_email_clpv = consulta_string_func($sql, 'ema', $oIfx2, '');
    }

    $logo .= ' </table>';
    $logo .= '</td></b>';
    $logo .= '</tr>';
    $logo .= '</table>';
    $logo .= ' <br>';

    $cliente .= ' <table style="width: 100%; border:1px solid black; border-radius: 5px; padding: 2px; font-size: 15x;">';
    $cliente .= ' <tr>';
    $cliente .= ' <b><td style="width: 13%"> CLIENTE:</td></b>';
    $cliente .= ' <td style="width: 50% ">' . htmlentities($ret_nom_clpv) . '</td>';
    $cliente .= ' <b><td style="width: 15% "> FECHA EMISION:</td></b>';
    $cliente .= ' <td style="width: 22% ">' . $minv_fmov . '</td>';
    $cliente .= ' </tr>';

    $cliente .= ' <tr>';
    $cliente .= ' <b><td style="width: 13% "> RUC:</td></b>';
    $cliente .= ' <td style="width: 50% ">' . $rete_ruci_benf . '</td>';
    $cliente .= ' <b><td style="width: 15% "> TELEFONO:</td></b>';
    $cliente .= ' <td style="width: 22% ">' . $rete_telf_benf . '</td>';
    $cliente .= ' </tr>';

    $cliente .= ' <tr>';
    $cliente .= ' <b><td style="width: 13% "> DIRECCION:</td></b>';
    $cliente .= ' <td style="width: 50% ">' . htmlentities($rete_dire_benf) . '</td>';
    $cliente .= ' <b><td style="width: 15% "> EMAIL:</td></b>';
    $cliente .= ' <td style="width: 22% ">' . $ret_email_clpv . '</td>';
    $cliente .= ' </tr>';
    $cliente .= ' </table>';
    $cliente .= ' <br>';

    $total = number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_fle_fact + $fact_otr_fact + $fact_fin_fact - $totalDescuento, 2, '.', '');
    $V = new EnLetras();
    $con_letra = strtoupper($V->ValorEnLetras($total, 'dolar'));

    /* $totales .= '<table style="width: 100%;">';
      $totales .= '<tr>';
      $totales .= '<td>TOTAL :  </td>';
      $totales .= '<td>' . $con_letra . '</td>';
      $totales .= '</tr>';
      $totales .= '</table>'; *


    $legend = '<page_footer>
        <table align="center" style="width: 80%">
            <tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">Este comprobante electronico ha sido generado a traves de Sisconti S.A. - Facturacion Electronica</td>
            </tr>
			<tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">www.sisconti.com.ec</td>
            </tr>
        </table>
    </page_footer>';

    $documento .= '<page backimgw="70%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
    $documento .= $logo . $cliente . $deta;
    $documento .= $legend;
    $documento .= '</page>';

    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;

    return $documento;
}
*/


function reporte_liqu_compras($id = '', $nombre_archivo = '', $idSucursal = '', &$rutaPdf = '')
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    //$idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_sn_conta, empr_ac2_empr, empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr, empr_rimp_sn
                                            from saeempr where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S') {
                $empr_conta_sn = 'SI';
            } else {
                $empr_conta_sn = 'NO';
            }

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $porcIva = $oIfx->f('empr_iva_empr');
            $empr_ac2_empr = trim($oIfx->f('empr_ac2_empr'));
            $empr_rimp_sn = $oIfx->f('empr_rimp_sn');
            $empr_sn_conta = $oIfx->f('empr_sn_conta');
        }
    }
    $oIfx->Free();

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis  from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
        }
    }
    $oIfx->Free();


    //VALIDACION SUSCURSALES

    $sqls="select count(*) as cont from saesucu";
    $contsucu=consulta_string($sqls,'cont',$oIfx,0);

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }
    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;
    //$path_logo_img = DIR_FACTELEC . 'imagenes/logos/' . $path_img[$count];
    $path_logo_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];

    $emprce="select empr_num_resu,empr_nom_empr from saeempr where empr_cod_empr=$idEmpresa";
    $contribuyente= consulta_string($emprce, 'empr_num_resu', $oIfx, '');
    $razonSocial= consulta_string($emprce, 'empr_nom_empr', $oIfx, '');
    $logo .= '<table style="width: 100%; margin: 0px;">';
    $logo .= '<tr>';
    $logo .= '<b><td align="center" style="width: 50%; border:1px solid black; border-radius: 5px; margin: 0px;">';
    $logo .= '<table align="center" style="margin: 0px;">';
    $logo .= '<tr><td style="margin-top: 0px;"><img width="250px;" src="' . $path_logo_img . '"></td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 16px; white-space:nowrap;">' . $razonSocial . '</td></tr>';
    
    $sqlxml = "select ixml_tit_ixml, ixml_det_ixml from saeixml where ixml_cod_empr=$idEmpresa 
				and ixml_est_deleted ='S' and ixml_sn_pdf='S' order by ixml_ord_ixml";

				if ($oIfx->Query($sqlxml)) {
					if ($oIfx->NumFilas() > 0) {
						do {
							$titulo  = $oIfx->f('ixml_tit_ixml');
							$detalle = $oIfx->f('ixml_det_ixml');
                            $logo .= '<tr><td align="center" style="font-size: 14px;" width="300">' . $detalle . '</td></tr>';
						} while ($oIfx->SiguienteRegistro());
					}
				}
	$oIfx->Free();

    //$logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 16px;">RUC : ' . $ruc_empr . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';

    //selecciona sucursales y direcciones
    $sql_sucu_matriz = "select sucu_dir_sucu from saesucu where sucu_nom_sucu ='MATRIZ'";
    $matriz = consulta_string($sql_sucu_matriz, 'sucu_dir_sucu', $oIfx, '');
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    $emprce="select empr_num_resu from saeempr where empr_cod_empr=$idEmpresa";
    $contribuyente= consulta_string($emprce, 'empr_num_resu', $oIfx, '');
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                //$logo .= '<tr><td align="center" style="font-size: 12px">' . $sucu_nom_sucu . ': ' . htmlentities($sucu_dir_sucu) . '</td></tr>';
                //$logo .= '<tr><td align="center" style="font-size: 13px">SUCURSAL : ' . $sucu_nom_sucu . '</td></tr>';

                $logo .= '<tr><td style="position:top; whidth:50px;"><h4>Direccion Matriz:</h4></td></tr><br>';
                $logo .= '<tr><td>' . htmlentities($dirMatriz) . '</td></tr>';
                if( $contsucu>1){
                    $logo .= '<tr><td align="center" style="font-size: 13px">SUCURSAL : ' . $sucu_nom_sucu . '</td></tr>';

                    $logo .= '<tr><td><h4>Direccion Sucursal:</h4>' . htmlentities($sucu_dir_sucu) . '</td></tr>';
                }


                if($empr_conta_sn=='SI'){
                    $logo .= '<tr><td> Contribuyente Especial:'.$contribuyente.'</td></tr>';
                }
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $logo .= '<tr><td>&nbsp;</td></tr>';

    //$logo .= '<tr><td align="center" style="font-size: 12px;">Contribuyente Especial #:' . $empr_num_resu . '</td></tr>';
    if (!empty($empr_num_resu)) {
        $logo .= '<tr><td align="center" style="font-size: 13px;"><b>Contribuyente Especial #:</b> ' . $empr_num_resu . '</td></tr>';
    }
    if($empr_conta_sn=='SI'){
        if($empr_sn_conta=='S'){
            $empr_sn_conta ='SI';
        }
        else{
            $empr_sn_conta ='NO';
        }
        $logo .= '<tr><td align="center" style="font-size: 12px;">Obligado a llevar Contabilidad :' . $empr_sn_conta . '</td></tr>';
    }    
    if($empr_rimp_sn=="S"){
        $logo .= '<tr><td align="center" style="font-size: 12px;"><b>CONTRIBUYENTE R&Eacute;GIMEN RIMPE</b></td></tr>';
    }
    
    if(!empty($empr_ac2_empr))
    {
        $logo .= '<tr><td align="center" style="font-size: 12px;">Agente de Retención Resolución No. ' . $empr_ac2_empr . '</td></tr>';
    }
    $logo .= ' </table>';
    $logo .= '</td></b>';


    // FORMA DE PAGO
    /* $sql = "select p.fpag_des_fpag from saefxfp f , saefpag p where
      p.fpag_cod_fpag = f.fxfp_cod_fpag and
      p.fpag_cod_empr = $idEmpresa and
      f.fxfp_cod_empr = $idEmpresa and
      f.fxfp_cod_sucu = $idSucursal and
      f.fxfp_cod_fact = $id ";
      $fp = consulta_string_func($sql, 'fpag_des_fpag', $oIfx, ''); */

    // $sqlFac = " select  m.minv_fmov, m.minv_fac_prov, c.clpv_nom_clpv, minv_email_clpv, m.minv_num_comp,
    //                     (select max(dire_dir_dire)
    //                     from saedire
    //                     where dire_cod_empr = c.clpv_cod_empr
    //                     and dire_cod_sucu = c.clpv_cod_sucu
    //                     and dire_cod_clpv = c.clpv_cod_clpv) as direccion,
    //                     m.minv_cod_clpv, m.minv_ser_docu, m.minv_aprob_sri, m.minv_clav_sri,
    //                     m.minv_cod_ejer, m.minv_erro_sri, c.clv_con_clpv, m.minv_cod_tran, c.clpv_ruc_clpv,
    //                     (select max(tlcp_tlf_tlcp)
    //                     from saetlcp
    //                     where tlcp_cod_empr = c.clpv_cod_empr
    //                     and tlcp_cod_sucu = c.clpv_cod_sucu
    //                     and tlcp_cod_clpv = c.clpv_cod_clpv) as telefono,
    //                     round(((COALESCE(minv_iva_valo,0) * 100 ) / 12 ),2) as total_graba_12,
    //                     round(((minv_tot_minv - COALESCE(minv_dge_valo, 0) + COALESCE(minv_otr_valo, 0) + COALESCE(minv_fle_minv, 0)) -  round((( COALESCE(minv_iva_valo, 0) * 100 ) / 12 ),2)),2) as total_graba_0,
    //                     round(COALESCE(minv_iva_valo,0),2) as valor_iva,
    //                     round((minv_tot_minv - COALESCE(minv_dge_valo,0) + COALESCE(minv_otr_valo,0 ) + COALESCE(minv_fle_minv,0) + COALESCE(minv_iva_valo,0)),2)  as total,
    //                     COALESCE(minv_val_noi, 0) as no_ojeto_iva,
    //                     COALESCE(minv_val_exe, 0) as exento_iva,
    // 	                m.minv_dge_valo,
    //                     m.minv_cod_fpagop, ( m.minv_fec_entr - m.minv_fmov ) as dias_plazo,
    //                     d.dmov_iva_porc,
    // 	                m.minv_cm1_minv, m.minv_cm2_minv, m.minv_fec_entr, m.minv_fech_sri
    //             from saeminv m , saeclpv c, saedmov d
    //             where  c.clpv_cod_clpv = m.minv_cod_clpv and
    //                     c.clpv_cod_empr = m.minv_cod_empr and
    //                     c.clpv_cod_sucu = m.minv_cod_sucu and
    //                     d.dmov_cod_empr = m.minv_cod_empr and
    //                     d.dmov_cod_sucu = m.minv_cod_sucu and
    //                     d.dmov_cod_ejer = m.minv_cod_ejer and
    //                     d.dmov_num_comp = m.minv_num_comp and
    //                     c.clpv_cod_empr = $idEmpresa and
    //                     c.clpv_clopv_clpv = 'PV' and
    //                     m.minv_cod_empr = $idEmpresa and
    //                     m.minv_cod_sucu = $idSucursal and
    //                     m.minv_elec_sn ='S' and
    //                     m.minv_aprob_sri = 'N' and
    //                     m.minv_num_comp = $id

    //                 group by 1,2,3,4,5,6,7,8,9,10,11,12, 13, 14,15,16,17, 18, 19, 20, 21,22, 23, 24, 25, 26, 27, 28, 29, 30
    //                 order by m.minv_fac_prov ";

    $sqlFac = " select  m.minv_fmov, m.minv_fac_prov, c.clpv_nom_clpv, minv_email_clpv, m.minv_num_comp, 
                        (select max(dire_dir_dire)
                        from saedire
                        where dire_cod_empr = c.clpv_cod_empr
                        and dire_cod_sucu = c.clpv_cod_sucu
                        and dire_cod_clpv = c.clpv_cod_clpv) as direccion, 
                        m.minv_cod_clpv, m.minv_ser_docu, m.minv_aprob_sri, m.minv_clav_sri,
                        m.minv_cod_ejer, m.minv_erro_sri, c.clv_con_clpv, m.minv_cod_tran, c.clpv_ruc_clpv, 
                        (select max(tlcp_tlf_tlcp)
                        from saetlcp
                        where tlcp_cod_empr = c.clpv_cod_empr
                        and tlcp_cod_sucu = c.clpv_cod_sucu
                        and tlcp_cod_clpv = c.clpv_cod_clpv) as telefono,
                        minv_con_iva,
                        minv_sin_iva,
                        (minv_iva_valo) as valor_iva,
                        minv_tot_minv,
                        COALESCE(minv_val_noi, 0) as no_ojeto_iva,
                        COALESCE(minv_val_exe, 0) as exento_iva,
		                m.minv_dge_valo,	
                        m.minv_cod_fpagop, ( m.minv_fec_entr - m.minv_fmov ) as dias_plazo,
                       
		                m.minv_cm1_minv, m.minv_cm2_minv, m.minv_fec_entr, m.minv_fech_sri
                from saeminv m , saeclpv c
                where  c.clpv_cod_clpv = m.minv_cod_clpv and
                        c.clpv_cod_empr = m.minv_cod_empr and 
                        --c.clpv_cod_sucu = m.minv_cod_sucu and 
                                           
                        c.clpv_cod_empr = $idEmpresa and
                        c.clpv_clopv_clpv = 'PV' and                                                
                        m.minv_cod_empr = $idEmpresa and
                        m.minv_cod_sucu = $idSucursal and
                        m.minv_elec_sn ='S' and                        
                       -- m.minv_aprob_sri = 'N' and 
	                    m.minv_num_comp = $id

                    group by 1,2,3,4,5,6,7,8,9,10,11,12, 13, 14,15,16,17, 18, 19, 20, 21,22, 23, 24, 25, 26, 27, 28, 29
                    order by m.minv_fac_prov ";
    //  echo $sqlFac; exit;
    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $fact_nse_fact = $oIfx->f('minv_ser_docu');
                $fact_num_preimp = $oIfx->f('minv_fac_prov');
                $fact_auto_sri = $oIfx->f('minv_clav_sri');
                $fact_fech_sri = $oIfx->f('minv_fech_sri');
                $fact_nom_cliente = $oIfx->f('clpv_nom_clpv');
                $fact_fech_fact = fecha_mysql_func($oIfx->f('minv_fmov'));
                $fact_ruc_clie = $oIfx->f('clpv_ruc_clpv');
                $fact_tlf_cliente = $oIfx->f('telefono');
                $fact_dir_clie = htmlentities($oIfx->f('direccion'));
                $fact_email_clpv = str_replace(' ', '', $oIfx->f("minv_email_clpv"));
                $fact_con_miva = $oIfx->f('minv_con_iva');
                $fact_sin_miva = $oIfx->f('minv_sin_iva');
                $fact_tot_fact = $oIfx->f('minv_tot_minv');
                $fact_iva = $oIfx->f('valor_iva');
                $fact_ice = 0;
                $fact_clav_sri = $oIfx->f('minv_clav_sri');
                $fact_dsg_valo = $oIfx->f('minv_dge_valo');
                $fact_cm2_fact = $oIfx->f("minv_cm1_minv");
                $fact_cm4_fact = $oIfx->f("minv_cm2_minv");
                //$orden_compra   = $oIfx->f("fact_opc_fact");
                $fact_cod_clpv = $oIfx->f("minv_cod_clpv");
                //$fact_cod_ccli  = $oIfx->f("fact_cod_ccli");
                $fact_dia_plazo = $oIfx->f("dias_plazo");
                $fact_fech_venc = fecha_mysql_func($oIfx->f("minv_fec_entr"));


                if ($fact_dia_plazo == 0) {

                    $sql = "select fpag_cod_fpagop, mxfp_val_mxfp, mxfp_num_dias, mxfp_fec_fin
                    from saemxfp, saefpag
                    where mxfp_cod_empr = fpag_cod_empr 
                    and mxfp_cod_sucu = fpag_cod_sucu 
                    and mxfp_cod_fpag = fpag_cod_fpag
                    and  mxfp_num_comp = $id
                    and mxfp_cod_empr = $idEmpresa
                    and mxfp_cod_sucu = $idSucursal";

                    $fact_dia_plazo = consulta_string_func($sql, 'mxfp_num_dias', $oIfxA, 0);
                    $fact_fech_venc = fecha_mysql_func(consulta_string_func($sql, 'mxfp_fec_fin', $oIfxA, ''));

                }


                //$fact_fech_venc = fecha_mysql_func($oIfx->f("fact_fech_venc"));


                $logo .= '<b><td style="width: 40%; border: 1px solid black; border-radius: 5px;" align="center">';
                $logo .= ' <table align="center" style="font-size: 15px;">';
                $logo .= ' <tr>';
                $logo .= '<td style="border-bottom: 1px inset black;">LIQUIDACION DE COMPRA DE BIENES </td>';
                $logo .= ' </tr>';
                $logo .= '<tr>
                            <td style="border-bottom: 1px inset black;">Y PRESTACION DE SERVICIOS </td>
                          </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>SERIE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . substr($fact_nse_fact, 0, 3) . '-' . substr($fact_nse_fact, 3, 6) . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="font-size: 17px; color: red; border-bottom: 1;">' . $fact_num_preimp . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fact_auto_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1">FECHA AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fact_fech_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1" >AMBIENTE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $ambiente_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td style="border-top:1" >EMISION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $emision_sri . '</td>';
                $logo .= ' </tr>';

                //verifica si existe clave de acceso
                if ($fact_clav_sri != '') {
                    $nombArch = $fact_nse_fact . $fact_num_preimp;
                    //$nombArch = '0112201401179141325300110010010000048101234567818';
                    $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';

                    new barCodeGenrator($fact_clav_sri, 1, $rutaCodi, 450, 100, true);

                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="right" style="font-size: 12px;">CLAVE DE ACCESO</td>';
                    $logo .= '</tr>';
                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="right"> <img width="350px;" src="' . $rutaCodi . '"/></td>';
                    $logo .= '</tr>';
                }

                $logo .= ' </table>';
                $logo .= '</td></b>';
                $logo .= '</tr>';
                $logo .= '</table>';
                $logo .= ' <br>';

                $cliente .= ' <table style="width: 100%; border:1px solid black; border-radius: 5px; padding: 2px; font-size: 15x;">';
                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 1%;">CLIENTE:</td></b>';
                $cliente .= ' <td style="width: 48%; ">' . $fact_nom_cliente . '</td>';
                $cliente .= ' <b><td style="width: 13%; ">FECHA EMISION:</td></b>';
                $fact_fech_fact = str_replace("/", "", $fact_fech_fact);
                $cliente .= ' <td style="width: 29% ">' . $fact_fech_fact . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% ">RUC:</td></b>';
                $cliente .= ' <td style="width: 48% ">' . $fact_ruc_clie . '</td>';
                $cliente .= ' <b><td style="width: 13% ">TELEFONO:</td></b>';
                $cliente .= ' <td style="width: 29% ">' . $fact_tlf_cliente . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% ">DIRECCION:</td></b>';
                $cliente .= ' <td style="width: 48% ">' . $fact_dir_clie . '</td>';
                $cliente .= ' <b><td style="width: 13% ">EMAIL:</td></b>';
                $cliente .= ' <td style="width: 29% ">' . $fact_email_clpv . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                //$cliente .= ' <b><td style="width: 10% ">GUIA #:</td></b>';
                //$cliente .= ' <td style="width: 48% ">' . $fact_cm4_fact . '</td>';
                $cliente .= '<b><td style="width: 10% ">OBSERV:</td></b>';
                $cliente .= ' <td style="width: 48%;">' . $fact_cm2_fact . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10%;"></td></b>';
                $cliente .= ' <td style="width: 48%;"></td>';
                $cliente .= '<b><td style="width: 13%;">FECHA VENCE:</td></b>';
                $cliente .= ' <td style="width: 29%;">' . $fact_fech_venc . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10%;">ESTAB.:</td></b>';
                $cliente .= ' <td style="width: 48%;">' . $estab_ccli . '</td>';
                $cliente .= ' <b><td style="width: 13% ">DIAS PLAZO:</td></b>';
                $cliente .= ' <td style="width: 29%;">' . $fact_dia_plazo . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' </table>';

                $cliente .= ' <br>';
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    //$sqlDeta = "select * from saedmov where dmov_num_comp = $id and dmov_cod_sucu = $idSucursal and dmov_cod_empr = $idEmpresa ";
    $sqlDeta = "select dmov_cod_prod, prod_cod_barra, dmov_can_dmov, dmov_det_dmov, prod_nom_prod, dmov_cun_dmov, 0 as subsidio, 0 as prec_sin_subsidio, dmov_iva_porc,
	                    ( case when dmov_ds1_dmov > 0 then  ((dmov_can_dmov * dmov_cun_dmov) / dmov_ds1_dmov)
                            else 0
                         end ) as descuento
                from saedmov, saeprod 
                where dmov_cod_prod = prod_cod_prod
                and dmov_cod_empr = prod_cod_empr
                and dmov_cod_sucu = prod_cod_sucu
                and dmov_num_comp = $id and dmov_cod_sucu = $idSucursal and dmov_cod_empr = $idEmpresa ";
    $deta .= ' <table style="width: 100%; font-size: 13px; border-radius: 5px; border-collapse: collapse;" border="1">';
    $deta .= ' <tr>';
    $deta .= ' <b> <td style="width: 10%;" align="center">CODIGO</td> </b>';
    //$deta .= ' <b> <td style="width: 10%;" align="center">COD.AUX</td> </b>';
    $deta .= ' <b> <td style="width: 5%;" align="center">CANT.</td> </b>';
    $deta .= ' <b> <td style="width: 30%;" align="center">DESCRIPCION</td> </b>';
    $deta .= ' <b> <td style="width:  20%;" align="center">DET.ADICION</td> </b>';
    $deta .= ' <b> <td style="width:  7%;" align="center">PRECIO</td> </b>';
    $deta .= ' <b> <td style="width:  5%;" align="center">SUBSI</td> </b>';
    $deta .= ' <b> <td style="width:  7%;" align="center">PREC.SIN SUBSIDIO</td> </b>';
    $deta .= ' <b> <td style="width:  6%;" align="center">DSCTO</td> </b>';
    $deta .= ' <b> <td style="width: 10%;" align="center">PRECIO TOTAL</td> </b>';
    $deta .= ' </tr>';

    $tot_iva0 = 0;
    $tot_nobiva = 0;
    $tot_exeiva = 0;

    if ($oIfx->Query($sqlDeta)) {
        if ($oIfx->NumFilas() > 0) {
            // $porcIva = '';
            do {
                $dfac_cod_prod = $oIfx->f('dmov_cod_prod');
                //$cod_alterno        = $oIfx->f('prod_cod_barra');
                $dfac_nom_prod = $oIfx->f('prod_nom_prod');
                $dfac_cant_dfac = $oIfx->f('dmov_can_dmov');
                $deta_adicional = $oIfx->f('dmov_det_dmov');
                $dfac_precio_dfac = $oIfx->f('dmov_cun_dmov');
                $dfac_des1_dfac = $oIfx->f('descuento');
                $subsidio = $oIfx->f('subsidio');
                $prec_sin_subsidio = $oIfx->f('prec_sin_subsidio');
                $dmov_iva_porc = $oIfx->f('dmov_iva_porc');
                if(round($dmov_iva_porc)>0) $porcIva=$dmov_iva_porc;
                if (empty($dfac_des1_dfac)) $dfac_des1_dfac = 0;


                $subTotal_sin_iva = ($dfac_cant_dfac * $dfac_precio_dfac) - $dfac_des1_dfac;
                $totalDescuento += $dfac_des1_dfac;


                $sql = "select prod_sn_noi, prod_sn_exe  from saeprod where 
								prod_cod_prod = '$dfac_cod_prod' and 
								prod_cod_empr = $idEmpresa and 
								prod_cod_sucu = $idSucursal ";
                if ($oIfxA->Query($sql)) {
                    if ($oIfxA->NumFilas() > 0) {
                        $prod_sn_noi = $oIfxA->f('prod_sn_noi');
                        $prod_sn_exe = $oIfxA->f('prod_sn_exe');
                    }
                }
                $oIfxA->Free();


                if ($prod_sn_noi == 'S') {
                    $tot_nobiva += $subTotal_sin_iva;
                }
                if ($prod_sn_exe == 'S') {
                    $tot_exeiva += $subTotal_sin_iva;
                }

                //$deta_adicional = '';

                $deta .= ' <tr>';
                $deta .= ' <td style="width: 10%;">' . $dfac_cod_prod . '</td>';
                //$deta .= ' <td style="width: 10%;">' . $cod_alterno . '</td>';
                $deta .= ' <td style="width: 5%;" align="right">' . number_format($dfac_cant_dfac, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 30%;">' . $dfac_nom_prod . '</td>';
                $deta .= ' <td style="width: 20%;">' . $deta_adicional . '</td>';
                $deta .= ' <td style="width: 7%;" align="right">' . number_format($dfac_precio_dfac, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 5%;" align="right">' . number_format($subsidio, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 7%;" align="right">' . number_format($prec_sin_subsidio, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 6%;" align="right">' . number_format(round($dfac_des1_dfac, 0), 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 10%;" align="right">' . number_format($subTotal_sin_iva, 2, '.', ',') . '</td>';
                $deta .= ' </tr>';
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $deta .= ' </table>';

    //VALIDAICON LIQUIDACIONES INGRESADAS MARZO - IVA 12%

    if($fact_fech_fact<'2024-04-01'){
        $porcIva=12;
    }

    $totales .= ' <table style="width: 100%; font-size: 13px; margin-top: 3px; border-radius: 5px; border-collapse: collapse;"  border=1 align="right">';


    $totales .= ' <tr>';
    $totales .= ' <b> <td>SUBTOTAL  IVA '.round($porcIva,0).' %:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_con_miva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>SUBTOTAL  IVA 0%:</td> </b>';
    $totales .= ' <td align="right">' . number_format(($fact_sin_miva), 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>SUBTOTAL  NO OBJETO IVA:</td> </b>';
    $totales .= ' <td align="right">' . number_format(($tot_nobiva), 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>SUBTOTAL  EXENTO IVA:</td> </b>';
    $totales .= ' <td align="right">' . number_format(($tot_exeiva), 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>SUBTOTAL SIN IMPUESTOS:</td> </b>';
    $totales .= ' <td style="width: 10%;" align="right">' . number_format($fact_con_miva + $fact_sin_miva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>DESCUENTO:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>ICE:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_ice, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>IVA ' . round($porcIva) . '%:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_iva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>VALOR TOTAL:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_con_miva + $fact_sin_miva + $fact_iva - $fact_dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' </table>';

    $total = number_format($fact_con_miva + $fact_sin_miva + $fact_iva - $totalDescuento, 2, '.', '');
    $V = new EnLetras();
    $con_letra = strtoupper($V->ValorEnLetras($total, 'dolar'));

    //query forma de pago
    $sqlFPago = " select fpag_cod_fpagop, mxfp_val_mxfp, mxfp_num_dias, mxfp_fec_fin,
                        (select fpagop_des_fpagop from saefpagop 
                        where fpagop_cod_empr = fpag_cod_empr and 
                        fpagop_cod_fpagop = fpag_cod_fpagop) as fpagop_des_fpagop
                    from saemxfp, saefpag
                    where mxfp_cod_empr = fpag_cod_empr 
                    and mxfp_cod_sucu = fpag_cod_sucu 
                    and mxfp_cod_fpag = fpag_cod_fpag
                    and  mxfp_num_comp = $id
                    and mxfp_cod_empr = $idEmpresa
                    and mxfp_cod_sucu = $idSucursal";
    if ($oIfx->Query($sqlFPago)) {
        if ($oIfx->NumFilas() > 0) {
            $tablePago .= '<table style="width: 60%; border-collapse: collapse;" border="1">';
            $tablePago .= '<tr>';
            $tablePago .= '<th style="width: 70%;">FORMA PAGO</th>';
            $tablePago .= '<th style="width: 30%;">VALOR</th>';
            $tablePago .= '</tr>';
            do {
                $fpag_cod_fpagop = $oIfx->f('fpag_cod_fpagop');
                $fxfp_val_fxfp = $oIfx->f('mxfp_val_mxfp');
                $fxfp_num_dias = $oIfx->f('mxfp_num_dias');
                $fpagop_des_fpagop = $oIfx->f('fpagop_des_fpagop');

                $tablePago .= '<tr>';
                $tablePago .= '<td style="width: 70%;">' . $fpag_cod_fpagop . ' ' . htmlentities($fpagop_des_fpagop) . '</td>';
                $tablePago .= '<td style="width: 30%;" align="right">' . number_format($fxfp_val_fxfp, 2, '.', '') . '</td>';
                $tablePago .= '</tr>';
            } while ($oIfx->SiguienteRegistro());
            $tablePago .= '</table>';
        }
    }
    $oIfx->Free();

    // LEEYNDA
    /* $tableLeyenda .= '<br><br>';
    $tableLeyenda .= '<table style="width: 98%; border-collapse: collapse; margin-top: 10px;" border="0">';
    $tableLeyenda .= '<tr>';
    $tableLeyenda .= '<td style="width: 98%;" align="center">"Sirvase emitir el comprobante de retencion hasta 5 dias habiles despues de la fecha de emision de factura, cumpliendo con los requisitos y caracteristicas de los Articulos del LRTI."</td>';
    $tableLeyenda .= '</tr>';

    $tableLeyenda .= '<tr><td style="width: 98%;" align="center">&nbsp;</td></tr>';
    $tableLeyenda .= '<tr><td style="width: 98%;" align="center">&nbsp;</td></tr>';
    $tableLeyenda .= '<tr><td style="width: 98%;" align="center">&nbsp;</td></tr>';
    $tableLeyenda .= '<tr><td style="width: 98%;" align="center"></td></tr>';
    $tableLeyenda .= '<tr><td style="width: 98%;" align="center"></td></tr>';
    $tableLeyenda .= '<tr><td style="width: 98%;" align="center"></td></tr>';
    $tableLeyenda .= '<tr><td style="width: 98%;" align="center"></td></tr>';
    $tableLeyenda .= '<tr><td style="width: 98%;" align="center"></td></tr>';
    $tableLeyenda .= '<tr><td style="width: 98%;" align="center"></td></tr>';
    $tableLeyenda .= '<tr><td style="width: 98%;" align="center"></td></tr>';
    $tableLeyenda .= '<tr><td style="width: 98%;" align="center"></td></tr>';
    $tableLeyenda .= '<tr><td style="width: 98%;" align="center"></td></tr>';
    $tableLeyenda .= '<tr><td style="width: 98%;" align="center"></td></tr>';
    $tableLeyenda .= '<tr><td style="width: 98%;" align="center"></td></tr>';

    $tableLeyenda .= '<tr>';
    //$tableLeyenda .= '<td style="width: 98%;" align="center">------------------------------------------------------</td>';
    $tableLeyenda .= '</tr>';
    $tableLeyenda .= '<tr><td style="width: 98%;" align="center"></td></tr>';
    $tableLeyenda .= '<tr><td style="width: 98%;" align="center"></td></tr>';
    $tableLeyenda .= '<tr><td style="width: 98%;" align="center"></td></tr>';
    $tableLeyenda .= '<tr>';
    $tableLeyenda .= '<td style="width: 98%;" align="center">FIRMA AUTORIZADA</td>';
    $tableLeyenda .= '</tr>';
    $tableLeyenda .= '<tr>';
    //$tableLeyenda .= '<td style="width: 98%;" align="center">CEGA INTERNATIONAL TRADERS S.A.</td>';
    $tableLeyenda .= '</tr>';

    $tableLeyenda .= '</table>';*/

    $legend = '<page_footer>
    <div style="text-align:center;color: #6B6565; background-color: transparent;">Este comprobante electronico ha sido generado a traves de Sisconti S.A. - Facturacion Electronica<br>www.sisconti.com.ec</div>
    </page_footer>';

    $documento .= '<page backimgw="70%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
    $documento .= $logo . $cliente . $deta . $totales . $tablePago . $tableLeyenda;
    // echo $logo;exit;
    // $documento .= $logo ;
    $documento .= $legend;
    $documento .= '</page>';

    // file_put_contents("/var/www/html/prueba_liquidacion.html",$documento);

    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;

    return $documento;
}

function reporte_pedido($id = '', $nombre_archivo = '', &$rutaPdf = '')
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo
                                            from saeempr where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';

            $empr_num_resu = $oIfx->f('empr_num_resu');
        }
    }
    $oIfx->Free();

    $logo .= '<table style="width: 100%; margin: 0px;">';
    $logo .= '<tr>';
    $logo .= '<b><td align="center" style="width: 100%; margin: 0px;">';
    $logo .= '<table align="center" style="margin: 0px;">';
    $logo .= '<tr><td style="margin-top: 0px;"><img width="200px;" height="150px;" src="' . $empr_path_logo . '"></td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 20px;">' . $razonSocial . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 16px;">RUC : ' . $ruc_empr . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';

    //selecciona sucursales y direcciones
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa";
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                $logo .= '<tr><td align="center" style="font-size: 13px">' . $sucu_nom_sucu . ': ' . htmlentities($sucu_dir_sucu) . '</td></tr>';
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $sqlPed = "SELECT * FROM saepedf WHERE
                            pedf_cod_pedf = $id and
                            pedf_cod_empr = $idEmpresa and
                            pedf_cod_sucu = $idSucursal";


    if ($oIfx->Query($sqlPed)) {
        if ($oIfx->NumFilas() > 0) {
            do {

                $id_pedido = $oIfx->f('pedf_cod_pedf');
                $codigo_op = $oIfx->f('pedf_num_preimp');
                $id_cliente = $oIfx->f('pedf_cod_clpv');
                $pedf_cod_pedf = $oIfx->f('pedf_cod_pedf');
                $nombre_cliente = $oIfx->f('pedf_nom_cliente');
                $ruc_cliente = $oIfx->f('pedf_ruc_clie');
                $telefono = $oIfx->f('pedf_tlf_cliente');
                $direccion = $oIfx->f('pedf_dir_clie');
                $id_user = $oIfx->f('pedf_user_web');
                $fecha_user = $oIfx->f('pedf_fech_fact');
                $prioridad = $oIfx->f('prioridad');
                $vend_cod_vend = $oIfx->f('pedf_cod_vend');
                $pedf_email_clpv = $oIfx->f('pedf_email_clpv');
                $subtotal = $oIfx->f('pedf_tot_fact');
                $con_iva = $oIfx->f('pedf_con_miva');
                $sin_iva = $oIfx->f('pedf_sin_miva');
                $dsg_valo = $oIfx->f('pedf_dsg_valo');
                $iva = $oIfx->f('pedf_iva');
                $pedf_cm1_pedf = $oIfx->f('pedf_cm1_pedf');

                // nombre vendedor
                $sql_vend = "select vend_nom_vend from saevend where vend_cod_vend = '$vend_cod_vend' ";
                if ($oIfxA->Query($sql_vend)) {
                    if ($oIfxA->NumFilas() > 0) {
                        $nombre_vendedor = htmlentities($oIfxA->f('vend_nom_vend'));
                    } else {
                        $nombre_vendedor = '';
                    }
                }
                $oIfxA->Free();

                $logo .= '<tr><td>&nbsp;</td></tr>';
                $logo .= '<tr><td align="center" style="font-size: 18px; color: red;">PEDIDO : ' . $codigo_op . '</td></tr>';
                $logo .= ' </table>';
                $logo .= '</td></b>';
                $logo .= '</tr>';
                $logo .= '</table>';

                $cliente .= ' <table style="width: 100%; padding: 2px; font-size: 15x;">';
                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 13%"> CLIENTE: </td></b>';
                $cliente .= ' <td style="width: 50% ">' . htmlentities($nombre_cliente) . '</td>';
                $cliente .= ' <b><td style="width: 15% "> FECHA PEDIDO: </td></b>';
                $cliente .= ' <td style="width: 22% ">' . fecha_mysql($fecha_user) . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 13% "> RUC: </td></b>';
                $cliente .= ' <td style="width: 50% ">' . $ruc_cliente . '</td>';
                $cliente .= ' <b><td style="width: 15% "> TELEFONO: </td></b>';
                $cliente .= ' <td style="width: 22% ">' . $telefono . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 13% "> DIRECCION: </td></b>';
                $cliente .= ' <td style="width: 50% ">' . htmlentities($direccion) . '</td>';
                $cliente .= ' <b><td style="width: 15% "> EMAIL: </td></b>';
                $cliente .= ' <td style="width: 22% ">' . $pedf_email_clpv . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 13% "> VENDEDOR: </td></b>';
                $cliente .= ' <td style="width: 50% " colspan="2">' . $nombre_vendedor . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' </table>';

                $cliente .= ' <br>';
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    $sqlDeta = "select * from saedpef where dpef_cod_pedf = $id and dpef_cod_sucu = $idSucursal and dpef_cod_empr = $idEmpresa ";

    $deta .= ' <table style="width: 100%; font-size: 13px; border-radius: 5px;" border="1">';
    $deta .= ' <tr>';
    //$deta .= ' <b> <th class="diagrama" style="width: 6%;" align="center">No.</th> </b>';
    $deta .= ' <b> <th class="diagrama" style="width: 12%;" align="center">CODIGO</th> </b>';
    $deta .= ' <b> <th class="diagrama" style="width: 27%;" align="center">DESCRIPCION</th> </b>';
    $deta .= ' <b> <th class="diagrama" style="width: 27%;" align="center">DETALLE</th> </b>';
    $deta .= ' <b> <th class="diagrama" style="width: 8%;" align="center">CANTIDAD</th> </b>';
    $deta .= ' <b> <th class="diagrama" style="width: 8%;" align="center">PRECIO</th> </b>';
    $deta .= ' <b> <th class="diagrama" style="width: 8%;" align="center">DSCTO %</th> </b>';
    $deta .= ' <b> <th class="diagrama" style="width: 10%;" align="center">TOTAL</th> </b>';
    $deta .= ' </tr>';

    if ($oIfx->Query($sqlDeta)) {
        if ($oIfx->NumFilas() > 0) {
            $i = 1;
            do {
                $dfac_cod_prod = $oIfx->f('dpef_cod_prod');
                $dfac_nom_prod = $oIfx->f('dpef_nom_prod');
                $dfac_cant_dfac = $oIfx->f('dpef_cant_dfac');
                $dfac_precio_dfac = $oIfx->f('dpef_precio_dfac');
                $dfac_des1_dfac = $oIfx->f('dpef_des1_dfac');
                $dfac_des2_dfac = $oIfx->f('dpef_des2_dfac');
                $dfac_por_dsg = $oIfx->f('dpef_por_dsg');
                $dfac_mont_total = $oIfx->f('dpef_mont_total');
                $dpef_det_dpef = $oIfx->f('dpef_det_dpef');
                $dpef_cod_bode = $oIfx->f('dpef_cod_bode');

                $descuento = $dfac_des1_dfac + $dfac_des2_dfac + $dfac_por_dsg;
                if ($descuento > 0)
                    $descuento = ($dfac_precio_dfac * $dfac_cant_dfac) - ($dfac_mont_total);
                else
                    $descuento = 0;

                $totalDescuento = $totalDescuento + $descuento;

                //consulta bodega
                $sql = "select bode_nom_bode from saebode where bode_cod_bode = $dpef_cod_bode";
                $bode_nom_bode = consulta_string($sql, 'bode_nom_bode', $oIfxA, '');

                $deta .= ' <tr>';
                //$deta .= ' <td style="width: 6%;">' . $i . '</td>';
                $deta .= ' <td style="width: 12%;">' . $dfac_cod_prod . '</td>';
                $deta .= ' <td style="width: 27%;">' . htmlentities($dfac_nom_prod) . '</td>';
                $deta .= ' <td style="width: 27%;">' . htmlentities($dpef_det_dpef) . '</td>';
                $deta .= ' <td style="width: 8%;" align="right">' . round($dfac_cant_dfac, 0) . '</td>';
                $deta .= ' <td style="width: 8%;" align="right">' . number_format($dfac_precio_dfac, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 8%;" align="right">' . round($dfac_des1_dfac, 0) . '</td>';
                $deta .= ' <td style="width: 10%;" align="right">' . number_format($dfac_mont_total, 2, '.', ',') . '</td>';
                $deta .= ' </tr>';
                $i++;
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $deta .= ' </table>';

    $totales .= ' <table style="width: 100%; font-size: 13px; margin-top: 3px; border-radius: 5px;"  border=1 align="right">';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>SUBTOTAL SIN IMPUESTOS:</td> </b>';
    $totales .= ' <td style="width: 10%;" align="right">' . number_format($con_iva + $sin_iva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>SUBTOTAL  IVA 12%:</td> </b>';
    $totales .= ' <td align="right">' . number_format($con_iva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>SUBTOTAL  IVA 0%:</td> </b>';
    $totales .= ' <td align="right">' . number_format($sin_iva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>DESCUENTO:</td> </b>';
    $totales .= ' <td align="right">' . number_format($dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>IVA:</td> </b>';
    $totales .= ' <td align="right">' . number_format($iva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>TOTAL:</td> </b>';
    $totales .= ' <td align="right">' . number_format($con_iva + $sin_iva + $iva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' </table>';

    $totales .= ' <table style="width: 100%; font-size: 13px; border-radius: 5px;">';
    $totales .= ' <tr>';
    $totales .= ' <b> <td style="width: 15%;" align="left">OBSERVACIONES:</td> </b>';
    $totales .= ' <td style="width: 85%;" align="left">' . $pedf_cm1_pedf . '</td>';
    $totales .= ' </tr>';
    $totales .= ' </table>';

    $total = number_format($con_iva + $sin_iva + $iva - $totalDescuento, 2, '.', '');
    $V = new EnLetras();
    $con_letra = strtoupper($V->ValorEnLetras($total, 'dolar'));

    /* $totales .= '<table style="width: 100%;">';
      $totales .= '<tr>';
      $totales .= '<td>TOTAL :  </td>';
      $totales .= '<td>' . $con_letra . '</td>';
      $totales .= '</tr>';
      $totales .= '</table>'; */

    /* $legend = '<page_footer>
      <table align="center" style="width: 80%">
      <tr>
      <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">Este comprobante electronico ha sido generado a traves de Sisconti S.A. - Facturacion Electronica</td>
      </tr>
      <tr>
      <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">www.sisconti.com.ec</td>
      </tr>
      </table>
      </page_footer>'; */

    $documento .= '<page backimgw="70%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
    $documento .= $logo . $cliente . $deta . $totales;
    //$documento .= $legend;
    $documento .= '</page>';

    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;

    return $documento;
}

function reporteContratoClpv($id_clpv = '', $id_contrato = '', &$rutaPdf = '')
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo
                                            from saeempr where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';

            $empr_num_resu = $oIfx->f('empr_num_resu');
        }
    }
    $oIfx->Free();

    $logo .= '<table style="width: 100%; margin: 0px;">';
    $logo .= '<tr>';
    $logo .= '<b><td align="center" style="width: 100%; margin: 0px;">';
    $logo .= '<table align="center" style="margin: 0px;">';
    $logo .= '<tr><td align="left" style="font-size: 20px;">ACTUALIZACION  DE DATOS</td></tr>';
    $logo .= '<tr><td style="margin-top: 0px;"><img width="200px;" height="150px;" src="' . $empr_path_logo . '"></td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="left" style="font-size: 20px;">' . $razonSocial . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="left" style="font-size: 16px;">RUC : ' . $ruc_empr . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="left" style="font-size: 16px;">RUC : ' . $dirMatriz . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';

    $logo .= '</table>';
    $logo .= '</td></b>';
    $logo .= '</tr>';
    $logo .= '</table>';


    $sql = "select codigo, nom_clpv, ruc_clpv, fecha_contrato, fecha_cobro 
			from contrato_clpv
			where id = $id_contrato and
			id_clpv = $id_clpv";
    if ($oCon->Query($sql)) {
        if ($oCon->NumFilas() > 0) {
            $codigo = $oCon->f('codigo');
            $nom_clpv = $oCon->f('nom_clpv');
            $ruc_clpv = $oCon->f('ruc_clpv');
            $fecha_contrato = $oCon->f('fecha_contrato');
            $fecha_cobro = $oCon->f('fecha_cobro');

            //servicio contratado
            $sql = "select clse_cod_prod, clse_nom_prod
					from saeclse
					where clse_cod_empr = $idEmpresa and
					clse_cod_clpv = $id_clpv and
					clse_cod_contr = $id_contrato";
            if ($oIfx->Query($sql)) {
                if ($oIfx->NumFilas() > 0) {
                    $clse_cod_prod = $oIfx->f('clse_cod_prod');
                    $clse_nom_prod = $oIfx->f('clse_nom_prod');
                }
            }
            $oIfx->Free();

            $logo .= '<table align="left" style="margin: 0px;">';
            $logo .= '<tr>';
            $logo .= '<td style="font-size: 18px;">Fecha Contrato:</td>';
            $logo .= '<td style="font-size: 18px;">' . $fecha_contrato . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td style="font-size: 18px;">Codigo:</td>';
            $logo .= '<td style="font-size: 18px;">' . $codigo . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td style="font-size: 18px;">Identificacion:</td>';
            $logo .= '<td style="font-size: 18px;">' . $ruc_clpv . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td style="font-size: 18px;">Nombres:</td>';
            $logo .= '<td style="font-size: 18px;">' . $nom_clpv . '</td>';
            $logo .= '</tr>';
            $logo .= '<tr>';
            $logo .= '<td style="font-size: 18px;">Servicio Contratdo:</td>';
            $logo .= '<td style="font-size: 18px;">' . $clse_nom_prod . '</td>';
            $logo .= '</tr>';
            $logo .= '</table>';
        }
    }
    $oCon->Free();

    $sql = "select fecha 
			from contrato_pago
			where id_contrato = $id_contrato";
    if ($oCon->Query($sql)) {
        if ($oCon->NumFilas() > 0) {
            $logo .= '<table align="left" border="1" style="margin: 0px; border-collapse: collapse;">';
            $logo .= '<tr>';
            $logo .= '<td style="font-size: 18px;">Cuota</td>';
            $logo .= '<td style="font-size: 18px;">Fecha</td>';
            $logo .= '</tr>';
            $i = 1;
            do {
                $fecha = $oCon->f('fecha');
                $logo .= '<tr>';
                $logo .= '<td style="font-size: 18px;">' . $i . '</td>';
                $logo .= '<td style="font-size: 18px;">' . $fecha . '</td>';
                $logo .= '</tr>';
                $i++;
            } while ($oCon->SiguienteRegistro());
            $logo .= '</table>';
        }
    }
    $oCon->Free();


    /* $totales .= '<table style="width: 100%;">';
      $totales .= '<tr>';
      $totales .= '<td>TOTAL :  </td>';
      $totales .= '<td>' . $con_letra . '</td>';
      $totales .= '</tr>';
      $totales .= '</table>'; */

    /* $legend = '<page_footer>
      <table align="center" style="width: 80%">
      <tr>
      <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">Este comprobante electronico ha sido generado a traves de Sisconti S.A. - Facturacion Electronica</td>
      </tr>
      <tr>
      <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">www.sisconti.com.ec</td>
      </tr>
      </table>
      </page_footer>'; */


    $documento .= '<page backimgw="70%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
    $documento .= $logo . $cliente . $deta . $totales;
    //$documento .= $legend;
    $documento .= '</page>';

    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $id_contrato . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;

    return $documento;
}

function fechaSumaDias($fecha, $dias){

    $nuevafecha = strtotime ('+'.$dias.'day', strtotime ( $fecha ) ) ;
    $nuevafecha = date ('Y-m-d', $nuevafecha);
 
    return $nuevafecha;
}

function reporte_orden_compra($minv_serial = '', $id = '')
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oCnx = new Dbo ();
    $oCnx->DSN = $DSN;
    $oCnx->Conectar();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $idempresa = $_SESSION['U_EMPRESA'];
    $logo='';


    $sql = "select unid_sigl_unid, unid_cod_unid from saeunid where unid_cod_empr = $idempresa ";
    unset($array_unid);
    $array_unid = array_dato($oIfx, $sql, 'unid_cod_unid', 'unid_sigl_unid');

    
    $sqlf="SELECT fpag_des_fpag FROM SAEFPAG WHERE fpag_cod_modu=10";
    $forma_pago=consulta_string($sqlf,'fpag_des_fpag',$oIfxA,'');

    if (!empty($minv_serial)) {

        $sql = "select empr_ema_comp, empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_path_logo 
				from saeempr where empr_cod_empr = $idempresa ";
        if ($oIfx->Query($sql)) {
            if ($oIfx->NumFilas() > 0) {
                $razonSocial = trim($oIfx->f('empr_nom_empr'));
                $ruc_empr = $oIfx->f('empr_ruc_empr');
                $dirMatriz = trim($oIfx->f('empr_dir_empr'));
                $empr_path_logo = $oIfx->f('empr_path_logo');
                $empr_ema_comp = $oIfx->f('empr_ema_comp');
                if ($oIfx->f('empr_conta_sn') == 'S')
                    $empr_conta_sn = 'SI';
                else
                    $empr_conta_sn = 'NO';

                $empr_num_resu = $oIfx->f('empr_num_resu');
            }
        }
        $oIfx->Free();
        $arc_img = DIR_FACTELEC . "Include/Clases/Formulario/Plugins/reloj/" . basename($empr_path_logo);

        if (file_exists($arc_img)) {
            $imagen = $arc_img;
        } else {
            $imagen = '';
        }
        $logo = '';
        $x = '0px';
        if ($imagen != '') {

            $empr_logo = '<div style="text-align:center">
            <img src="' . $imagen . '" style="
            width:200px;
            object-fit; contain;">
            </div>';
            $x = '0px';
        }

        $logo .= '<table  style="width: 100%; border:1px solid black; border-radius: 5px; padding: 2px; "align="center">';
        $logo .= '<tr><td >'.$empr_logo.'</td></tr>';
        $logo .= '<tr><td align="center" style="font-size: 18px;"><b>' . $razonSocial . '</b></td></tr>';
        $logo .= '<tr><td align="center" style="font-size: 18px;"><b>RUC :</b> ' . $ruc_empr . '</td></tr>';
        $logo .= '<tr><td align="center" style="font-size: 18px;"><b>DIRECCION :</b> ' . $dirMatriz . '</td></tr>';
        if(!empty($empr_ema_comp)){
            $logo .= '<tr><td align="center" style="font-size: 18px;" ><b>CORREO:</b> '.$empr_ema_comp.'</td></tr>';
        }
        $logo .= '</table>';

        $logo .= '<br>';
        $logo .= '<br>';

        $sqlFac = "SELECT distinct( minv_num_comp),   minv_fmov,      clpv_nom_clpv,   
					minv_num_sec, minv_cod_clpv, minv_est_minv, minv_cm3_minv,
					minv_cm1_minv,
					minv_tot_minv,
					minv_iva_valo,
					minv_dge_valo,
					minv_cm6_minv,
                    minv_fec_entr,
                    minv_user_web,
                    minv_num_plaz,
					(COALESCE(minv_tot_minv,0) - COALESCE(minv_dge_valo,0) + COALESCE(minv_iva_valo,0) + COALESCE(minv_otr_valo,0) - COALESCE(minv_fle_minv,0) + COALESCE(minv_val_ice,0) ) total
					FROM saeminv,    saeclpv,    saedmov   WHERE 
					minv_cod_clpv =  clpv_cod_clpv  and  
					minv_num_comp = dmov_num_comp and  
					minv_cod_tran in  ( select defi_cod_tran from saedefi Where 
					defi_tip_defi  = '4' and 
					defi_cod_empr  = $idempresa and 
					defi_cod_modu  = 10)  AND  
					minv_cod_empr = $idempresa  AND  
					minv_num_comp = $minv_serial AND
					clpv_cod_empr = $idempresa AND
					(( minv_cer_sn is null) or ( minv_cer_sn = 'N' ) or ( minv_cer_sn = 'S' ) )";


        if ($oIfx->Query($sqlFac)) {
            if ($oIfx->NumFilas() > 0) {
                do {
                    $minv_num_comp = $oIfx->f('minv_num_comp');
                    $minv_est_minv = $oIfx->f('minv_est_minv');
                    $clpv_nom_clpv = $oIfx->f('clpv_nom_clpv');
                    $minv_num_sec = $oIfx->f('minv_num_sec');
                    $minv_num_plaz = $oIfx->f('minv_num_plaz');

                    if(empty($minv_num_plaz)){
                        $minv_num_plaz=0;
                    }
                    $minv_cod_clpv = $oIfx->f('minv_cod_clpv');
                    $usuario= $oIfx->f('minv_user_web');

                    $sqlgru="select grpv_cod_grpv from saeclpv where clpv_cod_clpv=$minv_cod_clpv";
                    $cod_grvpv=consulta_string($sqlgru,'grpv_cod_grpv',$oIfxA,'');
                    //grupo
                    $sqlgru="select grpv_nom_grpv from saegrpv where grpv_cod_grpv='$cod_grvpv'";
                    $grupo=consulta_string($sqlgru,'grpv_nom_grpv',$oIfxA,'');
  
                    $minv_fmov = $oIfx->f('minv_fmov');
                    $minv_fmov= date('d-m-Y',strtotime($minv_fmov));
                    $minv_fentr = $oIfx->f('minv_fec_entr');
                    $minv_fentr= date('d-m-Y',strtotime($minv_fentr));

                    $total = $oIfx->f('total');
                    $minv_cm3_minv = $oIfx->f('minv_cm3_minv');
                    $minv_cm1_minv = $oIfx->f('minv_cm1_minv');
                    $minv_tot_minv = $oIfx->f('minv_tot_minv');
                    $minv_iva_valo = $oIfx->f('minv_iva_valo');
                    $minv_dge_valo = $oIfx->f('minv_dge_valo');
                    $minv_cm6_minv = $oIfx->f('minv_cm6_minv');

                    // direccion
                    $sql = "select min( dire_dir_dire ) as dire  from saedire where
							dire_cod_empr = $idempresa and
							dire_cod_clpv = $minv_cod_clpv ";
                    $direccion = acento_func(consulta_string_func($sql, 'dire', $oIfxA, ''));

                    // telefono
                    $sql = "select min( tlcp_tlf_tlcp ) as telf  from saetlcp where
							tlcp_cod_empr = $idempresa and
							tlcp_cod_clpv = $minv_cod_clpv ";
                    $telefono = acento_func(consulta_string_func($sql, 'telf', $oIfxA, ''));


                    $cliente .= ' <table style="width: 100%; font-size: 17px; border:1px solid black; border-radius: 5px; padding: 2px; ">';
                    $cliente .= ' <tr>';
                    $cliente .= ' <b><td style="width: 22%;white-space:nowrap;"> Tipo Cta: </td></b>';
                    $cliente .= ' <td style="width: 48%; white-space:nowrap;">' . htmlentities($grupo) . '</td>';
                    $cliente .= ' <b><td style="width: 15%;white-space:nowrap;"> FECHA EMISION: </td></b>';
                    $cliente .= ' <td style="width: 15%;white-space:nowrap;">' . $minv_fmov . '</td>';
                    $cliente .= ' </tr>';
                    $cliente .= ' <tr>';
                    $cliente .= ' <b><td style="width: 22%"> PROVEEDOR: </td></b>';
                    $cliente .= ' <td style="width: 48% ">' . htmlentities($clpv_nom_clpv) . '</td>';
                    $cliente .= ' <b><td style="width: 15% "> FECHA ENTREGA: </td></b>';
                    $cliente .= ' <td style="width: 15% ">' . $minv_fentr . '</td>';
                    $cliente .= ' </tr>';

                    $cliente .= ' <tr>';
                    $cliente .= ' <td style="width: 22% "><strong>DIRECCION:</strong> </td>';
                    $cliente .= ' <td style="width: 48% ">' . htmlentities($direccion) . '</td>';
                    $cliente .= ' <td style="width: 15% "><strong>TELEFONO: </strong></td>';
                    $cliente .= ' <td style="width: 15% ">' . $telefono . '</td>';
                    $cliente .= ' </tr>';

                    $cliente .= ' <tr>';
                    $cliente .= ' <td style="width: 22% "><strong>ORDEN DE COMPRA No: </strong></td>';
                    $cliente .= ' <td style="width: 48% ">' . $minv_num_sec . ' - '.$minv_num_comp.'</td>';
                    $cliente .= '<td style="width: 15% "><strong>TRANSPORTE: </strong></td>';
                    $cliente .= ' <td style="width: 15% ">' . $minv_cm3_minv . '</td>';
                    $cliente .= ' </tr>';

                    $cliente .= ' <tr>';
                    $cliente .= ' <td style="width: 20%;"><strong> OBSERVACIONES: </strong></td>';
                    $cliente .= ' <td  colspan="3" style="width: 80%;">' . $minv_cm1_minv. '</td>';
                    $cliente .= ' </tr>';
                    if ($minv_cm6_minv != '') {

                        $cliente .= ' <tr>';
                        $cliente .= ' <td style="width: 20% "><strong> OBSERVACIONES2: </strong></td>';
                        $cliente .= ' <td colspan="3" style="width: 80%;">' . $minv_cm6_minv . '</td>';
                        $cliente .= ' </tr>';
                    }
                    $cliente .= ' </table>';

                    $cliente .= '<br>';
                    $cliente .= '<br>';

                } while ($oIfx->SiguienteRegistro());
            }
        }
        $oIfx->Free();

        if(!empty($minv_fmov)){
            $FechaCre = fechaSumaDias($minv_fmov, $minv_num_plaz);
            $FechaCre= date('d-m-Y',strtotime($FechaCre));
        }
        else{
            $FechaCre='NA';
        }

       
       

        if(!empty($usuario)){
            $sql = "select u.USUARIO_USER, concat(u.usuario_nombre,' ',u.usuario_apellido) as apenomb  from comercial.usuario u where u.USUARIO_ID = $usuario ";
            $nombre_usuario=consulta_string_func($sql, 'apenomb', $oIfxA, '');
        }



        $sqlDeta = "select  d.dmov_cod_prod, d.dmov_cod_bode, d.dmov_cod_unid, d.dmov_iva_porc, 
					d.dmov_can_dmov, d.dmov_can_entr, 
					p.prod_nom_prod, d.dmov_cun_dmov, pr.prbo_iva_porc,
					dmov_fmov, dmov_cod_ccos
					from saedmov d , saeprod p, saeprbo pr where
					p.prod_cod_prod = d.dmov_cod_prod and
					p.prod_cod_prod = pr.prbo_cod_prod and
					p.prod_cod_empr = pr.prbo_cod_empr and
					p.prod_cod_sucu = pr.prbo_cod_sucu and
					d.dmov_cod_bode = pr.prbo_cod_bode and
					p.prod_cod_empr = $idempresa and
					d.dmov_num_comp = $minv_serial and
					d.dmov_cod_empr = $idempresa 
					order by d.dmov_cod_dmov ";

        $deta .= ' <table style="width: 100%; font-size: 16px; border-radius: 2px; border-collapse: collapse;" border="1">';
        $deta .= ' <tr>';
        $deta .= ' <td style="width: 10%;white-space:nowrap;" align="center"><strong>CODIGO</strong></td>';
        $deta .= ' <td style="width: 39%;white-space:nowrap;" align="center"><strong>DESCRIPCION</strong></td> ';
       // $deta .= '  <td style="width: 20%;" align="center"><strong>C. COSTOS</strong></td> ';
        $deta .= '  <td style="width: 12%;white-space:nowrap;" align="center"><strong>CANT ORDENADA</strong></td>';
        $deta .= '  <td style="width: 12%;white-space:nowrap;" align="center"><strong>CANT RECIBIDA</strong></td>';
        $deta .= '  <td style="width: 7%;white-space:nowrap;" align="center"><strong>UNIDAD</strong></td>';
        $deta .= '  <td style="width: 10%;white-space:nowrap;" align="center"><strong>PRECIO UNITARIO</strong></td>';
        $deta .= '  <td style="width: 10%;white-space:nowrap;" align="center"><strong>VALOR TOTAL</strong></td>';
        $deta .= ' </tr>';
        $total_iva=0;
        if ($oIfx->Query($sqlDeta)) {
            if ($oIfx->NumFilas() > 0) {
                do {
                    $prod_cod = $oIfx->f('dmov_cod_prod');
                    $prod_nom_prod = $oIfx->f('prod_nom_prod');
                    $bode_cod = $oIfx->f('dmov_cod_bode');
                    $unid_cod = $oIfx->f('dmov_cod_unid');
                    //$cantidad = $oIfx->f('cantidad');
                    $cantidad= $oIfx->f('dmov_can_dmov');
                    $cantidad_rec= $oIfx->f('dmov_can_entr');
                    $costo = $oIfx->f('dmov_cun_dmov');
                    $cta_inv = $oIfx->f('prbo_cta_inv');
                    $cta_iva = $oIfx->f('prbo_cta_ideb');
                    //$iva = $oIfx->f('prbo_iva_porc');
                    $iva = $oIfx->f('dmov_iva_porc');
                    $dmov_fmov = $oIfx->f('dmov_fmov');
                    $dmov_cod_ccos = $oIfx->f('dmov_cod_ccos');

                    $ccosn_nom_ccosn = "";
                    if (!empty($dmov_cod_ccos)) {
                        $sql = "select ccosn_nom_ccosn from saeccosn where ccosn_cod_empr = $idempresa and ccosn_cod_ccosn = '$dmov_cod_ccos'";
                        $ccosn_nom_ccosn = consulta_string_func($sql, 'ccosn_nom_ccosn', $oIfxA, '');
                    }

                    if (empty($iva)) {
                        $iva = 0;
                    }

                    // TOTAL
                    $total_fac = 0;
                    $descuento = 0;
                    $descuento_2 = 0;
                    $descuento_general = 0;
                    $dsc1 = ($costo * $cantidad * $descuento) / 100;
                    $dsc2 = ((($costo * $cantidad) - $dsc1) * $descuento_2) / 100;
                    if ($descuento_general > 0) {
                        // descto general
                        $dsc3 = ((($costo * $cantidad) - $dsc1 - $dsc2) * $descuento_general) / 100;
                        $total_fact_tmp = ((($costo * $cantidad) - ($dsc1 + $dsc2 + $dsc3)));
                        $tmp = ((($costo * $cantidad) - ($dsc1 + $dsc2)));
                    } else {
                        // sin descuento general
                        $total_fact_tmp = ((($costo * $cantidad) - ($dsc1 + $dsc2)));
                        $tmp = $total_fact_tmp;
                    }

                    $total_fac = round($total_fact_tmp, 2);

                    // total con iva
                    if ($iva > 0) {
                        $total_con_iva = round((($total_fac * $iva) / 100), 2) + $total_fac;
                        $total_iva+=round((($total_fac * $iva) / 100), 2);
                    } else {
                        $total_con_iva = $total_fac;
                    }

                    $deta .= ' <tr>';
                    $deta .= ' <td style="width: 15%;" align="center">' . $prod_cod . '</td>';
                    $deta .= ' <td style="width: 40%;">' . $prod_nom_prod . '</td>';
                    //$deta .= ' <td style="width: 20%;">' . $ccosn_nom_ccosn . '</td>';
                    $deta .= ' <td style="width: 10%;" align="right">' . round($cantidad, 0) . '</td>';
                    $deta .= ' <td style="width: 10%;" align="right">' . round($cantidad_rec, 0) . '</td>';
                    $deta .= ' <td style="width: 5%;" align="center">' . $array_unid[$unid_cod] . '</td>';
                    $deta .= ' <td style="width: 10%;" align="right">' . number_format($costo, 4, '.', ',') . '</td>';
                    $deta .= ' <td style="width: 10%;" align="right">' . number_format($total_fac, 4, '.', ',') . '</td>';
                    $deta .= ' </tr>';
                } while ($oIfx->SiguienteRegistro());
            }
        }
        $oIfx->Free();

        $deta .= ' </table>';

        ///VALIDAICON IVA

        if(round( $minv_iva_valo)==0){
            $minv_iva_valo=$total_iva;
            $total+=$minv_iva_valo;
        }

    

    $totales .='<table style="width: 100%;  font-size: 16px; margin-top: 3px;  align="center">';
    $totales .='<tr>
    <td  style="width: 50%;" align="left"> Forma de Pago:  '.$forma_pago.'<br> Dias&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Valor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Fecha fin <br>'.$minv_num_plaz.'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;100&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'.number_format($total, 2, '.', ',').'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'.$FechaCre.'</td>
    <td style="width: 50%;" align="center">';

        //$totales .= ' <table style="width: 100%; font-size: 13px; margin-top: 3px; border-radius: 5px; border-collapse: collapse;"  border=1 align="right">';
        $totales .= ' <table style=" margin-left:30px; width: 223%; font-size: 16px; border-radius: 5px; border-collapse: collapse;"  border=1 align="right">';
        $totales .= ' <tr>';
		$totales .= ' <b> <td style="width: 11.5%;">SUBTOTAL:</td> </b>';
		$totales .= ' <td align="right" style="width: 8.5%;">' . number_format($minv_tot_minv, 2, '.', ',') . '</td>';
		$totales .= ' </tr>';
		$totales .= ' <tr>';
		$totales .= ' <b> <td style="width: 11.5%;">DESCUENTO:</td> </b>';
		$totales .= ' <td align="right" style="width: 8.5%;">' . number_format($minv_dge_valo, 2, '.', ',') . '</td>';
		$totales .= ' </tr>';
		$totales .= ' <tr>';
		$totales .= ' <b> <td style="width: 11.5%;">IVA:</td> </b>';
		$totales .= ' <td align="right" style="width: 8.5%;">' . number_format($minv_iva_valo, 2, '.', ',') . '</td>';
		$totales .= ' </tr>';
		$totales .= ' <tr>';
		$totales .= ' <b> <td style="width: 11.5%;">TOTAL:</td> </b>';
		$totales .= ' <td align="right" style="width: 8.5%;">' . number_format($total, 2, '.', ',') . '</td>';
		$totales .= ' </tr>';
		$totales .= ' </table>';

        $totales .= ' </td>';
        
        $totales .= ' </tr>';

        $totales .= ' </table>';

        


        $html .= '<table style="width:90%;  margin-top: 100px" align="center" >
        <tr>
            <td style="width:40%; font-size:16px; text-align: center;border-top : 2px solid black;">Ingresado por:<br>' . $nombre_usuario . '</td>
            <td style="width:10%;"></td>
            <td style="width:40%;font-size:16px; text-align: center;border-top : 2px solid black;">Aprobado por:</td>
            <td style="width:10%;"></td>					
        </tr>
</table>';

        $documento .= '<page backimgw="70%" backtop="7mm" backbottom="7mm" backleft="7mm" backright="20mm">';
        $documento .= $logo . $cliente . $deta . $totales.$html;
        //$documento .= $logo ;
        // $documento .= $legend;
        $documento .= '</page>';



        $html2pdf = new HTML2PDF('P', 'A3', 'fr');
        $html2pdf->WriteHTML($documento);
        $ruta = DIR_FACTELEC . 'Include/orden_compra';
        if (!file_exists($ruta)){
            mkdir($ruta,0777,true);
        }

        $ruta = DIR_FACTELEC . 'Include/orden_compra/' . $minv_serial . '.pdf';
        $html2pdf->Output($ruta, 'F');
        $rutaPdf = $ruta;
        return $rutaPdf;


    }

}

function reporte_orden_compra_roma($minv_serial = '', $id = '')
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oCnx = new Dbo ();
    $oCnx->DSN = $DSN;
    $oCnx->Conectar();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $idempresa = $_SESSION['U_EMPRESA'];
    $logo='';


    if (!empty($minv_serial)) {

        $sql = "select empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_path_logo
				from saeempr where empr_cod_empr = $idempresa ";
        if ($oIfx->Query($sql)) {
            if ($oIfx->NumFilas() > 0) {
                $razonSocial = trim($oIfx->f('empr_nom_empr'));
                $ruc_empr = $oIfx->f('empr_ruc_empr');
                $dirMatriz = trim($oIfx->f('empr_dir_empr'));
                $empr_path_logo = $oIfx->f('empr_path_logo');
                if ($oIfx->f('empr_conta_sn') == 'S')
                    $empr_conta_sn = 'SI';
                else
                    $empr_conta_sn = 'NO';

                $empr_num_resu = $oIfx->f('empr_num_resu');
            }
        }
        $oIfx->Free();
        $arc_img = DIR_FACTELEC . "Include/Clases/Formulario/Plugins/reloj/" . basename($empr_path_logo);

        if (file_exists($arc_img)) {
            $imagen = $arc_img;
        } else {
            $imagen = '';
        }
        $logo = '';
        $x = '0px';
        if ($imagen != '') {

            $empr_logo = '<br><div>
            <img src="' . $imagen . '" style="
            width:200px;
            object-fit; contain;">
            </div>';
            $x = '0px';
        }

        $logo .= '<table width="100%">';
        $logo .= '<tr>';
        $logo .= '<td align="center" style="width: 100%; border:1px solid black; border-radius: 5px; margin: 0px;">';
        $logo .= '<table align="center" style="margin: 0px;">';
        $logo .= '<tr><td style="margin-top: 0px;">'.$empr_logo.'</td></tr>';
        $logo .= '<tr><td>&nbsp;</td></tr>';
        $logo .= '<tr><td align="center" style="font-size: 12px;">' . $razonSocial . '</td></tr>';
        $logo .= '<tr><td>&nbsp;</td></tr>';
        $logo .= '<tr><td align="center" style="font-size: 12px;">RUC : ' . $ruc_empr . '</td></tr>';
        $logo .= '<tr><td>&nbsp;</td></tr>';
        $logo .= '<tr><td align="center" style="font-size: 12px;">DIRECCION : ' . $dirMatriz . '</td></tr>';
        $logo .= '<tr><td>&nbsp;</td></tr>';
        $logo .= '</table>';
        $logo .= '</td>';
        $logo .= '</tr>';
        $logo .= '</table>';

        $logo .= '<br>';
        $logo .= '<br>';

        $sqlFac = "SELECT distinct( minv_num_comp),   minv_fmov,      clpv_nom_clpv,   
					minv_num_sec, minv_cod_clpv, minv_est_minv, minv_cm3_minv,
					minv_cm1_minv,
					minv_tot_minv,
					minv_iva_valo,
					minv_dge_valo,
					minv_cm6_minv,

                    minv_num_tsacos,
                    minv_calif_roma,


					(COALESCE(minv_tot_minv,0) - COALESCE(minv_dge_valo,0) + COALESCE(minv_iva_valo,0) + COALESCE(minv_otr_valo,0) - COALESCE(minv_fle_minv,0) + COALESCE(minv_val_ice,0) ) total
					FROM saeminv,    saeclpv,    saedmov   WHERE 
					minv_cod_clpv =  clpv_cod_clpv  and  
					minv_num_comp = dmov_num_comp and  
					minv_cod_tran in  ( select defi_cod_tran from saedefi Where 
					defi_tip_defi  = '4' and 
					defi_cod_empr  = $idempresa and 
					defi_cod_modu  = 10)  AND  
					minv_cod_empr = $idempresa  AND  
					minv_num_comp = $minv_serial AND
					clpv_cod_empr = $idempresa AND
					(( minv_cer_sn is null) or ( minv_cer_sn = 'N' ) )";






        if ($oIfx->Query($sqlFac)) {
            if ($oIfx->NumFilas() > 0) {
                do {
                    $minv_num_comp = $oIfx->f('minv_num_comp');
                    $minv_est_minv = $oIfx->f('minv_est_minv');
                    $clpv_nom_clpv = $oIfx->f('clpv_nom_clpv');
                    $minv_num_sec = $oIfx->f('minv_num_sec');
                    $minv_cod_clpv = $oIfx->f('minv_cod_clpv');
                    $minv_fmov = $oIfx->f('minv_fmov');
                    $total = $oIfx->f('total');
                    $minv_cm3_minv = $oIfx->f('minv_cm3_minv');
                    $minv_cm1_minv = $oIfx->f('minv_cm1_minv');
                    $minv_tot_minv = $oIfx->f('minv_tot_minv');
                    $minv_iva_valo = $oIfx->f('minv_iva_valo');
                    $minv_dge_valo = $oIfx->f('minv_dge_valo');
                    $minv_cm6_minv = $oIfx->f('minv_cm6_minv');

                    // direccion
                    $sql = "select min( dire_dir_dire ) as dire  from saedire where
							dire_cod_empr = $idempresa and
							dire_cod_clpv = $minv_cod_clpv ";
                    $direccion = acento_func(consulta_string_func($sql, 'dire', $oIfxA, ''));

                    // telefono
                    $sql = "select min( tlcp_tlf_tlcp ) as telf  from saetlcp where
							tlcp_cod_empr = $idempresa and
							tlcp_cod_clpv = $minv_cod_clpv ";
                    $telefono = acento_func(consulta_string_func($sql, 'telf', $oIfxA, ''));

                    // Detalle del romaneo
                    $bruto_tara = round($total, 2) - round($minv_num_tsacos, 2);
                    $caliiacionD = round(($bruto_tara *  $minv_calif_roma) / 100, 0);
                    $bruto_tara_calificacion = $bruto_tara - $caliiacionD;
                    $total_precio = round($bruto_tara_calificacion, 2) * round($costo, 2);


                    $cliente .= ' <table style="width: 100%; border:1px solid black; border-radius: 5px; padding: 2px; ">';
                    $cliente .= ' <tr>';
                    $cliente .= ' <b><td style="width: 13%"> PROVEEDOR: </td></b>';
                    $cliente .= ' <td style="width: 50% ">' . htmlentities($clpv_nom_clpv) . '</td>';
                    $cliente .= ' <b><td style="width: 15% "> FECHA EMISION: </td></b>';
                    $minv_fmov = str_replace("/", "", $minv_fmov);
                    $cliente .= ' <td style="width: 22% ">' . $minv_fmov . '</td>';
                    $cliente .= ' </tr>';

                    $cliente .= ' <tr>';
                    $cliente .= ' <td style="width: 13% "> <strong>DIRECCION:</strong> </td>';
                    $cliente .= ' <td style="width: 50% ">' . htmlentities($direccion) . '</td>';
                    $cliente .= ' <td style="width: 15% "><strong> TELEFONO: </strong></td>';
                    $cliente .= ' <td style="width: 22% ">' . $telefono . '</td>';
                    $cliente .= ' </tr>';

                    $cliente .= ' <tr>';
                    $cliente .= ' <td style="width: 13% "><strong> ORDEN DE COMPRA: </strong></td>';
                    $cliente .= ' <td style="width: 50% ">' . $minv_num_sec . '</td>';
                    $cliente .= '<td style="width: 15% "><strong> TRANSPORTE: </strong></td>';
                    $cliente .= ' <td style="width: 22% ">' . $minv_cm3_minv . '</td>';
                    $cliente .= ' </tr>';

                    $cliente .= ' <tr>';
                    $cliente .= ' <td style="width: 13% "><strong> OBSERVACIONES: </strong></td>';
                    $cliente .= ' <td colspan="3">' . $minv_cm1_minv . '</td>';
                    $cliente .= ' </tr>';
                    if ($minv_cm6_minv != '') {

                        $cliente .= ' <tr>';
                        $cliente .= ' <td style="width: 13% "><strong> OBSERVACIONES2: </strong></td>';
                        $cliente .= ' <td colspan="3">' . $minv_cm6_minv . '</td>';
                        $cliente .= ' </tr>';
                    }
                    $cliente .= ' </table>';

                    $cliente .= '<br>';
                    $cliente .= '<br>';

                } while ($oIfx->SiguienteRegistro());
            }
        }
        $oIfx->Free();

        $sqlDeta = "select  d.dmov_cod_prod, d.dmov_cod_bode, d.dmov_cod_unid,  
					(d.dmov_can_dmov - d.dmov_can_entr) as cantidad, 
					p.prod_nom_prod, d.dmov_cun_dmov, pr.prbo_iva_porc,
					dmov_fmov, dmov_cod_ccos
					from saedmov d , saeprod p, saeprbo pr where
					p.prod_cod_prod = d.dmov_cod_prod and
					p.prod_cod_prod = pr.prbo_cod_prod and
					p.prod_cod_empr = pr.prbo_cod_empr and
					p.prod_cod_sucu = pr.prbo_cod_sucu and
					d.dmov_cod_bode = pr.prbo_cod_bode and
					p.prod_cod_empr = $idempresa and
					d.dmov_num_comp = $minv_serial and
					d.dmov_cod_empr = $idempresa 
					order by d.dmov_cod_dmov ";

        $deta .= ' <table style="width: 100%; font-size: 13px; border-radius: 5px; border-collapse: collapse;" border="1">';
        $deta .= ' <tr>';
        $deta .= ' <td style="width: 20%;" align="center"><strong>CODIGO</strong></td>';
        $deta .= ' <td style="width: 40%;" align="center"><strong>DESCRIPCION</strong></td> ';
        $deta .= '  <td style="width: 20%;" align="center"><strong>C. COSTOS</strong></td> ';
        $deta .= '  <td style="width: 10%;" align="center"><strong>CANT BRUTO</strong></td> ';
        $deta .= '  <td style="width: 10%;" align="center"><strong>TARA</strong></td> ';
        $deta .= '  <td style="width: 10%;" align="center"><strong>CALIFICACION</strong></td> ';
        $deta .= '<td style="width: 10%;" align="center"><strong>FECHA ENTREGA</strong></td>';
        $deta .= ' </tr>';

        if ($oIfx->Query($sqlDeta)) {
            if ($oIfx->NumFilas() > 0) {
                do {
                    $prod_cod = $oIfx->f('dmov_cod_prod');
                    $prod_nom_prod = $oIfx->f('prod_nom_prod');
                    $bode_cod = $oIfx->f('dmov_cod_bode');
                    $unid_cod = $oIfx->f('dmov_cod_unid');
                    $cantidad = $oIfx->f('cantidad');
                    $costo = $oIfx->f('dmov_cun_dmov');
                    $cta_inv = $oIfx->f('prbo_cta_inv');
                    $cta_iva = $oIfx->f('prbo_cta_ideb');
                    $iva = $oIfx->f('prbo_iva_porc');
                    $dmov_fmov = $oIfx->f('dmov_fmov');
                    $dmov_cod_ccos = $oIfx->f('dmov_cod_ccos');

                    $ccosn_nom_ccosn = "";
                    if (!empty($dmov_cod_ccos)) {
                        $sql = "select ccosn_nom_ccosn from saeccosn where ccosn_cod_empr = $idempresa and ccosn_cod_ccosn = '$dmov_cod_ccos'";
                        $ccosn_nom_ccosn = consulta_string_func($sql, 'ccosn_nom_ccosn', $oIfxA, '');
                    }

                    if (empty($iva)) {
                        $iva = 0;
                    }

                    // TOTAL
                    $total_fac = 0;
                    $descuento = 0;
                    $descuento_2 = 0;
                    $descuento_general = 0;
                    $dsc1 = ($costo * $cantidad * $descuento) / 100;
                    $dsc2 = ((($costo * $cantidad) - $dsc1) * $descuento_2) / 100;
                    if ($descuento_general > 0) {
                        // descto general
                        $dsc3 = ((($costo * $cantidad) - $dsc1 - $dsc2) * $descuento_general) / 100;
                        $total_fact_tmp = ((($costo * $cantidad) - ($dsc1 + $dsc2 + $dsc3)));
                        $tmp = ((($costo * $cantidad) - ($dsc1 + $dsc2)));
                    } else {
                        // sin descuento general
                        $total_fact_tmp = ((($costo * $cantidad) - ($dsc1 + $dsc2)));
                        $tmp = $total_fact_tmp;
                    }

                    $total_fac = round($total_fact_tmp, 2);

                    // total con iva
                    if ($iva > 0) {
                        $total_con_iva = round((($total_fac * $iva) / 100), 2) + $total_fac;
                    } else {
                        $total_con_iva = $total_fac;
                    }

                    $deta .= ' <tr>';
                    $deta .= ' <td style="width: 20%;">' . $prod_cod . '</td>';
                    $deta .= ' <td style="width: 40%;">' . $prod_nom_prod . '</td>';
                    $deta .= ' <td style="width: 20%;">' . $ccosn_nom_ccosn . '</td>';
                    $deta .= ' <td style="width: 10%;" align="right">' . round($cantidad, 0) . '</td>';
                    $deta .= ' <td style="width: 10%;" align="right">' . $minv_num_tsacos . '</td>';
                    $deta .= ' <td style="width: 10%;" align="right">' . $minv_calif_roma . '</td>';
                    //$deta .= ' <td style="width: 10%;" align="right">' . number_format($costo, 4, '.', ',') . '</td>';
                    //$deta .= ' <td style="width: 10%;" align="right">' . round($total_con_iva, 0) . '</td>';
                    $deta .= ' <td style="width: 10%;" align="right">' . $dmov_fmov . '</td>';
                    $deta .= ' </tr>';
                } while ($oIfx->SiguienteRegistro());
            }
        }
        $oIfx->Free();

        $deta .= ' </table>';

        /*$totales .= ' <table style="width: 100%; font-size: 13px; margin-top: 3px; border-radius: 5px; border-collapse: collapse;"  border=1 align="right">';
		$totales .= ' <tr>';
		$totales .= ' <b> <td style="width: 10%;">SUBTOTAL:</td> </b>';
		$totales .= ' <td align="right" style="width: 10%;">' . number_format($minv_tot_minv, 2, '.', ',') . '</td>';
		$totales .= ' </tr>';
		$totales .= ' <tr>';
		$totales .= ' <b> <td style="width: 10%;">DESCUENTO:</td> </b>';
		$totales .= ' <td align="right" style="width: 10%;">' . number_format($minv_dge_valo, 2, '.', ',') . '</td>';
		$totales .= ' </tr>';
		$totales .= ' <tr>';
		$totales .= ' <b> <td style="width: 10%;">IVA:</td> </b>';
		$totales .= ' <td align="right" style="width: 10%;">' . number_format($minv_iva_valo, 2, '.', ',') . '</td>';
		$totales .= ' </tr>';
		$totales .= ' <tr>';
		$totales .= ' <b> <td style="width: 10%;">TOTAL:</td> </b>';
		$totales .= ' <td align="right" style="width: 10%;">' . number_format($total, 2, '.', ',') . '</td>';
		$totales .= ' </tr>';
		$totales .= ' </table>';*/

        $documento .= '<page backimgw="70%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
        $documento .= $logo . $cliente . $deta . $totales;
        //$documento .= $logo ;
        // $documento .= $legend;
        $documento .= '</page>';



        $html2pdf = new HTML2PDF('P', 'A3', 'fr');
        $html2pdf->WriteHTML($documento);
        $ruta = DIR_FACTELEC . 'Include/orden_compra/' . $minv_serial . '.pdf';
        $html2pdf->Output($ruta, 'F');
        $rutaPdf = $ruta;
        return $rutaPdf;


    }

}




function eliminaArchivos($path = '')
{

    //$path = path(DIR_INCLUDE).'archivos/';
    $ficheroseliminados = 0;
    $handle = opendir($path);
    while ($file = readdir($handle)) {

        if (is_file($path . $file)) {
            chmod($path . $file, 0777);
//            if (unlink($path . $file)) {
//                $ficheroseliminados++;
//            }
        }
    }
}

function eliminaArchivo($path = '', $nombArch = '')
{

    //$path = path(DIR_INCLUDE).'archivos/';
    $ficheroseliminados = 0;
    $handle = opendir($path);


    while ($file = readdir($handle)) {
        if (is_file($path . $file)) {
            if ($file == $nombArch) {
                if (unlink($path . $file))
                    $ficheroseliminados++;
            }
        }
    }
    return $ficheroseliminados;
}

function envio_correo_pedido($rutaPdf = '', $clpv_nom_clpv = '', $estado_pedido = '', $correo_tmp = '', $pedido = '', $op = '', $fecha = '')
{
    include_once(path(DIR_INCLUDE) . "class.phpmailer.php");
    include_once(path(DIR_INCLUDE) . "class.smtp.php");
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idSucursal = $_SESSION['U_SUCURSAL'];

    $sqlEmpr = "select empr_nom_empr, empr_dir_empr from saeempr where empr_cod_empr = $idEmpresa";

    if ($oIfxA->Query($sqlEmpr)) {
        $compania = $oIfxA->f("empr_nom_empr");
        $dirMatriz = trim($oIfx->f('empr_dir_empr'));
    }
    $oIfxA->Free();

    //consulta correos y mensaje
    $sql = "select prfa_sub_prfa, prfa_men_prfa from saeprfa where prfa_cod_empr = $idEmpresa and prfa_est_prfa = 'S' and prfa_cod_prfa = 3";
    if ($oIfxA->Query($sql)) {
        $prfa_sub_prfa = $oIfxA->f("prfa_sub_prfa");
        $prfa_men_prfa = $oIfxA->f("prfa_men_prfa");
    }
    $oIfxA->Free();

    $sql = "select smtpserver, smtpport, smtpauth, 
                   smtpuserid, smtppassword, smtptls, 
                   smtpmail from saemailsmtp";

    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $host = $oIfx->f('smtpserver');
            $port = $oIfx->f('smtpport');
            $smtpauth = $oIfx->f('smtpauth');
            $userid = $oIfx->f('smtpuserid');
            $smtpsecure = $oIfx->f('smtptls');
            $mailenvio = $oIfx->f('smtpmail');
            $password = $oIfx->f('smtppassword');
        }
    }
    $oIfx->Free();

    $mail = new PHPMailer();
    $mail->IsSMTP();
    $mail->Mailer = "smtp";

    if ($smtpauth == 'S') {
        $mail->SMTPAuth = true;
    }

    if ($smtpsecure == 'S') {
        $mail->SMTPSecure = "ssl";
    }

    $mail->Host = $host;
    $mail->Username = $userid;
    $mail->Password = $password;
    $mail->From = $mailenvio;

    $mail->FromName = $compania;
    $mail->Subject = $prfa_sub_prfa;
    $mail->AltBody = "Pedido....";
    $mail->IsHTML(true);
    $mail->CharSet = 'UTF-8';

    if ($estado_pedido == 'PA') {
        $estado_pedido = 'REQUIERE AUTORIZACION';
    } elseif ($estado_pedido == 'PE') {
        $estado_pedido = 'PENDIENTE DE FACTURAR';
    }

    if ($op == 1) {
        $msj_tmp = "Le informamos que ha sido generado un nuevo pedido;";
    } elseif ($op == 2) {
        $msj_tmp = "Le informamos que el Pedido $pedido ha sido modificado;";
    }

    $fecha = fecha_mysql_func($fecha);

    $sHtml = "<div style='width: 900px;'>
                        <table style='width:850px;'> 
                            <tr>
                                <td>Estimado,</td>
                            </tr>
                            <tr>
                                <td>$msj_tmp a continuacion adjuntamos el archivo:</td>
                            </tr>
                        </table>
                        <br />
                        <table style='width:850px;'>
                            <tr>
                                <td style='font-weight: bold;'>PEDIDO:</td> <td>$pedido</td>
                            </tr>
                            <tr>
                                <td style='font-weight: bold;'>CLIENTE:</td> <td>$clpv_nom_clpv</td>
                            </tr>
                             <tr>
                                <td style='font-weight: bold;'>FECHA:</td> <td>$fecha</td>
                            </tr>
                            <tr>
                                <td style='font-weight: bold;'>ESTADO:</td> <td>$estado_pedido</td>
                            </tr>
                        </table>  
                        <br>
                        <br><br>
                        <table style='width:850px;'>
                            <tr> 
                                <td>Atentamente,</td>
                            </tr> 
                            <tr>&nbsp;</tr>
                            <tr>&nbsp;</tr>
                            <tr>
                                <td style='font-weight: bold;'>$compania</td>
                            </tr>
                            <tr>&nbsp;</tr>
                            <tr>
                                <td style='font-weight: bold;'>$dirMatriz</td>
                            </tr>
                        </table>
                    </div>";


    $mail->MsgHTML($sHtml);

    //consulta correos
    $sql_correo = "select prfa_mail1, prfa_mail2, prfa_mail3 from saeprfa where prfa_cod_empr = $idEmpresa and prfa_est_prfa = 'S' and prfa_cod_prfa = 3";
    if ($oIfxA->Query($sql_correo)) {
        if ($oIfxA->NumFilas() > 0) {
            do {
                $prfa_mail1 = $oIfxA->f('prfa_mail1');
                $prfa_mail2 = $oIfxA->f('prfa_mail2');
                $prfa_mail3 = $oIfxA->f('prfa_mail3');

                //envia correo
                if (!empty($prfa_mail1))
                    $mail->AddAddress($prfa_mail1, $prfa_mail1);

                if (!empty($prfa_mail2))
                    $mail->AddAddress($prfa_mail2, $prfa_mail2);

                if (!empty($prfa_mail3))
                    $mail->AddAddress($prfa_mail3, $prfa_mail3);
            } while ($oIfxA->SiguienteRegistro());
        }
    }
    $oIfxA->Free();

    //$mail->AddBCC("daniel.castro@sisconti.com.ec", "Info");

    $mail->AddAttachment($rutaPdf, 'Pedido' . $pedido . '.pdf');

    if (!$mail->Send())
        return "Error: " . $mail->ErrorInfo;
    else
        return 'Mail enviado!';
}

function fecha_informix_func($fecha)
{
    $m = substr($fecha, 5, 2);
    $y = substr($fecha, 0, 4);
    $d = substr($fecha, 8, 2);

    return ($y . '-' . $m . '-' . $d);
}

//cacula diferencia de dias entre 2 fechas en formato mysql
function dias_transcurridos($fecha_i, $fecha_f)
{
    $dias = (strtotime($fecha_i) - strtotime($fecha_f)) / 86400;
    $dias = abs($dias);
    $dias = floor($dias);
    return $dias;
}

function reporte_cierre($usuario = '', $fecha = '', $sucursal = '')
{
    //Definiciones
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $oConA = new Dbo;
    $oConA->DSN = $DSN;
    $oConA->Conectar();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();


//      VARIABLES
    $idempresa = $_SESSION['U_EMPRESA'];

    $fecha_ = date("m/d/Y");

    if (empty($fecha)) {
        $fecha_ifx = $fecha_;
    } else {
        $fecha_ifx = fecha_informix($fecha);
    }

    // SUCURSAL POR USUARIO
    $sql = "select u.USUARIO_ID, u.USUA_COD_USUA from comercial.usuario u where
                    u.USUARIO_ID = $usuario and
                    u.EMPRESA_ID = $idempresa ";
    $usuario_informix = consulta_string($sql, 'usua_cod_usua', $oCon, 0);

    // CONTROL DE CIERRE DE CAJA
    $sql = "select count(*) as cont from cierre_caja c where
                    c.empr_cod_empr = $idempresa and
                    c.sucu_cod_sucu = $sucursal and
                    c.usuario_id = $usuario  and
                    c.fecha = '$fecha' and
                    c.estado = 'PE' 
                    -- and c.id_turno_fact = $id_turno ";
    $cont = consulta_string($sql, 'cont', $oCon, 0);

    unset($array_cargos);
    if ($cont > 0) {


        $sql = "SELECT empr_cod_empr, usuario_id, fecha, hora, estado 
                from cierre_caja
                where usuario_id = $usuario and
                fecha = '$fecha'";

        if ($oCon->Query($sql)) {
            if ($oCon->NumFilas() > 0) {
                do {
                    $empr_cod_empr = $oCon->f('empr_cod_empr');
                    $usuario_id = $oCon->f('usuario_id');
                    $fecha_cierre = $oCon->f('fecha');
                    $hora = $oCon->f('hora');
                    $estado = $oCon->f('estado');
                } while ($oCon->SiguienteRegistro());
            }
        }
        $oCon->Free();

        //consulta nombre de la empresa
        $sql = "select empr_nom_empr, empr_dir_empr from saeempr where empr_cod_empr = $empr_cod_empr";
        $empr_nom_empr = consulta_string($sql, 'empr_nom_empr', $oIfx, '');
        $empr_dir_empr = consulta_string($sql, 'empr_dir_empr', $oIfx, '');

        //consulta sucursal
        $sql = "select sucu_nom_sucu from saesucu where sucu_cod_sucu = $sucursal";
        $sucu_nom_sucu = consulta_string($sql, 'sucu_nom_sucu', $oIfx, '');

        //consulta nombre del usuario
        $sql = "select concat(usuario_nombre, ' ', usuario_apellido) as user from usuario where usuario_id = $usuario_id";
        $user = consulta_string($sql, 'user', $oCon, '');

        $sHtml .= '<table align="center">';
        $sHtml .= '<tr>';
        $sHtml .= '<td align="center" style="font-size: 18px; font-weight: bold;" colspan="4">' . $empr_nom_empr . '</td>';
        $sHtml .= '</tr>';
        $sHtml .= '<tr>';
        $sHtml .= '<td align="center" style="font-size: 11px; font-weight: bold;" colspan="4">' . $empr_dir_empr . '</td>';
        $sHtml .= '</tr>';
        $sHtml .= '<tr><td>&nbsp;</td></tr>';
        $sHtml .= '<tr>';
        $sHtml .= '<td align="center" style="font-size: 11px; font-weight: bold;" colspan="4">CIERRE DE CAJA</td>';
        $sHtml .= '</tr>';
        $sHtml .= '<tr>';
        $sHtml .= '<td width="70" align="left" style="font-size: 12px; font-weight: bold;">Usuario:</td>';
        $sHtml .= '<td width="150" style="font-size: 12px; font-weight: bold;">' . $user . '</td>';
        $sHtml .= '<td width="70" align="left" style="font-size: 12px; font-weight: bold;">Fecha:</td>';
        $sHtml .= '<td width="150" style="font-size: 12px; font-weight: bold;">' . $fecha_cierre . ' - ' . $hora . '</td>';
        $sHtml .= '</tr>';
        $sHtml .= '<tr>';
        $sHtml .= '<td width="70" align="left" style="font-size: 12px; font-weight: bold;">Sucursal:</td>';
        $sHtml .= '<td width="150" align="left" style="font-size: 12px; font-weight: bold;">' . $sucu_nom_sucu . '</td>';
        $sHtml .= '<td width="70" align="left" style="font-size: 12px; font-weight: bold;">Estado:</td>';
        $sHtml .= '<td width="150" align="left" style="font-size: 12px; font-weight: bold;">' . $estado . '</td>';
        $sHtml .= '</tr>';
        $sHtml .= '</table>';

        // BILLETES
        $table_bille .= '<table align="center" border="1" style="margin-top: 10px; font-size: 11px;">';
        $table_bille .= '<tr><th class="diagrama" align="center" colspan="5">BILLETES</th> </tr>';
        $table_bille .= '<tr>
                            <th align="center" class="diagrama" width="50">N.-</th>
                            <th align="center" class="diagrama" width="150">CANTIDAD</th>
                            <th align="center" class="diagrama" width="150">$ VALOR </th>
                            <th align="center" class="diagrama" width="150">TOTAL</th>
                            <th align="center" class="diagrama" width="150">ESTADO</th>
                        </tr>';
        $i = 1;
        $sql = "select d.id_det_caja,  d.forma_pago, d.cantidad, d.valor, d.total, d.tipo, c.estado
                                from cierre_caja c , det_cierre_caja d where
                                c.id_cierre_caja = d.id_cierre_caja and
                                c.empr_cod_empr = $idempresa and
                                c.sucu_cod_sucu = $sucursal and
                                c.usuario_id = $usuario and
                                c.fecha = '$fecha' and
                                d.empr_cod_empr = $idempresa and
                                d.sucu_cod_sucu = $sucursal and
                                c.estado = 'PE' and
                                d.forma_pago = 'EFE' and
                                d.tipo = 'B' 
                                -- and c.id_turno_fact = $id_turno ";
        $total_bille = 0;
        if ($oCon->Query($sql)) {
            if ($oCon->NumFilas() > 0) {
                do {
                    $id_det = $oCon->f('id_det_caja');
                    $cantidad = $oCon->f('cantidad');
                    $valor = $oCon->f('valor');
                    $total = $oCon->f('total');
                    $estado = $oCon->f('estado');
                    if ($estado == 'PE') {
                        $estado = 'PENDIENTE';
                    } elseif ($estado == 'TE') {
                        $estado = "TERMINADO";
                    }

                    if ($sClass == 'off')
                        $sClass = 'on';
                    else
                        $sClass = 'off';
                    $table_bille .= '<tr height="20" class="' . $sClass . '"
                                                            onMouseOver="javascript:this.className=\'link\';"
                                                            onMouseOut="javascript:this.className=\'' . $sClass . '\';">';
                    $table_bille .= '<td align="center">' . $i . '</td>';
                    $table_bille .= '<td align="right">' . $cantidad . '</td>';
                    $table_bille .= '<td align="right">' . $valor . '</td>';
                    $table_bille .= '<td align="right">' . $total . '</td>';
                    $table_bille .= '<td align="right">' . $estado . '</td>';
                    $table_bille .= '</tr>';
                    $i++;
                    $total_bille += $total;
                } while ($oCon->SiguienteRegistro());
                // totales cheque
                $table_bille .= '<tr height="20">';
                $table_bille .= '<td align="right"></td>';
                $table_bille .= '<td></td>';
                $table_bille .= '<td class="frm_td">TOTAL:</td>';
                $table_bille .= '<td class="frm_td" align="right">' . $total_bille . '</td>';
                $table_bille .= '<td align="center"></td>';
                $table_bille .= '<td align="center"></td>';
                $table_bille .= '</tr>';
            } else {
                $table_bille = '';
            }
        }
        $table_bille .= '</table>';
        $oCon->Free();


        // MONEDAS
        $table_mone .= '<table align="center" border="1" style="margin-top: 10px; font-size: 11px;">';
        $table_mone .= '<tr><th class="diagrama" align="center" colspan="5">MONEDAS</th> </tr>';
        $table_mone .= '<tr>
                            <th align="center" class="diagrama" width="50">N.-</th>
                            <th align="center" class="diagrama" width="150">CANTIDAD</th>
                            <th align="center" class="diagrama" width="150">$ VALOR </th>
                            <th align="center" class="diagrama" width="150">TOTAL</th>
                            <th align="center" class="diagrama" width="150">ESTADO</th>
                    </tr>';
        $i = 1;
        $sql = "select d.id_det_caja,  d.forma_pago, d.cantidad, d.valor, d.total, d.tipo, c.estado
                                from cierre_caja c , det_cierre_caja d where
                                c.id_cierre_caja = d.id_cierre_caja and
                                c.empr_cod_empr = $idempresa and
                                c.sucu_cod_sucu = $sucursal and
                                c.usuario_id = $usuario and
                                c.fecha = '$fecha' and
                                d.empr_cod_empr = $idempresa and
                                d.sucu_cod_sucu = $sucursal and
                                c.estado = 'PE' and
                                d.forma_pago = 'EFE' and
                                d.tipo = 'M' 
                                -- and c.id_turno_fact = $id_turno ";
        $total_mone = 0;
        if ($oCon->Query($sql)) {
            if ($oCon->NumFilas() > 0) {
                do {
                    $id_det = $oCon->f('id_det_caja');
                    $cantidad = $oCon->f('cantidad');
                    $valor = $oCon->f('valor');
                    $total = $oCon->f('total');
                    $estado = $oCon->f('estado');

                    if ($estado == 'PE') {
                        $estado = 'PENDIENTE';
                    } elseif ($estado == 'TE') {
                        $estado = "TERMINADO";
                    }

                    if ($sClass == 'off')
                        $sClass = 'on';
                    else
                        $sClass = 'off';
                    $table_mone .= '<tr height="20" class="' . $sClass . '"
                                                            onMouseOver="javascript:this.className=\'link\';"
                                                            onMouseOut="javascript:this.className=\'' . $sClass . '\';">';
                    $table_mone .= '<td align="center">' . $i . '</td>';
                    $table_mone .= '<td align="right">' . $cantidad . '</td>';
                    $table_mone .= '<td align="right">' . $valor . '</td>';
                    $table_mone .= '<td align="right">' . $total . '</td>';
                    $table_mone .= '<td align="right">' . $estado . '</td>';
                    $table_mone .= '</tr>';
                    $i++;
                    $total_mone += $total;
                } while ($oCon->SiguienteRegistro());
                // totales cheque
                $table_mone .= '<tr height="20">';
                $table_mone .= '<td align="right"></td>';
                $table_mone .= '<td></td>';
                $table_mone .= '<td class="frm_td">TOTAL:</td>';
                $table_mone .= '<td class="frm_td" align="right">' . $total_mone . '</td>';
                $table_mone .= '<td align="center"></td>';
                $table_mone .= '<td align="center"></td>';
                $table_mone .= '</tr>';
            } else {
                $table_mone = '';
            }
        }
        $table_mone .= '</table>';
        $oCon->Free();


        //CHEQUES
        $table_che .= '<table align="center" border="1" style="margin-top: 10px; font-size: 11px;">';
        $table_che .= '<tr><th class="diagrama" align="center" colspan="6">CHEQUE</th> </tr>';
        $table_che .= '<tr>
                        <th align="center" class="diagrama" width="50">N.-</th>
                        <th align="center" class="diagrama" width="150">TRANSACCION</th>
                        <th align="center" class="diagrama" width="150">CHEQUE</th>
                        <th align="center" class="diagrama" width="150">FACTURA</th>
                        <th align="center" class="diagrama" width="100">VALOR</th>
                        <th class="diagrama" width="50"></th>
                    </tr>';

        $sql = "select f.fact_cod_fact, f.fact_num_preimp, f.fact_nse_fact,
                   fp.fpag_des_fpag, fx.fxfp_val_fxfp, fx.fxfp_num_rete
              from saefact f, saefxfp fx, saefpag fp
              where f.fact_cod_fact = fx.fxfp_cod_fact and
                    fp.fpag_cod_fpag = fx.fxfp_cod_fpag and
                    f.fact_cod_empr = fx.fxfp_cod_empr and
                    f.fact_cod_sucu = fx.fxfp_cod_sucu and
                    f.fact_cod_empr = $idempresa and
                    fx.fxfp_cod_empr = $idempresa and
                    f.fact_cod_sucu = $sucursal and
                    fx.fxfp_cod_sucu = $sucursal and
                    f.fact_fech_fact = '$fecha_ifx' and
                    f.fact_cod_usua = $usuario_informix and
                    f.fact_user_web = $usuario and
                    fp.fpag_cot_fpag like ('CHE%') order by fpag_des_fpag ";
        if ($oIfx->Query($sql)) {
            if ($oIfx->NumFilas() > 0) {
                $l = 1;
                $forma_pago = '';
                $subtotal = 0;
                $total_che = 0;
                do {
                    $fact_mum_preimp = $oIfx->f('fact_num_preimp');
                    $fact_nse_fact = $oIfx->f('fact_nse_fact');
                    $fpag_des_fpag = $oIfx->f('fpag_des_fpag');
                    $fxfp_val_fxfp = $oIfx->f('fxfp_val_fxfp');
                    $fact_cod_fact = $oIfx->f('fact_cod_fact');
                    $fxfp_num_rete = $oIfx->f('fxfp_num_rete');

                    if ($oIfx->f('fpag_des_fpag') == $forma_pago) {
                        $subtotal = round(($subtotal + $oIfx->f('fxfp_val_fxfp')), 2);
                        //$total = $total + $oIfx->f('monto');
                    } else {
                        //$oReturn->alert($subtotal);
                        if ($l >= 2) {
                            $table_che .= '<tr>
                                  <td class="font_face_2" style="color: blue;" align="right" colspan="4">Subtotal ' . $forma_pago . ':</td>';
                            $table_che .= '<td class="font_face_2" style="color: blue;" align="right">' . number_format(round($subtotal, 2), 2) . '</td>
								  </tr>	';
                        }
                        $forma_pago = $oIfx->f('fpag_des_fpag');
                        $total_che = round(($total + $subtotal), 2);
                        $subtotal = round($oIfx->f('fxfp_val_fxfp'), 2);
                    }

                    //consulta estado del check
                    $sql = "select check_sn from det_cierre_caja where fact_cod_fact = $fact_cod_fact and total = '$fxfp_val_fxfp' and forma_pago = '$fpag_des_fpag'";
                    $check_sn = consulta_string($sql, 'check_sn', $oConA, 'N');

                    if ($sClass == 'off')
                        $sClass = 'on';
                    else
                        $sClass = 'off';

                    $table_che .= '<tr height="20" class="' . $sClass . '"
                                        onMouseOver="javascript:this.className=\'link\';"
                                        onMouseOut="javascript:this.className=\'' . $sClass . '\';">';
                    $table_che .= '<td align="center">' . $l . '</td>';
                    $table_che .= '<td align="left">' . $fpag_des_fpag . '</td>';
                    $table_che .= '<td align="left">' . $fxfp_num_rete . '</td>';
                    $table_che .= '<td align="left" style="cursor: pointer;" onclick="factura(' . $fact_cod_fact . ', ' . $sucursal . ')">' . $fact_nse_fact . '-' . $fact_mum_preimp . '</td>';
                    $table_che .= '<td align="right">' . $fxfp_val_fxfp . '</td>';
                    $table_che .= '<td align="center">' . $check_sn . '</td>';
                    $table_che .= '</tr>';
                    $l++;
                } while ($oIfx->SiguienteRegistro());
                $table_che .= '<tr>
                        <td class="font_face_2" style="color: blue;" align="right" colspan="4">Subtotal ' . $forma_pago . ':</td>
                           <td class="font_face_2" style="color: blue;" align="right">' . number_format(round($subtotal, 2), 2) . '</td>
                        </tr>';

                $total_che = $total_che + $subtotal;
            } else {
                $table_che .= '<tr>
                            <td colspan="5">Sin Registros generados...</td>
                        </tr>';
            }
        }
        $oIfx->Free();
        $table_che .= '</table>';


        // TARJETA DE CREDITO
        $table_tar .= '<table align="center" border="1" style="margin-top: 10px; font-size: 11px;">';
        $table_tar .= '<tr><th class="diagrama" align="center" colspan="6">TARJETA</th> </tr>';
        $table_tar .= '<tr>
                        <th align="center" class="diagrama" width="50">N.-</th>
                        <th align="center" class="diagrama" width="150">TRANSACCION</th>
                        <th align="center" class="diagrama" width="150">VOUCHER</th>
                        <th align="center" class="diagrama" width="150">FACTURA</th>
                        <th align="center" class="diagrama" width="100">VALOR</th>
                        <th class="diagrama" width="50"></th>
                  </tr>';


        $sql = "select f.fact_cod_fact, f.fact_num_preimp, f.fact_nse_fact,
                   fp.fpag_des_fpag, fx.fxfp_val_fxfp, fx.fxfp_num_rete
              from saefact f, saefxfp fx, saefpag fp
              where f.fact_cod_fact = fx.fxfp_cod_fact and
                    fp.fpag_cod_fpag = fx.fxfp_cod_fpag and
                    f.fact_cod_empr = fx.fxfp_cod_empr and
                    f.fact_cod_sucu = fx.fxfp_cod_sucu and
                    f.fact_cod_empr = $idempresa and
                    fx.fxfp_cod_empr = $idempresa and
                    f.fact_cod_sucu = $sucursal and
                    fx.fxfp_cod_sucu = $sucursal and
                    f.fact_fech_fact = '$fecha_ifx' and
                    f.fact_cod_usua = $usuario_informix and
                    f.fact_user_web = $usuario and
                    fp.fpag_cot_fpag like ('TAR%') order by fpag_des_fpag ";
        if ($oIfx->Query($sql)) {
            if ($oIfx->NumFilas() > 0) {
                $k = 1;
                $forma_pago = '';
                $subtotal = 0;
                $total_tar = 0;
                do {
                    $fact_mum_preimp = $oIfx->f('fact_num_preimp');
                    $fact_nse_fact = $oIfx->f('fact_nse_fact');
                    $fpag_des_fpag = $oIfx->f('fpag_des_fpag');
                    $fxfp_val_fxfp = $oIfx->f('fxfp_val_fxfp');
                    $fact_cod_fact = $oIfx->f('fact_cod_fact');
                    $fxfp_num_rete = $oIfx->f('fxfp_num_rete');

                    if ($oIfx->f('fpag_des_fpag') == $forma_pago) {
                        $subtotal = round(($subtotal + $oIfx->f('fxfp_val_fxfp')), 2);
                        //$total = $total + $oIfx->f('monto');
                    } else {
                        //$oReturn->alert($subtotal);
                        if ($k >= 2) {
                            $table_tar .= '<tr>
                                  <td class="font_face_2" style="color: blue;" align="right" colspan="4">Subtotal ' . $forma_pago . ':</td>';
                            $table_tar .= '<td class="font_face_2" style="color: blue;" align="right">' . number_format(round($subtotal, 2), 2) . '</td>
								  </tr>	';
                        }
                        $forma_pago = $oIfx->f('fpag_des_fpag');
                        $total_tar = round(($total + $subtotal), 2);
                        $subtotal = round($oIfx->f('fxfp_val_fxfp'), 2);
                    }

                    //consulta estado del check
                    $sql = "select check_sn from det_cierre_caja where fact_cod_fact = $fact_cod_fact and total = '$fxfp_val_fxfp' and forma_pago = '$fpag_des_fpag'";
                    $check_sn = consulta_string($sql, 'check_sn', $oConA, 'N');

                    if ($sClass == 'off')
                        $sClass = 'on';
                    else
                        $sClass = 'off';

                    $table_tar .= '<tr height="20" class="' . $sClass . '"
                                        onMouseOver="javascript:this.className=\'link\';"
                                        onMouseOut="javascript:this.className=\'' . $sClass . '\';">';
                    $table_tar .= '<td align="center">' . $k . '</td>';
                    $table_tar .= '<td align="left">' . $fpag_des_fpag . '</td>';
                    $table_tar .= '<td align="left">' . $fxfp_num_rete . '</td>';
                    $table_tar .= '<td align="left" style="cursor: pointer;" onclick="factura(' . $fact_cod_fact . ', ' . $sucursal . ')">' . $fact_nse_fact . '-' . $fact_mum_preimp . '</td>';
                    $table_tar .= '<td align="right">' . $fxfp_val_fxfp . '</td>';
                    $table_tar .= '<td align="center">' . $check_sn . '</td>';
                    $table_tar .= '</tr>';
                    $k++;
                } while ($oIfx->SiguienteRegistro());
                $table_tar .= '<tr>
                        <td class="font_face_2" style="color: blue;" align="right" colspan="4">Subtotal ' . $forma_pago . ':</td>
                           <td class="font_face_2" style="color: blue;" align="right">' . number_format(round($subtotal, 2), 2) . '</td>
                        </tr>';

                $total_tar = $total_tar + $subtotal;
            } else {
                $table_tar .= '<tr>
                            <td colspan="5">Sin Registros generados...</td>
                        </tr>';
            }
        }
        $oIfx->Free();
        $table_tar .= '</table>';
        $oCon->Free();


        //consulta credito
        $table_cre .= '<table align="center" border="1" style="margin-top: 10px; font-size: 11px;">';
        $table_cre .= '<tr><th class="diagrama" align="center" colspan="5">CREDITO</th> </tr>';
        $table_cre .= '<tr>
                        <th align="center" class="diagrama" width="50">N.-</th>
                        <th align="center" class="diagrama" width="150">TRANSACCION</th>
                        <th align="center" class="diagrama" width="150">FACTURA</th>
                        <th align="center" class="diagrama" width="150">VALOR</th>
                        <th class="diagrama" width="150"></th>
                  </tr>';


        $sql = "select f.fact_cod_fact, f.fact_num_preimp, f.fact_nse_fact,
                   fp.fpag_des_fpag, fx.fxfp_val_fxfp
              from saefact f, saefxfp fx, saefpag fp
              where f.fact_cod_fact = fx.fxfp_cod_fact and
                    fp.fpag_cod_fpag = fx.fxfp_cod_fpag and
                    f.fact_cod_empr = fx.fxfp_cod_empr and
                    f.fact_cod_sucu = fx.fxfp_cod_sucu and
                    f.fact_cod_empr = $idempresa and
                    fx.fxfp_cod_empr = $idempresa and
                    f.fact_cod_sucu = $sucursal and
                    fx.fxfp_cod_sucu = $sucursal and
                    f.fact_fech_fact = '$fecha_ifx' and
                    f.fact_cod_usua = $usuario_informix and
                    f.fact_user_web = $usuario and
                    fp.fpag_cot_fpag like ('CRE%') order by fpag_des_fpag";
        if ($oIfx->Query($sql)) {
            if ($oIfx->NumFilas() > 0) {
                $k = 1;
                $total_cre = 0;
                do {
                    $fact_mum_preimp = $oIfx->f('fact_num_preimp');
                    $fact_nse_fact = $oIfx->f('fact_nse_fact');
                    $fpag_des_fpag = $oIfx->f('fpag_des_fpag');
                    $fxfp_val_fxfp = $oIfx->f('fxfp_val_fxfp');
                    $fact_cod_fact = $oIfx->f('fact_cod_fact');

                    //consulta estado del check
                    $sql = "select check_sn from det_cierre_caja where fact_cod_fact = $fact_cod_fact and total = '$fxfp_val_fxfp' and forma_pago = '$fpag_des_fpag'";
                    $check_sn = consulta_string($sql, 'check_sn', $oConA, 'N');

                    if ($sClass == 'off')
                        $sClass = 'on';
                    else
                        $sClass = 'off';

                    $table_cre .= '<tr height="20" class="' . $sClass . '"
                                        onMouseOver="javascript:this.className=\'link\';"
                                        onMouseOut="javascript:this.className=\'' . $sClass . '\';">';
                    $table_cre .= '<td align="center">' . $k . '</td>';
                    $table_cre .= '<td align="left">' . $fpag_des_fpag . '</td>';
                    $table_cre .= '<td align="left" style="cursor: pointer;" onclick="factura(' . $fact_cod_fact . ', ' . $sucursal . ')">' . $fact_nse_fact . '-' . $fact_mum_preimp . '</td>';
                    $table_cre .= '<td align="right">' . $fxfp_val_fxfp . '</td>';
                    $table_cre .= '<td align="center">' . $check_sn . '</td>';
                    $table_cre .= '</tr>';
                    $k++;

                    $total_cre = $total_cre + $fxfp_val_fxfp;
                } while ($oIfx->SiguienteRegistro());
            } else {
                $table_cre .= '<tr>
                            <td colspan="5">Sin Registros generados...</td>
                        </tr>';
            }
        }
        $oIfx->Free();
        $table_cre .= '</table>';


        //consulta retenciones
        $table_ret .= '<table align="center" border="1" style="margin-top: 10px; font-size: 11px;">';
        $table_ret .= '<tr><th class="diagrama" align="center" colspan="5">RETENCIONES</th> </tr>';
        $table_ret .= '<tr>
                        <th align="center" class="diagrama" width="50">N.-</th>
                        <th align="center" class="diagrama" width="150">TRANSACCION</th>
                        <th align="center" class="diagrama" width="150">FACTURA</th>
                        <th align="center" class="diagrama" width="150">VALOR</th>
                        <th class="diagrama" width="150"></th>
                  </tr>';


        $sql = "select f.fact_cod_fact, f.fact_num_preimp, f.fact_nse_fact,
                   fp.fpag_des_fpag, fx.fxfp_val_fxfp
              from saefact f, saefxfp fx, saefpag fp
              where f.fact_cod_fact = fx.fxfp_cod_fact and
                    fp.fpag_cod_fpag = fx.fxfp_cod_fpag and
                    f.fact_cod_empr = fx.fxfp_cod_empr and
                    f.fact_cod_sucu = fx.fxfp_cod_sucu and
                    f.fact_cod_empr = $idempresa and
                    fx.fxfp_cod_empr = $idempresa and
                    f.fact_cod_sucu = $sucursal and
                    fx.fxfp_cod_sucu = $sucursal and
                    f.fact_fech_fact = '$fecha_ifx' and
                    f.fact_cod_usua = $usuario_informix and
                    f.fact_user_web = $usuario and
                    fp.fpag_cot_fpag like ('RET%') order by fpag_des_fpag";
        //$oReturn->alert($sql);
        if ($oIfx->Query($sql)) {
            if ($oIfx->NumFilas() > 0) {
                $l = 1;
                do {
                    $fact_mum_preimp = $oIfx->f('fact_num_preimp');
                    $fact_nse_fact = $oIfx->f('fact_nse_fact');
                    $fpag_des_fpag = $oIfx->f('fpag_des_fpag');
                    $fxfp_val_fxfp = $oIfx->f('fxfp_val_fxfp');
                    $fact_cod_fact = $oIfx->f('fact_cod_fact');

                    //consulta estado del check
                    $sql = "select check_sn from det_cierre_caja where fact_cod_fact = $fact_cod_fact and total = '$fxfp_val_fxfp' and forma_pago = '$fpag_des_fpag'";
                    $check_sn = consulta_string($sql, 'check_sn', $oConA, 'N');


                    if ($sClass == 'off')
                        $sClass = 'on';
                    else
                        $sClass = 'off';

                    $table_ret .= '<tr height="20" class="' . $sClass . '"
                                        onMouseOver="javascript:this.className=\'link\';"
                                        onMouseOut="javascript:this.className=\'' . $sClass . '\';">';
                    $table_ret .= '<td align="center">' . $l . '</td>';
                    $table_ret .= '<td align="left">' . $fpag_des_fpag . '</td>';
                    $table_ret .= '<td align="left" style="cursor: pointer;" onclick="factura(' . $fact_cod_fact . ', ' . $sucursal . ')">' . $fact_nse_fact . '-' . $fact_mum_preimp . '</td>';
                    $table_ret .= '<td align="right">' . $fxfp_val_fxfp . '</td>';
                    $table_ret .= '<td align="center">' . $check_sn . '</td>';
                    $table_ret .= '</tr>';
                    $l++;
                } while ($oIfx->SiguienteRegistro());
            } else {
                $table_ret .= '<tr>
                           <td colspan="5">Sin Registros generados...</td>
                        </tr>';
            }
        }
        $oIfx->Free();
        $table_ret .= '</table>';

        // TOTAL DE VENTAS
        $fecha_ifx = fecha_informix($fecha);

        $sql = "select sum( COALESCE(  f.fact_iva, 0)  -  COALESCE( f.fact_dsg_valo , 0 )  + COALESCE( f.fact_fle_fact , 0 )  +  COALESCE( f.fact_otr_fact , 0 )  +  COALESCE( f.fact_fin_fact , 0 ) + COALESCE( f.fact_tot_fact , 0 )   + COALESCE( f.fact_ice_fact , 0 ) ) as total
                                from saefact f where
                                f.fact_cod_empr = $idempresa and
                                f.fact_cod_sucu = $sucursal and
                                f.fact_est_fact <>  'AN' and
                                f.fact_user_web = $usuario and
                                f.fact_fech_fact =  '$fecha_ifx'   ";
        $total_ventas = consulta_string($sql, 'total', $oIfx, 0);

        $table_total .= '<table align="center" style="margin-top: 10px; margin-left: 90px; font-size: 11px;">';
        $table_total .= '<tr><th class="diagrama" align="center" colspan="6">TOTALES</th> </tr>';

        // EFECTIVO
        $table_total .= '<tr height="20">';
        $table_total .= '<td colspan="6"></td>';
        $table_total .= '<td align="left" width="200"  class="font_face_2" style="font-size: 11px; color: red;">EFECTIVO:</td>';
        $table_total .= '<td align="right" class="font_face_2" style="font-size: 11px; color: red;">$&nbsp;' . number_format($total_bille + $total_mone, 2, '.', ',') . '</td>';
        $table_total .= '</tr>';

        // CHEQUE
        $table_total .= '<tr height="20">';
        $table_total .= '<td colspan="6"></td>';
        $table_total .= '<td align="left" width="200"  class="font_face_2" style="font-size: 11px; color: red;">CHEQUE:</td>';
        $table_total .= '<td align="right" class="font_face_2" style="font-size: 11px; color: red;">$&nbsp;' . number_format($total_che, 2, '.', ',') . '</td>';
        $table_total .= '</tr>';

        // TARJETAS
        $table_total .= '<tr height="20">';
        $table_total .= '<td colspan="6"></td>';
        $table_total .= '<td align="left" width="200"  class="font_face_2" style="font-size: 11px; color: red;">TARJETA CRE.:</td>';
        $table_total .= '<td align="right" class="font_face_2" style="font-size: 11px; color: red;">$&nbsp;' . number_format($total_tar, 2, '.', ',') . '</td>';
        $table_total .= '</tr>';

        // CREDITO
        $table_total .= '<tr height="20">';
        $table_total .= '<td colspan="6"></td>';
        $table_total .= '<td align="left" width="200" class="font_face_2" style="font-size: 11px; color: red;">CREDITO:</td>';
        $table_total .= '<td align="right" class="font_face_2" style="font-size: 11px; color: red;">$&nbsp;' . number_format($total_cre, 2, '.', ',') . '</td>';
        $table_total .= '</tr>';

        $table_total .= '<tr height="20">';
        $table_total .= '<td colspan="6"></td>';
        $table_total .= '<td align="left" width="200"  class="font_face_2" style="font-size: 11px; color: red;">GASTO:</td>';
        $table_total .= '<td align="right" class="font_face_2" style="font-size: 11px; color: red;">$&nbsp;' . number_format($val_gasto, 2, '.', ',') . '</td>';
        $table_total .= '</tr>';

        // TOTAL CIERRE CAJA
        $total_cierre = ($total_bille + $total_mone + $total_che + $total_tar + $total_cre);
        $table_total .= '<tr height="20">';
        $table_total .= '<td colspan="6"></td>';
        $table_total .= '<td align="left" width="200"  class="font_face_2" style="font-size: 12px; color: red;">TOTAL CIERRE CAJA:</td>';
        $table_total .= '<td align="right" class="font_face_2" style="font-size: 12px; color: red; border-bottom: 2px solid #000">$&nbsp;' . number_format($total_cierre, 2, '.', ',') . '</td>';
        $table_total .= '</tr>';

        // TOTAL DE COBROS
        $sql = "select  sum (fp.fxfp_val_fxfp ) as pxfp_val_pxfp
                                from saefxfp fp, saefact f where
                                f.fact_cod_fact = fp.fxfp_cod_fact and
                                fp.fxfp_cod_empr = $idempresa and
                                fp.fxfp_cod_sucu = $sucursal and
                                f.fact_cod_empr = $idempresa and
                                f.fact_cod_sucu = $sucursal and
                                f.fact_est_fact <> 'AN' and
                                f.fact_fech_fact= '$fecha_ifx'  and
                                f.fact_user_web = $usuario";
        $total_cobro = consulta_string($sql, 'pxfp_val_pxfp', $oIfx, 0);

        // VENTAS
        $table_total .= '<tr height="20">';
        $table_total .= '<td colspan="6"></td>';
        $table_total .= '<td align="left" width="200" class="font_face_2" style="font-size: 12px; color: red;">TOTAL VENTAS:</td>';
        $table_total .= '<td align="right" class="font_face_2" style="font-size: 12px; color: red;">$&nbsp;' . number_format($total_ventas, 2, '.', ',') . '</td>';
        $table_total .= '</tr>';

        // COBRO
        $table_total .= '<tr height="20">';
        $table_total .= '<td colspan="6"></td>';
        $table_total .= '<td align="left" width="200" class="font_face_2" style="font-size: 12px; color: red;">TOTAL COBRO:</td>';
        $table_total .= '<td align="right" class="font_face_2" style="font-size: 12px; color: red; border-bottom: 2px solid #000;">$&nbsp;' . number_format($total_cobro, 2, '.', ',') . '</td>';
        $table_total .= '</tr>';

        // DIFERENCIAS
        $total_dife = ($total_bille + $total_mone + $total_che + $total_tar + $total_cre - $total_ventas + $val_gasto);
        $table_total .= '<tr height="20">';
        $table_total .= '<td colspan="6"></td>';
        $table_total .= '<td align="left" width="200" class="font_face_2" style="font-size: 12px; color: red;">DIFERENCIAS:</td>';
        $table_total .= '<td align="right" class="font_face_2" style="font-size: 12px; color: red;">$&nbsp;' . number_format($total_dife, 2, '.', ',') . '</td>';
        $table_total .= '</tr>';

        //COSTO INVENTARIO
        $sql = "select sum(precio_total) as precio_total from comercial.conteo_fisico where empr_cod_empr = $idempresa and
                                                                                  sucu_cod_sucu = $sucursal and
                                                                                  fecha = '$fecha'";
        $precio_total = consulta_string($sql, 'precio_total', $oConA, '');

        $table_total .= '</table>';
    } elseif ($cont <= 0) {
        $table_op = '<span>No tiene Cierres de Caja....<span>';
    }


    //$documento .= '<page>';
    $documento .= $sHtml . $table_bille . $table_mone . $table_che . $table_tar . $table_cre . $table_ret . $table_total;
    //$documento .= '</page>';

    $html2pdf = new HTML2PDF('P', 'A4', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $usuario_informix . '.pdf';
    $html2pdf->Output($ruta, 'F');

    return $documento;
}

function fecha_mysql_func_dmY($fecha)
{
    $fecha_array = explode('/', $fecha);
    $m = $fecha_array[0];
    $y = $fecha_array[2];
    $d = $fecha_array[1];

    return ($d . '/' . $m . '/' . $y);
}

//devuelve nombre de bodega

function compararFechasIva($primera, $segunda)
{
    $valoresPrimera = explode("-", $primera);
    $valoresSegunda = explode("-", $segunda);

    $diaPrimera = $valoresPrimera[2];
    $mesPrimera = $valoresPrimera[1];
    $anyoPrimera = $valoresPrimera[0];

    $diaSegunda = $valoresSegunda[2];
    $mesSegunda = $valoresSegunda[1];
    $anyoSegunda = $valoresSegunda[0];

    $diasPrimeraJuliano = gregoriantojd($mesPrimera, $diaPrimera, $anyoPrimera);
    $diasSegundaJuliano = gregoriantojd($mesSegunda, $diaSegunda, $anyoSegunda);

    if (!checkdate($mesPrimera, $diaPrimera, $anyoPrimera)) {
        // "La fecha ".$primera." no es v&aacute;lida";
        return 0;
    } elseif (!checkdate($mesSegunda, $diaSegunda, $anyoSegunda)) {
        // "La fecha ".$segunda." no es v&aacute;lida";
        return 0;
    } else {
        return $diasPrimeraJuliano - $diasSegundaJuliano;
    }
}

function fecha_mysql_dmy($fecha)
{
    $fecha_array = explode('-', $fecha);
    $y = $fecha_array[0];
    $m = $fecha_array[1];
    $d = $fecha_array[2];

    return ($d . '/' . $m . '/' . $y);
}

function vacios($valor, $cambio)
{
    $resp = 0;
    if (empty($valor)) {
        $resp = $cambio;
    } else {
        $resp = $valor;
    }
    return $resp;
}

// estado del balance score card
function estado_score($oCon, $meta, $real)
{
    $porcentaje = 0;
    if ($meta != 0) {
        $porcentaje = (100 * $real) / $meta;
        $sql_estado = "select *from estado_score";
        if ($oCon->Query($sql_estado)) {
            do {
                $valor_minimo = $oCon->f('valor_minimo');
                $valor_maximo = $oCon->f('valor_maximo');
                if ($porcentaje >= $valor_minimo && $porcentaje <= $valor_maximo) {
                    $estado = $oCon->f('path');
                }
            } while ($oCon->SiguienteRegistro());
        }
        $oCon->Free();
    } else {
        $estado = 'null';
    }

    return $estado;
}


// ARRAY NORMAL IFX O OCON
function array_dato($Conexion, $sql, $campo1, $campo2)
{
    unset($array);
    if ($Conexion->Query($sql)) {
        if ($Conexion->NumFilas() > 0) {
            do {
                $array [$Conexion->f($campo1)] = $Conexion->f($campo2);
            } while ($Conexion->SiguienteRegistro());
        }
    }
    $Conexion->Free();
    return $array;
}


function fecha_mysql_funcYmd($fecha)
{
    $fecha_array = explode('/', $fecha);
    $m = $fecha_array[0];
    $y = $fecha_array[2];
    $d = $fecha_array[1];

    return ($y . '/' . $m . '/' . $d);
}

// resta fechas dd--mm-YY
function restaFechas_func($dFecIni, $dFecFin)
{
    $dFecIni = str_replace("-", "", $dFecIni);
    $dFecIni = str_replace("/", "", $dFecIni);
    $dFecFin = str_replace("-", "", $dFecFin);
    $dFecFin = str_replace("/", "", $dFecFin);

    preg_match("([0-9]{1,2})([0-9]{1,2})([0-9]{2,4})", $dFecIni, $aFecIni);

    preg_match("([0-9]{1,2})([0-9]{1,2})([0-9]{2,4})", $dFecFin, $aFecFin);

    $date1 = mktime(0, 0, 0, $aFecIni[2], $aFecIni[1], $aFecIni[3]);
    $date2 = mktime(0, 0, 0, $aFecFin[2], $aFecFin[1], $aFecFin[3]);

    return round(($date2 - $date1) / (60 * 60 * 24));
}

function Mes_func($mes)
{

    switch ($mes) {
        case 1:
            $nombre_mes = "Enero";
            break;
        case 2:
            $nombre_mes = "Febrero";
            break;
        case 3:
            $nombre_mes = "Marzo";
            break;
        case 4:
            $nombre_mes = "Abril";
            break;
        case 5:
            $nombre_mes = "Mayo";
            break;
        case 6:
            $nombre_mes = "Junio";
            break;
        case 7:
            $nombre_mes = "Julio";
            break;
        case 8:
            $nombre_mes = "Agosto";
            break;
        case 9:
            $nombre_mes = "Septiembre";
            break;
        case 10:
            $nombre_mes = "Octubre";
            break;
        case 11:
            $nombre_mes = "Noviembre";
            break;
        case 12:
            $nombre_mes = "Diciembre";
            break;
    }

    return $nombre_mes;
}


function envio_correo_adj_orgfashion($correo = '', $ride = '', $pdf = '', $nom_clpv = '', $clave = '', $serial = '', $clpv = 0, $idTipo = 0) {
    //include_once(path(DIR_INCLUDE) . "class.phpmailer.php");
    //include_once(path(DIR_INCLUDE) . "class.smtp.php");
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    //variables de session
    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idSucursal = $_SESSION['U_SUCURSAL'];

    //tipo documento
    $sqlDocu = "select documento from comercial.doc_time where id_time = $idTipo";
    $docu = consulta_string_func($sqlDocu, 'documento', $oCon, '');

    $sqlEmpr = "select empr_nom_empr, empr_dir_empr, empr_tel_resp from saeempr where empr_cod_empr = $idEmpresa";
    if ($oIfx->Query($sqlEmpr)) {
        $compania = $oIfx->f("empr_nom_empr");
        $dirMatriz = $oIfx->f('empr_dir_empr');
        $empr_tel_resp = $oIfx->f("empr_tel_resp");
    }
    $oIfx->Free();

    //consulta correos y mensaje
    $sql = "select prfa_sub_prfa, prfa_men_prfa from saeprfa where prfa_cod_empr = $idEmpresa and prfa_est_prfa = 'S' and prfa_cod_prfa = 5";
    if ($oIfx->Query($sql)) {
        $prfa_sub_prfa = $oIfx->f("prfa_sub_prfa");
        $prfa_men_prfa = $oIfx->f("prfa_men_prfa");
    }
    $oIfx->Free();

    $sqlSmtp = "select server, port, auth, 
			user, pass, ssltls, 
			mail 
			from comercial.config_email
			where id_empresa = $idEmpresa and
			id_tipo = $idTipo";
    if ($oCon->Query($sqlSmtp)) {
        if ($oCon->NumFilas() > 0) {
            $host = $oCon->f('server');
            $port = $oCon->f('port');
            $smtpauth = $oCon->f('auth');
            $userid = $oCon->f('user');
            $smtpsecure = $oCon->f('ssltls');
            $mailenvio = $oCon->f('mail');
            $password = $oCon->f('pass');
        }
    }
    $oCon->Free();

    /*
    $mail = new PHPMailer();
    $mail->IsSMTP();
    $mail->Mailer = "smtp";
    if ($smtpauth == 'S') {
        $mail->SMTPAuth = true;
    }
    */

    if ($smtpsecure == 'S') {
        //$mail->SMTPSecure = "tls";
        $secure_type="tls";
    }else{
        $secure_type="ssl";
    }

    /*
    $mail->Host = $host;
    $mail->Port = $port;
    $mail->Username = $userid;
    $mail->Password = $password;
    $mail->From = $mailenvio;

    $mail->FromName = $compania;
    $mail->Subject = $prfa_sub_prfa . ' ' . $docu . ' No.' . $serial;
    $mail->AltBody = "Factura....";
    $mail->IsHTML(true);
    $mail->CharSet = 'UTF-8';
    */

    $sHtml = "<div style='width: 900px;'>
				<table style='width:850px;'> 
					<tr>
						<td>Estimado cliente, <span style='font-weight: bold'>$nom_clpv</span> </td>
					</tr>
					<tr>
						<td>Le informamos que ha sido generado el siguiente documento electronico, a continuacion adjuntamos el archivo:</td>
					</tr>
				</table>
				<br />
				<table style='width:850px;'>
					<tr>
						<td style='font-weight: bold;'>$docu No.</td> <td>$serial</td>
					</tr>
					<tr>
						<td style='font-weight: bold;'>CLAVE</td> <td>$clave</td>
					</tr>
					<tr>
						<td style='font-weight: bold;'>AUTORIZACION</td> <td>$clave</td>
					</tr>
				</table>  
				<br><br>
				<table style='width:850px;'>
					<tr> 
						<td>Atentamente,</td>
					</tr> 
					<tr>&nbsp;</tr>
					<tr>&nbsp;</tr>
					<tr>
						<td style='font-weight: bold; font-size: 13px;'>$compania</td>
					</tr>
					<tr>&nbsp;</tr>
					<tr>
						<td style='font-weight: bold;'>Dire.: $dirMatriz</td>
					</tr>
					<tr>
						<td style='font-weight: bold;'>Telf.: $empr_tel_resp</td>
					</tr>
					 <tr>&nbsp;</tr>
				</table>
			</div>";

    //$mail->MsgHTML($sHtml);

    //$correoArray = explode(";", $correo);

    /*
    if (count($correoArray) > 0) {
        for ($j = 0; $j < count($correoArray); $j++) {
            $correoTmp = trim($correoArray[$j]);

            if (verificaremail($correoTmp)) {
                $mail->AddAddress($correoTmp, $correoTmp);
            }
        }
    } else {
        if (verificaremail($correo)) {
            $mail->AddAddress($correo, $correo);
        }
    }*/

    //consulta correos
    $sql_correo = "select prfa_mail1, prfa_mail2, prfa_mail3 from saeprfa where prfa_cod_empr = $idEmpresa and prfa_est_prfa = 'S' and prfa_cod_prfa = 5";
    if ($oIfx->Query($sql_correo)) {
        if ($oIfx->NumFilas() > 0) {
            $prfa_mail1 = $oIfx->f('prfa_mail1');
            $prfa_mail2 = $oIfx->f('prfa_mail2');
            $prfa_mail3 = $oIfx->f('prfa_mail3');
            /*
            //envia correo
            if (!empty($prfa_mail1))
                $mail->AddBCC($prfa_mail1, $prfa_mail1);

            if (!empty($prfa_mail2))
                $mail->AddBCC($prfa_mail2, $prfa_mail2);

            if (!empty($prfa_mail3))
                $mail->AddBCC($prfa_mail3, $prfa_mail3);
            */
        }
    }
    $oIfx->Free();

    ////$mail->AddBCC('d-aniel300_89@hotmail.com', '');

    //$rutaRide = array(split("/", $ride));
    //$nombDocu = $rutaRide[count($rutaRide)];


    $archivo_ride = file_get_contents($pdf);
    $archivo_ride = base64_encode($archivo_ride);

    $archivo_xml = file_get_contents($ride);
    $archivo_xml = base64_encode($archivo_xml);

    $headers = array(
        "Content-Type:application/json",
        "Token-Api:c70c4f84-45a8-4d4f-8ad9-938127fe4d8d"
    );
    $data = array(
        "host" => $host,
        "port" => $port,
        "secure_type" => $secure_type,
        "from_address" => $mailenvio,
        "to_address" =>  $correo, //$correoArray,
        "subject" => $prfa_sub_prfa . ' ' . $docu . ' No.' . $serial,
        "username" => $userid,
        "password" => $password,
        "body" => $sHtml,
        "archivo_ride" => $archivo_ride,
        "archivo_xml" => $archivo_xml,
        "guia_pdf" => ""
    );

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_URL, URL_JIREH_WS."/api/correo/enviar");
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $respuesta = curl_exec($ch);
    $resultado = json_decode($respuesta,true);
    $enviado = $resultado["enviado"];

    if($enviado == true){
        return "Mail Enviado!";
    }else{
        return "Error al enviar email";
    }

    /*
    if (!$mail->Send())
        return "Error: " . $mail->ErrorInfo . $sqlSmtp;
    else
        return 'Mail enviado!';
    */
}


/*function envio_correo_adj($correo = '', $ride = '', $pdf = '', $nom_clpv = '', $clave = '', $serial = '', $clpv = 0, $idTipo = 0) {
    include_once(path(DIR_INCLUDE) . "class.phpmailer.php");
    include_once(path(DIR_INCLUDE) . "class.smtp.php");
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    //variables de session
    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idSucursal = $_SESSION['U_SUCURSAL'];

    //tipo documento
    $sqlDocu = "select documento from comercial.doc_time where id_time = $idTipo";
    $docu = consulta_string_func($sqlDocu, 'documento', $oCon, '');

    $sqlEmpr = "select empr_nom_empr, empr_dir_empr, empr_tel_resp from saeempr where empr_cod_empr = $idEmpresa";
    if ($oIfx->Query($sqlEmpr)) {
        $compania = $oIfx->f("empr_nom_empr");
        $dirMatriz = $oIfx->f('empr_dir_empr');
        $empr_tel_resp = $oIfx->f("empr_tel_resp");
    }
    $oIfx->Free();

    //consulta correos y mensaje
    $sql = "select prfa_sub_prfa, prfa_men_prfa from saeprfa where prfa_cod_empr = $idEmpresa and prfa_est_prfa = 'S' and prfa_cod_prfa = 5";
    if ($oIfx->Query($sql)) {
        $prfa_sub_prfa = $oIfx->f("prfa_sub_prfa");
        $prfa_men_prfa = $oIfx->f("prfa_men_prfa");
    }
    $oIfx->Free();

    $sqlSmtp = "select server, port, auth,
			\"user\", pass, ssltls,
			mail
			from comercial.config_email
			where id_empresa = $idEmpresa and
			id_tipo = $idTipo";
    if ($oCon->Query($sqlSmtp)) {
        if ($oCon->NumFilas() > 0) {
            $host = $oCon->f('server');
            $port = $oCon->f('port');
            $smtpauth = $oCon->f('auth');
            $userid = $oCon->f('user');
            $smtpsecure = $oCon->f('ssltls');
            $mailenvio = $oCon->f('mail');
            $password = $oCon->f('pass');
        }
    }
    $oCon->Free();

    $mail = new PHPMailer();
    $mail->IsSMTP();
    $mail->Mailer = "smtp";

    if($smtpauth == 'S') {
        $mail->SMTPAuth = true;
    }

    $mail->SMTPSecure = $smtpsecure;


    $mail->Host = $host;
    $mail->Port = $port;
    $mail->Username = $userid;
    $mail->Password = $password; //"uedjsdyglupogtma";
    $mail->From = $mailenvio;

    $mail->FromName = $compania;
    $mail->Subject = $prfa_sub_prfa . ' ' . $docu . ' No.' . $serial;
    $mail->AltBody = "Factura....";
    $mail->IsHTML(true);
    $mail->CharSet = 'UTF-8';

    $sHtml = "<div style='width: 900px;'>
				<table style='width:850px;'>
					<tr>
						<td>Estimado cliente, <span style='font-weight: bold'>$nom_clpv</span> </td>
					</tr>
					<tr>
						<td>Le informamos que ha sido generado el siguiente documento electronico, a continuacion adjuntamos el archivo:</td>
					</tr>
				</table>
				<br />
				<table style='width:850px;'>
					<tr>
						<td style='font-weight: bold;'>$docu No.</td> <td>$serial</td>
					</tr>
					<tr>
						<td style='font-weight: bold;'>CLAVE</td> <td>$clave</td>
					</tr>
					<tr>
						<td style='font-weight: bold;'>AUTORIZACION</td> <td>$clave</td>
					</tr>
				</table>
				<br><br>
				<table style='width:850px;'>
					<tr>
						<td>Atentamente,</td>
					</tr>
					<tr>&nbsp;</tr>
					<tr>&nbsp;</tr>
					<tr>
						<td style='font-weight: bold; font-size: 13px;'>$compania</td>
					</tr>
					<tr>&nbsp;</tr>
					<tr>
						<td style='font-weight: bold;'>Dire.: $dirMatriz</td>
					</tr>
					<tr>
						<td style='font-weight: bold;'>Telf.: $empr_tel_resp</td>
					</tr>
					 <tr>&nbsp;</tr>
				</table>
			</div>";

    $mail->MsgHTML($sHtml);
    $mail->AddAddress($correo, $correo);

    //consulta correos
    $sql_correo = "select prfa_mail1, prfa_mail2, prfa_mail3 from saeprfa where prfa_cod_empr = $idEmpresa and prfa_est_prfa = 'S' and prfa_cod_prfa = 5";
    if ($oIfx->Query($sql_correo)) {
        if ($oIfx->NumFilas() > 0) {
            $prfa_mail1 = $oIfx->f('prfa_mail1');
            $prfa_mail2 = $oIfx->f('prfa_mail2');
            $prfa_mail3 = $oIfx->f('prfa_mail3');

            //envia correo
            if (!empty($prfa_mail1))
                $mail->AddBCC($prfa_mail1, $prfa_mail1);

            if (!empty($prfa_mail2))
                $mail->AddBCC($prfa_mail2, $prfa_mail2);

            if (!empty($prfa_mail3))
                $mail->AddBCC($prfa_mail3, $prfa_mail3);
        }
    }
    $oIfx->Free();


    /*
    $data = array(
        "codigo" => "fashionclub",
        "clave_acceso" => $clave_acceso,
        "your_address": "jorge.hernandez@sisconti.com",
        "to_address": "jorge.hernandez@sisconti.com",
        "subject": $prfa_sub_prfa . ' ' . $docu . ' No.' . $serial,
        "message": $sHtml,
        "ride":"aG9sYQ==",
        "xml": base64_encode($contenido_xml)
    );

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL,"http://localhost:5555/envio/correo");
    curl_setopt($ch, CURLOPT_POST, 1);
    curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $respuesta = curl_exec($ch);
    $resultado = json_decode($respuesta, true);
    curl_close ($ch);
    */


/* $mail->AddAttachment($ride, $clave.'.xml');
 $mail->AddAttachment($pdf, $clave.'.pdf');


 if (!$mail->Send())
     return "Error: " . $mail->ErrorInfo . $sqlSmtp;
 else
     return 'Mail enviado!';
}*/

function envio_correo_adj($correo = '', $ride = '', $pdf = '', $nom_clpv = '', $clave = '', $serial = '', $clpv = 0, $idTipo = 0) {
    global $DSN_Ifx, $DSN;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    //variables de session
    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idSucursal = $_SESSION['U_SUCURSAL'];

    //tipo documento
    $sqlDocu = "select documento from comercial.doc_time where id_time = $idTipo";
    $docu = consulta_string_func($sqlDocu, 'documento', $oCon, '');

    $sqlEmpr = "select empr_nom_empr, empr_dir_empr, empr_tel_resp, empr_token_api, empr_ruc_empr from saeempr where empr_cod_empr = $idEmpresa";
    if ($oIfx->Query($sqlEmpr)) {
        $compania = $oIfx->f("empr_nom_empr");
        $dirMatriz = $oIfx->f('empr_dir_empr');
        $empr_tel_resp = $oIfx->f("empr_tel_resp");
        $empr_api_toke = $oIfx->f("empr_token_api");
        $ruc_empr = $oIfx->f('empr_ruc_empr');
    }
    $oIfx->Free();

    //consulta correos y mensaje
    $sql = "select prfa_sub_prfa, prfa_men_prfa from saeprfa where prfa_cod_empr = $idEmpresa and prfa_est_prfa = 'S' and prfa_cod_prfa = 5";
    if ($oIfx->Query($sql)) {
        $prfa_sub_prfa = $oIfx->f("prfa_sub_prfa");
        $prfa_men_prfa = $oIfx->f("prfa_men_prfa");
    }
    $oIfx->Free();

    $sqlSmtp = "select server, port, auth, 
    config_email.user, pass, ssltls, 
			mail 
			from comercial.config_email
			where id_empresa = $idEmpresa and
			id_tipo = $idTipo";
    if ($oCon->Query($sqlSmtp)) {
        if ($oCon->NumFilas() > 0) {
            $host = $oCon->f('server');
            $port = $oCon->f('port');
            $smtpauth = $oCon->f('auth');
            $userid = $oCon->f('user');
            $smtpsecure = $oCon->f('ssltls');
            $mailenvio = $oCon->f('mail');
            $password = $oCon->f('pass');
        }
    }
    $oCon->Free();

    if($smtpsecure=='S'||$smtpsecure=='ssl'){
        $smtpsecure='ssl';
    }
    else{
        $smtpsecure='tls';
    }


    $secure_type=$smtpsecure;

    //INFO CUENTAS BANCARIAS RIDE 
    $campo_msj='';

    $sqlfa="select empr_cta_sn, empr_det_cta from saeempr where empr_cod_empr=$idEmpresa ";
     $empr_cta_sn=consulta_string($sqlfa,'empr_cta_sn',$oCon,'');
     $empr_det_cta=consulta_string($sqlfa,'empr_det_cta',$oCon,'');

     if($empr_cta_sn=='S'){
        $campo_msj='<tr><td colspan="2" align="justify">'.$empr_det_cta.'</td></tr>';
     }


    $sHtml = "<div style='width: 900px;'>
				<table style='width:850px;'> 
					<tr>
						<td>Estimado cliente, <span style='font-weight: bold'>$nom_clpv</span> </td>
					</tr>
					<tr>
						<td>Le informamos que ha sido generado el siguiente documento electronico, a continuacion adjuntamos el archivo:</td>
					</tr>
				</table>
				<br />
				<table style='width:850px;'>
					<tr>
						<td style='font-weight: bold;'>$docu No.</td> <td>$serial</td>
					</tr>
					<tr>
						<td style='font-weight: bold;'>CLAVE</td> <td>$clave</td>
					</tr>
					<tr>
						<td style='font-weight: bold;'>AUTORIZACION</td> <td>$clave</td>
					</tr>
                    $campo_msj
				</table>  
				<br><br>
				<table style='width:850px;'>
					<tr> 
						<td>Atentamente,</td>
					</tr> 
					<tr>&nbsp;</tr>
					<tr>&nbsp;</tr>
					<tr>
						<td style='font-weight: bold; font-size: 13px;'>$compania</td>
					</tr>
					<tr>&nbsp;</tr>
					<tr>
						<td style='font-weight: bold;'>Dire.: $dirMatriz</td>
					</tr>
					<tr>
						<td style='font-weight: bold;'>Telf.: $empr_tel_resp</td>
					</tr>
					 <tr>&nbsp;</tr>
				</table>
			</div>";



   

    $archivo_ride = file_get_contents($pdf);
    $archivo_ride = base64_encode($archivo_ride);

    $archivo_xml = file_get_contents($ride);
    $archivo_xml = base64_encode($archivo_xml);


    $headers = array(
        "Content-Type:application/json",
        "Token-Api:$empr_api_toke"
    );
    $rescorreo=trim($correo);
    $correo = array(trim($correo));
    $correocc = array(trim($mailenvio));

     //CORREOS COPIA POR SUCURSAL
     $sql_correo = "select prfa_mail1, prfa_mail2, prfa_mail3 from saeprfa where prfa_cod_empr = $idEmpresa and prfa_cod_sucu=$idSucursal and prfa_est_prfa = 'S' and prfa_cod_prfa = $idTipo";
     if ($oIfx->Query($sql_correo)) {
         if ($oIfx->NumFilas() > 0) {
             $prfa_mail1 = $oIfx->f('prfa_mail1');
             $prfa_mail2 = $oIfx->f('prfa_mail2');
             $prfa_mail3 = $oIfx->f('prfa_mail3');

            if(!empty($prfa_mail1)){
                array_push( $correocc,$prfa_mail1);
            }
            if(!empty($prfa_mail2)){
                array_push( $correocc,$prfa_mail2);
            }
            if(!empty($prfa_mail3)){
                array_push( $correocc,$prfa_mail3);
            }

             
         }
     }
     $oIfx->Free();


    //CORREOS REGISTRADOS DEL CLIENTE
    $sql_correo="select emai_ema_emai from saeemai where emai_cod_clpv=$clpv";
    if ($oIfx->Query($sql_correo)) {
        if ($oIfx->NumFilas() > 0) {
            do{

                $correo_cli=trim($oIfx->f('emai_ema_emai'));

                if(!empty($correo_cli)){
                    array_push( $correocc,$correo_cli);
                }

            }while ($oIfx->SiguienteRegistro());
        }
    }
 
    $data = array(
        "smtp_server" => $host.":".$port,
        "secure_type" => $secure_type,
        "username" => $userid,
        "password" => $password,
        "from_address" => $mailenvio,
        "to_address" =>  $correo,
        "to_cc" =>  $correocc,
        "title" => $prfa_sub_prfa . ' ' . $docu . ' No.' . $serial,
        "content" => $sHtml,
        "attachments" => array(
            array(
                "name"=>"comprobante_".$clave.".pdf","content"=>$archivo_ride
            ),
            array(
                "name"=>"comprobante_".$clave.".xml","content"=>$archivo_xml
            )
        )
    );

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_URL, URL_JIREH_WS_CORREOS."/api/v1/correo/enviar");
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $respuesta = curl_exec($ch);
    $resultado = json_decode($respuesta,true);


    $mensaje = $resultado["msg"];
    $enviado = $resultado["result"];

    if($enviado == true){
        return "Mail Enviado a: ".$rescorreo;
    }else{
        return "Error al enviar email".$mensaje ;
    }
}

function envio_correo_adj_2($oIfx, $oCon, $correo = '', $ride = '', $pdf = '', $nom_clpv = '', $clave = '', $serial = '', $clpv = 0, $idTipo = 0) {

    session_start();

    //variables de session
    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idSucursal = $_SESSION['U_SUCURSAL'];

    session_write_close(); //ESTA FUNCION INPIDE QUE SE BLOQUEEN LOS DEMAS PROCESOS PHP

    //tipo documento
    $sqlDocu = "select documento from comercial.doc_time where id_time = $idTipo";
    $docu = consulta_string_func($sqlDocu, 'documento', $oCon, '');

    $sqlEmpr = "select empr_nom_empr, empr_dir_empr, empr_tel_resp, empr_token_api, empr_ruc_empr from saeempr where empr_cod_empr = $idEmpresa";
    if ($oIfx->Query($sqlEmpr)) {
        $compania = $oIfx->f("empr_nom_empr");
        $dirMatriz = $oIfx->f('empr_dir_empr');
        $empr_tel_resp = $oIfx->f("empr_tel_resp");
        $empr_api_toke = $oIfx->f("empr_token_api");
        $ruc_empr = $oIfx->f('empr_ruc_empr');
    }
    $oIfx->Free();

    //consulta correos y mensaje
    $sql = "select prfa_sub_prfa, prfa_men_prfa from saeprfa where prfa_cod_empr = $idEmpresa and prfa_est_prfa = 'S' and prfa_cod_prfa = 5";
    if ($oIfx->Query($sql)) {
        $prfa_sub_prfa = $oIfx->f("prfa_sub_prfa");
        $prfa_men_prfa = $oIfx->f("prfa_men_prfa");
    }
    $oIfx->Free();

    $sqlSmtp = "select server, port, auth, 
    config_email.user, pass, ssltls, 
			mail 
			from comercial.config_email
			where id_empresa = $idEmpresa and
			id_tipo = $idTipo";
    if ($oCon->Query($sqlSmtp)) {
        if ($oCon->NumFilas() > 0) {
            $host = $oCon->f('server');
            $port = $oCon->f('port');
            $smtpauth = $oCon->f('auth');
            $userid = $oCon->f('user');
            $smtpsecure = $oCon->f('ssltls');
            $mailenvio = $oCon->f('mail');
            $password = $oCon->f('pass');
        }
    }
    $oCon->Free();

    if($smtpsecure=='S'||$smtpsecure=='ssl'){
        $smtpsecure='ssl';
    }
    else{
        $smtpsecure='tls';
    }


    $secure_type=$smtpsecure;

    //INFO CUENTAS BANCARIAS RIDE 
    $campo_msj='';

    $sqlfa="select empr_cta_sn, empr_det_cta from saeempr where empr_cod_empr=$idEmpresa ";
     $empr_cta_sn=consulta_string($sqlfa,'empr_cta_sn',$oCon,'');
     $empr_det_cta=consulta_string($sqlfa,'empr_det_cta',$oCon,'');

     if($empr_cta_sn=='S'){
        $campo_msj='<tr><td colspan="2" align="justify">'.$empr_det_cta.'</td></tr>';
     }


    $sHtml = "<div style='width: 900px;'>
				<table style='width:850px;'> 
					<tr>
						<td>Estimado cliente, <span style='font-weight: bold'>$nom_clpv</span> </td>
					</tr>
					<tr>
						<td>Le informamos que ha sido generado el siguiente documento electronico, a continuacion adjuntamos el archivo:</td>
					</tr>
				</table>
				<br />
				<table style='width:850px;'>
					<tr>
						<td style='font-weight: bold;'>$docu No.</td> <td>$serial</td>
					</tr>
					<tr>
						<td style='font-weight: bold;'>CLAVE</td> <td>$clave</td>
					</tr>
					<tr>
						<td style='font-weight: bold;'>AUTORIZACION</td> <td>$clave</td>
					</tr>
                    $campo_msj
				</table>  
				<br><br>
				<table style='width:850px;'>
					<tr> 
						<td>Atentamente,</td>
					</tr> 
					<tr>&nbsp;</tr>
					<tr>&nbsp;</tr>
					<tr>
						<td style='font-weight: bold; font-size: 13px;'>$compania</td>
					</tr>
					<tr>&nbsp;</tr>
					<tr>
						<td style='font-weight: bold;'>Dire.: $dirMatriz</td>
					</tr>
					<tr>
						<td style='font-weight: bold;'>Telf.: $empr_tel_resp</td>
					</tr>
					 <tr>&nbsp;</tr>
				</table>
			</div>";



   

    $archivo_ride = file_get_contents($pdf);
    $archivo_ride = base64_encode($archivo_ride);

    $archivo_xml = file_get_contents($ride);
    $archivo_xml = base64_encode($archivo_xml);


    $headers = array(
        "Content-Type:application/json",
        "Token-Api:$empr_api_toke"
    );
    $rescorreo=trim($correo);
    $correo = array(trim($correo));
    $correocc = array(trim($mailenvio));

     //CORREOS COPIA POR SUCURSAL
     $sql_correo = "select prfa_mail1, prfa_mail2, prfa_mail3 from saeprfa where prfa_cod_empr = $idEmpresa and prfa_cod_sucu=$idSucursal and prfa_est_prfa = 'S' and prfa_cod_prfa = $idTipo";
     if ($oIfx->Query($sql_correo)) {
         if ($oIfx->NumFilas() > 0) {
             $prfa_mail1 = $oIfx->f('prfa_mail1');
             $prfa_mail2 = $oIfx->f('prfa_mail2');
             $prfa_mail3 = $oIfx->f('prfa_mail3');

            if(!empty($prfa_mail1)){
                array_push( $correocc,$prfa_mail1);
            }
            if(!empty($prfa_mail2)){
                array_push( $correocc,$prfa_mail2);
            }
            if(!empty($prfa_mail3)){
                array_push( $correocc,$prfa_mail3);
            }

             
         }
     }
     $oIfx->Free();


    //CORREOS REGISTRADOS DEL CLIENTE
    $sql_correo="select emai_ema_emai from saeemai where emai_cod_clpv=$clpv";
    if ($oIfx->Query($sql_correo)) {
        if ($oIfx->NumFilas() > 0) {
            do{

                $correo_cli=trim($oIfx->f('emai_ema_emai'));

                if(!empty($correo_cli)){
                    array_push( $correocc,$correo_cli);
                }

            }while ($oIfx->SiguienteRegistro());
        }
    }
 
    $data = array(
        "smtp_server" => $host.":".$port,
        "secure_type" => $secure_type,
        "username" => $userid,
        "password" => $password,
        "from_address" => $mailenvio,
        "to_address" =>  $correo,
        "to_cc" =>  $correocc,
        "title" => $prfa_sub_prfa . ' ' . $docu . ' No.' . $serial,
        "content" => $sHtml,
        "attachments" => array(
            array(
                "name"=>"comprobante_".$clave.".pdf","content"=>$archivo_ride
            ),
            array(
                "name"=>"comprobante_".$clave.".xml","content"=>$archivo_xml
            )
        )
    );

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_URL, URL_JIREH_WS_CORREOS."/api/v1/correo/enviar");
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 15);
    curl_setopt($ch, CURLOPT_TIMEOUT, 15); 
    $respuesta = curl_exec($ch);
    $resultado = json_decode($respuesta,true);


    $mensaje = $resultado["msg"];
    $enviado = $resultado["result"];

    if($enviado == true){
        return "Mail Enviado a: ".$rescorreo;
    }else{
        return "Error al enviar email".$mensaje ;
    }
}

function envio_correo_adj_reenvio($correo = '', $ride = '', $pdf = '', $nom_clpv = '', $clave = '', $serial = '', $clpv = 0, $idTipo = 0, $copia_email = "") {
    global $DSN_Ifx, $DSN;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    //variables de session
    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idSucursal = $_SESSION['U_SUCURSAL'];

    //tipo documento
    $sqlDocu = "select documento from comercial.doc_time where id_time = $idTipo";
    $docu = consulta_string_func($sqlDocu, 'documento', $oCon, '');

    $sqlEmpr = "select empr_nom_empr, empr_dir_empr, empr_tel_resp, empr_token_api from saeempr where empr_cod_empr = $idEmpresa";
    if ($oIfx->Query($sqlEmpr)) {
        $compania = $oIfx->f("empr_nom_empr");
        $dirMatriz = $oIfx->f('empr_dir_empr');
        $empr_tel_resp = $oIfx->f("empr_tel_resp");
        $empr_api_toke = $oIfx->f("empr_token_api");
    }
    $oIfx->Free();

    //consulta correos y mensaje
    $sql = "select prfa_sub_prfa, prfa_men_prfa from saeprfa where prfa_cod_empr = $idEmpresa and prfa_est_prfa = 'S' and prfa_cod_prfa = 5";
    if ($oIfx->Query($sql)) {
        $prfa_sub_prfa = $oIfx->f("prfa_sub_prfa");
        $prfa_men_prfa = $oIfx->f("prfa_men_prfa");
    }
    $oIfx->Free();

    $sqlSmtp = "select server, port, auth, 
    config_email.user, pass, ssltls, 
			mail 
			from comercial.config_email
			where id_empresa = $idEmpresa and
			id_tipo = $idTipo";
    if ($oCon->Query($sqlSmtp)) {
        if ($oCon->NumFilas() > 0) {
            $host = $oCon->f('server');
            $port = $oCon->f('port');
            $smtpauth = $oCon->f('auth');
            $userid = $oCon->f('user');
            $smtpsecure = $oCon->f('ssltls');
            $mailenvio = $oCon->f('mail');
            $password = $oCon->f('pass');
        }
    }
    $oCon->Free();

    if($smtpsecure=='S'||$smtpsecure=='ssl'){
        $smtpsecure='ssl';
    }
    else{
        $smtpsecure='tls';
    }


    $secure_type=$smtpsecure;


    $sHtml = "<div style='width: 900px;'>
				<table style='width:850px;'> 
					<tr>
						<td>Estimado cliente, <span style='font-weight: bold'>$nom_clpv</span> </td>
					</tr>
					<tr>
						<td>Le informamos que ha sido generado el siguiente documento electronico, a continuacion adjuntamos el archivo:</td>
					</tr>
				</table>
				<br />
				<table style='width:850px;'>
					<tr>
						<td style='font-weight: bold;'>$docu No.</td> <td>$serial</td>
					</tr>
					<tr>
						<td style='font-weight: bold;'>CLAVE</td> <td>$clave</td>
					</tr>
					<tr>
						<td style='font-weight: bold;'>AUTORIZACION</td> <td>$clave</td>
					</tr>
				</table>  
				<br><br>
				<table style='width:850px;'>
					<tr> 
						<td>Atentamente,</td>
					</tr> 
					<tr>&nbsp;</tr>
					<tr>&nbsp;</tr>
					<tr>
						<td style='font-weight: bold; font-size: 13px;'>$compania</td>
					</tr>
					<tr>&nbsp;</tr>
					<tr>
						<td style='font-weight: bold;'>Dire.: $dirMatriz</td>
					</tr>
					<tr>
						<td style='font-weight: bold;'>Telf.: $empr_tel_resp</td>
					</tr>
					 <tr>&nbsp;</tr>
				</table>
			</div>";
    


    $archivo_ride = file_get_contents($pdf);
    $archivo_ride = base64_encode($archivo_ride);

    $archivo_xml = file_get_contents($ride);
    $archivo_xml = base64_encode($archivo_xml);


    $headers = array(
        "Content-Type:application/json",
        "Token-Api:$empr_api_toke"
    );

    $correocc = array(trim($mailenvio));

    $rescorreo=trim($correo);
    $correos_destino = array();
    $correos_explode = explode(';',$correo);
    foreach ($correos_explode as $correo_exp){
        array_push($correos_destino, trim($correo_exp));
    }

    if($copia_email){
        array_push( $correocc,$copia_email);
    }


    $data = array(
        "smtp_server" => $host.":".$port,
        "secure_type" => $secure_type,
        "username" => $userid,
        "password" => $password,
        "from_address" => $mailenvio,
        "to_address" =>  $correos_destino,
        "to_cc" =>  $correocc,
        "title" => $prfa_sub_prfa . ' ' . $docu . ' No.' . $serial,
        "content" => $sHtml,
        "attachments" => array(
            array(
                "name"=>"comprobante_".$clave.".pdf","content"=>$archivo_ride
            ),
            array(
                "name"=>"comprobante_".$clave.".xml","content"=>$archivo_xml
            )
        )
    );

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_URL, URL_JIREH_WS_CORREOS."/api/v1/correo/enviar");
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $respuesta = curl_exec($ch);
    $resultado = json_decode($respuesta,true);


    $mensaje = $resultado["msg"];
    $enviado = $resultado["result"];

    if($enviado == true){
        return "Mail Enviado a: ".$rescorreo;
    }else{
        return "Error al enviar email".$mensaje ;
    }
}

function envio_correo_adj_sunat($correo = '', $ride = '', $pdf = '', $nom_clpv = '', $clave = '', $serial = '', $clpv = 0, $idTipo = '', $nombre_documento = '',$copia_email = '') {
    global $DSN_Ifx, $DSN;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    //variables de session
    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idSucursal = $_SESSION['U_SUCURSAL'];

    if($idTipo == '01'){
     
        $docu = 'FACTURA DE VENTA';
    }else if($idTipo == '03'){
        $docu = 'BOLETA DE VENTA';
        $idTipo=1;
    }

    if($nombre_documento){
        $docu = $nombre_documento;
    }

    $sqlEmpr = "select empr_nom_empr, empr_dir_empr, empr_tel_resp, empr_token_api from saeempr where empr_cod_empr = $idEmpresa";
    if ($oIfx->Query($sqlEmpr)) {
        $compania = $oIfx->f("empr_nom_empr");
        $dirMatriz = $oIfx->f('empr_dir_empr');
        $empr_tel_resp = $oIfx->f("empr_tel_resp");
        $empr_api_toke = $oIfx->f("empr_token_api");
    }
    $oIfx->Free();

    //consulta correos y mensaje
    $sql = "select prfa_sub_prfa, prfa_men_prfa from saeprfa where prfa_cod_empr = $idEmpresa and prfa_est_prfa = 'S' and prfa_cod_prfa = 5";
    if ($oIfx->Query($sql)) {
        $prfa_sub_prfa = $oIfx->f("prfa_sub_prfa");
        $prfa_men_prfa = $oIfx->f("prfa_men_prfa");
    }
    $oIfx->Free();

    $sqlSmtp = "select server, port, auth, 
                config_email.user, pass, ssltls, cuerpo_mensaje,
                mail, asunto 
                from comercial.config_email
                where id_empresa = $idEmpresa and
                id_tipo = $idTipo";
    if ($oCon->Query($sqlSmtp)) {
        if ($oCon->NumFilas() > 0) {
            $host = $oCon->f('server');
            $port = $oCon->f('port');
            $smtpauth = $oCon->f('auth');
            $userid = $oCon->f('user');
            $smtpsecure = $oCon->f('ssltls');
            $mailenvio = $oCon->f('mail');
            $asunto = $oCon->f('asunto');
            $password = $oCon->f('pass');
            $msj_personalizado = $oCon->f('cuerpo_mensaje',false);
        }
    }
    $oCon->Free();

    if($smtpsecure=='S'||$smtpsecure=='ssl'){
        $smtpsecure='ssl';
    }
    else{
        $smtpsecure='tls';
    }


    $secure_type=$smtpsecure;

    $array_imagenes = array();
    if(!empty(trim($msj_personalizado))){
        
        $msj_personalizado =str_replace('{cliente}',$nom_clpv, $msj_personalizado);
        $msj_personalizado =str_replace('{comprobante}',$serial, $msj_personalizado);
        $asunto =str_replace('{comprobante}',$serial, $asunto);
        $sHtml = $msj_personalizado;


        //TRANSFORMA EL HTML PARA RECORRER LA INFORMACION DE SUS TAGS
        $doc = new DOMDocument();
        @$doc->loadHTML($sHtml);
        
        $imagenes = $doc->getElementsByTagName('img');
        $i=1;

        foreach ($imagenes as $imagen) {
            $width   = $imagen->getAttribute('width');
            $height   = $imagen->getAttribute('height');
            $src   = $imagen->getAttribute('src');
            $style= $imagen->getAttribute('style');

            //VALIDAICON IMAGENES BASE 64
            
            if(preg_match("/data:image/",$src)){
                $array_src=explode(',',$src);
                $text_ori  = '<img style="'.$style.'" src="'.$src.'" width="'.$width.'" height="'.$height.'">';
                $text_ori_1= '<img src="'.$src.'" width="'.$width.'" height="'.$height.'">';

                $text_new='<img style="'.$style.'" width="'.$width.'" height="'.$height.'" src="cid:img'.$i.'"  />';
                $sHtml=str_replace($text_ori,$text_new ,$sHtml);
                $sHtml=str_replace($text_ori_1,$text_new ,$sHtml);
 
                if(!empty( $src)){
                    $data = array(
                        "content" => $array_src[1],
                        "image_id" => 'img'.$i,
                    );
                    array_push($array_imagenes, $data);
                }
            }
           
            
            $i++;
        }

        //var_dump($sHtml);exit;

    }
    else{
            $sHtml = "<div style='width: 900px;'>
				<table style='width:850px;'> 
					<tr>
						<td>Estimado cliente, <span style='font-weight: bold'>$nom_clpv</span> </td>
					</tr>
					<tr>
						<td>Le informamos que ha sido generado el siguiente documento electronico, a continuacion adjuntamos el archivo:</td>
					</tr>
				</table>
				<br />
				<table style='width:850px;'>
					<tr>
						<td style='font-weight: bold;'>$docu No.</td> <td>$serial</td>
					</tr>
				</table>  
				<br><br>
				<table style='width:850px;'>
					<tr> 
						<td>Atentamente,</td>
					</tr> 
					<tr>&nbsp;</tr>
					<tr>&nbsp;</tr>
					<tr>
						<td style='font-weight: bold; font-size: 13px;'>$compania</td>
					</tr>
					<tr>&nbsp;</tr>
					<tr>
						<td style='font-weight: bold;'>Dire.: $dirMatriz</td>
					</tr>
					<tr>
						<td style='font-weight: bold;'>Telf.: $empr_tel_resp</td>
					</tr>
					 <tr>&nbsp;</tr>
				</table>
			</div>";

    }


    //consulta correos
    $sql_correo = "select prfa_mail1, prfa_mail2, prfa_mail3 from saeprfa where prfa_cod_empr = $idEmpresa and prfa_est_prfa = 'S' and prfa_cod_prfa = 5";
    if ($oIfx->Query($sql_correo)) {
        if ($oIfx->NumFilas() > 0) {
            $prfa_mail1 = $oIfx->f('prfa_mail1');
            $prfa_mail2 = $oIfx->f('prfa_mail2');
            $prfa_mail3 = $oIfx->f('prfa_mail3');
            /*
            //envia correo
            if (!empty($prfa_mail1))
                $mail->AddBCC($prfa_mail1, $prfa_mail1);

            if (!empty($prfa_mail2))
                $mail->AddBCC($prfa_mail2, $prfa_mail2);

            if (!empty($prfa_mail3))
                $mail->AddBCC($prfa_mail3, $prfa_mail3);
            */
        }
    }
    $oIfx->Free();

    $archivo_ride = file_get_contents($pdf);
    $archivo_ride = base64_encode($archivo_ride);

    $archivo_xml = file_get_contents($ride);
    $archivo_xml = base64_encode($archivo_xml);


    $headers = array(
        "Content-Type:application/json",
        "Token-Api:$empr_api_toke"
    );
    $rescorreo=trim($correo);
    $correocc = array(trim($mailenvio));


    $correos_destino = array();
    $correos_explode = explode(';',$correo);
    foreach ($correos_explode as $correo_exp){
        array_push($correos_destino, trim($correo_exp));
    }

    if($copia_email){
        array_push( $correocc,$copia_email);
    }

    //VALIDACION ASUNTO

    if(empty(trim($asunto))){
       $asunto= $prfa_sub_prfa . ' ' . $docu . ' No.' . $serial;
    }

    $data = array(
        "smtp_server" => $host.":".$port,
        "secure_type" => $secure_type,
        "username" => $userid,
        "password" => $password,
        "from_address" => $mailenvio,
        "to_address" =>  $correos_destino,
        "to_cc" =>  $correocc,
        "title" => $asunto,
        "content" => $sHtml,
        "attachments" => array(
            array(
                "name"=>"comprobante_".$clave.".pdf","content"=>$archivo_ride
            ),
            array(
                "name"=>"comprobante_".$clave.".xml","content"=>$archivo_xml
            )
            ),
        "images" => $array_imagenes
    );

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_URL, URL_JIREH_WS_CORREOS."/api/v1/correo/enviar");
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $respuesta = curl_exec($ch);
    $resultado = json_decode($respuesta,true);


    $mensaje = $resultado["msg"];
    $enviado = $resultado["result"];

    if($enviado == true){
        return "Mail Enviado a: ".$rescorreo;
    }else{
        return "Error al enviar email ".$mensaje ;
    }
}

function envio_correo_html_send($correo = '', $html_mensaje = '', $title_mensaje = '',  $idTipo = 1, $copia_email = "", $adj=array(), $array_imagenes=array()) {
    global $DSN_Ifx, $DSN;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    //variables de session
    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idSucursal = $_SESSION['U_SUCURSAL'];


    $sqlEmpr = "select empr_nom_empr, empr_dir_empr, empr_tel_resp, empr_token_api from saeempr where empr_cod_empr = $idEmpresa";
    if ($oIfx->Query($sqlEmpr)) {
        $compania = $oIfx->f("empr_nom_empr");
        $dirMatriz = $oIfx->f('empr_dir_empr');
        $empr_tel_resp = $oIfx->f("empr_tel_resp");
        $empr_api_toke = $oIfx->f("empr_token_api");
    }
    $oIfx->Free();


    $sqlSmtp = "select server, port, auth, 
    config_email.user, pass, ssltls, 
            mail 
            from comercial.config_email
            where id_empresa = $idEmpresa and
            id_tipo = $idTipo";
    if ($oCon->Query($sqlSmtp)) {
        if ($oCon->NumFilas() > 0) {
            $host = $oCon->f('server');
            $port = $oCon->f('port');
            $smtpauth = $oCon->f('auth');
            $userid = $oCon->f('user');
            $smtpsecure = $oCon->f('ssltls');
            $mailenvio = $oCon->f('mail');
            $password = $oCon->f('pass');
        }
    }
    $oCon->Free();

    if($smtpsecure=='S'||$smtpsecure=='ssl'){
        $smtpsecure='ssl';
    }
    else{
        $smtpsecure='tls';
    }


    $secure_type=$smtpsecure;
    $sHtml = "<div style='width: 900px;'>".$html_mensaje."</div>";

    $headers = array(
        "Content-Type:application/json",
        "Token-Api:$empr_api_toke"
    );

    $correocc = array();

    $rescorreo=trim($correo);
    $correos_destino = array();
    $correos_explode = explode(';',$correo);
    foreach ($correos_explode as $correo_exp){
        array_push($correos_destino, trim($correo_exp));
    }

    if($copia_email){
        array_push( $correocc,$copia_email);
    }

    $htt = url_actual();
    $url = str_replace('modulos', '', $htt);

            $data = array(
            "smtp_server" => $host.":".$port,
            "secure_type" => $secure_type,
            "username" => $userid,
            "password" => $password,
            "from_address" => $mailenvio,
            "to_address" =>  $correos_destino,
            "to_cc" =>  $correocc,
            "title" => $title_mensaje,
            "content" => $sHtml,
            //"attachments" => $adj,
            "images" => $array_imagenes
            
            );
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_URL, URL_JIREH_WS_CORREOS."/api/v1/correo/enviar");
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $respuesta = curl_exec($ch);
    $resultado = json_decode($respuesta,true);


    $mensaje = $resultado["msg"];
    $enviado = $resultado["result"];

    if($enviado == true){
        return "Mail Enviado a: ".$rescorreo;
    }else{
        return "Error al enviar email".$mensaje ;
    }
}


function envio_correo_form_recla($pdf,$correo_recl, $secuencial, $nom_recla, $fecha_adic,$num_contrato) { 
    

    //echo 'pdf:' .$pdf. 'CORREO:' .$correo_recl;exit;
    //echo "dentro de la func";exit;
    global $DSN_Ifx, $DSN;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    //variables de session
    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idSucursal = $_SESSION['U_SUCURSAL'];


    $pdf=DIR_FACTELEC.'modulos/form_recla/'.$pdf;
    
    $sqlEmpr = "select empr_nom_empr, empr_dir_empr, empr_tel_resp, empr_token_api from saeempr where empr_cod_empr = $idEmpresa";
    if ($oIfx->Query($sqlEmpr)) {
        $compania = $oIfx->f("empr_nom_empr");
        $dirMatriz = $oIfx->f('empr_dir_empr');
        $empr_tel_resp = $oIfx->f("empr_tel_resp");
        $empr_api_toke = $oIfx->f("empr_token_api");
    }
    $oIfx->Free();

 

    $sqlSmtp = "select server, port, auth, 
    config_email.user, pass, ssltls, 
			mail 
			from comercial.config_email
			where id_empresa = $idEmpresa and
			id_tipo = 1";

           // echo $sqlSmtp;exit;
    if ($oCon->Query($sqlSmtp)) {
        if ($oCon->NumFilas() > 0) {
            $host = $oCon->f('server');
            $port = $oCon->f('port');
            $smtpauth = $oCon->f('auth');
            $userid = $oCon->f('user');
            $smtpsecure = $oCon->f('ssltls');
            $mailenvio = $oCon->f('mail');
            $password = $oCon->f('pass');
        }
    }
    $oCon->Free();

    if($smtpsecure=='S'||$smtpsecure=='ssl'){
        $smtpsecure='ssl';
    }
    else{
        $smtpsecure='tls';
    }

    $secure_type=$smtpsecure;

 

  
    $sHtml = "<div style='width: 900px;'>
				<table style='width:850px;'> 

                <tr>
                <td><b>CONTENIDO DE CONFIRMACIÓN DE RECEPCIÓN DE RECLAMO POR CORREO ELECTRÓNICO</b></td>
                </tr>
                </table>
                <table>
					<tr>
                        <td>ASUNTO: Reclamo N° <b>$secuencial</b></td>
						<td>Servicio  N° <b>$num_contrato</b></td>
                        
					</tr>
					
				</table>
				<br />
				<table style='width:850px;'>
					<tr>
						<td style='font-weight: ;'>Estimado Cliente: <b> $nom_recla </b></td>
					</tr>
					<tr>
						<td style='font-weight: ;'>Sirva la presente para saludarte y, al mismo tiempo, enviarte el formulario de reclamo presentado el día <b>$fecha_adic</b>, 
                        el mismo que fue registrado con código N° <b> $secuencial </b> y derivado para su atención.</td>
					</tr>
					<tr>
						<td style='font-weight: ;'><p>Asimismo, te informamos que los plazos de atención y notificación de reclamos se encuentran regulados por el OSIPTEL 
                        conforme a lo dispuesto en el TUO del Reglamento para la Atención de Gestiones y Reclamos de Usuarios de Servicios Públicos de Telecomunicaciones 
                        aprobado mediante la Resolución de Consejo Directivo N° 099-2022-CD/OSIPTEL.</p></td> 
					</tr>

                    <tr>
						<td style='font-weight: ;'><p>Finalmente, solicitamos tengas a bien confirmar la recepción de la presente comunicación.</p></td> 
					</tr>

                    <tr>
                    <td>Saludos cordiales,<br></td>
                    </tr>

                    <tr>
                    <td>Atención al Cliente<br>
                    <b>GLOBAL FIBER</b></td>
                    </tr>
				</table>  
			
			
			</div>";


    $headers = array(
        "Content-Type:application/json",
        "Token-Api:$empr_api_toke"
    );

    // Copia a :
    $reenviar_a='';
    $correocc = array();
    $reenviar_a_partes = explode(";", $reenviar_a);
    foreach ($reenviar_a_partes as $key => $reenviar) {
        array_push($correocc, $reenviar);
    }
    // FIN Copia a :

    $correos_destino = array();
    array_push($correos_destino, $correo_recl);
   
    if(empty($pdf)){
        $data = array(
            "smtp_server" => $host.":".$port,
            "secure_type" => $secure_type,
            "username" => $userid,
            "password" => $password,
            "from_address" => $mailenvio,
            "to_address" =>  $correos_destino,
            "to_cc" =>  [],//reenvio
            "title" => 'NOTIFICACION',
            "content" => $sHtml
        );
    } else {
        $archivo_ride = file_get_contents($pdf);
        $archivo_ride = base64_encode($archivo_ride);
        
        $data = array(
            "smtp_server" => $host.":".$port,
            "secure_type" => $secure_type,
            "username" => $userid,
            "password" => $password,
            "from_address" => $mailenvio,
            "to_address" =>  $correos_destino,
            "to_cc" =>  [],
            "title" => 'Reclamo N° '.$secuencial.' Servicio N° '.$num_contrato.'',
            "content" => $sHtml,
            "attachments" => array(
                array(
                    "name"=>"comprobante.pdf","content"=>$archivo_ride
                )
            )
        );
    }

    

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_URL, URL_JIREH_WS_CORREOS."/api/v1/correo/enviar");
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $respuesta = curl_exec($ch);
    $resultado = json_decode($respuesta,true);
   // var_dump($resultado);


    $mensaje = $resultado["msg"];
    $enviado = $resultado["result"];

    if($enviado == true){
       $mesaje = "Mail Enviado a: ".$correo_recl;
    }else{
        $mesaje = "Error al enviar email ".$enviado ;
    }
    
    return $mesaje;


}

function envio_correo_form_orden_serv($pdf,$email, $nom_clpv) { 
    

    //echo 'pdf:' .$pdf. 'CORREO:' .$correo_recl;exit;
    //echo "dentro de la func";exit;
    global $DSN_Ifx, $DSN;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    //variables de session
    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idSucursal = $_SESSION['U_SUCURSAL'];


   
    
    $sqlEmpr = "select empr_nom_empr, empr_dir_empr, empr_tel_resp, empr_token_api from saeempr where empr_cod_empr = $idEmpresa";
    if ($oIfx->Query($sqlEmpr)) {
        $compania = $oIfx->f("empr_nom_empr");
        $dirMatriz = $oIfx->f('empr_dir_empr');
        $empr_tel_resp = $oIfx->f("empr_tel_resp");
        $empr_api_toke = $oIfx->f("empr_token_api");
    }
    $oIfx->Free();

 

    $sqlSmtp = "select server, port, auth, 
    config_email.user, pass, ssltls, 
			mail 
			from comercial.config_email
			where id_empresa = $idEmpresa and
			id_tipo = 1";

           // echo $sqlSmtp;exit;
    if ($oCon->Query($sqlSmtp)) {
        if ($oCon->NumFilas() > 0) {
            $host = $oCon->f('server');
            $port = $oCon->f('port');
            $smtpauth = $oCon->f('auth');
            $userid = $oCon->f('user');
            $smtpsecure = $oCon->f('ssltls');
            $mailenvio = $oCon->f('mail');
            $password = $oCon->f('pass');
        }
    }
    $oCon->Free();

    if($smtpsecure=='S'||$smtpsecure=='ssl'){
        $smtpsecure='ssl';
    }
    else{
        $smtpsecure='tls';
    }

    $secure_type=$smtpsecure;

 

  
    $sHtml = "<div style='width: 900px;'>
				<table style='width:850px;'> 

                <tr>
                <td><b>CONTENIDO DE RECEPCIÓN DE ORDEN DE SERVICIO POR CORREO ELECTRÓNICO</b></td>
                </tr>
                </table>
             
				<br />
				<table style='width:850px;'>
					<tr>
						<td style='font-weight: ;'>Estimado Cliente: <b> $nom_clpv </b></td>
					</tr>
					<tr>
						<td style='font-weight: ;'>Sirva la presente para saludarte y, al mismo tiempo, enviarte el formulario de orden de servicio, el mismo contiene una archivo pdf
                        en el cual se detalla toda la ejecucion a su pedido.
					</tr>
					

                    <tr>
                    <td>Saludos cordiales,<br></td>
                    </tr>

                    <tr>
                    <td><br>
                    <b>$compania</b></td>
                    </tr>
				</table>  
			
			
			</div>";


    $headers = array(
        "Content-Type:application/json",
        "Token-Api:$empr_api_toke"
    );

    // Copia a :
    $reenviar_a='';
    $correocc = array();
    $reenviar_a_partes = explode(";", $reenviar_a);
    foreach ($reenviar_a_partes as $key => $reenviar) {
        array_push($correocc, $reenviar);
    }
    // FIN Copia a :

    $correos_destino = array();
    array_push($correos_destino, $email);
   
    if(empty($pdf)){
        $data = array(
            "smtp_server" => $host.":".$port,
            "secure_type" => $secure_type,
            "username" => $userid,
            "password" => $password,
            "from_address" => $mailenvio,
            "to_address" =>  $correos_destino,
            "to_cc" =>  [],//reenvio
            "title" => 'NOTIFICACION',
            "content" => $sHtml
        );
    } else {
        $archivo_ride = file_get_contents($pdf);
        $archivo_ride = base64_encode($archivo_ride);
        
        $data = array(
            "smtp_server" => $host.":".$port,
            "secure_type" => $secure_type,
            "username" => $userid,
            "password" => $password,
            "from_address" => $mailenvio,
            "to_address" =>  $correos_destino,
            "to_cc" =>  [],
            "title" => 'ORDEN DE SERVICIO',
            "content" => $sHtml,
            "attachments" => array(
                array(
                    "name"=>"comprobante.pdf","content"=>$archivo_ride
                )
            )
        );
    }

    

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_URL, URL_JIREH_WS_CORREOS."/api/v1/correo/enviar");
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $respuesta = curl_exec($ch);
    $resultado = json_decode($respuesta,true);
   // var_dump($resultado);


    $mensaje = $resultado["msg"];
    $enviado = $resultado["result"];

    if($enviado == true){
       $mesaje = "Mail Enviado a: ".$correo_recl;
    }else{
        $mesaje = "Error al enviar email ".$enviado ;
    }
    
    return $mesaje;


}

// SRI
function ambienteEmisionSri($Conexion, $idEmpresa, $idSucursal, $op)
{

    if ($op == 1) {

        $sqlAmbiEmi = "select sucu_tip_ambi from saesucu where  sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal";
        $sucu_tip_ambi = consulta_string_func($sqlAmbiEmi, 'sucu_tip_ambi', $Conexion, '');

        return $sucu_tip_ambi;

    } elseif ($op == 2) {

        $sqlAmbiEmi = "select sucu_tip_emis from saesucu where  sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal";
        $sucu_tip_emis = consulta_string_func($sqlAmbiEmi, 'sucu_tip_emis', $Conexion, '');

        return $sucu_tip_emis;

    } elseif ($op == 3) {

        $sqlAmbiEmi = "select sucu_tip_toke from saesucu where  sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal";
        $sucu_tip_toke = consulta_string_func($sqlAmbiEmi, 'sucu_tip_toke', $Conexion, '');

        return $sucu_tip_toke;
    } elseif ($op == 4) {

        $sqlAmbiEmi = "select sucu_tip_esqu from saesucu where  sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal";
        $sucu_tip_esqu = consulta_string_func($sqlAmbiEmi, 'sucu_tip_esqu', $Conexion, '');


        return $sucu_tip_esqu;
    }
}

function generaClaveAccesoSri2($empr_ruc_empr, $sucu_tip_ambi, $sucu_tip_emis, $tipDocumento, $fechaDocumento, $serieDocumento, $secuencialDocumento)
{

    //datos de la empresa
   /*  $sqlEmpr = "select empr_ruc_empr from saeempr where empr_cod_empr = $idEmpresa";
    $empr_ruc_empr = consulta_string_func($sqlEmpr, 'empr_ruc_empr', $Conexion, ''); */

    //datos de la sucursal para armar clave de acceso
    /* $sqlSucu = "select  sucu_tip_ambi, sucu_tip_emis 
				from saesucu 
				where  sucu_cod_empr = $idEmpresa and
				sucu_cod_sucu = $idSucursal";
    if ($Conexion->Query($sqlSucu)) {
        if ($Conexion->NumFilas() > 0) {
            $sucu_tip_ambi = $Conexion->f('sucu_tip_ambi');
            $sucu_tip_emis = $Conexion->f('sucu_tip_emis');
        }
    }
    $Conexion->Free(); */

    $num8 = 12345678;
    $fechaXml = fecha_claveSri($fechaDocumento);

    $claveAcceso = $fechaXml . $tipDocumento . $empr_ruc_empr . $sucu_tip_ambi . $serieDocumento . $secuencialDocumento . $num8 . $sucu_tip_emis;
    $digitoVerificador = digitoVerificadorSri($claveAcceso);

    $claveAcceso = $claveAcceso . $digitoVerificador;

    return $claveAcceso;
}

function generaClaveAccesoSri($Conexion, $tipDocumento, $idEmpresa, $idSucursal, $fechaDocumento, $serieDocumento, $secuencialDocumento)
{

    //datos de la empresa
    $sqlEmpr = "select empr_ruc_empr from saeempr where empr_cod_empr = $idEmpresa";
    $empr_ruc_empr = consulta_string_func($sqlEmpr, 'empr_ruc_empr', $Conexion, '');

    //datos de la sucursal para armar clave de acceso
    $sqlSucu = "select  sucu_tip_ambi, sucu_tip_emis 
				from saesucu 
				where  sucu_cod_empr = $idEmpresa and
				sucu_cod_sucu = $idSucursal";
    if ($Conexion->Query($sqlSucu)) {
        if ($Conexion->NumFilas() > 0) {
            $sucu_tip_ambi = $Conexion->f('sucu_tip_ambi');
            $sucu_tip_emis = $Conexion->f('sucu_tip_emis');
        }
    }
    $Conexion->Free();

    $num8 = 12345678;
    $fechaXml = fecha_claveSri($fechaDocumento);

    $claveAcceso = $fechaXml . $tipDocumento . $empr_ruc_empr . $sucu_tip_ambi . $serieDocumento . $secuencialDocumento . $num8 . $sucu_tip_emis;
    $digitoVerificador = digitoVerificadorSri($claveAcceso);

    $claveAcceso = $claveAcceso . $digitoVerificador;

    return $claveAcceso;
}

function fecha_claveSri($fecha)
{
    $fecha_array = explode('-', $fecha);
    $m = $fecha_array[1];
    $d = $fecha_array[2];
    $y = $fecha_array[0];

    return ($d . '' . $m . '' . $y);
}

function digitoVerificadorSri($cadena)
{
    $pivote = 7;

    $longitudCadena = strlen($cadena);
    for ($i = 0; $i < $longitudCadena; $i++) {
        if ($pivote == 1)
            $pivote = 7;
        $caracter = substr($cadena, $i, 1);
        $temporal = $caracter * $pivote;
        $pivote--;
        $cantidadTotal += $temporal;
    }

    $div = $cantidadTotal % 11;
    $digitoVerificador = 11 - $div;

    if ($digitoVerificador == 10)
        $digitoVerificador = 1;
    if ($digitoVerificador == 11)
        $digitoVerificador = 0;

    return $digitoVerificador;
}

function updateComprobanteSRI($claveAcceso = '', $numeroAutorizacion = '', $fechaAutorizacion = '', $id_docu = '')
{
    global $DSN, $DSN_Ifx;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idSucursal = $_SESSION['U_SUCURSAL'];
    $user_sri = $_SESSION['U_ID'];

    $sqlUpdaComp = "update saefact set
                    fact_aprob_sri = 'S',
                    fact_auto_sri = '$numeroAutorizacion',
                    fact_user_sri = $user_sri,
                    fact_fech_sri = '$fechaAutorizacion',
                    fact_user_web  = $user_sri,
                    fact_erro_sri  = '',
                    fact_clav_sri  = '$claveAcceso'
                    where fact_cod_fact = $id_docu and
                    fact_cod_empr = $idEmpresa and
                    fact_cod_sucu = $idSucursal ";
    $oIfx->QueryT($sqlUpdaComp);
}

function fecha_mysql_Ymd($fecha)
{
    $fecha_array = explode('/', $fecha);
    $m = $fecha_array[0];
    $y = $fecha_array[2];
    $d = $fecha_array[1];

    return ($y . '/' . $m . '/' . $d);
}

function fecha_mysql_Ymd1($fecha)
{
    $fecha_array = explode('/', $fecha);
    $m = $fecha_array[0];
    $y = $fecha_array[2];
    $d = $fecha_array[1];

    return ($y . '-' . $m . '-' . $d);
}


function primerDiaMes($mes, $anio)
{
    return date('Y/m/d', mktime(0, 0, 0, $mes, 1, $anio));
}

function stock_lote_func($idempresa, $idsucursal, $idbodega, $oIfx, $fecha, $lote, $prod_cod)
{
    $sql = "select 
				sum(case defi_tip_defi
					when '0' then dmov_can_dmov
					when '1' then - dmov_can_dmov
					when '5' then  dmov_can_dmov
					when '6' then - dmov_can_dmov
				end) dmov_can_dmov , dmov_cod_lote, prod_cod_prod, prod_nom_prod
				from saeprbo, saeprod, saedmov, saeminv, saetran, saedefi
				where prbo_cod_prod = prod_cod_prod
				and prbo_cod_empr = prod_cod_empr
				and prbo_cod_sucu = prod_cod_sucu
				and prod_cod_prod = dmov_cod_prod
				and prod_cod_empr = dmov_cod_empr
				and dmov_num_comp = minv_num_comp
				and dmov_num_prdo = minv_num_prdo
				and dmov_cod_empr = minv_cod_empr
				and dmov_cod_ejer = minv_cod_ejer
				and minv_cod_tran = tran_cod_tran
				and minv_cod_empr = tran_cod_empr
				and minv_cod_modu = tran_cod_modu
				and tran_cod_tran = defi_cod_tran
				and tran_cod_empr = defi_cod_empr
				and tran_cod_modu = defi_cod_modu
				and prbo_cod_bode = $idbodega
				and prbo_cod_empr = $idempresa
				and prbo_cod_sucu = $idsucursal
				and prbo_cos_prod = '2'
				and dmov_cod_lote = '$lote'
				and dmov_can_dmov > 0
				and dmov_cod_bode = $idbodega
				and minv_fmov    <= '$fecha'
				and minv_cod_empr = $idempresa
				and dmov_cod_prod = '$prod_cod'
				and defi_tip_defi in ('0','1','5','6')
				group by 2,3,4
				having  sum(case defi_tip_defi
					when '0' then dmov_can_dmov
					when '1' then - dmov_can_dmov
					when '5' then  dmov_can_dmov
					when '6' then - dmov_can_dmov
				end) <> 0

				union all

				select 
				sum( case defi_tip_defi
					when '0' then dmov_can_dmov
					when '1' then - dmov_can_dmov
					when '5' then  dmov_can_dmov
					when '6' then dmov_can_dmov
				end ) dmov_can_dmov,  dmov_cod_lote,  prod_cod_prod, prod_nom_prod
				from saeprbo, saeprod, saedmov, saeminv,saetran, saedefi
				where prbo_cod_prod = prod_cod_prod
				and prbo_cod_empr = prod_cod_empr
				and prbo_cod_sucu = prod_cod_sucu
				and prod_cod_prod = dmov_cod_prod
				and prod_cod_empr = dmov_cod_empr
				and dmov_num_comp = minv_num_comp
				and dmov_num_prdo = minv_num_prdo
				and dmov_cod_empr = minv_cod_empr
				and dmov_cod_ejer = minv_cod_ejer
				and minv_cod_tran = tran_cod_tran
				and minv_cod_empr = tran_cod_empr
				and minv_cod_modu = tran_cod_modu
				and tran_cod_tran = defi_cod_tran
				and tran_cod_empr = defi_cod_empr
				and tran_cod_modu = defi_cod_modu
				and prbo_cod_bode = $idbodega
				and prbo_cod_empr = $idempresa
				and prbo_cod_sucu = $idsucursal
				and prbo_cos_prod = '2'
				and dmov_can_dmov > 0
				and dmov_cod_lote = '$lote'
				and dmov_bod_envi = $idbodega
				and minv_fmov    <= '$fecha' 
				and minv_cod_empr = $idempresa
				and dmov_cod_prod = '$prod_cod'
				and defi_tip_defi in ('0','1','5','6')
				group by 2,3,4

				having sum( case defi_tip_defi
					when '0' then dmov_can_dmov
					when '1' then - dmov_can_dmov
					when '5' then  dmov_can_dmov
					when '6' then dmov_can_dmov
				end ) <> 0
				order by prod_cod_prod  ";

    $stock = 0;
    $cantidad = 0;
    unset($array_stock);
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $cantidad += $oIfx->f('dmov_can_dmov');
                $lote = $oIfx->f('dmov_cod_lote');
                $prod_cod = $oIfx->f('prod_cod_prod');
                $prod_nom = $oIfx->f('prod_nom_prod');
            } while ($oIfx->SiguienteRegistro());
        }
    }

    return $cantidad;
}

function calculaMontoAPagarContrato($idempresa, $idsucursal, $id_clpv, $id_contrato)
{
    //Definiciones
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $granTotal = 0;

    //monto
    $sql = "select clse_cod_prod, clse_cod_bode
            from saeclse
            where clse_cod_empr = $idempresa and
            clse_cod_sucu = $idsucursal and
            clse_Cod_clpv = $id_clpv and
            clse_cod_contr = $id_contrato";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $montoTotal = 0;
            do {
                $clse_cod_prod = $oIfx->f('clse_cod_prod');
                $clse_cod_bode = $oIfx->f('clse_cod_bode');

                //iva ice
                $sql = "select prbo_iva_porc, prbo_ice_porc
                        from saeprbo
                        where prbo_cod_prod = '$clse_cod_prod' and
                        prbo_cod_bode = $clse_cod_bode and
                        prbo_cod_empr = $idempresa and
                        prbo_cod_sucu = $idsucursal";
                if ($oIfxA->Query($sql)) {
                    if ($oIfxA->NumFilas() > 0) {
                        $prbo_iva_porc = $oIfxA->f('prbo_iva_porc');
                        $prbo_ice_porc = $oIfxA->f('prbo_ice_porc');
                    }
                }
                $oIfxA->Free();

                //precio
                $ppr_pre_raun = 0;
                $sql = "select ppr_pre_raun 
                        from saeppr 
                        where ppr_cod_prod = '$clse_cod_prod' and 
                        ppr_cod_bode = $clse_cod_bode and
                        ppr_cod_empr = $idempresa and
                        ppr_cod_sucu = $idsucursal";
                if ($oIfxA->Query($sql)) {
                    if ($oIfxA->NumFilas() > 0) {
                        $ppr_pre_raun = $oIfxA->f('ppr_pre_raun');
                    }
                }
                $oIfxA->Free();

                $subTotal = round($ppr_pre_raun, 2);
                $totalIce = 0;
                if ($prbo_ice_porc > 0) {
                    $totalIce = round($ppr_pre_raun * $prbo_ice_porc / 100, 2);
                    $subTotal += $totalIce;
                }

                $granTotal = $subTotal;
                $totalIva = 0;
                if ($prbo_iva_porc > 0) {
                    $totalIva = round($subTotal * $prbo_iva_porc / 100, 2);
                    $granTotal += $totalIva;
                }

            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    return $granTotal;
}

function calculaMontoReconexion($idempresa, $idsucursal, $id_clpv, $id_contrato, $fecha)
{
    //Definiciones
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $oConA = new Dbo;
    $oConA->DSN = $DSN;
    $oConA->Conectar();

    //mes - anio
    $mes = substr($fecha, 5, 2);
    $anio = substr($fecha, 0, 4);

    $granTotal = 0;
    $montoTotal = 0;

    //config_corte
    $sql = "select id_bodega, id_prod
            from config_corte
            where id_empresa = $idempresa and
            id_sucursal = $idsucursal";
    if ($oCon->Query($sql)) {
        if ($oCon->NumFilas() > 0) {
            $clse_cod_prod = $oCon->f('id_prod');
            $clse_cod_bode = $oCon->f('id_bodega');
        }
    }
    $oCon->Free();

    //monto
    $sql = "select valor
            from corte_clpv
            where id_empresa = $idempresa and
            id_sucursal = $idsucursal and
            id_clpv = $id_clpv and
            id_contrato = $id_contrato and
            mes = $mes and
            anio = $anio";
    if ($oCon->Query($sql)) {
        if ($oCon->NumFilas() > 0) {
            $valor = $oCon->f('valor');

            //iva ice
            $sql = "select prbo_iva_porc, prbo_ice_porc
                    from saeprbo
                    where prbo_cod_prod = '$clse_cod_prod' and
                    prbo_cod_bode = $clse_cod_bode and
                    prbo_cod_empr = $idempresa and
                    prbo_cod_sucu = $idsucursal";
            if ($oIfx->Query($sql)) {
                if ($oIfx->NumFilas() > 0) {
                    $prbo_iva_porc = $oIfx->f('prbo_iva_porc');
                    $prbo_ice_porc = $oIfx->f('prbo_ice_porc');
                }
            }
            $oIfx->Free();

            //precio
            $ppr_pre_raun = 0;
            $sql = "select ppr_pre_raun 
                    from saeppr 
                    where ppr_cod_prod = '$clse_cod_prod' and 
                    ppr_cod_bode = $clse_cod_bode and
                    ppr_cod_empr = $idempresa and
                    ppr_cod_sucu = $idsucursal";
            if ($oIfx->Query($sql)) {
                if ($oIfx->NumFilas() > 0) {
                    $ppr_pre_raun = $oIfx->f('ppr_pre_raun');
                }
            }
            $oIfx->Free();

            $subTotal = round($ppr_pre_raun, 2);

            $totalIce = 0;
            if ($prbo_ice_porc > 0) {
                $totalIce = round($ppr_pre_raun * $prbo_ice_porc / 100, 2);
                $subTotal += $totalIce;
            }

            $granTotal = $subTotal;
            $totalIva = 0;
            if ($prbo_iva_porc > 0) {
                $totalIva = round($subTotal * $prbo_iva_porc / 100, 2);
                $granTotal += $totalIva;
            }

        }
    }
    $oCon->Free();

    return $granTotal;
}

function controlEjercicio($empresa, $anio)
{
    global $DSN, $DSN_Ifx;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    //ejercicio
    $sqlEjercicio = "select count(*) as control
					from saeejer 
					where
					ejer_cod_empr = $empresa and
					DATE_PART('year',ejer_fec_inil) = '$anio'";
    $control = consulta_string_func($sqlEjercicio, 'control', $oIfx, 0);

    return $control;
}

function controlPeriodo($empresa, $anio, $periodo)
{
    global $DSN, $DSN_Ifx;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    //ejercicio
    $sqlEjercicio = "select ejer_cod_ejer
					from saeejer 
					where
					ejer_cod_empr = $empresa and
					EXTRACT( 'year' from ejer_fec_inil) = '$anio'";
    $ejer_cod_ejer = consulta_string_func($sqlEjercicio, 'ejer_cod_ejer', $oIfx, 0);

    $sqlPeriodo = "select prdo_est_prdo 
					from saeprdo 
					where prdo_cod_empr = $empresa and 
					prdo_cod_ejer = $ejer_cod_ejer and 
					prdo_num_prdo = $periodo";
    $prdo_est_prdo = consulta_string_func($sqlPeriodo, 'prdo_est_prdo', $oIfx, '');

    return $prdo_est_prdo;
}

function _data_first_month_day($month, $year)
{
    return date('Y-m-d', mktime(0, 0, 0, $month, 1, $year));
}

function calculaCostoPlanificado($idProy = 0, $idTree = 0, $cantidad = 0)
{
    global $DSN, $DSN_Ifx;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    //variables de session
    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idSucursal = $_SESSION['U_SUCURSAL'];
    $user_sri = $_SESSION['U_ID'];

    //tipo presupuesto
    $sql = "select id, nombre 
			from comercial.tipo_presupuesto 
			where id_empresa = $idEmpresa";
    if ($oCon->Query($sql)) {
        if ($oCon->NumFilas() > 0) {
            unset($arrayTipo);
            do {
                $arrayTipo[] = $oCon->f('id');
            } while ($oCon->SiguienteRegistro());
        }
    }
    $oCon->Free();

    //query costo planificado
    $sql = "select id_tipo, sum(total) as total
			from comercial.presupuesto_proy
			where id_tree = $idTree and
			id_proyecto = $idProy
			group by 1";
    if ($oCon->Query($sql)) {
        if ($oCon->NumFilas() > 0) {
            unset($arrayPresupuesto);
            do {
                $id_tipo = $oCon->f('id_tipo');
                $total = round($oCon->f('total'), 2);

                $arrayPresupuesto[$id_tipo] = $total;
            } while ($oCon->SiguienteRegistro());
        }
    }
    $oCon->Free();

    //query iteraciones
    $sql = "select count(e.id) as iteracion
			from comercial.ejecucion_proy e
			where e.id_tree =  $idTree and
			e.id_proyecto = $idProy
            group by e.id
			order by e.id desc";
    $iteracion = consulta_string($sql, 'iteracion', $oCon, 0);

    $ejecutadoALaFecha = 0;
    if (count($arrayTipo)) {
        foreach ($arrayTipo as $val) {
            $idTipo = $val[0];

            $valorPlanificadoTipo = $arrayPresupuesto[$idTipo];

            $ejecutadoALaFecha += $valorPlanificadoTipo * $iteracion;
        }
    }

    $ejecutadoALaFecha = $ejecutadoALaFecha;

    return $ejecutadoALaFecha;

}

//// rol de nomina

function envio_correo_adj_rol($correo, $id_anio, $id_mes, $id_empl) {
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    //variables de session
    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idSucursal = $_SESSION['U_SUCURSAL'];

    $sqlempl="select concat(empl_nom_empl, ' ', empl_ape_empl) as nombres  from saeempl where empl_cod_empl='$id_empl'";
    $empleado=consulta_string($sqlempl,'nombres',$oIfx,'');

    $sqlEmpr = "select empr_nom_empr, empr_dir_empr, empr_tel_resp, empr_token_api from saeempr where empr_cod_empr = $idEmpresa";
    if ($oIfx->Query($sqlEmpr)) {
        $compania = $oIfx->f("empr_nom_empr");
        $dirMatriz = $oIfx->f('empr_dir_empr');
        $empr_tel_resp = $oIfx->f("empr_tel_resp");
        $empr_api_toke = $oIfx->f("empr_token_api");
    }
    $oIfx->Free();

    $sql="select prdo_num_prdo, prdo_nom_prdo  from saeprdo where prdo_num_prdo='$id_mes' group by 1,2 order by 1";

    if($oIfx->Query($sql)){
        if($oIfx->NumFilas()>0){
            $mes=$oIfx->f('prdo_nom_prdo');
        }
    }

    $sqlSmtp = "select server, port, auth, 
    config_email.user, pass, ssltls, mail
    from comercial.config_email
    where id_empresa =$idEmpresa and
			id_tipo = 1";

    if ($oCon->Query($sqlSmtp)) {
        if ($oCon->NumFilas() > 0) {
            $host = $oCon->f('server');
            $port = $oCon->f('port');
            $smtpauth = $oCon->f('auth');
            $userid = $oCon->f('user');
            $smtpsecure = $oCon->f('ssltls');
            $mailenvio = $oCon->f('mail');
            $password = $oCon->f('pass');
        }
    }
    $oCon->Free();

    //mail de envio

    $sqlr="select prrh_val_prrh from saeprrh where prrh_cod_prrh = 'ERRHH'";
    $correo_rrh=consulta_string($sqlr,'prrh_val_prrh',$oIfx,'');
    if(!empty($correo_rrh)){
        $mailenvio =$correo_rrh;
    }



    $secure_type=$smtpsecure;


    $html1="Estimado (a): $empleado<br><br>
			Adjunto al presente encontrara su rol de pagos correspondiente al mes de ".$mes." de ".$id_anio.". <br><br>";
    $html2="<br>Atentamente,<br>
    $compania <br><br>";

    $sHtml=$html1.$html2;


    $nombre_archivo = 'RECIBO_PAGO_'.$id_anio.'_'.$id_mes.'_'.$id_empl;
    $pdf = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $subject = 'ROL DE PAGO';
    $fromname = "Sistema Web $compania";
    $addbcc = $email;




    $archivo_ride = file_get_contents($pdf);
    $archivo_ride = base64_encode($archivo_ride);


    $headers = array(
        "Content-Type:application/json",
        "Token-Api:$empr_api_toke"
    );

    
    $correo = array(trim($correo));
    //$correocc = array(trim($mailenvio));
    $correocc = array();
    $data = array(
        "smtp_server" => $host.":".$port,
        "secure_type" => $secure_type,
        "username" => $userid,
        "password" => $password,
        "from_address" => $mailenvio,
        "to_address" =>  $correo,
        "to_cc" =>  $correocc,
        "title" => $subject,
        "content" => $sHtml,
        "attachments" => array(
            array(
                "name"=>$nombre_archivo.".pdf","content"=>$archivo_ride
            )
        )
    );

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_URL, URL_JIREH_WS_CORREOS."/api/v1/correo/enviar");
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $respuesta = curl_exec($ch);

    

    $resultado = json_decode($respuesta,true);

    $mensaje = $resultado["msg"];
    $enviado = $resultado["result"];


    if($enviado == true){
        return "Mail Enviado!";
    }else{
        return "Error al enviar email".$mensaje.$enviado ;
    }

}


function rol_individual_old($id_empresa = 0, $id_anio = 0, $id_mes = 0, $id_empl = '', $id_depar = 0, $id_proyecto = 0, $pago_cod_estr = '', $fecha_rol = '', &$rutaPdf = '')
{
    //Definiciones
    global $DSN_Ifx;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();


    $oIfxB = new Dbo;
    $oIfxB->DSN = $DSN_Ifx;
    $oIfxB->Conectar();


    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();

    $oIfxD = new Dbo;
    $oIfxD->DSN = $DSN_Ifx;
    $oIfxD->Conectar();

    $oReturn = new xajaxResponse();

    //anio - mes
    $opAnio = 0;
    if ($id_anio == 2017) {
        $opAnio = 1;
    }
    $condicion_fecha = '';
    if ($fecha_rol != '') {
        $condicion_fecha = "and pago_fec_real='$fecha_rol'";
    }
    $nombre_archivo = 'RECIBO_PAGO_' . $id_anio . '_' . $id_mes . '_' . $id_empl;
    $sql = "select pago_fec_real, pago_cod_estr
			from saepago 
			where pago_cod_empl='$id_empl' and 
				pago_cod_empr='$id_empresa' and
				SUBSTR(cast (pago_per_pago as text), 0, 5) = '$id_anio' and
				SUBSTR(cast (pago_per_pago as text), 5, 2) = '$id_mes'  and pago_ori_gene='R'
				$condicion_fecha
				group by 1,2";
    //echo $sql;exit;
    $ban_anti = false;
    if ($oIfxD->query($sql)) {
        if ($oIfxD->NumFilas() > 0) {
            do {
                $table_op = "";
                $legend = "";
                $pago_fec_real = $oIfxD->f('pago_fec_real');
                $id_depar = $oIfxD->f('pago_cod_estr');

                $sql_depar = '';
                if (!empty($id_proyecto)) {
                    if (!empty($id_depar)) {
                        $sql_depar = " and pago_cod_empl in (  select  esem_cod_empl from saeestr, saeesem where
														estr_cod_estr = esem_cod_estr and
														estr_cod_empr = $id_empresa and
														estr_cod_padr  in ( '$id_depar' )
														group by 1 ) ";
                    } else {
                        $sql_depar = " and pago_cod_empl in (  select  esem_cod_empl from saeestr, saeesem where
														estr_cod_estr = esem_cod_estr and
														estr_cod_empr = $id_empresa and
														estr_cod_padr  in ( select estr_cod_estr
																				from saeestr where
																				estr_cod_empr = $id_empresa and
																				estr_cod_gpro = '$id_proyecto'  )
														group by 1 ) ";
                    }
                }

                $sql_empl = '';

                $sql_empl = " and pago_cod_empl = '$id_empl' ";


                $sql = "select empr_nom_empr, empr_path_logo from saeempr where empr_cod_empr = $id_empresa ";
                $empr_nom = consulta_string_func($sql, 'empr_nom_empr', $oIfxA, '');
                $empr_path_logo = consulta_string_func($sql, 'empr_path_logo', $oIfxA, '');

                //rubro sueldo
                $sql = "select rubr_cod_rubr from saerubr where rubr_tsu_rubr = '1'";
                $rubroSueldo = consulta_string_func($sql, 'rubr_cod_rubr', $oIfxA, '');

                //$oReturn->alert($sql);
                unset($tot_ingr);
                unset($array_table_ingr);
                unset($array_tmp);
                //// prestamos

                $sql = "select sum(cuot_mot_capi) as valor, pret_cod_empl, tpre_cod_rubr
					from saecuot  c
					 inner join saepret on pret_cod_pret = cuot_cod_pret
					inner join saetpre on tpre_cod_tpre = pret_cod_tpre
					 where 
					pret_cod_empr=tpre_cod_empr and 
					pret_cod_empr=$id_empresa group by pret_cod_empl , tpre_cod_rubr
					";
                unset($array_prest_pen);
                if ($oIfx->Query($sql)) {
                    if ($oIfx->NumFilas() > 0) {
                        do {
                            $array_prest_pen[$oIfx->f('pret_cod_empl')][$oIfx->f('tpre_cod_rubr')] = $oIfx->f('valor');
                        } while ($oIfx->SiguienteRegistro());
                    }
                }

                //	var_dump($array_prest_pen);exit;
                // EGRESOS
                if (($id_mes < 12) && ($id_anio == 2017)) {
                    $sql = "select  
							pago_cod_rubr, pago_cod_empl,   pago_per_pago, 
							pago_val_pago,  rubr_des_rubr,
							rubr_cod_trub
							from saepago,
							saerubr
							where
							rubr_cod_rubr = pago_cod_rubr and
							rubr_cod_empr = $id_empresa and
							pago_cod_empr = $id_empresa and
							SUBSTR(cast (pago_per_pago as text), 0, 5) = '$id_anio' and
							SUBSTR(cast (pago_per_pago as text), 5, 2) = '$id_mes' and
							rubr_cod_trub = 'D'	AND rubr_cod_rubr<>'RIESS' and pago_fec_real='$pago_fec_real' and pago_ori_gene='R'
							$sql_empl 
							order by pago_cod_empl";
                } else {
                    $sql = "select  
							pago_cod_rubr, pago_cod_empl,   pago_per_pago, 
							pago_val_pago,  rubr_des_rubr,
							rubr_cod_trub
							from saepago,
							saerubr
							where
							rubr_cod_rubr = pago_cod_rubr and
							rubr_cod_empr = $id_empresa and
							pago_cod_empr = $id_empresa and
							SUBSTR(cast (pago_per_pago as text), 0, 5) = '$id_anio' and
							SUBSTR(cast (pago_per_pago as text), 5, 2) = $id_mes and
							rubr_cod_trub = 'D'	 and pago_fec_real='$pago_fec_real' and pago_ori_gene='R'
							$sql_empl 
							order by pago_cod_empl";
                }


                //echo $sql;exit;
                unset($tot_egre);
                $tabla_egre = '';
                unset($array_table_egre);
                unset($array_tmp);

                $tmp = 1;
                $ban = 0;
                if ($oIfx->Query($sql)) {
                    if ($oIfx->NumFilas() > 0) {
                        do {

                            $cod_empl = $oIfx->f('pago_cod_empl');
                            $rubr_cod = $oIfx->f('pago_cod_rubr');
                            $pago_per = $oIfx->f('pago_per_pago');
                            $pago_val = $oIfx->f('pago_val_pago');
                            $rubr_des = $oIfx->f('rubr_des_rubr');
                            $rubr_tipo = $oIfx->f('rubr_cod_trub');

                            $array_tmp [$tmp] = $cod_empl;
                            if ($tmp > 1) {
                                if ($array_tmp[$tmp] != $array_tmp[$tmp - 1]) {
                                    $tabla_egre = '';
                                }
                            }
                            if (($tmp == 1) && ($id_mes >= 12) && ($id_anio >= 2017) && ($ban == 0) && ($ban_anti == false)) {
                                $sql = "select estr_cod_ppag from saeestr where estr_cod_estr='$id_depar' and estr_cod_empr='$id_empresa'";
                                $control_estr = consulta_string($sql, 'estr_cod_ppag', $oIfx, '');
                                //echo $sql;exit;
                                if ($control_estr == 1) {
                                    unset($tablaAnticipo);
                                    $sql = "SELECT 
											anti_obs_anti,
											anti_val_anti 
										FROM saeanti 
											where anti_cod_empl= $cod_empl and 
											DATE_PART('year',anti_fec_anti) = $id_anio and
											DATE_PART('month',anti_fec_anti) = $id_mes";

                                    if ($oIfxC->Query($sql)) {
                                        $obs = $oIfxC->f('anti_obs_anti');
                                        $val = $oIfxC->f('anti_val_anti');
                                        $ban = 1;
                                        if ($val != '0.0') {
                                            $tabla_egre .= '<tr>';
                                            $tabla_egre .= '<td align="left" style="width: 80%;">' . $obs . '</td>';
                                            $tabla_egre .= '<td align="right" style="width: 20%;">' . number_format($val, 2, '.', ',') . '</td>';
                                            $tabla_egre .= '</tr>';
                                        }

                                    }

                                    $tot_egre [$cod_empl] += $val;
                                    $ban_anti = true;
                                }
                            }

                            if ($sClass == 'off') $sClass = 'on'; else $sClass = 'off';
                            if (empty($array_prest_pen[$cod_empl][$rubr_cod])) {
                                $tabla_egre .= '<tr>';
                                $tabla_egre .= '<td align="left" width="70%;">' . $rubr_des . '</td>';
                                $tabla_egre .= '<td  align="right" width="15%;">' . number_format($pago_val, 2, '.', ',') . '</td>';
                                $tabla_egre .= '<td  align="right" width="15%;"></td>';
                                $tabla_egre .= '</tr>';
                            } else {
                                $tabla_egre .= '<tr>';
                                $tabla_egre .= '<td align="left" width="70%;">' . $rubr_des . '</td>';
                                $tabla_egre .= '<td align="right" width="15%;">' . number_format($pago_val, 2, '.', ',') . '</td>';
                                $tabla_egre .= '<td align="right" width="15%;">' . number_format($array_prest_pen[$cod_empl][$rubr_cod], 2, '.', ',') . '</td>';
                                $tabla_egre .= '</tr>';
                            }

                            $array_table_egre [$cod_empl] = $tabla_egre;

                            $tot_egre [$cod_empl] += $pago_val;
                            $tmp++;


                        } while ($oIfx->SiguienteRegistro());
                    }
                }
                $oIfx->Free();

                //anticipo
                $anticipo = 0;
                if (($val == 0) && ($ban_anti == false)) {
                    $sql = "select estr_cod_ppag from saeestr where estr_cod_estr='$id_depar' and estr_cod_empr='$id_empresa'";
                    $control_estr = consulta_string($sql, 'estr_cod_ppag', $oIfx, '');
                    //echo $sql;exit;
                    if ($control_estr == 1) {
                        $sql = "select sum(anti_val_anti) as anticipo 
						from saeanti
						where anti_cod_empl = '$id_empl' and
						anti_cod_empr = $id_empresa and
						DATE_PART('year',anti_fec_anti) = $id_anio and
						DATE_PART('month',anti_fec_anti) = $id_mes";
                        $anticipo = consulta_string_func($sql, 'anticipo', $oIfx, 0);
                        $ban_anti = true;
                    }
                }

                /*if($anticipo > 0){
			$tablaAnticipo .='<tr>';
			$tablaAnticipo .='<td align="left">PAGO QUINCENA</td>';
			$tablaAnticipo .='<td align="right">'.number_format($anticipo, 2, '.', ',').'</td>';
			$tablaAnticipo .='</tr>';

			$array_table_egre[$id_empl] .= $tablaAnticipo;
			$tot_egre[$id_empl] += $anticipo;
		}*/

                //$table_op .='<div width="80%" syle="margin-top: 5px;">';

                ///$table_op .='<div width="80%" syle="margin-top: 15px;">';


                $sql = "select pago_cod_empl
				from saepago, saerubr	where
				rubr_cod_rubr = pago_cod_rubr and
				rubr_cod_empr = pago_cod_empr and
				rubr_cod_empr = $id_empresa and						 
				pago_cod_empr = $id_empresa and
				SUBSTR(cast (pago_per_pago as text), 0, 5) = '$id_anio' and
				SUBSTR(cast (pago_per_pago as text), 5, 2) = '$id_mes' and pago_fec_real='$pago_fec_real' and pago_ori_gene='R'
				$sql_empl 
				$sql_depar
				group by 1
				order by pago_cod_empl";
                $ingr = 0;
                $egre = 0;
                if ($oIfx->Query($sql)) {
                    if ($oIfx->NumFilas() > 0) {
                        do {
                            $cod_empl = $oIfx->f('pago_cod_empl');

                            $tabla_ingr = $array_table_ingr[$cod_empl];
                            $tabla_egre = $array_table_egre[$cod_empl];

                            $egre = $tot_egre [$cod_empl];
                            $ingr = $tot_ingr [$cod_empl];

                            $sql = "select empl_ape_nomb , empl_sal_sala, empl_jor_trab, empl_val5_empl, empl_num_ctas 
								from saeempl 
								where empl_cod_empr = $id_empresa and 
								empl_cod_empl = '$cod_empl' ";
                            $empl_nom = consulta_string_func($sql, 'empl_ape_nomb', $oIfxA, '');
                            $salario = consulta_string_func($sql, 'empl_sal_sala', $oIfxA, '');
                            $empl_jor_trab = consulta_string_func($sql, 'empl_jor_trab', $oIfxA, '');
                            $empl_val5_empl = consulta_string_func($sql, 'empl_val5_empl', $oIfxA, '');
                            $empl_num_ctas = consulta_string_func($sql, 'empl_num_ctas', $oIfxA, '');

                            if ($opAnio == 0) {
                                $sueldo = $salario;
                            } else {
                                $sueldo = $empl_val5_empl;
                            }


                            $sql = "select estr_des_estr, esem_fec_ingr  from saeesem, saeestr where
									estr_cod_estr = esem_cod_estr and
									estr_cod_empr = $id_empresa and
									esem_cod_empl = '$cod_empl' and 
									esem_cod_empr = $id_empresa and
                                    esem_fec_sali is null
                                    order by 2 asc limit 1";
                            $cargo = consulta_string_func($sql, 'estr_des_estr', $oIfxA, '');

                            $sql_tmp = "select estr_cod_padr  from saeesem, saeestr where
									estr_cod_estr = esem_cod_estr and
									estr_cod_empr = $id_empresa and
									esem_cod_empl =  '$cod_empl'  and 
									esem_cod_empr = $id_empresa ";


                            if ($oIfxB->Query($sql_tmp)) {
                                if ($oIfxB->NumFilas() > 0) {
                                    $estr_tmp = $oIfxB->f('estr_cod_padr');
                                }
                            }
                            $oIfxB->Free();

                            $sql_p = "select estr_des_estr  from saeestr where 
									estr_cod_empr = $id_empresa and
									estr_cod_estr = '$estr_tmp'  ";
                            if ($oIfxB->Query($sql_p)) {
                                if ($oIfxB->NumFilas() > 0) {
                                    $estr_nom = $oIfxB->f('estr_des_estr');
                                }
                            }
                            $oIfxB->Free();


                            // HORAS EXTRAS
                            $sql = "select  amem_hor_trab, amem_hor_atra, amem_hor_falt,
										amem_hor_perm, amem_hor_e025, amem_hor_lice,
										amem_hor_e050,  amem_hor_e100,  amem_hor_vaca, amem_hor_mate, amem_hor_efer, amem_hor_sein
								from 	saeamem where
										amem_cod_empr = $id_empresa and
										amem_cod_empl = '$cod_empl'  and
										amem_fec_amem = '$pago_fec_real' ";

                            //echo $sql;exit;
                            if ($oIfxB->Query($sql)) {
                                if ($oIfxB->NumFilas() > 0) {
                                    $hor_trab = $oIfxB->f('amem_hor_trab');
                                    $hor_atra = ($oIfxB->f('amem_hor_atra') / 8);
                                    $hor_falt = ($oIfxB->f('amem_hor_falt') / 8);
                                    $hor_perm = ($oIfxB->f('amem_hor_perm'));
                                    $hor_25 = $oIfxB->f('amem_hor_e025');
                                    $hor_50 = $oIfxB->f('amem_hor_e050');
                                    $hor_100 = $oIfxB->f('amem_hor_e100');
                                    $hor_vaca = $oIfxB->f('amem_hor_vaca');
                                    $hor_mater = $oIfxB->f('amem_hor_mate');
                                    $hor_sein = ($oIfxB->f('amem_hor_sein') / 8);
                                    //$hor_sein= ($oIfxB->f('amem_hor_mate')/8);
                                    $hor_lice = vacios($oIfxB->f('amem_hor_lice'), '0.0');
                                    $hor_efer = vacios($oIfxB->f('amem_hor_efer'), '0.0');
                                    $hor_trab = ($hor_trab - $hor_lice - $hor_efer - $hor_vaca);

                                }
                            }

                            // INGRESOS
                            $sql = "select  
							pago_cod_rubr, pago_cod_empl,   pago_per_pago, 
							pago_val_pago,  rubr_des_rubr,
							rubr_cod_trub
							from saepago,
							saerubr
							where
							rubr_cod_rubr = pago_cod_rubr and
							rubr_cod_empr = $id_empresa and						 
							pago_cod_empr = $id_empresa and
							SUBSTR(cast (pago_per_pago as text), 0, 5) = '$id_anio' and
							SUBSTR(cast (pago_per_pago as text), 5, 2) = '$id_mes' and
							rubr_cod_trub = 'I'	and rubr_cod_rubr<>'RSUEN' AND   rubr_cod_rubr<>'RIEAS' and pago_fec_real='$pago_fec_real' and pago_ori_gene='R'
							$sql_empl  
							order by rubr_des_alia";

                            $tabla_ingr = '';
                            $tmp = 1;
                            if ($oIfx->Query($sql)) {
                                if ($oIfx->NumFilas() > 0) {
                                    do {
                                        $cod_empl = $oIfx->f('pago_cod_empl');
                                        $rubr_cod = $oIfx->f('pago_cod_rubr');
                                        $pago_per = $oIfx->f('pago_per_pago');
                                        $pago_val = $oIfx->f('pago_val_pago');
                                        $rubr_des = $oIfx->f('rubr_des_rubr');
                                        $rubr_tipo = $oIfx->f('rubr_cod_trub');
                                        $array_tmp [$tmp] = $cod_empl;

                                        /*if($rubr_cod == $rubroSueldo){
										$salario = $pago_val;
									}*/

                                        if ($tmp > 1) {
                                            if ($array_tmp[$tmp] != $array_tmp[$tmp - 1]) {
                                                $tabla_ingr = '';
                                            }
                                        }

                                        $fecha_ingreso = ingreso_fecha($cod_empl);
                                        $fecha_ingreso_cargo = ingreso_fecha_cargo($cod_empl);
                                        $ban = 0;
                                        $tabla_ingr .= '<tr>';
                                        $tabla_ingr .= '<td align="left">' . $rubr_des . '</td>';
                                        if ($rubr_cod == 'RHEVC') {
                                            $tabla_ingr .= '<td align="left"></td>';
                                            $tabla_ingr .= '<td align="left">' . $hor_25 . '</td>';

                                            $ban = 1;
                                        }
                                        if ($rubr_cod == 'RHECI') {
                                            $tabla_ingr .= '<td align="left"></td>';
                                            $tabla_ingr .= '<td align="left">' . $hor_100 . '</td>';
                                            //$tabla_ingr .='<td align="left"></td>';
                                            $ban = 1;
                                        }
                                        if ($rubr_cod == 'RHECC') {
                                            $tabla_ingr .= '<td align="left"></td>';
                                            $tabla_ingr .= '<td align="left">' . $hor_50 . '</td>';
                                            //$tabla_ingr .='<td align="left"></td>';
                                            $ban = 1;
                                        }
                                        if ($rubr_cod == 'RSUEL') {
                                            //$tabla_ingr .='<td align="left">'.$hor_trab.'</td>';

                                            $dias_tra = ($hor_trab / 8);
                                            $tabla_ingr .= '<td align="left">' . $dias_tra . '</td>';
                                            $tabla_ingr .= '<td align="left"></td>';
                                            $ban = 1;
                                        }
                                        if ($rubr_cod == 'RLICE') {
                                            //$tabla_ingr .='<td align="left">'.$hor_lice.'</td>';
                                            //$tabla_ingr .='<td align="left"></td>';
                                            $dias_lice = ($hor_lice / 8);
                                            $tabla_ingr .= '<td align="left">' . $dias_lice . '</td>';
                                            $tabla_ingr .= '<td align="left"></td>';
                                            $ban = 1;
                                        }
                                        if ($rubr_cod == 'RLICD') {
                                            //$tabla_ingr .='<td align="left">'.$hor_efer.'</td>';
                                            //$tabla_ingr .='<td align="left"></td>';
                                            $dias_efer = ($hor_efer / 8);
                                            $tabla_ingr .= '<td align="left">' . $dias_efer . '</td>';
                                            $tabla_ingr .= '<td align="left"></td>';
                                            $ban = 1;
                                        }
                                        if ($rubr_cod == 'RVACP') {
                                            //$tabla_ingr .='<td align="left">'.$hor_vaca.'</td>';
                                            //$tabla_ingr .='<td align="left"></td>';
                                            $dias_vaca = ($hor_vaca / 8);
                                            $tabla_ingr .= '<td align="left">' . $dias_vaca . '</td>';
                                            $tabla_ingr .= '<td align="left"></td>';
                                            $ban = 1;
                                        }
                                        if ($rubr_cod == 'RMATE') {
                                            //$tabla_ingr .='<td align="left">'.$hor_vaca.'</td>';
                                            //$tabla_ingr .='<td align="left"></td>';
                                            $dias_mater = ($hor_mater / 8);
                                            $tabla_ingr .= '<td align="left">' . $dias_mater . '</td>';
                                            $tabla_ingr .= '<td align="left"></td>';
                                            $ban = 1;
                                        }
                                        if ($ban == 0) {
                                            $tabla_ingr .= '<td align="left"></td>';
                                            $tabla_ingr .= '<td align="left"></td>';
                                        }
                                        $tabla_ingr .= '<td align="right">' . number_format($pago_val, 2, '.', ',') . '</td>';
                                        $tabla_ingr .= '</tr>';

                                        $array_table_ingr [$cod_empl] = $tabla_ingr;


                                        $tot_ingr += $pago_val;
                                        $tmp++;
                                    } while ($oIfx->SiguienteRegistro());
                                }
                            }

                            $table_op .= '<table align="left" style="width: 100%; border:1px solid black; border-radius: 5px; margin-top: 20px;">';
                            if ($empr_path_logo != '') {
                                $table_op .= '<tr>
										<td colspan="2">
											<img src="' . $empr_path_logo . '" width="250"/>
										</td>
									</tr>';
                            }

                            $table_op .= '<tr>	
										<td class="fecha_letra" style="width: 50%;">EMPRESA: ' . ($empr_nom) . '</td>
										<td class="fecha_letra" style="width: 50%;"></td>
									</tr>
									<tr>	
										<td class="fecha_letra">ROL MES: ' . Mes_func($id_mes) . ' ' . $id_anio . '</td>
										<td class="fecha_letra"></td>
									</tr>
									<tr>	
										<td class="fecha_letra">NOMBRE: ' . $empl_nom . '</td>
										<td class="fecha_letra">CODIGO: ' . $cod_empl . '</td>
									</tr>
									<tr>	
										<td class="fecha_letra">CARGO: ' . $cargo . '</td>
										<td class="fecha_letra">DEPARTAMENTO: ' . $estr_nom . '</td>
									</tr>
									<tr>	
										<td class="fecha_letra">FECHA INGRESO EMPRESA: ' . $fecha_ingreso . '</td>
										<td class="fecha_letra">FECHA INGRESO CARGO: ' . $fecha_ingreso_cargo . '</td>
									</tr>
									<tr>
										<td class="fecha_letra">SALARIO: ' . number_format($sueldo, 2, '.', ',') . '</td>
										<td class="fecha_letra">PERMISOS: ' . $hor_perm . '</td>	
									</tr>
									<tr>
									<td class="fecha_letra">VACACIONES: ' . $hor_vaca . '</td>	
									<td class="fecha_letra">FALTAS INJUSTIFICADAS: ' . $hor_falt . '</td>
									</tr>
									<tr>	
										<td class="fecha_letra">JORNADA DE TRABAJO: ' . $empl_jor_trab . '</td>
										<td class="fecha_letra">LICENCIA SIN SUELDO: ' . $hor_atra . '</td>
									</tr>
									<tr>										
										<td class="fecha_letra">NUMERO DE CUENTA: ' . $empl_num_ctas . '</td>
										<td class="fecha_letra"></td>
									</tr>';
                            $table_op .= '</table>';

                            $table_op .= '<br>';

                            $table_op .= '<table style="width: 100%; margin-top: 10px;" border="1" style="border-collapse: collapse;">';
                            $table_op .= '<tr>
										<td width="50%">INGRESOS</td>
										<td width="50%">DESCUENTOS</td>
									</tr>';
                            $table_op .= '<tr>
										<td valign="top" style="width: 52%;">
											<table align="center" border="1" width="99%" style="border-collapse: collapse;">												
												<tr>
													<td style="width: 69%;">DESCRIPCION</td>
													<td style="width: 8%;">DIAS</td>
													<td style="width: 10%;">HORAS</td>
													<td style="width: 10%;">VALOR</td>
												</tr>
												' . $tabla_ingr . '
											</table>
										</td>
										<td valign="top" style="width: 48%;">
											<table  border="1" width="99%" style="border-collapse: collapse;">	
													<tr>
													<td style="width: 69%;">DESCRIPCION</td>
													<td style="width: 15%;">VALOR</td>
													<td style="width: 15%;">SAL PRES</td>
												</tr>											
												' . $tabla_egre . '
											</table>	
										</td>
									</tr>';

                            $table_op .= '<tr>
										<td valign="top" style="width: 50%;">
											<table align="center" border="0" width="99%" style="border-collapse: collapse;">		
												<tr>
													<td></td>
													<td align="right" width="80%;">TOTAL INGRESO:</td>
													<td align="right" width="20%;">' . number_format($tot_ingr, 2, '.', ',') . '</td>
												</tr>
											</table>	
										</td>
										<td valign="top" style="width: 50%;">
											<table align="center" border="0" width="99%" style="border-collapse: collapse;">		
												<tr>
													<td></td>
													<td align="right" width="80%;">TOTAL EGRESO:</td>
													<td align="right" width="20%;">' . number_format($egre, 2, '.', ',') . '</td>
												</tr>
											</table>	
										</td>
									</tr>';
                            $total_recibi = $tot_ingr - $egre;
                            $table_op .= '<tr>
										<td valign="top" style="width: 50%;">
											<table align="center" border="0" width="99%" style="border-collapse: collapse;">		
												<tr>
													<td colspan="3"></td>
												</tr>
											</table>	
										</td>
										<td valign="top" style="width: 50%;">
											<table align="center" border="0" width="99%" style="border-collapse: collapse;">		
												<tr>
													<td></td>
													<td class="fecha_letra" align="right" width="80%;">TOTAL A RECIBIR:</td>
													<td class="fecha_letra" align="right" width="20%;">' . number_format($total_recibi, 2, '.', ',') . '</td>
												</tr>
											</table>	
										</td>
										</tr>';
                            $table_op .= "</table>";

                        } while ($oIfx->SiguienteRegistro());

                    }
                }

                //$table_op .="</div>";
                $legend .= ' <br><br><br><br><br>
						<table style="width: 100%; " border="0" >
							<tr>
								<td style="width: 50%;" align="center">
									_________________________ <br>
											<h5>' . $empr_nom . '</h5><br><br>
									
								</td>
								<td style="width: 50%;" align="center">
									_______________________________ <br>
										<h5 style="text-align: center;">' . $empl_nom . '<br>' . $cod_empl . '</h5><br><br>
									
								</td>
							</tr>
					</table>';


                $documento .= '<page backimgw="10%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
                $documento .= $table_op;
                $documento .= $legend;
                $documento .= '</page>';

            } while ($oIfxD->SiguienteRegistro());
        }
    }


    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;

    return $documento;
}


function rol_individual_personalizado($id_empresa = 0, $id_anio = 0, $id_mes = 0, $id_empl = '', $id_depar = 0, $id_proyecto = 0, $pago_cod_estr = '', $fecha_rol = '', $rutaPdf = '',$duplicado='N')
{
    //Definiciones
    global $DSN_Ifx;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();


    $oIfxB = new Dbo;
    $oIfxB->DSN = $DSN_Ifx;
    $oIfxB->Conectar();


    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();

    $oIfxD = new Dbo;
    $oIfxD->DSN = $DSN_Ifx;
    $oIfxD->Conectar();

    $oReturn = new xajaxResponse();

    //anio - mes
    $opAnio = 0;
    if ($id_anio == 2017) {
        $opAnio = 1;
    }
    $condicion_fecha = '';
    if ($fecha_rol != '') {
        $condicion_fecha = "and pago_fec_real='$fecha_rol'";
    }
    $nombre_archivo = 'RECIBO_PAGO_' . $id_anio . '_' . $id_mes . '_' . $id_empl;
    
    //Generando Firma
    $sql = "select empl_fir_empl from saeempl 
    where 
    empl_cod_empr = $id_empresa and 
    empl_cod_empl = '$id_empl' 
    ";
    
    $empl_fir_empl = consulta_string_func($sql, 'empl_fir_empl', $oIfxA, '');

    $empl_fir = '<br><br><br><br><br>';
    if(!empty($empl_fir_empl)){
        $dir_fir = DIR_FACTELEC . "Include/Clases/Formulario/Plugins/reloj/" . basename($empl_fir_empl);
        if (file_exists($dir_fir)) {
            $empl_fir = '
                <img 
                    src="' . $dir_fir . '" 
                    style="
                        width:100px;
                        object-fit; 
                        contain;
                    "
                />
            ';
        }
    }
        
    $sql = "select pago_fec_real, pago_cod_estr
            from saepago 
            where pago_cod_empl='$id_empl' and 
                pago_cod_empr='$id_empresa' and
                SUBSTR(cast (pago_per_pago as text), 0, 5) = '$id_anio' and
                SUBSTR(cast (pago_per_pago as text), 5, 2) = '$id_mes'  and pago_ori_gene='R'
                $condicion_fecha
                group by 1,2";

                
    $ban_anti = false;

    if ($oIfxD->query($sql)) {
        if ($oIfxD->NumFilas() > 0) {
            do {
                $table_op = "";
                $legend = "";
                $pago_fec_real = $oIfxD->f('pago_fec_real');
                $id_depar = $oIfxD->f('pago_cod_estr');
                $sql_depar = '';
                if (!empty($id_proyecto)) {
                    if (!empty($id_depar)) {
                        $sql_depar = " and pago_cod_empl in (  select  esem_cod_empl from saeestr, saeesem where
                                                        estr_cod_estr = esem_cod_estr and
                                                        estr_cod_empr = $id_empresa and
                                                        estr_cod_padr  in ( '$id_depar' )
                                                        group by 1 ) ";
                    } else {
                        $sql_depar = " and pago_cod_empl in (  select  esem_cod_empl from saeestr, saeesem where
                                                        estr_cod_estr = esem_cod_estr and
                                                        estr_cod_empr = $id_empresa and
                                                        estr_cod_padr  in ( select estr_cod_estr
                                                                                from saeestr where
                                                                                estr_cod_empr = $id_empresa and
                                                                                estr_cod_gpro = '$id_proyecto'  )
                                                        group by 1 ) ";
                    }
                }

                $sql_empl = '';

                $sql_empl = " and pago_cod_empl = '$id_empl' ";


                //DATOS DE LA EMPRESA

                $sql = "select empr_nom_empr, empr_path_logo, empr_img_rep from saeempr where empr_cod_empr = $id_empresa ";

                $empr_nom = consulta_string_func($sql, 'empr_nom_empr', $oIfxA, '');
                $empr_path_logo = consulta_string_func($sql, 'empr_img_rep', $oIfxA, '');
                $path_img = explode("/", $empr_path_logo);
                $count = count($path_img) - 1;
                $arc_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];
                //echo $arc_img;exit;
                if (file_exists($arc_img)) {
                    $imagen = $arc_img;
                } else {
                    $imagen = '';
                }

                $logo = '';
                $x = '0px';
                if ($imagen != '') {

                    $empr_logo = '<div align="left">
                        <img src="' . $imagen . '" style="
                        width:200px;">
                        </div>';
                    $x = '0px';
                }
                else{
                    $empr_logo ='<span><font color="red">SIN LOGO</font></span>';
                }

                //MONEDA BASE


                $sql = "select pcon_mon_base, pcon_seg_mone from saepcon where pcon_cod_empr = $id_empresa ";
                $mone_cod = consulta_string_func($sql, 'pcon_mon_base', $oIfx, '');
        
        
        
                $sql_mone_principal = "select * from saemone
                    where mone_cod_empr = $id_empresa
                    and mone_cod_mone = $mone_cod";
        
                if ($oIfx->Query($sql_mone_principal)) {
                    if ($oIfx->NumFilas() > 0) {
                        do {
                            $moneda_principal = trim($oIfx->f('mone_des_mone'));


                        } while ($oIfx->SiguienteRegistro());
                    }
                }



                //rubro sueldo
                $sql = "select rubr_cod_rubr from saerubr where rubr_tsu_rubr = '1'";

                $rubroSueldo = consulta_string_func($sql, 'rubr_cod_rubr', $oIfxA, '');

                //$oReturn->alert($sql);
                unset($tot_ingr);
                unset($array_table_ingr);
                unset($array_tmp);
                //// prestamos

                $sql = "select sum(cuot_mot_capi) as valor, pret_cod_empl, tpre_cod_rubr
                    from saecuot  c
                     inner join saepret on pret_cod_pret = cuot_cod_pret
                    inner join saetpre on tpre_cod_tpre = pret_cod_tpre
                     where 
                    pret_cod_empr=tpre_cod_empr and 
                    pret_cod_empr='1' and cuot_est_cuot='0' group by pret_cod_empl , tpre_cod_rubr
                    ";
                ;
                //echo $sql; exit;
                unset($array_prest_pen);
                if ($oIfx->Query($sql)) {
                    if ($oIfx->NumFilas() > 0) {
                        do {
                            $array_prest_pen[$oIfx->f('pret_cod_empl')][$oIfx->f('tpre_cod_rubr')] = $oIfx->f('valor');
                            //$array_prest_pen[$oIfx->f('pret_cod_empl')]['RCAFE']=$oIfx->f('valor');
                        } while ($oIfx->SiguienteRegistro());
                    }
                }

                //  var_dump($array_prest_pen);exit;
                // EGRESOS
                if (($id_mes < 12) && ($id_anio == 2017)) {
                    $sql = "select  
                            pago_cod_rubr, pago_cod_empl,   pago_per_pago, 
                            pago_val_pago,  rubr_des_rubr,
                            rubr_cod_trub
                            from saepago,
                            saerubr
                            where
                            rubr_cod_rubr = pago_cod_rubr and
                            rubr_cod_empr = $id_empresa and
                            pago_cod_empr = $id_empresa and
                            SUBSTR(cast (pago_per_pago as text), 0, 5) = '$id_anio' and
                            SUBSTR(cast (pago_per_pago as text), 5, 2) = '$id_mes' and
                            rubr_cod_trub = 'D' AND rubr_cod_rubr<>'RIESS' and pago_fec_real='$pago_fec_real' and pago_ori_gene='R'
                            $sql_empl 
                            order by pago_cod_empl";
                    //echo $sql;
                    //echo 'hola 1 ';exit;
                } else {
                    $sql = "select  
                            pago_cod_rubr, pago_cod_empl,   pago_per_pago, 
                            pago_val_pago,  rubr_des_rubr,
                            rubr_cod_trub
                            from saepago,
                            saerubr
                            where
                            rubr_cod_rubr = pago_cod_rubr and
                            rubr_cod_empr = $id_empresa and
                            pago_cod_empr = $id_empresa and
                            SUBSTR(cast (pago_per_pago as text), 0, 5) = '$id_anio' and
                            SUBSTR(cast (pago_per_pago as text), 5, 2) = '$id_mes' and
                            rubr_cod_trub = 'D'  and pago_fec_real='$pago_fec_real' and pago_ori_gene='R'
                            $sql_empl 
                            order by pago_cod_empl";
                    //echo $sql;
                    //echo 'hola 2 ';exit;
                }


                $tot_egre= Array();
                $tabla_egre = '';
                unset($array_table_egre);
                unset($array_tmp);

                $tmp = 1;
                $ban = 0;
                $i = 0;
                if ($oIfx->Query($sql)) {
                    if ($oIfx->NumFilas() > 0) {
                        do {

                            $cod_empl = $oIfx->f('pago_cod_empl');
                            $rubr_cod = $oIfx->f('pago_cod_rubr');
                            $pago_per = $oIfx->f('pago_per_pago');
                            $pago_val = $oIfx->f('pago_val_pago');
                            $rubr_des = $oIfx->f('rubr_des_rubr');
                            $rubr_tipo = $oIfx->f('rubr_cod_trub');

                            $array_tmp [$tmp] = $cod_empl;
                            if ($tmp > 1) {
                                if ($array_tmp[$tmp] != $array_tmp[$tmp - 1]) {
                                    $tabla_egre = '';
                                }
                            }

                            if ($sClass == 'off') $sClass = 'on'; else $sClass = 'off';
                            //var_dump($array_prest_pen);
                            //exit;
                            if (empty($array_prest_pen[$cod_empl][$rubr_cod])) {
                                //if(empty($array_prest_pen[$cod_empl])){
                                //echo 'hola tabla';


                                    $tabla_egre .= '<tr>';
                                    $tabla_egre .= '<td style="font-size:75%;" align="left" width="75%">' . $rubr_des . ':</td>';
                                    $tabla_egre .= '<td style="font-size:75%;" align="right" width="25%"><strong>' . number_format($pago_val, 2, '.', ',') . '</strong></td>';
                                    // $tabla_egre .= '<td>&nbsp;</td>';
                                    $tabla_egre .= '</tr>';

                                    if($rubr_cod == 'RANTI'){
                                        $ban_anti = true;
                                    }

                            }
                            else {

                                if ($rubr_cod == 'RPRES') {
                                    $sql = "
                                        SELECT
                                            sum(cuot_mot_capi) valor
                                            FROM
                                            saepret,
                                            saetpre,
                                            saecuot 
                                        WHERE
                                            pret_cod_tpre = tpre_cod_tpre 
                                            AND pret_cod_pret = cuot_cod_pret 
                                            AND tpre_cod_empr = pret_cod_empr 
                                            AND cuot_est_cuot = 0
                                            AND pret_cod_empl = '$cod_empl' 
                                            AND pret_cod_empr = $id_empresa
                                            AND tpre_cod_rubr = 'RPRES'
                                        ";

                                    $saldo_prestamo = consulta_string($sql, 'valor', $oIfxB, 0);
                                }


                                $tabla_egre .= '<tr>';
                                $tabla_egre .= '<td style="font-size:75%;" align="left" width="75%">' . $rubr_des . ':</td>';
                                $tabla_egre .= '<td style="font-size:75%;" align="right" width="25%"><strong>' . number_format($pago_val, 2, '.', ',') . '</strong></td>';
                                //$tabla_egre .= '<td >' . number_format($array_prest_pen[$cod_empl][$rubr_cod], 2, '.', ',') . '</td>';
                                $tabla_egre .= '</tr>';

                            }

                            //echo $tabla_egre;
                            //exit;

                            $array_table_egre[$cod_empl] = $tabla_egre;

                            $tot_egre [$cod_empl] += $pago_val;
                            $tmp++;

                            //var_dump($array_table_egre);
                            $i++;
                            //var_dump($i.'p');
                        } while ($oIfx->SiguienteRegistro());

                        if (($tmp == 1) && ($id_mes >= 12) && ($id_anio >= 2017) && ($ban == 0) && ($ban_anti == false)) {
                            $sql = "select estr_cod_ppag from saeestr where estr_cod_estr='$id_depar' and estr_cod_empr='$id_empresa'";
                            $control_estr = consulta_string($sql, 'estr_cod_ppag', $oIfxA, '');
                            //echo $sql;exit;
                            if ($control_estr == 1) {
                                unset($tablaAnticipo);
                                $sql = "SELECT 
                                            anti_obs_anti,
                                            anti_val_anti 
                                        FROM saeanti 
                                            where anti_cod_empl= '$cod_empl' and 
                                            DATE_PART('year',anti_fec_anti) = $id_anio and
                                            DATE_PART('month',anti_fec_anti) = $id_mes";
                                //echo $sql;exit;
                                if ($oIfxC->Query($sql)) {
                                    $obs = $oIfxC->f('anti_obs_anti');
                                    $val = $oIfxC->f('anti_val_anti');
                                    //echo $val; exit;
                                    $ban = 1;
                                    //if($val!='0.0'){
                                    if (!empty($val) || $val != '0.0') {

                                        $tabla_egre .= '<tr>';
                                        $tabla_egre .= '<td style="font-size:75%;" width="75%" align="left">' . $obs . ':</td>';
                                        $tabla_egre .= '<td style="font-size:75%;" width="25%" align="right"><strong>' . number_format($val, 2, '.', ',') . '</strong></td>';
                                        //$tabla_egre .= '<td  align="right">&nbsp;</td>';
                                        $tabla_egre .= '</tr>';
                                    }

                                }

                                $tot_egre [$cod_empl] += $val;
                                $ban_anti = true;
                            }
                        }
                    }
                }
                $oIfx->Free();

                //anticipo
                $anticipo = 0;
                if (($val == 0) && ($ban_anti == false)) {
                    $sql = "select estr_cod_ppag from saeestr where estr_cod_estr='$id_depar' and estr_cod_empr='$id_empresa'";
                    $control_estr = consulta_string($sql, 'estr_cod_ppag', $oIfx, '');
                    //echo $sql;exit;
                    if ($control_estr == 1) {
                        $sql = "select sum(anti_val_anti) as anticipo 
                        from saeanti
                        where anti_cod_empl = '$id_empl' and
                        anti_cod_empr = $id_empresa and
                        DATE_PART('year',anti_fec_anti) = $id_anio and
                        DATE_PART('month',anti_fec_anti) = $id_mes";
                        $anticipo = consulta_string_func($sql, 'anticipo', $oIfx, 0);
                        $ban_anti = true;
                    }
                }

                /*if($anticipo > 0){
                $tablaAnticipo .='<tr>';
                $tablaAnticipo .='<td align="left">PAGO QUINCENA</td>';
                $tablaAnticipo .='<td align="right">'.number_format($anticipo, 2, '.', ',').'</td>';
                $tablaAnticipo .='</tr>';

                $array_table_egre[$id_empl] .= $tablaAnticipo;
                $tot_egre[$id_empl] += $anticipo;
                }*/

                //$table_op .='<div width="80%" syle="margin-top: 5px;">';

                ///$table_op .='<div width="80%" syle="margin-top: 15px;">';


                $sql = "select pago_cod_empl
                from saepago, saerubr   where
                rubr_cod_rubr = pago_cod_rubr and
                rubr_cod_empr = pago_cod_empr and
                rubr_cod_empr = $id_empresa and                      
                pago_cod_empr = $id_empresa and
                SUBSTR(cast (pago_per_pago as text), 0, 5) = '$id_anio' and
                SUBSTR(cast (pago_per_pago as text), 5, 2) = '$id_mes' and pago_fec_real='$pago_fec_real' and pago_ori_gene='R'
                $sql_empl 
                $sql_depar
                group by 1
                order by pago_cod_empl";
                //echo $sql;exit;
                $ingr = 0;
                $egre = 0;
                if ($oIfx->Query($sql)) {
                    if ($oIfx->NumFilas() > 0) {
                        do {
                            $cod_empl = $oIfx->f('pago_cod_empl');
                            $tabla_egre = $array_table_egre[$cod_empl];

                            $egre = $tot_egre[$cod_empl];


                            $sql = "select empl_ape_nomb , empl_sal_sala, empl_jor_trab, empl_val5_empl, empl_num_ctas , empl_cod_banc
                                from saeempl 
                                where empl_cod_empr = $id_empresa and 
                                empl_cod_empl = '$cod_empl' ";
                            $empl_nom = consulta_string_func($sql, 'empl_ape_nomb', $oIfxA, '');
                            $salario = consulta_string_func($sql, 'empl_sal_sala', $oIfxA, '');
                            $empl_jor_trab = consulta_string_func($sql, 'empl_jor_trab', $oIfxA, '');
                            $empl_val5_empl = consulta_string_func($sql, 'empl_val5_empl', $oIfxA, '');
                            $empl_num_ctas = consulta_string_func($sql, 'empl_num_ctas', $oIfxA, '');
                            $empl_cod_banc = consulta_string_func($sql, 'empl_cod_banc', $oIfxA, '');

                            $fecha_consulta=$id_anio.'-'.$id_mes.'-01';
                            $fecha_consulta=(date("Y-m-t",(strtotime($fecha_consulta))));


                            $sql = "SELECT hisa_fec_apli, hisa_val_sala FROM saehisa where his_cod_empl='$cod_empl' and hisa_fec_apli>='$fecha_consulta' order by hisa_fec_apli ASC limit 1";
                            $hisa_val_sala  = consulta_string_func($sql, 'hisa_val_sala', $oIfxA, 0);
                            if ($hisa_val_sala>0) {
                                $salario = $hisa_val_sala;
                            }


                            $banco='';
                            if (trim($empl_cod_banc)!='') {
                                $sql = "select banc_nom_banc
                                from saebanc
                                where banc_cod_banc= $empl_cod_banc";
                                $banco = consulta_string_func($sql, 'banc_nom_banc', $oIfxA, '');

                                if ($opAnio == 0) {
                                    $sueldo = $salario;
                                } else {
                                    $sueldo = $empl_val5_empl;
                                }
                            }else{
                                $sueldo = $salario;
                            }


                            $sql = "select estr_des_estr, esem_fec_ingr  from saeesem, saeestr where
                                    estr_cod_estr = esem_cod_estr and
                                    estr_cod_empr = $id_empresa and
                                    esem_cod_empl = '$cod_empl' and 
                                    esem_cod_empr = $id_empresa and
                                    esem_fec_ingr <= '$fecha_consulta'
                                    order by 2 desc limit 1";

                            $cargo = consulta_string_func($sql, 'estr_des_estr', $oIfxA, '');

                            $fech_ing_cargo=consulta_string_func($sql, 'esem_fec_ingr', $oIfxA, '');

                            $sql_tmp = "select estr_cod_padr  from saeesem, saeestr where
                                    estr_cod_estr = esem_cod_estr and
                                    estr_cod_empr = $id_empresa and
                                    esem_cod_empl =  '$cod_empl'  and 
                                    esem_cod_empr = $id_empresa ";



                            if ($oIfxB->Query($sql_tmp)) {
                                if ($oIfxB->NumFilas() > 0) {
                                    $estr_tmp = $oIfxB->f('estr_cod_padr');
                                }
                            }
                            $oIfxB->Free();

                            $sql_p = "select estr_des_estr  from saeestr where 
                                    estr_cod_empr = $id_empresa and
                                    estr_cod_estr = '$estr_tmp'  ";

                            if ($oIfxB->Query($sql_p)) {
                                if ($oIfxB->NumFilas() > 0) {
                                    $estr_nom = $oIfxB->f('estr_des_estr');
                                }
                            }
                            $oIfxB->Free();


                            // HORAS EXTRAS
                            $sql = "select  amem_hor_trab, amem_hor_atra, amem_hor_falt,
                                        amem_hor_perm, amem_hor_e025, amem_hor_lice,
                                        amem_hor_e050,  amem_hor_e100,  amem_hor_vaca, amem_hor_mate, amem_hor_efer, amem_hor_sein
                                from    saeamem where
                                        amem_cod_empr = $id_empresa and
                                        amem_cod_empl = '$cod_empl'
                                        and DATE_PART ('year',amem_fec_amem)= '$id_anio'
                                        and DATE_PART ('month',amem_fec_amem)= '$id_mes'
                                        ";


                            if ($oIfxB->Query($sql)) {
                                if ($oIfxB->NumFilas() > 0) {
                                    $hor_trab = $oIfxB->f('amem_hor_trab');
                                    $hor_atra = ($oIfxB->f('amem_hor_atra') / 8);
                                    $hor_falt = ($oIfxB->f('amem_hor_falt') / 8);
                                    $hor_perm = ($oIfxB->f('amem_hor_perm'));
                                    $hor_25 = $oIfxB->f('amem_hor_e025');
                                    $hor_50 = $oIfxB->f('amem_hor_e050');
                                    $hor_100 = $oIfxB->f('amem_hor_e100');
                                    $hor_vaca = $oIfxB->f('amem_hor_vaca');
                                    $hor_mater = $oIfxB->f('amem_hor_mate');
                                    $hor_sein = ($oIfxB->f('amem_hor_sein') / 8);
                                    //$hor_sein= ($oIfxB->f('amem_hor_mate')/8);
                                    $hor_lice = vacios($oIfxB->f('amem_hor_lice'), '0.0');
                                    $hor_efer = vacios($oIfxB->f('amem_hor_efer'), '0.0');
                                    $hor_trab = ($hor_trab);

                                }
                            }

                            // INGRESOS
                            $sql = "select  
                            pago_cod_rubr, pago_cod_empl,   pago_per_pago, 
                            pago_val_pago,  rubr_des_rubr,
                            rubr_cod_trub
                            from saepago,
                            saerubr
                            where
                            rubr_cod_rubr = pago_cod_rubr and
                            rubr_cod_empr = $id_empresa and                      
                            pago_cod_empr = $id_empresa and
                            SUBSTR(cast (pago_per_pago as text), 0, 5) = '$id_anio' and
                            SUBSTR(cast (pago_per_pago as text), 5, 2) = '$id_mes' and
                            rubr_cod_trub = 'I' and rubr_cod_rubr<>'RSUEN' AND   rubr_cod_rubr<>'RIEAS' and pago_fec_real='$pago_fec_real' and pago_ori_gene='R'
                            $sql_empl  
                            order by rubr_des_alia";


                            $tabla_ingr = '';
                            $tmp = 1;
                            if ($oIfx->Query($sql)) {
                                if ($oIfx->NumFilas() > 0) {
                                    do {
                                        $cod_empl = $oIfx->f('pago_cod_empl');
                                        $rubr_cod = $oIfx->f('pago_cod_rubr');
                                        $pago_per = $oIfx->f('pago_per_pago');
                                        $pago_val = $oIfx->f('pago_val_pago');
                                        $rubr_des = $oIfx->f('rubr_des_rubr');
                                        $rubr_tipo = $oIfx->f('rubr_cod_trub');
                                        $array_tmp [$tmp] = $cod_empl;

                                        /*if($rubr_cod == $rubroSueldo){
                                        $salario = $pago_val;
                                    }*/

                                        if ($tmp > 1) {
                                            if ($array_tmp[$tmp] != $array_tmp[$tmp - 1]) {
                                                $tabla_ingr = '';
                                            }
                                        }

                                        $fecha_ingreso='';
                                        $sql="SELECT min(esem_fec_ingr) as fecha FROM saeesem WHERE esem_cod_empl='$cod_empl' and esem_fec_sali is null";

                                        if($oIfxB->Query($sql)){
                                            if($oIfxB->NumFilas()>0){
                                                $fecha_ingreso=$oIfxB->f('fecha');
                                            }
                                        }



                                        
                                        //$fecha_ingreso_cargo = ingreso_fecha_cargo($cod_empl);
                                        $ban = 0;
                                        $tabla_ingr .= '<tr>';
                                        $tabla_ingr .= '<td style="font-size:75%;" width="75%" align="left">' . $rubr_des . ': ';
                                        if ($rubr_cod == 'RHECC') {
                                            $tabla_ingr .= ' <strong>'. $hor_50 . ' horas </strong></td>';
                                            $ban = 1;
                                        }

                                        if ($rubr_cod == 'RHEVC') {
                                            $tabla_ingr .= ' <strong>'. $hor_25 . ' horas </strong></td>';
                                            $ban = 1;
                                        }

                                        if ($rubr_cod == 'RHECI') {
                                            $tabla_ingr .= ' <strong>'. $hor_100 . ' horas </strong></td>';
                                            $ban = 1;
                                        }
                                        
                                        if ($rubr_cod == 'RSUEL') {
                                            $dias_tra=$hor_trab*30/$empl_jor_trab;
                                            $tabla_ingr .= ' <strong>'. $dias_tra . ' dias </strong></td>';
                                            $ban = 1;
                                        }



                                        if ($rubr_cod == 'RLICE') {
                                            //$tabla_ingr .='<td align="left">'.$hor_lice.'</td>';
                                            //$tabla_ingr .='<td align="left"></td>';
                                            $dias_lice = ($hor_lice / 8);
                                            //$tabla_ingr .= '<td align="left">' . $dias_lice . '</td>';
                                            //$tabla_ingr .= '<td align="left"></td>';
                                            $ban = 1;
                                        }
                                        if ($rubr_cod == 'RLICD') {
                                            //$tabla_ingr .='<td align="left">'.$hor_efer.'</td>';
                                            //$tabla_ingr .='<td align="left"></td>';
                                            $dias_efer = ($hor_efer / 8);
                                            // $tabla_ingr .= '<td align="left">' . $dias_efer . '</td>';
                                            // $tabla_ingr .= '<td align="left"></td>';
                                            $ban = 1;
                                        }
                                        if ($rubr_cod == 'RVACP') {
                                            //$tabla_ingr .='<td align="left">'.$hor_vaca.'</td>';
                                            //$tabla_ingr .='<td align="left"></td>';
                                            $dias_vaca = ($hor_vaca / 8);
                                            //$tabla_ingr .= '<td align="left">' . $dias_vaca . '</td>';
                                            //$tabla_ingr .= '<td align="left"></td>';
                                            $ban = 1;
                                        }
                                        if ($rubr_cod == 'RMATE') {
                                            //$tabla_ingr .='<td align="left">'.$hor_vaca.'</td>';
                                            //$tabla_ingr .='<td align="left"></td>';
                                            $dias_mater = ($hor_mater / 8);
                                            //$tabla_ingr .= '<td align="left">' . $dias_mater . '</td>';
                                            // $tabla_ingr .= '<td align="left"></td>';
                                            $ban = 1;
                                        }

                                        if ($ban == 0) {
                                            $tabla_ingr .= '</td><td style="font-size:75%;" align="right" width="25%"> <strong>' . number_format($pago_val, 2, '.', ',') . '</strong></td>';
                                        }else {
                                            $tabla_ingr .= ' <td style="font-size:75%;" align="right" width="25%"><strong>' . number_format($pago_val, 2, '.', ',') . '</strong></td>';
                                        }
                                        $tabla_ingr .= '</tr>';

                                        $array_table_ingr [$cod_empl] = $tabla_ingr;


                                        $tot_ingr += $pago_val;
                                        $tmp++;
                                    } while ($oIfx->SiguienteRegistro());
                                }
                            }


                            $path_img = explode("/", $empr_path_logo);
                            $count = count($path_img) - 1;
                            $url_absoluta = url_actual() . '/WebApp';
                            $path_logo_img = $url_absoluta . '/Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];

                            //FORMATO DEL REPORTE ROL INDIVIDUAL PERSONALIZADO


                            $table_rol = '<table  align="left" border="0"   style="width: 100%;  margin-top: 10px; " >';
                            if ($empr_path_logo != '') {
                                $table_rol .= '<tr>
                                <td align="left">' . $empr_logo . '</td>
                                <td align="right" style="color: black;" ><strong>ROL DE PAGOS<br>Per&iacute;odo '.strtoupper( Mes_func($id_mes)).' ' . $id_anio . '</strong></td>
                                    </tr>
                                    
                                    <tr><td colspan="2"  ><hr></td></tr>';
                            }
                            $table_rol .= '</table>';





                            $table_rol .= '<br><br><table align="left" width="100%" style="width: 100%; border:1px solid black; border-radius: 5px; margin-top: 20px;">';
                            $table_rol .= '<tr>
                                              <td  bgcolor="black" style="width:100%"><font color="white">'.$empl_nom.'</font></td>
                                         </tr>';
                            $table_rol .='</table>';

                            $table_rol .= '<br><br><table bgcolor="#C9C2C1" align="left" width="100%" style="width: 100%; border:3px solid black; ">';
                            $table_rol .='<tr>
                                           <td style="font-size:90%;"><strong>N° C&eacute;dula</strong></td>
                                           <td style="font-size:90%;">'.$cod_empl.'</td>
                                           <td style="font-size:90%;"><strong>D&iacute;as per&iacute;odo</strong></td>
                                           <td style="font-size:90%;">30.00</td>
                                        </tr>';
                            $table_rol .='<tr>
                                        <td style="font-size:90%;"><strong>Sueldo B&aacute;sico</strong></td>
                                        <td style="font-size:90%;">'.number_format($sueldo, 2, '.', ',').'</td>
                                        <td style="font-size:90%;"><strong>Cargo</strong> '.$cargo.'</td>
                                     </tr>';

                            $fecha_uno = strtotime($fecha_ingreso);
                            $fecha_dos = strtotime($fech_ing_cargo);

                            if($fecha_uno > $fecha_dos){
                                $fecha_ingreso=$fech_ing_cargo;
                                //echo "La fecha de iingreso a la empmresa es mayor a la fecha de cargo";
                            }

                            $table_rol .='<tr>
                                        <td style="font-size:90%;"><strong>Fecha Ingreso Empresa</strong></td>
                                        <td style="font-size:90%;">'.$fecha_ingreso.'</td>
                                        <td><strong>Jornada Trabajo</strong></td>
                                        <td>'.$empl_jor_trab.'</td>
                                     </tr>';

                            $table_rol .='<tr>
                                        <td style="font-size:90%;"><strong>Fecha Ingreso Cargo</strong></td>
                                        <td style="font-size:90%;" colspan="3">'.$fech_ing_cargo.'</td>
                                        
                                     </tr>';

                            $table_rol .='</table>';
                            //INGRESOS Y EGRESOS

                            $table_rol .= '<br><br><table style="width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">';
                            $table_rol .= '<tr>
                                        <td style="font-size:80%;" align="center" width="50%" ><strong>_______________ INGRESOS _______________</strong></td>
                                        <td style="font-size:80%;" align="center" width="50%"><strong>_______________ EGRESOS _______________</strong></td>
                                    </tr>';
                            $table_rol .= '<tr>
                                        <td   valign="top" style="width: 50%;">
                                            <table align="center" border="0" width="100%" >                                                
                                                ' . $tabla_ingr . '
                                            </table>
                                        </td>
                                        <td  valign="top" style="width: 50%;">
                                            <table  align="center" border="0" width="100%" >                                      
                                                ' . $tabla_egre . '
                                            </table>    
                                        </td>
                                    </tr>';
                            $table_rol .= '<tr>
                                    <td colspan="2" style="font-size:80%;" align="center"><strong>___________________________________________________________________________________<br></strong></td>
                                  
                                </tr>';

                            $table_rol .= '<tr>
                                        <td valign="top" style="width: 50%;">
                                            <table bgcolor="yellow" style="width: 100%; border:2px solid black; border-radius: 2px;">        
                                                <tr>
                                                    <td align="left" width="70%" style="font-size:80%;"><strong>TOTAL INGRESOS:</strong></td>
                                                    <td align="right" width="30%" style="font-size:80%;"><strong>' . number_format($tot_ingr, 2, '.', ',') . '</strong></td>
                                                </tr>
                                            </table>    
                                        </td>
                                        <td valign="top" style="width: 50%;">
                                            <table bgcolor="yellow" style="width: 100%; border:2px solid black; border-radius: 2px;">         
                                                <tr>
                                                    <td align="left" width="70%;" style="font-size:80%;"><strong>TOTAL EGRESOS:</strong></td>
                                                    <td align="right" width="30%;" style="font-size:80%;"><strong>' . number_format($egre, 2, '.', ',') . '</strong></td>
                                                </tr>
                                            </table>    
                                        </td>
                                    </tr>';
                            $total_recibi = $tot_ingr - $egre;
                            $table_rol .= '</table>';

                            $table_rol .= '<br><br><table style="width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">';
                            $table_rol .= '<tr bgcolor="#C9C2C1">
                                       
                                                    <td style="font-size:90%;" class="fecha_letra" align="left" width="80%;"><strong>NETO A RECIBIR PER&Iacute;ODO '.strtoupper( Mes_func($id_mes)).' ' . $id_anio . '</strong></td>
                                                    <td style="font-size:90%;" class="fecha_letra" align="right" width="20%;"><strong>' . number_format($total_recibi, 2, '.', ',') . '</strong></td>
                                                </tr>';
                            $table_rol .= '</table>';
                            $formatter = new EnLetras();
                            $valtotal=$formatter->ValorEnLetrasMonePeru($total_recibi, $moneda_principal);

                            $table_rol .= '<br><br><table style="width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">';
                            $table_rol .= '<tr>
                                                <td style="font-size:90%;" class="fecha_letra" align="left" width="100%;"><strong>SON: '.strtoupper($valtotal).'</strong></td>
                                            </tr>';
                            if ($saldo_prestamo!=0) {
                                $table_rol .= '<tr>
                                                <td style="font-size:90%;" class="fecha_letra" align="left" width="100%;"><strong>SALDO PRESTAMO: ' . $saldo_prestamo . '</strong></td>
                                            </tr>';
                            }

                            $table_rol .= '</table>';


                            $table_rol .= '<br><br><table style="width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">';
                            $table_rol .= '<tr>
                                                    <td style="font-size:70%;" class="fecha_letra" align="left" width="100%;"><p align="justify">Certifico que he recibido a entera satisfacción los valores contenidos en el presente comprobante de pago de remuneraciones,
                                                    valor que ha sido acreditado en mi cuenta de BANCO '.$banco.' número: '.$empl_num_ctas.', por lo que no tengo ningún reclamo</p></td>
                                                </tr>';
                            $table_rol .= '</table>';


                        } while ($oIfx->SiguienteRegistro());

                    }
                }

                $sql_empr = "select empr_repres from saeempr where empr_cod_empr = $id_empresa ";
                $empr_repres1 = consulta_string_func($sql_empr, 'empr_repres', $oIfxA, '');
                $sql_empr1 = "select empr_ced_repr from saeempr where empr_cod_empr = $id_empresa ";
                $empr_ced_repr = consulta_string_func($sql_empr1, 'empr_ced_repr', $oIfxA, '');

                //$table_op .="</div>";
                $legend .= '
                        <table style="width: 100%; " border="0" >
                            <tr>
                                <td style="width: 50%;" align="center">
                                    <br>
                                </td>
                                <td style="width: 50%;" align="center">
                                    '.$empl_fir.'
                                </td>
                            </tr>
                            <tr>
                                
                                <td style="width: 50%;" align="center">
                                    _______________________________ <br>
                                        TALENTO HUMANO<br><br>
                                    
                                </td>
                                <td style="width: 50%;" align="center">
                                    _______________________________ <br>
                                        RECIBÍ CONFORME <br>CI:' . $cod_empl . '<br> FECHA:'.date('d-m-Y').'<br><br> 
                                </td>
                            </tr>
                        </table>
                    ';

                $emisor.=' <table style="width: 100%; " border="0" >
                    <tr>
                    <td style="width: 100%;" align="center"><strong>ORIGINAL EMISOR</strong></td>
                    </tr>
                    </table>';

                $receptor.=' <table style="width: 100%; " border="0" >
                    <tr>
                    <td style="width: 100%;" align="center"><strong>COPIA RECEPTOR</strong></td>
                    </tr>
                    </table>';


                $documento .= '<page backimgw="10%" backtop="10mm" backbottom="10mm" backleft="10mm" backright="10mm">';

                
                if($duplicado=='S') {

                    $tabla='<table style="width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">
                    <tr>
                        <td valign="top" width="50%" >'.$table_rol.''. $legend.''. $emisor.'</td>';
                        $tabla .= '        <td valign="top" style="width: 2%;"></td>
                        <td valign="top" width="50%" >' . $table_rol . '' . $legend . '' . $receptor . '</td>';
                        $tabla.='</tr>
                        </table>
                        ';
                
                }
                else{

                    $tabla='<table style="width: 100%; margin-top: 10px;" border="0" style="border-collapse: collapse;">
                    <tr>
                        <td valign="top">'.$table_rol.''. $legend.''. $emisor.'</td>';
                       
                        $tabla.='</tr>
                        </table>
                        ';

                }
                /*$documento =<<<EOD
                $tabla
                EOD;*/
                // $documento .= $table_op;
                $documento .= $tabla;
                $documento .= '</page>||||||||||';

            } while ($oIfxD->SiguienteRegistro());
        }
        else{
            $documento='<div align="center"><span><font color="red" size="30%">EL EMPLEADO NO CUMPLE EL TIEMPO NECESARIO PARA LA GENERACIÓN DEL ROL</font></span></div>';
        }
    }


    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $doc=str_replace('||||||||||','',$documento);
    $html2pdf->WriteHTML($doc);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;

    return $documento;
}


function rol_individual($id_empresa = 0, $id_anio = 0, $id_mes = 0, $id_empl = '', $id_depar = 0, $id_proyecto = 0, $pago_cod_estr = '', $fecha_rol = '', &$rutaPdf = '')
{
    //Definiciones
    global $DSN_Ifx;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();


    $oIfxB = new Dbo;
    $oIfxB->DSN = $DSN_Ifx;
    $oIfxB->Conectar();


    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();

    $oIfxD = new Dbo;
    $oIfxD->DSN = $DSN_Ifx;
    $oIfxD->Conectar();

    $oReturn = new xajaxResponse();

    //anio - mes
    $opAnio = 0;
    if ($id_anio == 2017) {
        $opAnio = 1;
    }
    $condicion_fecha = '';
    if ($fecha_rol != '') {
        $condicion_fecha = "and pago_fec_real='$fecha_rol'";
    }
    $nombre_archivo = 'RECIBO_PAGO_' . $id_anio . '_' . $id_mes . '_' . $id_empl;
    $sql = "select pago_fec_real, pago_cod_estr
            from saepago 
            where pago_cod_empl='$id_empl' and 
                pago_cod_empr='$id_empresa' and
                SUBSTR(cast (pago_per_pago as text), 0, 5) = '$id_anio' and
                SUBSTR(cast (pago_per_pago as text), 5, 2) = '$id_mes'  and pago_ori_gene='R'
                $condicion_fecha
                group by 1,2";

    $ban_anti = false;
    if ($oIfxD->query($sql)) {
        if ($oIfxD->NumFilas() > 0) {
            do {
                $table_op = "";
                $legend = "";
                $pago_fec_real = $oIfxD->f('pago_fec_real');
                $id_depar = $oIfxD->f('pago_cod_estr');
                $sql_depar = '';
                if (!empty($id_proyecto)) {
                    if (!empty($id_depar)) {
                        $sql_depar = " and pago_cod_empl in (  select  esem_cod_empl from saeestr, saeesem where
                                                        estr_cod_estr = esem_cod_estr and
                                                        estr_cod_empr = $id_empresa and
                                                        estr_cod_padr  in ( '$id_depar' )
                                                        group by 1 ) ";
                    } else {
                        $sql_depar = " and pago_cod_empl in (  select  esem_cod_empl from saeestr, saeesem where
                                                        estr_cod_estr = esem_cod_estr and
                                                        estr_cod_empr = $id_empresa and
                                                        estr_cod_padr  in ( select estr_cod_estr
                                                                                from saeestr where
                                                                                estr_cod_empr = $id_empresa and
                                                                                estr_cod_gpro = '$id_proyecto'  )
                                                        group by 1 ) ";
                    }
                }

                $sql_empl = '';

                $sql_empl = " and pago_cod_empl = '$id_empl' ";



                $sql = "select empr_nom_empr, empr_path_logo from saeempr where empr_cod_empr = $id_empresa ";

                $empr_nom = consulta_string_func($sql, 'empr_nom_empr', $oIfxA, '');
                $empr_path_logo = consulta_string_func($sql, 'empr_path_logo', $oIfxA, '');
                $path_img = explode("/", $empr_path_logo);
                $count = count($path_img) - 1;
                $arc_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];
                //echo $arc_img;exit;
                if (file_exists($arc_img)) {
                    $imagen = $arc_img;
                } else {
                    $imagen = '';
                }
                $logo = '';
                $x = '0px';
                if ($imagen != '') {

                    $empr_logo = '<div>
        <img src="' . $imagen . '" style="
        width:120px;">
        </div>';
                    $x = '0px';
                }
                else{
                    $empr_logo ='<span><font color="red">SIN LOGO</font></span>';
                }




                //rubro sueldo
                $sql = "select rubr_cod_rubr from saerubr where rubr_tsu_rubr = '1'";

                $rubroSueldo = consulta_string_func($sql, 'rubr_cod_rubr', $oIfxA, '');

                //$oReturn->alert($sql);
                unset($tot_ingr);
                unset($array_table_ingr);
                unset($array_tmp);
                //// prestamos

                $sql = "select sum(cuot_mot_capi) as valor, pret_cod_empl, tpre_cod_rubr
                    from saecuot  c
                     inner join saepret on pret_cod_pret = cuot_cod_pret
                    inner join saetpre on tpre_cod_tpre = pret_cod_tpre
                     where 
                    pret_cod_empr=tpre_cod_empr and 
                    pret_cod_empr='1' and cuot_est_cuot='0' group by pret_cod_empl , tpre_cod_rubr
                    ";
                ;
                //echo $sql; exit;
                unset($array_prest_pen);
                if ($oIfx->Query($sql)) {
                    if ($oIfx->NumFilas() > 0) {
                        do {
                            $array_prest_pen[$oIfx->f('pret_cod_empl')][$oIfx->f('tpre_cod_rubr')] = $oIfx->f('valor');
                            //$array_prest_pen[$oIfx->f('pret_cod_empl')]['RCAFE']=$oIfx->f('valor');
                        } while ($oIfx->SiguienteRegistro());
                    }
                }

                //  var_dump($array_prest_pen);exit;
                // EGRESOS
                if (($id_mes < 12) && ($id_anio == 2017)) {
                    $sql = "select  
                            pago_cod_rubr, pago_cod_empl,   pago_per_pago, 
                            pago_val_pago,  rubr_des_rubr,
                            rubr_cod_trub
                            from saepago,
                            saerubr
                            where
                            rubr_cod_rubr = pago_cod_rubr and
                            rubr_cod_empr = $id_empresa and
                            pago_cod_empr = $id_empresa and
                            SUBSTR(cast (pago_per_pago as text), 0, 5) = '$id_anio' and
                            SUBSTR(cast (pago_per_pago as text), 5, 2) = '$id_mes' and
                            rubr_cod_trub = 'D' AND rubr_cod_rubr<>'RIESS' and pago_fec_real='$pago_fec_real' and pago_ori_gene='R'
                            $sql_empl 
                            order by pago_cod_empl";
                    //echo $sql;
                    //echo 'hola 1 ';exit;
                } else {
                    $sql = "select  
                            pago_cod_rubr, pago_cod_empl,   pago_per_pago, 
                            pago_val_pago,  rubr_des_rubr,
                            rubr_cod_trub
                            from saepago,
                            saerubr
                            where
                            rubr_cod_rubr = pago_cod_rubr and
                            rubr_cod_empr = $id_empresa and
                            pago_cod_empr = $id_empresa and
                            SUBSTR(cast (pago_per_pago as text), 0, 5) = '$id_anio' and
                            SUBSTR(cast (pago_per_pago as text), 5, 2) = '$id_mes' and
                            rubr_cod_trub = 'D'  and pago_fec_real='$pago_fec_real' and pago_ori_gene='R'
                            $sql_empl 
                            order by pago_cod_empl";
                    //echo $sql;
                    //echo 'hola 2 ';exit;
                }


                unset($tot_egre);
                $tabla_egre = '';
                unset($array_table_egre);
                unset($array_tmp);

                $tmp = 1;
                $ban = 0;
                $i = 0;
                if ($oIfx->Query($sql)) {
                    if ($oIfx->NumFilas() > 0) {
                        do {

                            $cod_empl = $oIfx->f('pago_cod_empl');
                            $rubr_cod = $oIfx->f('pago_cod_rubr');
                            $pago_per = $oIfx->f('pago_per_pago');
                            $pago_val = $oIfx->f('pago_val_pago');
                            $rubr_des = $oIfx->f('rubr_des_rubr');
                            $rubr_tipo = $oIfx->f('rubr_cod_trub');

                            $array_tmp [$tmp] = $cod_empl;
                            if ($tmp > 1) {
                                if ($array_tmp[$tmp] != $array_tmp[$tmp - 1]) {
                                    $tabla_egre = '';
                                }
                            }
                            if (($tmp == 1) && ($id_mes >= 12) && ($id_anio >= 2017) && ($ban == 0) && ($ban_anti == false)) {
                                $sql = "select estr_cod_ppag from saeestr where estr_cod_estr='$id_depar' and estr_cod_empr='$id_empresa'";
                                $control_estr = consulta_string($sql, 'estr_cod_ppag', $oIfxA, '');
                                //echo $sql;exit;
                                if ($control_estr == 1) {
                                    unset($tablaAnticipo);
                                    $sql = "SELECT 
                                            anti_obs_anti,
                                            anti_val_anti 
                                        FROM saeanti 
                                            where anti_cod_empl= '$cod_empl' and 
                                            DATE_PART('year',anti_fec_anti) = $id_anio and
                                            DATE_PART('month',anti_fec_anti) = $id_mes";
                                    //echo $sql;exit;
                                    if ($oIfxC->Query($sql)) {
                                        $obs = $oIfxC->f('anti_obs_anti');
                                        $val = $oIfxC->f('anti_val_anti');
                                        //echo $val; exit;
                                        $ban = 1;
                                        //if($val!='0.0'){
                                        if (!empty($val) || $val != '0.0') {
                                            $tabla_egre .= '<tr>';
                                            $tabla_egre .= '<td align="left" style="width: 50%;">' . $obs . '</td>';
                                            $tabla_egre .= '<td align="right" style="width: 25%;">' . number_format($val, 2, '.', ',') . '</td>';
                                            $tabla_egre .= '<td  align="right" width="25%;">&nbsp;</td>';
                                            $tabla_egre .= '</tr>';
                                        }

                                    }

                                    $tot_egre [$cod_empl] += $val;
                                    $ban_anti = true;
                                }
                            }

                            if ($sClass == 'off') $sClass = 'on'; else $sClass = 'off';
                            //var_dump($array_prest_pen);
                            //exit;
                            if (empty($array_prest_pen[$cod_empl][$rubr_cod])) {
                                //if(empty($array_prest_pen[$cod_empl])){
                                //echo 'hola tabla';
                                if($rubr_cod!='RANTI') {
                                    $tabla_egre .= '<tr>';
                                    $tabla_egre .= '<td align="left" width="50%;">' . $rubr_des . '</td>';
                                    $tabla_egre .= '<td  align="right" width="25%;">' . number_format($pago_val, 2, '.', ',') . '</td>';
                                    $tabla_egre .= '<td  align="right" width="25%;">&nbsp;</td>';
                                    $tabla_egre .= '</tr>';
                                }
                            } else {
                                $tabla_egre .= '<tr>';
                                $tabla_egre .= '<td align="left" width="50%;">' . $rubr_des . '</td>';
                                $tabla_egre .= '<td align="right" width="25%;">' . number_format($pago_val, 2, '.', ',') . '</td>';
                                $tabla_egre .= '<td align="right" width="25%;">' . number_format($array_prest_pen[$cod_empl][$rubr_cod], 2, '.', ',') . '</td>';
                                $tabla_egre .= '</tr>';
                            }

                            //echo $tabla_egre;
                            //exit;

                            $array_table_egre[$cod_empl] = $tabla_egre;

                            if($rubr_cod!='RANTI') {
                                $tot_egre [$cod_empl] += $pago_val;
                            }
                            $tmp++;

                            //var_dump($array_table_egre);
                            $i++;
                            //var_dump($i.'p');
                        } while ($oIfx->SiguienteRegistro());
                    }
                }
                $oIfx->Free();

                //anticipo
                $anticipo = 0;
                if (($val == 0) && ($ban_anti == false)) {
                    $sql = "select estr_cod_ppag from saeestr where estr_cod_estr='$id_depar' and estr_cod_empr='$id_empresa'";
                    $control_estr = consulta_string($sql, 'estr_cod_ppag', $oIfx, '');
                    //echo $sql;exit;
                    if ($control_estr == 1) {
                        $sql = "select sum(anti_val_anti) as anticipo 
                        from saeanti
                        where anti_cod_empl = '$id_empl' and
                        anti_cod_empr = $id_empresa and
                        DATE_PART('year',anti_fec_anti) = $id_anio and
                        DATE_PART('month',anti_fec_anti) = $id_mes";
                        $anticipo = consulta_string_func($sql, 'anticipo', $oIfx, 0);
                        $ban_anti = true;
                    }
                }

                if($anticipo > 0){
                    $tablaAnticipo .='<tr>';
                    $tablaAnticipo .='<td align="left">PAGO QUINCENA</td>';
                    $tablaAnticipo .='<td align="right">'.number_format($anticipo, 2, '.', ',').'</td>';
                    $tablaAnticipo .='</tr>';

                    $array_table_egre[$id_empl] .= $tablaAnticipo;
                    $tot_egre[$id_empl] += $anticipo;
                }

                //$table_op .='<div width="80%" syle="margin-top: 5px;">';

                ///$table_op .='<div width="80%" syle="margin-top: 15px;">';


                $sql = "select pago_cod_empl
                from saepago, saerubr   where
                rubr_cod_rubr = pago_cod_rubr and
                rubr_cod_empr = pago_cod_empr and
                rubr_cod_empr = $id_empresa and                      
                pago_cod_empr = $id_empresa and
                SUBSTR(cast (pago_per_pago as text), 0, 5) = '$id_anio' and
                SUBSTR(cast (pago_per_pago as text), 5, 2) = '$id_mes' and pago_fec_real='$pago_fec_real' and pago_ori_gene='R'
                $sql_empl 
                $sql_depar
                group by 1
                order by pago_cod_empl";
                //echo $sql;
                //exit;
                $ingr = 0;
                $egre = 0;
                if ($oIfx->Query($sql)) {
                    if ($oIfx->NumFilas() > 0) {
                        do {
                            $cod_empl = $oIfx->f('pago_cod_empl');

                            $tabla_ingr = $array_table_ingr[$cod_empl];
                            $tabla_egre = $array_table_egre[$cod_empl];

                            $egre = $tot_egre [$cod_empl];
                            $ingr = $tot_ingr [$cod_empl];

                            $sql = "select empl_ape_nomb , empl_sal_sala, empl_jor_trab, empl_val5_empl, empl_num_ctas 
                                from saeempl 
                                where empl_cod_empr = $id_empresa and 
                                empl_cod_empl = '$cod_empl' ";
                            $empl_nom = consulta_string_func($sql, 'empl_ape_nomb', $oIfxA, '');
                            $salario = consulta_string_func($sql, 'empl_sal_sala', $oIfxA, '');
                            $empl_jor_trab = consulta_string_func($sql, 'empl_jor_trab', $oIfxA, '');
                            $empl_val5_empl = consulta_string_func($sql, 'empl_val5_empl', $oIfxA, '');
                            $empl_num_ctas = consulta_string_func($sql, 'empl_num_ctas', $oIfxA, '');

                            if ($opAnio == 0) {
                                $sueldo = $salario;
                            } else {
                                $sueldo = $empl_val5_empl;
                            }


                            $sql = "select estr_des_estr, esem_fec_ingr  from saeesem, saeestr where
                                    estr_cod_estr = esem_cod_estr and
                                    estr_cod_empr = $id_empresa and
                                    esem_cod_empl = '$cod_empl' and 
                                    esem_cod_empr = $id_empresa 
                                    order by 2 desc";

                            $cargo = consulta_string_func($sql, 'estr_des_estr', $oIfxA, '');

                            $sql_tmp = "select estr_cod_padr  from saeesem, saeestr where
                                    estr_cod_estr = esem_cod_estr and
                                    estr_cod_empr = $id_empresa and
                                    esem_cod_empl =  '$cod_empl'  and 
                                    esem_cod_empr = $id_empresa ";



                            if ($oIfxB->Query($sql_tmp)) {
                                if ($oIfxB->NumFilas() > 0) {
                                    $estr_tmp = $oIfxB->f('estr_cod_padr');
                                }
                            }
                            $oIfxB->Free();

                            $sql_p = "select estr_des_estr  from saeestr where 
                                    estr_cod_empr = $id_empresa and
                                    estr_cod_estr = '$estr_tmp'  ";

                            if ($oIfxB->Query($sql_p)) {
                                if ($oIfxB->NumFilas() > 0) {
                                    $estr_nom = $oIfxB->f('estr_des_estr');
                                }
                            }
                            $oIfxB->Free();


                            // HORAS EXTRAS
                            $sql = "select  amem_hor_trab, amem_hor_atra, amem_hor_falt,
                                        amem_hor_perm, amem_hor_e025, amem_hor_lice,
                                        amem_hor_e050,  amem_hor_e100,  amem_hor_vaca, amem_hor_mate, amem_hor_efer, amem_hor_sein
                                from    saeamem where
                                        amem_cod_empr = $id_empresa and
                                        amem_cod_empl = '$cod_empl'
                                        and DATE_PART ('year',amem_fec_amem)= '$id_anio'
                                        and DATE_PART ('month',amem_fec_amem)= '$id_mes'
                                        ";


                            if ($oIfxB->Query($sql)) {
                                if ($oIfxB->NumFilas() > 0) {
                                    $hor_trab = $oIfxB->f('amem_hor_trab');
                                    $hor_atra = ($oIfxB->f('amem_hor_atra') / 8);
                                    $hor_falt = ($oIfxB->f('amem_hor_falt') / 8);
                                    $hor_perm = ($oIfxB->f('amem_hor_perm'));
                                    $hor_25 = $oIfxB->f('amem_hor_e025');
                                    $hor_50 = $oIfxB->f('amem_hor_e050');
                                    $hor_100 = $oIfxB->f('amem_hor_e100');
                                    $hor_vaca = $oIfxB->f('amem_hor_vaca');
                                    $hor_mater = $oIfxB->f('amem_hor_mate');
                                    $hor_sein = ($oIfxB->f('amem_hor_sein') / 8);
                                    //$hor_sein= ($oIfxB->f('amem_hor_mate')/8);
                                    $hor_lice = vacios($oIfxB->f('amem_hor_lice'), '0.0');
                                    $hor_efer = vacios($oIfxB->f('amem_hor_efer'), '0.0');
                                    $hor_trab = ($hor_trab - $hor_lice - $hor_efer - $hor_vaca);

                                }
                            }

                            // INGRESOS
                            $sql = "select  
                            pago_cod_rubr, pago_cod_empl,   pago_per_pago, 
                            pago_val_pago,  rubr_des_rubr,
                            rubr_cod_trub
                            from saepago,
                            saerubr
                            where
                            rubr_cod_rubr = pago_cod_rubr and
                            rubr_cod_empr = $id_empresa and                      
                            pago_cod_empr = $id_empresa and
                            SUBSTR(cast (pago_per_pago as text), 0, 5) = '$id_anio' and
                            SUBSTR(cast (pago_per_pago as text), 5, 2) = '$id_mes' and
                            rubr_cod_trub = 'I' and rubr_cod_rubr<>'RSUEN' AND   rubr_cod_rubr<>'RIEAS' and pago_fec_real='$pago_fec_real' and pago_ori_gene='R'
                            $sql_empl  
                            order by rubr_des_alia";


                            $tabla_ingr = '';
                            $tmp = 1;
                            if ($oIfx->Query($sql)) {
                                if ($oIfx->NumFilas() > 0) {
                                    do {
                                        $cod_empl = $oIfx->f('pago_cod_empl');
                                        $rubr_cod = $oIfx->f('pago_cod_rubr');
                                        $pago_per = $oIfx->f('pago_per_pago');
                                        $pago_val = $oIfx->f('pago_val_pago');
                                        $rubr_des = $oIfx->f('rubr_des_rubr');
                                        $rubr_tipo = $oIfx->f('rubr_cod_trub');
                                        $array_tmp [$tmp] = $cod_empl;

                                        /*if($rubr_cod == $rubroSueldo){
                                        $salario = $pago_val;
                                    }*/

                                        if ($tmp > 1) {
                                            if ($array_tmp[$tmp] != $array_tmp[$tmp - 1]) {
                                                $tabla_ingr = '';
                                            }
                                        }

                                        //$fecha_ingreso = ingreso_fecha($cod_empl);
                                        //$fecha_ingreso_cargo = ingreso_fecha_cargo($cod_empl);
                                        $ban = 0;
                                        $tabla_ingr .= '<tr>';
                                        $tabla_ingr .= '<td align="left">' . $rubr_des . '</td>';
                                        if ($rubr_cod == 'RHEVC') {
                                            $tabla_ingr .= '<td align="left"></td>';
                                            $tabla_ingr .= '<td align="left">' . $hor_25 . '</td>';

                                            $ban = 1;
                                        }
                                        if ($rubr_cod == 'RHECI') {
                                            $tabla_ingr .= '<td align="left"></td>';
                                            $tabla_ingr .= '<td align="left">' . $hor_100 . '</td>';
                                            //$tabla_ingr .='<td align="left"></td>';
                                            $ban = 1;
                                        }
                                        if ($rubr_cod == 'RHECC') {
                                            $tabla_ingr .= '<td align="left"></td>';
                                            $tabla_ingr .= '<td align="left">' . $hor_50 . '</td>';
                                            //$tabla_ingr .='<td align="left"></td>';
                                            $ban = 1;
                                        }
                                        if ($rubr_cod == 'RSUEL') {
                                            //$tabla_ingr .='<td align="left">'.$hor_trab.'</td>';

                                            $dias_tra = ($hor_trab / 8);
                                            $tabla_ingr .= '<td align="left">' . $dias_tra . '</td>';
                                            $tabla_ingr .= '<td align="left"></td>';
                                            $ban = 1;
                                        }
                                        if ($rubr_cod == 'RLICE') {
                                            //$tabla_ingr .='<td align="left">'.$hor_lice.'</td>';
                                            //$tabla_ingr .='<td align="left"></td>';
                                            $dias_lice = ($hor_lice / 8);
                                            $tabla_ingr .= '<td align="left">' . $dias_lice . '</td>';
                                            $tabla_ingr .= '<td align="left"></td>';
                                            $ban = 1;
                                        }
                                        if ($rubr_cod == 'RLICD') {
                                            //$tabla_ingr .='<td align="left">'.$hor_efer.'</td>';
                                            //$tabla_ingr .='<td align="left"></td>';
                                            $dias_efer = ($hor_efer / 8);
                                            $tabla_ingr .= '<td align="left">' . $dias_efer . '</td>';
                                            $tabla_ingr .= '<td align="left"></td>';
                                            $ban = 1;
                                        }
                                        if ($rubr_cod == 'RVACP') {
                                            //$tabla_ingr .='<td align="left">'.$hor_vaca.'</td>';
                                            //$tabla_ingr .='<td align="left"></td>';
                                            $dias_vaca = ($hor_vaca / 8);
                                            $tabla_ingr .= '<td align="left">' . $dias_vaca . '</td>';
                                            $tabla_ingr .= '<td align="left"></td>';
                                            $ban = 1;
                                        }
                                        if ($rubr_cod == 'RMATE') {
                                            //$tabla_ingr .='<td align="left">'.$hor_vaca.'</td>';
                                            //$tabla_ingr .='<td align="left"></td>';
                                            $dias_mater = ($hor_mater / 8);
                                            $tabla_ingr .= '<td align="left">' . $dias_mater . '</td>';
                                            $tabla_ingr .= '<td align="left"></td>';
                                            $ban = 1;
                                        }

                                        if ($ban == 0) {
                                            $tabla_ingr .= '<td align="left"></td>';
                                            $tabla_ingr .= '<td align="left"></td>';
                                        }
                                        $tabla_ingr .= '<td align="right">' . number_format($pago_val, 2, '.', ',') . '</td>';
                                        $tabla_ingr .= '</tr>';

                                        $array_table_ingr [$cod_empl] = $tabla_ingr;


                                        $tot_ingr += $pago_val;
                                        $tmp++;
                                    } while ($oIfx->SiguienteRegistro());
                                }
                            }


                            $path_img = explode("/", $empr_path_logo);
                            $count = count($path_img) - 1;
                            $url_absoluta = url_actual() . '/WebApp';
                            $path_logo_img = $url_absoluta . '/Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];

                            $table_op .= '<table align="left" style="width: 100%; border:1px solid black; border-radius: 5px; margin-top: 20px;">';
                            if ($empr_path_logo != '') {
                                $table_op .= '<tr>
                                         <td colspan="2">
                                            ' . $empr_logo . '<br>
                                        </td>
                                    </tr>';
                            }

                            $table_op .= '<tr>  
                                        <td class="fecha_letra" width="400"><b>EMPRESA:</b> ' . ($empr_nom) . ' </td>
                                        <td class="fecha_letra" width="200"></td>
                                    </tr>
                                    <tr>    
                                        <td class="fecha_letra" width="400"><b>ROL MES:</b> ' . Mes_func($id_mes) . ' ' . $id_anio . '</td>
                                        <td class="fecha_letra" width="200"></td>
                                    </tr>
                                    <tr>    
                                        <td class="fecha_letra" width="300"><b>NOMBRE:</b> ' . $empl_nom . '</td>
                                        <td class="fecha_letra" width="300"><b>CODIGO:</b> ' . $cod_empl . '</td>
                                    </tr>
                                    <tr>    
                                        <td class="fecha_letra" width="300"><b>CARGO:</b> ' . $cargo . '</td>
                                        <td class="fecha_letra" width="300"><b>DEPARTAMENTO:</b> ' . $estr_nom . ' </td>
                                    </tr>
                                    <tr>    
                                        <td class="fecha_letra" width="300"><b>FECHA INGRESO EMPRESA:</b> ' . $fecha_ingreso . '</td>
                                        <td class="fecha_letra" width="300"><b>FECHA INGRESO CARGO:</b> ' . $fecha_ingreso_cargo . '</td>
                                    </tr>
                                    <tr>
                                        <td class="fecha_letra" width="300"><b>SALARIO:</b> ' . number_format($sueldo, 2, '.', ',') . '</td>
                                        <td class="fecha_letra" width="300"><b>PERMISOS:</b> ' . $hor_perm . '</td>    
                                    </tr>
                                    <tr>
                                    <td class="fecha_letra" width="300"><b>VACACIONES:</b> ' . $hor_vaca . '</td>  
                                    <td class="fecha_letra" width="300"><b>FALTAS INJUSTIFICADAS:</b> ' . $hor_falt . '</td>
                                    </tr>
                                    <tr>    
                                        <td class="fecha_letra" width="300"><b>JORNADA DE TRABAJO:</b> ' . $empl_jor_trab . '</td>
                                        <td class="fecha_letra" width="300"><b>LICENCIA SIN SUELDO:</b> ' . $hor_atra . '</td>
                                    </tr>
                                    <tr>                                        
                                        <td class="fecha_letra" width="300"><b>NUMERO DE CUENTA:</b> ' . $empl_num_ctas . '</td>
                                        <td class="fecha_letra" width="300"></td>
                                    </tr>';
                            $table_op .= '</table>';

                            $table_op .= '<br>';

                            $table_op .= '<table style="width: 100%; margin-top: 20px;" border="1" style="border-collapse: collapse;">';
                            $table_op .= '<tr>
                                        <td width="350"><b>INGRESOS</b></td>
                                        <td width="350"><b>DESCUENTOS</b></td>
                                    </tr>';
                            $table_op .= '<tr>
                                        <td valign="top" width="350">
                                            <table align="center" border="1" width="100%" style="border-collapse: collapse;">                                                
                                                <tr>
                                                    <td style="width: 69%;">DESCRIPCION</td>
                                                    <td style="width: 8%;">DI.</td>
                                                    <td style="width: 10%;">HOR.</td>
                                                    <td style="width: 10%;">VAL.</td>
                                                </tr>
                                                ' . $tabla_ingr . '
                                            </table>
                                        </td>
                                        <td valign="top" width="350">
                                            <table  border="1" width="100%" style="border-collapse: collapse;">  
                                                    <tr>
                                                    <td width="100">DESCRIPCION</td>
                                                    <td width="50">VALOR</td>
                                                    <td width="50">SAL PRES</td>
                                                </tr>                                           
                                                ' . $tabla_egre . '
                                            </table>    
                                        </td>
                                    </tr>';

                            $table_op .= '<tr>
                                        <td valign="top" width="350">
                                            <table align="center" border="0" width="100%" style="border-collapse: collapse;">        
                                                <tr>
                                                    <td align="right" width="50" ></td>
                                                    <td align="right" width="200"><b>TOTAL INGRESO:</b></td>
                                                    <td align="right" width="100">' . number_format($tot_ingr, 2, '.', ',') . '</td>
                                                </tr>
                                            </table>    
                                        </td>
                                        <td valign="top" width="350">
                                            <table align="center" border="0" width="100%" style="border-collapse: collapse;">        
                                                <tr>
                                                   
                                                    <td align="right" width="120"><b>TOTAL EGRESO:</b></td>
                                                    <td align="right" width="60">' . number_format($egre, 2, '.', ',') . '</td>
                                                    <td ></td>
                                                </tr>
                                            </table>    
                                        </td>
                                    </tr>';
                            $total_recibi = $tot_ingr - $egre;
                            $table_op .= '<tr>
                                        <td valign="top" width="350">
                                            <table align="center" border="0" width="100%" style="border-collapse: collapse;">        
                                                <tr>
                                                    <td colspan="3"></td>
                                                </tr>
                                            </table>    
                                        </td>
                                        <td valign="top" width="350">
                                            <table align="center" border="0" width="100%" style="border-collapse: collapse;">        
                                                <tr>
                                                  
                                                    <td class="fecha_letra" align="right" width="120"><b>TOTAL A RECIBIR:</b></td>
                                                    <td class="fecha_letra" align="right" width="60">' . number_format($total_recibi, 2, '.', ',') . '</td>
                                                    <td ></td>
                                                </tr>
                                            </table>    
                                        </td>
                                        </tr>';
                            $table_op .= "</table>";

                        } while ($oIfx->SiguienteRegistro());

                    }
                }

                $sql_empr = "select empr_repres from saeempr where empr_cod_empr = $id_empresa ";
                $empr_repres1 = consulta_string_func($sql_empr, 'empr_repres', $oIfxA, '');
                $sql_empr1 = "select empr_ced_repr from saeempr where empr_cod_empr = $id_empresa ";
                $empr_ced_repr = consulta_string_func($sql_empr1, 'empr_ced_repr', $oIfxA, '');

                //$table_op .="</div>";
                $legend .= ' <br><br><br><br><br>
                        <table style="width: 100%; " border="0" >
                            <tr>
                                <td style="width: 50%;" align="center">
                                    _______________________________ <br>
                                        <h5 style="text-align: center;">' . $empl_nom . '<br>' . $cod_empl . '</h5><br><br> 
                                </td>
                                <td style="width: 50%;" align="center">
                                    _______________________________ <br>
                                        <h5 style="text-align: center;">' . $empr_repres1 . '<br>' . $empr_ced_repr . '</h5><br><br>
                                    
                                </td>
                            </tr>
                    </table>';


                $documento .= '<page backimgw="10%" backtop="10mm" backbottom="10mm" backleft="7mm" backright="7mm">';
                $documento .= $table_op;
                $documento .= $legend;
                $documento .= '</page>';

            } while ($oIfxD->SiguienteRegistro());
        }
    }


    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;

    return $documento;
}


//// anticipo empleados
function rol_individual_anticipo($id_empresa = 0, $id_anio = 0, $id_mes = 0, $id_empl = '', $id_depar = 0, $id_proyecto = 0, &$rutaPdf = '')
{
    //Definiciones
    global $DSN_Ifx;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();


    $oIfxB = new Dbo;
    $oIfxB->DSN = $DSN_Ifx;
    $oIfxB->Conectar();


    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();

    $oReturn = new xajaxResponse();

    //anio - mes
    $opAnio = 0;
    if ($id_anio == 2017) {
        $opAnio = 1;
    }



    $nombre_archivo = 'RECIBO_PAGO_' . $id_anio . '_' . $id_mes . '_' . $id_empl;


    if (!empty($id_proyecto)) {

        if (!empty($id_depar)) {
            $sql_depar = " and pago_cod_empl in (  select  esem_cod_empl from saeestr, saeesem where
												estr_cod_estr = esem_cod_estr and
												estr_cod_empr = $id_empresa and
												estr_cod_padr  in ( '$id_depar' )
												group by 1 ) ";



        } else {
            $sql_depar = " and pago_cod_empl in (  select  esem_cod_empl from saeestr, saeesem where
												estr_cod_estr = esem_cod_estr and
												estr_cod_empr = $id_empresa and
												estr_cod_padr  in ( select estr_cod_estr
																		from saeestr where
																		estr_cod_empr = $id_empresa and
																		estr_cod_gpro = '$id_proyecto'  )
												group by 1 ) ";


        }
    }


    $sql_empl = '';

    $sql_empl = " and pago_cod_empl = '$id_empl' ";


    $sql = "select empr_nom_empr, empr_path_logo, empr_img_rep from saeempr where empr_cod_empr = $id_empresa ";


    $empr_nom = consulta_string_func($sql, 'empr_nom_empr', $oIfxA, '');

    $empr_path_logo = consulta_string_func($sql, 'empr_img_rep', $oIfxA, '');

    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;
    $arc_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];

    if (file_exists($arc_img)) {
        $imagen = $arc_img;
    } else {
        $imagen = '';
    }
    $logo = '';
    $x = '0px';
    if ($imagen != '') {

        $empr_logo = '<div align="center">
        <img src="' . $imagen . '" style="
        width:250px;">
        </div>';
        $x = '0px';
    }
    else{
        $empr_logo ='<span><font color="red">SIN LOGO</font></span>';
    }



    //rubro sueldo
    $sql = "select rubr_cod_rubr from saerubr where rubr_tsu_rubr = '1'";
    // echo $sql; exit;

    $rubroSueldo = consulta_string_func($sql, 'rubr_cod_rubr', $oIfxA, '');


    //$oReturn->alert($sql);
    unset($tot_ingr);
    unset($array_table_ingr);
    unset($array_tmp);


    //echo $sql;exit;
    unset($tot_egre);
    $tabla_egre = '';
    unset($array_table_egre);
    unset($array_tmp);
    $tmp = 1;
    $ban = 0;


    //anticipo
    $anticipo = 0;


    // $table_op .='<div width="80%" syle="margin-top: 5px;">';

    // $table_op .='<div width="80%" syle="margin-top: 15px;">';

    //validacion para que los meses del año menores a 10 lleven un 0 al inicio
    // if($id_mes<=9){
    // $id_mes='0'.$id_mes;
    // }
    //------------------------------
    $sql = "select pago_cod_empl
				from saepago, saerubr	where
				rubr_cod_rubr = pago_cod_rubr and
				rubr_cod_empr = pago_cod_empr and
				rubr_cod_empr = $id_empresa and						 
				pago_cod_empr = $id_empresa and
				SUBSTR(cast (pago_per_pago as text), 0, 5) = '$id_anio' and
				SUBSTR(cast (pago_per_pago as text), 5, 2) = '$id_mes' and pago_ori_gene='R'
				$sql_empl 
				$sql_depar
				group by 1
				order by pago_cod_empl";

    $ingr = 0;
    $egre = 0;
    // echo $sql; exit;


    if ($oIfx->Query($sql)) {



        if ($oIfx->NumFilas() > 0) {


            do {
                $cod_empl = $oIfx->f('pago_cod_empl');

                $tabla_ingr = $array_table_ingr[$cod_empl];
                $tabla_egre = $array_table_egre[$cod_empl];

                $egre = $tot_egre [$cod_empl];
                $ingr = $tot_ingr [$cod_empl];

                $sql = "select empl_ape_nomb , empl_sal_sala, empl_jor_trab, empl_val5_empl 
								from saeempl 
								where empl_cod_empr = $id_empresa and 
								empl_cod_empl = '$cod_empl' ";




                $empl_nom = consulta_string_func($sql, 'empl_ape_nomb', $oIfxA, '');

                $salario = consulta_string_func($sql, 'empl_sal_sala', $oIfxA, '');

                $empl_jor_trab = consulta_string_func($sql, 'empl_jor_trab', $oIfxA, '');

                $empl_val5_empl = consulta_string_func($sql, 'empl_val5_empl', $oIfxA, '');


                if ($opAnio == 0) {
                    $sueldo = $salario;
                } else {
                    $sueldo = $empl_val5_empl;
                }


                $sql = "select estr_des_estr, esem_fec_ingr  from saeesem, saeestr where
									estr_cod_estr = esem_cod_estr and
									estr_cod_empr = $id_empresa and
									esem_cod_empl = '$cod_empl' and 
									esem_cod_empr = $id_empresa 
									order by 2 desc";


                $cargo = consulta_string_func($sql, 'estr_des_estr', $oIfxA, '');


                $sql_tmp = "select estr_cod_padr  from saeesem, saeestr where
									estr_cod_estr = esem_cod_estr and
									estr_cod_empr = $id_empresa and
									esem_cod_empl =  '$cod_empl'  and 
									esem_cod_empr = $id_empresa ";






                if ($oIfxB->Query($sql_tmp)) {
                    if ($oIfxB->NumFilas() > 0) {
                        $estr_tmp = $oIfxB->f('estr_cod_padr');
                    }
                }
                $oIfxB->Free();

                $sql_p = "select estr_des_estr  from saeestr where 
									estr_cod_empr = $id_empresa and
									estr_cod_estr = '$estr_tmp'  ";
                if ($oIfxB->Query($sql_p)) {
                    if ($oIfxB->NumFilas() > 0) {
                        $estr_nom = $oIfxB->f('estr_des_estr');
                    }
                }
                $oIfxB->Free();

                // if($id_mes<=9){
                // $id_mes='0'.$id_mes;
                // }
                $sql = "select
							min(anti_obs_anti) as anti_obs_anti,
							sum(anti_val_anti) as anticipo1,
							sum(anti_val_adic) as anticipo2
							from saeanti
							where anti_cod_empl = '$id_empl' and
							anti_cod_empr = $id_empresa and
							DATE_PART('year',anti_fec_anti) = $id_anio and
							DATE_PART('month',anti_fec_anti) =$id_mes";







                $anticipo = consulta_string_func($sql, 'anticipo1', $oIfx, 0);
                $detalle_anti = consulta_string_func($sql, 'anti_obs_anti', $oIfx, 0);

                // echo $anticipo;exit;



                $tabla_ingr = '';
                if ($anticipo > 0) {
                    $tabla_ingr .= '<tr>';
                    $tabla_ingr .= '<td align="left">' . substr($detalle_anti, 0, 17) . '</td>';
                    $tabla_ingr .= '<td align="left">' . number_format($anticipo, 2, '.', ',') . '</td>';
                    $tabla_ingr .= '</tr>';


                }


                $path_img = explode("/", $empr_path_logo);
                $count = count($path_img) - 1;
                $url_absoluta = url_actual() . '/WebApp';
                $path_logo_img = $url_absoluta . '/Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];


                $table_op .= '<div style="width:200mm; height:150mm; font-size:8px ">';
                $table_op .= '<table align="left" style="width: 100%; border:1px solid black; border-radius: 5px; margin-top: 20px;">';
                if ($empr_path_logo != '') {
                    $table_op .= '<tr>
                                         <td colspan="2">
                                            ' . $empr_logo . '
                                        </td>
                                    </tr>';
                }                            $table_op .= '<tr>  
                                        <td class="fecha_letra" style="width: 50%;">EMPRESA: ' . ($empr_nom) . '</td>
                                        <td class="fecha_letra" style="width: 50%;"></td>
                                    </tr>
                                    <tr>    
                                        <td class="fecha_letra">ROL MES: ' . Mes_func($id_mes) . ' ' . $id_anio . '</td>
                                        <td class="fecha_letra"></td>
                                    </tr>
                                    <tr>    
                                        <td class="fecha_letra">NOMBRE: ' . $empl_nom . '</td>
                                        <td class="fecha_letra">CODIGO: ' . $cod_empl . '</td>
                                    </tr>
                                    <tr>    
                                        <td class="fecha_letra">CARGO: ' . $cargo . '</td>
                                        <td class="fecha_letra">DEPARTAMENTO: ' . $estr_nom . '</td>
                                    </tr>
                                    <tr>    
                                        <td class="fecha_letra">FECHA INGRESO EMPRESA: ' . $fecha_ingreso . '</td>
                                        <td class="fecha_letra">FECHA INGRESO CARGO: ' . $fecha_ingreso_cargo . '</td>
                                    </tr>
                                    <tr>
                                        <td class="fecha_letra">SALARIO: ' . number_format($sueldo, 2, '.', ',') . '</td>
                                        <td class="fecha_letra">PERMISOS: ' . $hor_perm . '</td>    
                                    </tr>
                                    <tr>
                                    <td class="fecha_letra">VACACIONES: ' . $hor_vaca . '</td>  
                                    <td class="fecha_letra">FALTAS INJUSTIFICADAS: ' . $hor_falt . '</td>
                                    </tr>
                                    <tr>    
                                        <td class="fecha_letra">JORNADA DE TRABAJO: ' . $empl_jor_trab . '</td>
                                        <td class="fecha_letra">LICENCIA SIN SUELDO: ' . $hor_atra . '</td>
                                    </tr>
                                    <tr>                                        
                                        <td class="fecha_letra">NUMERO DE CUENTA: ' . $empl_num_ctas . '</td>
                                        <td class="fecha_letra"></td>
                                    </tr>';
                $table_op .= '</table>';


                $table_op .= '<br>';

                $table_op .= '<table style="width: 98%; margin-top: 10px;" border="1" style="border-collapse: collapse;">';
                $table_op .= '<tr>
										<td width="50%">INGRESOS</td>
										<td width="50%">DESCUENTOS</td>
									</tr>';
                $table_op .= '<tr>
										<td valign="top" style="width: 50%;">
											<table align="center" border="1" width="99%" style="border-collapse: collapse;">												
												<tr>
													<td style="width: 50%;">DESCRIPCION</td>
													<td style="width: 10%;">DIAS</td>
													<td style="width: 20%;">HORAS</td>
													<td style="width: 17%;">VALOR</td>
												</tr>
												' . $tabla_ingr . '
											</table>
										</td>
										<td valign="top" style="width: 50%;">
											<table align="center" border="1" width="99%" style="border-collapse: collapse;">		
												' . $tabla_egre . '
											</table>	
										</td>
									</tr>';

                $table_op .= '<tr>
										<td valign="top" style="width: 50%;">
											<table align="center" border="0" width="99%" style="border-collapse: collapse;">		
												<tr>
													<td></td>
													<td align="right" width="77%;">TOTAL INGRESO:</td>
													<td align="right" width="20%;">' . number_format($anticipo, 2, '.', ',') . '</td>
												</tr>
											</table>	
										</td>
										<td valign="top" style="width: 50%;">
											<table align="center" border="0" width="99%" style="border-collapse: collapse;">		
												<tr>
													<td></td>
													<td align="right" width="77%;">TOTAL EGRESO:</td>
													<td align="right" width="20%;">' . number_format($egre, 2, '.', ',') . '</td>
												</tr>
											</table>	
										</td>
									</tr>';
                $total_recibi = $anticipo - $egre;
                $table_op .= '<tr>
										<td valign="top" style="width: 50%;">
											<table align="center" border="0" width="99%" style="border-collapse: collapse;">		
												<tr>
													<td colspan="3"></td>
												</tr>
											</table>	
										</td>
										<td valign="top" style="width: 50%;">
											<table align="center" border="0" width="99%" style="border-collapse: collapse;">		
												<tr>
													<td></td>
													<td class="fecha_letra" align="right" width="77%;">TOTAL A RECIBIR:</td>
													<td class="fecha_letra" align="right" width="20%;">' . number_format($total_recibi, 2, '.', ',') . '</td>
												</tr>
											</table>	
										</td>
									</tr>';
                $table_op .= "</table>";




            } while ($oIfx->SiguienteRegistro());

        }else{
            $table_op .= '<div style="width:200mm; height:150mm; font-size:8px ">';
            $table_op .= '<table align="left" style="width: 100%; border:1px solid black; border-radius: 5px; margin-top: 20px;">';
            $table_op .= '<tr>
                                        <td colspan="3">
                                           
                                        </td>
                                    </tr>';
            $table_op .= '<tr>  
                                        <td colspan="3" class="fecha_letra" style="width: 50%;">EMPRESA: . </td>
                                    
                                    </tr>
                                    <tr>    
                                        <td <td colspan="3" class="fecha_letra">ROL MES:  </td>
                                    </tr>
                                    <tr>    
                                        <td class="fecha_letra">NOMBRE: </td>
                                        <td class="fecha_letra">CODIGO: </td>
                                        <td class="fecha_letra">CARGO: </td>
                                    </tr>
                                    <tr>
                                        <td class="fecha_letra">DEPARTAMENTO: </td>
                                        <td class="fecha_letra">FECHA INGRESO EMPRESA: </td>
                                        <td class="fecha_letra">FECHA INGRESO CARGO: </td>
                                    </tr>
                                    <tr>
                                        <td class="fecha_letra">SALARIO: </td>
                                        <td class="fecha_letra">FALTAS JUSTIFICADA: </td>
                                        <td class="fecha_letra">FALTAS INJUSTIFICADAS: </td>
                                    </tr>
                                    <tr>
                                        <td style="width: 50%;" class="fecha_letra">JORNADA DE TRABAJO: </td>
                                    
                                        <td  style="width: 50%;" <td colspan="2" class="fecha_letra">LICENCIA SIN SUELDO: </td>
                                        
                                    </tr>';
            $table_op .= '</table>';

            $table_op .= '<br>';

            $table_op .= '<table style="width: 100%; margin-top: 10px;" border="1" style="border-collapse: collapse;">';
            $table_op .= '<tr>
                                        <td width="50%">INGRESOS</td>
                                        <td width="50%">DESCUENTOS</td>
                                    </tr>';
            $table_op .= '<tr>
                                        <td valign="top" style="width: 50%;">
                                            <table align="center" border="1" width="99%" style="border-collapse: collapse;">                                                
                                                <tr>
                                                    <td style="width: 50%;">DESCRIPCION</td>
                                                    <td style="width: 10%;">DIAS</td>
                                                    <td style="width: 20%;">HORAS</td>
                                                    <td style="width: 17%;">VALOR</td>
                                                </tr>
                                              
                                            </table>
                                        </td>
                                        <td valign="top" style="width: 50%;">
                                            <table align="center" border="1" width="99%" style="border-collapse: collapse;">        
                                               
                                            </table>    
                                        </td>
                                    </tr>';

            $table_op .= '<tr>
                                        <td valign="top" style="width: 50%;">
                                            <table align="center" border="0" width="99%" style="border-collapse: collapse;">        
                                                <tr>
                                                    <td></td>
                                                    <td align="right" width="80%;">TOTAL INGRESO:</td>
                                                    <td align="right" width="20%;"></td>
                                                </tr>
                                            </table>    
                                        </td>
                                        <td valign="top" style="width: 50%;">
                                            <table align="center" border="0" width="99%" style="border-collapse: collapse;">        
                                                <tr>
                                                    <td></td>
                                                    <td align="right" width="80%;">TOTAL EGRESO:</td>
                                                    <td align="right" width="20%;"></td>
                                                </tr>
                                            </table>    
                                        </td>
                                    </tr>';

            $table_op .= '<tr>
                                        <td valign="top" style="width: 50%;">
                                            <table align="center" border="0" width="99%" style="border-collapse: collapse;">        
                                                <tr>
                                                    <td colspan="3"></td>
                                                </tr>
                                            </table>    
                                        </td>
                                        <td valign="top" style="width: 50%;">
                                            <table align="center" border="0" width="99%" style="border-collapse: collapse;">        
                                                <tr>
                                                    <td></td>
                                                    <td class="fecha_letra" align="right" width="80%;">TOTAL A RECIBIR:</td>
                                                    <td class="fecha_letra" align="right" width="20%;"></td>
                                                </tr>

                                            </table>    
                                              <h1> NO SE GENERO UN PAGO !!! </h1>
                                        </td>
                                    </tr>';

            $table_op .= "</table>";


        }
    }

    //$table_op .="</div>";

    $table_op .= '<br><br><br>_____________________<br>
		<h6>Recursos Humanos<br>' . $empr_nom . '</h6><br><br>';
    // $oReturn->alert('Buscando...');
    $table_op .= "</div>";
    $sql = "SELECT empl_mai_empl  FROM saeempl WHERE empl_cod_empl='$id_empl'";
    if ($oIfxB->Query($sql)) {
        if ($oIfxB->NumFilas() > 0) {
            $correo = $oIfxB->f('empl_mai_empl');
        }
    }

    // envio_correo_adj_rol($correo, $table_op, $id_anio, $id_mes);

    $documento .= '<page backimgw="0%" backtop="0mm" backbottom="0mm" backleft="0mm" backright="0mm">';
    $documento .= $table_op;
    // $documento .= $legend;
    $documento .= '</page>';


    $html2pdf = new HTML2PDF('P', 'A4', 'fr');

    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;



    return $documento;
}


function secuencial_func($op, $serie, $as_codigo_pedido, $ceros_sql)
{
    //string
    $ls_codigo;
    $ceros;
    $ls_codigos;

    //integer
    $li_codigo;
    $ceros1;
    $ll_numeros;
    $ll_codigo;

    if (isset($as_codigo_pedido) or $as_codigo_pedido == '') {
        $li_codigo = ($as_codigo_pedido);

        $li_codigo = 0;
    } else {
        $li_codigo = $as_codigo_pedido;
    }

    $li_codigo = $as_codigo_pedido;

    $li_codigo = $li_codigo + 1;
    $ll_numeros = strlen(($li_codigo));
    $ceros = cero_mas_func('0', $ceros_sql);
    $ceros1 = strlen($ceros);
    $ll_codigo = $ceros1 - $ll_numeros;

    switch ($op) {
        case 1:
            // secuencial user
            $ls_codigos = $serie . '-' . (cero_mas_func('0', $ll_codigo)) . ($li_codigo);
            break;
        case 2:
            // secuencial normal
            $ls_codigos = (cero_mas_func('0', $ll_codigo)) . ($li_codigo);
            break;

    }

    return $ls_codigos;

}

function val_check_inv($valor, $verdad, $falso)
{
    $check = '';
    if (!empty($valor)) {
        $check = $verdad;
    } else {
        $check = $falso;
    }
    return $check;
}

function data_last_month_day($month, $year)
{

    $day = date("d", mktime(0, 0, 0, $month + 1, 0, $year));

    return date('Y/m/d', mktime(0, 0, 0, $month, $day, $year));
}


function cantidadDiaMes($fecha)
{

    $timestamp = strtotime($fecha);
    $diasdelmes = date("t", $timestamp);

    return $diasdelmes;
}

/// impresion masiva de roles




/// impresion masiva de roles
function rol_individual_masivo($id_empresa = "", $id_anio = "", $id_mes = "", $array_empleados = "", $id_depar = "", $id_proyecto = "")
{



    //Definiciones
    global $DSN_Ifx;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();


    $oIfxB = new Dbo;
    $oIfxB->DSN = $DSN_Ifx;
    $oIfxB->Conectar();


    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();


    $oIfxD = new Dbo;
    $oIfxD->DSN = $DSN_Ifx;
    $oIfxD->Conectar();

    $oReturn = new xajaxResponse();

    //anio - mes
    $opAnio = 0;
    if ($id_anio == 2017) {
        $opAnio = 1;
    }


    $contador = 0;
    $contador2 = 1;

    $cont=count($array_empleados);

    if($cont>0){

        foreach ($array_empleados as $array) {
            $id_empl = $array;

            //anio - mes
            $opAnio = 0;
            if ($id_anio == 2017) {
                $opAnio = 1;
            }
            $condicion_fecha = '';
            if ($fecha_rol != '') {
                $condicion_fecha = "and pago_fec_real='$fecha_rol'";
            }
            $nombre_archivo = 'RECIBO_PAGO_' . $id_anio . '_' . $id_mes . '_' . $id_empl;
            $sql = "select pago_fec_real, pago_cod_estr
					from saepago 
					where pago_cod_empl='$id_empl' and 
						pago_cod_empr='$id_empresa' and
						SUBSTR(cast (pago_per_pago as text), 0, 5) = '$id_anio' and
						SUBSTR(cast (pago_per_pago as text), 5, 2) = '$id_mes'  and pago_ori_gene='R'
						$condicion_fecha
						group by 1,2";

            $ban_anti = false;
            if ($oIfxD->query($sql)) {
                if ($oIfxD->NumFilas() > 0) {
                    do {
                        $table_op = "";
                        $legend = "";
                        $pago_fec_real = $oIfxD->f('pago_fec_real');
                        $id_depar = $oIfxD->f('pago_cod_estr');
                        $sql_depar = '';
                        if (!empty($id_proyecto)) {
                            if (!empty($id_depar)) {
                                $sql_depar = " and pago_cod_empl in (  select  esem_cod_empl from saeestr, saeesem where
																estr_cod_estr = esem_cod_estr and
																estr_cod_empr = $id_empresa and
																estr_cod_padr  in ( '$id_depar' )
																group by 1 ) ";
                            } else {
                                $sql_depar = " and pago_cod_empl in (  select  esem_cod_empl from saeestr, saeesem where
																estr_cod_estr = esem_cod_estr and
																estr_cod_empr = $id_empresa and
																estr_cod_padr  in ( select estr_cod_estr
																						from saeestr where
																						estr_cod_empr = $id_empresa and
																						estr_cod_gpro = '$id_proyecto'  )
																group by 1 ) ";
                            }
                        }

                        $sql_empl = '';

                        $sql_empl = " and pago_cod_empl = '$id_empl' ";



                        $sql = "select empr_nom_empr, empr_path_logo from saeempr where empr_cod_empr = $id_empresa ";

                        $empr_nom = consulta_string_func($sql, 'empr_nom_empr', $oIfxA, '');
                        $empr_path_logo = consulta_string_func($sql, 'empr_path_logo', $oIfxA, '');
                        $path_img = explode("/", $empr_path_logo);
                        $count = count($path_img) - 1;
                        $arc_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];
                        //echo $arc_img;exit;
                        if (file_exists($arc_img)) {
                            $imagen = $arc_img;
                        } else {
                            $imagen = '';
                        }
                        $logo = '';
                        $x = '0px';
                        if ($imagen != '') {

                            $empr_logo = '<div>
				<img src="' . $imagen . '" style="
				width:300px;">
				</div>';
                            $x = '0px';
                        }
                        else{
                            $empr_logo ='<span><font color="red">SIN LOGO</font></span>';
                        }




                        //rubro sueldo
                        $sql = "select rubr_cod_rubr from saerubr where rubr_tsu_rubr = '1'";

                        $rubroSueldo = consulta_string_func($sql, 'rubr_cod_rubr', $oIfxA, '');

                        //$oReturn->alert($sql);
                        unset($tot_ingr);
                        unset($array_table_ingr);
                        unset($array_tmp);
                        //// prestamos

                        $sql = "select sum(cuot_mot_capi) as valor, pret_cod_empl, tpre_cod_rubr
							from saecuot  c
							 inner join saepret on pret_cod_pret = cuot_cod_pret
							inner join saetpre on tpre_cod_tpre = pret_cod_tpre
							 where 
							pret_cod_empr=tpre_cod_empr and 
							pret_cod_empr='1' and cuot_est_cuot='0' group by pret_cod_empl , tpre_cod_rubr
							";
                        ;
                        //echo $sql; exit;
                        unset($array_prest_pen);
                        if ($oIfx->Query($sql)) {
                            if ($oIfx->NumFilas() > 0) {
                                do {
                                    $array_prest_pen[$oIfx->f('pret_cod_empl')][$oIfx->f('tpre_cod_rubr')] = $oIfx->f('valor');
                                    //$array_prest_pen[$oIfx->f('pret_cod_empl')]['RCAFE']=$oIfx->f('valor');
                                } while ($oIfx->SiguienteRegistro());
                            }
                        }

                        //  var_dump($array_prest_pen);exit;
                        // EGRESOS
                        if (($id_mes < 12) && ($id_anio == 2017)) {
                            $sql = "select  
									pago_cod_rubr, pago_cod_empl,   pago_per_pago, 
									pago_val_pago,  rubr_des_rubr,
									rubr_cod_trub
									from saepago,
									saerubr
									where
									rubr_cod_rubr = pago_cod_rubr and
									rubr_cod_empr = $id_empresa and
									pago_cod_empr = $id_empresa and
									SUBSTR(cast (pago_per_pago as text), 0, 5) = '$id_anio' and
									SUBSTR(cast (pago_per_pago as text), 5, 2) = '$id_mes' and
									rubr_cod_trub = 'D' AND rubr_cod_rubr<>'RIESS' and pago_fec_real='$pago_fec_real' and pago_ori_gene='R'
									$sql_empl 
									order by pago_cod_empl";
                            //echo $sql;
                            //echo 'hola 1 ';exit;
                        } else {
                            $sql = "select  
									pago_cod_rubr, pago_cod_empl,   pago_per_pago, 
									pago_val_pago,  rubr_des_rubr,
									rubr_cod_trub
									from saepago,
									saerubr
									where
									rubr_cod_rubr = pago_cod_rubr and
									rubr_cod_empr = $id_empresa and
									pago_cod_empr = $id_empresa and
									SUBSTR(cast (pago_per_pago as text), 0, 5) = '$id_anio' and
									SUBSTR(cast (pago_per_pago as text), 5, 2) = '$id_mes' and
									rubr_cod_trub = 'D'  and pago_fec_real='$pago_fec_real' and pago_ori_gene='R'
									$sql_empl 
									order by pago_cod_empl";
                            //echo $sql;
                            //echo 'hola 2 ';exit;
                        }


                        unset($tot_egre);
                        $tabla_egre = '';
                        unset($array_table_egre);
                        unset($array_tmp);

                        $tmp = 1;
                        $ban = 0;
                        $i = 0;
                        if ($oIfx->Query($sql)) {
                            if ($oIfx->NumFilas() > 0) {
                                do {

                                    $cod_empl = $oIfx->f('pago_cod_empl');
                                    $rubr_cod = $oIfx->f('pago_cod_rubr');
                                    $pago_per = $oIfx->f('pago_per_pago');
                                    $pago_val = $oIfx->f('pago_val_pago');
                                    $rubr_des = $oIfx->f('rubr_des_rubr');
                                    $rubr_tipo = $oIfx->f('rubr_cod_trub');

                                    $array_tmp [$tmp] = $cod_empl;
                                    if ($tmp > 1) {
                                        if ($array_tmp[$tmp] != $array_tmp[$tmp - 1]) {
                                            $tabla_egre = '';
                                        }
                                    }
                                    if (($tmp == 1) && ($id_mes >= 12) && ($id_anio >= 2017) && ($ban == 0) && ($ban_anti == false)) {
                                        $sql = "select estr_cod_ppag from saeestr where estr_cod_estr='$id_depar' and estr_cod_empr='$id_empresa'";
                                        $control_estr = consulta_string($sql, 'estr_cod_ppag', $oIfxA, '');
                                        //echo $sql;exit;
                                        if ($control_estr == 1) {
                                            unset($tablaAnticipo);
                                            $sql = "SELECT 
													anti_obs_anti,
													anti_val_anti 
												FROM saeanti 
													where anti_cod_empl= '$cod_empl' and 
													DATE_PART('year',anti_fec_anti) = $id_anio and
													DATE_PART('month',anti_fec_anti) = $id_mes";
                                            //echo $sql;exit;
                                            if ($oIfxC->Query($sql)) {
                                                $obs = $oIfxC->f('anti_obs_anti');
                                                $val = $oIfxC->f('anti_val_anti');
                                                //echo $val; exit;
                                                $ban = 1;
                                                //if($val!='0.0'){
                                                if (!empty($val) || $val != '0.0') {
                                                    $tabla_egre .= '<tr>';
                                                    $tabla_egre .= '<td align="left" style="width: 50%;">' . $obs . '</td>';
                                                    $tabla_egre .= '<td align="right" style="width: 25%;">' . number_format($val, 2, '.', ',') . '</td>';
                                                    $tabla_egre .= '<td  align="right" width="25%;">&nbsp;</td>';
                                                    $tabla_egre .= '</tr>';
                                                }

                                            }

                                            $tot_egre [$cod_empl] += $val;
                                            $ban_anti = true;
                                        }
                                    }

                                    if ($sClass == 'off') $sClass = 'on'; else $sClass = 'off';
                                    //var_dump($array_prest_pen);
                                    //exit;
                                    if (empty($array_prest_pen[$cod_empl][$rubr_cod])) {
                                        //if(empty($array_prest_pen[$cod_empl])){
                                        //echo 'hola tabla';
                                        if($rubr_cod!='RANTI') {
                                            $tabla_egre .= '<tr>';
                                            $tabla_egre .= '<td align="left" width="50%;">' . $rubr_des . '</td>';
                                            $tabla_egre .= '<td  align="right" width="25%;">' . number_format($pago_val, 2, '.', ',') . '</td>';
                                            $tabla_egre .= '<td  align="right" width="25%;">&nbsp;</td>';
                                            $tabla_egre .= '</tr>';
                                        }
                                    } else {
                                        $tabla_egre .= '<tr>';
                                        $tabla_egre .= '<td align="left" width="50%;">' . $rubr_des . '</td>';
                                        $tabla_egre .= '<td align="right" width="25%;">' . number_format($pago_val, 2, '.', ',') . '</td>';
                                        $tabla_egre .= '<td align="right" width="25%;">' . number_format($array_prest_pen[$cod_empl][$rubr_cod], 2, '.', ',') . '</td>';
                                        $tabla_egre .= '</tr>';
                                    }

                                    //echo $tabla_egre;
                                    //exit;

                                    $array_table_egre[$cod_empl] = $tabla_egre;

                                    if($rubr_cod!='RANTI') {
                                        $tot_egre [$cod_empl] += $pago_val;
                                    }
                                    $tmp++;

                                    //var_dump($array_table_egre);
                                    $i++;
                                    //var_dump($i.'p');
                                } while ($oIfx->SiguienteRegistro());
                            }
                        }
                        $oIfx->Free();

                        //anticipo
                        $anticipo = 0;
                        if (($val == 0) && ($ban_anti == false)) {
                            $sql = "select estr_cod_ppag from saeestr where estr_cod_estr='$id_depar' and estr_cod_empr='$id_empresa'";
                            $control_estr = consulta_string($sql, 'estr_cod_ppag', $oIfx, '');
                            //echo $sql;exit;
                            if ($control_estr == 1) {
                                $sql = "select sum(anti_val_anti) as anticipo 
								from saeanti
								where anti_cod_empl = '$id_empl' and
								anti_cod_empr = $id_empresa and
								DATE_PART('year',anti_fec_anti) = $id_anio and
								DATE_PART('month',anti_fec_anti) = $id_mes";
                                $anticipo = consulta_string_func($sql, 'anticipo', $oIfx, 0);
                                $ban_anti = true;
                            }
                        }

                        if($anticipo > 0){
                            $tablaAnticipo .='<tr>';
                            $tablaAnticipo .='<td align="left">PAGO QUINCENA</td>';
                            $tablaAnticipo .='<td align="right">'.number_format($anticipo, 2, '.', ',').'</td>';
                            $tablaAnticipo .='</tr>';

                            $array_table_egre[$id_empl] .= $tablaAnticipo;
                            $tot_egre[$id_empl] += $anticipo;
                        }

                        //$table_op .='<div width="80%" syle="margin-top: 5px;">';

                        ///$table_op .='<div width="80%" syle="margin-top: 15px;">';


                        $sql = "select pago_cod_empl
						from saepago, saerubr   where
						rubr_cod_rubr = pago_cod_rubr and
						rubr_cod_empr = pago_cod_empr and
						rubr_cod_empr = $id_empresa and                      
						pago_cod_empr = $id_empresa and
						SUBSTR(cast (pago_per_pago as text), 0, 5) = '$id_anio' and
						SUBSTR(cast (pago_per_pago as text), 5, 2) = '$id_mes' and pago_fec_real='$pago_fec_real' and pago_ori_gene='R'
						$sql_empl 
						$sql_depar
						group by 1
						order by pago_cod_empl";
                        //echo $sql;
                        //exit;
                        $ingr = 0;
                        $egre = 0;
                        if ($oIfx->Query($sql)) {
                            if ($oIfx->NumFilas() > 0) {
                                do {
                                    $cod_empl = $oIfx->f('pago_cod_empl');

                                    $tabla_ingr = $array_table_ingr[$cod_empl];
                                    $tabla_egre = $array_table_egre[$cod_empl];

                                    $egre = $tot_egre [$cod_empl];
                                    $ingr = $tot_ingr [$cod_empl];

                                    $sql = "select empl_ape_nomb , empl_sal_sala, empl_jor_trab, empl_val5_empl, empl_num_ctas 
										from saeempl 
										where empl_cod_empr = $id_empresa and 
										empl_cod_empl = '$cod_empl' ";
                                    $empl_nom = consulta_string_func($sql, 'empl_ape_nomb', $oIfxA, '');
                                    $salario = consulta_string_func($sql, 'empl_sal_sala', $oIfxA, '');
                                    $empl_jor_trab = consulta_string_func($sql, 'empl_jor_trab', $oIfxA, '');
                                    $empl_val5_empl = consulta_string_func($sql, 'empl_val5_empl', $oIfxA, '');
                                    $empl_num_ctas = consulta_string_func($sql, 'empl_num_ctas', $oIfxA, '');

                                    if ($opAnio == 0) {
                                        $sueldo = $salario;
                                    } else {
                                        $sueldo = $empl_val5_empl;
                                    }


                                    $sql = "select estr_des_estr, esem_fec_ingr  from saeesem, saeestr where
											estr_cod_estr = esem_cod_estr and
											estr_cod_empr = $id_empresa and
											esem_cod_empl = '$cod_empl' and 
											esem_cod_empr = $id_empresa 
											order by 2 desc";

                                    $cargo = consulta_string_func($sql, 'estr_des_estr', $oIfxA, '');

                                    $sql_tmp = "select estr_cod_padr  from saeesem, saeestr where
											estr_cod_estr = esem_cod_estr and
											estr_cod_empr = $id_empresa and
											esem_cod_empl =  '$cod_empl'  and 
											esem_cod_empr = $id_empresa ";



                                    if ($oIfxB->Query($sql_tmp)) {
                                        if ($oIfxB->NumFilas() > 0) {
                                            $estr_tmp = $oIfxB->f('estr_cod_padr');
                                        }
                                    }
                                    $oIfxB->Free();

                                    $sql_p = "select estr_des_estr  from saeestr where 
											estr_cod_empr = $id_empresa and
											estr_cod_estr = '$estr_tmp'  ";

                                    if ($oIfxB->Query($sql_p)) {
                                        if ($oIfxB->NumFilas() > 0) {
                                            $estr_nom = $oIfxB->f('estr_des_estr');
                                        }
                                    }
                                    $oIfxB->Free();


                                    // HORAS EXTRAS
                                    $sql = "select  amem_hor_trab, amem_hor_atra, amem_hor_falt,
												amem_hor_perm, amem_hor_e025, amem_hor_lice,
												amem_hor_e050,  amem_hor_e100,  amem_hor_vaca, amem_hor_mate, amem_hor_efer, amem_hor_sein
										from    saeamem where
												amem_cod_empr = $id_empresa and
												amem_cod_empl = '$cod_empl'
												and DATE_PART ('year',amem_fec_amem)= '$id_anio'
												and DATE_PART ('month',amem_fec_amem)= '$id_mes'
												";


                                    if ($oIfxB->Query($sql)) {
                                        if ($oIfxB->NumFilas() > 0) {
                                            $hor_trab = $oIfxB->f('amem_hor_trab');
                                            $hor_atra = ($oIfxB->f('amem_hor_atra') / 8);
                                            $hor_falt = ($oIfxB->f('amem_hor_falt') / 8);
                                            $hor_perm = ($oIfxB->f('amem_hor_perm'));
                                            $hor_25 = $oIfxB->f('amem_hor_e025');
                                            $hor_50 = $oIfxB->f('amem_hor_e050');
                                            $hor_100 = $oIfxB->f('amem_hor_e100');
                                            $hor_vaca = $oIfxB->f('amem_hor_vaca');
                                            $hor_mater = $oIfxB->f('amem_hor_mate');
                                            $hor_sein = ($oIfxB->f('amem_hor_sein') / 8);
                                            //$hor_sein= ($oIfxB->f('amem_hor_mate')/8);
                                            $hor_lice = vacios($oIfxB->f('amem_hor_lice'), '0.0');
                                            $hor_efer = vacios($oIfxB->f('amem_hor_efer'), '0.0');
                                            $hor_trab = ($hor_trab - $hor_lice - $hor_efer - $hor_vaca);

                                        }
                                    }

                                    // INGRESOS
                                    $sql = "select  
									pago_cod_rubr, pago_cod_empl,   pago_per_pago, 
									pago_val_pago,  rubr_des_rubr,
									rubr_cod_trub
									from saepago,
									saerubr
									where
									rubr_cod_rubr = pago_cod_rubr and
									rubr_cod_empr = $id_empresa and                      
									pago_cod_empr = $id_empresa and
									SUBSTR(cast (pago_per_pago as text), 0, 5) = '$id_anio' and
									SUBSTR(cast (pago_per_pago as text), 5, 2) = '$id_mes' and
									rubr_cod_trub = 'I' and rubr_cod_rubr<>'RSUEN' AND   rubr_cod_rubr<>'RIEAS' and pago_fec_real='$pago_fec_real' and pago_ori_gene='R'
									$sql_empl  
									order by rubr_des_alia";


                                    $tabla_ingr = '';
                                    $tmp = 1;
                                    if ($oIfx->Query($sql)) {
                                        if ($oIfx->NumFilas() > 0) {
                                            do {
                                                $cod_empl = $oIfx->f('pago_cod_empl');
                                                $rubr_cod = $oIfx->f('pago_cod_rubr');
                                                $pago_per = $oIfx->f('pago_per_pago');
                                                $pago_val = $oIfx->f('pago_val_pago');
                                                $rubr_des = $oIfx->f('rubr_des_rubr');
                                                $rubr_tipo = $oIfx->f('rubr_cod_trub');
                                                $array_tmp [$tmp] = $cod_empl;

                                                /*if($rubr_cod == $rubroSueldo){
                                                $salario = $pago_val;
                                            }*/

                                                if ($tmp > 1) {
                                                    if ($array_tmp[$tmp] != $array_tmp[$tmp - 1]) {
                                                        $tabla_ingr = '';
                                                    }
                                                }

                                                //$fecha_ingreso = ingreso_fecha($cod_empl);
                                                //$fecha_ingreso_cargo = ingreso_fecha_cargo($cod_empl);
                                                $ban = 0;
                                                $tabla_ingr .= '<tr>';
                                                $tabla_ingr .= '<td align="left">' . $rubr_des . '</td>';
                                                if ($rubr_cod == 'RHEVC') {
                                                    $tabla_ingr .= '<td align="left"></td>';
                                                    $tabla_ingr .= '<td align="left">' . $hor_25 . '</td>';

                                                    $ban = 1;
                                                }
                                                if ($rubr_cod == 'RHECI') {
                                                    $tabla_ingr .= '<td align="left"></td>';
                                                    $tabla_ingr .= '<td align="left">' . $hor_100 . '</td>';
                                                    //$tabla_ingr .='<td align="left"></td>';
                                                    $ban = 1;
                                                }
                                                if ($rubr_cod == 'RHECC') {
                                                    $tabla_ingr .= '<td align="left"></td>';
                                                    $tabla_ingr .= '<td align="left">' . $hor_50 . '</td>';
                                                    //$tabla_ingr .='<td align="left"></td>';
                                                    $ban = 1;
                                                }
                                                if ($rubr_cod == 'RSUEL') {
                                                    //$tabla_ingr .='<td align="left">'.$hor_trab.'</td>';

                                                    $dias_tra = ($hor_trab / 8);
                                                    $tabla_ingr .= '<td align="left">' . $dias_tra . '</td>';
                                                    $tabla_ingr .= '<td align="left"></td>';
                                                    $ban = 1;
                                                }
                                                if ($rubr_cod == 'RLICE') {
                                                    //$tabla_ingr .='<td align="left">'.$hor_lice.'</td>';
                                                    //$tabla_ingr .='<td align="left"></td>';
                                                    $dias_lice = ($hor_lice / 8);
                                                    $tabla_ingr .= '<td align="left">' . $dias_lice . '</td>';
                                                    $tabla_ingr .= '<td align="left"></td>';
                                                    $ban = 1;
                                                }
                                                if ($rubr_cod == 'RLICD') {
                                                    //$tabla_ingr .='<td align="left">'.$hor_efer.'</td>';
                                                    //$tabla_ingr .='<td align="left"></td>';
                                                    $dias_efer = ($hor_efer / 8);
                                                    $tabla_ingr .= '<td align="left">' . $dias_efer . '</td>';
                                                    $tabla_ingr .= '<td align="left"></td>';
                                                    $ban = 1;
                                                }
                                                if ($rubr_cod == 'RVACP') {
                                                    //$tabla_ingr .='<td align="left">'.$hor_vaca.'</td>';
                                                    //$tabla_ingr .='<td align="left"></td>';
                                                    $dias_vaca = ($hor_vaca / 8);
                                                    $tabla_ingr .= '<td align="left">' . $dias_vaca . '</td>';
                                                    $tabla_ingr .= '<td align="left"></td>';
                                                    $ban = 1;
                                                }
                                                if ($rubr_cod == 'RMATE') {
                                                    //$tabla_ingr .='<td align="left">'.$hor_vaca.'</td>';
                                                    //$tabla_ingr .='<td align="left"></td>';
                                                    $dias_mater = ($hor_mater / 8);
                                                    $tabla_ingr .= '<td align="left">' . $dias_mater . '</td>';
                                                    $tabla_ingr .= '<td align="left"></td>';
                                                    $ban = 1;
                                                }

                                                if ($ban == 0) {
                                                    $tabla_ingr .= '<td align="left"></td>';
                                                    $tabla_ingr .= '<td align="left"></td>';
                                                }
                                                $tabla_ingr .= '<td align="right">' . number_format($pago_val, 2, '.', ',') . '</td>';
                                                $tabla_ingr .= '</tr>';

                                                $array_table_ingr [$cod_empl] = $tabla_ingr;


                                                $tot_ingr += $pago_val;
                                                $tmp++;
                                            } while ($oIfx->SiguienteRegistro());
                                        }
                                    }


                                    $path_img = explode("/", $empr_path_logo);
                                    $count = count($path_img) - 1;
                                    $url_absoluta = url_actual() . '/WebApp';
                                    $path_logo_img = $url_absoluta . '/Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];

                                    $table_op .= '<table align="left" style="width: 100%; border:1px solid black; border-radius: 5px; margin-top: 20px;">';
                                    if ($empr_path_logo != '') {
                                        $table_op .= '<tr>
												 <td colspan="2">
													' . $empr_logo . '
												</td>
											</tr>';
                                    }

                                    $table_op .= '<tr>  
												<td class="fecha_letra" style="width: 50%;">EMPRESA: ' . ($empr_nom) . '</td>
												<td class="fecha_letra" style="width: 50%;"></td>
											</tr>
											<tr>    
												<td class="fecha_letra">ROL MES: ' . Mes_func($id_mes) . ' ' . $id_anio . '</td>
												<td class="fecha_letra"></td>
											</tr>
											<tr>    
												<td class="fecha_letra">NOMBRE: ' . $empl_nom . '</td>
												<td class="fecha_letra">CODIGO: ' . $cod_empl . '</td>
											</tr>
											<tr>    
												<td class="fecha_letra">CARGO: ' . $cargo . '</td>
												<td class="fecha_letra">DEPARTAMENTO: ' . $estr_nom . '</td>
											</tr>
											<tr>    
												<td class="fecha_letra">FECHA INGRESO EMPRESA: ' . $fecha_ingreso . '</td>
												<td class="fecha_letra">FECHA INGRESO CARGO: ' . $fecha_ingreso_cargo . '</td>
											</tr>
											<tr>
												<td class="fecha_letra">SALARIO: ' . number_format($sueldo, 2, '.', ',') . '</td>
												<td class="fecha_letra">PERMISOS: ' . $hor_perm . '</td>    
											</tr>
											<tr>
											<td class="fecha_letra">VACACIONES: ' . $hor_vaca . '</td>  
											<td class="fecha_letra">FALTAS INJUSTIFICADAS: ' . $hor_falt . '</td>
											</tr>
											<tr>    
												<td class="fecha_letra">JORNADA DE TRABAJO: ' . $empl_jor_trab . '</td>
												<td class="fecha_letra">LICENCIA SIN SUELDO: ' . $hor_atra . '</td>
											</tr>
											<tr>                                        
												<td class="fecha_letra">NUMERO DE CUENTA: ' . $empl_num_ctas . '</td>
												<td class="fecha_letra"></td>
											</tr>';
                                    $table_op .= '</table>';

                                    $table_op .= '<br>';

                                    $table_op .= '<table style="width: 98%; margin-top: 10px;" border="1" style="border-collapse: collapse;">';
                                    $table_op .= '<tr>
												<td width="50%">INGRESOS</td>
												<td width="50%">DESCUENTOS</td>
											</tr>';
                                    $table_op .= '<tr>
												<td valign="top" style="width: 50%;">
													<table align="center" border="1" width="99%" style="border-collapse: collapse;">                                                
														<tr>
															<td style="width: 69%;">DESCRIPCION</td>
															<td style="width: 8%;">DI.</td>
															<td style="width: 10%;">HOR.</td>
															<td style="width: 10%;">VAL.</td>
														</tr>
														' . $tabla_ingr . '
													</table>
												</td>
												<td valign="top" style="width:50%;">
													<table  border="1" width="99%" style="border-collapse: collapse;">  
															<tr>
															<td style="width: 16%;">DESCRIPCION</td>
															<td style="width: 15%;">VALOR</td>
															<td style="width: 15%;">SAL PRES</td>
														</tr>                                           
														' . $tabla_egre . '
													</table>    
												</td>
											</tr>';

                                    $table_op .= '<tr>
												<td valign="top" style="width: 50%;">
													<table align="center" border="0" width="99%" style="border-collapse: collapse;">        
														<tr>
															<td></td>
															<td align="right" width="80%;">TOTAL INGRESO:</td>
															<td align="right" width="20%;">' . number_format($tot_ingr, 2, '.', ',') . '</td>
														</tr>
													</table>    
												</td>
												<td valign="top" style="width: 50%;">
													<table align="center" border="0" width="99%" style="border-collapse: collapse;">        
														<tr>
															<td></td>
															<td align="right" width="30%;">TOTAL EGRESO:</td>
															<td align="right" width="20%;">' . number_format($egre, 2, '.', ',') . '</td>
														</tr>
													</table>    
												</td>
											</tr>';
                                    $total_recibi = $tot_ingr - $egre;
                                    $table_op .= '<tr>
												<td valign="top" style="width: 50%;">
													<table align="center" border="0" width="99%" style="border-collapse: collapse;">        
														<tr>
															<td colspan="3"></td>
														</tr>
													</table>    
												</td>
												<td valign="top" style="width: 50%;">
													<table align="center" border="0" width="99%" style="border-collapse: collapse;">        
														<tr>
															<td></td>
															<td class="fecha_letra" align="right" width="30%;">TOTAL A RECIBIR:</td>
															<td class="fecha_letra" align="right" width="20%;">' . number_format($total_recibi, 2, '.', ',') . '</td>
														</tr>
													</table>    
												</td>
												</tr>';
                                    $table_op .= "</table>";

                                } while ($oIfx->SiguienteRegistro());

                            }
                        }

                        $sql_empr = "select empr_repres from saeempr where empr_cod_empr = $id_empresa ";
                        $empr_repres1 = consulta_string_func($sql_empr, 'empr_repres', $oIfxA, '');
                        $sql_empr1 = "select empr_ced_repr from saeempr where empr_cod_empr = $id_empresa ";
                        $empr_ced_repr = consulta_string_func($sql_empr1, 'empr_ced_repr', $oIfxA, '');

                        //$table_op .="</div>";
                        $legend .= ' <br><br><br><br><br>
								<table style="width: 100%; " border="0" >
									<tr>
										<td style="width: 50%;" align="center">
											_______________________________ <br>
												<h5 style="text-align: center;">' . $empl_nom . '<br>' . $cod_empl . '</h5><br><br> 
										</td>
										<td style="width: 50%;" align="center">
											_______________________________ <br>
												<h5 style="text-align: center;">' . $empr_repres1 . '<br>' . $empr_ced_repr . '</h5><br><br>
											
										</td>
									</tr>
							</table>';


                        $documento .= '<page backimgw="10%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
                        $documento .= $table_op;
                        $documento .= $legend;
                        $documento .= '</page>';

                    } while ($oIfxD->SiguienteRegistro());
                }
            }


        }
    }

    // envio_correo_adj_rol($correo, $table_op, $id_anio, $id_mes);


    //$documento = $table_op.$table_op.$table_op;
    //$documento .= $legend;


    $html2pdf = new HTML2PDF('P', 'A4', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;

    return $documento;
}


/// impresion masiva de roles
function rol_individual_masivo_personalizado($id_empresa = "", $id_anio = "", $id_mes = "", $array_empleados = "", $id_depar = "", $id_proyecto = "")
{



    //Definiciones
    global $DSN_Ifx;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();


    $oIfxB = new Dbo;
    $oIfxB->DSN = $DSN_Ifx;
    $oIfxB->Conectar();


    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();


    $oIfxD = new Dbo;
    $oIfxD->DSN = $DSN_Ifx;
    $oIfxD->Conectar();

    $oReturn = new xajaxResponse();

    $cont=count($array_empleados);
    $documento='';
    if($cont>0){
      

        foreach ($array_empleados as $array){
            $id_empl=$array;
            $duplicado='S';

            $sql="select 
			pago_cod_estr 
		 from saepago 
		 where 
			pago_cod_empl='$id_empl' and 
			pago_cod_empr='$id_empresa' and 
			SUBSTR(cast (pago_per_pago as text), 0, 5) = '$id_anio'
			AND SUBSTR(cast (pago_per_pago as text), 5, 2) = '$id_mes'";
    $pago_cod_estr = consulta_string($sql, 'pago_cod_estr', $oIfx, 0);


            $documento .= rol_individual_personalizado($id_empresa, $id_anio, $id_mes, $id_empl, $id_depar, $id_proyecto, $pago_cod_estr,'','',$duplicado);

        }
    }


    return $documento;


}




function url_actual()
{
    if (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on') {
        $url = "https://";
    } else {
        $url = "http://";
    }
    $app = explode("/", $_SERVER['REQUEST_URI']);
    return $url . $_SERVER['HTTP_HOST'] . '/' . $app[1];
}


/// impresion masiva de anticipos
function rol_masivo_anti($id_empresa = "", $id_anio = "", $id_mes = "", $array_empleados = "", $id_depar = "", $id_proyecto = "")
{
    //Definiciones
    global $DSN_Ifx;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();


    $oIfxB = new Dbo;
    $oIfxB->DSN = $DSN_Ifx;
    $oIfxB->Conectar();


    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();

    $oReturn = new xajaxResponse();

    //anio - mes
    $opAnio = 0;
    if ($id_anio == 2017) {
        $opAnio = 1;
    }
    $cont=count($array_empleados);

    if($cont>0){
        foreach ($array_empleados as $array) {
            $id_empl = $array;

            $nombre_archivo = 'RECIBO_PAGO_' . $id_anio . '_' . $id_mes . '_' . $id_empl;


            if (!empty($id_proyecto)) {

                if (!empty($id_depar)) {
                    $sql_depar = " and pago_cod_empl in (  select  esem_cod_empl from saeestr, saeesem where
													estr_cod_estr = esem_cod_estr and
													estr_cod_empr = $id_empresa and
													estr_cod_padr  in ( '$id_depar' )
													group by 1 ) ";



                } else {
                    $sql_depar = " and pago_cod_empl in (  select  esem_cod_empl from saeestr, saeesem where
													estr_cod_estr = esem_cod_estr and
													estr_cod_empr = $id_empresa and
													estr_cod_padr  in ( select estr_cod_estr
																			from saeestr where
																			estr_cod_empr = $id_empresa and
																			estr_cod_gpro = '$id_proyecto'  )
													group by 1 ) ";


                }
            }


            $sql_empl = '';

            $sql_empl = " and pago_cod_empl = '$id_empl' ";


            $sql = "select empr_nom_empr, empr_path_logo from saeempr where empr_cod_empr = $id_empresa ";


            $empr_nom = consulta_string_func($sql, 'empr_nom_empr', $oIfxA, '');

            $empr_path_logo = consulta_string_func($sql, 'empr_path_logo', $oIfxA, '');

            $path_img = explode("/", $empr_path_logo);
            $count = count($path_img) - 1;
            $arc_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];

            if (file_exists($arc_img)) {
                $imagen = $arc_img;
            } else {
                $imagen = '';
            }
            $logo = '';
            $x = '0px';
            if ($imagen != '') {

                $empr_logo = '<div>
				<img src="' . $imagen . '" style="
				width:300px;">
				</div>';
                $x = '0px';
            }
            else{
                $empr_logo ='<span><font color="red">SIN LOGO</font></span>';
            }



            //rubro sueldo
            $sql = "select rubr_cod_rubr from saerubr where rubr_tsu_rubr = '1'";
            // echo $sql; exit;

            $rubroSueldo = consulta_string_func($sql, 'rubr_cod_rubr', $oIfxA, '');


            //$oReturn->alert($sql);
            unset($tot_ingr);
            unset($array_table_ingr);
            unset($array_tmp);


            //echo $sql;exit;
            unset($tot_egre);
            $tabla_egre = '';
            unset($array_table_egre);
            unset($array_tmp);
            $tmp = 1;
            $ban = 0;


            //anticipo
            $anticipo = 0;


            // $table_op .='<div width="80%" syle="margin-top: 5px;">';

            // $table_op .='<div width="80%" syle="margin-top: 15px;">';

            //validacion para que los meses del año menores a 10 lleven un 0 al inicio
            // if($id_mes<=9){
            // $id_mes='0'.$id_mes;
            // }
            //------------------------------
            $sql = "select pago_cod_empl
					from saepago, saerubr	where
					rubr_cod_rubr = pago_cod_rubr and
					rubr_cod_empr = pago_cod_empr and
					rubr_cod_empr = $id_empresa and						 
					pago_cod_empr = $id_empresa and
					SUBSTR(cast (pago_per_pago as text), 0, 5) = '$id_anio' and
					SUBSTR(cast (pago_per_pago as text), 5, 2) = '$id_mes' and pago_ori_gene='R'
					$sql_empl 
					$sql_depar
					group by 1
					order by pago_cod_empl";

            $ingr = 0;
            $egre = 0;

            if ($oIfx->Query($sql)) {

                $sql = "select empl_ape_nomb , empl_sal_sala, empl_jor_trab, empl_val5_empl 
									from saeempl 
									where empl_cod_empr = $id_empresa and 
									empl_cod_empl = '$id_empl' ";




                $empl_nom = consulta_string_func($sql, 'empl_ape_nomb', $oIfxA, '');

                $salario = consulta_string_func($sql, 'empl_sal_sala', $oIfxA, '');

                $empl_jor_trab = consulta_string_func($sql, 'empl_jor_trab', $oIfxA, '');

                $empl_val5_empl = consulta_string_func($sql, 'empl_val5_empl', $oIfxA, '');



                do {
                    $cod_empl = $oIfx->f('pago_cod_empl');

                    $tabla_ingr = $array_table_ingr[$cod_empl];
                    $tabla_egre = $array_table_egre[$cod_empl];

                    $egre = $tot_egre [$cod_empl];
                    $ingr = $tot_ingr [$cod_empl];




                    if ($opAnio == 0) {
                        $sueldo = $salario;
                    } else {
                        $sueldo = $empl_val5_empl;
                    }


                    $sql = "select estr_des_estr, esem_fec_ingr  from saeesem, saeestr where
										estr_cod_estr = esem_cod_estr and
										estr_cod_empr = $id_empresa and
										esem_cod_empl = '$cod_empl' and 
										esem_cod_empr = $id_empresa 
										order by 2 desc";


                    $cargo = consulta_string_func($sql, 'estr_des_estr', $oIfxA, '');


                    $sql_tmp = "select estr_cod_padr  from saeesem, saeestr where
										estr_cod_estr = esem_cod_estr and
										estr_cod_empr = $id_empresa and
										esem_cod_empl =  '$cod_empl'  and 
										esem_cod_empr = $id_empresa ";






                    if ($oIfxB->Query($sql_tmp)) {
                        if ($oIfxB->NumFilas() > 0) {
                            $estr_tmp = $oIfxB->f('estr_cod_padr');
                        }
                    }
                    $oIfxB->Free();

                    $sql_p = "select estr_des_estr  from saeestr where 
										estr_cod_empr = $id_empresa and
										estr_cod_estr = '$estr_tmp'  ";
                    if ($oIfxB->Query($sql_p)) {
                        if ($oIfxB->NumFilas() > 0) {
                            $estr_nom = $oIfxB->f('estr_des_estr');
                        }
                    }
                    $oIfxB->Free();

                    // if($id_mes<=9){
                    // $id_mes='0'.$id_mes;
                    // }
                    $sql = "select
								min(anti_obs_anti) as anti_obs_anti,
								sum(anti_val_anti) as anticipo1,
								sum(anti_val_adic) as anticipo2
								from saeanti
								where anti_cod_empl = '$id_empl' and
								anti_cod_empr = $id_empresa and
								DATE_PART('year',anti_fec_anti) = $id_anio and
								DATE_PART('month',anti_fec_anti) =$id_mes";







                    $anticipo = consulta_string_func($sql, 'anticipo1', $oIfx, 0);
                    $detalle_anti = consulta_string_func($sql, 'anti_obs_anti', $oIfx, 0);

                    // echo $anticipo;exit;



                    $tabla_ingr = '';
                    if ($anticipo > 0) {
                        $tabla_ingr .= '<tr>';
                        $tabla_ingr .= '<td align="left">' . substr($detalle_anti, 0, 17) . '</td>';
                        $tabla_ingr .= '<td align="left">' . number_format($anticipo, 2, '.', ',') . '</td>';
                        $tabla_ingr .= '</tr>';


                    }


                    $path_img = explode("/", $empr_path_logo);
                    $count = count($path_img) - 1;
                    $url_absoluta = url_actual() . '/WebApp';
                    $path_logo_img = $url_absoluta . '/Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];


                    $table_op .= '<div style="width:200mm; height:150mm; font-size:8px ">';
                    $table_op .= '<table align="left" style="width: 100%; border:1px solid black; border-radius: 5px; margin-top: 20px;">';
                    if ($empr_path_logo != '') {
                        $table_op .= '<tr>
											 <td colspan="2">
												' . $empr_logo . '
											</td>
										</tr>';
                    }                            $table_op .= '<tr>  
											<td class="fecha_letra" style="width: 50%;">EMPRESA: ' . ($empr_nom) . '</td>
											<td class="fecha_letra" style="width: 50%;"></td>
										</tr>
										<tr>    
											<td class="fecha_letra">ROL MES: ' . Mes_func($id_mes) . ' ' . $id_anio . '</td>
											<td class="fecha_letra"></td>
										</tr>
										<tr>    
											<td class="fecha_letra">NOMBRE: ' . $empl_nom . '</td>
											<td class="fecha_letra">CODIGO: ' . $cod_empl . '</td>
										</tr>
										<tr>    
											<td class="fecha_letra">CARGO: ' . $cargo . '</td>
											<td class="fecha_letra">DEPARTAMENTO: ' . $estr_nom . '</td>
										</tr>
										<tr>    
											<td class="fecha_letra">FECHA INGRESO EMPRESA: ' . $fecha_ingreso . '</td>
											<td class="fecha_letra">FECHA INGRESO CARGO: ' . $fecha_ingreso_cargo . '</td>
										</tr>
										<tr>
											<td class="fecha_letra">SALARIO: ' . number_format($sueldo, 2, '.', ',') . '</td>
											<td class="fecha_letra">PERMISOS: ' . $hor_perm . '</td>    
										</tr>
										<tr>
										<td class="fecha_letra">VACACIONES: ' . $hor_vaca . '</td>  
										<td class="fecha_letra">FALTAS INJUSTIFICADAS: ' . $hor_falt . '</td>
										</tr>
										<tr>    
											<td class="fecha_letra">JORNADA DE TRABAJO: ' . $empl_jor_trab . '</td>
											<td class="fecha_letra">LICENCIA SIN SUELDO: ' . $hor_atra . '</td>
										</tr>
										<tr>                                        
											<td class="fecha_letra">NUMERO DE CUENTA: ' . $empl_num_ctas . '</td>
											<td class="fecha_letra"></td>
										</tr>';
                    $table_op .= '</table>';


                    $table_op .= '<br>';

                    $table_op .= '<table style="width: 98%; margin-top: 10px;" border="1" style="border-collapse: collapse;">';
                    $table_op .= '<tr>
											<td width="50%">INGRESOS</td>
											<td width="50%">DESCUENTOS</td>
										</tr>';
                    $table_op .= '<tr>
											<td valign="top" style="width: 50%;">
												<table align="center" border="1" width="99%" style="border-collapse: collapse;">												
													<tr>
														<td style="width: 50%;">DESCRIPCION</td>
														<td style="width: 10%;">DIAS</td>
														<td style="width: 20%;">HORAS</td>
														<td style="width: 17%;">VALOR</td>
													</tr>
													' . $tabla_ingr . '
												</table>
											</td>
											<td valign="top" style="width: 50%;">
												<table align="center" border="1" width="99%" style="border-collapse: collapse;">		
													' . $tabla_egre . '
												</table>	
											</td>
										</tr>';

                    $table_op .= '<tr>
											<td valign="top" style="width: 50%;">
												<table align="center" border="0" width="99%" style="border-collapse: collapse;">		
													<tr>
														<td></td>
														<td align="right" width="80%;">TOTAL INGRESO:</td>
														<td align="right" width="20%;">' . number_format($anticipo, 2, '.', ',') . '</td>
													</tr>
												</table>	
											</td>
											<td valign="top" style="width: 50%;">
												<table align="center" border="0" width="99%" style="border-collapse: collapse;">		
													<tr>
														<td></td>
														<td align="right" width="80%;">TOTAL EGRESO:</td>
														<td align="right" width="20%;">' . number_format($egre, 2, '.', ',') . '</td>
													</tr>
												</table>	
											</td>
										</tr>';
                    $total_recibi = $anticipo - $egre;
                    $table_op .= '<tr>
											<td valign="top" style="width: 50%;">
												<table align="center" border="0" width="99%" style="border-collapse: collapse;">		
													<tr>
														<td colspan="3"></td>
													</tr>
												</table>	
											</td>
											<td valign="top" style="width: 50%;">
												<table align="center" border="0" width="99%" style="border-collapse: collapse;">		
													<tr>
														<td></td>
														<td class="fecha_letra" align="right" width="80%;">TOTAL A RECIBIR:</td>
														<td class="fecha_letra" align="right" width="20%;">' . number_format($total_recibi, 2, '.', ',') . '</td>
													</tr>
												</table>	
											</td>
										</tr>';
                    $table_op .= "</table>";




                } while ($oIfx->SiguienteRegistro());

            }

            //$table_op .="</div>";

            $table_op .= '<br><br><br>_____________________<br>
			<h6>Recursos Humanos<br>' . $empr_nom . '</h6><br><br>';
            // $oReturn->alert('Buscando...');
            $table_op .= "</div>";
            $sql = "SELECT empl_mai_empl  FROM saeempl WHERE empl_cod_empl='$id_empl'";
            if ($oIfxB->Query($sql)) {
                if ($oIfxB->NumFilas() > 0) {
                    $correo = $oIfxB->f('empl_mai_empl');
                }
            }

        }
    }
    $documento .= '<page backimgw="0%" backtop="0mm" backbottom="0mm" backleft="0mm" backright="0mm">';
    $documento .= $table_op;
    // $documento .= $legend;
    $documento .= '</page>';

    $html2pdf = new HTML2PDF('P', 'A4', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;

    return $documento;
}

function finiquito_liquidacion($id_empresa = 0, $id_anio = 0, $id_mes = 0, $id_empl = '', $id_depar = 0, $id_proyecto = 0, &$rutaPdf = '')
{
    //Definiciones
    global $DSN_Ifx;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();


    $oIfxB = new Dbo;
    $oIfxB->DSN = $DSN_Ifx;
    $oIfxB->Conectar();


    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();

    $oReturn = new xajaxResponse();
    $lon = strlen($id_mes);
    if ($lon == 1) {
        $id_mes = '0' . $id_mes;
    }
    //anio - mes
    $perido = $id_anio . $id_mes;
    //ulitmo dia mes
    $ultimo_dia = date("d", (mktime(0, 0, 0, $id_mes + 1, 1, $id_anio) - 1));

    //$fecha_liqui=$id_anio.'-'.$id_mes.'-'.$ultimo_dia.' 00:00:00';
    $nombre_archivo = 'FINIQUITO_LIQUIDACION_' . $id_anio . '_' . $id_mes . '_' . $id_empl;
    $sql = "select * from saeempr where empr_cod_empr='$id_empresa'";
    $ciudad = consulta_string($sql, 'empr_cod_ciud', $oIfx, '');


    $empr_repres = consulta_string($sql, 'empr_repres', $oIfx, '');
    $empresa = consulta_string($sql, 'empr_nom_empr', $oIfx, '');

    $sql = "select * from saeciud where ciud_cod_ciud='$ciudad'";
    $ciudad = consulta_string($sql, 'ciud_nom_ciud', $oIfx, '');
    $sql = "select * from saeempl where empl_cod_empl='$id_empl'";
    //echo $sql;exit;
    $empl_ape = consulta_string($sql, 'empl_ape_empl', $oIfx, '');
    $empl_nom = consulta_string($sql, 'empl_nom_empl', $oIfx, '');
    $empl_val_sala = consulta_string($sql, 'empl_sal_sala', $oIfx, '');
    $empl_cod_nove = consulta_string($sql, 'empl_cod_nove', $oIfx, '');
    $empl_fir_empl = consulta_string($sql, 'empl_fir_empl', $oIfx, '');
    if ($empl_cod_nove == '') {
        $empl_cod_nove = 'V';
    }
    $sql = "SELECT  nove_des_nove FROM saelnove where nove_ini_nove='$empl_cod_nove'";
    $empl_cod_nove = consulta_string($sql, 'nove_des_nove', $oIfx, '');
    //echo $sql;exit;
    $sql = "select * from saeesem where esem_cod_empr='$id_empresa' and DATE_PART('year',esem_fec_sali)=$id_anio and DATE_PART('MONTH',esem_fec_sali)='$id_mes' and esem_cod_empl='$id_empl'";
    $esem_fec_sali = consulta_string($sql, 'esem_fec_sali', $oIfx, '');
    //echo $sql;exit;
    $array_f = explode('-', $esem_fec_sali);
    $anio_sali = $array_f[0];
    $mes_sali = $array_f[1];
    $dia_sali = $array_f[2];
    $esem_fec_ingr = consulta_string($sql, 'esem_fec_ingr', $oIfx, '');
    $esem_cod_estr = consulta_string($sql, 'esem_cod_estr', $oIfx, '');
    $sql = "select * from saeestr where estr_cod_estr='$esem_cod_estr' and estr_cod_empr='$id_empresa'";
    $estr_des_estr = consulta_string($sql, 'estr_des_estr', $oIfx, '');
    $fecha_liqui = $anio_sali . '-' . $mes_sali . '-' . $dia_sali . ' 00:00:00';
    $documento = '<table   style="width:90%; text-align: justify;">
					<tr>
						<td style="width:100%;" colspan="2" align="center" border="0" ><br><br><strong>ACTA DE FINIQUITO</strong><br><br></td>
					</tr>
					<tr>
						<td  style="width:100%" colspan="2" align="justify" border="0"><p style="margin-left: 10px; margin-right: 10px">En la ciudad de ' . $ciudad . ', ante el se&ntilde;or Inspector de Trabajo de,comparecen: por una parte el se&ntilde;or ' . $empr_repres . ' en calidad de Gerente General
								y como tal Representante de la Empresa ' . htmlentities($empresa) . ' como Ex-Empleador,  y por otra parte el se&ntilde;or/a ' . $empl_ape . ' ' . $empl_nom . '
								con identificacion #' . $id_empl . ' de Ex-Trabajador; quienes libre y voluntariamente convienen en dar por terminadas las relaciones de  trabajo a partir	del ' . $esem_fec_sali . ' a consecuencia de
						 		' . htmlentities($empl_cod_nove) . ' y de acuerdo a las cl&aacute;usulas siguientes:</p><br>
						</td>
					</tr>
					<tr>
						
						<td  style="width:10%;"valign="top"  border="0">&nbsp;&nbsp;PRIMERA.-</td>
					
						<td style="width:90%;" border="0">
								 Los comparecientes declaran que el se&ntilde;or/a ' . htmlentities($empl_ape) . ' ' . htmlentities($empl_nom) . ', venia prestando sus servicios l&iacute;citos   y personales a &oacute;rdenes de la  Empresa
								 desde el ' . $esem_fec_ingr . ' en calidad de ' . htmlentities($estr_des_estr) . ' con una remuneracion mensual de USD ' . $empl_val_sala . ' d&oacute;lares hasta el ' . $esem_fec_sali . ', fecha en la cual se dan 
								 por terminadas las relaciones de trabajo entre /las partes.<br><br>
								
						</td>
					</tr>
					<tr>
						<td style="width:10%;" valign="top" border="0">&nbsp;&nbsp;SEGUNDA.-</td>
						<td style="width:90%;"  border="0" > De conformidad con lo dispuesto en el Art. 571 del C&oacute;digo de Trabajo, el Inspector del Trabajo, procede a  liquidar en forma pormenorizada
							los valores a los cuales tiene derecho el Ex-Trabajador y cuyo resultado es el que a continuaci&oacute;n  se detalla<br><br>
							
						</td>
					</tr>';
    $sql = "SELECT
				rubr_des_rubr AS concepto,
				0.00 AS tiempo,
				pago_val_pago AS ingreso,
				0.00 AS descuento,
				1 AS grupo,
				rubr_cod_rubr
			FROM
				saepago,
				saerubr
			WHERE
				pago_cod_rubr = rubr_cod_rubr
			AND pago_cod_empr = rubr_cod_empr
			AND pago_cod_empl = '$id_empl'
			AND pago_cod_empr = $id_empresa
			AND pago_per_pago = $perido
			--AND pago_fec_liqu = '$fecha_liqui'
			AND rubr_cod_trub = 'I'
			AND pago_ori_gene = 'L'
			AND rubr_rol_desp = '1'
			UNION
				SELECT
					rubr_des_rubr AS concepto,
					0.00 AS tiempo,
					0.00 AS ingreso,
					pago_val_pago AS descuento,
					3 AS grupo,
					rubr_cod_rubr
				FROM
					saepago,
					saerubr
				WHERE
					pago_cod_rubr = rubr_cod_rubr
				AND pago_cod_empr = rubr_cod_empr
				AND pago_cod_empl ='$id_empl'
				AND pago_cod_empr = $id_empresa
				AND pago_per_pago = $perido
				--AND pago_fec_liqu = '$fecha_liqui'
				AND rubr_cod_trub = 'D'
				AND pago_ori_gene = 'L'
				AND rubr_rol_desp = '1'
				UNION
					SELECT
						rubr_des_rubr AS concepto,
						0.00 AS tiempo,
						Sum(
							pemp_val_mese + pemp_val_aux - pemp_val_paga
						) AS ingreso,
						0.00 AS descuento,
						2 AS grupo,
						rubr_cod_rubr
					FROM
						saepemp,
						saepnom,
						saerubr
					WHERE
						pemp_cod_pnom = pnom_cod_pnom
					AND pemp_cod_empr = pnom_cod_empr
					AND pnom_cod_rubr = rubr_cod_rubr
					AND pnom_cod_empr = rubr_cod_empr
					and pemp_cod_empl = '$id_empl'
					and pemp_cod_empr = $id_empresa
					--and pemp_fec_liqu =  '$fecha_liqui'
					and pnom_pro_desp = '1'
					group by
						rubr_cod_rubr,rubr_des_rubr
					order by 5 asc";
    //echo $sql;exit;
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $tabla_valores = '<br><table align="center">
								<tr>
									<td >Concepto</td>
									<td >Ingreso</td>
									<td >Descuento</td>
								</tr>';
            $i = 1;
            $total_ing = 0;
            $total_des = 0;
            do {
                $concepto = $oIfx->f('concepto');
                $ingreso = $oIfx->f('ingreso');
                $descuento = $oIfx->f('descuento');
                $rubro = $oIfx->f('rubr_cod_rubr');
                $total_ing += $ingreso;
                $total_des += $descuento;

                if ($ingreso == 0) {
                    $ingreso = '';
                }
                if ($descuento == 0) {
                    $descuento = '';
                }
                $style = null;
                if ($i == 1) {
                    $style = 'style="border-top: 1px solid black"';
                }


                if ($ingreso!='' || $descuento!='') {
                    $tabla_valores .= '<tr>
									<td ' . $style . ' >' . $concepto . '</td>
									<td ' . $style . ' align="right">' . $ingreso . '</td>
									<td ' . $style . ' align="right">' . $descuento . '</td>
								</tr>';
                }
                $i++;
            } while ($oIfx->SiguienteRegistro());
            $tabla_valores .= '</table><br>&nbsp;&nbsp;TOTAL LIQUIDO A RECIBIR: US$ ' . ($total_ing - $total_des) . '<br><br>';
        }
    }
    $firma_img = '<br><br><br><br><br><br><br>';
    if(!empty($empl_fir_empl)){
        $dir_fir = DIR_FACTELEC . "Include/Clases/Formulario/Plugins/reloj/" . basename($empl_fir_empl);
        if (file_exists($dir_fir)) {
            $firma_img = '
                <img src="' . $dir_fir . '" style="
                width:200px;
                object-fit; contain;">
                ';
        }
    }

    $total = $total_ing - $total_des;
    $V = new EnLetras();
    $con_letra = strtoupper($V->ValorEnLetras($total, 'dolar'));
    $documento .= '<tr><td  style="width:100%;" colspan="2" border="0" >' . $tabla_valores . '</td></tr>';
    $documento .= '<tr>
					<td style="width:10%;" border="0" valign="top">&nbsp;&nbsp;TERCERA.- </td>
					<td style="width:90%;" border="0">En esta fecha el Representante de la Empresa entrega al se&ntilde;or. La cantidad de ' . $con_letra . ' ($' . number_format($total,2) . '),
					quien manifiesta su total conformidad con la liquidaci&oacute;n procedente en todas sus partes, declarando expresamente cancelados en su totalidad y reconoce a la vez 
					que todos los derechos y beneficios laborales y contractuales le han sido pagados en su integridad en forma oportuna durante el tiempo que dur&oacute; la relaci&oacute;n laboral.
					 Deja constancia que durante el tiempo que laboro con ' . htmlentities($empresa) . ' no ha sufrido enfermedad profesional o accidente de trabajo que lo incapacite
					 total o parcialmente en forma temporal o permanente para el desempeño de sus labores habituales.<br><br>
					 Por lo tanto, releva a la Empresa de cualquier obligaci&oacute;n al igual que otros administradores, representante, sucesores o subrogantes, no teniendo que reclamar
					 por ning&uacute;n concepto ni a presente ni a futuro; reserv&aacute;ndose solamente el derecho a reclamar las utilidades correspondientes al a&ntilde;o ' . $anio_sali . ' en el caso que hubiere. 
					 Adicionalmente declaro no encontrarme en licencia por paternidad.<br><br></td>
				</tr>
				<tr>
					<td  style="width:10%;" border="0" valign="top">&nbsp;&nbsp;CUARTA.-</td>
					<td style="width:90%;"border="0">Las partes, ratific&aacute;ndose en las clausulas precedentes, en la liquidaci&oacute;n de haberes pormenorizada efectuada por el Inspector del Trabajo y, en especial en la 
					  terminaci&oacute;n de las relaciones de trabajo, acuerdan otorgar a la presente Acta de Finiquito, la fuerza de SENTENCIA EJECUTORIADA, pasada ante Autoridad 
					  de cosa juzgada y de finiquito inviolable.<br><br><br></td>
				</tr>
				<tr>
					<td border="0" colspan="2"><p style="margin-left: 10px; margin-right: 10px">Para constancia, los comparecientes suscriben el presente documento en unidad de acto, conjuntamente con el se&ntilde;or Inspector de Trabajo que interviene y certifica.</p></td>
				</tr>
					</table><br><br><br><br><br><br><br><br>
					<table align="center" border="0" width="100%">
						<tr>
							<td align="center">EX-TRABAJADOR</td>
							<td></td>
							<td align="center">POR ' . htmlentities($empresa) . '</td>
						</tr>
						<tr>
							<td align="center">'.$firma_img.'</td>
							<td></td>
							<td align="center"><br><br><br><br><br><br><br></td>
						</tr>
						<tr>
							<td style="border-top: 1px solid black" align="center"> ' . htmlentities($empl_ape) . ' ' . htmlentities($empl_nom) . '<br>C.I.#: ' . $id_empl . '<br><br><br><br><br><br><br></td>
							<td></td>
							<td style="border-top: 1px solid black" align="center">' . htmlentities($empr_repres) . '<br><br><br><br><br><br><br><br></td>
						</tr>
						<tr>
							<td></td>
							<td></td>
							<td></td>
						</tr>
						<tr>
							<td></td>
							<td style="border-top: 1px solid black" align="center" >INSPECTOR DE TRABAJO</td>
							<td></td>
						</tr>
					</table>';


    $table_op .= '<page style="border-style: solid;" backimgw="50%" backtop="20mm" backbottom="1mm" backleft="1mm" backright="1mm">';
    $table_op .= $documento;
    //$documento .= $legend;
    $table_op .= '</page>';

    $html2pdf = new HTML2PDF('P', 'A4', 'fr');
    $html2pdf->WriteHTML($table_op);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;

    return $documento;
}


////PDF DIARIOS, INGRESOS, EGRESOS, MAS LOGO EMPRESA
function generar_diarios_ingresos_pdf($idempresa = "", $idsucursal = "", $asto_cod = "", $ejer_cod = "", $prdo_cod = "")
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $idEmpresa = $_SESSION['U_EMPRESA'];

    $class = new GeneraDetalleAsientoContable();

    $arrayAsto = $class->informacionAsientoContable($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $asto_cod);

    $arrayDiario = $class->diarioAsientoContable($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $asto_cod);

    $arrayDirectorio = $class->directorioAsientoContable($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $asto_cod);

    $arrayRetencion = $class->retencionAsientoContable($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $asto_cod);

    $sql = "SELECT
			empl_cod_empl,
			empl_nom_empl,
			empl_ape_empl
		 FROM saeempl, SAEPCCH
		WHERE
			SAEPCCH.pcch_cod_empl=saeempl.empl_cod_empl AND empl_cod_empr = $idempresa ";
    if ($oIfx->Query($sql)) {
        unset($array_empl);
        if ($oIfx->NumFilas() > 0) {
            do {
                $empleado = $oIfx->f('empl_nom_empl') . ' ' . $oIfx->f('empl_ape_empl');
                $array_empl[$oIfx->f('empl_cod_empl')] = $empleado;
            } while ($oIfx->SiguienteRegistro());
        }
    }

    foreach ($arrayAsto as $val) {
        $asto_cod_asto = $val[0];
        $asto_vat_asto = $val[1];
        $asto_ben_asto = $val[2];
        $asto_fec_asto = $val[3];
        $asto_det_asto = $val[4];
        $asto_cod_modu = $val[5];
        $asto_usu_asto = $val[6];
        $asto_user_web = $val[7];
        $asto_fec_serv = $val[8];
        $asto_cod_tidu = $val[9];
    }

    $sql = "select empr_ruc_empr, empr_dir_empr, empr_nom_empr, empr_path_logo from saeempr where empr_cod_empr = $idempresa ";
    if ($oIfx->Query($sql)) {
        $empr_ruc = $oIfx->f('empr_ruc_empr');
        $empr_dir = $oIfx->f('empr_dir_empr');
        $empr_nom = $oIfx->f('empr_nom_empr');
        $empr_path_logo = $oIfx->f('empr_path_logo');
        $empr_nom .= ' ';
    }

    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;
    $empr_path_logo = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];

    if (file_exists( $empr_path_logo)) {
        $imagen =  $empr_path_logo;
    } else {
        $imagen = '';
    }
    if ($imagen != '') {

        $empr_logo = '<div>
            <img src="' . $imagen . '" style="
            width: 10%;
            object-fit; contain;">
            </div>';
        $x = '0px';
    }
    else{

        $empr_logo ='<span><font color="red">SIN LOGO</font></span>';
    }



    $sql = "SELECT sucu_nom_sucu FROM saesucu WHERE sucu_cod_sucu='$idsucursal'";
    if ($oIfx->Query($sql)) {
        $sucu_nom = $oIfx->f('sucu_nom_sucu');
    }
    $sql = "select ciud_nom_ciud from saesucu inner join saeciud on saesucu.sucu_cod_ciud=saeciud.ciud_cod_ciud where saesucu.sucu_cod_sucu='$idsucursal'";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ciudad = $oIfx->f('ciud_nom_ciud');
        }
    }

    $sql = "select modu_des_modu from saemodu where modu_cod_modu = $asto_cod_modu";
    $modu_des_modu = consulta_string_func($sql, 'modu_des_modu', $oIfx, '');

    //tipo documento
    $sql = "select tidu_des_tidu from saetidu where tidu_cod_tidu = '$asto_cod_tidu'";
    $tidu_des_tidu = consulta_string_func($sql, 'tidu_des_tidu', $oIfx, '');


    $oIfx->Free();
    setlocale(LC_ALL, "es_ES@euro", "es_ES", "esp");

    $asto_fec = strftime("%d de %B de %Y", strtotime($asto_fec_asto));
    /// minv
    $sql = "select minv_num_comp, minv_num_caja, minv_prec_caja, minv_id_actv from saeminv where minv_cod_empr='$idempresa' and minv_cod_sucu='$idsucursal' and 
				minv_cod_ejer='$ejer_cod' and minv_num_prdo='$prdo_cod' and minv_tran_minv='$asto_cod'";
    $minv_num_caja = consulta_string_func($sql, 'minv_num_caja', $oIfx, '');
    $minv_prec_caja = str_replace('.0', '', consulta_string_func($sql, 'minv_prec_caja', $oIfx, ''));
    $minv_id_actv = consulta_string_func($sql, 'minv_id_actv', $oIfx, 0);

    $html_marco_logio = '';
    if ($minv_id_actv != 0) {
        

        $sql_existe_tabla = "SELECT count(table_name) as contador FROM information_schema.columns 
									WHERE table_name='proyecto_pymes' 
									AND table_schema = 'public'";
            $existe_tabla = consulta_string($sql_existe_tabla, 'contador', $oIfx, 0);
            if ($existe_tabla > 0) {
                $sql_detalle_amrco = 'SELECT codigo, nombre FROM proyecto_pymes WHERE id = ' . $minv_id_actv;
                $nombre_marco_logico = consulta_string_func($sql_detalle_amrco, 'nombre', $oIfx, '');
                $codigo_marco_logico = consulta_string_func($sql_detalle_amrco, 'codigo', $oIfx, '');
                $html_marco_logio = '<br><strong>Marco Logico: </strong> ' . $codigo_marco_logico . '-' . $nombre_marco_logico;
            }

    }





    $rutaImagen = $empr_path_logo;

    $html .= '
        <table border = "0" style="width: 100%; margin-left: 50px; margin-top:20px">
            <tr>
                <td style="font-size:18px; text-align: left; margin-left:100px; margin-top:30px">'.$empr_logo.'</td>
            </tr>
        </table>
        <table border="0" style="width: 100%;">
            <tr>
                <td style="width: 100%; font-size:18px; font-weight: bold; text-align: center">' . $empr_nom . '</td>
            </tr>
            <tr>
                <td  style="width: 100%; font-size:14px; text-align: center"><strong>SUCURSAL:' . $sucu_nom . '</strong></td>
            </tr>
            <tr>
                <td  style="width: 100%; font-size:14px; text-align: center"><strong>DIRECCION:' . $empr_dir . '</strong></td>
            </tr>
            <tr>
                <td style="width: 100%; font-size:14px; text-align: center"><strong>RUC:' . $empr_ruc . '</strong><br><br></td>
            </tr>
		</table>
		<table border="0" style="width:90%; margin-left:50px; ">
				<tr>
					<td style="width: 50%;font-size:12px; text-align: left"><strong>Fecha:</strong> ' . $ciudad . ', ' . $asto_fec . '</td>
					<td style="width: 50%; font-size:12px; text-align: left"><strong>Modulo:</strong>' . $modu_des_modu . '</td>
				</tr>
				
				<tr>
					<td  style="width:50%; font-size:12px; text-align: left"><strong>Monto: </strong>$ ' . number_format($asto_vat_asto, 2, '.', ',') . '</td>
					<td style="width: 50%; font-size:12px; text-align: left"><strong>Documento:</strong> ' . $asto_cod_tidu . ' - ' . $tidu_des_tidu . '</td>
				</tr>
				<tr>
					<td  style="width: 50%; font-size:12px; text-align: left"><strong>Beneficiario: </strong> ' . $asto_ben_asto . '</td>
					<td style="width: 50%; font-size:14px; text-align: left"><strong>Comprobante No:</strong>' . $asto_cod_asto . '</td>
				</tr>
			
				<tr>
					<td colspan="2" style="width: 50%; font-size:12px; text-align: left">
                        <strong>Detalle:</strong> ' . $asto_det_asto . '
                        '.$html_marco_logio.'
                    </td>
					
				</tr>';

    if ($minv_prec_caja != '') {
        $html .= '<tr>
					<td  style="width: 50%; font-size:12px; text-align: left"><strong>Responsable Caja: </strong> ' . $array_empl[$minv_prec_caja] . '</td>
					<td style="width: 50%;font-size:14px; text-align: left"><strong>Secuencia No:</strong>' . $minv_num_caja . '</td>

				</tr>';
    }


    $html .= '</table>';


    if (count($arrayDirectorio) > 0) {
        $html .= '
								<table  style="margin-left:50px; width:90%;border:1px solid black; border-radius: 5px; margin-top:20px" align="left">
									<tr>
									    <td colspan="6" style="width:100%; font-size:16px; text-align: center; border-bottom:1px solid "><strong>DIRECTORIO</strong></td>
									</tr>
									<tr>
										<td  style="width:3%;font-size:14px; text-align: center; border-right:1px solid; "><strong>N</strong></td>
										<td  style="width:30%;font-size:14px; text-align: center; border-right:1px solid; "><strong>CLIENTE / PROVEEDOR</strong></td>
										<td  style="width:10%;font-size:14px; text-align: center; border-right:1px solid; "><strong>TRANSACCION</strong></td>
										<td  style="width:20%;font-size:14px; text-align: center; border-right:1px solid; "><strong>FACTURA</strong></td>
										<td  style="width:10%;font-size:14px; text-align: center;  border-right:1px solid; "><strong>DEBITO</strong></td>
										<td  style="width:10%;font-size:14px; text-align: center; "><strong>CREDITO</strong></td>
										
									</tr>';
        foreach ($arrayDirectorio as $val) {
            //directorio

            $dir_cod_dir = $val[0];
            $dir_cod_cli = $val[1];
            $tran_cod_modu = $val[2];
            $dir_cod_tran = $val[3];
            $dir_num_fact = $val[4];
            $dir_detalle = $val[5];
            $dir_fec_venc = $val[6];
            $dir_deb_ml = $val[7];
            $dir_cre_ml = $val[8];
            //clpv
            $clpv_nom_clpv = '';
            if (!empty($dir_cod_cli)) {
                $sql = "select clpv_nom_clpv from saeclpv where clpv_cod_clpv = $dir_cod_cli";
                $clpv_nom_clpv = consulta_string_func($sql, 'clpv_nom_clpv', $oIfx, '');
            }

            $html .= '<tr>';
            $html .= '<td style="width:3%;font-size:12px; text-align: center; border-right:1px solid; border-top:1px solid ">' . $dir_cod_dir . '</td>';
            $html .= '<td style="width:30%;font-size:12px; text-align: center; border-right:1px solid; border-top:1px solid">' . $clpv_nom_clpv . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: center; border-right:1px solid; border-top:1px solid ">' . $dir_cod_tran . '</td>';
            $html .= '<td style="width:20%;font-size:12px; text-align: center; border-right:1px solid; border-top:1px solid ">' . $dir_num_fact . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: right;  border-right:1px solid; border-top:1px solid" align="right">' . number_format($dir_deb_ml, 2, '.', ',') . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: right; border-top:1px solid" align="right">' . number_format($dir_cre_ml, 2, '.', ',') . '</td>';
            $html .= '</tr>';
        }
        $html .= '</table>';
    }

    //retencioncd
    if (count($arrayRetencion) > 0) {

        $html .= '<table  style="margin-left:50px; width:90%;border:1px solid black; border-radius: 5px; margin-top:20px" align="left">';
        $html .= '<tr>';
        $html .= '<td colspan="7" style="width:100%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>RETENCION</strong></td>';
        $html .= '</tr>';
        $html .= '<tr>';
        $html .= '<td style="width:20%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid " ><strong>Cliente/Proveedor</strong></td>';
        $html .= '<td style="width:20%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>Factura</strong></td>';
        $html .= '<td style="width:20%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>Retencion</strong></td>';
        $html .= '<td style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>Codigo</strong></td>';
        $html .= '<td style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>Porcentaje</strong></td>';
        $html .= '<td style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>Base Imp.</strong></td>';
        $html .= '<td style="width:10%;font-size:14px; text-align: center; border-bottom:1px solid "><strong>Valor</strong></td>';
        $html .= '</tr>';
        foreach ($arrayRetencion as $val) {
            $ret_cta_ret = $val[0];
            $ret_porc_ret = $val[1];
            $ret_bas_imp = $val[2];
            $ret_valor = $val[3];
            $ret_num_ret = $val[4];
            $ret_detalle = $val[5];
            $ret_num_fact = $val[6];
            $ret_ser_ret = $val[7];
            $ret_cod_clpv = $val[8];
            $ret_fec_ret = $val[9];

            //clpv
            $clpv_nom_clpv = '';
            if (!empty($ret_cod_clpv)) {
                $sql = "select clpv_nom_clpv from saeclpv where clpv_cod_clpv = $ret_cod_clpv";
                $clpv_nom_clpv = consulta_string_func($sql, 'clpv_nom_clpv', $oIfx, '');
            }

            //fprv
            $printRet = '';
            if ($asto_cod_modu == 4 || $asto_cod_modu == 6) {

                //fecha fprv o minv
                if ($asto_cod_modu == 4) {
                    $sql = "select fprv_fec_emis 
								from saefprv
								where fprv_cod_clpv = $ret_cod_clpv and
								fprv_num_fact = '$ret_num_fact' and
								fprv_cod_asto = '$asto_cod_asto' and
								fprv_cod_ejer = $ejer_cod and
								fprv_cod_empr = $idempresa and
								fprv_cod_sucu = $idsucursal";
                    $fechaEmis = consulta_string_func($sql, 'fprv_fec_emis', $oIfx, '');
                } elseif ($asto_cod_modu == 6) {
                    $sql = "select minv_fmov 
								from saeminv
								where minv_cod_clpv = $ret_cod_clpv and
								minv_fac_prov = '$ret_num_fact' and
								minv_comp_cont = '$asto_cod_asto' and
								minv_cod_ejer = $ejer_cod and
								minv_cod_empr = $idempresa and
								minv_cod_sucu = $idsucursal";
                    $fechaEmis = consulta_string_func($sql, 'minv_fmov', $oIfx, '');
                }

                $printRet = '<div class="btn btn-primary btn-sm" onclick="genera_documento(5, \'' . $campo . '\',\'' . $fprv_clav_sri . '\' ,
																				 \'' . $ret_cod_clpv . '\'  , \'' . $ret_num_fact . '\', \'' . $ejer . '\',
																				 \'' . $asto . '\',  \'' . $fechaEmis . '\', ' . $sucu . ');">
									<span class="glyphicon glyphicon-print"></span>
								</div>';
            }

            $html .= '<tr>';
            $html .= '<td style="width:20%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid" >' . $clpv_nom_clpv . '</td>';
            $html .= '<td style=" width:20%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid" >' . $ret_num_fact . '</td>';
            $html .= '<td style="width:20%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid">' . $ret_ser_ret . ' - ' . $ret_num_ret . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid">' . $ret_cta_ret . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid" align="right">' . $ret_porc_ret . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid" align="right">' . number_format($ret_bas_imp, 2, '.', ',') . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: right;  border-bottom:1px solid" align="right">' . number_format($ret_valor, 2, '.', ',') . '</td>';
            $html .= '</tr>';

        }//fin foreach

        $html .= '</table>';


    }
    ///diario
    if (count($arrayDiario) > 0) {

        $html .= '<table style="margin-left:50px; width:90%; border:1px ; border-radius: 2px; margin-top:20px" align="left">';
        $html .= '<tr>';
        $html .= '<td colspan="6" style="width:100%;font-size:14px; text-align: center; border-bottom:1px;"><strong>DIARIO</strong></td>';
        $html .= '</tr>';
        $html .= '<tr>';
        $html .= '<td style="width:25%;font-size:12px; text-align: center;  border-bottom:1px; border-right:1px "><strong>Cuenta Contable</strong></td>';
        $html .= '<td style="width:15%;font-size:12px; text-align: center;  border-bottom:1px; border-right:1px "><strong>Centro Costos</strong></td>';
        $html .= '<td style="width:15%;font-size:12px; text-align: center;  border-bottom:1px; border-right:1px "><strong>Centro Actividad</strong></td>';
        $html .= '<td style="width:15%;font-size:12px; text-align: center;  border-bottom:1px; border-right:1px "><strong>Documento</strong></td>';
        $html .= '<td style="width:15%;font-size:12px; text-align: center;  border-bottom:1px; border-right:1px "><strong>Debito</strong></td>';
        $html .= '<td style="width:15%;font-size:12px; text-align: center;  border-bottom:1px; border-right:1px "><strong>Credito</strong></td>';
        $html .= '</tr>';
        $totalDeb = 0;
        $totalCre = 0;
        foreach ($arrayDiario as $val) {
            $dasi_cod_cuen = $val[0];
            $dasi_cod_cact = $val[1];
            $ccos_cod_ccos = $val[2];
            $dasi_dml_dasi = $val[3];
            $dasi_cml_dasi = $val[4];
            $dasi_det_asi = $val[5];
            $dasi_num_depo = $val[6];

            //clpv
            $cuen_nom_cuen = '';
            if (!empty($dasi_cod_cuen)) {
                $sql = "select cuen_nom_cuen from saecuen where cuen_cod_cuen = '$dasi_cod_cuen' and cuen_cod_empr = $idempresa";
                $cuen_nom_cuen = consulta_string_func($sql, 'cuen_nom_cuen', $oIfx, '');
            }

            $ccosn_nom_ccosn = '';
            if (!empty($ccos_cod_ccos)) {
                $sql = "select ccosn_nom_ccosn from saeccosn where ccosn_cod_ccosn = '$ccos_cod_ccos' and ccosn_cod_empr = $idempresa";
                $ccosn_nom_ccosn = consulta_string_func($sql, 'ccosn_nom_ccosn', $oIfx, '');
            }

            $cact_nom_cact = '';
            if (!empty($dasi_cod_cact)) {
                $sql = "select cact_nom_cact from saecact where cact_cod_cact = '$dasi_cod_cact' and cact_cod_empr = $idempresa";
                $cact_nom_cact = consulta_string_func($sql, 'cact_nom_cact', $oIfx, '');
            }

            $html .= '<tr>';
            $html .= '<td style="width:25%;font-size:10px; text-align: left;  border-bottom:1px; border-right:1px ">' . $dasi_cod_cuen . ' - ' . $cuen_nom_cuen . '</td>';
            $html .= '<td style="width:15%;font-size:10px; text-align: left;  border-bottom:1px; border-right:1px ">' . $ccos_cod_ccos . ' - ' . $ccosn_nom_ccosn . '</td>';
            $html .= '<td style="width:15%;font-size:10px; text-align: left;  border-bottom:1px; border-right:1px ">' . $dasi_cod_cact . ' - ' . $cact_nom_cact . '</td>';
            $html .= '<td style="width:15%;font-size:10px; text-align: left;  border-bottom:1px; border-right:1px ">' . $dasi_num_depo . '</td>';
            $html .= '<td style="padding: 8px; width:15%;font-size:10px; text-align: right; border-bottom:1px; border-right:1px; margin-top:20px "><label margin-top:20px>' . number_format($dasi_dml_dasi, 2, '.', ',') . '</label></td>';
            $html .= '<td style="padding: 8px; width:15%;font-size:10px; text-align: right; border-bottom:1px; border-right:1px ">' . number_format($dasi_cml_dasi, 2, '.', ',') . '</td>';
            $html .= '</tr>';

            $totalDeb += $dasi_dml_dasi;
            $totalCre += $dasi_cml_dasi;
        }//fin foreach

        //$usuario = $_SESSION['U_NOMBRECOMPLETO'];


        if (!empty($asto_user_web)) {
            $sql = "select u.USUARIO_USER, concat(u.usuario_nombre,' ',u.usuario_apellido) as apenomb  from comercial.usuario u where u.USUARIO_ID = $asto_user_web ";
            $usuario = consulta_string_func($sql, 'usuario_user', $oCon, '');
            $nombre_usuario=consulta_string_func($sql, 'apenomb', $oCon, '');
        } else {
            $usuario = $asto_usu_asto;
            if(!empty($usuario)){
                $sql = "select u.USUARIO_USER, concat(u.usuario_nombre,' ',u.usuario_apellido) as apenomb  from comercial.usuario u where u.USUARIO_ID = $asto_usu_asto ";
                $nombre_usuario=consulta_string_func($sql, 'apenomb', $oCon, '');
            }

        }

        $html .= '<tr>';
        $html .= '<td align="right" style="width:60%;font-size:12px; text-align: right;" colspan="4"><strong>TOTAL</strong></td>';
        $html .= '<td align="right" style="padding: 8px; width:8%;font-size:10px; text-align: right;">' . number_format($totalDeb, 2, '.', ',') . '</td>';
        $html .= '<td align="right" style="padding: 8px; width:8%;font-size:10px;">' . number_format($totalCre, 2, '.', ',') . '</td>';
        $html .= '</tr>';
        $html .= '</table>';
        $sql = "select minv_num_comp, minv_num_caja, minv_prec_caja from saeminv where minv_cod_empr='$idempresa' and minv_cod_sucu='$idsucursal' and 
				minv_cod_ejer='$ejer_cod' and minv_num_prdo='$prdo_cod' and minv_tran_minv='$asto_cod'";

        if ($oIfx->Query($sql)) {
            if ($oIfx->NumFilas() > 0) {
                do {
                    $minv_num_comp = $oIfx->f('minv_num_comp');
                    $sql2 = "select * from saeminr where minr_cod_empr='$idEmpresa' and minr_cod_sucu='$idsucursal' and minr_cod_ejer='$ejer_cod' 
						and minr_num_prdo='$prdo_cod' and minr_num_comp='$minv_num_comp'";
                    if ($oIfx2->Query($sql2)) {
                        if ($oIfx2->NumFilas() > 0) {
                            $html .= '<table  style="margin-left:50px; width:90%;border:1px solid black; border-radius: 5px; margin-top:20px" align="left">';
                            $html .= '<tr>';
                            $html .= '<td colspan="7" style="width:100%;font-size:16px; text-align: center; border-bottom:1px solid "><strong>FACTURAS DE REEMBOLSO</strong></td>';
                            $html .= '</tr>';
                            $html .= '<tr>';
                            $html .= '<td  style="width:3%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid;"><strong>N</strong></td>
									<td  style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid;"><strong>FECHA</strong></td>
									<td  style="width:15%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid;"><strong>IDENTIFICACION</strong></td>
									<td  style="width:20%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid;"><strong>N. ESTAB.</strong></td>
									<td  style="width:20%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid;"><strong>PTO. EMISION</strong></td>
									<td  style="width:20%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid;"><strong>FACTURA</strong></td>
									<td  style="width:10%;font-size:14px; text-align: center; border-bottom:1px solid;"><strong>VALOR</strong></td>';
                            $html .= '</tr>';
                            $i = 1;
                            $gran_t_remm = 0;
                            do {
                                $html .= '<tr>';
                                $html .= '<td  style="width:3%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid;">' . $i . '</td>
									<td  style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid;">' . $oIfx2->f('minr_fec_emis') . '</td>
									<td  style="width:15%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid;">' . $oIfx2->f('minr_ide_prov') . '</td>
									<td  style="width:20%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid;">' . $oIfx2->f('minr_num_esta') . '</td>
									<td  style="width:20%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid;">' . $oIfx2->f('minr_pto_emis') . '</td>
									<td  style="width:20%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid;">' . $oIfx2->f('minr_sec_docu') . '</td>
									<td  style="width:10%;font-size:14px; text-align: right;  border-right:1px solid; border-bottom:1px solid;">' . ($oIfx2->f('minr_con_miva') + $oIfx2->f('minr_sin_miva') + $oIfx2->f('minr_iva_valo')) . '</td>';
                                $html .= '</tr>';
                                $i++;
                                $gran_t_remm += ($oIfx2->f('minr_con_miva') + $oIfx2->f('minr_sin_miva') + $oIfx2->f('minr_iva_valo'));
                            } while ($oIfx2->SiguienteRegistro());
                            $html .= '<tr>';
                            $html .= '<td  colspan="6" style="width:3%;font-size:14px; text-align: right; border-right:1px solid;"><strong>TOTAL</strong></td>
									 <td  style="width:10%;font-size:14px; text-align: right;   ">' . $gran_t_remm . '</td>';
                            $html .= '</tr>';
                            $html .= '</table>';
                        }
                    }
                } while ($oIfx->SiguienteRegistro());
            }
        }






        
        // ------------------------------------------------------------------------------------------
        // TABLA BENEFICIARIOS
        // ------------------------------------------------------------------------------------------

        // Tabla de beneficiarios proceso fedexport tabla: proy_fact_benf
        // beneficiarios

        $sql_existe_tabla = "SELECT count(table_name) as contador FROM information_schema.columns 
									WHERE table_name='proy_fact_benf' 
									AND table_schema = 'public'";
        $existe_tabla = consulta_string($sql_existe_tabla, 'contador', $oIfx, 0);
        if ($existe_tabla > 0) {

            $sql_beneficiarios = "SELECT id_prove, id_clpv, valor 
                                    from proy_fact_benf 
                                    where 
                                    id_empresa =  $idempresa and 
                                    id_sucursal = $idsucursal and
                                    asto = '$asto_cod_asto' and
                                    ejer = $ejer_cod
                                    ";

            $cont_ben = 1;
            $valor_total = 0;
            if ($oIfx->Query($sql_beneficiarios)) {
                if ($oIfx->NumFilas() > 0) {

                    $html .= '<table  style="margin-left:50px; width:90%;border:1px solid black; border-radius: 5px; margin-top:20px" align="left">';
                    $html .= '<tr>';
                    $html .= '<td colspan="7" style="width:100%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>GASTOS BENEFICIARIOS</strong></td>';
                    $html .= '</tr>';
                    $html .= '<tr>';
                    $html .= '<td style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid " ><strong>No.</strong></td>';
                    $html .= '<td style="width:70%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>Cliente</strong></td>';
                    $html .= '<td style="width:20%;font-size:14px; text-align: center; border-bottom:1px solid "><strong>Valor</strong></td>';
                    $html .= '</tr>';


                    do {
                        $id_prove = $oIfx->f('id_prove');
                        $id_clpv = $oIfx->f('id_clpv');
                        $valor = $oIfx->f('valor');
                        $valor_total = $valor_total + $valor;


                        $sql_nom_ben = "SELECT nom_clpv FROM contrato_clpv where id_clpv = $id_clpv";
                        $nom_clpv = consulta_string_func($sql_nom_ben, 'nom_clpv', $oIfx2, '');


                        $html .= '<tr>';
                        $html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid" >' . $cont_ben . '</td>';
                        $html .= '<td style=" width:70%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid" >' . $nom_clpv . '</td>';
                        $html .= '<td style="width:20%;font-size:12px; text-align: right;  border-bottom:1px solid" align="right">' . number_format($valor, 2, '.', ',') . '</td>';
                        $html .= '</tr>';

                        $cont_ben++;
                    } while ($oIfx->SiguienteRegistro());

                    $html .= '<tr>';
                    $html .= '<td align="right" style="width:80%;font-size:14px; text-align: right;" colspan="2"><strong>TOTAL</strong></td>';
                    $html .= '<td align="right" style="padding: 8px; width:8%;font-size:14px; text-align: right;">' . number_format($valor_total, 2, '.', ',') . '</td>';
                    $html .= '</tr>';
                    $html .= '</table>';
                }
            }
            $oIfx->Free();

        }
        // ------------------------------------------------------------------------------------------
        // FIN TABLA BENEFICIARIOS
        // ------------------------------------------------------------------------------------------







        $html.= '<table style="width:100%; margin-top: 100px" align="center" >
					
					<tr>
						<td style="width:10%"></td>
						<td style="width:10%; font-size:12px; text-align: center;border-top : 2px solid black;">Ingresado por:<br>'.$usuario.'</td>
						<td style="width:10%;"></td>
						<td style="width:10%;font-size:12px; text-align: center;border-top : 2px solid black;">Aprobado por</td>
						<td style="width:10%;"></td>	
						<td style="width:10%; font-size:12px; text-align: center;border-top : 2px solid black;">Revisado por:</td>
						<td style="width:10%;"></td>
						<td style="width:10%; font-size:12px; text-align: center;border-top : 2px solid black;">Recibí Conforme</td>
						<td style="width:10%;"></td>
					</tr>
					
					
			</table>';
    }
    return $html;

}


/*
////PDF DIARIOS, INGRESOS , EGRESOS - TODO A LA DERECHA SIN LOGOS--
function generar_diarios_ingresos_pdf( $idempresa="", $idsucursal="", $asto_cod="", $ejer_cod="", $prdo_cod=""){
	global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();


    $idEmpresa = $_SESSION['U_EMPRESA'];

	$class = new GeneraDetalleAsientoContable();

	$arrayAsto = $class->informacionAsientoContable($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $asto_cod);

	$arrayDiario = $class->diarioAsientoContable($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $asto_cod);

	$arrayDirectorio = $class->directorioAsientoContable($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $asto_cod);

	$arrayRetencion = $class->retencionAsientoContable($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $asto_cod);

	//var_dump($arrayRetencion);exit;
	foreach($arrayAsto as $val){
				$asto_cod_asto = $val[0];
				$asto_vat_asto = $val[1];
				$asto_ben_asto = $val[2];
				$asto_fec_asto = $val[3];
				$asto_det_asto = $val[4];
                $asto_cod_modu = $val[5];
				$asto_usu_asto = $val[6];
                $asto_user_web = $val[7];
                $asto_fec_serv = $val[8];
                $asto_cod_tidu = $val[9];
                $asto_cod_mone = $val[10];
	}

	$sql = "select empr_ruc_empr, empr_dir_empr, empr_nom_empr, empr_path_logo from saeempr where empr_cod_empr = $idempresa ";
	if($oIfx->Query($sql)){
		$empr_ruc = $oIfx->f('empr_ruc_empr');
		$empr_dir = $oIfx->f('empr_dir_empr');
		$empr_nom = $oIfx->f('empr_nom_empr');
		$empr_path_logo = $oIfx->f('empr_path_logo');
		$empr_nom.=' ';
	}
	$sql="SELECT sucu_nom_sucu FROM saesucu WHERE sucu_cod_sucu='$idsucursal'";
	if($oIfx->Query($sql)){
		$sucu_nom = $oIfx->f('sucu_nom_sucu');
	}

	$oIfx->Free();
	setlocale(LC_ALL,"es_ES@euro","es_ES","esp");

	$asto_fec = strftime("%d de %B de %Y", strtotime($asto_fec));

    // MONEDA
    $sql = "select mone_des_mone from saemone where mone_cod_empr = $idempresa and mone_cod_mone = $asto_cod_mone ";
    $moneda =  consulta_string_func($sql, 'mone_des_mone', $oIfx, 0);

    // TIDU
    $sql = "select tidu_des_tidu from saetidu where tidu_cod_tidu = '$asto_cod_tidu' ";
    $tidu_nom =  consulta_string_func($sql, 'tidu_des_tidu', $oIfx, 0);

    $html.='<table style="margin-left:50px; margin-right:50px; margin-top:30px">
				<tr >
					<td style="font-size:18px; text-align: left">'.$empr_nom.'<br><br></td>
				</tr>
				<tr>
					<td  style="font-size:14px; text-align: left">SUCURSAL:'.$sucu_nom.'<br><br></td>
				</tr>
				<tr>
					<td  style="font-size:14px; text-align: left">DIRECCION:'. $empr_dir.'<br><br></td>
				</tr>
				<tr>
					<td style="font-size:14px; text-align: left">RUC:'.$empr_ruc.'<br><br></td>
				</tr>
				<tr>
					<td style="font-size:14px; text-align: left">COMPROBANTE No: '.$tidu_nom.' :'. $asto_cod_asto.'<br><br></td>
				</tr>
			</table>
			<table border="0"    style="width: 100%; margin-left:50px; margin-top:5px;">
				<tr>
					<td   colspan="2" style="width: 100%;font-size:12px; text-align: left"><strong>Fecha:</strong> '.$asto_fec_asto.'</td>
				</tr>
				<tr>
					<td   style="width: 100%;font-size:12px; text-align: left"><strong>Moneda:</strong> '.$moneda.'</td>
				</tr>
				<tr>
					<td  style="width: 100%; font-size:12px; text-align: left"><strong>Monto: </strong>'.number_format($asto_vat_asto,2,'.',',').'</td>
				</tr>
				<tr>
					<td colspan="2" style="width: 100%; font-size:12px; text-align: left"><strong>Beneficiario: </strong> '. $asto_ben_asto.'</td>
				</tr>
				<tr>
					<td colspan="2" style="width: 100%; font-size:12px; text-align: left"><strong>Detalle:</strong> '.$asto_det_asto.'<br><br></td>
				</tr>
			</table>';

	//directorio
		if(count($arrayDirectorio) > 0){
			$html.='
                    <table  style="margin-left:50px; width:90%;border:1px solid black; border-radius: 5px; margin-top:10px" align="left">
                        <tr>
                        <td colspan="6" style="width:100%;font-size:16px; text-align: center; border-bottom:1px solid "><strong>DIRECTORIO</strong></td>
                        </tr>
                        <tr>
                            <td  style="width:3%; font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>N</strong></td>
                            <td  style="width:30%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>CIENTE / PROVEEDOR</strong></td>
                            <td  style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>TRANSACCION</strong></td>
                            <td  style="width:20%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>FACTURA</strong></td>
                            <td  style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>CREDITO</strong></td>
                            <td  style="width:10%;font-size:14px; text-align: center;  border-bottom:1px solid"><strong>DEBITO</strong></td>
                        </tr>';
			foreach($arrayDirectorio as $val){
				$dir_cod_dir    = $val[0];
				$dir_cod_cli    = $val[1];
				$tran_cod_modu  = $val[2];
				$dir_cod_tran   = $val[3];
				$dir_num_fact   = $val[4];
				$dir_detalle    = $val[5];
				$dir_fec_venc   = $val[6];
				$dir_deb_ml     = $val[7];
				$dir_cre_ml     = $val[8];
				//clpv
				$clpv_nom_clpv  = '';
				if(!empty($dir_cod_cli)){
					$sql = "select clpv_nom_clpv from saeclpv where clpv_cod_clpv = $dir_cod_cli";
					$clpv_nom_clpv = consulta_string_func($sql, 'clpv_nom_clpv', $oIfx, '');
				}

				$html.= '<tr>';
				$html.= '<td style="width:3%;font-size:12px; text-align: center; border-right:1px solid; border-bottom:1px solid ">'.$dir_cod_dir.'</td>';
				$html.= '<td style="width:30%;font-size:12px; text-align: center; border-right:1px solid; border-bottom:1px solid">'.$clpv_nom_clpv.'</td>';
				$html.= '<td style="width:10%;font-size:12px; text-align: center; border-right:1px solid; border-bottom:1px solid ">'.$dir_cod_tran.'</td>';
				$html.= '<td style="width:20%;font-size:12px; text-align: center; border-right:1px solid; border-bottom:1px solid ">'.$dir_num_fact.'</td>';
				$html.= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid" align="right">'.number_format($dir_cre_ml,2,'.',',').'</td>';
				$html.= '<td style="width:10%;font-size:12px; text-align: right;  border-bottom:1px solid" align="right">'.number_format($dir_deb_ml,2,'.',',').'</td>';
				$html.= '</tr>';
			}
			$html.='</table>';
		}

		//retencion
		if(count($arrayRetencion) > 0){

			$html.= '<table  style="margin-left:50px; width:90%;border:1px solid black; border-radius: 5px; margin-top:30px" align="left">';
			$html.= '<tr>';
			$html.= '<td colspan="7" style="width:100%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>RETENCION</strong></td>';
			$html.= '</tr>';
			$html.= '<tr>';
			$html.= '<td style="width:20%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid " ><strong>Cliente/Proveedor</strong></td>';
			$html.= '<td style="width:20%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>Factura</strong></td>';
			$html.= '<td style="width:20%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>Retencion</strong></td>';
			$html.= '<td style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>Codigo</strong></td>';
			$html.= '<td style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>Porcentaje</strong></td>';
			$html.= '<td style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>Base Imp.</strong></td>';
			$html.= '<td style="width:10%;font-size:14px; text-align: center; border-bottom:1px solid "><strong>Valor</strong></td>';
			$html.= '</tr>';
			foreach($arrayRetencion as $val){
				$ret_cta_ret = $val[0];
				$ret_porc_ret = $val[1];
				$ret_bas_imp = $val[2];
				$ret_valor = $val[3];
				$ret_num_ret = $val[4];
				$ret_detalle = $val[5];
				$ret_num_fact = $val[6];
				$ret_ser_ret = $val[7];
				$ret_cod_clpv = $val[8];
				$ret_fec_ret = $val[9];

				//clpv
				$clpv_nom_clpv = '';
				if(!empty($ret_cod_clpv)){
					$sql = "select clpv_nom_clpv from saeclpv where clpv_cod_clpv = $ret_cod_clpv";
					$clpv_nom_clpv = consulta_string_func($sql, 'clpv_nom_clpv', $oIfx, '');
				}

				//fprv
				$printRet = '';
				if($asto_cod_modu == 4 || $asto_cod_modu == 6){

					//fecha fprv o minv
					if($asto_cod_modu == 4){
						$sql = "select fprv_fec_emis
								from saefprv
								where fprv_cod_clpv = $ret_cod_clpv and
								fprv_num_fact = '$ret_num_fact' and
								fprv_cod_asto = '$asto_cod_asto' and
								fprv_cod_ejer = $ejer_cod and
								fprv_cod_empr = $idempresa and
								fprv_cod_sucu = $idsucursal";
						$fechaEmis = consulta_string_func($sql, 'fprv_fec_emis', $oIfx, '');
					}elseif($asto_cod_modu == 6){
						$sql = "select minv_fmov
								from saeminv
								where minv_cod_clpv = $ret_cod_clpv and
								minv_fac_prov = '$ret_num_fact' and
								minv_comp_cont = '$asto_cod_asto' and
								minv_cod_ejer = $ejer_cod and
								minv_cod_empr = $idempresa and
								minv_cod_sucu = $idsucursal";
						$fechaEmis = consulta_string_func($sql, 'minv_fmov', $oIfx, '');
					}

					$printRet = '<div class="btn btn-primary btn-sm" onclick="genera_documento(5, \''.$campo.'\',\''.$fprv_clav_sri.'\' ,
																				 \''.$ret_cod_clpv.'\'  , \''.$ret_num_fact.'\', \''.$ejer.'\',
																				 \''.$asto.'\',  \''.$fechaEmis.'\', '.$sucu.');">
									<span class="glyphicon glyphicon-print"></span>
								</div>';
				}

				$html.= '<tr>';
				$html.= '<td style="width:20%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid" >'.$clpv_nom_clpv.'</td>';
				$html.= '<td style=" width:20%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid" >'.$ret_num_fact.'</td>';
				$html.= '<td style="width:20%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid">'.$ret_ser_ret.' - '.$ret_num_ret.'</td>';
				$html.= '<td style="width:10%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid">'.$ret_cta_ret.'</td>';
				$html.= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid" align="right">'.$ret_porc_ret.'</td>';
				$html.= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid" align="right">'.number_format($ret_bas_imp,2,'.',',').'</td>';
				$html.= '<td style="width:10%;font-size:12px; text-align: right;  border-bottom:1px solid" align="right">'.number_format($ret_valor,2,'.',',').'</td>';
				$html.= '</tr>';

			}//fin foreach

			$html.= '</table>';



		}
		///diario
		if(count($arrayDiario) > 0){

			$html.= '<table  style="margin-left:50px; width:90%;border:1px solid black; border-radius: 5px; margin-top:30px" align="">';
			$html.= '<tr>';
			$html.= '<td colspan="6" style="width:100%;font-size:16px; text-align: center; border-bottom:1px solid "><strong>DIARIO</strong></td>';
			$html.= '</tr>';
			$html.= '<tr>';
			$html.= '<td style="width:25%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>Cuenta Contable</strong></td>';
			$html.= '<td style="width:15%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>Centro Costos</strong></td>';
			$html.= '<td style="width:15%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>Centro Actividad</strong></td>';
			$html.= '<td style="width:15%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>Documento</strong></td>';
			$html.= '<td style="width:8%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>Debito</strong></td>';
			$html.= '<td style="width:8%;font-size:14px; text-align: center;  border-bottom:1px solid "><strong>Credito</strong></td>';
			$html.= '</tr>';
			$totalDeb = 0;
			$totalCre = 0;
			foreach($arrayDiario as $val){
				$dasi_cod_cuen = $val[0];
				$dasi_cod_cact = $val[1];
				$ccos_cod_ccos = $val[2];
				$dasi_dml_dasi = $val[3];
				$dasi_cml_dasi = $val[4];
				$dasi_det_asi = $val[5];
				$dasi_num_depo = $val[6];

				//clpv
				$cuen_nom_cuen = '';
				if(!empty($dasi_cod_cuen)){
					$sql = "select cuen_nom_cuen from saecuen where cuen_cod_cuen = '$dasi_cod_cuen' and cuen_cod_empr = $idempresa";
					$cuen_nom_cuen = consulta_string_func($sql, 'cuen_nom_cuen', $oIfx, '');
				}

				$ccosn_nom_ccosn = '';
				if(!empty($ccos_cod_ccos)){
					$sql = "select ccosn_nom_ccosn from saeccosn where ccosn_cod_ccosn = '$ccos_cod_ccos' and ccosn_cod_empr = $idempresa";
					$ccosn_nom_ccosn = consulta_string_func($sql, 'ccosn_nom_ccosn', $oIfx, '');
				}

				$cact_nom_cact = '';
				if(!empty($dasi_cod_cact)){
					$sql = "select cact_nom_cact from saecact where cact_cod_cact = '$dasi_cod_cact' and cact_cod_empr = $idempresa";
					$cact_nom_cact = consulta_string_func($sql, 'cact_nom_cact', $oIfx, '');
				}

				$html.= '<tr>';
				$html.= '<td style="width:25%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">'.$dasi_cod_cuen.' - '.$cuen_nom_cuen.'</td>';
				$html.= '<td style="width:15%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">'.$ccos_cod_ccos.' - '.$ccosn_nom_ccosn.'</td>';
				$html.= '<td style="width:15%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">'.$dasi_cod_cact.' - '.$cact_nom_cact.'</td>';
				$html.= '<td style="width:15%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">'.$dasi_num_depo.'</td>';
				$html.= '<td style="width:8%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid ">'.number_format($dasi_dml_dasi,2,'.',',').'</td>';
				$html.= '<td style="width:8%;font-size:12px; text-align: right; border-bottom:1px solid ">'.number_format($dasi_cml_dasi,2,'.',',').'</td>';
				$html.= '</tr>';

				$totalDeb += $dasi_dml_dasi;
				$totalCre += $dasi_cml_dasi;
			}//fin foreach
			$usuario = $_SESSION['U_NOMBRECOMPLETO'];
			$html.= '<tr>';
			$html.= '<td align="right" style="width:60%;font-size:14px; text-align: right; border-right:1px solid; " colspan="4"><strong>TOTAL</strong></td>';
			$html.= '<td align="right" style="width:8%;font-size:12px; text-align: right; border-right:1px solid; ">'.number_format($totalDeb,2,'.',',').'</td>';
			$html.= '<td align="right" style="width:8%;font-size:12px; border-right:1px solid;">'.number_format($totalCre,2,'.',',').'</td>';
			$html.= '</tr>';
			$html.= '</table>';
			$html.= '<table style="width:100%; margin-top: 80px" align="center" >
					<tr>
						<td style="width:15%"></td>
						<td style="width:15%; font-size:12px; text-align: center;border-top : 2px solid black;">Ingresado por:<br>'.$usuario.'</td>
						<td style="width:30%"></td>
						<td style="width:15%;font-size:12px; text-align: center;border-top : 2px solid black;">Aprobado por</td>
						<td style="width:15%"></td>

					</tr>
					<tr><td><br><br><br><br><br><br></td></tr>
					<tr>
					<td width="15%"></td>
						<td width="15%" style="font-size:12px; text-align: center;border-top : 2px solid black;">Revisado por:</td>
						<td width="30%"></td>
						<td width="15%" style="font-size:12px; text-align: center;border-top : 2px solid black;">Recibí Conforme</td>

							<td width="15%"></td>
					</tr>
			</table>';


		}


	return $html;

}

*/

////PDF INVENTARIO
function generar_mov_inv_pdf($idempresa = "", $idsucursal = "", $minv_num_comp = "", $tran_cod = '', $ejer_cod = "", $prdo_cod = "")
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();

   

    $idEmpresa = $_SESSION['U_EMPRESA'];

    $class = new GeneraDetalleInventario();

    $arrayMinv = $class->generaSaeminv($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $tran_cod, $minv_num_comp);

    $arrayDmov = $class->generaSaedmov($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $minv_num_comp);

    //var_dump($arrayRetencion);exit;
    foreach ($arrayMinv as $val) {
        $minv_num_sec = $val[0];
        $minv_cod_clpv = $val[1];
        $minv_fmov = $val[2];
        $minv_fac_prov = $val[3];
        $minv_tot_minv = $val[4];
        $minv_iva_valo = $val[5];
        $minv_cm1_minv = $val[6];
        $minv_hor_minv = $val[7];
        $minv_cod_mone = $val[8];
    }

    $sqlmin="select minv_user_web as minv_cod_usua from saeminv where minv_num_comp=$minv_num_comp";
    $minv_cod_usua = consulta_string($sqlmin, 'minv_cod_usua', $oIfx, '');

    if(!empty($minv_cod_usua)){
        $sql_usuario = "SELECT (usuario_nombre || ' ' || usuario_apellido) AS nombres from comercial.usuario where usuario_id = " . $minv_cod_usua;
        $usuario_nombre = consulta_string($sql_usuario, 'nombres', $oIfx, '');
    
    }
    else{
        $usuario_nombre ='';
    }
    
    $sql = "select empr_ruc_empr, empr_dir_empr, empr_nom_empr, empr_path_logo from saeempr where empr_cod_empr = $idempresa ";
    if ($oIfx->Query($sql)) {
        $empr_ruc = $oIfx->f('empr_ruc_empr');
        $empr_dir = $oIfx->f('empr_dir_empr');
        $empr_nom = $oIfx->f('empr_nom_empr');
        $empr_path_logo = $oIfx->f('empr_path_logo');
        $empr_nom .= ' ';
    }
    $sql = "SELECT sucu_nom_sucu FROM saesucu WHERE sucu_cod_sucu='$idsucursal'";
    if ($oIfx->Query($sql)) {
        $sucu_nom = $oIfx->f('sucu_nom_sucu');
    }


    $sql = "select tran_des_tran from saetran where
					tran_cod_empr = $idempresa and
					tran_cod_sucu = $idsucursal and
					tran_cod_tran = '$tran_cod' ";
    if ($oIfx->Query($sql)) {
        $tran_nom_tran = $oIfx->f('tran_des_tran');
    }

    $oIfx->Free();
    setlocale(LC_ALL, "es_ES@euro", "es_ES", "esp");

    $asto_fec = strftime("%d de %B de %Y", strtotime($asto_fec));


    // Nombre Proveedor
    if(empty($minv_cod_clpv))
    {
        $proveedorcliente ='';
    }    
    else
    {
        $sql = "SELECT clpv_nom_clpv
        from saeclpv where clpv_cod_clpv= $minv_cod_clpv 
        and clpv_cod_empr= $idempresa 
        and clpv_cod_sucu = $idsucursal";
        $proveedorcliente = consulta_string_func($sql, 'clpv_nom_clpv', $oIfx, '');
    }

    // MONEDA
    $sql = "select mone_des_mone from saemone where mone_cod_empr = $idempresa and mone_cod_mone = $minv_cod_mone ";
    $moneda = consulta_string_func($sql, 'mone_des_mone', $oIfx, 0);
    $minv_fmov = str_replace('/', '', $minv_fmov);
    // Nombre Proveedor
    //$oIfx->Free();
    //$sql = "select clpv_nom_clpv from saeclpv where clpv_cod_clpv= $minv_cod_clpv and clpv_cod_empr= $idempresa and clpv_cod_sucu = $idsucursal "; 
    //$prov = consulta_string($sql, 'clpv_nom_clpv', $oIfx, '');
    //$proveedorcliente = consulta_string_func($sql, 'clpv_nom_clpv', $oIfx, 0);
    //$usuario_nombre = consulta_string($sql_usuario, 'nombres', $oIfx, '');

    

    $html .= '<table style="margin-left:50px; margin-right:0px; margin-top:10px">
				<tr >
					<td style="font-size:18px; text-align: left">' . $empr_nom . '<br></td>

				</tr>
				<tr>
					<td  style="font-size:14px; text-align: left">SUCURSAL:' . $sucu_nom . '<br></td>
				</tr>
				<tr>
					<td  style="font-size:14px; text-align: left">DIRECCION:' . $empr_dir . '<br><br></td>
				</tr>
				<!-- <tr>
					<td style="font-size:18px; text-align: right">N.- MOVIMIENTO  ' . $tran_nom_tran . ' No:<strong>' . $minv_num_sec . '</strong><br><br><br></td>
				</tr> -->
			</table>

            <table  style="margin-left:40px; width:90%;border:0px solid black; margin-top:10px" align="center">
                <tr>
                    <td  style="font-size:20px; text-align: center; border-bottom:0px solid ">N.- MOVIMIENTO ' . $tran_nom_tran . ' No: <strong>' . $minv_num_sec . '</strong><br><br></td>
                </tr>            
			</table>
			<table border="0" style="width: 90%; margin-left:50px; margin-top:10px;">
				<tr>
					<td  style="width: 50%;font-size:18px; text-align: left">PROVEEDOR: <strong>' . $proveedorcliente . '</strong></td> 
					<td  style="width: 50%;font-size:16px; text-align: right">Fecha: <strong>' . $minv_fmov . '</strong></td>
				</tr>
			</table>

            <table border="0" style="width: 90%; margin-left:50px; margin-top:10px;">
				<tr>
                    <td style="width: 70%; font-size:16px; text-align: left">Detalle: ' . $minv_cm1_minv . '</td>
					<td  style="width: 30%; font-size:16px; text-align: right">Monto: <strong>' . number_format(($minv_tot_minv + $minv_iva_valo), 2, '.', ',') . '</strong></td>
				</tr>			
			</table>';

    //SAEDMOV
    if (count($arrayDmov) > 0) {
        $html .= '
								<table  style="margin-left:40px; width:90%;border:1px solid black; border-radius: 5px; margin-top:10px" align="left">
									<tr>
									<td colspan="8" style="width:100%;font-size:16px; text-align: center; border-bottom:1px solid ">DETALLE</td>
									</tr>
									<tr>
										<td  style="width:3%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid ">N</td>
										<td  style="width:15%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid">BODEGA</td>
										<td  style="width:18%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid">CODIGO</td>
										<!-- <td  style="width:8%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid">CODIGO BARRAS</td> -->
										<td  style="width:27%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid">PRODUCTO</td>
										<!-- <td  style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid">LOTE/SERIE</td> -->
										<td  style="width:8%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid">UNIDAD MEDIDA</td>
										<td  style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid">CANT.</td>
										<td  style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid">C.UNITARIO</td>
										<td  style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid">TOTAL</td>
									</tr>';

        $i = 1;
        $cantidad_total_ad = 0;
        $costo_total_ad = 0;
        foreach ($arrayDmov as $val) {
            $dmov_cod_prod = $val[0];
            $dmov_cod_bode = $val[1];
            $dmov_bod_envi = $val[2];
            $dmov_cod_ccos = $val[3];
            $dmov_cod_cuen = $val[4];
            $dmov_can_dmov = $val[5];
            $dmov_cun_dmov = $val[6];
            $dmov_cto_dmov = $val[7];
            $dmov_cad_lote = $val[8];
            $dmov_ela_lote = $val[9];
            $dmov_cod_lote = $val[10];
            $dmov_prec_vent = $val[11];

            if(empty($dmov_prec_vent)){
                $dmov_prec_vent = 0;
            }

            if ($dmov_cun_dmov < 0.01) {
                $dmov_cun_dmov = $dmov_prec_vent;
            }

            // $sql = "select prod_nom_prod from saeprod where prod_cod_empr = $idempresa and prod_cod_sucu = $idsucursal and prod_cod_prod = '$dmov_cod_prod' ";
            // $prod_nom = consulta_string_func($sql, 'prod_nom_prod', $oIfx, '');


            $sql = "SELECT prod_nom_prod, prbo_uco_prod, prbo_cod_unid, unid_nom_unid
                            from saeprod, saeprbo, saeunid 
                            where 
                            prbo_cod_prod = prod_cod_prod and 
                            prbo_cod_unid = unid_cod_unid and 
                            prod_cod_prod = '$dmov_cod_prod' and
                            prbo_cod_bode = $dmov_cod_bode
                            ";
            $prod_nom = consulta_string_func($sql, 'prod_nom_prod', $oIfx, '');
            $prod_unid = consulta_string_func($sql, 'unid_nom_unid', $oIfx, '');


            $sql = "select bode_nom_bode from saebode where bode_cod_empr = $idempresa and bode_cod_bode = '$dmov_cod_bode' ";
            $bode_nom = consulta_string_func($sql, 'bode_nom_bode', $oIfx, '');

            $sql = "select prod_cod_barra from saeprod where prod_cod_empr = $idempresa and prod_cod_sucu = $idsucursal and prod_cod_prod = '$dmov_cod_prod' ";
            $prod_cod_barra = consulta_string_func($sql, 'prod_cod_barra', $oIfx, '');

            $sql = "select prbo_dis_prod from saeprbo where prbo_cod_empr = $idempresa and prbo_cod_sucu = $idsucursal and prbo_cod_prod = '$dmov_cod_prod' ";
            $prbo_dis_prod = consulta_string_func($sql, 'prbo_dis_prod', $oIfx, '0');

            

            $html .= '<tr>';
            $html .= '<td style="width:3%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid ">' . $i . '</td>';
            $html .= '<td style="width:15%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid">' . $bode_nom . '</td>';
            $html .= '<td style="width:18%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $dmov_cod_prod . '</td>';
            //$html .= '<td style="width:8%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $prod_cod_barra . '</td>';
            $html .= '<td style="width:27%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $prod_nom . '</td>';
            //$html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $dmov_cod_lote . '</td>';
            $html .= '<td style="width:8%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $prod_unid . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid" align="right">' . round($dmov_can_dmov, 2) . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid">' . number_format($dmov_cun_dmov, 2) . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid">' . number_format($dmov_cto_dmov, 2) . '</td>';
            //$html.= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid"></td>';
            $html .= '</tr>';

            $cantidad_total_ad += $dmov_can_dmov;
            $costo_total_ad += $dmov_cto_dmov;

            $i++;
        }


        $html .= '<tr>';
        $html .= '<td style="width:3%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid" colspan="5">TOTALES</td>';
        $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid" align="right">' . round($cantidad_total_ad, 2) . '</td>';
        $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid"></td>';
        $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid">' . number_format($costo_total_ad, 2) . '</td>';
        $html .= '</tr>';


        $html .= '</table>';
        $html .= '<br><br><br><br><br><br>';
        $html .= '<table  style="margin-left:15px; width:90%;border:0px solid black; border-radius: 5px; margin-top:10px" align="center">';
        $html .= '<tr>
						<td style="font-size:16px; text-align: center;border-top : 1px; width:24%;">Elaborado por:<br> '.$usuario_nombre.'</td>	
                        <!-- <td style="font-size:16px; text-align: center; width:30%;"><br><br><br><br><br><br></td> -->
						<td style="font-size:16px; text-align: center;border-top : 1px; width:24%;">Despachado por:</td>
					    <td style="font-size:16px; text-align: center;border-top : 1px; width:24%;">Autorizado por:</td>		
                        <td style="font-size:16px; text-align: center;border-top : 1px; width:24%;">Recibido por:</td>
					</tr>
                    <tr>
                    <!-- <td style="font-size:16px; text-align: center;border-top : 2px solid black; width:35%;">Autorizado por:</td>
                    <td style="font-size:16px; text-align: center; width:30%;"></td> 
                        <td style="font-size:16px; text-align: center;border-top : 2px solid black; width:35%;">Recibido por:</td> -->
                    </tr>
                    </table>';
    }

    return $html;

}


function generar_mov_inv_serie_pdf($idempresa = "", $idsucursal = "", $minv_num_comp = "", $tran_cod = '', $ejer_cod = "", $prdo_cod = "")
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();


    $idEmpresa = $_SESSION['U_EMPRESA'];

    $class = new GeneraDetalleInventario();

    $arrayMinv = $class->generaSaeminv($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $tran_cod, $minv_num_comp);

    $arrayDmov = $class->generaSaedmov($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $minv_num_comp);

    //var_dump($arrayRetencion);exit;
    foreach ($arrayMinv as $val) {
        $minv_num_sec = $val[0];
        $minv_cod_clpv = $val[1];
        $minv_fmov = $val[2];
        $minv_fac_prov = $val[3];
        $minv_tot_minv = $val[4];
        $minv_iva_valo = $val[5];
        $minv_cm1_minv = $val[6];
        $minv_hor_minv = $val[7];
        $minv_cod_mone = $val[8];
    }

    $sql = "select empr_ruc_empr, empr_dir_empr, empr_nom_empr, empr_path_logo from saeempr where empr_cod_empr = $idempresa ";
    if ($oIfx->Query($sql)) {
        $empr_ruc = $oIfx->f('empr_ruc_empr');
        $empr_dir = $oIfx->f('empr_dir_empr');
        $empr_nom = $oIfx->f('empr_nom_empr');
        $empr_path_logo = $oIfx->f('empr_path_logo');
        $empr_nom .= ' ';
    }
    $sql = "SELECT sucu_nom_sucu FROM saesucu WHERE sucu_cod_sucu='$idsucursal'";
    if ($oIfx->Query($sql)) {
        $sucu_nom = $oIfx->f('sucu_nom_sucu');
    }


    $sql = "select tran_des_tran from saetran where
					tran_cod_empr = $idempresa and
					tran_cod_sucu = $idsucursal and
					tran_cod_tran = '$tran_cod' ";
    if ($oIfx->Query($sql)) {
        $tran_nom_tran = $oIfx->f('tran_des_tran');
    }

    $oIfx->Free();
    setlocale(LC_ALL, "es_ES@euro", "es_ES", "esp");

    $asto_fec = strftime("%d de %B de %Y", strtotime($asto_fec));

    // MONEDA
    $sql = "select mone_des_mone from saemone where mone_cod_empr = $idempresa and mone_cod_mone = $minv_cod_mone ";
    $moneda = consulta_string_func($sql, 'mone_des_mone', $oIfx, 0);

    $html .= '<table style="margin-left:50px; margin-right:50px; margin-top:30px">
				<tr >
					<td style="font-size:18px; text-align: left">' . $empr_nom . '<br><br></td>
				</tr>
				<tr>
					<td  style="font-size:14px; text-align: left">SUCURSAL:' . $sucu_nom . '<br><br></td>
				</tr>
				<tr>
					<td  style="font-size:14px; text-align: left">DIRECCION:' . $empr_dir . '<br><br></td>
				</tr>
                
				<!-- <tr>
					<td style="font-size:14px; text-align: left">RUC:' . $empr_ruc . '<br><br></td>
				</tr> -->
				<tr>
					<td style="font-size:14px; text-align: center">N.- MOVIMIENTO  ' . $tran_nom_tran . ' No:' . $minv_num_sec . '<br><br></td>
				</tr>
			
			</table>
			<table border="0"    style="width: 100%; margin-left:50px; margin-top:10px;">
				<tr>
					<td   colspan="2" style="width: 100%;font-size:12px; text-align: left"><strong>Fecha:</strong> ' . $minv_fmov . '</td>
					
				</tr>
				<tr>
					<td   style="width: 100%;font-size:12px; text-align: left"><strong>Moneda:</strong> ' . $moneda . '</td>
					
					
				</tr>
				<tr>
					<td  style="width: 100%; font-size:12px; text-align: left"><strong>Monto: </strong>' . number_format(($minv_tot_minv + $minv_iva_valo), 2, '.', ',') . '</td>
				</tr>			
				<tr>
					<td colspan="2" style="width: 100%; font-size:12px; text-align: left"><strong>Detalle:</strong> ' . $minv_cm1_minv . '<br><br></td>
				</tr>				
			</table>';

    //SAEDMOV
    if (count($arrayDmov) > 0) {
        $html .= '
								<table  style="margin-left:50px; width:95%;border:1px solid black; border-radius: 5px; margin-top:10px" align="left">
									<tr>
									<td colspan="9" style="width:100%;font-size:16px; text-align: center; border-bottom:1px solid "><strong>DETALLE</strong></td>
									</tr>
									<tr>
										<td  style="width:3%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>N</strong></td>
										<td  style="width:15%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>BODEGA</strong></td>
										<td  style="width:20%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>CODIGO</strong></td>
										<!-- <td  style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>CODIGO BARRAS</strong></td> -->
										<td  style="width:25%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>PRODUCTO</strong></td>
										<td  style="width:5%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>CANT.</strong></td>
										<td  style="width:15%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>SERIE CAJA</strong></td>
										<td  style="width:15%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>SERIE TARJETA</strong></td>
									</tr>';

        $i = 1;
        foreach ($arrayDmov as $val) {
            $dmov_cod_prod = $val[0];
            $dmov_cod_bode = $val[1];
            $dmov_bod_envi = $val[2];
            $dmov_cod_ccos = $val[3];
            $dmov_cod_cuen = $val[4];
            $dmov_can_dmov = $val[5];
            $dmov_cun_dmov = $val[6];
            $dmov_cto_dmov = $val[7];
            $dmov_cad_lote = $val[8];
            $dmov_ela_lote = $val[9];
            $dmov_cod_lote = $val[10];
            $dmov_serie_caja = $val[11];
            $dmov_serie_tarj = $val[12];

            $sql = "select prod_nom_prod from saeprod where prod_cod_empr = $idempresa and prod_cod_sucu = $idsucursal and prod_cod_prod = '$dmov_cod_prod' ";
            $prod_nom = consulta_string_func($sql, 'prod_nom_prod', $oIfx, '');

            $sql = "select bode_nom_bode from saebode where bode_cod_empr = $idempresa and bode_cod_bode = '$dmov_cod_bode' ";
            $bode_nom = consulta_string_func($sql, 'bode_nom_bode', $oIfx, '');

            $sql = "select prod_cod_barra from saeprod where prod_cod_empr = $idempresa and prod_cod_sucu = $idsucursal and prod_cod_prod = '$dmov_cod_prod' ";
            $prod_cod_barra = consulta_string_func($sql, 'prod_cod_barra', $oIfx, '');

            $sql = "select prbo_dis_prod from saeprbo where prbo_cod_empr = $idempresa and prbo_cod_sucu = $idsucursal and prbo_cod_prod = '$dmov_cod_prod' ";
            $prbo_dis_prod = consulta_string_func($sql, 'prbo_dis_prod', $oIfx, '0');

            $html .= '<tr>';
            $html .= '<td style="width:3%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid ">' . $i . '</td>';
            $html .= '<td style="width:15%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid">' . $bode_nom . '</td>';
            $html .= '<td style="width:20%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $dmov_cod_prod . '</td>';
            //$html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $prod_cod_barra . '</td>';
            $html .= '<td style="width:25%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $prod_nom . '</td>';
            $html .= '<td style="width:5%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid" align="right">' . $dmov_can_dmov . '</td>';
            $html .= '<td style="width:15%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid">' . $dmov_cun_dmov . '</td>';
            $html .= '<td style="width:15%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid">' . $dmov_cto_dmov . '</td>';
            $html .= '</tr>';

            $i++;
        }

        $html .= '</table>';
        $html .= '<br><br><br><br><br><br>';
        $html .= '<table  style="margin-left:15px; width:60%;border:0px solid black; border-radius: 5px; margin-top:10px" align="center">';
        $html .= '<tr>
						<td style="font-size:12px; text-align: center;border-top : 2px solid black; width:50%;">Despachado por:</td>
						<td style="font-size:12px; text-align: center;border-top : 2px solid black; width:50%;">Autorizado por:</td>	
					</tr>
					</table>';
    }

    return $html;

}

function generar_mov_inv_tran_pdf($idempresa = "", $idsucursal = "", $minv_num_comp = "", $tran_cod = '', $ejer_cod = "", $prdo_cod = "")
{
    global $DSN_Ifx, $DSN;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();


    $idEmpresa = $_SESSION['U_EMPRESA'];

    $class = new GeneraDetalleInventario();

    $arrayMinv = $class->generaSaeminv($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $tran_cod, $minv_num_comp);

    $arrayDmov = $class->generaSaedmov($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $minv_num_comp);

    //var_dump($arrayRetencion);exit;
    foreach ($arrayMinv as $val) {
        $minv_num_sec = $val[0];
        $minv_cod_clpv = $val[1];
        $minv_fmov = str_replace('/','',$val[2]);
        $minv_fac_prov = $val[3];
        $minv_tot_minv = $val[4];
        $minv_iva_valo = $val[5];
        $minv_cm1_minv = $val[6];
        $minv_hor_minv = $val[7];
        $minv_cod_mone = $val[8];
    }

    $sql = "select empr_ruc_empr, empr_dir_empr, empr_nom_empr, empr_path_logo from saeempr where empr_cod_empr = $idempresa ";
    if ($oIfx->Query($sql)) {
        $empr_ruc = $oIfx->f('empr_ruc_empr');
        $empr_dir = $oIfx->f('empr_dir_empr');
        $empr_nom = $oIfx->f('empr_nom_empr');
        $empr_path_logo = $oIfx->f('empr_path_logo');
        $empr_nom .= ' ';
    }
    $sql = "SELECT sucu_nom_sucu FROM saesucu WHERE sucu_cod_sucu='$idsucursal'";
    if ($oIfx->Query($sql)) {
        $sucu_nom = $oIfx->f('sucu_nom_sucu');
    }


    $sql = "select tran_des_tran from saetran where
					tran_cod_empr = $idempresa and
					tran_cod_sucu = $idsucursal and
					tran_cod_tran = '$tran_cod' ";
    if ($oIfx->Query($sql)) {
        $tran_nom_tran = $oIfx->f('tran_des_tran');
    }

    $oIfx->Free();
    setlocale(LC_ALL, "es_ES@euro", "es_ES", "esp");

    $asto_fec = strftime("%d de %B de %Y", strtotime($asto_fec));

    // MONEDA
    $sql = "select mone_des_mone from saemone where mone_cod_empr = $idempresa and mone_cod_mone = $minv_cod_mone ";
    $moneda = consulta_string_func($sql, 'mone_des_mone', $oIfx, 0);

    $html .= '<table align="center" cellspacing="1" cellpadding="1">
				<tr >
					<td align="center" width="100%" style="font-size:90%;">' . $empr_nom . '</td>
				</tr>
				<tr>
					<td  align="center" width="100%" style="font-size:90%;"><strong>SUCURSAL:</strong>' . $sucu_nom . '</td>
				</tr>
				<tr>
					<td  align="center" width="100%" style="font-size:90%;"><strong>DIRECCION:</strong>' . $empr_dir . '</td>
				</tr>
				<tr>
					<td align="center" width="100%" style="font-size:90%;"><strong>RUC:</strong>' . $empr_ruc . '</td>
				</tr>
				<tr>
					<td align="center" width="100%" style="font-size:90%;"><strong>N.- MOVIMIENTO</strong> ' . $tran_nom_tran . ' No:' . $minv_num_sec . '</td>
				</tr>
						
				
			</table>
			<br><br><table cellspacing="1" cellpadding="1">
				<tr>
					<td   align="left" width="100%" style="font-size:90%;"><strong>Fecha:</strong> ' . $minv_fmov . '</td>
					
				</tr>
				<tr>
					<td   align="left" width="100%" style="font-size:90%;"><strong>Moneda:</strong> ' . $moneda . '</td>
					
					
				</tr>
				<tr>
					<td  align="left" width="100%" style="font-size:90%;"><strong>Monto: </strong>' . number_format(($minv_tot_minv + $minv_iva_valo), 2, '.', ',') . '</td>
				</tr>			
				<tr>
					<td align="left" width="100%" style="font-size:90%;"><strong>Detalle:</strong> ' . ($minv_cm1_minv) . '<br><br></td>
				</tr>				
			</table>';

    //SAEDMOV
    if (count($arrayDmov) > 0) {
        $html .= '
								<table align="center" style="font-size:100%;"  border="1" cellpadding="1" cellspacing="1">
									<tr>
									<td align="center"  colspan="8" ><strong>DETALLE</strong></td>
									</tr>
									<tr>
										<td  align="center" style="font-size:75%; width: 5%"><strong>_N_</strong></td>
                                        <td  align="center" style="font-size:75%; width: 12%"><strong>_______BODEGA ORIG._______</strong></td>
                                        <td  align="center" style="font-size:75%; width: 12%"><strong>_______BODEGA DEST._______</strong></td>
										<td  align="center" style="font-size:75%; width: 10%"><strong>_______CODIGO_______</strong></td>
										<td  align="center" style="font-size:75%; width: 15%"><strong>_______CODIGO BARRAS_______</strong></td>
										<td  align="center" style="font-size:75%; width: 10%"><strong>_______SERIE_______</strong></td>
										<td  align="center" style="font-size:75%; width: 24%"><strong>_______PRODUCTO_______</strong></td>
										<td  align="center" style="font-size:75%; width: 12%"><strong>_______CANT._______</strong></td>
									</tr>';

        $i = 1;
        foreach ($arrayDmov as $val) {
            $dmov_cod_prod = $val[0];
            $dmov_cod_bode = $val[1];
            $dmov_bod_envi = $val[2];
            $dmov_cod_ccos = $val[3];
            $dmov_cod_cuen = $val[4];
            $dmov_can_dmov = $val[5];
            $dmov_cun_dmov = $val[6];
            $dmov_cto_dmov = $val[7];
            $dmov_cad_lote = $val[8];
            $dmov_ela_lote = $val[9];
            $dmov_cod_lote = $val[10];

            $sql = "select prod_nom_prod from saeprod where prod_cod_empr = $idempresa and prod_cod_sucu = $idsucursal and prod_cod_prod = '$dmov_cod_prod' ";
            $prod_nom = consulta_string_func($sql, 'prod_nom_prod', $oIfx, '');

            $sql = "select bode_nom_bode from saebode where bode_cod_empr = $idempresa and bode_cod_bode = '$dmov_cod_bode' ";
            $bode_nom = consulta_string_func($sql, 'bode_nom_bode', $oIfx, '');

            $sql = "select prod_cod_barra from saeprod where prod_cod_empr = $idempresa and prod_cod_sucu = $idsucursal and prod_cod_prod = '$dmov_cod_prod' ";
            $prod_cod_barra = consulta_string_func($sql, 'prod_cod_barra', $oIfx, '');

            $sql = "select prbo_dis_prod from saeprbo where prbo_cod_empr = $idempresa and prbo_cod_sucu = $idsucursal and prbo_cod_prod = '$dmov_cod_prod' ";
            $prbo_dis_prod = consulta_string_func($sql, 'prbo_dis_prod', $oIfx, '0');


            $sql = "select bode_nom_bode from saebode where bode_cod_empr = $idempresa and bode_cod_bode = '$dmov_bod_envi' ";
            $bode_dest = consulta_string_func($sql, 'bode_nom_bode', $oIfx, '');

            $html .= '<tr>
            <td align="center" style="font-size:75%;">' . $i . '</td>
            <td align="center" style="font-size:75%;">' . $bode_nom . '</td>
            <td align="center" style="font-size:75%;">' . $bode_dest . '</td>
            <td align="center" style="font-size:75%;">' . $dmov_cod_prod . '</td>
            <td align="center" style="font-size:75%;">' . $prod_cod_barra . '</td>
            <td align="center" style="font-size:75%;">' . $dmov_cod_lote . '</td>
            <td align="left"   style="font-size:75%;">' . ($prod_nom) . '</td>
            <td align="center" style="font-size:75%;">' . $dmov_can_dmov . '</td>
            </tr>';

            $i++;
        }

        $html .= '</table>';
        $html .= '<br><br><br>';
        $html .= '<table  align="center" cellpadding="1" cellspacing="1">';
        $html .= '<tr>';
        $html .= '<td align="center">_____________________</td>';
        $html .= '<td align="center" >______________________</td>';
        $html .= '</tr>';
        $html .= '<tr>
						<td align="center" width="50%" style="font-size:75%;">Despachado por:</td>
						<td align="center" width="50%" style="font-size:75%;">Autorizado por:</td>	
					</tr>
					</table>';
    }

    return $html;

}

function generar_mov_inv_tran_pdf_old($idempresa = "", $idsucursal = "", $minv_num_comp = "", $tran_cod = '', $ejer_cod = "", $prdo_cod = "")
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();


    $idEmpresa = $_SESSION['U_EMPRESA'];

    $class = new GeneraDetalleInventario();

    $arrayMinv = $class->generaSaeminv($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $tran_cod, $minv_num_comp);

    $arrayDmov = $class->generaSaedmov($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $minv_num_comp);

    //var_dump($arrayRetencion);exit;
    foreach ($arrayMinv as $val) {
        $minv_num_sec = $val[0];
        $minv_cod_clpv = $val[1];
        $minv_fmov = $val[2];
        $minv_fac_prov = $val[3];
        $minv_tot_minv = $val[4];
        $minv_iva_valo = $val[5];
        $minv_cm1_minv = $val[6];
        $minv_hor_minv = $val[7];
        $minv_cod_mone = $val[8];
    }

    $sql = "select empr_ruc_empr, empr_dir_empr, empr_nom_empr, empr_path_logo from saeempr where empr_cod_empr = $idempresa ";
    if ($oIfx->Query($sql)) {
        $empr_ruc = $oIfx->f('empr_ruc_empr');
        $empr_dir = $oIfx->f('empr_dir_empr');
        $empr_nom = $oIfx->f('empr_nom_empr');
        $empr_path_logo = $oIfx->f('empr_path_logo');
        $empr_nom .= ' ';
    }
    $sql = "SELECT sucu_nom_sucu FROM saesucu WHERE sucu_cod_sucu='$idsucursal'";
    if ($oIfx->Query($sql)) {
        $sucu_nom = $oIfx->f('sucu_nom_sucu');
    }


    $sql = "select tran_des_tran from saetran where
					tran_cod_empr = $idempresa and
					tran_cod_sucu = $idsucursal and
					tran_cod_tran = '$tran_cod' ";
    if ($oIfx->Query($sql)) {
        $tran_nom_tran = $oIfx->f('tran_des_tran');
    }

    $oIfx->Free();
    setlocale(LC_ALL, "es_ES@euro", "es_ES", "esp");

    $asto_fec = strftime("%d de %B de %Y", strtotime($asto_fec));

    // MONEDA
    $sql = "select mone_des_mone from saemone where mone_cod_empr = $idempresa and mone_cod_mone = $minv_cod_mone ";
    $moneda = consulta_string_func($sql, 'mone_des_mone', $oIfx, 0);

    $html .= '<table style="margin-left:50px; margin-right:50px; margin-top:30px">
				<tr >
					<td style="font-size:18px; text-align: left">' . $empr_nom . '<br><br></td>
				</tr>
				<tr>
					<td  style="font-size:14px; text-align: left">SUCURSAL:' . $sucu_nom . '<br><br></td>
				</tr>
				<tr>
					<td  style="font-size:14px; text-align: left">DIRECCION:' . $empr_dir . '<br><br></td>
				</tr>
				<tr>
					<td style="font-size:14px; text-align: left">RUC:' . $empr_ruc . '<br><br></td>
				</tr>
				<tr>
					<td style="font-size:14px; text-align: left">N.- MOVIMIENTO  ' . $tran_nom_tran . ' No:' . $minv_num_sec . '<br><br></td>
				</tr>
						
				
			</table>
			<table border="0"    style="width: 100%; margin-left:50px; margin-top:10px;">
				<tr>
					<td   colspan="2" style="width: 100%;font-size:12px; text-align: left"><strong>Fecha:</strong> ' . $minv_fmov . '</td>
					
				</tr>
				<tr>
					<td   style="width: 100%;font-size:12px; text-align: left"><strong>Moneda:</strong> ' . $moneda . '</td>
					
					
				</tr>
				<tr>
					<td  style="width: 100%; font-size:12px; text-align: left"><strong>Monto: </strong>' . number_format(($minv_tot_minv + $minv_iva_valo), 2, '.', ',') . '</td>
				</tr>			
				<tr>
					<td colspan="2" style="width: 100%; font-size:12px; text-align: left"><strong>Detalle:</strong> ' . $minv_cm1_minv . '<br><br></td>
				</tr>				
			</table>';

    //SAEDMOV
    if (count($arrayDmov) > 0) {
        $html .= '
								<table  style="margin-left:50px; width:90%;border:1px solid black; border-radius: 5px; margin-top:10px" align="left">
									<tr>
									<td colspan="9" style="width:100%;font-size:16px; text-align: center; border-bottom:1px solid "><strong>DETALLE</strong></td>
									</tr>
									<tr>
										<td  style="width:3%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>N</strong></td>
                                        <td  style="width:15%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>BODEGA ORIG.</strong></td>
                                        <td  style="width:15%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>BODEGA DEST.</strong></td>
										<td  style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>CODIGO</strong></td>
										<td  style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>CODIGO BARRAS</strong></td>
										<td  style="width:25%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>PRODUCTO</strong></td>
										<td  style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>CANT.</strong></td>
										<td  style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong></strong></td>
									</tr>';

        $i = 1;
        foreach ($arrayDmov as $val) {
            $dmov_cod_prod = $val[0];
            $dmov_cod_bode = $val[1];
            $dmov_bod_envi = $val[2];
            $dmov_cod_ccos = $val[3];
            $dmov_cod_cuen = $val[4];
            $dmov_can_dmov = $val[5];
            $dmov_cun_dmov = $val[6];
            $dmov_cto_dmov = $val[7];
            $dmov_cad_lote = $val[8];
            $dmov_ela_lote = $val[9];
            $dmov_cod_lote = $val[10];

            $sql = "select prod_nom_prod from saeprod where prod_cod_empr = $idempresa and prod_cod_sucu = $idsucursal and prod_cod_prod = '$dmov_cod_prod' ";
            $prod_nom = consulta_string_func($sql, 'prod_nom_prod', $oIfx, '');

            $sql = "select bode_nom_bode from saebode where bode_cod_empr = $idempresa and bode_cod_bode = '$dmov_cod_bode' ";
            $bode_nom = consulta_string_func($sql, 'bode_nom_bode', $oIfx, '');

            $sql = "select prod_cod_barra from saeprod where prod_cod_empr = $idempresa and prod_cod_sucu = $idsucursal and prod_cod_prod = '$dmov_cod_prod' ";
            $prod_cod_barra = consulta_string_func($sql, 'prod_cod_barra', $oIfx, '');

            $sql = "select prbo_dis_prod from saeprbo where prbo_cod_empr = $idempresa and prbo_cod_sucu = $idsucursal and prbo_cod_prod = '$dmov_cod_prod' ";
            $prbo_dis_prod = consulta_string_func($sql, 'prbo_dis_prod', $oIfx, '0');


            $sql = "select bode_nom_bode from saebode where bode_cod_empr = $idempresa and bode_cod_bode = '$dmov_bod_envi' ";
            $bode_dest = consulta_string_func($sql, 'bode_nom_bode', $oIfx, '');

            $html .= '<tr>';
            $html .= '<td style="width:3%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid ">' . $i . '</td>';
            $html .= '<td style="width:15%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid">' . $bode_nom . '</td>';
            $html .= '<td style="width:15%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid">' . $bode_dest . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $dmov_cod_prod . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $prod_cod_barra . '</td>';
            $html .= '<td style="width:25%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $prod_nom . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid" align="right">' . $dmov_can_dmov . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid"></td>';
            $html .= '</tr>';

            $i++;
        }

        $html .= '</table>';
        $html .= '<br><br><br><br><br><br>';
        $html .= '<table  style="margin-left:15px; width:60%;border:0px solid black; border-radius: 5px; margin-top:10px" align="center">';
        $html .= '<tr>
						<td style="font-size:12px; text-align: center;border-top : 2px solid black; width:50%;">Despachado por:</td>
						<td style="font-size:12px; text-align: center;border-top : 2px solid black; width:50%;">Autorizado por:</td>	
					</tr>
					</table>';
    }

    return $html;

}

function lista_boostrap_func($oIfx, $sql, $campo_defecto, $campo_id, $campo_nom)
{
    $optionEmpr = '';
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
          

            do {
                $empr_cod_empr = $oIfx->f($campo_id);
                $empr_nom_empr = $oIfx->f($campo_nom);

                $selectedEmpr = '';

                if ($empr_cod_empr == $campo_defecto) {
                    $selectedEmpr = 'selected';
                }
                $optionEmpr .= '<option value="' . $empr_cod_empr . '" ' . $selectedEmpr . '>' . $empr_nom_empr . '</option>';
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    return $optionEmpr;
}

function lista_boostrap_func_selec_op($oIfx, $sql, $campo_defecto, $campo_id, $campo_nom)
{
    $optionEmpr = '';
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $optionEmpr .= '<option value="">-- SELECCIONE UNA OPCION --</option>';

            do {
                $empr_cod_empr = $oIfx->f($campo_id);
                $empr_nom_empr = $oIfx->f($campo_nom);

                $selectedEmpr = '';

                if ($empr_cod_empr == $campo_defecto) {
                    $selectedEmpr = 'selected';
                }
                $optionEmpr .= '<option value="' . $empr_cod_empr . '" ' . $selectedEmpr . '>' . $empr_nom_empr . '</option>';
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    return $optionEmpr;
}

function lista_boostrap_select2_func($oIfx, $sql, $campo_id_defecto, $campo_id, $campo_nom)
{
    $optionSelect2 = '';
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $campo_id_target    = $oIfx->f($campo_id);
                $campo_nom_target   = $oIfx->f($campo_nom);

                $selected_target = (empty($campo_id_defecto[$campo_id_target]))?"":"selected";

                $optionSelect2 .= '<option value="' . $campo_id_target . '" ' . $selected_target . '>' . $campo_nom_target . '</option>';
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    return $optionSelect2;
}

function fecha_informix_func2($fecha)
{
    $m = substr($fecha, 5, 2);
    $y = substr($fecha, 0, 4);
    $d = substr($fecha, 8, 2);

    return ($m . '/' . $d . '/' . $y);
}

function fecha_informix_modal($fecha)
{
    $m = substr($fecha, 0, 2);
    $d = substr($fecha, 3, 2);
    $y = substr($fecha, 6, 4);

    return ($d . '/' . $m . '/' . $y);
}

function fecha_mysql_func3($fecha)
{
    $d = substr($fecha, 0, 2);
    $m = substr($fecha, 3, 2);
    $y = substr($fecha, 6, 4);

    return ($y . '-' . $m . '-' . $d);
}


///// resultados de imagenes
function reporte_resultados_imagenes($cod_fact, $id_clpv, $id)
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();


    $oConA = new Dbo;
    $oConA->DSN = $DSN;
    $oConA->Conectar();

    $idempresa = $_SESSION['U_EMPRESA'];

    $sql = "select empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_tel_resp
                                            from saeempr where empr_cod_empr = $idempresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {

            $empr_path_logo = $oIfx->f('empr_path_logo');

        }
    }

    $sql = "SELECT
				img_informe_detalle.resultado,
				img_informe_detalle.nom_prod,
				img_informes.nom_clpv,
				img_informes.ruc_clpv,
				img_informes.user_web,
				img_informe_detalle.fecha_registro,
				img_informe_detalle.adjunto, 
				img_informe_detalle.id_img_informes, 
				USUARIO_NOMBRE as nombre, 
				USUARIO_APELLIDO as apellido,
				EMPL_COD_EMPL as cedula,
				especialidad,
				usuario_firma
			FROM
				img_informes
			INNER JOIN img_informe_detalle ON img_informes.id = img_informe_detalle.id_img_informes
			inner join usuario on img_informe_detalle.user_web=USUARIO_ID
			WHERE
				img_informe_detalle.id='$id'";
    if ($oCon->Query($sql)) {
        if ($oCon->NumFilas() > 0)
            do {
                $especialidad = $oCon->f('especialidad');
                $cedula = $oCon->f('cedula');
                $paciente = $oCon->f('nom_clpv');
                $ruc_clpv = $oCon->f('ruc_clpv');
                $fecha_registro = $oCon->f('fecha_registro');
                $nom_prod = $oCon->f('nom_prod');
                $resultado = TRIM($oCon->f('resultado'));
                $adjunto = $oCon->f('adjunto');
                $nombre = $oCon->f('nombre');
                $apellido = $oCon->f('apellido');
                $usuario_firma = $oCon->f('usuario_firma');
                $id_img_informes = $oCon->f('id_img_informes');
                $html_pdf = '<br><br><table style="width: 96%;" border=0>
								<tr>
									<td  style="width: 50%;"><strong>PACIENTE:</strong>' . $paciente . '</td>
									<td style="width: 25%;"><strong>IDENTIFICACION:</strong>' . $ruc_clpv . '</td>
									<td style="width: 25%;"  align="right"><strong>FECHA:</strong>' . $fecha_registro . '</td>
								</tr>
								<tr>
									<td style="width: 100%;" colspan="3"><h3>' . $nom_prod . '</h3></td>
								</tr>
								<tr>
									<td style="width: 100%;" colspan="3">
										<pre style="white-space:pre-wrap;">' . $resultado . '</pre>
									
									<br><br>
									</td>
								</tr>';
                if ($resultado != '') {
                    if (!empty($usuario_firma)) {
                        $html_pdf .= '	<tr>
									<td  colspan="3">ATENTAMENTE <br> <img src="' . path(DIR_INCLUDE) . 'clases/formulario/plugins/reloj/' . substr($usuario_firma, 3) . '" width="100"></td>
								</tr>';
                    }
                    $html_pdf .= '<tr>
										<td colspan="3" style="width: 100%; ">Dra.  ' . $nombre . ' ' . $apellido . '<br>' . $especialidad . '<br> REG No ' . $cedula . '</td>
									</tr>								';
                }

                $html_pdf .= '</table>';
                $table = ' <table style="width: 96%;" border=0>';
                if ($adjunto != '') {
                    $table .= '<tr>
									<td  colspan="3"><img src="' . path(DIR_INCLUDE) . 'clases/formulario/plugins/reloj/' . substr($adjunto, 3) . '" width="500"></td>
								</tr>';
                }
                $sql = "select * from img_informes_adj where id_img_informes='$id_img_informes'";


                if ($oConA->Query($sql)) {
                    if ($oConA->NumFilas() > 0) {
                        do {
                            $adjunto = $oConA->f('adjunto');
                            $table .= '	<tr>
									<td  colspan="3"><img src="' . path(DIR_INCLUDE) . 'clases/formulario/plugins/reloj/' . substr($adjunto, 3) . '" width="500"></td>
								</tr>';
                        } while ($oConA->SiguienteRegistro());

                    }
                }

                $table .= '</table>';
            } while ($oCon->SiguienteRegistro());
    }
    $documento = '<page backtop="70mm" backbottom="30mm" backleft="10mm" backright="20mm" style="width:100%; ">
					<page_header style="width:100%; font-size:20px; ">
						<table style="width:100%; margin: 0px; " border="0">
							<tr>
								<td valign="top" style="width:25%;"><img src="' . $empr_path_logo . '" width="300" /></td>
								
								<td style="width:25%;">Edificio - Hospital Lenin Mosquera<br>
														Flores 912 y Manabi (Plaza Teatro)<br>
														Telefonos: 2951225 / 2953572<br>
														Servicio al Cliente: 0988422423<br>
														administracion@hospitaleninmosquera.org<br>
														www.hospitaleninmosquera.org</td>
							</tr>					
							<tr>
								<td colspan="2" style="width:100%;" align="center"><h2  style="color:#0c5e3a" >SERVICIO DE IMAGENES CLINICAS</h2></td>
							</tr>
						</table>
					</page_header>
					<page_footer>
						
						<table style="width: 100%; margin: 0px; border-top:3px;  font-size: 20px;" >
						<tr><td style="width: 100%; "><h4>Servicios de Tomografía, Rayos X, Mamografía, Densitometría, Ecografías.</h4></td></tr>';


    $documento .= '</table>
					</page_footer>';
    $pdf .= $documento;
    $pdf .= $html_pdf;
    $pdf .= '</page>';
    if ($table != '') {

        $pdf .= $documento;
        $pdf .= $table;
        $pdf .= '</page>';

    }


    $nombre_archivo = 'RESULTADO_IMG_' . $cod_fact . '_' . $id_clpv . '_' . $id;

    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($pdf);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;


    return $pdf;
}

function envio_correo_examenes($cod_fact, $id_clpv, $id, $email, $tipo)
{
    include_once(path(DIR_INCLUDE) . "class.phpmailer.php");
    //  include_once(path(DIR_INCLUDE) . "class.smtp.php");
    global $DSN, $DSN_Ifx;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();
    $idempresa = $_SESSION['U_EMPRESA'];
    $sqlEmpr = "select empr_nom_empr, empr_dir_empr, empr_tel_resp from saeempr where empr_cod_empr = $idempresa";
    if ($oIfx->Query($sqlEmpr)) {
        $compania = $oIfx->f("empr_nom_empr");
        $dirMatriz = $oIfx->f('empr_dir_empr');
        $empr_tel_resp = $oIfx->f("empr_tel_resp");
    }
    $oIfx->Free();
    $sqlSmtp = "select server, port, auth, 
			user, pass, ssltls, 
			mail 
			from comercial.config_email
			where id_empresa = $idempresa and
			id_tipo = 1";
    if ($oCon->Query($sqlSmtp)) {
        if ($oCon->NumFilas() > 0) {
            $host = $oCon->f('server');
            $port = $oCon->f('port');
            $smtpauth = $oCon->f('auth');
            $userid = $oCon->f('user');
            $smtpsecure = $oCon->f('ssltls');
            $mailenvio = $oCon->f('mail');
            $password = $oCon->f('pass');
        }
    }
    $oCon->Free();

    $mail = new PHPMailer();
    $mail->IsSMTP();
    $mail->Mailer = "smtp";

    if ($smtpauth == 'S') {
        $mail->SMTPAuth = true;
    }


    $mail->SMTPSecure = $smtpsecure;


    $mail->Host = $host;
    $mail->Port = $port;
    $mail->Username = $userid;
    $mail->Password = $password;
    $mail->From = $mailenvio;
    if ($tipo == 1) {
        $des = 'LABORATORIO';
        $des2 = 'laboratorio';
    } else {
        $des = 'IMG';
        $des2 = 'imagen';

    }
    $mail->FromName = $compania;
    $mail->Subject = $des;
    $mail->AltBody = $des;
    $mail->IsHTML(true);
    $mail->CharSet = 'UTF-8';

    $html1 = "Estimado (a):<br><br>
			Adjunto al presente encontrar el resultado de examenes de " . $des2 . " <br><br>";
    $html2 = "<br>Atentamente,<br>
			" . $compania . "<br><br>";
    $cuerpo = $html1 . $html2;
    $mail->MsgHTML($cuerpo);

    $mail->AddAddress($email, $email);


    $nombre_archivo = 'RESULTADO_' . $des . '_' . $cod_fact . '_' . $id_clpv . '_' . $id;
//echo $nombre_archivo;exit;
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $mail->AddAttachment($ruta);
    if (!$mail->Send())
        return "Error: " . $mail->ErrorInfo . $sqlSmtp;
    else
        return 'Mail enviado!';

}

///// resultados de laboratorio

function reporte_resultados_laboratorio($cod_fact, $id_clpv, $id_l)
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();


    $idempresa = $_SESSION['U_EMPRESA'];

    $sql = "select empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_tel_resp
                                            from saeempr where empr_cod_empr = $idempresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {

            $empr_path_logo = $oIfx->f('empr_path_logo');

        }
    }
    $oIfx->Free();
    $sql = "SELECT
				lab_toma_detalle.id,
				lab_toma_detalle.cod_prod,
				lab_toma_detalle.nom_prod
			FROM
				lab_toma_muest
			INNER JOIN lab_toma_detalle ON lab_toma_muest.id = lab_toma_detalle.id_lab_toma_mues
			WHERE
				estado = 'RC' and cod_fact='$cod_fact' and id_clpv='$id_clpv' and lab_toma_muest.id='$id_l'";
    //	echo $sql;exit;
    if ($oCon->Query($sql)) {
        if ($oCon->NumFilas() > 0) {
            unset($array_detalle_id);
            do {
                $id = $oCon->f('id');
                $cod_prod = $oCon->f('cod_prod');
                $nom_prod = $oCon->f('nom_prod');
                $array_detalle_id[] = array($id, $cod_prod, $nom_prod);
            } while ($oCon->SiguienteRegistro());
        }
    }
    foreach ($array_detalle_id as $arreglo) {
        $id = $arreglo[0];
        $cod_prod = $arreglo[1];
        $nom_prod = $arreglo[2];
        $sql2 = "SELECT
							lab_toma_muest.nom_clpv,
							lab_toma_muest.ruc_clpv,
							lab_toma_detalle.nom_prod,
							lab_toma_detalle.cod_prod,
							DATE_FORMAT(lab_toma_detalle.fecha_registro, '%d-%m-%Y') as fecha_registro,
							lab_toma_muest.fecha_nacimineto,
							lab_toma_muest.sexo
							
						FROM
							lab_toma_muest
						INNER JOIN lab_toma_detalle ON lab_toma_muest.id = lab_toma_detalle.id_lab_toma_mues
						WHERE lab_toma_detalle.id='$id'";

        $paciente = consulta_string($sql2, 'nom_clpv', $oCon, '');
        $ruc_clpv = consulta_string($sql2, 'ruc_clpv', $oCon, '');
        $nom_prod = consulta_string($sql2, 'nom_prod', $oCon, '');
        $fecha_registro = consulta_string($sql2, 'fecha_registro', $oCon, '');
        $fecha_nacimineto = consulta_string($sql2, 'fecha_nacimineto', $oCon, '');

        $sexo = consulta_string($sql2, 'sexo', $oCon, '');
        $fecha = time() - strtotime($fecha_nacimineto);
        $edad = floor((($fecha / 3600) / 24) / 360);
        if ($sexo == 'M') {
            $sexo = 'MASCULINO';
        } else {
            $sexo = 'FEMENINO';
        }
        $sql = "SELECT
					lab_servicio_detalle.descripcion,
					lab_toma_reultado.resultado,
					lab_toma_reultado.referencia,
					lab_toma_reultado.fecha_registro
				FROM
					lab_servicios
				INNER JOIN lab_servicio_detalle ON lab_servicios.id = lab_servicio_detalle.id_lab_servicio
				INNER JOIN lab_toma_reultado ON lab_servicio_detalle.id = lab_toma_reultado.id_servicio_detalle
				WHERE
					lab_toma_reultado.id_lab_toma_detalle='$id'";
        //$oReturn->alert	($sql);
        if ($oCon->Query($sql)) {
            if ($oCon->NumFilas() > 0) {
                $documento = '<page backtop="60mm" backbottom="30mm" backleft="10mm" backright="20mm" style="width:100%; ">
										<page_header style="width:100%; font-size:20px; ">
											<table style="width:100%; margin: 0px; " border=0>
												<tr>
													<td style="width:25%;"><img src="' . $empr_path_logo . '" width="300" /></td>
													
													<td style="width:25%;">Edificio - Hospital Lenin Mosquera<br>
														Flores 912 y Manabi (Plaza Teatro)<br>
														Telefonos: 2951225 / 2953572<br>
														Servivio al Cliente: 0988422423<br>
														administracion@hospitaleninmosquera.org<br>
														www.hospitaleninmosquera.org</td>
												</tr>
												<tr>
													<td colspan="2" style="width:100%;" align="center"><h2  style="color:#0c5e3a" >SERVICIO DE LABORATORIO CLINICO</h2></td>
												</tr>
											</table>
										</page_header>
										<page_footer>
											<table style="width: 100%; margin: 0px; border-top:3px;  font-size: 20px;" >
												
												<tr>
													<td style="width: 100%; ">&nbsp;&nbsp;&nbsp;&nbsp;Responsable:  </td>
												</tr>
												
											</table>
										</page_footer>';

                $html_pdf = '<table style="width: 96%;" border=0>
									<tr>
										<td colspan="2" style="width: 50%;"><strong>PACIENTE:</strong>' . $paciente . '</td>
										<td style="width: 25%;"><strong>IDENTIFICACION:</strong>' . $ruc_clpv . '</td>
										<td style="width: 25%;"  align="right"><strong>FECHA:</strong>' . $fecha_registro . '</td>
									</tr>
									<tr>
										<td style="width: 10%;"><strong>EDAD:</strong>' . $edad . '</td>
										<td style="width: 25%;"><strong>SEXO:</strong>' . $sexo . '</td>
										<td style="width: 25%;"></td>
										<td style="width: 25%;"></td>
									</tr>
									<tr>
										<td colspan="4"  align="center" style="width: 100%;"><h3><strong>' . $nom_prod . '</strong></h3></td>
										
									</tr>
								</table>
								<table style="width: 96%; border:2px solid black; border-radius: 5px 5px 5px 5px" cellspacing="0" cellpadding="0">
									<tr>
										<td style="width: 33%;border-bottom: 1px inset black;border-right:1px; text-align:center"><strong>DESCRIPCION</strong></td>
										<td style="width: 33%;border-bottom: 1px inset black;border-right:1px; text-align:center"><strong>RESULTADO</strong></td>
										<td style="width: 33%;border-bottom: 1px inset black;border-right:1px; text-align:center"><strong>REFERENCIA</strong></td>
									</tr>';

                do {
                    $decripcion = $oCon->f('descripcion');
                    $resultado = $oCon->f('resultado');
                    $referencia = $oCon->f('referencia');
                    $html_pdf .= '<tr>
									<td style="width: 33%;border-bottom: 1px inset black; border-right:1px">' . $decripcion . '</td>
									<td style="width: 33%;border-bottom: 1px inset black; border-right:1px"><pre>' . $resultado . '</pre></td>
									<td style="width: 33%;border-bottom: 1px inset black; border-right:1px"><pre>' . $referencia . '</pre></td>
								</tr>';
                } while ($oCon->SiguienteRegistro());
                $html_pdf .= '</table>';
                $pdf .= $documento;
                $pdf .= $html_pdf;
                $pdf .= '</page>';
            }
        }

    }
    $nombre_archivo = 'RESULTADO_LABORATORIO_' . $cod_fact . '_' . $id_clpv . '_' . $id_l;
    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($pdf);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;


    return $pdf;
}

function impresion_solicitudes($id_)
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();


    $oConA = new Dbo;
    $oConA->DSN = $DSN;
    $oConA->Conectar();

    $idempresa = $_SESSION['U_EMPRESA'];

    $sql = "select empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_tel_resp
                                            from saeempr where empr_cod_empr = $idempresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {

            $empr_path_logo = $oIfx->f('empr_path_logo');

        }
    }

    $sql = "SELECT
			descricion,
			solicitud_examen.id, 
			consulta_id,
			tipo_solicitudes.id as tipo,
			solicitud_examen.user_id, 
			clpv_paciente, observacion
			from 
			solicitud_examen,
			tipo_solicitudes
			
		WHERE
			tipo_solicitud_id = tipo_solicitudes.id
			and solicitud_examen.id='$id_'";
    if ($oCon->Query($sql)) {
        if ($oCon->NumFilas() > 0) {
            do {
                $descripcion_ = $oCon->f("descricion");
                $consulta_id = $oCon->f("consulta_id");
                $tipo = $oCon->f("tipo");
                $usuario_id = $oCon->f("user_id");
                $clpv_paciente = $oCon->f("clpv_paciente");
                $observacion = $oCon->f("observacion");
            } while ($oCon->SiguienteRegistro());
        }
    }
    $sql = "select concat(usuario_nombre, ' ', usuario_apellido) as user from usuario where usuario_id = $usuario_id";
    $user = consulta_string($sql, 'user', $oCon, '');

    $sql = "select clpv_nom_clpv from saeclpv where clpv_cod_clpv = $clpv_paciente";
    $clpv_nom_clpv = consulta_string($sql, 'clpv_nom_clpv', $oIfx, '');
    //echo $sql;exit;
    $html = '<h2  style="color:#0c5e3a" >PACIENTE:' . $clpv_nom_clpv . ' </h2>
			<table  cellpadding="0" cellspacing="0" class="table table-bordered table-striped table-condensed" style="width: 99%; margin-bottom: 0px;">
								';
    $sql = "select * from tipo_solicitud_categoria where tipo_solicitud_id='$tipo' and estado='1' order by posicion";

    if ($oCon->Query($sql)) {
        if ($oCon->Numfilas() > 0) {
            $i = 1;

            do {
                $ban = true;
                $id = $oCon->f('id');
                $descripcion = $oCon->f('descripcion');
                $grupo = $oCon->f('grupo');
                $des_grupo = $oCon->f('des_grupo');
                if ($i == 1) {
                    $html .= '<tr>';
                }

                $html .= '<td  valign="top" style="width: 32%; margin-bottom: 0px;">
									<table  cellpadding="0" cellspacing="0"  style="width: 100%; margin-bottom: 0px;" border="1" class="table">
										<tr>
											<td style="width: 5%;"> </td>
											<td style="width: 80%;">' . $descripcion . '</td>
											<td style="width: 15%;">CANT</td>
										</tr>';
                $sql = "SELECT
								tipo_solicitud_detalle.id,
								tipo_solicitud_detalle.descripcion,
								tipo_solicitud_detalle.codigo_producto,
								tipo_solicitud_detalle.tipo_categoria_id,
								tipo_solicitud_detalle.estado,
								tipo_solicitud_detalle.bodega 
							FROM
								tipo_solicitud_detalle
								INNER JOIN solicitud_examen_detalle ON tipo_solicitud_detalle.id = solicitud_examen_detalle.tipo_solicitud_detalle_id
								INNER JOIN solicitud_examen ON solicitud_examen_detalle.solicitud_examen_id = solicitud_examen.id 
							WHERE
								tipo_solicitud_detalle.tipo_categoria_id = '$id' 
								AND tipo_solicitud_detalle.estado = '1' and solicitud_examen.id='$id_'";
                //		echo $sql;exit;
                if ($oConA->Query($sql)) {
                    if ($oConA->Numfilas() > 0) {
                        do {
                            $codigo = $oConA->f('codigo_producto');
                            $id = $oConA->f('id');
                            $descripcion = $oConA->f('descripcion');
                            $html .= '<tr>
												<td align="center">X</td>
												<td align="left"><label for="' . $id . '"  class="control-label">' . $descripcion . '</label></td>
												<td align="center">1</td>
											</tr>';
                        } while ($oConA->SiguienteRegistro());
                    }
                }
                $html .= '</table></td>';
                $i++;
                if ($i == 4) {
                    $html .= '</tr>';
                    $i = 1;

                    $ban = false;
                }


            } while ($oCon->SiguienteRegistro());

        }
    }

    if ($ban == true) {
        $html .= '</tr>';
    }


    $html .= '</table><h3>Observaciones:</h3><h4>' . $observacion . '</h4>';
    $documento = '<page backtop="70mm" backbottom="30mm" backleft="10mm" backright="20mm" style="width:100%; ">
					<page_header style="width:100%; font-size:20px; ">
						<table style="width:100%; margin: 0px; " border="0">
							<tr>
								<td valign="top" style="width:25%;"><img src="' . $empr_path_logo . '" width="300" /></td>
								
								<td style="width:25%;">Edificio - Hospital Lenin Mosquera<br>
														Flores 912 y Manabi (Plaza Teatro)<br>
														Telefonos: 2951225 / 2953572<br>
														Servivio al Cliente: 0988422423<br>
														administracion@hospitaleninmosquera.org<br>
														www.hospitaleninmosquera.org</td>
							</tr>					
							<tr>
								<td colspan="2" style="width:100%;" align="center"><h2  style="color:#0c5e3a" >SOLICITUD DE ' . $descripcion_ . ' </h2></td>
							</tr>	

						</table>
					</page_header>
					<page_footer>
						<table style="width: 100%; margin: 0px; border-top:3px;  font-size: 20px;" >
							
							<tr>
								<td style="width: 100%; ">&nbsp;&nbsp;&nbsp;&nbsp;Responsable:' . $user . '  </td>
							</tr>
							
						</table>
					</page_footer>';

    $documento .= $html . '</page>';
    //echo $documento;exit;
    return $documento;

}


// PDF PEDIDO COMPRA
function generar_pedido_compra_pdf($idempresa = "", $idsucursal = "", $pedido_num = "")
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();


    $idEmpresa = $_SESSION['U_EMPRESA'];

    $class = new GeneraPedidoCompra();

    $arrayMinv = $class->generaSaepedi($oIfx, $idempresa, $idsucursal, $pedido_num);

    $arrayDmov = $class->generaSaedped($oIfx, $idempresa, $idsucursal, $pedido_num);

    //var_dump($arrayRetencion);exit;
    foreach ($arrayMinv as $val) {
        $pedi_cod_pedi = $val[0];
        $pedi_res_pedi = $val[1];
        $pedi_fec_pedi = $val[2];
        $pedi_det_pedi = $val[3];
        $pedi_are_soli = $val[4];
        $pedi_lug_entr = $val[5];
        $pedi_uso_pedi = $val[6];
        $pedi_des_cons = $val[7];
    }

    $sql = "select empr_ruc_empr, empr_dir_empr, empr_nom_empr, empr_path_logo from saeempr where empr_cod_empr = $idempresa ";
    if ($oIfx->Query($sql)) {
        $empr_ruc = $oIfx->f('empr_ruc_empr');
        $empr_dir = $oIfx->f('empr_dir_empr');
        $empr_nom = $oIfx->f('empr_nom_empr');
        $empr_path_logo = $oIfx->f('empr_path_logo');
        $empr_nom .= ' ';
    }
    $sql = "SELECT sucu_nom_sucu FROM saesucu WHERE sucu_cod_sucu='$idsucursal'";
    if ($oIfx->Query($sql)) {
        $sucu_nom = $oIfx->f('sucu_nom_sucu');
    }





    $oIfx->Free();
    setlocale(LC_ALL, "es_ES@euro", "es_ES", "esp");

    $asto_fec = strftime("%d de %B de %Y", strtotime($asto_fec));
    $pedi_fec_pedi = str_replace('/', '', $pedi_fec_pedi);
    // $pedi_fec_pedi = strftime("%d de %B de %Y", strtotime($pedi_fec_pedi));


    $html .= '<table style="margin-left:50px; margin-right:50px; margin-top:30px">
				<tr >
					<td style="font-size:18px; text-align: left">' . $empr_nom . '<br><br></td>
				</tr>
				<tr>
					<td  style="font-size:14px; text-align: left;">SUCURSAL: ' . $sucu_nom . '<br><br></td>
				</tr>
				<tr>
					<td  style="font-size:14px; text-align: left">DIRECCION: ' . $empr_dir . '<br><br></td>
				</tr>
				<tr>
					<td style="font-size:14px; text-align: left">RUC: ' . $empr_ruc . '<br><br></td>
				</tr>
				<tr>
					<td style="font-size:14px; text-align: left">N.- PEDIDO COMPRA: ' . $pedi_cod_pedi . '<br><br></td>
				</tr>
						
				
			</table>
			<table border="0"  style="width: 100%; margin-left:50px; margin-top:10px;">
				<tr>
					<td colspan="2" style="width: 100%;font-size:12px; text-align: left">Fecha: ' . $pedi_fec_pedi . '</td>
					
				</tr>			
				<tr>
					<td colspan="2" style="width: 100%; font-size:12px; text-align: left">Solicitado por: ' . $pedi_res_pedi . '<br><br></td>
				</tr>	
				<tr>
					<td colspan="2" style="width: 100%; font-size:12px; text-align: left">Area Solicitado: ' . $pedi_are_soli . '<br><br></td>
				</tr>
				<tr>
					<td colspan="2" style="width: 100%; font-size:12px; text-align: left">Observacion: ' . $pedi_des_cons . '<br><br></td>
				</tr>				
			</table>';

    //SAEDMOV
    if (count($arrayDmov) > 0) {
        $html .= '
								<table  style="margin-left:50px; width:90%;border:1px solid black; border-radius: 5px; margin-top:20px" align="left">
									<tr>
									<td colspan="6" style="width:100%;font-size:16px; text-align: center; border-bottom:1px solid ">DETALLE</td>
									</tr>
									<tr>
										<td  style="width:3%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid ">N</td>
										<td  style="width:20%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid">BODEGA</td>
										<td  style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid">CODIGO</td>
										<td  style="width:30%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid">PRODUCTO</td>
										<td  style="width:10%;font-size:14px; text-align: center; border-bottom:1px solid">UNIDAD</td>
										<td  style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid">CANT.</td>										
									</tr>';

        $i = 1;
        foreach ($arrayDmov as $val) {
            $dped_cod_prod = $val[0];
            $dped_cod_bode = $val[1];
            $dped_cod_unid = $val[2];
            $dped_can_ped = $val[3];
            $dped_prod_nom = $val[4];

            $sql = "select unid_nom_unid from saeunid where unid_cod_empr = $idempresa and unid_cod_unid = $dped_cod_unid ";
            $unid_nom = consulta_string_func($sql, 'unid_nom_unid', $oIfx, '');

            $sql = "select bode_nom_bode from saebode where bode_cod_empr = $idempresa and bode_cod_bode = '$dped_cod_bode' ";
            $bode_nom = consulta_string_func($sql, 'bode_nom_bode', $oIfx, '');


            $html .= '<tr>';
            $html .= '<td style="width:3%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid ">' . $i . '</td>';
            $html .= '<td style="width:20%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid">' . $bode_nom . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $dped_cod_prod . '</td>';
            $html .= '<td style="width:30%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $dped_prod_nom . '</td>';
            $html .= '<td style="width:30%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $unid_nom . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid" align="right">' . $dped_can_ped . '</td>';
            $html .= '</tr>';

            $i++;
        }
        $html .= '</table>';
    }

    return $html;

}


function envio_correo_adj_inv($correo = '', $idEmpresa, $idSucursal, $serial_minv, $pdf, $tipo, $clpv_correo, $clpv_nom)
{

    require_once('class.phpmailer.php');
    require_once('class.smtp.php');

    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    //$clpv_correo="garcia.andres.resona@gmail.com";

    $sqlEmpr = "select empr_nom_empr, empr_dir_empr, empr_tel_resp from saeempr where empr_cod_empr = $idEmpresa";

    if ($oIfx->Query($sqlEmpr)) {
        $compania = $oIfx->f("empr_nom_empr");
        $dirMatriz = $oIfx->f('empr_dir_empr');
        $empr_tel_resp = $oIfx->f("empr_tel_resp");
    }
    $oIfx->Free();

    //consulta correos y mensaje
    $sql = "select prpc_sub_prpc, prpc_men_prpc
				from saeprpc where
				prpc_cod_empr = $idEmpresa and
				prpc_cod_sucu = $idSucursal and
				prpc_cod_prpc = $tipo  ";

    if ($oIfx->Query($sql)) {
        $prpc_sub_prpc = $oIfx->f("prpc_sub_prpc");
        $prpc_men_prpc = $oIfx->f("prpc_men_prpc");
    }
    $oIfx->Free();

    if(empty($prpc_men_prpc)){
        $prpc_men_prpc='';

    }

    $sqlSmtp = "select server, port, auth, 
    config_email.user, pass, ssltls, mail
    from comercial.config_email
    where id_empresa =$idEmpresa";
    if ($oCon->Query($sqlSmtp)) {
        if ($oCon->NumFilas() > 0) {
            $host = $oCon->f('server');
            $port = $oCon->f('port');
            $smtpauth = $oCon->f('auth');
            $userid = $oCon->f('user');
            $smtpsecure = $oCon->f('ssltls');
            $mailenvio = $oCon->f('mail');
            $password = $oCon->f('pass');
        }
    }
    $oCon->Free();



    $mail = new PHPMailer();
    $mail->IsSMTP();
    $mail->Mailer = "smtp";

    if ($smtpauth == 'S') {
        $mail->SMTPAuth = true;
    }

    $mail->SMTPSecure = $smtpsecure;

    $mail->Host = $host;
    $mail->Port = $port;
    //$mail->SMTPDebug =4;
    $mail->Username = $userid;
    $mail->Password = $password;
    $mail->From = $mailenvio;

    $mail->FromName = $compania;
    $mail->Subject = $prpc_sub_prpc . ' No.' . $serial_minv;

    $mail->CharSet = 'UTF-8';

    $sHtml = $prpc_men_prpc;

    $mail->MsgHTML($sHtml);

    $sql_tmp = '';
    if ($tipo == 1) {
        // PEDIDO
        $sql_tmp = " and  usua_cr1_usua   > '0'  ";
    } elseif ($tipo == 2) {
        // COTIZACION
        $sql_tmp = " and  usua_cr2_usua   > '0'  ";
    } elseif ($tipo == 3) {
        // AUTORIZACION COTIZACION
        $sql_tmp = " and  usua_cr3_usua   > '0'  ";
    } elseif ($tipo == 4) {
        // ORDEN DE COMPRA
        $sql_tmp = " and  usua_cr4_usua   > '0'  ";
    } elseif ($tipo == 5) {
        // AUTORIZACION ORDEN DE COMPRA
        $sql_tmp = " and  usua_cr5_usua   > '0'  ";
    }


    //consulta correos
    $sql_correo = "select  empl_mai_empl, empl_cod_empl    from saeusua, saeempl where
						usua_cod_empl = empl_cod_empl and
						empl_cod_empr = $idEmpresa 
						$sql_tmp  ";

    if ($oIfx->Query($sql_correo)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $prfa_mail1 = $oIfx->f('empl_mai_empl');

                //envia correo
                if (!empty($prfa_mail1)) {
                    $mail->AddBCC($prfa_mail1, $prfa_mail1);
                }
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();


    $mail->AddAddress($clpv_correo, $clpv_correo);


    $mail->AddAttachment($pdf, $serial_minv . $clpv_nom . '.pdf');

    $mail->IsHTML(true);

    if (!$mail->Send()) {
        $msg = "Error: " . $mail->ErrorInfo;
    } else {
        $msg = "Mensaje enviado correctamente a: \n $clpv_correo";
    }
    return $msg;
}


function generar_requ_inv_pdf($idempresa = "", $idsucursal = "", $requ_cod = "")
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();

    $oCon = new Dbo ();
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $sql = "SELECT u.USUARIO_ID, u.USUARIO_USER FROM comercial.usuario u ";
    unset($array_user);
    $array_user = array_dato($oCon, $sql, 'usuario_id', 'usuario_user');

    $sql = "select  treq_cod_treq, trec_des_treq  from saetreq where treq_cod_empr = $idempresa  ";
    unset($array_tipo);
    $array_tipo = array_dato($oIfx, $sql, 'treq_cod_treq', 'trec_des_treq');

    $sql = "select  bode_cod_bode, bode_nom_bode from saebode where bode_cod_empr = $idempresa  ";
    unset($array_bode);
    $array_bode = array_dato($oIfx, $sql, 'bode_cod_bode', 'bode_nom_bode');

    $sql = "select unid_nom_unid, unid_cod_unid from saeunid where unid_cod_empr = $idempresa ";
    unset($array_unid);
    $array_unid = array_dato($oIfx, $sql, 'unid_cod_unid', 'unid_nom_unid');


    $class = new GeneraRequisicionInv();

    $arrayMinv = $class->generaSaerequ($oIfx, $idempresa, $idsucursal, $requ_cod);

    $arrayDmov = $class->generaSaedreq($oIfx, $idempresa, $idsucursal, $requ_cod);

    //var_dump($arrayRetencion);exit;
    foreach ($arrayMinv as $val) {
        $requ_cod_treq = $val[0];
        $requ_cod_empl = $val[1];
        $requ_est_requ = $val[2];
        $requ_fec_requ = $val[3];
        $requ_cod_bode = $val[4];
        $requ_bode_sol = $val[5];
        $requ_user_web = $val[6];
        $requ_num_preimp = $val[7];
        $requ_fec_aprob = $val[8];
        $requ_hora_apro = $val[9];

    }

    $sql = "select empr_ruc_empr, empr_dir_empr, empr_nom_empr, empr_path_logo from saeempr where empr_cod_empr = $idempresa ";
    if ($oIfx->Query($sql)) {
        $empr_ruc = $oIfx->f('empr_ruc_empr');
        $empr_dir = $oIfx->f('empr_dir_empr');
        $empr_nom = $oIfx->f('empr_nom_empr');
        $empr_path_logo = $oIfx->f('empr_path_logo');
        $empr_nom .= ' ';
    }
    $sql = "SELECT sucu_nom_sucu FROM saesucu WHERE sucu_cod_sucu='$idsucursal'";
    if ($oIfx->Query($sql)) {
        $sucu_nom = $oIfx->f('sucu_nom_sucu');
    }


    $oIfx->Free();
    setlocale(LC_ALL, "es_ES@euro", "es_ES", "esp");

    $asto_fec = strftime("%d de %B de %Y", strtotime($asto_fec));

    $html .= '<table style="margin-left:50px; margin-right:50px; margin-top:30px">
				<tr >
					<td style="font-size:18px; text-align: left">' . $empr_nom . '<br><br></td>
				</tr>
				<tr>
					<td  style="font-size:14px; text-align: left">SUCURSAL:' . $sucu_nom . '<br><br></td>
				</tr>
				<tr>
					<td  style="font-size:14px; text-align: left">DIRECCION:' . $empr_dir . '<br><br></td>
				</tr>
				<tr>
					<td style="font-size:14px; text-align: left">RUC:' . $empr_ruc . '<br><br></td>
				</tr>
				<tr>
					<td style="font-size:14px; text-align: left">N.- REQUISICION:' . $requ_num_preimp . '<br><br></td>
				</tr>
						
				
			</table>
			<table border="0"  style="width: 100%; margin-left:50px; margin-top:10px;">
				<tr>
					<td colspan="2" style="width: 100%;font-size:12px; text-align: left"><strong>Fecha:</strong> ' . $requ_fec_requ . '</td>
					
				</tr>			
				<tr>
					<td colspan="2" style="width: 100%; font-size:12px; text-align: left"><strong>Solicitado por:</strong> ' . $array_user[$requ_user_web] . '<br><br></td>
                </tr>
                <tr>
					<td colspan="2" style="width: 100%; font-size:12px; text-align: left"><strong>Bodega Solicita:</strong> ' . $array_bode[$requ_bode_sol] . '<br><br></td>
                </tr>
                <tr>
					<td colspan="2" style="width: 100%; font-size:12px; text-align: left"><strong>Bodega Aprueba:</strong> ' . $array_bode[$requ_cod_bode] . '<br><br></td>
				</tr>				
			</table>';

    //SAEDMOV
    if (count($arrayDmov) > 0) {
        $html .= '
								<table  style="margin-left:50px; width:90%;border:1px solid black; border-radius: 5px; margin-top:20px" align="left">
									<tr>
									<td colspan="6" style="width:100%;font-size:16px; text-align: center; border-bottom:1px solid "><strong>DETALLE</strong></td>
									</tr>
									<tr>
										<td  style="width:3%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>N</strong></td>
										<td  style="width:20%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>BODEGA</strong></td>
										<td  style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>CODIGO</strong></td>
										<td  style="width:30%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>PRODUCTO</strong></td>
										<td  style="width:10%;font-size:14px; text-align: center; border-bottom:1px solid"><strong>UNIDAD</strong></td>
										<td  style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>CANT.</strong></td>										
									</tr>';

        $i = 1;
        foreach ($arrayDmov as $val) {
            $dreq_cod_prod = $val[0];
            $dreq_cod_bode = $array_bode[$val[1]];
            $dreq_can_dreq = $val[2];
            $dreq_cod_unid = $array_unid[$val[3]];

            $sql = "select prod_nom_prod from saeprod where prod_cod_empr = $idempresa and prod_cod_sucu = $idsucursal and prod_cod_prod = '$dreq_cod_prod' ";
            $prod_nom = consulta_string_func($sql, 'prod_nom_prod', $oIfx, '1');

            $html .= '<tr>';
            $html .= '<td style="width:3%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid ">' . $i . '</td>';
            $html .= '<td style="width:20%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid">' . $dreq_cod_bode . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $dreq_cod_prod . '</td>';
            $html .= '<td style="width:30%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $prod_nom . '</td>';
            $html .= '<td style="width:30%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $dreq_cod_unid . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid" align="right">' . $dreq_can_dreq . '</td>';
            $html .= '</tr>';

            $i++;
        }
        $html .= '</table>';
    }

    return $html;

}


function envio_correo_requ($correo = '', $ride = '', $pdf = '', $nom_clpv = '', $clave = '', $serial = '', $clpv = 0, $idTipo = 0, $title = '', $msn_secu)
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    //variables de session
    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idSucursal = $_SESSION['U_SUCURSAL'];

    //tipo documento
    $sqlDocu = "select documento from comercial.doc_time where id_time = '$idTipo' ";
    $docu = consulta_string_func($sqlDocu, 'documento', $oCon, '');

    $sqlEmpr = "select empr_nom_empr, empr_dir_empr, empr_tel_resp, empr_token_api from saeempr where empr_cod_empr = $idEmpresa";
    if ($oIfx->Query($sqlEmpr)) {
        $compania = $oIfx->f("empr_nom_empr");
        $dirMatriz = $oIfx->f('empr_dir_empr');
        $empr_tel_resp = $oIfx->f("empr_tel_resp");

        $empr_api_toke = $oIfx->f("empr_token_api");
        $nomb_empresa = $oIfx->f("empr_nom_empr");
    }
    $oIfx->Free();

    //PARAMETROS ENVIO DE CORREOS
    $sqlSmtp = "select server, port, auth, user, pass, ssltls, mail 	from comercial.config_email 	where 
                    id_empresa   = $idEmpresa and
			        id_tipo      = '$idTipo' ";
    if ($oCon->Query($sqlSmtp)) {
        if ($oCon->NumFilas() > 0) {
            $host = $oCon->f('server');
            $port = $oCon->f('port');
            $smtpauth = $oCon->f('auth');
            $userid = $oCon->f('user');
            $smtpsecure = $oCon->f('ssltls');
            $mailenvio = $oCon->f('mail');
            $password = $oCon->f('pass');
        }
    }
    $oCon->Free();

    if($smtpsecure=='S'||$smtpsecure=='ssl'){
        $smtpsecure='ssl';
    }
    else{
        $smtpsecure='tls';
    }

    $secure_type=$smtpsecure;


    //ARRAY ARCHVOS ADJUNTOS
    $adj = array();
    $adjuntos = DIR_FACTELEC . 'modulos/inventario_requisicion_solicitud/documento.pdf';
    if (file_exists($adjuntos)) {
        $archivo = file_get_contents($adjuntos);
        $archivo = array("name" => basename($adjuntos), "content" => base64_encode($archivo));
        array_push($adj, $archivo);
    }

    //CONSTRUCCION PARAMETROS WEB SERVICE

    $headers = array(
        "Content-Type:application/json",
        "Token-Api:$empr_api_toke"
    );

    $correocc = array();


    $sHtml = "<div style='width: 900px;'>
				<table style='width:850px;'> 
					<tr>
						<td>Estimados,</td>
					</tr>
					<tr>
						<td>Le informamos que ha sido generado el siguiente documento N.- Requisicion <span style='font-weight: bold'>$nom_clpv</span>, a continuacion adjuntamos el archivo:</td>
					</tr>
				</table>
				<br /> 
				<br><br>
				<table style='width:850px;'>
					<tr> 
						<td>Atentamente,</td>
					</tr> 
					<tr>&nbsp;</tr>
					<tr>&nbsp;</tr>
					<tr>
						<td style='font-weight: bold; font-size: 13px;'>$compania</td>
					</tr>
					<tr>&nbsp;</tr>
					<tr>
						<td style='font-weight: bold;'>Dire.: $dirMatriz</td>
					</tr>
					<tr>
						<td style='font-weight: bold;'>Telf.: $empr_tel_resp</td>
					</tr>
					 <tr>&nbsp;</tr>
				</table>
			</div>";

    //consulta correos
    $sql_correo = "select prfa_mail1, prfa_mail2, prfa_mail3 from saeprfa where prfa_cod_empr = $idEmpresa and prfa_est_prfa = 'S' and prfa_cod_prfa = 5";
    if ($oIfx->Query($sql_correo)) {
        if ($oIfx->NumFilas() > 0) {
            $prfa_mail1 = $oIfx->f('prfa_mail1');
            $prfa_mail2 = $oIfx->f('prfa_mail2');
            $prfa_mail3 = $oIfx->f('prfa_mail3');

            if(!empty($prfa_mail1)){
                array_push( $correocc,$prfa_mail1);
            }
            if(!empty($prfa_mail2)){
                array_push( $correocc,$prfa_mail2);
            }
            if(!empty($prfa_mail3)){
                array_push( $correocc,$prfa_mail3);
            }

        }
    }
    $oIfx->Free();


    $smtp_server = "{$host}:{$port}";
    $correoArray = explode(";", $correo);

    $data = array(
        "smtp_server" => $smtp_server,
        "secure_type" => $secure_type,
        "username" => $userid,
        "password" => $password,
        "from_address" => $mailenvio,
        "to_address" =>  $correoArray,
        "to_cc" =>  $correocc,
        "title" => "$title",
        "content" => $sHtml,
        "attachments" => $adj
    );



    $ch = curl_init();
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_URL, URL_JIREH_WS_CORREOS."/api/v1/correo/enviar");
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $respuesta = curl_exec($ch);
    curl_close($ch);
    $resultado = json_decode($respuesta,true);
//    print_r($resultado);exit;
    $mensaje = $resultado["msg"];
    $enviado = $resultado["result"];

    $destinatarios = '';
    foreach($correoArray as $cor){

        $destinatarios.=$cor.' ';
    }

    if($enviado == true){
        $msg="Mail enviado a: $destinatarios";
    }else{
        $msg="Error al enviar email: $mensaje";
    }


    return $msg;
}


function generar_mov_inv_tran_taller_pdf($idempresa = "", $idsucursal = "", $minv_num_comp = "", $tran_cod = '', $ejer_cod = "", $prdo_cod = "")
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idBodega = $_SESSION['U_BODEGA'];

    $class = new GeneraDetalleInventario();

    $arrayMinv = $class->generaSaeminv($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $tran_cod, $minv_num_comp);

    $arrayDmov = $class->generaSaedmov($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $minv_num_comp);

    //var_dump($arrayRetencion);exit;
    foreach ($arrayMinv as $val) {
        $minv_num_sec = $val[0];
        $minv_cod_clpv = $val[1];
        $minv_fmov = $val[2];
        $minv_fac_prov = $val[3];
        $minv_tot_minv = $val[4];
        $minv_iva_valo = $val[5];
        $minv_cm1_minv = $val[6];
        $minv_hor_minv = $val[7];
        $minv_cod_mone = $val[8];
        $minv_ruc_resp = $val[9];
        $minv_nomb_resp = $val[10];
    }

    $sql = "select empr_ruc_empr, empr_dir_empr, empr_nom_empr, empr_path_logo from saeempr where empr_cod_empr = $idempresa ";
    if ($oIfx->Query($sql)) {
        $empr_ruc = $oIfx->f('empr_ruc_empr');
        $empr_dir = $oIfx->f('empr_dir_empr');
        $empr_nom = $oIfx->f('empr_nom_empr');
        $empr_path_logo = $oIfx->f('empr_path_logo');
        $empr_nom .= ' ';
    }
    $sql = "SELECT sucu_nom_sucu FROM saesucu WHERE sucu_cod_sucu='$idsucursal'";
    if ($oIfx->Query($sql)) {
        $sucu_nom = $oIfx->f('sucu_nom_sucu');
    }


    $sql = "select tran_des_tran from saetran where
					tran_cod_empr = $idempresa and
					tran_cod_sucu = $idsucursal and
					tran_cod_tran = '$tran_cod' ";
    if ($oIfx->Query($sql)) {
        $tran_nom_tran = $oIfx->f('tran_des_tran');
    }

    $oIfx->Free();
    setlocale(LC_ALL, "es_ES@euro", "es_ES", "esp");

    $asto_fec = strftime("%d de %B de %Y", strtotime($asto_fec));

    // MONEDA
    $sql = "select mone_des_mone from saemone where mone_cod_empr = $idempresa and mone_cod_mone = $minv_cod_mone ";
    $moneda = consulta_string_func($sql, 'mone_des_mone', $oIfx, 0);

    // CONTRATOS
    /*
    $sql = "SELECT l.codigo FROM comercial.int_inst_despacho_cab c, comercial.instalacion_clpv t, comercial.contrato_clpv l WHERE
                    l.id               = t.id_contrato and
                    c.id_inst_desp_cab = t.id_inst_desp_cab and
                    c.empr_cod_empr    = $idempresa AND
                    c.minv_num_comp    = $minv_num_comp AND
                    t.id_empresa       = $idempresa
                    GROUP BY 1 ";
                    */
    $contrato = '';
    /*
    if($oCon->Query($sql)){
        do{
            $contrato .= $oCon->f('codigo'). ' - ' ;
        }while($oCon->SiguienteRegistro());
    }
    */
    //<strong>' . $tran_nom_tran . '</strong> 
    //<table  style="margin-left:50px; width:90%;border:1px solid black; border-radius: 5px; margin-top:10px" align="left; font-family: Courier;">
    //Banchito
    $minv_fmov = str_replace("/", "", $minv_fmov);
    $html .= '<table style="margin-left:50px; width:100%; margin-right:50px; margin-top:30px; font-family: Courier;" align="center">
				<tr >
					<td style="font-size:20px; text-align: center;"><strong>' . $empr_nom . '</strong><br></td>
				</tr>
				<tr>
					<td  style="font-size:14px; text-align: center;">SUCURSAL:' . $sucu_nom . '<br></td>
				</tr>
				<tr>
					<td  style="font-size:14px; text-align: center;">DIRECCION:' . $empr_dir . '<br></td>
				</tr>
				<tr>
					<td style="font-size:14px; text-align: center;">RUC:' . $empr_ruc . '<br></td>
				</tr>
			</table>

            <table  style="margin-left:40px; width:90%;border:0px solid black; margin-top:10px" align="center">
                <tr>
                    <td  style="font-size:20px; text-align: center; border-bottom:0px solid ">N.- MOVIMIENTO COMPRAS No: <strong>' . $minv_num_sec . '</strong><br><br></td>
                </tr>            
			</table>

			<table border="0" style="width: 100%; margin-left:50px; margin-top:10px; font-family: Courier;">
				<tr>
					<td   colspan="2" style="width: 100%;font-size:14px; text-align: left"><strong>Fecha:</strong> ' . $minv_fmov . '</td>
				</tr>
				<tr>
					<td   style="width: 100%;font-size:14px; text-align: left"><strong>Moneda:</strong> ' . $moneda . '</td>
				</tr>
				<tr style="display:none">
					<td  style="width: 100%; font-size:14px; text-align: left; display:none"><strong>Monto: </strong>' . number_format(($minv_tot_minv + $minv_iva_valo), 2, '.', ',') . '</td>
				</tr>			
				<tr>
					<td colspan="2" style="width: 100%; font-size:14px; text-align: left"><strong>Detalle:</strong> ' . $minv_cm1_minv . '<br><br></td>
                </tr>				
                <tr>
			<!--	<td colspan="2" style="width: 100%; font-size:14px; text-align: left"><strong>Tecnico:</strong> ' . $minv_ruc_resp . ' - ' . $minv_nomb_resp . '<br><br></td> -->
                </tr>
                <tr>
			<!-- <td colspan="2" style="width: 100%; font-size:14px; text-align: left"><strong>N.- Contrato:</strong> ' . $contrato . '<br><br></td> -->
				</tr>
			</table>';

    //SAEDMOV
    if (count($arrayDmov) > 0) {
        $html .= '
								<table  style="margin-left:50px; width:90%;border:1px solid black; border-radius: 5px; margin-top:10px" align="left; font-family: Courier;">
									<tr>
									<td colspan="9" style="width:100%;font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; "><strong>DETALLE</strong></td>
									</tr>
									<tr>
										<td  style="width:3%; font-size:12px;  text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; "><strong>N</strong></td>
                                        <td  style="width:10%;font-size:12px; text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; "><strong>BODEGA ORIG.</strong></td>
                                        <td  style="width:10%;font-size:12px; text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; "><strong>BODEGA DEST.</strong></td>
										<td  style="width:16%; font-size:12px;  text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; "><strong>CODIGO</strong></td>
										<!-- <td  style="width:8%; font-size:12px;  text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; "><strong>CODIGO BARRAS</strong></td> -->
										<td  style="width:30%;font-size:12px; text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; "><strong>PRODUCTO</strong></td>
                                        <td  style="width:3%;font-size:12px; text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; "><strong>UND</strong></td>
										<td  style="width:8%; font-size:12px;  text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; "><strong>CANT.</strong></td>
										<td  style="width:10%;font-size:12px; text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; "><strong>COSTO U.</strong></td>
										<td  style="width:10%;font-size:12px; text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; "><strong>COSTO TOTAL</strong></td>
									</tr>';

        $i = 1;
        foreach ($arrayDmov as $val) {
            $dmov_cod_prod = $val[0];
            $dmov_cod_bode = $val[1];
            $dmov_bod_envi = $val[2];
            $dmov_cod_ccos = $val[3];
            $dmov_cod_cuen = $val[4];
            $dmov_can_dmov = $val[5];
            $dmov_cun_dmov = $val[6];
            $dmov_cto_dmov = $val[7];
            $dmov_cad_lote = $val[8];
            $dmov_ela_lote = $val[9];
            $dmov_cod_lote = $val[10];
            $dmov_serie_caja = $val[11];
            $dmov_serie_tarj = $val[12];

            if (empty($dmov_bod_envi)) {
                $dmov_bod_envi = $dmov_cod_bode;
            }

            $sql = "select prod_nom_prod from saeprod where prod_cod_empr = $idempresa and prod_cod_sucu = $idsucursal and prod_cod_prod = '$dmov_cod_prod' ";
            $prod_nom = consulta_string_func($sql, 'prod_nom_prod', $oIfx, '');

            $sql = "select bode_nom_bode from saebode where bode_cod_empr = $idempresa and bode_cod_bode = '$dmov_cod_bode' ";
            $bode_nom = consulta_string_func($sql, 'bode_nom_bode', $oIfx, '');

            $sql = "select prod_cod_barra from saeprod where prod_cod_empr = $idempresa and prod_cod_sucu = $idsucursal and prod_cod_prod = '$dmov_cod_prod' ";
            $prod_cod_barra = consulta_string_func($sql, 'prod_cod_barra', $oIfx, '');

            $sql = "select prbo_dis_prod, prbo_cod_unid from saeprbo where prbo_cod_empr = $idempresa and prbo_cod_sucu = $idsucursal and prbo_cod_prod = '$dmov_cod_prod' ";
            $prbo_dis_prod = consulta_string_func($sql, 'prbo_dis_prod', $oIfx, '0');
            $prbo_cod_unidad = consulta_string_func($sql, 'prbo_cod_unid', $oIfx, '0');

            $sql = "select unid_sigl_unid from saeunid where unid_cod_unid = $prbo_cod_unidad and unid_cod_empr=$idempresa";
            $sigla_unidad = consulta_string_func($sql, 'unid_sigl_unid', $oIfx, '');

            $sql = "select bode_nom_bode from saebode where bode_cod_empr = $idempresa and bode_cod_bode = '$dmov_bod_envi' ";
            $bode_dest = consulta_string_func($sql, 'bode_nom_bode', $oIfx, '');
            
            $html .= '<tr>';
            $html .= '<td style="width:3%;font-size:12px;  text-align: right; border-right:0px solid; border-bottom:0px solid; font-family: Courier;  ">' . $i . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:0px solid; border-bottom:0px solid; font-family: Courier; ">' . $bode_nom . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:0px solid; border-bottom:0px solid; font-family: Courier; ">' . $bode_dest . '</td>';
            $html .= '<td style="width:16%;font-size:12px;  text-align: left; border-right:0px solid; border-bottom:0px solid; font-family: Courier;  ">' . $dmov_cod_prod . '</td>';
            //$html .= '<td style="width:8%;font-size:12px;  text-align: left; border-right:1px solid; border-bottom:1px solid; font-family: Courier;  ">' . $prod_cod_barra . '</td>';
            $html .= '<td style="width:30%;font-size:12px; text-align: left; border-right:0px solid; border-bottom:0px solid; font-family: Courier;  ">' . $prod_nom . '</td>';
            $html .= '<td style="width:3%;font-size:12px; text-align: center; border-right:0px solid; border-bottom:0px solid; font-family: Courier;  ">' . $sigla_unidad . ' </td>';
            $html .= '<td style="width:8%;font-size:12px;  text-align: right; border-right:0px solid; border-bottom:0px solid; font-family: Courier; " align="right">' . number_format(($dmov_can_dmov), 2, '.', ',') . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:0px solid; border-bottom:0px solid; font-family: Courier; " align="right">' . number_format(($dmov_cun_dmov), 4, '.', ',') . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:0px solid; border-bottom:0px solid; font-family: Courier; " align="right">' . number_format(($dmov_cto_dmov), 4, '.', ',') . '</td>';
            $html .= '</tr>';
            $total = $total + $dmov_cto_dmov;
            $total_cant = $total_cant + $dmov_can_dmov;

            $i++;
        }
        //echo $empr_nom;
        //exit;
        if ($empr_ruc === '0791725720001')
        {
            $html .= '</table>';
            $html .= '<table  style="margin-left:50px; width:90%;border:0px solid black; border-radius: 0px; margin-top:10px" align="left; font-family: Courier;">';
            $html .= '<tr>';
            $html .= '<td style="width:3%;font-size:12px;  text-align: right; border-right:0px solid; border-bottom:0px solid; font-family: Courier;  "></td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:0px solid; border-bottom:0px solid; font-family: Courier; "></td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:0px solid; border-bottom:0px solid; font-family: Courier; "></td>';
            $html .= '<td style="width:16%;font-size:12px;  text-align: left; border-right:0px solid; border-bottom:0px solid; font-family: Courier;  "></td>';
            //$html .= '<td style="width:8%;font-size:12px;  text-align: left; border-right:0px solid; border-bottom:0px solid; font-family: Courier;  "></td>';
            $html .= '<td style="width:30%;font-size:14px; text-align: right; border-right:0px solid; border-bottom:0px solid; font-family: Courier;  "></td>';
            $html .= '<td style="width:3%;font-size:14px; text-align: right; border-right:0px solid; border-bottom:0px solid; font-family: Courier;  ">TOTALES:</td>';
            $html .= '<td style="width:8%;font-size:14px;  text-align: right; border-right:0px solid; border-bottom:0px solid; font-family: Courier; " align="right">' . $total_cant . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:0px solid; border-bottom:0px solid; font-family: Courier; " align="right"></td>';
            $html .= '<td style="width:10%;font-size:14px; text-align: right; border-right:0px solid; border-bottom:0px solid; font-family: Courier; " align="right">' . number_format(($total), 2, '.', ',') . '</td>';
            $html .= '</tr>';
            $html .= '</table>';
            $html .= '<br><br><br><br><br><br>';
            $html .= '<table  style="margin-left:50px; width:90%;border:0px solid black; border-radius: 5px; margin-top:10px" align="center; ">';
            $html .= '<tr>
                            <td style="font-size:14px; text-align: center;border-top: 1px solid black; width:24%;">Aux. Bodega</td>
                            <td style="font-size:14px; text-align: center;border-top: 1px solid black; width:24%;">Jefe Bodega</td>	
                            <td style="font-size:14px; text-align: center;border-top: 1px solid black; width:24%;">Administracion</td>
                            <td style="font-size:14px; text-align: center;border-top: 1px solid black; width:24%;">Contabilidad</td>	

                        </tr>
                        </table>';
        }
        else
        {
            $html .= '</table>';
            $html .= '<table  style="margin-left:50px; width:90%;border:0px solid black; border-radius: 0px; margin-top:10px" align="left; font-family: Courier;">';
            $html .= '<tr>';
            $html .= '<td style="width:3%;font-size:12px;  text-align: right; border-right:0px solid; border-bottom:0px solid; font-family: Courier;  "></td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:0px solid; border-bottom:0px solid; font-family: Courier; "></td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:0px solid; border-bottom:0px solid; font-family: Courier; "></td>';
            $html .= '<td style="width:16%;font-size:12px;  text-align: left; border-right:0px solid; border-bottom:0px solid; font-family: Courier;  "></td>';
            //$html .= '<td style="width:8%;font-size:12px;  text-align: left; border-right:0px solid; border-bottom:0px solid; font-family: Courier;  "></td>';
            $html .= '<td style="width:30%;font-size:14px; text-align: right; border-right:0px solid; border-bottom:0px solid; font-family: Courier;  "></td>';
            $html .= '<td style="width:3%;font-size:14px; text-align: right; border-right:0px solid; border-bottom:0px solid; font-family: Courier;  ">TOTALES:</td>';
            $html .= '<td style="width:8%;font-size:14px;  text-align: right; border-right:0px solid; border-bottom:0px solid; font-family: Courier; " align="right">' . $total_cant . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:0px solid; border-bottom:0px solid; font-family: Courier; " align="right"></td>';
            $html .= '<td style="width:10%;font-size:14px; text-align: right; border-right:0px solid; border-bottom:0px solid; font-family: Courier; " align="right">' . number_format(($total), 2, '.', ',') . '</td>';
            $html .= '</tr>';
            $html .= '</table>';
            $html .= '<br><br><br><br><br><br>';
            $html .= '<table  style="margin-left:50px; width:90%;border:0px solid black; border-radius: 5px; margin-top:10px" align="center; ">';
            $html .= '<tr>
                            <td style="font-size:14px; text-align: center;border-top: 1px solid black; width:24%;">Autorizado por:</td>
                            <td style="font-size:14px; text-align: center;border-top: 1px solid black; width:24%;">Recibido por:</td>	
                            <td style="font-size:14px; text-align: center;border-top: 1px solid black; width:24%;">Revisado por:</td>
                            <td style="font-size:14px; text-align: center;border-top: 1px solid black; width:24%;">Contabilidad:</td>	

                        </tr>
                        </table>';
        }
    }


    $documento = '<page backimgw="95%" backtop="5mm" backbottom="5mm" backleft="10mm" backright="10mm" footer="date;heure;page">';
    $documento .= $html;
    $documento .= '</page>';


    return $documento;

}


//IMPRIME RETENCIONES PRE-IMPRESAS--
function reporte_retencionGastoPre($id = '', $nombre_archivo = '', &$rutaPdf = '', $clpv = 0, $num_fact = '', $ejer = 0, $asto = '', $fec_emis = '', $idSucursal)
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    //$idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_sn_conta, empr_nom_empr, empr_ruc_empr , empr_dir_empr, 
            empr_conta_sn, empr_num_resu, empr_path_logo,
            empr_tip_empr
            from saeempr 
            where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_tip_empr = $oIfx->f('empr_tip_empr');
            $empr_sn_conta = $oIfx->f('empr_sn_conta');
        }
    }
    $oIfx->Free();

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis  from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
        }
    }
    $oIfx->Free();

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }


    $logo .= '<table style="width: 100%; margin: 0px;">';
    $logo .= '<tr>';
    $logo .= '<b><td align="center" style="width: 60%; border:1px solid black; border-radius: 5px; margin: 0px;">';
    $logo .= '<table align="center" style="margin: 0px;">';
    $logo .= '<tr><td style="margin-top: 0px;"><img width="200px;" height="150px;" src="' . $empr_path_logo . '"></td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 20px;">' . $razonSocial . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 16px;">RUC : ' . $ruc_empr . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';

    //selecciona sucursales y direcciones
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa";
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                $logo .= '<tr><td align="center" style="font-size: 13px">' . $sucu_nom_sucu . ': ' . htmlentities($sucu_dir_sucu) . '</td></tr>';
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $logo .= '<tr><td>&nbsp;</td></tr>';

    if ($empr_tip_empr == 'S') {
        $logo .= '<tr><td align="center" style="font-size: 12px;">Contribuyente Especial #:' . $empr_num_resu . '</td></tr>';
    }//fin if
    if($empr_conta_sn=='SI'){
        if($empr_sn_conta=='S'){
            $empr_sn_conta ='SI';
        }
        else{
            $empr_sn_conta ='NO';
        }
        $logo .= '<tr><td align="center" style="font-size: 12px;">Obligado a llevar Contabilidad :' . $empr_sn_conta . '</td></tr>';
    }
    $logo .= ' </table>';
    $logo .= '</td></b>';

    $sqlRet = "select * from saefprv  where
                    fprv_cod_empr = $idEmpresa and 
                    fprv_cod_sucu = $idSucursal  and 
                    fprv_cod_clpv = $clpv and 
                    fprv_num_fact = '$num_fact' and 
                    fprv_cod_ejer = '$ejer' and  
                    fprv_cod_asto = '$asto' and  
                    fprv_fec_emis = '$fec_emis' ";

    if ($oIfx->Query($sqlRet)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $fprv_num_fact = $oIfx->f('fprv_num_fact');
                $fprv_fec_emis = fecha_mysql_func($oIfx->f('fprv_fec_emis'));
                $fprv_cod_rtf1 = $oIfx->f('fprv_cod_rtf1');
                $fprv_cod_rtf2 = $oIfx->f('fprv_cod_rtf2');
                $fprv_cod_riva1 = $oIfx->f('fprv_cod_riva1');
                $fprv_cod_riva2 = $oIfx->f('fprv_cod_riva2');
                $fprv_por_ret1 = $oIfx->f('fprv_por_ret1');
                $fprv_por_ret2 = $oIfx->f('fprv_por_ret2');
                $fprv_val_ret1 = $oIfx->f('fprv_val_ret1');
                $fprv_val_ret2 = $oIfx->f('fprv_val_ret2');
                $fprv_por_iva1 = $oIfx->f('fprv_por_iva1');
                $fprv_por_iva2 = $oIfx->f('fprv_por_iva2');
                $fprv_val_iva1 = $oIfx->f('fprv_val_iva1');
                $fprv_val_iva2 = $oIfx->f('fprv_val_iva2');
                $fprv_num_seri = $oIfx->f('fprv_num_seri');
                $fprv_num_rete = $oIfx->f('fprv_num_rete');
                $fprv_val_bas1 = $oIfx->f('fprv_val_bas1');
                $fprv_val_bas2 = $oIfx->f('fprv_val_bas2');
                $fprv_val_bas3 = $oIfx->f('fprv_val_bas3');
                $fprv_val_bas4 = $oIfx->f('fprv_val_bas4');
                $fprv_ruc_prov = $oIfx->f('fprv_ruc_prov');
                $fprv_ser_rete = $oIfx->f('fprv_ser_rete');
                $fprv_auto_sri = $oIfx->f('fprv_auto_sri');
                $fprv_fech_sri = $oIfx->f('fprv_fech_sri');
                $fprv_email_clpv = $oIfx->f('fprv_email_clpv');
                $fprv_clav_sri = $oIfx->f('fprv_clav_sri');
                $fprv_nom_clpv = $oIfx->f('fprv_nom_clpv');
                $fprv_dir_clpv = $oIfx->f('fprv_dir_clpv');
                $fprv_tel_clpv = $oIfx->f('fprv_tel_clpv');
                $fprv_cod_clpv = $oIfx->f('fprv_cod_clpv');
                $fprv_cod_tran = $oIfx->f('fprv_cod_tran');

                //ruc si no existe
                if (empty($fprv_ruc_prov)) {
                    $sql_ruc = "select clpv_ruc_clpv from saeclpv where clpv_cod_clpv = $clpv and clpv_cod_empr = $idEmpresa ";
                    $fprv_ruc_prov = consulta_string_func($sql_ruc, 'clpv_ruc_clpv', $oIfx2, '');
                }

                //nom si no existe
                if (empty($fprv_nom_clpv)) {
                    $sql_nom = "select clpv_nom_clpv from saeclpv where clpv_cod_clpv = $clpv and clpv_cod_empr = $idEmpresa ";
                    $fprv_nom_clpv = consulta_string_func($sql_nom, 'clpv_nom_clpv', $oIfx2, '');
                }

                // direccion
                if (empty($fprv_dir_clpv)) {
                    $sql = "select min( dire_dir_dire ) as dire  from saedire where
                            dire_cod_empr = $idEmpresa and
                            dire_cod_clpv = $clpv ";
                    $fprv_dir_clpv = consulta_string_func($sql, 'dire', $oIfx2, '');
                }

                // telefono
                if (empty($fprv_tel_clpv)) {
                    $sql = "select min( tlcp_tlf_tlcp ) as telf  from saetlcp where
                            tlcp_cod_empr = $idEmpresa and
                            tlcp_cod_clpv = $clpv ";
                    $fprv_tel_clpv = consulta_string_func($sql, 'telf', $oIfx2, '');
                }

                // email
                if (empty($fprv_email_clpv)) {
                    $sql = "select min( emai_ema_emai ) as ema  from saeemai where
                            emai_cod_empr = $idEmpresa and
                            emai_cod_clpv = $clpv";
                    $fprv_email_clpv = consulta_string_func($sql, 'ema', $oIfx2, '');
                }

                //TIPO DE COMPROBANTE
                $sql_tran = "select tr.tran_cod_tran,
                                    t.tcmp_des_tcmp from
                                     saetcmp t, saetran tr
                                    where 
                                    tr.trans_tip_comp = t.tcmp_cod_tcmp and
                                    tr.tran_cod_tran = '$fprv_cod_tran' AND
                                    tr.tran_cod_empr = $idEmpresa and
                                    tr.tran_cod_sucu = $idSucursal and
                                    tr.tran_cod_modu = 4";
                $tip_comp = consulta_string_func($sql_tran, 'tcmp_des_tcmp', $oIfx2, 0);
                //$tip_comp = substr($tip_comp, 0, 50);

                $logo .= '<b><td style="width: 40%; border: 1px solid black; border-radius: 5px;" align="center">';
                $logo .= ' <table align="center" style="font-size: 15px;">';
                $logo .= ' <tr>';
                $logo .= '<td style="border-bottom: 1px inset black;">COMPROBANTE DE RETENCION</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>SERIE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . substr($fprv_ser_rete, 0, 3) . '-' . substr($fprv_ser_rete, 3, 6) . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="font-size: 17px; color: red; border-bottom: 1;">' . $fprv_num_rete . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fprv_auto_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1" >FECHA AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fprv_fech_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1" >AMBIENTE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $ambiente_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td style="border-top:1" >EMISION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $emision_sri . '</td>';
                $logo .= ' </tr>';

                if ($fprv_clav_sri != '') {
                    $nombArch = $fprv_ser_rete . $fprv_num_rete;
                    $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';

                    new barCodeGenrator($fprv_clav_sri, 1, $rutaCodi, 450, 100, true);


                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="right" style="font-size: 12px;">CLAVE DE ACCESO:</td>';
                    $logo .= '</tr>';
                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="right"> <img width="350px;" src="' . $rutaCodi . '"/></td>';
                    $logo .= '</tr>';
                }

                $logo .= ' </table>';
                $logo .= '</td></b>';
                $logo .= '</tr>';
                $logo .= '</table>';
                $logo .= ' <br>';
                setlocale(LC_ALL, "es_ES@euro", "es_ES", "esp");

                $arry_fech = explode('/', $fprv_fec_emis);
                $fprv_fec_emis = $arry_fech[2] . '/' . $arry_fech[1] . '/' . $arry_fech[0];
                $fprv_fec_emis = strftime("%d de %B de %Y", strtotime($fprv_fec_emis));
                $cliente .= ' <table border="0" style="width: 100%; margin-top:172px; margin-left:73px">';
                $cliente .= ' <tr>';
                $cliente .= ' <td style="width: 55%; font-size:12px; " height="20">&nbsp;&nbsp;&nbsp;' . htmlentities($fprv_nom_clpv) . '</td>';
                $cliente .= ' <td align=left style="width: 22%;font-size:12px; " height="20">&nbsp;&nbsp;' . $fprv_fec_emis . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <td style="width: 55%; font-size:12px;" height="20">&nbsp;&nbsp;' . $fprv_ruc_prov . '</td>';
                $cliente .= ' <td style="width: 22%; font-size:12px;" height="20" >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' . $tip_comp . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <td style="width: 55%; font-size:12px;" height="20">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' . htmlentities(substr($fprv_dir_clpv, 0, 40)) . '</td>';
                $cliente .= ' <td style="width: 22%; font-size:12px;" height="20"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' . substr($fprv_num_seri, 0, 3) . '-' . substr($fprv_num_seri, 3, 6) . '-' . $fprv_num_fact . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' </table>';
                $cliente .= ' <br>';
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    $deta .= ' <br><br><br><table border="0" align="center" style="width: 100%;  margin-left: 12px">';
    /*  $deta .= ' <tr>';
    $deta .= ' <b> <td align=center style="width: 15%;  border: 1px inset black;">COMPROBANTE</td> </b>';
    $deta .= ' <b> <td align=center style="width: 25%;  border: 1px inset black;">NUMERO</td> </b>';
    $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">FECHA EMISION</td> </b>';
    $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">BASE IMPONIBLE</td> </b>';
    $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">IMPUESTO</td> </b>';
    $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">CODIGO</td> </b>';
    $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">PORCENTAJE</td> </b>';
    $deta .= ' <b> <td align=center style="width: 10%;  border: 1px inset black;">VALOR</td> </b>';
    $deta .= ' </tr>';
    $deta .= ' <tr><td style="border-left:1; border-right:1; height:20px" colspan=8></td></tr>';
*/
    $cont_linas = 1;
    if ($fprv_val_ret1 > 0 || $fprv_cod_rtf1 != '') {
        $deta .= ' <tr>';
        //  $deta .= ' <td align=center style="width: 15%; border-left:1; "></td>';
        //  $deta .= ' <td align=center style="width: 25%; "></td>';
        $deta .= ' <td align=center style="width: 10%; font-size:12px; ">' . $arry_fech[2] . '</td>';
        $deta .= ' <td align=center style="width: 10%; font-size:12px;">' . number_format($fprv_val_bas1, 2, '.', '') . '</td>';
        $deta .= ' <td align=center style="width: 1%; font-size:12px;"></td>';
        $deta .= ' <td align=center style="width: 10%; font-size:12px;">RENTA</td>';
        $deta .= ' <td align=center style="width: 10%; font-size:12px;">' . $fprv_cod_rtf1 . '</td>';
        $deta .= ' <td align=left style="width: 10%; font-size:12px;">' . $fprv_por_ret1 . ' %' . '</td>';
        $deta .= ' <td align=left style="width: 10%; font-size:12px;">' . number_format($fprv_val_ret1, 2, '.', '') . '</td>';
        $deta .= ' </tr>';
        $total += $fprv_val_ret1;

    }

    if ($fprv_val_ret2 > 0 || $fprv_cod_rtf2 != '') {
        $deta .= ' <tr>';
        //  $deta .= ' <td align=center style="width: 15%; border-left:1; "></td>';
        // $deta .= ' <td align=center style="width: 25%; "></td>';
        $deta .= ' <td align=center style="width: 10%; font-size:12px;">' . $arry_fech[2] . '</td>';
        $deta .= ' <td align=center style="width: 10%; font-size:12px;">' . number_format($fprv_val_bas2, 2, '.', '') . '</td>';
        $deta .= ' <td align=center style="width: 1%; font-size:12px;"></td>';
        $deta .= ' <td align=center style="width: 10%; font-size:12px;">RENTA</td>';
        $deta .= ' <td align=center style="width: 10%; font-size:12px;">' . $fprv_cod_rtf2 . '</td>';
        $deta .= ' <td align=left style="width: 10%; font-size:12px;">' . $fprv_por_ret2 . ' %' . '</td>';
        $deta .= ' <td align=left style="width: 10%; font-size:12px; ">' . number_format($fprv_val_ret2, 2, '.', '') . '</td>';
        $deta .= ' </tr>';
        $total += $fprv_val_ret2;
        $cont_linas++;
    }

    if ($fprv_val_iva1 > 0 || $fprv_cod_riva1 != '') {
        $deta .= ' <tr>';
        // $deta .= ' <td align=center style="width: 15%; border-left:1; "></td>';
        // $deta .= ' <td align=center style="width: 25%; "></td>';
        $deta .= ' <td align=center style="width: 10%; font-size:12px;">' . $arry_fech[2] . '</td>';
        $deta .= ' <td align=center style="width: 10%; font-size:12px;">' . number_format($fprv_val_bas3, 2, '.', '') . '</td>';
        $deta .= ' <td align=center style="width: 1%; font-size:12px;"></td>';
        $deta .= ' <td align=center style="width: 10%; font-size:12px;">IVA</td>';
        $deta .= ' <td align=center style="width: 10%; font-size:12px;">' . $fprv_cod_riva1 . '</td>';
        $deta .= ' <td align=left style="width: 10%;font-size:12px; ">' . $fprv_por_iva1 . ' %' . '</td>';
        $deta .= ' <td align=left style="width: 10%; font-size:12px;">' . number_format($fprv_val_iva1, 2, '.', '') . '</td>';
        $deta .= ' </tr>';
        $total += $fprv_val_iva1;
        $cont_linas++;
    }

    if ($fprv_val_iva2 > 0 || $fprv_cod_riva2 != '') {
        $deta .= ' <tr>';
        // $deta .= ' <td align=center style="width: 15%; border-left:1;"></td>';
        // $deta .= ' <td align=center style="width: 25%; "></td>';
        $deta .= ' <td align=center style="width: 10%; font-size:12px;">' . $arry_fech[2] . '</td>';
        $deta .= ' <td align=center style="width: 10%; font-size:12px;">' . number_format($fprv_val_bas4, 2, '.', '') . '</td>';
        $deta .= ' <td align=center style="width: 1%;  font-size:12px; "></td>';
        $deta .= ' <td align=center style="width: 10%; font-size:12px;  ">IVA</td>';
        $deta .= ' <td align=center style="width: 10%; font-size:12px;">' . $fprv_cod_riva2 . '</td>';
        $deta .= ' <td align=left style="width: 10%; font-size:12px;">' . $fprv_por_iva2 . ' %' . '</td>';
        $deta .= ' <td align=left style="width: 10%; font-size:12px;">' . number_format($fprv_val_iva2, 2, '.', '') . '</td>';
        $deta .= ' </tr>';
        $total += $fprv_val_iva2;
        $cont_linas++;
    }
    for ($i = 0; $cont_linas <= 8; $cont_linas++) {
        $deta .= ' <tr><td style="height:15px" colspan=8></td></tr>';
    }

    //

    $deta .= ' <tr>';
    //$deta .= ' <td style="border-top:1"></td>';
    // $deta .= ' <td style="border-top:1"></td>';
    $deta .= ' <td ></td>';
    $deta .= ' <td></td>';
    $deta .= ' <td ></td>';
    $deta .= ' <td ></td>';
    $deta .= ' <td ></td>';
    $deta .= ' <b><td align=right ></td></b>';
    $deta .= ' <b><td style="font-size:14px;" align=left >' . number_format($total, 2, '.', '') . '</td></b>';
    $deta .= ' </tr>';
    $deta .= ' </table>';

    $total = number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_fle_fact + $fact_otr_fact + $fact_fin_fact - $totalDescuento, 2, '.', '');
    $V = new EnLetras();
    $con_letra = strtoupper($V->ValorEnLetras($total, 'dolar'));

    /* $totales .= '<table style="width: 100%;">';
      $totales .= '<tr>';
      $totales .= '<td>TOTAL :  </td>';
      $totales .= '<td>' . $con_letra . '</td>';
      $totales .= '</tr>';
      $totales .= '</table>'; */

    $legend = '<page_footer>
        <table align="center" style="width: 80%">
            <tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">Este comprobante electronico ha sido generado a traves de Sisconti S.A. - Facturacion Electronica</td>
            </tr>
			<tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">www.sisconti.com.ec</td>
            </tr>
        </table>
    </page_footer>';

    $documento .= '<page backimgw="70%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
    $documento .= $cliente . $deta;
    //$documento .= $legend;
    $documento .= '</page>';

    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;


    //eliminaArchivos(DIR_FACTELEC . 'Include/archivos/');

    return $documento;
}

//IMPRIME RETENCIONES PRE-IMPRESAS//
function reporte_retencionInventarioPre($id = '', $nombre_archivo = '', &$rutaPdf = '', $clpv = 0, $num_fact = '', $ejer = 0, $asto = '', $fec_emis = '', $idSucursal)
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    //$idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_sn_conta, empr_nom_empr, empr_ruc_empr , empr_dir_empr, 
            empr_conta_sn, empr_num_resu, empr_path_logo,
            empr_tip_empr
            from saeempr 
            where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_tip_empr = $oIfx->f('empr_tip_empr');
        }
    }
    $oIfx->Free();

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis  from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
        }
    }
    $oIfx->Free();

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }


    $logo .= '<table style="width: 100%; margin: 0px;">';
    $logo .= '<tr>';
    $logo .= '<b><td align="center" style="width: 60%; border:1px solid black; border-radius: 5px; margin: 0px;">';
    $logo .= '<table align="center" style="margin: 0px;">';
    $logo .= '<tr><td style="margin-top: 0px;"><img width="200px;" height="150px;" src="' . $empr_path_logo . '"></td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 20px;">' . $razonSocial . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 16px;">RUC : ' . $ruc_empr . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';

    //selecciona sucursales y direcciones
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa";
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                $logo .= '<tr><td align="center" style="font-size: 13px">' . $sucu_nom_sucu . ': ' . htmlentities($sucu_dir_sucu) . '</td></tr>';
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $logo .= '<tr><td>&nbsp;</td></tr>';

    if ($empr_tip_empr == 'S') {
        $logo .= '<tr><td align="center" style="font-size: 12px;">Contribuyente Especial #:' . $empr_num_resu . '</td></tr>';
    }//fin if
    if($empr_conta_sn=='SI'){
        if($empr_sn_conta=='S'){
            $empr_sn_conta ='SI';
        }
        else{
            $empr_sn_conta ='NO';
        }
        $logo .= '<tr><td align="center" style="font-size: 12px;">Obligado a llevar Contabilidad :' . $empr_sn_conta . '</td></tr>';
    }
    $logo .= ' </table>';
    $logo .= '</td></b>';

    /*$sqlRet = "select * from saefprv  where
                    fprv_cod_empr = $idEmpresa and
                    fprv_cod_sucu = $idSucursal  and
                    fprv_cod_clpv = $clpv and
                    fprv_num_fact = '$num_fact' and
                    fprv_cod_ejer = '$ejer' and
                    fprv_cod_asto = '$asto' and
                    fprv_fec_emis = '$fec_emis' "; */

    $sqlRet = "select * from saeminv where
						minv_cod_empr = $idEmpresa and
						minv_cod_sucu = $idSucursal and
						minv_cod_clpv = $clpv and
						minv_fac_prov = '$num_fact' and
						minv_cod_ejer = $ejer and
						minv_tran_minv= '$asto' ";
    if ($oIfx->Query($sqlRet)) {
        if ($oIfx->NumFilas() > 0) {
            //do {
            $fprv_num_fact = $oIfx->f('minv_fac_prov');
            $fprv_fec_emis = fecha_mysql_func($oIfx->f('minv_fmov'));
            $fprv_ruc_prov = '';
            $fprv_ser_rete = $oIfx->f('fprv_ser_rete');
            $fprv_auto_sri = $oIfx->f('minv_auto_sri');
            $fprv_fech_sri = $oIfx->f('minv_fech_sri');
            $fprv_email_clpv = $oIfx->f('minv_email_clpv');
            $fprv_clav_sri = $oIfx->f('minv_clav_sri');
            $fprv_nom_clpv = $oIfx->f('fprv_nom_clpv');
            $fprv_dir_clpv = $oIfx->f('fprv_dir_clpv');
            $fprv_tel_clpv = $oIfx->f('fprv_tel_clpv');
            $fprv_cod_clpv = $oIfx->f('minv_cod_clpv');
            $fprv_cod_tran = $oIfx->f('minv_cod_tran');
            $minv_cod_ejer = $oIfx->f('minv_cod_ejer');
            $minv_num_prdo = $oIfx->f('minv_num_prdo');
            $minv_tran_minv = $oIfx->f('minv_tran_minv');
            $fprv_num_seri = $oIfx->f('minv_ser_docu');

            $sql = "select * from saeret where
							asto_cod_empr = $idEmpresa and
							asto_cod_sucu = $idSucursal and
							rete_cod_asto = '$minv_tran_minv' and
							asto_cod_ejer = $minv_cod_ejer and
							asto_num_prdo = $minv_num_prdo and
							ret_num_fact = '$fprv_num_fact' ";
            $fprv_num_rete = consulta_string_func($sql, 'ret_ser_ret', $oIfx2, '');
            $fprv_ser_rete = consulta_string_func($sql, 'ret_num_ret', $oIfx2, '');


            //ruc si no existe
            if (empty($fprv_ruc_prov)) {
                $sql_ruc = "select clpv_ruc_clpv from saeclpv where clpv_cod_clpv = $clpv and clpv_cod_empr = $idEmpresa ";
                $fprv_ruc_prov = consulta_string_func($sql_ruc, 'clpv_ruc_clpv', $oIfx2, '');
            }

            //nom si no existe
            if (empty($fprv_nom_clpv)) {
                $sql_nom = "select clpv_nom_clpv from saeclpv where clpv_cod_clpv = $clpv and clpv_cod_empr = $idEmpresa ";
                $fprv_nom_clpv = consulta_string_func($sql_nom, 'clpv_nom_clpv', $oIfx2, '');
            }

            // direccion
            if (empty($fprv_dir_clpv)) {
                $sql = "select min( dire_dir_dire ) as dire  from saedire where
                            dire_cod_empr = $idEmpresa and
                            dire_cod_clpv = $clpv ";
                $fprv_dir_clpv = consulta_string_func($sql, 'dire', $oIfx2, '');
            }

            // telefono
            if (empty($fprv_tel_clpv)) {
                $sql = "select min( tlcp_tlf_tlcp ) as telf  from saetlcp where
                            tlcp_cod_empr = $idEmpresa and
                            tlcp_cod_clpv = $clpv ";
                $fprv_tel_clpv = consulta_string_func($sql, 'telf', $oIfx2, '');
            }

            // email
            if (empty($fprv_email_clpv)) {
                $sql = "select min( emai_ema_emai ) as ema  from saeemai where
                            emai_cod_empr = $idEmpresa and
                            emai_cod_clpv = $clpv";
                $fprv_email_clpv = consulta_string_func($sql, 'ema', $oIfx2, '');
            }

            //TIPO DE COMPROBANTE
            $sql_tran = "select d.defi_cod_tran, t.tcmp_des_tcmp from saedefi d, saetcmp t where
									d.defi_tip_comp = t.tcmp_cod_tcmp and
									d.defi_cod_empr = $idEmpresa and
									d.defi_cod_sucu = $idSucursal and
									d.defi_cod_tran = '$fprv_cod_tran'";
            $tip_comp = consulta_string_func($sql_tran, 'tcmp_des_tcmp', $oIfx2, 0);
            //$tip_comp = substr($tip_comp, 0, 50);

            $logo .= '<b><td style="width: 40%; border: 1px solid black; border-radius: 5px;" align="center">';
            $logo .= ' <table align="center" style="font-size: 15px;">';
            $logo .= ' <tr>';
            $logo .= '<td style="border-bottom: 1px inset black;">COMPROBANTE DE RETENCION</td>';
            $logo .= ' </tr>';
            $logo .= ' <tr>';
            $logo .= '<td>SERIE:</td>';
            $logo .= ' </tr>';
            $logo .= ' <tr>';
            $logo .= '<td>' . substr($fprv_ser_rete, 0, 3) . '-' . substr($fprv_ser_rete, 3, 6) . '</td>';
            $logo .= ' </tr>';
            $logo .= ' <tr>';
            $logo .= '<td style="font-size: 17px; color: red; border-bottom: 1;">' . $fprv_num_rete . '</td>';
            $logo .= ' </tr>';
            $logo .= ' <tr>';
            $logo .= '<td>AUTORIZACION:</td>';
            $logo .= ' </tr>';
            $logo .= ' <tr>';
            $logo .= '<td>' . $fprv_auto_sri . '</td>';
            $logo .= ' </tr>';
            $logo .= ' <tr>';
            $logo .= '<td style="border-top:1" >FECHA AUTORIZACION:</td>';
            $logo .= ' </tr>';
            $logo .= ' <tr>';
            $logo .= '<td>' . $fprv_fech_sri . '</td>';
            $logo .= ' </tr>';
            $logo .= ' <tr>';
            $logo .= '<td style="border-top:1" >AMBIENTE:</td>';
            $logo .= ' </tr>';
            $logo .= ' <tr>';
            $logo .= ' <td>' . $ambiente_sri . '</td>';
            $logo .= ' </tr>';
            $logo .= ' <tr>';
            $logo .= ' <td style="border-top:1" >EMISION:</td>';
            $logo .= ' </tr>';
            $logo .= ' <tr>';
            $logo .= ' <td>' . $emision_sri . '</td>';
            $logo .= ' </tr>';

            if ($fprv_clav_sri != '') {
                $nombArch = $fprv_ser_rete . $fprv_num_rete;
                $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';

                new barCodeGenrator($fprv_clav_sri, 1, $rutaCodi, 450, 100, true);


                $logo .= '<tr>';
                $logo .= '<td colspan=2 align="right" style="font-size: 12px;">CLAVE DE ACCESO:</td>';
                $logo .= '</tr>';
                $logo .= '<tr>';
                $logo .= '<td colspan=2 align="right"> <img width="350px;" src="' . $rutaCodi . '"/></td>';
                $logo .= '</tr>';
            }

            $logo .= ' </table>';
            $logo .= '</td></b>';
            $logo .= '</tr>';
            $logo .= '</table>';
            $logo .= ' <br>';
            setlocale(LC_ALL, "es_ES@euro", "es_ES", "esp");

            $arry_fech = explode('/', $fprv_fec_emis);
            $fprv_fec_emis = $arry_fech[2] . '/' . $arry_fech[1] . '/' . $arry_fech[0];
            $fprv_fec_emis = strftime("%d de %B de %Y", strtotime($fprv_fec_emis));
            $cliente .= ' <table  border="1" style="width: 100%; margin-top:115px; margin-left:73px">';
            $cliente .= ' <tr>';
            $cliente .= ' <td style="width: 55%; font-size:12px; " height="20">&nbsp;&nbsp;&nbsp;' . htmlentities($fprv_nom_clpv) . '</td>';
            $cliente .= ' <td style="width: 22%;font-size:12px; " height="20">&nbsp;&nbsp;' . $fprv_fec_emis . '</td>';
            $cliente .= ' </tr>';

            $cliente .= ' <tr>';
            $cliente .= ' <td style="width: 55%; font-size:12px;" height="20">&nbsp;&nbsp;' . $fprv_ruc_prov . '</td>';
            $cliente .= ' <td style="width: 22%; font-size:12px;" height="20" >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' . $tip_comp . '</td>';
            $cliente .= ' </tr>';

            $cliente .= ' <tr>';
            $cliente .= ' <td style="width: 55%; font-size:12px;" height="20">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' . htmlentities(substr($fprv_dir_clpv, 0, 40)) . '</td>';
            $cliente .= ' <td style="width: 22%; font-size:12px;" height="20"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' . substr($fprv_num_seri, 0, 3) . '-' . substr($fprv_num_seri, 3, 6) . '-' . $fprv_num_fact . '</td>';
            $cliente .= ' </tr>';

            $cliente .= ' </table>';
            $cliente .= ' <br>';
            // } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    $deta .= ' <br><br><br><table align="center" style="width: 100%;  margin-left: 25px">';

    $cont_linas = 1;
    $sql = "select * from saeret where
						asto_cod_empr = $idEmpresa and
						asto_cod_sucu = $idSucursal and
						rete_cod_asto = '$asto' and
						asto_cod_ejer = $ejer and
						asto_num_prdo = '$minv_num_prdo' and
						ret_num_fact = '$num_fact' ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $ret_cta_ret = $oIfx->f('ret_cta_ret');
                $ret_porc_ret = $oIfx->f('ret_porc_ret');
                $ret_bas_imp = $oIfx->f('ret_bas_imp');
                $ret_valor = $oIfx->f('ret_valor');
                $ret_num_ret = $oIfx->f('ret_num_ret');
                $ret_nom_clpv = $oIfx->f('ret_nom_clpv');
                $rete_dire_benf = $oIfx->f('rete_dire_benf');
                $rete_telf_benf = $oIfx->f('rete_telf_benf');
                $rete_ruci_benf = $oIfx->f('rete_ruci_benf');
                $ret_num_fact = $oIfx->f('ret_num_fact');
                $ret_ser_ret = $oIfx->f('ret_ser_ret');
                $ret_email_clpv = $oIfx->f('ret_email_clpv');

                if ($ret_cta_ret == '') {
                    $ret_cta_ret = 0;
                }
                $sql_rete = "select tret_ban_retf from saetret where tret_cod = '$ret_cta_ret' 
									and tret_cod_empr = $idEmpresa ";
                $tipo_rete = consulta_string_func($sql_rete, 'tret_ban_retf', $oIfx2, 0);

                if ($tipo_rete == 'RI') {
                    $tipo_rete = 'IVA';
                } elseif ($tipo_rete == 'IR') {
                    $tipo_rete = 'RENTA';
                }

                $deta .= ' <tr>';
                $deta .= ' <td align=center style="width: 10%; font-size:12px; ">' . $arry_fech[2] . '</td>';
                $deta .= ' <td align=center style="width: 10%; font-size:12px;">' . number_format($ret_bas_imp, 2, '.', '') . '</td>';
                $deta .= ' <td align=center style="width: 8%; font-size:12px;"></td>';
                $deta .= ' <td align=center style="width: 10%; font-size:12px;">' . $tipo_rete . '</td>';
                $deta .= ' <td align=center style="width: 10%; font-size:12px;">' . $ret_cta_ret . '</td>';
                $deta .= ' <td align=center style="width: 10%; font-size:12px;">' . $ret_porc_ret . ' %' . '</td>';
                $deta .= ' <td align=center style="width: 10%; font-size:12px;">' . number_format($ret_valor, 2, '.', '') . '</td>';
                $deta .= ' </tr>';

                $total += $ret_valor;
                $cont_linas++;

            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    for ($i = 0; $cont_linas <= 8; $cont_linas++) {
        $deta .= ' <tr><td style="height:20px" colspan=8></td></tr>';
    }

    $deta .= ' <tr>';
    $deta .= ' <td ></td>';
    $deta .= ' <td></td>';
    $deta .= ' <td ></td>';
    $deta .= ' <td ></td>';
    $deta .= ' <td ></td>';
    $deta .= ' <b><td align=right ></td></b>';
    $deta .= ' <b><td style="font-size:14px;" align=center >' . number_format($total, 2, '.', '') . '</td></b>';
    $deta .= ' </tr>';
    $deta .= ' </table>';

    $legend = '<page_footer>
        <table align="center" style="width: 80%">
            <tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">Este comprobante electronico ha sido generado a traves de Sisconti S.A. - Facturacion Electronica</td>
            </tr>
			<tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">www.sisconti.com.ec</td>
            </tr>
        </table>
    </page_footer>';

    $documento .= '<page backimgw="70%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
    $documento .= $cliente . $deta;
    //$documento .= $legend;
    $documento .= '</page>';

    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;


    //eliminaArchivos(DIR_FACTELEC . 'Include/archivos/');

    return $documento;
}

// LIQUIDACION DE COMPRAS
function generar_liqCompras_pdf($idempresa = "", $idsucursal = "", $asto_cod = "", $ejer_cod = "", $prdo_cod = "")
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    //
    $sql = "SELECT saeasto.asto_num_mayo,
			( fprv_val_gra0  +  fprv_val_gr0s ) as bim_tar0 ,			
			saeasto.asto_det_asto,   
			saeasto.asto_fec_asto,   
			saeasto.asto_cod_asto,
			saeusua.usua_nom_usua,
			saeclpv.clpv_nom_clpv,
			saeclpv.clpv_ruc_clpv,
			saedire.dire_dir_dire,
			(fprv_val_grab + fprv_val_grbs) as bas_imgr,
			saefprv.fprv_val_viva,
			saedir.dir_cod_cli,
			( SELECT saeciud.ciud_nom_ciud  
				FROM saeciud, saeempr  
				WHERE ( saeempr.empr_cod_ciud = saeciud.ciud_cod_ciud ) and  
					  ( saeempr.empr_cod_empr = saeasto.asto_cod_empr )) AS ciudad  
		FROM saeasto, saeusua, saedir, saeclpv, saefprv, saedire
		WHERE ( saeusua.usua_cod_usua = saeasto.asto_cod_usua ) and  
			( saedir.dire_cod_asto = saeasto.asto_cod_asto ) and	
			( saedir.dire_cod_empr = saeasto.asto_cod_empr ) and
			( saedir.dire_cod_sucu = saeasto.asto_cod_sucu ) and
			( saedir.asto_cod_ejer = saeasto.asto_cod_ejer ) and
			( saeclpv.clpv_cod_clpv = saedir.dir_cod_cli ) and
			( saeclpv.clpv_cod_empr = saedir.dire_cod_empr ) and
			( saedire.dire_cod_clpv = saeclpv.clpv_cod_clpv ) and
			( saedire.dire_cod_empr = saeclpv.clpv_cod_empr ) and
			( saefprv.fprv_cod_asto = saeasto.asto_cod_asto ) and	
			( saefprv.fprv_cod_sucu = saeasto.asto_cod_sucu ) and
			saefprv.fprv_cod_empr = saeasto.asto_cod_empr and
			saefprv.fprv_cod_ejer = saeasto.asto_cod_ejer and
			(( saeasto.asto_cod_asto = '$asto_cod'  ) AND  
			( saeasto.asto_cod_empr = $idEmpresa  ) AND  
			( saeasto.asto_cod_sucu = $idsucursal ) AND  
			( saeasto.asto_cod_ejer = $ejer_cod  ) AND  
			( saeasto.asto_tipo_mov = 'DI' )) ";

    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            unset($arrayLiq);
            do {
                $arrayLiq[] = array($oIfx->f('asto_num_mayo'), $oIfx->f('bim_tar0')
                , $oIfx->f('asto_det_asto'), $oIfx->f('asto_fec_asto')
                , $oIfx->f('asto_cod_asto'), $oIfx->f('usua_nom_usua')
                , $oIfx->f('clpv_nom_clpv'), $oIfx->f('clpv_ruc_clpv')
                , $oIfx->f('dire_dir_dire'), $oIfx->f('bas_imgr')
                , $oIfx->f('fprv_val_viva'), $oIfx->f('dir_cod_cli')
                , $oIfx->f('ciudad'));
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free($arrayLiq);
    // var_dump($arrayLiq); exit;
    foreach ($arrayLiq as $val) {
        $asto_num_mayo = $val[0];
        $bim_tar0 = $val[1];
        $asto_det_asto = $val[2];
        $asto_fec_asto = $val[3];
        $asto_cod_asto = $val[4];
        $usua_nom_usua = $val[5];
        $clpv_nom_clpv = $val[6];
        $clpv_ruc_clpv = $val[7];
        $dire_dir_dire = $val[8];
        $bas_imgr = $val[9];
        $fprv_val_viva = $val[10];
        $dir_cod_cli = $val[11];
        $ciudad = $val[12];


    }

    $sql = "select empr_ruc_empr, empr_dir_empr, empr_nom_empr, empr_path_logo from saeempr where empr_cod_empr = $idempresa ";
    if ($oIfx->Query($sql)) {
        $empr_ruc = $oIfx->f('empr_ruc_empr');
        $empr_dir = $oIfx->f('empr_dir_empr');
        $empr_nom = $oIfx->f('empr_nom_empr');
        $empr_path_logo = $oIfx->f('empr_path_logo');
        $empr_nom .= ' ';
    }
    $sql = "SELECT sucu_nom_sucu FROM saesucu WHERE sucu_cod_sucu='$idsucursal'";
    if ($oIfx->Query($sql)) {
        $sucu_nom = $oIfx->f('sucu_nom_sucu');
    }
    if (count($arrayLiq) > 0) {
        $subTotal = $bim_tar0 + $bas_imgr;
        $total = $bim_tar0 + $bas_imgr + $fprv_val_viva;
        $html .= '<table style="margin-left:50px; width:100%;border:0px solid black; border-radius: 5px; margin-top:70px" align="left">
				<tr >
					<td style="width:70%; font-size:14px; text-align: left">' . $clpv_nom_clpv . '<br></td>
				</tr>
				<tr>
					<td  style="style="width:70%; font-size:14px; text-align: left">' . $clpv_ruc_clpv . '<br></td>
				</tr>
				<tr>
					<td  style="style="width:70%; font-size:14px; text-align: left">' . $dire_dir_dire . '</td>				
					<td style="style="width:30%; font-size:14px; text-align: left">' . $asto_fec_asto . '<br></td>
				</tr>
	
						
				
			</table>
			<table  style="margin-left:50px; width:90%;border:0px solid black; border-radius: 5px; margin-top:70px" align="left">
				<tr>
				<td colspan="3" style="width:100%;font-size:16px; text-align: center; border-bottom:0px solid "><strong></strong></td>
				</tr>
				<tr>
					<td  style="width:70%;font-size:14px; text-align: center; border-right:0px solid; border-bottom:0px solid "><strong></strong></td>
					<td  style="width:15%;font-size:14px; text-align: center; border-right:0px solid; border-bottom:0px solid"><strong></strong></td>
					<td  style="width:15%;font-size:14px; text-align: center; border-right:0px solid; border-bottom:0px solid"><strong></strong></td>
				</tr>
				<tr>
					<td style="font-size:14px; text-align: left">' . $asto_det_asto . '</td>
					<td style="font-size:14px; text-align: right">' . $subTotal . '</td>
					<td style="font-size:14px; text-align: right">' . $subTotal . '</td>										
				</tr>
			</table>
						<table  style="margin-left:50px; width:90%;border:0px solid black; border-radius: 5px; margin-top:70px" align="left">
				<tr>
				<td colspan="3" style="width:100%;font-size:16px; text-align: center; border-bottom:0px solid "><strong></strong></td>
				</tr>
				<tr>
					<td  style="width:70%;font-size:14px; text-align: center; border-right:0px solid; border-bottom:0px solid "><strong></strong></td>
					<td  style="width:15%;font-size:14px; text-align: center; border-right:0px solid; border-bottom:0px solid"><strong></strong></td>
					<td  style="width:15%;font-size:14px; text-align: center; border-right:0px solid; border-bottom:0px solid"><strong></strong></td>
				</tr>
				<tr>
					<td style="font-size:14px; text-align: left"></td>					
					<td style="font-size:14px; text-align: right"></td>
					<td style="font-size:14px; text-align: right">' . $subTotal . '</td>
				</tr>
				<tr>
					<td style="font-size:14px; text-align: left"></td>					
					<td style="font-size:14px; text-align: right"></td>
					<td style="font-size:14px; text-align: right">' . $fprv_val_viva . '</td>
				</tr>
				<tr>
					<td style="font-size:14px; text-align: left"></td>					
					<td style="font-size:14px; text-align: right"></td>
					<td style="font-size:14px; text-align: right">' . $total . '</td>
				</tr>
	
			</table>';

    }
    return $html;
}


////PDF EGRESOS TESORERIA PRE-IMPRESO
function generar_tesoreria_egreso_pdf($idempresa = "", $idsucursal = "", $asto_cod = "", $ejer_cod = "", $prdo_cod = "")
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $idEmpresa = $_SESSION['U_EMPRESA'];

    $class = new GeneraDetalleAsientoContable();

    $arrayAsto = $class->informacionAsientoContable($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $asto_cod);

    $arrayDiario = $class->diarioAsientoContable($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $asto_cod);

    $arrayDirectorio = $class->directorioAsientoContable($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $asto_cod);

    $arrayRetencion = $class->retencionAsientoContable($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $asto_cod);

    $sql = "SELECT
			empl_cod_empl,
			empl_nom_empl,
			empl_ape_empl
		 FROM saeempl, SAEPCCH
		WHERE
			SAEPCCH.pcch_cod_empl=saeempl.empl_cod_empl AND empl_cod_empr = $idempresa ";
    if ($oIfx->Query($sql)) {
        unset($array_empl);
        if ($oIfx->NumFilas() > 0) {
            do {
                $empleado = $oIfx->f('empl_nom_empl') . ' ' . $oIfx->f('empl_ape_empl');
                $array_empl[$oIfx->f('empl_cod_empl')] = $empleado;
            } while ($oIfx->SiguienteRegistro());
        }
    }

    foreach ($arrayAsto as $val) {
        $asto_cod_asto = $val[0];
        $asto_vat_asto = $val[1];
        $asto_ben_asto = $val[2];
        $asto_fec_asto = $val[3];
        $asto_det_asto = $val[4];
        $asto_cod_modu = $val[5];
        $asto_usu_asto = $val[6];
        $asto_user_web = $val[7];
        $asto_fec_serv = $val[8];
        $asto_cod_tidu = $val[9];
    }

    $sql = "select empr_ruc_empr, empr_dir_empr, empr_nom_empr, empr_path_logo from saeempr where empr_cod_empr = $idempresa ";
    if ($oIfx->Query($sql)) {
        $empr_ruc = $oIfx->f('empr_ruc_empr');
        $empr_dir = $oIfx->f('empr_dir_empr');
        $empr_nom = $oIfx->f('empr_nom_empr');
        $empr_path_logo = $oIfx->f('empr_path_logo');
        $empr_nom .= ' ';
    }
    $sql = "SELECT sucu_nom_sucu FROM saesucu WHERE sucu_cod_sucu='$idsucursal'";
    if ($oIfx->Query($sql)) {
        $sucu_nom = $oIfx->f('sucu_nom_sucu');
    }
    $sql = "select ciud_nom_ciud from saesucu inner join saeciud on saesucu.sucu_cod_ciud=saeciud.ciud_cod_ciud where saesucu.sucu_cod_sucu='$idsucursal'";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ciudad = $oIfx->f('ciud_nom_ciud');
        }
    }

    $sql = "select modu_des_modu from saemodu where modu_cod_modu = $asto_cod_modu";
    $modu_des_modu = consulta_string_func($sql, 'modu_des_modu', $oIfx, '');

    //tipo documento
    $sql = "select tidu_des_tidu from saetidu where tidu_cod_tidu = $asto_cod_tidu";
    $tidu_des_tidu = consulta_string_func($sql, 'tidu_des_tidu', $oIfx, '');


    $oIfx->Free();
    setlocale(LC_ALL, "es_ES@euro", "es_ES", "esp");

    $asto_fec = strftime("%d de %B de %Y", strtotime($asto_fec_asto));

    $total = number_format($asto_vat_asto, 2, '.', '');
    $V = new EnLetras();


    ///diario
    if (count($arrayDiario) > 0) {

        $html .= '<table  style="margin-left:50px; width:90%;border:0px solid black; border-radius: 5px; margin-top:100px" align="">';
        $html .= '<tr>';
        // $html.= '<td colspan="6" style="width:90%;font-size:16px; text-align: center; border-bottom:0px solid "><strong>DIARIO SERVICABLE</strong></td>';
        $html .= '</tr>';
        $html .= '<tr>';
        //$html.= '<td style="width:25%;font-size:14px; text-align: center; border-right:0px solid; border-bottom:0px solid "><strong>Cuenta Contable</strong></td>';
        //$html.= '<td style="width:60%;font-size:14px; text-align: center; border-right:0px solid; border-bottom:0px solid "><strong>Nombre Cuenta</strong></td>';
        //$html.= '<td style="width:15%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>Centro Actividad</strong></td>';
        //$html.= '<td style="width:15%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>Documento</strong></td>';
        //$html.= '<td style="width:10%;font-size:14px; text-align: center; border-right:0px solid; border-bottom:0px solid "><strong>Debito</strong></td>';
        //$html.= '<td style="width:10%;font-size:14px; text-align: center; border-bottom:0px solid "><strong>Credito</strong></td>';
        $html .= '</tr>';
        $totalDeb = 0;
        $totalCre = 0;
        $sql = "select max(cuen_cod_mone) as moneda from saedasi inner join saecuen on cuen_cod_cuen= dasi_cod_cuen where
                    cuen_cod_empr = asto_cod_empr and 
                    asto_cod_asto = '$asto_cod' and
				asto_cod_empr = $idempresa and
				asto_cod_sucu = $idsucursal and
				asto_cod_ejer = $ejer_cod and
                dasi_num_prdo = $prdo_cod ";
        $moneda_dasi = consulta_string($sql, 'moneda', $oIfx, '1');
        $sql = "select pcon_mon_base from saepcon where pcon_cod_empr = $idempresa ";
        $moneda = consulta_string_func($sql, 'pcon_mon_base', $oIfx, '', 0);
        if ($moneda != $moneda_dasi) {
            $sql = "select dasi_cod_cuen,  sum(dasi_dme_dasi) as dasi_dml_dasi, sum(dasi_cme_dasi) as dasi_cml_dasi
				   
				from saedasi
				where asto_cod_asto = '$asto_cod' and
				asto_cod_empr = $idempresa and
				asto_cod_sucu = $idsucursal and
				asto_cod_ejer = $ejer_cod and
                dasi_num_prdo = $prdo_cod group by dasi_cod_cuen";
        } else {
            $sql = "select dasi_cod_cuen,  sum(dasi_dml_dasi) as dasi_dml_dasi, sum(dasi_cml_dasi) as dasi_cml_dasi
				   
				from saedasi
				where asto_cod_asto = '$asto_cod' and
				asto_cod_empr = $idempresa and
				asto_cod_sucu = $idsucursal and
				asto_cod_ejer = $ejer_cod and
                dasi_num_prdo = $prdo_cod group by dasi_cod_cuen";
        }

        //  echo $sql;exit;
        if ($oIfx->Query($sql)) {
            if ($oIfx->NumFilas() > 0) {
                unset($array);
                do {
                    $dasi_cod_cuen = $oIfx->f('dasi_cod_cuen');

                    $dasi_dml_dasi = $oIfx->f('dasi_dml_dasi');
                    $dasi_cml_dasi = $oIfx->f('dasi_cml_dasi');

                    $cuen_nom_cuen = '';
                    if (!empty($dasi_cod_cuen)) {
                        $sql = "select cuen_nom_cuen from saecuen where cuen_cod_cuen = '$dasi_cod_cuen' and cuen_cod_empr = $idempresa";
                        $cuen_nom_cuen = consulta_string_func($sql, 'cuen_nom_cuen', $oIfx2, '');
                    }


                    $html .= '<tr>';
                    $html .= '<td style="width:15%;font-size:12px; text-align: left; border-right:0px solid; border-bottom:0px solid ">' . $dasi_cod_cuen . '</td>';
                    $html .= '<td style="width:30%;font-size:12px; text-align: left; border-right:0px solid; border-bottom:0px solid ">' . $cuen_nom_cuen . '</td>';
                    //$html.= '<td style="width:15%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">'.$dasi_cod_cact.' - '.$cact_nom_cact.'</td>';
                    //$html.= '<td style="width:15%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">'.$dasi_num_depo.'</td>';
                    $html .= '<td style="width:12%;font-size:12px; text-align: right; border-right:0px solid; border-bottom:0px solid ">' . number_format($dasi_dml_dasi, 2, '.', ',') . '</td>';
                    $html .= '<td style="width:12%;font-size:12px; text-align: right; border-bottom:0px solid ">' . number_format($dasi_cml_dasi, 2, '.', ',') . '</td>';
                    $html .= '</tr>';

                    $totalDeb += $dasi_dml_dasi;
                    $totalCre += $dasi_cml_dasi;

                } while ($oIfx->SiguienteRegistro());
            }
        }

        //$usuario = $_SESSION['U_NOMBRECOMPLETO'];
        if (!empty($asto_user_web)) {
            $sql = "select u.USUARIO_USER  from comercial.usuario u where u.USUARIO_ID = $asto_user_web ";
            $usuario = consulta_string_func($sql, 'usuario_user', $oCon, '');
        } else {
            $usuario = $asto_usu_asto;
        }


        $html .= '<tr>';
        $html .= '<td valign="bottom" align="right" style="height:220px; width:45%;font-size:14px; text-align: right; border-right:0px solid; " colspan="2" ><strong></strong></td>';
        $html .= '<td valign="bottom" align="right" style="width:12%;font-size:12px; text-align: right; border-right:0px solid; ">' . number_format($totalDeb, 2, '.', ',') . '</td>';
        $html .= '<td valign="bottom"  align="right" style="width:12%;font-size:12px; border-right:0px solid;">' . number_format($totalCre, 2, '.', ',') . '</td>';
        $html .= '</tr>';
        $html .= '</table>';

        $html .= '<table style="width:100%; margin-top: 100px" align="center" >
					
					<tr>
						<td style="width:10%"></td>
				    <!--<td style="width:10%; font-size:12px; text-align: center;border-top : 2px solid black;">Ingresado por:<br>' . $usuario . '</td> -->
						<td style="width:10%;"></td>
					<!--	<td style="width:10%;font-size:12px; text-align: center;border-top : 2px solid black;">Aprobado por</td> -->
						<td style="width:10%;"></td>	
					<!--	<td style="width:10%; font-size:12px; text-align: center;border-top : 2px solid black;">Revisado por:</td> -->
						<td style="width:10%;"></td>
					<!--	<td style="width:10%; font-size:12px; text-align: center;border-top : 2px solid black;">Recibí Conforme</td> -->
						<td style="width:10%;"></td>
					</tr> 
					
					
			</table>';


    }
    $sql = "select banc_nom_banc, dchc_cod_cuen, cuen_cod_mone, mone_des_mone, dchc_num_dchc, dchc_cta_dchc
        from  saedchc
        inner join saecuen on saedchc.dchc_cod_cuen = saecuen.cuen_cod_cuen
        inner join saectab on  saedchc.dchc_cod_ctab = saectab.ctab_cod_ctab
        inner join saebanc on saectab.ctab_cod_banc = saebanc.banc_cod_banc
        inner join saemone on saecuen.cuen_cod_mone = saemone.mone_cod_mone
        where 
        cuen_cod_empr = mone_cod_empr and 
        cuen_cod_empr = asto_cod_empr and
        cuen_cod_cuen = dchc_cod_cuen and
        dchc_cod_asto = '$asto_cod' and 
        asto_cod_empr = '$idempresa' and 
        asto_cod_sucu= '$idsucursal' and 
        asto_cod_ejer= '$ejer_cod' and  
        asto_num_prdo='$prdo_cod'";
    $dchc_cta_dchc = consulta_string_func($sql, 'dchc_cta_dchc', $oIfx, '');
    $dchc_nom_banc = consulta_string_func($sql, 'banc_nom_banc', $oIfx, '');
    $dchc_num_dchc = consulta_string_func($sql, 'dchc_num_dchc', $oIfx, '');
    $mone_des_mone = consulta_string_func($sql, 'mone_des_mone', $oIfx, '');

    $con_letra = strtoupper($V->ValorEnLetras($totalCre, $mone_des_mone));


    $html_cab = '<br><br><br><br>';
    $html_cab .= '<table border="0" style="width: 100%; margin-left:30px; margin-top:10px">
					<tr>
						<td style="width: 33%; font-size:12px; text-align: center"><strong>' . $dchc_cta_dchc . '</strong></td>
						<td style="width: 33%; font-size:12px; text-align: center"><strong>' . $dchc_nom_banc . '</strong></td>
						<td style="width: 33%; font-size:12px; text-align: center"><strong>' . $dchc_num_dchc . '</strong></td>
					</tr>
				</table>';
    $cabecera .= '<table border="0" style="width: 100%; margin-left:30px; margin-top:10px">
				<tr>
				<!--    <td style="font-size:18px; text-align: left"><img src="' . $empr_path_logo . '" width="250""><br></td> -->
				</tr>
				<tr>
					<td style="width: 100%; font-size:12px; text-align: center"><strong>' . htmlentities($empr_nom) . '</strong></td>
				</tr>
				
				<tr>
					<td  style="width: 100%; font-size:12px; text-align: center"><strong>DIRECCION:' . htmlentities($empr_dir) . '</strong></td>
				</tr>
				<tr>
					<td style="width: 100%; font-size:12px; text-align: center"><strong>NIT:' . $empr_ruc . '</strong><br><br></td>
				</tr>
				</table>
			
			<table border="0"    style="width:100%; margin-left:30px; ">
				<tr>
					<td    style="width: 50%;font-size:12px; text-align: left"><strong>Fecha:</strong> ' . $ciudad . ', ' . $asto_fec . '</td>
					
					
				</tr>
				
				
				
				<tr>
                    <td  style="width: 50%; font-size:12px; text-align: left"><strong>Beneficiario: </strong> ' . $asto_ben_asto . '</td>
                    <td  style="width:50%; font-size:12px; text-align: left"><strong>Monto: </strong>' . number_format($totalCre, 2, '.', ',') . '</td>

				</tr>
			
				<tr>
					<td colspan="2" style="width: 50%; font-size:12px; text-align: left"><strong>Detalle:</strong> ' . $asto_det_asto . '</td>					
				</tr>
				<tr>
					<td colspan="2" style="width: 50%; font-size:12px; text-align: left"><strong>Son:</strong> ' . $con_letra . '</td>					
                </tr>
                <tr>
					<td style="width: 50%; font-size:12px; text-align: left"><strong>Documento:</strong> ' . $asto_cod_tidu . ' - ' . $tidu_des_tidu . '</td>
				</tr></table>';
    return $html_cab . $cabecera . $html;

}


function sumaMesFecha($fecha)
{

    $actual = strtotime($fecha);
    $mesMas = date("Y-m-d", strtotime("+1 month", $actual));

    return $mesMas;
}


function generar_mov_importacion_pdf($idempresa = "", $idsucursal = "", $minv_num_comp = "", $tran_cod = '', $ejer_cod = "", $prdo_cod = "")
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    $sigl_mone = $_SESSION['U_MONE_SIGLA'] . '$';

    $class = new GeneraDetalleInventario();

    $arrayMinv = $class->generaSaeminv($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $tran_cod, $minv_num_comp);

    $arrayDmov = $class->generaSaedmov($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $minv_num_comp);

    //var_dump($arrayRetencion);exit;
    foreach ($arrayMinv as $val) {
        $minv_num_sec = $val[0];
        $minv_cod_clpv = $val[1];
        $minv_fmov = $val[2];
        $minv_fac_prov = $val[3];
        $minv_tot_minv = $val[4];
        $minv_iva_valo = $val[5];
        $minv_cm1_minv = $val[6];
        $minv_hor_minv = $val[7];
        $minv_cod_mone = $val[8];

        $minv_cod_pais = $val[11];
        $minv_cod_emb = $val[12];
        $minv_prto_ori = $val[13];
        $minv_prto_des = $val[14];
        $minv_cm6_minv = $val[15];
    }

    $sql = "select empr_ruc_empr, empr_dir_empr, empr_nom_empr, empr_path_logo from saeempr where empr_cod_empr = $idempresa ";
    if ($oIfx->Query($sql)) {
        $empr_ruc = $oIfx->f('empr_ruc_empr');
        $empr_dir = $oIfx->f('empr_dir_empr');
        $empr_nom = $oIfx->f('empr_nom_empr');
        $empr_path_logo = $oIfx->f('empr_path_logo');
        $empr_nom .= ' ';
    }
    $sql = "SELECT sucu_nom_sucu FROM saesucu WHERE sucu_cod_sucu='$idsucursal'";
    if ($oIfx->Query($sql)) {
        $sucu_nom = $oIfx->f('sucu_nom_sucu');
    }


    $sql = "select tran_des_tran from saetran where
					tran_cod_empr = $idempresa and
					tran_cod_sucu = $idsucursal and
					tran_cod_tran = '$tran_cod' ";
    if ($oIfx->Query($sql)) {
        $tran_nom_tran = $oIfx->f('tran_des_tran');
    }

    $oIfx->Free();
    setlocale(LC_ALL, "es_ES@euro", "es_ES", "esp");

    $asto_fec = strftime("%d de %B de %Y", strtotime($asto_fec));

    // MONEDA
    $sql = "select mone_des_mone from saemone where mone_cod_empr = $idempresa and mone_cod_mone = $minv_cod_mone ";
    $moneda = consulta_string_func($sql, 'mone_des_mone', $oIfx, 0);

    // IMPORTACION
    $sql = "select pais_des_pais from saepais where pais_cod_pais = '$minv_cod_pais' ";
    $pais_nom = consulta_string_func($sql, 'pais_des_pais', $oIfx, 0);

    $sql = "select emba_cod_emba, emba_nom_emba from saeemba where emba_cod_emba = '$minv_cod_emb' ";
    $emba_nom = consulta_string_func($sql, 'emba_nom_emba', $oIfx, 0);

    $sql = "select prto_cod_prto, prto_des_prto from saeprto where prto_cod_prto = '$minv_prto_ori' ";
    $puerto_orig = consulta_string_func($sql, 'prto_des_prto', $oIfx, 0);

    $sql = "select prto_cod_prto, prto_des_prto from saeprto where prto_cod_prto = '$minv_prto_des' ";
    $puerto_dest = consulta_string_func($sql, 'prto_des_prto', $oIfx, 0);

    $sql = "select clpv_nom_clpv, clpv_ruc_clpv from saeclpv where clpv_cod_empr = $idempresa and clpv_cod_clpv = $minv_cod_clpv ";
    if ($oIfx->Query($sql)) {
        $clpv_nom = $oIfx->f('clpv_nom_clpv');
        $clpv_ruc = $oIfx->f('clpv_ruc_clpv');
    }

    $html .= '<table style="margin-left:50px; margin-right:50px; margin-top:30px; font-family: Courier;">
				<tr >
					<td style="font-size:18px; text-align: left"><strong>' . $empr_nom . '</strong><br><br></td>
				</tr>
				<tr>
					<td  style="font-size:14px; text-align: left">SUCURSAL:' . $sucu_nom . '<br><br></td>
				</tr>
				<tr>
					<td  style="font-size:14px; text-align: left">DIRECCION:' . $empr_dir . '<br><br></td>
				</tr>
				<tr>
					<td style="font-size:14px; text-align: left">RUC:' . $empr_ruc . '<br><br></td>
				</tr>
				<tr>
					<td style="font-size:14px; text-align: center"><strong>N.- MOVIMIENTO  ' . $tran_nom_tran . ' No:' . $minv_num_sec . '</strong><br><br></td>
				</tr>				
			</table>
			<table border="0" style="width: 100%; margin-left:50px; margin-top:5px; font-family: Courier;">
				<tr>
					<td style="width: 100%;font-size:12px; text-align: left"><strong>Fecha:</strong> ' . $minv_fmov . '</td>					
				</tr>
				<tr>
					<td   style="width: 100%;font-size:12px; text-align: left"><strong>Moneda:</strong> ' . $moneda . '</td>					
				</tr>
				<tr>
					<td  style="width: 100%; font-size:12px; text-align: left"><strong>Monto ' . $sigl_mone . ': </strong>' . number_format(($minv_tot_minv + $minv_iva_valo), 2, '.', ',') . '</td>
				</tr>			
				<tr>
					<td style="width: 100%; font-size:12px; text-align: left"><strong>Detalle:</strong> ' . $minv_cm1_minv . '<br><br></td>
				</tr>				
			</table>
			
			<table border="0" style="width: 100%; margin-left:50px; margin-top:5px; font-family: Courier;">
				<tr>
					<td style="width: 50%;font-size:12px; text-align: left"><strong>Suplidor:</strong> ' . $clpv_nom . '</td>
					<td style="width: 50%;font-size:12px; text-align: left"><strong>Identificacion:</strong> ' . $clpv_ruc . '</td>
				</tr>
				<tr>
					<td style="width: 50%;font-size:12px; text-align: left"><strong>Pais:</strong> ' . $pais_nom . '</td>
					<td style="width: 50%;font-size:12px; text-align: left"><strong>Embarcador:</strong> ' . $emba_nom . '</td>
				</tr>
				<tr>
					<td style="width: 50%;font-size:12px; text-align: left"><strong>Puerto Origen:</strong> ' . $puerto_orig . '</td>
					<td style="width: 50%;font-size:12px; text-align: left"><strong>Puerto Destino:</strong> ' . $puerto_dest . '</td>
				</tr>
				<tr>
					<td style="width: 50%;font-size:12px; text-align: left"><strong>Condiciones de Pago:</strong> ' . $minv_cm6_minv . '</td>
					<td style="width: 50%;font-size:12px; text-align: left"><strong>Factura:</strong> ' . $minv_fac_prov . '</td>
				</tr>
			</table>';

    //SAEDMOV
    if (count($arrayDmov) > 0) {
        $html .= '
					<table  style="margin-left:50px; width:90%;border:1px solid black; border-radius: 5px; margin-top:10px; font-family: Courier;" align="left">
						<tr>
						<td colspan="9" style="width:100%;font-size:14px; text-align: center; border-bottom:1px solid "><strong>DETALLE</strong></td>
						</tr>
						<tr>
							<td  style="width:3%; font-size:12px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>N</strong></td>
							<td  style="width:15%;font-size:12px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>BODEGA</strong></td>
							<td  style="width:10%;font-size:12px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>CODIGO</strong></td>
							<td  style="width:10%;font-size:12px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>CODIGO BARRAS</strong></td>
							<td  style="width:25%;font-size:12px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>PRODUCTO</strong></td>
							<td  style="width:10%;font-size:12px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>PESO</strong></td>
							<td  style="width:10%;font-size:12px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>CANT.</strong></td>
							<td  style="width:10%;font-size:12px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>COSTO ' . $sigl_mone . '</strong></td>
						</tr>';

        $i = 1;
        $total = 0;
        foreach ($arrayDmov as $val) {
            $dmov_cod_prod = $val[0];
            $dmov_cod_bode = $val[1];
            $dmov_bod_envi = $val[2];
            $dmov_cod_ccos = $val[3];
            $dmov_cod_cuen = $val[4];
            $dmov_can_dmov = $val[5];
            $dmov_cun_dmov = $val[6];
            $dmov_cto_dmov = $val[7];
            $dmov_cad_lote = $val[8];
            $dmov_ela_lote = $val[9];
            $dmov_cod_lote = $val[10];
            $dmov_peso_dmov = $val[13];

            $sql = "select prod_nom_prod from saeprod where prod_cod_empr = $idempresa and prod_cod_sucu = $idsucursal and prod_cod_prod = '$dmov_cod_prod' ";
            $prod_nom = consulta_string_func($sql, 'prod_nom_prod', $oIfx, '');

            $sql = "select bode_nom_bode from saebode where bode_cod_empr = $idempresa and bode_cod_bode = '$dmov_cod_bode' ";
            $bode_nom = consulta_string_func($sql, 'bode_nom_bode', $oIfx, '');

            $sql = "select prod_cod_barra from saeprod where prod_cod_empr = $idempresa and prod_cod_sucu = $idsucursal and prod_cod_prod = '$dmov_cod_prod' ";
            $prod_cod_barra = consulta_string_func($sql, 'prod_cod_barra', $oIfx, '');

            $sql = "select prbo_dis_prod from saeprbo where prbo_cod_empr = $idempresa and prbo_cod_sucu = $idsucursal and prbo_cod_prod = '$dmov_cod_prod' ";
            //$prbo_dis_prod = consulta_string_func($sql, 'prbo_dis_prod', $oIfx, '0');

            $html .= '<tr>';
            $html .= '<td style="width:3%; font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid ">' . $i . '</td>';
            $html .= '<td style="width:15%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid">' . $bode_nom . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $dmov_cod_prod . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $prod_cod_barra . '</td>';
            $html .= '<td style="width:25%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $prod_nom . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid">' . $dmov_peso_dmov . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid">' . $dmov_can_dmov . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid">' . $dmov_cun_dmov . '</td>';
            $html .= '</tr>';

            $i++;
            $total += $dmov_can_dmov * $dmov_cun_dmov;
        }

        $html .= '<tr>';
        $html .= '<td style="width:3%; font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid "></td>';
        $html .= '<td style="width:15%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid"></td>';
        $html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid "></td>';
        $html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid "></td>';
        $html .= '<td style="width:25%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid "></td>';
        $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid"></td>';
        $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid">TOTAL ' . $sigl_mone . ':</td>';
        $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid">' . number_format(round(($total), 2), 2, '.', ',') . '</td>';
        $html .= '</tr>';

        $html .= '</table>';
        $html .= '<br><br><br><br><br><br>';
        $html .= '<table  style="margin-left:15px; width:60%;border:0px solid black; border-radius: 5px; margin-top:10px" align="center">';
        $html .= '<tr>
						<td style="font-size:12px; text-align: center;border-top : 2px solid black; width:50%;">Despachado por:</td>
						<td style="font-size:12px; text-align: center;border-top : 2px solid black; width:50%;">Autorizado por:</td>	
					</tr>
					</table>';
    }

    return $html;

}

function ultimoDiaMesFunc($fecha)
{

    $last_day = date('t', strtotime($fecha));

    return $last_day;
}

// PDF CONTEO FISICO
function generar_conteo_fisico_pdf($idempresa = "", $idsucursal = "", $conteo_cod = "")
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();


    $idEmpresa = $_SESSION['U_EMPRESA'];

    $class = new GeneraGuiaRemision();

    $arrayMinv = $class->generaCabConteo($oCon, $idempresa, $idsucursal, $conteo_cod);

    $arrayDmov = $class->generaDetConteo($oCon, $idempresa, $idsucursal, $conteo_cod);

    //var_dump($arrayRetencion);exit;
    foreach ($arrayMinv as $val) {
        $preimpreso = $val[0];
        $fecha = $val[1];
        $hora = $val[2];
        $fecha_server = $val[3];
        $user_cod_user = $val[4];

    }

    $sql = "select empr_ruc_empr, empr_dir_empr, empr_nom_empr, empr_path_logo from saeempr where empr_cod_empr = $idempresa ";
    if ($oIfx->Query($sql)) {
        $empr_ruc = $oIfx->f('empr_ruc_empr');
        $empr_dir = $oIfx->f('empr_dir_empr');
        $empr_nom = $oIfx->f('empr_nom_empr');
        $empr_path_logo = $oIfx->f('empr_path_logo');
        $empr_nom .= ' ';
    }
    $sql = "SELECT sucu_nom_sucu FROM saesucu WHERE sucu_cod_sucu='$idsucursal'";
    if ($oIfx->Query($sql)) {
        $sucu_nom = $oIfx->f('sucu_nom_sucu');
    }

    $sql = "select trta_nom_trta  from saetrta where
				trta_cod_empr = $idempresa and
				trta_cod_trta = 0 ";
    if ($oIfx->Query($sql)) {
        $trta_nom_trta = $oIfx->f('trta_nom_trta');
    }


    $oIfx->Free();
    setlocale(LC_ALL, "es_ES@euro", "es_ES", "esp");

    $asto_fec = strftime("%d de %B de %Y", strtotime($asto_fec));

    $html .= '<table style="margin-left:50px; margin-right:50px; margin-top:30px">
				<tr >
					<td style="font-size:18px; text-align: left">' . $empr_nom . '<br><br></td>
				</tr>
				<tr>
					<td  style="font-size:14px; text-align: left">SUCURSAL:' . $sucu_nom . '<br><br></td>
				</tr>
				<tr>
					<td  style="font-size:14px; text-align: left">DIRECCION:' . $empr_dir . '<br><br></td>
				</tr>
				<tr>
					<td style="font-size:14px; text-align: left">RUC:' . $empr_ruc . '<br><br></td>
				</tr>
				<tr>
					<td style="font-size:14px; text-align: left">N.- CONTEO FISICO:' . $preimpreso . '<br><br></td>
				</tr>				
			</table>
			<table border="0"  style="width: 100%; margin-left:50px; margin-top:8px;">
				<tr>
					<td colspan="2" style="width: 100%;font-size:12px; text-align: left"><strong>Fecha Sistema:</strong> ' . $fecha_server . '</td>					
				</tr>			
				<tr>
					<td colspan="2" style="width: 100%;font-size:12px; text-align: left"><strong>Fecha:</strong> ' . $fecha . '</td>					
				</tr>				
			</table>';

    //SAEDMOV
    if (count($arrayDmov) > 0) {
        $html .= '
					<table  style="margin-left:50px; width:90%;border:1px solid black; border-radius: 5px; margin-top:20px" align="left">
						<tr>
						<td colspan="7" style="width:100%;font-size:16px; text-align: center; border-bottom:1px solid "><strong>DETALLE</strong></td>
						</tr>
						<tr>
							<td  style="width:3%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid "><strong>N</strong></td>
							<td  style="width:20%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>BODEGA</strong></td>
							<td  style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>CODIGO</strong></td>
							<td  style="width:15%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>CODIGO BARRAS</strong></td>
							<td  style="width:30%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>PRODUCTO</strong></td>
							<td  style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>UNIDAD</strong></td>
							<td  style="width:10%;font-size:14px; text-align: center; border-right:1px solid; border-bottom:1px solid"><strong>CANT.</strong></td>										
						</tr>';

        $i = 1;
        unset($array);
        $cont = 1;
        $subtotal = 0;
        foreach ($arrayDmov as $val) {
            $prod_cod_prod = $val[0];
            $bode_cod_bode = $val[1];
            $unid_cod_unid = $val[2];
            $cantidad = round($val[3], 2);
            $dgui_fac_dgui = $val[4];

            $array [$i] = $dgui_fac_dgui;

            //$prod_cod_prod, $bode_cod_bode, $unid_cod_unid, $cantidad


            $sql = "select unid_nom_unid from saeunid where unid_cod_empr = $idempresa and unid_cod_unid = $unid_cod_unid ";
            $unid_nom = consulta_string_func($sql, 'unid_nom_unid', $oIfx, '');

            $sql = "select bode_nom_bode from saebode where bode_cod_empr = $idempresa and bode_cod_bode = '$bode_cod_bode' ";
            $bode_nom = consulta_string_func($sql, 'bode_nom_bode', $oIfx, '');

            $sql = "select prod_cod_barra , prod_nom_prod from saeprod where prod_cod_empr = $idempresa and prod_cod_sucu = $idsucursal and prod_cod_prod = '$prod_cod_prod' ";
            $prod_cod_barra = consulta_string_func($sql, 'prod_cod_barra', $oIfx, '');
            $dgui_nom_prod = consulta_string_func($sql, 'prod_nom_prod', $oIfx, '');

            if ($i > 1) {
                if ($array[$i] != $array[$i - 1]) {

                    $html .= '<tr>';
                    $html .= '<td style="width:3%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid "></td>';
                    $html .= '<td style="width:20%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid"></td>';
                    $html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid "></td>';
                    $html .= '<td style="width:15%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid "></td>';
                    $html .= '<td style="width:30%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid "></td>';
                    $html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">TOTAL:</td>';
                    $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid" align="right">' . $subtotal . '</td>';
                    $html .= '</tr>';

                    $sql = "select fpag_des_fpag from saefxfp , saefpag where
									fpag_cod_fpag = fxfp_cod_fpag and
									fpag_cod_empr = $idempresa and
									fxfp_cod_empr = $idsucursal and
									fxfp_cod_fact = $dgui_fac_dgui ";
                    $fpag_nom = consulta_string_func($sql, 'fpag_des_fpag', $oIfx, '');

                    $html .= '<tr>';
                    $html .= '<td style="width:30%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid " colspan="7">Subtotal FACTURAS ' . ($fpag_nom) . '</td>';
                    $html .= '</tr>';

                    $html .= '<tr>';
                    $html .= '<td style="width:30%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid " colspan="7">Nro Docs.: ' . ($cont - 1) . '</td>';
                    $html .= '</tr>';

                    $cont = 1;
                    $subtotal = 0;
                }
            }

            $html .= '<tr>';
            $html .= '<td style="width:3%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid ">' . $i . '</td>';
            $html .= '<td style="width:20%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid">' . $bode_nom . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $prod_cod_prod . '</td>';
            $html .= '<td style="width:15%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $prod_cod_barra . '</td>';
            $html .= '<td style="width:30%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $dgui_nom_prod . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $unid_nom . '</td>';
            $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid" align="right">' . $cantidad . '</td>';
            $html .= '</tr>';

            $subtotal += $cantidad;
            $cont++;
            $i++;
        }

        $html .= '<tr>';
        $html .= '<td style="width:3%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid "></td>';
        $html .= '<td style="width:20%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid"></td>';
        $html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid "></td>';
        $html .= '<td style="width:15%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid "></td>';
        $html .= '<td style="width:30%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid "></td>';
        $html .= '<td style="width:10%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">TOTAL:</td>';
        $html .= '<td style="width:10%;font-size:12px; text-align: right; border-right:1px solid; border-bottom:1px solid" align="right">' . $subtotal . '</td>';
        $html .= '</tr>';


        $html .= '<tr>';
        $html .= '<td style="width:30%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid " colspan="7">Nro Docs.: ' . ($cont - 1) . '</td>';
        $html .= '</tr>';
        $html .= '</table>';
    }

    return $html;

}

// ARRAY NORMAL IFX O OCON
function array_dato_matriz($Conexion, $sql, $campo1, $campo2, $campo3)
{
    unset($array);
    if ($Conexion->Query($sql)) {
        if ($Conexion->NumFilas() > 0) {
            do {
                $array [$Conexion->f($campo1)][$Conexion->f($campo2)] = $Conexion->f($campo3);
            } while ($Conexion->SiguienteRegistro());
        }
    }
    $Conexion->Free();
    return $array;
}


function envio_correo_tecnico($empleado, $id_contrato, $id_instalacion)
{

    include_once(path(DIR_INCLUDE) . "class.phpmailer.php");
    include_once(path(DIR_INCLUDE) . "class.smtp.php");

    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    //variables de session
    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empl_ape_nomb, empl_mai_empl from saeempl where empl_cod_empr = $idEmpresa AND empl_cod_empl = '$empleado'";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $empl_ape_nomb = $oIfx->f("empl_ape_nomb");
            $correo = $oIfx->f('empl_mai_empl');
        }
    }
    $oIfx->Free();

    if (!empty($correo)) {

        $sqlEmpr = "select empr_nom_empr, empr_dir_empr, empr_tel_resp from saeempr where empr_cod_empr = $idEmpresa";
        if ($oIfx->Query($sqlEmpr)) {
            if ($oIfx->NumFilas() > 0) {
                $compania = $oIfx->f("empr_nom_empr");
                $dirMatriz = $oIfx->f('empr_dir_empr');
                $empr_tel_resp = $oIfx->f("empr_tel_resp");
            }
        }
        $oIfx->Free();

        $sql = "select id_proceso, secuencial, fecha, observaciones FROM instalacion_clpv WHERE id = $id_instalacion ";
        if ($oCon->Query($sql)) {
            if ($oCon->NumFilas() > 0) {
                $id_proceso = $oCon->f("id_proceso");
                $secuencial = $oCon->f("secuencial");
                $fecha = $oCon->f('fecha');
                $observaciones = $oCon->f("observaciones");
            }
        }
        $oCon->Free();

        $sql = "SELECT descripcion FROM int_tipo_proceso WHERE id = $id_proceso";
        $descripcion = consulta_string_func($sql, 'descripcion', $oCon, '');

        $sql = "select codigo, nom_clpv, direccion, referencia, latitud, longitud FROM contrato_clpv WHERE id = $id_contrato ";
        if ($oCon->Query($sql)) {
            if ($oCon->NumFilas() > 0) {
                $codigo = $oCon->f("codigo");
                $nom_clpv = $oCon->f("nom_clpv");
                $direccion = $oCon->f('direccion');
                $referencia = $oCon->f("referencia");
                $latitud = $oCon->f("latitud");
                $longitud = $oCon->f("longitud");
            }
        }
        $oCon->Free();

        //query telefonos
        $telefonos = '';
        $sql = "select tlcp_tlf_tlcp 
				from saetlcp
				where tlcp_cod_empr = $idEmpresa and
				tlcp_cod_contr = $id_contrato";
        if ($oIfx->Query($sql)) {
            if ($oIfx->NumFilas() > 0) {
                do {
                    $telefonos .= $oIfx->f('tlcp_tlf_tlcp') . ' ';
                } while ($oIfx->SiguienteRegistro());
            }
        }
        $oIfx->Free();

        $sqlSmtp = "select server, port, auth, 
				user, pass, ssltls, 
				mail 
				from comercial.config_email
				where id_empresa = $idEmpresa";
        if ($oCon->Query($sqlSmtp)) {
            if ($oCon->NumFilas() > 0) {
                $host = $oCon->f('server');
                $port = $oCon->f('port');
                $smtpauth = $oCon->f('auth');
                $userid = $oCon->f('user');
                $smtpsecure = $oCon->f('ssltls');
                $mailenvio = $oCon->f('mail');
                $password = $oCon->f('pass');
            }
        }
        $oCon->Free();

        $mail = new PHPMailer();
        $mail->IsSMTP();
        $mail->Mailer = "smtp";

        if ($smtpauth == 'S') {
            $mail->SMTPAuth = true;
        }

        if ($smtpsecure == 'S') {
            $mail->SMTPSecure = "tls";
        }

        $mail->Host = $host;
        $mail->Port = $port;
        $mail->Username = $userid;
        $mail->Password = $password;
        $mail->From = $mailenvio;
        $mail->FromName = $compania;
        $mail->Subject = "Orden Servicio: $descripcion, Cliente: $nom_clpv";
        $mail->AltBody = "Factura....";
        $mail->IsHTML(true);
        $mail->CharSet = 'UTF-8';

        //query tecnico asigando
        $sql = "SELECT t.nombres, t.observacion_tecnico
                FROM instalacion_tecnico t, instalacion_clpv c
                WHERE t.id_instalacion = c.id AND
                c.id_contrato = $id_contrato AND
				c.id = $id_instalacion";
        $detalle_user = '';
        if ($oCon->Query($sql)) {
            if ($oCon->NumFilas() > 0) {
                do {
                    $detalle_user .= '<p style="color: blue;">' . $oCon->f('nombres') . '</p> <p style="color: green;">' . $oCon->f('observacion_tecnico') . '</p>';
                } while ($oCon->SiguienteRegistro());
            }
        }
        $oCon->Free();

        $sHtml = "<div style='width: 900px;'>
					<table style='width:850px;'> 
						<tr>
							<td>Estimado <span style='font-weight: bold'>$empl_ape_nomb</span> </td>
						</tr>
						<tr>
							<td>Le informamos que se le ha asignado la siguiente orden de servicio:</td>
						</tr>
					</table>
					<br />
					<table style='width:850px;'>
						<tr>
							<td style='font-weight: bold;'>Contrato: </td> <td>$codigo - $nom_clpv</td>
						</tr>
						<tr>
							<td style='font-weight: bold;'>Orden Servicio: </td> <td>$secuencial - $descripcion</td>
						</tr>
						<tr>
							<td style='font-weight: bold;'>Fecha: </td> <td>$fecha</td>
						</tr>
						<tr>
							<td style='font-weight: bold;'>Telefono: </td> <td>$telefonos</td>
						</tr>
						<tr>
							<td style='font-weight: bold;'>Direccion: </td> <td>$direccion</td>
						</tr>
						<tr>
							<td style='font-weight: bold;'>Referencia: </td> <td>$referencia</td>
						</tr>
						<tr>
							<td style='font-weight: bold;'>Detalle: </td> <td>$observaciones</td>
						</tr>
						<tr>
							<td style='font-weight: bold;'>Historial: </td> <td>$detalle_user</td>
						</tr>
						<tr>
							<td style='font-weight: bold;'>Georeferencia: </td> <td><a>$latitud , $longitud</a></td>
						</tr>
					</table>  
					<br><br>
					<table style='width:850px;'>
						<tr> 
							<td>Atentamente,</td>
						</tr> 
						<tr>&nbsp;</tr>
						<tr>&nbsp;</tr>
						<tr>
							<td style='font-weight: bold; font-size: 13px;'>$compania</td>
						</tr>
						<tr>&nbsp;</tr>
						<tr>
							<td style='font-weight: bold;'>Dire.: $dirMatriz</td>
						</tr>
						<tr>
							<td style='font-weight: bold;'>Telf.: $empr_tel_resp</td>
						</tr>
						 <tr>&nbsp;</tr>
					</table>
				</div>";

        $mail->MsgHTML($sHtml);

        $correoArray = explode(";", $correo);

        if (count($correoArray) > 0) {
            for ($j = 0; $j < count($correoArray); $j++) {
                $correoTmp = trim($correoArray[$j]);

                $mail->AddAddress($correoTmp, $correoTmp);
            }
        } else {
            $mail->AddAddress($correo, $correo);
        }

        $mail->AddBCC('geldurt@gmail.com', '');
        $mail->AddBCC('dawinmanfre@hotmail.com', '');

        if (!$mail->Send())
            return "Error: " . $mail->ErrorInfo . $sqlSmtp;
        else
            return 'Mail enviado!';
    }
}


function diferenciaDias($inicio, $fin)
{
    $inicio = strtotime($inicio);
    $fin = strtotime($fin);
    $dif = $fin - $inicio;
    $diasFalt = ((($dif / 60) / 60) / 24);
    return ceil($diasFalt);
}

function envio_correo_int($correo = '', $nom_clpv = '', $clave = '')
{
    include_once(path(DIR_INCLUDE) . "class.phpmailer.php");
    include_once(path(DIR_INCLUDE) . "class.smtp.php");
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    //variables de session
    $idEmpresa = $_SESSION['U_EMPRESA'];

    $sqlEmpr = "select empr_nom_empr, empr_dir_empr, empr_tel_resp from saeempr where empr_cod_empr = $idEmpresa";
    if ($oIfx->Query($sqlEmpr)) {
        $compania = $oIfx->f("empr_nom_empr");
        $dirMatriz = $oIfx->f('empr_dir_empr');
        $empr_tel_resp = $oIfx->f("empr_tel_resp");
    }
    $oIfx->Free();

    $sqlSmtp = "select server, port, auth, user, pass, ssltls, mail 	from comercial.config_email 	where 
                    id_empresa   = $idEmpresa and
			        id_tipo      = 12 ";
    if ($oCon->Query($sqlSmtp)) {
        if ($oCon->NumFilas() > 0) {
            $host = $oCon->f('server');
            $port = $oCon->f('port');
            $smtpauth = $oCon->f('auth');
            $userid = $oCon->f('user');
            $smtpsecure = $oCon->f('ssltls');
            $mailenvio = $oCon->f('mail');
            $password = $oCon->f('pass');
        }
    }
    $oCon->Free();

    $mail = new PHPMailer();
    $mail->IsSMTP();
    $mail->Mailer = "smtp";

    if ($smtpauth == 'S') {
        $mail->SMTPAuth = true;
    }

    $mail->SMTPSecure = $smtpsecure;


    $mail->Host = $host;
    $mail->Port = $port;
    $mail->Username = $userid;
    $mail->Password = $password;
    $mail->From = $mailenvio;

    $mail->FromName = $compania;
    $mail->Subject = "Comprobante de Pago";
    $mail->AltBody = $title;
    $mail->IsHTML(true);
    $mail->CharSet = 'UTF-8';


    $sHtml = "<div style='width: 900px;'>
				<table style='width:850px;'> 
					<tr>
						<td>Estimado cliente, <span style='font-weight: bold'>$nom_clpv</span> </td>
					</tr>
					<tr>
						<td>Le informamos que ha sido generado el siguiente documento, a continuacion adjuntamos el archivo:</td>
					</tr>
				</table>
				<br /> 
				<br><br>
				<table style='width:850px;'>
					<tr> 
						<td>Atentamente,</td>
					</tr> 
					<tr>&nbsp;</tr>
					<tr>&nbsp;</tr>
					<tr>
						<td style='font-weight: bold; font-size: 13px;'>$compania</td>
					</tr>
					<tr>&nbsp;</tr>
					<tr>
						<td style='font-weight: bold;'>Dire.: $dirMatriz</td>
					</tr>
					<tr>
						<td style='font-weight: bold;'>Telf.: $empr_tel_resp</td>
					</tr>
					<tr><td></td></tr>
				</table>
			</div>";

    $mail->MsgHTML($sHtml);

    $correoArray = explode(";", $correo);

    if (count($correoArray) > 0) {
        for ($j = 0; $j < count($correoArray); $j++) {
            $correoTmp = trim($correoArray[$j]);
            $mail->AddAddress($correoTmp, $correoTmp);
        }
    } else {
        $mail->AddAddress($correo, $correo);
    }

    $mail->AddBCC($prfa_mail3, $prfa_mail3);

    if ($clave > 0) {
        $ruta = DIR_FACTELEC . 'Include/archivos/' . $clave . '.pdf';
        $mail->AddAttachment($ruta, 'Comprobante.pdf');
    }

    if (!$mail->Send())
        return "Error: " . $mail->ErrorInfo;
    else
        return 'Mail enviado!';
}

///// impreseion de prestamos empleados
function prestamo_empleado($id, $empresa, $empleado)
{
    global $DSN_Ifx;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();


    $oIfxB = new Dbo;
    $oIfxB->DSN = $DSN_Ifx;
    $oIfxB->Conectar();


    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();

    $oIfxD = new Dbo;
    $oIfxD->DSN = $DSN_Ifx;
    $oIfxD->Conectar();
    $sql = "select empr_ruc_empr, empr_dir_empr, empr_nom_empr, empr_path_logo from saeempr where empr_cod_empr = $empresa ";
    if ($oIfx->Query($sql)) {
        $empr_ruc = $oIfx->f('empr_ruc_empr');
        $empr_dir = $oIfx->f('empr_dir_empr');
        $empr_nom = $oIfx->f('empr_nom_empr');
        $empr_path_logo = $oIfx->f('empr_path_logo');
        $empr_nom .= ' ';
    }
    $sql = "select * from saepret where  pret_cod_empr=$empresa
			and pret_cod_empl='$empleado' and pret_cod_pret='$id'";
    $monto_prest = consulta_string($sql, 'pret_mot_pret', $oIfx, '');
    $pret_fec_pret = consulta_string($sql, 'pret_fec_pret', $oIfx, '');
    $pret_num_cuot = consulta_string($sql, 'pret_num_cuot', $oIfx, '');
    $pret_cont_pret = consulta_string($sql, 'pret_con_pret', $oIfx, '');
    $sql = "select empl_cod_empl, empl_ape_nomb, * from saeempl where
					empl_cod_empr = $empresa and
					  empl_cod_empl='$empleado'
					order by 3";

    $nombre = consulta_string($sql, 'empl_ape_nomb', $oIfx, '');


    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;



    // $path_logo_img = DIR_FACTELEC . 'imagenes/logos/' . $path_img[$count];
    $path_logo_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];




   // echo $path_logo_img;exit;

    $documento = '<table border="0" style="width: 100%; margin-left:50px; margin-top:30px">
				<tr>
				    <td style="font-size:18px; text-align: left"><img src="' . $path_logo_img . '" width="150""><br></td>
				</tr>
				<tr>
					<td style="width: 100%; font-size:18px; text-align: center"><strong>' . $empr_nom . '</strong></td>
				</tr>
				<tr>
					<td  style="width: 100%; font-size:14px; text-align: center"><strong>DIRECCION:' . $empr_dir . '</strong></td>
				</tr>
				<tr>
					<td style="width: 100%; font-size:14px; text-align: center"><strong>RUC:' . $empr_ruc . '</strong><br><br></td>
				</tr>
				<tr>
					<td style="width: 100%; font-size:14px; text-align: left"><strong>EMPLEADO:</strong>' . $empleado_pres . ' ' . $nombre . '</td>
				</tr>
				<tr>
					<td style="width: 100%; font-size:14px; text-align: left"><strong>NUMERO PRESTAMO:</strong>' . $id . '</td>
				</tr>
				<tr>
					<td style="width: 100%; font-size:14px; text-align: left"><strong>CONCEPTO:</strong>' . $pret_cont_pret . '</td>
				</tr>
				<tr>
					<td style="width: 100%; font-size:14px; text-align: left"><strong>FECHA PRESTAMO:</strong>' . $pret_fec_pret . '</td>
				</tr>
				<tr>
					<td style="width: 100%; font-size:14px; text-align: left"><strong>CUOTAS:</strong> ' . $pret_num_cuot . '</td>
				</tr>
				</table>';

    $documento .= '<table class="table table-bordered table-hover table-striped table-condensed" style="width: 80%; margin-bottom: 1px; border:1px solid black; border-radius: 5px; margin-top:10px" align="center">';
    $documento .= '<tr>';
    $documento .= '<td style="width:100%;font-size:15px; text-align: center; border-right:0px solid; border-bottom:1px solid " colspan="7" align="center">TABLA DE AMORTIZACION</td>';
    $documento .= '</tr>';
    $documento .= '<tr >';
    $documento .= '<td  style="width:5%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">No.</td>';
    $documento .= '<td  style="width:15%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">FECHA</td>';
    $documento .= '<td  style="width:15%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">CUOTA</td>';
    $documento .= '<td  style="width:15%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">INTERES</td>';
    $documento .= '<td  style="width:15%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">AMORTIZACION</td>';
    $documento .= '<td  style="width:15%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">SALDO</td>';
    $documento .= '<td  style="width:15%;font-size:12px; text-align: left; border-right:0px solid; border-bottom:1px solid ">ESTADO</td>';
    $documento .= '</tr>';

    $sql = "select * from saepret, saecuot where pret_cod_pret = cuot_cod_pret and pret_cod_empr=$empresa
					and pret_cod_empl='$empleado' and pret_cod_pret='$id'";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $i = 1;
            $saldo = $monto_prest;
            $total_inte = 0;
            $total_pres = 0;
            do {
                $amortiza = ($oIfx->f('cuot_mot_capi') - $oIfx->f('cuot_mot_inte'));
                $saldo -= $amortiza;
                $total_pres += $oIfx->f('cuot_mot_capi');
                $total_inte += $oIfx->f('cuot_mot_inte');
                if ($saldo < 0) {
                    $saldo = 0.00;
                }
                $estado = $oIfx->f('cuot_est_cuot');
                $est = "PAGADO";
                if ($estado == 0) {
                    $est = "PENDIENTE";
                }
                $documento .= '<tr >';
                $documento .= '<td  style="width:5%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . number_format($oIfx->f('cuot_num_cuot'), 2, '.', ',') . '</td>';
                $documento .= '<td  style="width:15%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . $oIfx->f('cuot_fec_venc') . '</td>';
                $documento .= '<td  style="width:5%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . number_format($oIfx->f('cuot_mot_capi'), 2, '.', ',') . '</td>';
                $documento .= '<td  style="width:5%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . number_format($oIfx->f('cuot_mot_inte'), 2, '.', ',') . '</td>';
                $documento .= '<td  style="width:5%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . number_format($amortiza, 2, '.', ',') . '</td>';
                $documento .= '<td  style="width:5%;font-size:12px; text-align: left; border-right:1px solid; border-bottom:1px solid ">' . number_format($saldo, 2, '.', ',') . '</td>';
                $documento .= '<td  style="width:5%;font-size:12px; text-align: left; border-right:0px solid; border-bottom:1px solid ">' . $est . '</td>';

                $documento .= '</tr>';
                $cuota = $oIfx->f('cuot_mot_capi');
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $documento .= '<tr>';
    $documento .= '<td colspan="7" class="bg-danger fecha_letra" align="right">Cuota Fija: ' . number_format($cuota, 2, '.', ',') . '</td>';
    $documento .= '</tr>';
    $documento .= '<tr>';
    $documento .= '<td colspan="7" class="bg-danger fecha_letra" align="right">Interes Total: ' . number_format($total_inte, 2, '.', ',') . '</td>';
    $documento .= '</tr>';
    $documento .= '<tr>';
    $documento .= '<td colspan="7" class="bg-danger fecha_letra" align="right">Total A Pagar: ' . number_format($total_pres, 2, '.', ',') . '</td>';
    $documento .= '</tr>';
    $documento .= '</table>';
    $documento .= '<table style="width:100%; margin-top: 100px" align="center" >
					
					<tr>
						<td style="width:10%"></td>
				    <td style="width:10%; font-size:12px; text-align: center;border-top : 2px solid black;">Ingresado por:<br>' . $usuario . '</td>
						<td style="width:10%;"></td>
						<td style="width:10%;font-size:12px; text-align: center;border-top : 2px solid black;">Aprobado por</td> 
						<td style="width:10%;"></td>	
						<td style="width:10%; font-size:12px; text-align: center;border-top : 2px solid black;">Revisado por:</td> 
						<td style="width:10%;"></td>
						<td style="width:10%; font-size:12px; text-align: center;border-top : 2px solid black;">Recibí Conforme</td> 
						<td style="width:10%;"></td>
					</tr> 
					
					
			</table>';


    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;

    return $documento;

}


function reporte_factura1($empleado = '', $documento1 = '', $empresa = '')
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();


    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    // $idSucursal = $_SESSION['U_SUCURSAL'];
    $logo = '';

    $sql = "select empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr
                                            from saeempr where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
        }
    }
    $oIfx->Free();

    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;
    $path_logo_img = DIR_FACTELEC.'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];

    $sqlvaca = "SELECT  *  FROM comercial.rrhh_solic_vaca where id_empresa='$empresa' and empl_cod_empl='$empleado'";
    if ($oCon->Query($sqlvaca)) {
        if ($oCon->NumFilas() > 0) {

            $codigo = $oCon->f('id');
            $identificacion = $oCon->f('empl_cod_empl');
            $estado = ($oCon->f('estado'));
            $fecha = (($oCon->f('fecha_solicitud')));
            $fecha_realizar = (($oCon->f('fecha_realizar')));
            $observacion = $oCon->f('obs_empl');
            $horas = $oCon->f('horas');
        }
    }
    $oCon->Free();

    //tipo documento
    $sqlnom_empl = "select empl_ape_nomb  from saeempl where empl_cod_empl = '$identificacion' ";
    $name_empl = consulta_string_func($sqlnom_empl, 'empl_ape_nomb', $oIfx, '');


    //$logo .= '<div style="width: 100%; margin: 0px;border-style: solid;">';

    $logo .= '<table style="width: 200%; margin: 0px;" border="0px">';
    $logo .= '<tr><td style="margin-top: 0px;"><img width="200px;" height="50px;" src="' . $path_logo_img . '"></td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 20px;">' . $razonSocial . '</td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 16px;">RUC : ' . $ruc_empr . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '</table>';

    $logo .= '<br>';

    $logo .= '<div style="width: 100%; margin: 0px;border-style: solid;">';
    $logo .= '<strong>El Sr(A). ' . $name_empl . ' de conformidad a lo dispuesto en el articulo 66 del codigo de trabajo,tiene derecho a ' . $horas . ' horas de vacaciones, por lo tanto esta autorizado a utlizar.</strong>';
    $logo .= '</div>';

    $logo .= '<br>';

    $logo .= '<table >
			 <tr>
				<th colspan="2" align="center">SOLICITUD DE VACACIONES</th>
			  </tr>
			  <tr>
				<th>Nombre</th>
				<th>' . $name_empl . '</th>
			  </tr>
			  <tr>
				<td>Identifiacion</td>
				<td>' . $identificacion . '</td>
			  </tr>
			  <tr>
				<td>Estado</td>
				<td>' . $estado . '</td>
			  </tr>
			  <tr>
				<td>Fec Solicitud</td>
				<td>' . $fecha . '</td>
			  </tr>
			  <tr>
				<td>Fec Realizar</td>
				<td>' . $fecha_realizar . '</td>
			  </tr>
			  <tr>
				<td>N Horas</td>
				<td>' . $horas . '</td>
			  </tr>
			  <tr>
				<td>Razon de solicitud</td>
				<td>' . $observacion . '</td>
			  </tr>
			  ';
    $logo .= '</table>';
    $logo .= '<br><br><br>';

    $logo .= '<table >
			  <tr>
				<td>________________________&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;________________________&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;________________________<br><br></td>
				
			  </tr>
			  <tr>
			    <td>DEP.PERSONAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JEFE INMEDIATO&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GERENCIA</td>							
			  </tr>
			  ';
    $logo .= '</table>';

    /*$logo .= '<table style="width: 99%; margin: 0px;" border=1>';
    $logo .= '<tr>';
    $logo .= '<td colspan="2" align="center"  style="width: 55%; border:1px solid black; border-radius: 5px; margin: 0px;">Solicitud de Vacaciones </td>';
	$logo .= '<td align="center"  style="width: 55%; border:1px solid black; border-radius: 5px; margin: 0px;">Solicitud de Vacaciones </td>';
    $logo .= '</tr>';
	$logo .= '</table >';

	$logo .= '<table style="width: 99%; margin: 0px;">';
    $logo .= '<tr>';
    $logo .= '<td align="center" style="width: 55%; border:1px solid black; border-radius: 5px; margin: 0px;">Nombre:</td>';
	$logo .= '<td align="center" style="width: 55%; border:1px solid black; border-radius: 5px; margin: 0px;">'.$name_empl.'</td>';
    $logo .= '</tr>';
	$logo .= '</table >';*/

    //$logo .= '</div>';


    $legend = '<page_footer>
        <table align="center" style="width: 80%">
            <tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">Este comprobante electronico ha sido generado a traves de Sisconti S.A. - Facturacion Electronica</td>
            </tr>
			<tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">www.sisconti.com.ec</td>
            </tr>
        </table>
    </page_footer>';

    $documento .= '<page backimgw="70%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
    //$documento .= '<page >';
    $documento .= $logo;
    //$documento .= $legend;
    $documento .= '</page>';

    //$html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf = new HTML2PDF('P', 'A4', 'fr');
    $html2pdf->WriteHTML($documento);


    $nombre_archivo='SOLICITUD_VACACIONES_'. $identificacion ;
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;

    return $documento;
}


function reporte_aprobacion($empleado = '', $documento1 = '', $empresa = '')
{
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();


    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    // $idSucursal = $_SESSION['U_SUCURSAL'];
    $logo = '';

    $sql = "select empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr
                                            from saeempr where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
        }
    }
    $oIfx->Free();


    $sqlvaca = "SELECT  *  FROM comercial.rrhh_solic_vaca where id_empresa='$empresa' and empl_cod_empl='$empleado'";
    if ($oCon->Query($sqlvaca)) {
        if ($oCon->NumFilas() > 0) {

            $codigo = $oCon->f('id');
            $identificacion = $oCon->f('empl_cod_empl');
            $estado = ($oCon->f('estado'));
            $fecha = (($oCon->f('fecha_solicitud')));
            $fecha_realizar = (($oCon->f('fecha_realizar')));
            $observacion = $oCon->f('obs_empl');
            $horas = $oCon->f('horas');
        }
    }
    $oCon->Free();

    //tipo documento
    $sqlnom_empl = "select empl_ape_nomb  from saeempl where empl_cod_empl = '$identificacion' ";
    $name_empl = consulta_string_func($sqlnom_empl, 'empl_ape_nomb', $oIfx, '');


    //$logo .= '<div style="width: 100%; margin: 0px;border-style: solid;">';

    $logo .= '<table style="width: 200%; margin: 0px;" border="0px">';
    $logo .= '<tr><td style="margin-top: 0px;"><img width="200px;" height="50px;" src="' . $empr_path_logo . '"></td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 20px;">' . $razonSocial . '</td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="center" style="font-size: 16px;">RUC : ' . $ruc_empr . '</td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '</table>';

    $logo .= '<table style="width: 200%; margin: 0px;" border="0px">';
    $logo .= '<tr><td align="center" style="font-size: 20px;">AUTORIZACION</td></tr>';
    $logo .= '</table>';

    $logo .= '<br>';

    $logo .= '<div style="width: 100%; margin: 0px;border-style: solid;">';
    $logo .= '<strong>El Sr(A). ' . $name_empl . ' de conformidad a lo dispuesto en el articulo 66 del codigo de trabajo,tiene derecho a ' . $horas . ' horas de vacaciones, por lo tanto esta autorizado a utlizar.</strong>';
    $logo .= '</div>';

    $logo .= '<br>';

    $logo .= '<table >
			  <tr>
				<th>Nombre</th>
				<th>' . $name_empl . '</th>
			  </tr>
			  <tr>
				<td>Identifiacion</td>
				<td>' . $identificacion . '</td>
			  </tr>
			  <tr>
				<td>Estado</td>
				<td>' . $estado . '</td>
			  </tr>
			  <tr>
				<td>Fec Solicitud</td>
				<td>' . $fecha . '</td>
			  </tr>
			  <tr>
				<td>Fec Realizar</td>
				<td>' . $fecha_realizar . '</td>
			  </tr>
			  <tr>
				<td>N Horas</td>
				<td>' . $horas . '</td>
			  </tr>
			  <tr>
				<td>Razon de solicitud</td>
				<td>' . $observacion . '</td>
			  </tr>
			  ';
    $logo .= '</table>';

    $legend = '<page_footer>
        <table align="center" style="width: 80%">
            <tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">Este comprobante electronico ha sido generado a traves de Sisconti S.A. - Facturacion Electronica</td>
            </tr>
			<tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">www.sisconti.com.ec</td>
            </tr>
        </table>
    </page_footer>';

    $documento .= '<page backimgw="70%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
    //$documento .= '<page >';
    $documento .= $logo;
    //$documento .= $legend;
    $documento .= '</page>';

    //$html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;

    return $documento;
}


function recalculaOrdenRuta($oCon, $oIfx, $idRuta, $orden, $idContrato)
{

    //consulta orden en contrato_clpv
    $sql = "SELECT count(*) as control FROM contrato_clpv WHERE id_ruta = $idRuta AND orden_ruta = $orden";
    $control = consulta_string_func($sql, 'control', $oCon, 0);

    if ($control > 0) {

        //amar codigo
        $sql = "SELECT codigo, digitos FROM isp.int_rutas WHERE id = $idRuta";
        $codigo = consulta_string_func($sql, 'codigo', $oCon, 0);
        $digitos = consulta_string_func($sql, 'digitos', $oCon, 0);

        $tmp = "";
        if (!empty($idContrato)) {
            $tmp = " AND id != $idContrato";
        }

        unset($array);
        $sql = "SELECT id FROM contrato_clpv WHERE id_ruta = $idRuta AND orden_ruta >= $orden AND estado in ('AP') $tmp order by orden_ruta";
        if ($oCon->Query($sql)) {
            if ($oCon->NumFilas() > 0) {
                do {
                    $array[] = array($oCon->f('id'));
                } while ($oCon->SiguienteRegistro());
            }
        }
        $oCon->Free();

        if (count($array) > 0) {
            $j = ($orden + 1);
            foreach ($array as $val) {
                $id = $val[0];

                $j_ok = $j - 1;

                $codigo_ok = $codigo . '' . secuencial_pedido(2, '0', $j_ok, $digitos);

                $sql = "UPDATE contrato_clpv SET orden_ruta_tmp = orden_ruta, ruta_tmp = ruta, orden_ruta = $j, ruta = '$codigo_ok' WHERE id = $id";
                $oCon->QueryT($sql);

                $sql = "UPDATE saedire SET dire_num_ruta = $j, dire_cod_ruta = '$codigo_ok' WHERE dire_cod_contr = $id AND dire_id_ruta = $idRuta";
                $oIfx->QueryT($sql);

                $j++;
            }
        }
    }


}

/**
 * @param string $string
 * @return string
 * FUNCION PARA LIMPIAR STRING DE ESPACIOS Y CARACTERES ESPECIALES (DATATABLES)
 */


function limpiar_string($string = '')
{
    $string = str_replace("  ", "", $string);
    $string = str_replace(PHP_EOL, "", $string);
    $string = str_replace("[\n|\r|\n\r|\t|\0|\x0B]", "", $string);
    $string = str_replace(array("\r\n", "\r"), " ", $string);
    $string = preg_replace("[\n|\r|\n\r]", " ", $string);
    $string = preg_replace("/[\r\n|\n|\r]+/", " ", $string);
    $string = preg_replace('/\s\s+/', ' ', $string);
    $string = trim($string);
    $string = trim(preg_replace('/\s+/', ' ', $string));
    $string = preg_replace("/[\r\n|\n|\r]+/", " ", $string);
    $string = str_replace(PHP_EOL, "", $string);
    $string = str_replace("[\n|\r|\n\r|\t|\0|\x0B]", "", $string);
    $string = str_replace('"', "", $string);
    $string = str_replace("'", "", $string);
    $string = str_replace(array("\r\n", "\r"), " ", $string);

    return $string;

}

function limpiar_string_encode($string = '')
{
    $string = str_replace("  ", "", $string);
    $string = str_replace(PHP_EOL, "", $string);
    $string = str_replace("[\n|\r|\n\r|\t|\0|\x0B]", "", $string);
    $string = str_replace(array("\r\n", "\r"), " ", $string);
    $string = preg_replace("[\n|\r|\n\r]", " ", $string);
    $string = preg_replace("/[\r\n|\n|\r]+/", " ", $string);
    $string = preg_replace('/\s\s+/', ' ', $string);
    $string = trim($string);
    $string = trim(preg_replace('/\s+/', ' ', $string));
    $string = preg_replace("/[\r\n|\n|\r]+/", " ", $string);
    $string = str_replace(PHP_EOL, "", $string);
    $string = str_replace("[\n|\r|\n\r|\t|\0|\x0B]", "", $string);
    $string = str_replace('"', "", $string);
    $string = str_replace("'", "", $string);
    $string = str_replace(array("\r\n", "\r"), " ", $string);

    $string = utf8_encode($string);

    return $string;

}


/**
 * @param $idEmpresa
 * @param $idSucursal
 * @return int|mixed
 * FUNCION OBTENER NUMERO DE DECIMALES CONFIGURACION
 */
function obtener_numero_decimales_jire($idEmpresa, $idSucursal)
{

    global $DSN_Ifx, $DSN;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();
    $numero_des = 0;
    $sql_para = "select  para_num_dec as decimal from saepara WHERE para_cod_empr = $idEmpresa and para_cod_sucu = $idSucursal";
    $numero_des = consulta_string($sql_para, 'decimal', $oIfx, 0);

    if(!$numero_des){
        $numero_des = 2;
    }
    return $numero_des;

}


/**
 * @param $idEmpresa
 * @param $idSucursal
 * @return array
 * FUNCION OBTENER CONFIGRUACION DEL SISTEMA JIRE
 */
function obtener_configuracion_jire($idEmpresa, $idSucursal)
{

    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $sql_conf = "select para_sec_para, para_bod_fact, 
					para_dfa_para, para_cco_zona,
					COALESCE(para_sec_usu,'N') as para_sec_usu,
					para_fact_preimp,
                    para_trn_guia,
                    para_tran_guia,
                    para_bod_guia,
                    COALESCE(para_num_dec, 0) as para_num_dec,
                    para_consig_sn,
                    para_punt_emi,
                    COALESCE(para_ncre_preimp,'N') as para_ncre_preimp,
                    para_orc_clpv,
                    para_bod_grem,
                    para_conv_sn,
                    para_pedi_sn,
                    para_inf_gfac
					from saepara where
					para_cod_empr = $idEmpresa and
					para_cod_sucu = $idSucursal";

    if ($oIfx->Query($sql_conf)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                /** PARAMETROS PEDIDOS **/
                $para_sec_para = $oIfx->f("para_sec_para");
                $para_bod_fact = $oIfx->f("para_bod_fact");
                $para_dfa_para = $oIfx->f("para_dfa_para");
                $para_cco_zona = $oIfx->f("para_cco_zona");
                $para_sec_usu = $oIfx->f("para_sec_usu");
                $para_fact_preimp = $oIfx->f("para_fact_preimp");
                /** PARAMETROS TRANSFERENCIA GUIAS **/
                $para_trn_guia = $oIfx->f("para_trn_guia");
                $para_tran_guia = $oIfx->f("para_tran_guia");
                $para_bod_guia = $oIfx->f("para_bod_guia");

                $para_num_dec = $oIfx->f("para_num_dec");
                $para_consig_sn = $oIfx->f("para_consig_sn");
                $para_punt_emi = $oIfx->f("para_punt_emi");
                $para_ncre_preimp = $oIfx->f("para_ncre_preimp");
                /** PARAMETROS GUIAS */
                $para_orc_clpv = $oIfx->f("para_orc_clpv");
                $para_bod_grem = $oIfx->f("para_bod_grem");
                $para_conv_sn = $oIfx->f("para_conv_sn");
                $para_pedi_sn = $oIfx->f("para_pedi_sn");
                $para_inf_gfac = $oIfx->f("para_inf_gfac");
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    return array(
        $para_sec_para,
        $para_bod_fact,
        $para_dfa_para,
        $para_cco_zona,
        $para_sec_usu,
        $para_fact_preimp,

        $para_trn_guia,
        $para_tran_guia,
        $para_bod_guia,

        $para_num_dec,
        $para_consig_sn,

        $para_punt_emi,
        $para_ncre_preimp,

        $para_orc_clpv,
        $para_bod_grem,
        $para_conv_sn,
        $para_pedi_sn,
        $para_inf_gfac
    );

}

/**
 * @param int $number
 * @param int $n_decimales
 * @param string $separacion_deci
 * @param string $separacion_mil
 * @return string
 * FUNCION FORMATO NUMEROS EN EL SISTEMA
 */
function convert_number_format_jire($number = 0, $n_decimales = 0, $separacion_deci = '.', $separacion_mil = '')
{
    return number_format($number, $n_decimales, $separacion_deci, $separacion_mil);
}

/**
 * @param $fecha
 * @return string
 * FUNCION CONVERTIR FORMATO FECHA JIRE
 */
function formato_fecha_jire($fecha)
{

    $fecha_ = explode('-', $fecha);
    $anio = $fecha_[0];
    $mes = $fecha_[1];
    $dia = $fecha_[2];

    return $dia . '-' . $mes . '-' . $anio;
}

function string_utf8_jire($string)
{
    return ($string);
}

function string_utf8_encode_jire($string)
{
    return ($string);
}

/***
 * VALIDAR LOTE
 */

function validar_existencia_lote_parametros($empresa_id, $sucursal_id, $bodega_id, $cod_producto,$lote)
{

    global $DSN_Ifx, $DSN;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $usuario_web = $_SESSION['U_ID'];
    $fecha_actual = date('Y-m-d');

    $sql_sp = "SELECT * FROM sp_lotes_productos_web( $empresa_id, $sucursal_id, $bodega_id, '2018-01-01', '$fecha_actual', '$cod_producto', '$cod_producto', '2' , $usuario_web,'$lote') ";
//    print_r($sql_sp);exit;
    $oIfx->Query($sql_sp);

    $sql_lote_valido = "select count(*) as existe
			from tmp_prod_lote_web where
			user_cod_web  = $usuario_web and
			bode_cod_bode = $bodega_id and
			empr_cod_empr = $empresa_id and
			sucu_cod_sucu = $sucursal_id
			having  sum(cant_lote) <> 0";


    return consulta_string_func($sql_lote_valido, 'existe', $oIfx, 0);

}

function cantidad_existencia_lote_parametros($empresa_id, $sucursal_id, $bodega_id, $cod_producto,$lote)
{

    global $DSN_Ifx, $DSN;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $usuario_web = $_SESSION['U_ID'];
    $fecha_actual = date('Y-m-d');

    $sql_sp = "SELECT * FROM sp_lotes_productos_web( $empresa_id, $sucursal_id, $bodega_id, '2018-01-01', '$fecha_actual', '$cod_producto', '$cod_producto', '2' , $usuario_web,'$lote') ";
    $oIfx->Query($sql_sp);

    $sql_lote_valido = "select sum(cant_lote) as total
			from tmp_prod_lote_web where
			user_cod_web  = $usuario_web and
			bode_cod_bode = $bodega_id and
			empr_cod_empr = $empresa_id and
			sucu_cod_sucu = $sucursal_id
			having  sum(cant_lote) <> 0";


    return consulta_string_func($sql_lote_valido, 'total', $oIfx, 0);

}

function obtener_configuracion_cre_guias($oIfx, $idEmpresa, $idSucursal)
{
    $sql_conf = "select * from comercial.cre_guia_parametros where
					empr_cod_empr = $idEmpresa and
					sucu_cod_sucu = $idSucursal and
					estado = 1";

    $bodega_term_id = 0;
    $bodega_ppt_id = 0;
    $bodega_tran_id = 0;
    $bodega_fact_id = 0;
    $ejecucion = 0;

    if ($oIfx->Query($sql_conf)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                /** PARAMETROS WS GUIAS **/
                $bodega_term_id = $oIfx->f("bodega_term_id");
                $bodega_ppt_id = $oIfx->f("bodega_ppt_id");
                /** PARAMETROS TRANSFERENCIA GUIAS **/
                $bodega_tran_id = $oIfx->f("bodega_tran_id");
                $bodega_fact_id = $oIfx->f("bodega_fact_id");
                $ejecucion = $oIfx->f("ejecucion");

            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    return array(
        $bodega_term_id,
        $bodega_ppt_id,
        $bodega_tran_id,
        $bodega_fact_id,
        $ejecucion,
    );

}

function obtener_configuracion_saeemifa($idEmpresa, $idSucursal, $tipo_documento = 1)
{

    global $DSN_Ifx, $DSN;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $sql_conf = "select 
    emifa_cod_emifa,
    emifa_cod_empr,
    emifa_cod_sucu,
    emifa_tip_doc,
    emifa_cod_estab,
    emifa_cod_pto,
    emifa_tip_elec,
    emifa_alia_emifa,
    emifa_num_dig,
    emifa_sec_doc,
    emifa_fec_ini,
    emifa_fec_fin,
    emifa_auto_emifa,
    emifa_auto_desde,
    emifa_auto_hasta,
    emifa_edit_emifa,
    emifa_tip_emifa
    from saeemifa 
    where emifa_cod_empr = $idEmpresa
    and emifa_cod_sucu = $idSucursal
    and emifa_cod_emifa = $tipo_documento 
    and emifa_est_emifa = 'S' limit 1;";

    if ($oIfx->Query($sql_conf)) {
        if ($oIfx->NumFilas() > 0) {
            do {

                $emifa_cod_emifa = $oIfx->f("emifa_cod_emifa");
                $emifa_cod_empr = $oIfx->f("emifa_cod_empr");
                $emifa_cod_sucu = $oIfx->f("emifa_cod_sucu");
                $emifa_tip_doc = $oIfx->f("emifa_tip_doc");
                $emifa_cod_estab = $oIfx->f("emifa_cod_estab");
                $emifa_cod_pto = $oIfx->f("emifa_cod_pto");
                $emifa_tip_elec = $oIfx->f("emifa_tip_elec");
                $emifa_alia_emifa = $oIfx->f("emifa_alia_emifa");
                $emifa_num_dig = $oIfx->f("emifa_num_dig");
                $emifa_sec_doc = $oIfx->f("emifa_sec_doc");
                $emifa_fec_ini = $oIfx->f("emifa_fec_ini");
                $emifa_fec_fin = $oIfx->f("emifa_fec_fin");
                $emifa_auto_emifa = $oIfx->f("emifa_auto_emifa");
                $emifa_auto_desde = $oIfx->f("emifa_auto_desde");
                $emifa_auto_hasta = $oIfx->f("emifa_auto_hasta");
                $emifa_edit_emifa = $oIfx->f("emifa_edit_emifa");
                $emifa_tip_emifa = $oIfx->f("emifa_tip_emifa");

            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

    return array(
        $emifa_cod_emifa,
        $emifa_cod_empr,
        $emifa_cod_sucu,
        $emifa_tip_doc,
        $emifa_cod_estab,
        $emifa_cod_pto,
        $emifa_tip_elec,
        $emifa_alia_emifa,
        $emifa_num_dig,
        $emifa_sec_doc,
        $emifa_fec_ini,
        $emifa_fec_fin,
        $emifa_auto_emifa,
        $emifa_auto_desde,
        $emifa_auto_hasta,
        $emifa_edit_emifa,
        $emifa_tip_emifa
    );

}

function secu_pedi_prod($id_empresa, $id_sucursal, $num_dig, $Conexion){
    $sql = "select prpm_sec_orde from saeprpm
                where prpm_cod_empr = $id_empresa and
                prpm_cod_sucu = $id_sucursal ";
    $secuencial = 0;
    if($Conexion->Query($sql)){
        if ($Conexion->NumFilas() > 0){
            $secuencial = $Conexion->f('prpm_sec_orde');
        }else{
            $secuencial = '';
        }
    }
    $Conexion->Free();
    $secuencial = secuencial(2, '', $secuencial, $num_dig);
    return $secuencial;
}

//ENVIO CORREO COMPRAS CRE
function envio_email_auto_tec($correo, $mensaje, $correocc)
{
    //Definiciones
    global $DSN;
    session_start();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $idempresa = $_SESSION['U_EMPRESA'];

    //DATOS DE LA EMPRESA

    $sqlema="select empr_token_api, empr_img_rep, empr_nom_empr, empr_ema_test, empr_ema_sn from saeempr where empr_cod_empr=$idempresa";

    $imgmsj=consulta_string($sqlema,'empr_img_rep',$oCon,'');
    $empr_api_toke=consulta_string($sqlema,'empr_token_api',$oCon,'');
    $nomb_empresa=consulta_string($sqlema,'empr_nom_empr',$oCon,'');
    //CORREO DE PRUEBAS
    $test=consulta_string($sqlema,'empr_ema_sn',$oCon,'');

    //LOGO DE LA EMPRESA PARA CORREOS
    $arc_img = DIR_FACTELEC . "Include/Clases/Formulario/Plugins/reloj/" . basename($imgmsj);


    if (file_exists($arc_img)) {
        $extension = pathinfo($arc_img, PATHINFO_EXTENSION);
        $archivo = file_get_contents($arc_img);
        $imagen_base64=base64_encode($archivo);

    } else {
        $imagen_base64=null;
    }
    $imagencorreo=$imagen_base64;

    //PARAMETROS ENVIO DE CORREOS

    $sqlcorreo = "select server, port, auth, 
    config_email.user, pass, ssltls, mail
    from comercial.config_email
    where id_empresa = $idempresa";

    if ($oCon->Query($sqlcorreo)) {
        if ($oCon->NumFilas() > 0) {
            $host = $oCon->f('server');
            $port = $oCon->f('port');
            $smtpauth = $oCon->f('auth');
            $userid = $oCon->f('user');
            $smtpsecure = $oCon->f('ssltls');
            $mailenvio = $oCon->f('mail');
            $password = $oCon->f('pass');

        }
    }
    $oCon->Free();



    //CONSTRUCCION PARAMETROS WEB SERVICE

    $headers = array(
        "Content-Type:application/json",
        "Token-Api:$empr_api_toke"
    );

    //$adj = '';

    $smtp_server = "{$host}:{$port}";

    $data = array(
        "smtp_server" => $smtp_server,
        "secure_type" => $smtpsecure,
        "username" => $userid,
        "password" => $password,
        "from_address" => $mailenvio,
        "to_address" =>  $correo,
        "to_cc" =>  $correocc,
        "title" => "BIENVENIDOS AL SISTEMA INTEGRAL DE $nomb_empresa - SOLICITUD DE PAGOS",
        "content" => $mensaje,
        // "attachments" => $adj,
        // "images" => array(array("image_id"=>"<cruzroja01>", "content"=>$imagencorreo))
    );



    $ch = curl_init();
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_URL, URL_JIREH_WS_CORREOS."/api/v1/correo/enviar");
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $respuesta = curl_exec($ch);
    curl_close($ch);
    $resultado = json_decode($respuesta,true);
    $mensaje = $resultado["msg"];
    $enviado = $resultado["result"];


    foreach($correo as $cor){
        $destinatarios.=$cor.' ';
    }

    if($enviado == true){
        $msg="Mail enviado a: $destinatarios";
    }else{
        $msg="Error al enviar email: $mensaje";
    }


    return $msg;

}


function consultarTranXSucursalCre($oIfx, $tran_cod_empr, $tran_cod_sucu, $like_tran = '' ,$tran_cod_modu = 4){

    $sql_consulta = "select tran_cod_tran, tran_des_tran, trans_tip_tran from saetran where tran_cod_tran like '$like_tran%'	and
    tran_cod_empr = $tran_cod_empr and
    tran_cod_sucu = $tran_cod_sucu and
    tran_cod_modu = $tran_cod_modu limit 1;";

    $codigo = consulta_string_func($sql_consulta, 'tran_cod_tran', $oIfx, '');

    return $codigo;
}

function envio_correo_inventarios($emails = '', $ruta_pdf = '', $nombre_modulo = '') {

    include_once(path(DIR_INCLUDE) . "class.phpmailer.php");
    include_once(path(DIR_INCLUDE) . "class.smtp.php");
    global $DSN_Ifx, $DSN;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    //variables de session
    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idSucursal = $_SESSION['U_SUCURSAL'];

    $array_emails = explode(";", $emails);
    $array_mail_send = array();
    $existe = 'N';

    foreach ($array_emails as $key => $email) {
        array_push($array_mail_send, $email);
        $existe = 'S';
    }

    if($existe == 'N'){
        array_push($array_mail_send, $emails);
    }

    // $sql = "select empr_nom_empr, empr_dir_empr from saeempr where empr_cod_empr = $idEmpresa";
    // $empr_nom_empr = consulta_string($sql, 'empr_nom_empr', $oIfx, '');

    $sqlSmtp = "select server, port, auth, 
			user, pass, ssltls, 
			mail 
			from comercial.config_email
			where id_empresa = $idEmpresa and
			id_tipo =1";
    if ($oCon->Query($sqlSmtp)) {
        if ($oCon->NumFilas() > 0) {
            $host = $oCon->f('server');
            $port = $oCon->f('port');
            $smtpauth = $oCon->f('auth');
            $userid = $oCon->f('mail');
            $smtpsecure = $oCon->f('ssltls');
            $mailenvio = $oCon->f('mail');
            $password = $oCon->f('pass');
        }
    }
    $oCon->Free();


    $headers = array(
        "Content-Type:application/json",
        "Token-Api:e02e580c-9020-40f8-8c57-f14ffb1bdadf"
    );

    $adj = array();

    if (file_exists($ruta_pdf)) {
        $archivo = file_get_contents($ruta_pdf);
        $archivo= basename($ruta_pdf).'::'.base64_encode($archivo);
        array_push($adj, $archivo);
    }

    $asunto = 'DIARIO CONTABLE '. $nombre_modulo;
    $html = "<strong>Se ha realizado un movimiento de ".$nombre_modulo.". Se ha generado el Diario existosamente...</strong><br /><br />";
    $html .= "<font color='blue'>Adjunto Diario Contable</font>";

    $data = array(
        "host" => $host,
        "port" => $port,
        "secure_type" => $smtpsecure,
        "from_address" => $mailenvio,
        "from_name" => $mailenvio,
        "to_address" =>  $array_mail_send[0], //correo destinatario
        "to_cc" =>  $array_mail_send[1], //copia a
        // "to_address" => 'franklinalvarez88888@gmail.com', //correo destinatario
        // "to_cc" =>  'franklin.alvarez@sisconti.com', //copia a
        "subject" => $asunto,
        "username" => $userid,
        "password" => $password,
        "body" => $html,
        "archivo_ride" => '',
        "archivo_xml" => '',
        "multiples_adjuntos" =>$adj,
        //"multiples_imagenes" => array(),
        //        "guia_pdf" => ""
    );

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_URL, URL_JIREH_WS."/api/correo/enviar");
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $respuesta = curl_exec($ch);
    //    print_r($respuesta);exit;
    $resultado = json_decode($respuesta,true);
    $enviado = $resultado["enviado"];


    if($enviado == true){
        return 1;
    }else{
        return "Error al enviar email";
    }
}


// as_cod_pro2 char(35), as_cos_prod char(1), in_user
function lotes_prod( $an_cod_empr,  $an_cod_sucu, $an_cod_bode, $ada_feci,
                     $ada_fecf,	    $as_cod_prod, $as_cod_pro2, $as_cos_prod,
                     $in_user,      $Conexion,    $Conexion_MySql ){
    $sql = "delete from prod_lote where usuario = $in_user and prod_cod_prod = '$as_cod_prod'  ";
    $Conexion_MySql->QueryT($sql);

    $sql = "select 
			case defi_tip_defi
				when '0' then dmov_can_dmov
				when '1' then - dmov_can_dmov
				when '5' then  dmov_can_dmov
				when '6' then - dmov_can_dmov
			end dmov_can_dmov , dmov_cod_lote, dmov_ela_lote, dmov_cad_lote
			from saeprbo, saeprod, saedmov, saeminv, saetran, saedefi
			where prbo_cod_prod = prod_cod_prod
			and prbo_cod_empr = prod_cod_empr
			and prbo_cod_sucu = prod_cod_sucu
			and prod_cod_prod = dmov_cod_prod
			and prod_cod_empr = dmov_cod_empr
			and dmov_num_comp = minv_num_comp
			and dmov_num_prdo = minv_num_prdo
			and dmov_cod_empr = minv_cod_empr
			and dmov_cod_ejer = minv_cod_ejer
			and minv_cod_tran = tran_cod_tran
			and minv_cod_empr = tran_cod_empr
			and minv_cod_modu = tran_cod_modu
			and tran_cod_tran = defi_cod_tran
			and tran_cod_empr = defi_cod_empr
			and tran_cod_modu = defi_cod_modu
			and prbo_cod_bode = $an_cod_bode
			and prbo_cod_empr = $an_cod_empr
			and prbo_cod_sucu = $an_cod_sucu
			and prbo_cos_prod = '$as_cos_prod'
			and dmov_cod_lote not like ''
			and dmov_can_dmov > 0
			and prod_cod_prod between '$as_cod_prod' and '$as_cod_pro2'
			and dmov_cod_bode = $an_cod_bode
			and minv_fmov between  '$ada_feci'  and '$ada_fecf'  
			and minv_cod_empr = $an_cod_empr
			and defi_tip_defi in ('0','1','5','6')
			union all
			select 
			case defi_tip_defi
				when '0' then dmov_can_dmov
				when '1' then - dmov_can_dmov
				when '5' then  dmov_can_dmov
				when '6' then dmov_can_dmov
			end dmov_can_dmov,  dmov_cod_lote, dmov_ela_lote, dmov_cad_lote
			from saeprbo, saeprod, saedmov, saeminv,saetran, saedefi
			where prbo_cod_prod = prod_cod_prod
			and prbo_cod_empr = prod_cod_empr
			and prbo_cod_sucu = prod_cod_sucu
			and prod_cod_prod = dmov_cod_prod
			and prod_cod_empr = dmov_cod_empr
			and dmov_num_comp = minv_num_comp
			and dmov_num_prdo = minv_num_prdo
			and dmov_cod_empr = minv_cod_empr
			and dmov_cod_ejer = minv_cod_ejer
			and minv_cod_tran = tran_cod_tran
			and minv_cod_empr = tran_cod_empr
			and minv_cod_modu = tran_cod_modu
			and tran_cod_tran = defi_cod_tran
			and tran_cod_empr = defi_cod_empr
			and tran_cod_modu = defi_cod_modu
			and prbo_cod_bode = $an_cod_bode
			and prbo_cod_empr = $an_cod_empr
			and prbo_cod_sucu = $an_cod_sucu
			and prbo_cos_prod = '$as_cos_prod'
			and dmov_can_dmov > 0
			and dmov_cod_lote not like ''
			and prod_cod_prod between '$as_cod_prod' and '$as_cod_pro2'
			and dmov_bod_envi = $an_cod_bode
			and minv_fmov between  '$ada_feci'  and '$ada_fecf' 
			and minv_cod_empr = $an_cod_empr
			and defi_tip_defi in ('0','1','5','6') ";
    if($Conexion->Query($sql)){
        if($Conexion->NumFilas()>0){
            do{
                // dmov_can_dmov , dmov_cod_lote, dmov_ela_lote, dmov_cad_lote
                $dmov_cant = $Conexion->f('dmov_can_dmov');
                $dmov_lote = $Conexion->f('dmov_cod_lote');
                $dmov_ela  = $Conexion->f('dmov_ela_lote');
                $dmov_cad  = $Conexion->f('dmov_cad_lote');
                // sql
                $sql = "insert into prod_lote ( empr_cod_empr,   bode_cod_bode,  prod_cod_prod,"
                    . "                cant,            lote,           ela,"
                    . "                cad,             usuario,        fecha_corte  )"
                    . "       values(  $an_cod_empr,    $an_cod_bode,   '$as_cod_prod',"
                    . "                '$dmov_cant',   '$dmov_lote',    '$dmov_ela' ,"
                    . "                '$dmov_cad',     $in_user,       now() ) ";
                $Conexion_MySql->QueryT($sql);
                //$array [$as_cod_prod][$dmov_lote][$dmov_ela][$dmov_cad] += $dmov_cant;
            }while($Conexion->SiguienteRegistro());
        }
    }
    $Conexion->Free ();

    $sql = "select sum(l.cant) as cant,
                l.lote, l.ela, l.cad
                from prod_lote l where
                l.empr_cod_empr = $an_cod_empr and
                l.bode_cod_bode = $an_cod_bode and
                l.prod_cod_prod = '$as_cod_prod' and
                l.usuario       = $in_user
                group by 2,3,4
                having  sum(l.cant) > 0
                order by 3,2 ";
    unset($array);
    if($Conexion_MySql->Query($sql)){
        if($Conexion_MySql->NumFilas()>0){
            do{
                $array [] = array( $Conexion_MySql->f('cant'),      $Conexion_MySql->f('lote'),
                    $Conexion_MySql->f('ela'),       $Conexion_MySql->f('cad') );
            }while($Conexion_MySql->SiguienteRegistro());
        }
    }
    $Conexion_MySql->Free ();

    return $array;
}



function reporte_despacho_agricola($planes_array)
{

    //echo "dentro";exit;
    global $DSN_Ifx, $DSN, $DSN_Agr;

    session_start();
    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oIfxB = new Dbo;
    $oIfxB->DSN = $oIfx;
    $oIfxB->Conectar();


    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();


    $oCnx = new Dbo();
    $oCnx->DSN = $DSN;
    $oCnx->Conectar();





    $logo = '';

    $idEmpresa = $_SESSION['U_EMPRESA'];
    // $idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_ac2_empr, empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr
                                             from saeempr where empr_cod_empr = $idEmpresa ";

    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
            $empr_ac2_empr = trim($oIfx->f('empr_ac2_empr'));
        }
    }
    $oIfx->Free();
    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;
    $arc_img =  DIR_INCLUDE.'Clases/Formulario/Plugins/reloj/'.$path_img[$count];


    if (file_exists($arc_img)) {
        $imagen = $arc_img;
    } else {
        $imagen = '';
    }
    $logo = '';
    $x = '0px';

    if ($imagen != '') {

        $empr_logo = '<div><img src="' . $imagen . '" style="width:150px;object-fit; contain;"></div>';
    } else {
        $empr_logo = '<span><font color="red">SIN LOGO</font></span>';
    }

    $today = date("Y-m-d");

    $cabecera = '';
    $sql="SELECT max(numero_autoriza) as secuencial from agricola.planificacion";
    $secuencial = consulta_string($sql, 'secuencial', $oIfxC, '');



    $cabecera .= '<table border="1" cellpadding="2" style="font-size: 7px;">
        <tr>
         <td rowspan="2" width="30%">' . $empr_logo . '</td>
         <td align="center"><b>REGISTRO</b><br></td>  
         <td rowspan="2"> <b>CODIGO:</b>    <br><br>
         <b>FECHA:</b>  ' . $today . ' <br><br>
         <b>SISTEMA JIREH WEB</b></td>   
        </tr>
        <tr>
        <td align="center"><br><br>ORDEN DE APLICACION DIARIA<br><b># '.$secuencial.'</b></td>
        
        </tr>';
    $cabecera .= '</table> <br><br>';




    //DATOS DEL INFROME PRIMERA TABLA

    $cuerpo = '';
    $cuerpo .= '<table border="1" cellpadding="2" style="font-size: 7px;">
        
        <tr style="font-size: 7px;" >
                    
        
                   <td rowspan="2"><b>#ORDEN DESPACHO</b></td>
                   <td rowspan="2" style="width:70px"><b>HECTAREAS</b></td>
                   <td rowspan="2"><b>LOTE</b></td>
                   <td rowspan="2"><b>BLOQUES</b></td>
                   <td rowspan="2"style="width:90px"><b>APLICACION</b></td>
                   <td rowspan="2"style="width:50px"><b>M.APLIC</b></td>
                   <td rowspan="2" style="width:70px"><b>CICLO</b></td>
                   <td rowspan="2"style="width:40px"><b>AGUA</b></td>
                   <td align="center"; style="width:50px"><b>EJEC.</b></td>
                  
        </tr>
        <tr style="font-size: 9px;">
        <td style="width:25px"><b>SI</b></td>
        <td style="width:25px"><b>NO</b></td>
        </tr>
       ';

    $total_hec = 0;
    $total_agua_2 = 0;
    $cuantificadores = 0;

    // var_dump($planes_array);exit;
    foreach ($planes_array as $key => $planes) {
        $id    = $planes;

        $sql = "SELECT
        p.plan_id,
        p.planificacion_nombre,
        pg.siem_des_siem,
        pg.siem_hec_siem,
        cicl_cod_cicl,
        p.planificacion_estado,
        pg.sici_cod_fapr_sem,
        p.siem_cod_siem,
        pg.siem_cod_ppblo,
        p.sici_sem_apli
        from agricola.planificacion p , agricola.plani_prog pg where 
        p.plan_id= pg.id_cabecera and 
        plan_id =$id";






        if ($oIfx->Query($sql)) {
            if ($oIfx->NumFilas() > 0) {
                $i = 1;
                $plan_id = $oIfx->f('plan_id');
                $planificacion_nombre = $oIfx->f('planificacion_nombre');
                $siem_des_siem = $oIfx->f('siem_des_siem');
                $siem_hec_siem = $oIfx->f('siem_hec_siem');
                $cicl_cod_cicl = $oIfx->f('cicl_cod_cicl');
                $cod_fapr = $oIfx->f('sici_cod_fapr_sem');
                $siem_cod_siem = $oIfx->f('siem_cod_siem');
                $sici_sem_apli = $oIfx->f('sici_sem_apli');
                $siem_cod_ppblo = $oIfx->f('siem_cod_ppblo');


                $total_hec += $siem_hec_siem;



                $cuerpo .= '<tr style="font-size: 9px;">';

                $sql_f = "SELECT mp_can_agua from  agricola.plan_mp
                where plan_planifi_id =$plan_id";
                $total_agua = consulta_string($sql_f, 'mp_can_agua', $oIfxC, '');

                if (empty($total_agua)) {
                    $sql_q = "SELECT mp_can_agua from  agricola.plan_in
                    where plan_in_id_recetas =$plan_id";
                    $total_agua = consulta_string($sql_q, 'mp_can_agua', $oIfxC, '');
                    //echo "vacio";exit;
                }

                //echo $total_agua;exit;

                $a_x_h = ($total_agua * $siem_hec_siem);



                $total_agua_2 += $a_x_h;

                //$total_agua_2=number_format($total_agua_2,0,'.',',');
                $a_x_h = number_format($a_x_h, 0, '.', ',');


                // echo $total_agua_2;exit;



                $sql_q = "SELECT sum(q.mp_can_agua) as agua_quimicos 
                from agricola.plan_in q where  plan_in_id_recetas=$plan_id";
                $agua_quim = consulta_string($sql_q, 'agua_quimicos', $oIfxC, '');


                // $agua_x_registro=($agua_fer+$agua_quim);

                // $total_agua +=$agua_x_registro;


                $sql_cicl = "SELECT cicl_dec_cicl from agricola.saepcicl where cicl_cod_cicl =$cicl_cod_cicl";
                $ciclo_name = consulta_string($sql_cicl, 'cicl_dec_cicl', $oIfxC, '');


                $sql = "SELECT fapr_des_facr from agricola.saepfapr where fapr_cod_fapr =$cod_fapr";
                $aplicacion = consulta_string($sql, 'fapr_des_facr', $oIfxC, '');

                $sql = "SELECT siem_cod_bloq from agricola.saepsiem where siem_cod_siem =$siem_cod_siem";
                $bloq = consulta_string($sql, 'siem_cod_bloq', $oIfxC, '');

                //echo $bloq;exit;

                $sql = "SELECT ppblo_bloq_ppblo from agricola.saeppblo where ppblo_cod_ppblo =$siem_cod_ppblo";
               // echo $sql;exit;
                $bloques = consulta_string($sql, 'ppblo_bloq_ppblo', $oIfxC, '');


                $cuantificadores = $id . ', ';






                $cuerpo .= '
                    <td style="font-size: 7px;">' . strtoupper($plan_id) . '</td>
                    <td style="font-size: 7px;">' . strtoupper($siem_hec_siem) . '</td>
                    <td style="font-size: 7px;">' . strtoupper($siem_des_siem) . '</td>
                    <td style="font-size: 7px;">' . strtoupper($bloques) . '</td>
                    <td style="font-size: 7px;">' . strtoupper($aplicacion) . '</td>
                    <td style="font-size: 7px;">S.Boom</td>
                    <td style="font-size: 7px;">' . strtoupper($ciclo_name) . '</td>
                    <td style="font-size: 7px;">' . strtoupper($a_x_h) . '</td>
                    <td style="font-size: 7px;"></td>
                    <td style="font-size: 7px;"></td>
    
                      
                   </tr>';
            }
        }

        $i++;
    }

    $cuerpo .= '</table> <br><br>';





    $cuerpo_detalle2 = '<br><br>';
    $cuerpo_detalle2 .= '<table border="1" cellpadding="2" style="font-size: 7px;">
        <tr>
        <td><br>
        <b style="color:red">   APLICACION REAL: ' . $aplicacion . '</b><br>                        
        <b>FECHA: ___________________________________</b><br>                   
        <b>HORA: ____________________________________</b><br>
        </td>

        <td>
        <b>AGUA HA: </b> ' . $total_agua . ' litros/ha <br>
        <b>AGUA</b>: ' . $total_agua_2 . ' litros <br>
        <b>MARCHA</b>: ___________________________________<br>
        <b>PH</b>: ________________________________________<br>
        </td>
        </tr>
        <br><br>
        
        </table><br><br>';

    $equipo_protec = '../imagenes/agricola/equipo_de_porteccion.jpg';
    $imgen = $equipo_protec;


    $cuerpo_detalle2 .= '
        <table style="font-size: 7px;">
        <tr>
        <b style="color:red">EQUIPO DE PROTECCION:</b><br>
       
       
        <td><div><img src="' . $imgen . '" style="width:450px;object-fit; contain;"></div></td><br><br>
        </tr>';

    $cuerpo_detalle2 .= '</table><br><br>';





    $clim =  '../imagenes/agricola/clima.jpg';
    $clima = $clim;

    //DETALLE DEL INFROME CLIMA

    $cuerpo2 = '';
    $cuerpo2 .= '
        <table style="font-size: 7px;">
        <tr>
        <b style="color:red">CLIMATOLOGIA:</b><br>
       
       
        <td><div><img src="' . $clima . '" style="width:300px;object-fit; contain;"></div></td><br><br>
        </tr>';

    $cuerpo2 .= '</table><br><br>';


    //DETALLE DEL INFROME TABLA 2
    
    
    //FORMULAS DE CARGA AGUILON POR LITROS DE AGUA
    $cuerpo_fin = '';
    $c_completa = floor($total_agua_2 / 3000);
    $hec_comp = floor($total_hec);

    //echo $total_hec;exit;
    if ($c_completa > 0) {
        $hec_com = ($hec_comp / $c_completa);
    }
    $hec_inc = ($total_hec - $hec_comp);

    //CARGAS A 6000 = 0.5
    if($total_agua==6000){

        $res=0.5;

        $hec_inc = ($total_hec - $hec_comp);
        $res_hec = $hec_inc/$res;
        $hec_inc_cont = floor($res_hec);
        $hec_inc= $hec_inc-($hec_inc_cont *$res);
        $hec_com=0.5;
    }

     //CARGAS A 12000 = 0.25

    if($total_agua==12000){
        $res=0.25;

        $hec_inc = ($total_hec - $hec_comp);
        $res_hec = $hec_inc/$res;
        $hec_inc_cont = floor($res_hec);
        $hec_inc= $hec_inc-($hec_inc_cont *$res);
        $hec_com=0.25;

    }elseif($total_agua==2000){

        $res=1.5;
        $res_hec = $total_hec/$res;
        $hec_inc_cont = floor($res_hec);
        if($hec_inc_cont==0){
            $hec_inc=$total_hec;
        }else{
        $hec_inc= $total_hec-($hec_inc_cont *$res);
          }

        $hec_com=1.5;

    }



    $residuo = $total_agua_2 - ($c_completa * $total_agua);


    if ($c_completa == 0) {
        $agua_completa = 0;
        $residu = $residuo;
    } else {
        $agua_completa = (3000);
        $residu = $total_agua_2 - (3000 * $c_completa);
    }
    $cuerpo_fin .= '<table border="1" cellpadding="2" style="font-size: 7px;">
        
        <tr  >
                   <td style="color:red; width: 185px;" align="center"><b>PRODUCTO</b></td>
                   <td style="color:red; width: 65px;" align="center"><b>DOSIS HA</b></td>
                   <td><b>CARGAS COMPLETAS: ' . $c_completa . '</b></td>
                   <td><b>CARGA INCOMPLETA: ' . $hec_inc . '</b></td>
                   <td style="width: 65px;"><b>TOTAL</b></td>
                   <td style="width: 65px;"><b>UNIDAD</b></td>
        </tr>
       ';


    $dentro_cuerpo_fin = "";
    foreach ($planes_array as $key => $planes) {

        if ($key == 0) {
            $id    = $planes;

            $sql = "SELECT
        p.plan_id
       
        from agricola.planificacion p , agricola.plani_prog pg where 
        p.plan_id= pg.id_cabecera and 
        plan_id =$id";

            //fertilizante
            $sql_f = "SELECT  prod_nom_prod,unid_sigl_unid,recetas_mp_cantidad,prod_x_h
                from agricola.plan_mp 
                where plan_planifi_id =$plan_id";



            //echo $sql_f;exit;

            if ($oIfx->Query($sql_f)) {
                if ($oIfx->NumFilas() > 0) {
                    $i = 1;
                    do {



                        $prod_nom_prod = $oIfx->f('prod_nom_prod');
                        $unid_sigl_unid = $oIfx->f('unid_sigl_unid');
                        $recetas_mp_canti = $oIfx->f('recetas_mp_cantidad');
                        $prod_x_h = $oIfx->f('prod_x_h');

                        // echo $prod_x_h;exit;


                        //echo $recetas_mp_canti;exit;
                        if ($c_completa == 0) {
                            $recetas_mp_cantidad = 0;
                        } else {
                            $recetas_mp_can = ($hec_com * $recetas_mp_canti);
                        }

                        $incom = ($total_hec - $c_completa);



                        $total_incom = ($hec_inc * $recetas_mp_canti);

                        $total = ($recetas_mp_can * $c_completa);

                        $total_fer = ($total + $total_incom);



                        $agua = ($total_agua * $c_completa);

                        $total_agua_fer = ($agua + $residuo);

                        $prod=$prod_nom_prod .'- ds -'. $recetas_mp_canti;


                        $dentro_cuerpo_fin .= ' 
                            <tr>
                                <td>' . strtoupper($prod_nom_prod) . '</td>
                                <td>' . strtoupper($recetas_mp_canti) . '</td>
                                <td>' . strtoupper($recetas_mp_can) . '</td>
                                <td>' . $total_incom . '</td>
                                <td>' . $total_fer . '</td>
                                <td>' . strtoupper($unid_sigl_unid) . '</td>
                                                                        
                            </tr>

                            ';




                        $i++;
                    } while ($oIfx->SiguienteRegistro());
                }
            }
        }
    }



    $cuerpo_fin .= '' . $dentro_cuerpo_fin . '';



    $cuerpo_fin .= '</table>';


    $dentro_cuerpo_fin2 = "";
    $cuerpo_fin .= '<table border="1" cellpadding="2" style="font-size: 7px;">';

    $dentro_cuerpo_fin2 = "";


    foreach ($planes_array as $key => $planes) {

        if ($key == 0) {

            $id    = $planes;

            $sql = "SELECT
        p.plan_id,
        p.sici_tip_apli
       
        from agricola.planificacion p , agricola.plani_prog pg where 
        p.plan_id= pg.id_cabecera and 
        plan_id =$id";

            $plan_id = consulta_string($sql, 'plan_id', $oIfxC, '');
            $sici_tip_apli = consulta_string($sql, 'sici_tip_apli', $oIfxC, '');


            $sql="SELECT lcam_nom_lcam from agricola.saelcam where lcam_cod_letra='$sici_tip_apli'";
            $sici_tip_apli = consulta_string($sql, 'lcam_nom_lcam', $oIfxC, '');
            //echo $sql;exit;
            //  echo "si";exit;

            //fertilizante
            $sql_f = "SELECT  prod_nom_prod,unid_sigl_unid,recetas_in_cantidad,prod_x_h
                from agricola.plan_in   
                where plan_in_id_recetas =$plan_id";



            if ($oIfx->Query($sql_f)) {
                if ($oIfx->NumFilas() > 0) {
                    $i = 1;
                    do {


                        $prod_nom_prod = $oIfx->f('prod_nom_prod');
                        $unid_sigl_unid = $oIfx->f('unid_sigl_unid');
                        $recetas_mp_canti = $oIfx->f('recetas_in_cantidad');
                        $prod_x_h = $oIfx->f('prod_x_h');


                        //echo $prod_x_h;exit;

                        if ($c_completa == 0) {
                            $recetas_mp_cantidad = 0;
                        } else {
                            $recetas_mp_can = ($hec_com * $recetas_mp_canti);
                        }



                        $incom = ($total_hec - $c_completa);



                        $total_incom = ($hec_inc * $recetas_mp_canti);

                        $total = ($recetas_mp_can * $c_completa);

                        $total_fer = ($total + $total_incom);



                        $agua = ($total_agua * $c_completa);

                        $total_agua_fer = ($agua + $residuo);

                        $prod=$prod_nom_prod .'- ds -'. $recetas_mp_canti;


                        $dentro_cuerpo_fin2 .= ' 
                            <tr style="font-size: 9px;">
                                <td style="width: 185px;">' . strtoupper($prod_nom_prod) .'</td>
                                <td style="width: 65px;">' . strtoupper($recetas_mp_canti) .'</td>
                                <td>' . strtoupper($recetas_mp_can) . '</td>
                                <td>' . $total_incom . '</td>
                                <td style="width: 65px;">' . $total_fer . '</td>
                                <td style="width: 65px;">' . strtoupper($unid_sigl_unid) . '</td>
                                                                        
                            </tr>


                            ';


                        $i++;
                    } while ($oIfx->SiguienteRegistro());
                }
            }
        }
    }


    $cuerpo_fin .= '' . $dentro_cuerpo_fin2 . '';

    $cuerpo_fin .= '   <tr>
    <td style="color:red"><b>TOTAL AGUA</b></td>
    <td></td> 
    <td>' . $agua_completa . '</td> 
    <td>' . strtoupper($residu) . ' lts</td>  
    <td>' . strtoupper($total_agua_fer) . '</td>  
    <td>LITROS</td>                              
 </tr>
 ';
    $cuerpo_fin .= '</table><br><br>';

    $cuerpo_fin .= '  <b>OBSERVACIONES :</b> _____________________________________________________________________<br><br><br><br>';

    $cuerpo_detalle = '';
    $cuerpo_detalle .= '<table border="1" cellpadding="2">
        <tr style="font-size: 7px;">
        <td><br>
        <b>CULTIVO:</b> PIÑA VARIEDAD GOLDEN MD2<br>                       
        <b>HECTAREAJE</b>: ' . $total_hec . ' hectareas<br>             
        <b>CUANTIFICADORES: </b> ' . $cuantificadores . '<br>
        <b>ETAPA</b>: ' . $sici_tip_apli . '<br>
 
       
        </td>

        <td>
        <b>SEMANA</b>: ' . $sici_sem_apli . '<br>
        <b>FECHA</b>: ' . $today . '<br>
        <b>AGUILON</b>:______________________________<br>
        <b>OPERADOR</b>:___________________________<br>
        </td>
        </tr>
       ';

    $cuerpo_detalle .= '</table>';

    //FRIMAS Y FIN DEL INFROME
    $fin = '';
    $fin .= '<table cellpadding="2" style="font-size: 7px;">
        <tr>
        <td align="center">___________________</td>
        <td align="center">___________________</td>
        <td align="center">___________________</td> 
        <td align="center">___________________</td> 
        </tr>

        <tr style="font-size: 9px;" >
        <td align="center"><b>Tecnico Responsable</b><br><b>Ing. Emilio Vite </b></td>
        <td align="center"><b>Bodeguero</b></td>
        <td align="center"><b>Operador</b></td>
        <td align="center"><b> Supervisor de Aplicaciones</b></td>
        </tr>
        ';
    $fin .= '</table>';




    $documento = $cabecera . $cuerpo_detalle . $cuerpo_detalle2 . $cuerpo . $cuerpo2 . $cuerpo_fin . $fin;
    //echo $documento;exit;
    return $documento;
}



function reporte_despacho_agricola_contabilidad($planes_array)
{
    global $DSN_Ifx, $DSN, $DSN_Agr;

    session_start();
    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oIfxB = new Dbo;
    $oIfxB->DSN = $DSN_Ifx;
    $oIfxB->Conectar();

    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();

    $oCnx = new Dbo();
    $oCnx->DSN = $DSN;
    $oCnx->Conectar();


    /* $oIfxA = new Dbo;
     $oIfxA->DSN = $DSN_Ifx;
     $oIfxA->Conectar();
     */

    $logo = '';

    $idEmpresa = $_SESSION['U_EMPRESA'];
    // $idSucursal = $_SESSION['U_SUCURSAL'];

    $sql = "select empr_ac2_empr, empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr
                                             from saeempr where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
            $empr_ac2_empr = trim($oIfx->f('empr_ac2_empr'));
        }
    }
    $oIfx->Free();


    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;
    $arc_img =  DIR_INCLUDE.'Clases/Formulario/Plugins/reloj/'.$path_img[$count];



    if (file_exists($arc_img)) {
        $imagen = $arc_img;
    } else {
        $imagen = '';
    }
    $logo = '';
    $x = '0px';
    if ($imagen != '') {

        $empr_logo = '<div><img src="' . $imagen . '" style="width:150px;object-fit; contain;"></div>';
    } else {
        $empr_logo = '<span><font color="red">SIN LOGO</font></span>';
    }

    $today = date("Y-m-d");



    //PRIMERA IFNROMACION DEL REPROTE
    $cabecera = '';
    $sql="SELECT max(numero_autoriza) as secuencial from agricola.planificacion";
    $secuencial = consulta_string($sql, 'secuencial', $oIfxC, '');
    $cabecera .= '<table border="1" cellpadding="2">
        <tr>
         <td rowspan="2" width="30%">' . $empr_logo . '</td>
         <td align="center"><b>REGISTRO</b><br></td>  
         <td rowspan="2"> <b>CODIGO:</b>    <br><br>
         <b>FECHA:</b>  ' . $today . ' <br><br>
         <b>SISTEMA JIREH WEB</b></td>   
        </tr>
        <tr>
        <td align="center"><br><br>ORDEN DE APLICACION DIARIA <br> <b># '.$secuencial.'</b></td>
        
        </tr>';
    $cabecera .= '</table> <br><br>';


    //------------
    $total_hec = 0;

    $cuantificadores = 0;
    foreach ($planes_array as $key => $planes) {
        $id    = $planes;

        $sql = "SELECT
        pg.siem_hec_siem,
        p.sici_sem_apli,
        p.sici_tip_apli
        from agricola.planificacion p , agricola.plani_prog pg where
        p.plan_id= pg.id_cabecera and 
        plan_id =$id";

        //echo $sql;exit;

        if ($oIfx->Query($sql)) {
            if ($oIfx->NumFilas() > 0) {
                $i = 1;

                $siem_hec_siem = $oIfx->f('siem_hec_siem');
                $sici_sem_apli = $oIfx->f('sici_sem_apli');
                $sici_tip_apli = $oIfx->f('sici_tip_apli');

                $sql="SELECT lcam_nom_lcam from agricola.saelcam where lcam_cod_letra='$sici_tip_apli'";
                $sici_tip_apli = consulta_string($sql, 'lcam_nom_lcam', $oIfx, '');

                //echo $sici_tip_apli;exit;

                $total_hec += $siem_hec_siem;
            }
        }
    }


    $cuerpo_fin = '';
    $cuerpo_fin .= '<table border="1" cellpadding="2">
        
    <tr>
    
    <td style="width: 65px;"><b>#ORDEN DESPACHO.</b></td>
    <td style="width: 220px;"><b>PRODUCTO</b></td>
    <td style="width: 60px;"><b>LOTE</b></td>
    <td style="width: 55px;"><b>BLOQUES</b></td>
    <td style="width: 60px;"><b>DOSIS HA</b></td>
    <td style="width: 60px;"><b>CANTIDAD</b></td>
    </tr>
       ';


    $dentro_cuerpo_fin = "";
    foreach ($planes_array as $key => $planes) {


        $id    = $planes;

        $sql = "SELECT
           p.plan_id
          
           from agricola.planificacion p , agricola.plani_prog pg where 
           planificacion_estado = 'P' and
           p.plan_id= pg.id_cabecera and 
           plan_id =$id";
        //echo $sql;exit;
        $plan_id = consulta_string($sql, 'plan_id', $oIfxC, 0);

        //fertilizante
        $sql_f = "SELECT  prod_nom_prod,unid_sigl_unid,recetas_mp_cantidad,
           prod_x_h
                    
                   from agricola.plan_mp 
                   where plan_planifi_id =$plan_id";

        if ($oIfxA->Query($sql_f)) {
            if ($oIfxA->NumFilas() > 0) {
                $i = 1;
                do {



                    $prod_nom_prod = $oIfxA->f('prod_nom_prod');
                    $unid_sigl_unid = $oIfxA->f('unid_sigl_unid');
                    $recetas_mp_canti = $oIfxA->f('recetas_mp_cantidad');
                    $prod_x_h = $oIfxA->f('prod_x_h');


                    $prod_x_h =$prod_x_h .' '.$unid_sigl_unid;

                    $recetas_mp_canti=$recetas_mp_canti .' '.$unid_sigl_unid;



                    $sql="SELECT p.plan_id,p.siem_cod_siem,pg.sici_cod_fapr_sem ,pg.siem_hec_siem 
                       from agricola.planificacion p, agricola.plani_prog pg 
                       where 
                       p.plan_id= pg.id_cabecera and 
                       plan_id=$plan_id";

                    //echo $sql;exit;



                    $plan_id = consulta_string($sql, 'plan_id', $oIfxC, '');
                    $siem_cod_siem = consulta_string($sql, 'siem_cod_siem', $oIfxC, '');
                    $siem_hec_siem = consulta_string($sql, 'siem_hec_siem', $oIfxC, '');

                    $cod_fapr = consulta_string($sql, 'sici_cod_fapr_sem', $oIfxC, '');

                    $sql = "SELECT fapr_des_facr from agricola.saepfapr where fapr_cod_fapr =$cod_fapr";
                    $aplicacion = consulta_string($sql, 'fapr_des_facr', $oIfxC, '');




                    $sql="SELECT siem_des_siem,siem_cod_bloq from agricola.saepsiem where siem_cod_siem=$siem_cod_siem";
                    $siem_des_siem = consulta_string($sql, 'siem_des_siem', $oIfxC, '');
                    $siem_cod_bloq = consulta_string($sql, 'siem_cod_bloq', $oIfxC, '');

                    //  echo "si";exit;
                    /*  $sql="SELECT bloq_cant_bloq from agricola.saepbloq where bloq_cod_bloq=$siem_cod_bloq";
                      $bloq = consulta_string($sql, 'bloq_cant_bloq', $oIfxC, '');
                      */


                    $cuerpo_fin .= ' 
                               <tr>
                                  
                                   <td>'.$plan_id.'</td>
                                   <td>' . strtoupper($prod_nom_prod) . '</td>
                                   <td>'.$siem_des_siem.'</td>
                                   <td>'.$bloq.'</td>
                                   <td>' . $recetas_mp_canti . '</td>
                                   <td>' . $prod_x_h . '</td>
                                                                           
                               </tr>
   
                               ';




                    $i++;
                } while ($oIfxA->SiguienteRegistro());
            }
        }

    }


    $cuerpo_fin .= '' . $dentro_cuerpo_fin . '';



    $cuerpo_fin .= '</table>';


    $dentro_cuerpo_fin2 = "";
    $cuerpo_fin .= '<table border="1" cellpadding="2">
           
         
          ';

    $dentro_cuerpo_fin2 = "";
    foreach ($planes_array as $key => $planes) {



        $id    = $planes;

        $sql = "SELECT
           p.plan_id
          
           from agricola.planificacion p , agricola.plani_prog pg where 
           p.plan_id= pg.id_cabecera and 
           plan_id =$id";

        $plan_id = consulta_string($sql, 'plan_id', $oIfxC, '');


        //fertilizante
        $sql_f = "SELECT  prod_nom_prod,unid_sigl_unid,recetas_in_cantidad,prod_x_h
                   from agricola.plan_in   
                   where plan_in_id_recetas =$plan_id";



        if ($oIfxB->Query($sql_f)) {
            if ($oIfxB->NumFilas() > 0) {
                $i = 1;
                do {


                    $prod_nom_prod = $oIfxB->f('prod_nom_prod');
                    $unid_sigl_unid = $oIfxB->f('unid_sigl_unid');
                    $recetas_mp_canti = $oIfxB->f('recetas_in_cantidad');
                    $prod_x_h = $oIfxB->f('prod_x_h');


                    $prod_x_h =$prod_x_h .' '.$unid_sigl_unid;

                    $recetas_mp_canti=$recetas_mp_canti .' '.$unid_sigl_unid;


                    $sql="SELECT p.plan_id,p.siem_cod_siem,pg.sici_cod_fapr_sem ,pg.siem_hec_siem 
                           from agricola.planificacion p, agricola.plani_prog pg 
                           where 
                           p.plan_id= pg.id_cabecera and 
                           plan_id=$plan_id";

                    // echo $sql;exit;



                    $cod_fapr = consulta_string($sql, 'sici_cod_fapr_sem', $oIfxC, '');
                    //echo $cod_fapr;exit;
                    $sql_a = "SELECT fapr_des_facr from agricola.saepfapr where fapr_cod_fapr =$cod_fapr";
                    $aplicacion = consulta_string($sql_a, 'fapr_des_facr', $oIfxC, '');



                    $siem_cod_siem = consulta_string($sql, 'siem_cod_siem', $oIfxC, '');

                    $sql="SELECT siem_des_siem,siem_cod_bloq from agricola.saepsiem where siem_cod_siem=$siem_cod_siem";
                    $siem_des_siem = consulta_string($sql, 'siem_des_siem', $oIfxC, '');
                    $siem_cod_bloq = consulta_string($sql, 'siem_cod_bloq', $oIfxC, '');


                    /*    $sql="SELECT bloq_cant_bloq from agricola.saepbloq where bloq_cod_bloq=$siem_cod_bloq";
                        $bloq = consulta_string($sql, 'bloq_cant_bloq', $oIfxC, '');
*/
                    $dentro_cuerpo_fin2 .= ' 
                               <tr>

    

                                   <td style="width: 65px;">'.$plan_id.'</td>
                                   <td style="width: 220px;">' . strtoupper($prod_nom_prod) . '</td>
                                   <td style="width: 60px;">'.$siem_des_siem.'</td>
                                   <td style="width: 55px;">'.$bloq.'</td>
                                   <td style="width: 60px;">' . $recetas_mp_canti . '</td>
                                   <td style="width: 60px;">' . $prod_x_h . '</td>
                                  
                                                                           
                               </tr>
   
   
                               ';


                    $i++;
                } while ($oIfxB->SiguienteRegistro());
            }
        }

    }


    $cuerpo_fin .= '' . $dentro_cuerpo_fin2 . '';



    $cuerpo_fin .= '</table><br><br><br>';




    $cuerpo_detalle = '';
    $cuerpo_detalle .= '<table border="1" cellpadding="2">
        <tr>
        <td><br>
        <b>CULTIVO:</b> PIÑA VARIEDAD GOLDEN MD2<br>
        <b>APLICACION:</b> '.$aplicacion.'<br>                       
        <b>HECTAREAJE</b>: ' . $total_hec . '<br>             
        <b>CUANTIFICADORES: </b> ' . $cuantificadores . '<br>
        </td>

        <td>
        <b>SEMANA</b>: ' . $sici_sem_apli . '<br>
        <b>FECHA</b>: ' . $today . '<br>
        <b>ETAPA</b>: ' . $sici_tip_apli . '<br>
        </td>
        </tr>
       ';
    $cuerpo_detalle .= '</table><br><br><br>';



    //FRIMAS Y FIN DEL INFROME
    $fin = '';
    $fin .= '<table cellpadding="2">
        <tr>
        <td align="center">_____________________________</td>
        <td align="center">_____________________________</td> 
        </tr>

        <tr >
        <td align="center"><b>AUTORIZADO</b></td>
        <td align="center"><b>RECIBIDO</b></td>
        </tr>
        ';
    $fin .= '</table>';




    $documento = $cabecera . $cuerpo_detalle . $cuerpo_fin . $fin;
    //echo $documento;exit;
    return $documento;
}




function salida_de_venta($id){

    global $DSN, $DSN_Ifx;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo();
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $sql="SELECT regisv_nom_regisv,
                 regisv_cod_prod,
                 regisv_cod_clpv,
                 regisv_cod_chof,
                 regisv_pla_chof, 
                 regisv_peso_bruto,
                 regisv_peso_tara, 
                 regisv_fecha_salida,
                 nom_clpv,
                 regisv_fec_reg,
                 tipo_peso,
                 regis_obser_regis,
                 regisv_peso_2,
                 regisv_peso_neto from agricola.saeregisv where regisv_cod_regisv='$id'";

    //   echo $sql;exit;
    $cliente  = consulta_string($sql, 'nom_clpv', $oIfxA, '');
    $regisv_cod_prod  = consulta_string($sql, 'regisv_cod_prod', $oIfxA, '');

    $regisv_cod_chof  = consulta_string($sql, 'regisv_cod_chof', $oIfxA, '');
    $regisv_pla_chof  = consulta_string($sql, 'clpv_nom_clpv', $oIfxA, '');
    $regisv_peso_bruto  = consulta_string($sql, 'regisv_peso_bruto', $oIfxA, '');
    $regisv_peso_tara =consulta_string($sql, 'regisv_peso_tara', $oIfxA, '');
    $regisv_peso_neto = consulta_string($sql, 'regisv_peso_neto', $oIfxA, '');
    $regisv_fec_reg = consulta_string($sql, 'regisv_fec_reg', $oIfxA, '');
    $tipo_peso = consulta_string($sql, 'tipo_peso', $oIfxA, '');
    $regisv_fecha_salida = consulta_string($sql, 'regisv_fecha_salida', $oIfxA, '');
    $regis_obser_regis = consulta_string($sql, 'regis_obser_regis', $oIfxA, '');
    $regisv_peso_2 = consulta_string($sql, 'regisv_peso_2', $oIfxA, '');

    $sql = "SELECT productos_bas_nombre from agricola.productos_bascula where productos_bas_id='$regisv_cod_prod' ";
    $producto = consulta_string($sql, 'productos_bas_nombre', $oIfxA, '');

    $sql = "SELECT trta_nom_trta from agricola.saetrta where trta_cod_trta='$regisv_cod_chof'";
    $chofer = consulta_string($sql, 'trta_nom_trta', $oIfxA, '');




    $html.='<table>
    <tr>
    <td><b>PRODUCTO: </b>'.$producto.'</td><\n>
    </tr>

    <tr>
    <td><b>CLIENTE: </b> '.$cliente.' </td>
    </tr>
    
    <tr>
    <td><b>CONDUCTOR: </b> '.$chofer.'</td><\n>
    </tr>

    <tr>
    <td><b>PESO BRUTO:  </b>'.$regisv_peso_bruto.'</td><\n>
    </tr>

    <tr>
    <td><b>PESO TARA:  </b>'.$regisv_peso_tara.'</td><\n>
    </tr>

    <tr>
    <td><b>PESO NETO:  </b>'.$regisv_peso_neto.'</td><\n>
    </tr>

    <tr>
    <td><b>FECHA DE INGRESO:  </b>'.$regisv_fec_reg.'</td><\n>
    </tr>

    <tr>
    <td><b>FECHA DE SALIDA:  </b>'.$regisv_fecha_salida.'</td><\n>
    </tr>

    <tr>
    <td><b>TIPO DE PESO TARA:  </b>'.$tipo_peso.'</td><\n>
    </tr>

     <tr>
    <td><b>TIPO DE PESO BRUTO:  </b>'.$regisv_peso_2.'</td><\n>
    </tr>
    <tr>
    <td><b>OBSERVACIONES:  </b>'.$regis_obser_regis.'</td><\n>
    </tr>


    </table>';






    return $html;

}





function reporte_despacho_venta($tran){

    global $DSN, $DSN_Ifx;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo();
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();
    $oReturn = new xajaxResponse();
    //echo $tran;exit;


    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idsucursal = $_SESSION['U_SUCURSAL'];


    $today= date("Y-m-d");

    $sql_defi = "SELECT DEFI_COD_MODU, DEFI_TRS_DEFI  , DEFI_TIP_DEFI, DEFI_FOR_DEFI FROM SAEDEFI WHERE
               DEFI_COD_EMPR = $idEmpresa AND
               DEFI_COD_SUCU = $idsucursal and
               defi_cod_modu = 10 and
               defi_tip_defi = '0' and
               defi_cod_tran = '$tran' ";

    $secu_minv = '';
    $formato = 0;
    if ($oIfx->Query($sql_defi)) {
        if ($oIfx->NumFilas() > 0) {
            $secu_minv = $oIfx->f('defi_trs_defi')-1;
            $formato = $oIfx->f('defi_for_defi');
        }
    }

    if (empty($formato)) {
        $formato = 0;
    }

    $oIfx->Free();
    $secu_minv = secuencial(2, '0', $secu_minv, 8);



    $sql = "select empr_ac2_empr, empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr
                from saeempr where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {


        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
            $empr_ac2_empr = trim($oIfx->f('empr_ac2_empr'));
        }
    }
    $oIfx->Free();


    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;
    $arc_img =  DIR_INCLUDE.'Clases/Formulario/Plugins/reloj/'.$path_img[$count];




    if (file_exists($arc_img)) {
        $imagen = $arc_img;
    } else {
        $imagen = '';
    }
    $logo = '';
    $x = '0px';
    if ($imagen != '') {

        $empr_logo = '<div><img src="' . $imagen . '" style="width:150px;object-fit; contain;"></div>';
    } else {
        $empr_logo = '<span><font color="red">SIN LOGO</font></span>';
    }

    $hora      =  date("Y-m-d H:i:s");



    //PRIMERA IFNROMACION DEL REPROTE
    $cabecera = '';

    $cabecera .= '
                '.$hora.'<br><br>
                <table>
                <tr>
                <td rowspan="2" width="30%">' . $empr_logo . '</td>
                <td align="center"><b>Guia Despacho Produccion</b><br></td>
                </tr>
                ';
    $cabecera .= '</table> <br><br><br><br>';

    $detalle.='
               <table border="1" cellpadding="2">
                          
                               <tr  class="bg-primary";>
                               <td  style="width: 18px;"><b>N.-</b></td>
                               <td  style="width: 65px;"><b>Codigo</b></td>
                               <td  style="width: 145px;"><b>Producto</b></td>
                               <td  style="width: 65px;"><b>Lote</b></td>
                               <td  style="width: 50px;"><b>Peso Total</b></td>
                               <td  style="width: 50px;"><b>Cajas</b></td>
                               <td  style="width: 50px;"><b>Cntd.Frutas</b></td>
                               <td  style="width: 50px;"><b>Precio</b></td>
                               <td  style="width: 50px;"><b>Total</b></td>
                             
                                   
                               </tr>
                             
                             ';

    $sql="SELECT * from  agricola.despacho_produ where estado_despacho is null or estado_despacho='P'";

    $total_cajas=0;
    $total_unidades=0;
    $total_precio=0;
    $total_total=0;
    $total_peso=0;




    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $i = 1;
            do {
                $cod_prod = $oIfx->f('cod_prod');

                $cod_lote = $oIfx->f('cod_lote');
                $caja_tmp = $oIfx->f('caja_tmp');
                $cantidad = $oIfx->f('cantidad');
                $precio_tmp = $oIfx->f('precio_tmp');
                $total = $oIfx->f('total');
                $peso_tmp = $oIfx->f('peso_tmp');

                $fecha_reg = $oIfx->f('fecha_reg');

                $tipo_merc = $oIfx->f('tipo_merc');

                $cod_sec_minv = $oIfx->f('cod_sec_minv');

                $estado_despacho = $oIfx->f('estado_despacho');

                if($tipo_merc=='E'){

                    $peso_tmp=$peso_tmp * $caja_tmp;
                
                }else{

                    $peso_tmp=$peso_tmp * $cantidad;
                }

                $sql="SELECT ppblo_nom_ppblo from agricola.saeppblo where ppblo_cod_ppblo='$cod_lote'";
                $lote = consulta_string($sql, 'ppblo_nom_ppblo', $oIfxC, '');


                $sql="SELECT prod_nom_prod from saeprod where prod_cod_prod='$cod_prod'";
                $producto = consulta_string($sql, 'prod_nom_prod', $oIfxC, '');


                $detalle .= '<tr>
                      
                <td style="width: 18px;">'.$i.'</td> 
                <td style="width: 65px;">' . strtoupper($cod_prod) . '</td>
                <td style="width: 145px;">' . strtoupper($producto) . '</td>
                <td style="width: 65px;">' . strtoupper($lote) . '</td>
                <td style="width: 50px;" align="right">' . strtoupper($peso_tmp) . '</td>
                <td style="width: 50px;" align="right">' . strtoupper($caja_tmp) . '</td>
                <td style="width: 50px;" align="right">' . strtoupper($cantidad) . '</td>
                <td style="width: 50px;" align="right">' . strtoupper($precio_tmp) . '</td>
                <td style="width: 50px;" align="right">' . strtoupper($total) . '</td>
            
            
                </tr>';

                $total_cajas+=$caja_tmp;
                $total_unidades+=$cantidad;
                $total_precio+=$precio_tmp;
                $total_total+=$total;
                $total_peso+=$peso_tmp;


                $i++;
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $detalle .= '<tr>
                <td></td>
                <td></td>
                <td></td>
                <td style="color:red">TOTALES</td>
                <td align="right" style="color:red">'.$total_peso.'</td>
                <td align="right" style="color:red">'.$total_cajas.'</td>
                <td align="right" style="color:red">'.$total_unidades.'</td>
                <td align="right" style="color:red">'.$total_precio.'</td>
                <td align="right" style="color:red">'.$total_total.'</td>
                </tr>';


    $detalle .= '</table>';


    $sql="SELECT fecha_reg,tipo_merc,cod_clpv from  agricola.despacho_produ where estado_despacho is null or estado_despacho='P'";
    $fecha = consulta_string($sql, 'fecha_reg', $oIfxC, '');
    $tipo_mercado = consulta_string($sql, 'tipo_merc', $oIfxC, '');
    $tmp_cod_clpv = consulta_string($sql, 'cod_clpv', $oIfxC, '');


    $sql="SELECT clpv_nom_clpv from saeclpv where clpv_cod_clpv='$tmp_cod_clpv'";
    $nombre_cliente = consulta_string($sql, 'clpv_nom_clpv', $oIfxC, '');

    $sql="SELECT mercado_des_mercado from agricola.tipo_mercado where mercado_cod_letra='$tipo_mercado'";
    $mercado = consulta_string($sql, 'mercado_des_mercado', $oIfxC, '');



    $inf1 .= '
             
                <table>
                <tr>
                <td><b>Fecha: </b>   '.$fecha.'</td>
                </tr>

                <tr>
                <td><b>Cliente: </b>  '.$nombre_cliente.'</td>
                </tr>

                <tr>
                <td><b>Secuencial: </b>  '.$secu_minv.'</td>
                </tr>
                
                <tr>
                <td><b>Tipo de Mercado: </b>  '.$mercado.'</td>
                </tr>
                ';
    $inf1 .= '</table> <br><br>';





    $a=$cabecera.$inf1.$detalle;

    try {

        $oIfxA->QueryT('BEGIN WORK;');

        $sql="UPDATE agricola.despacho_produ set estado_despacho='S'"; 


        $oIfxA->QueryT($sql);

        $oIfxA->QueryT('COMMIT WORK');


    } catch (Exception $e) {
        // rollback
        $oIfxA->QueryT('ROLLBACK WORK;');
        $oReturn->alert($e->getMessage());
        $oReturn->assign("ctrl", "value", 1);
    }


    return $a;






}

function reporte_despacho_venta_2($cod){

    global $DSN, $DSN_Ifx;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo();
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();
    $oReturn = new xajaxResponse();
    //echo $tran;exit;


    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idsucursal = $_SESSION['U_SUCURSAL'];


    $today= date("Y-m-d");

  
 

    $sql = "select empr_ac2_empr, empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr
                from saeempr where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {


        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
            $empr_ac2_empr = trim($oIfx->f('empr_ac2_empr'));
        }
    }
    $oIfx->Free();


    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;
    $arc_img =  DIR_INCLUDE.'Clases/Formulario/Plugins/reloj/'.$path_img[$count];




    if (file_exists($arc_img)) {
        $imagen = $arc_img;
    } else {
        $imagen = '';
    }
    $logo = '';
    $x = '0px';
    if ($imagen != '') {

        $empr_logo = '<div><img src="' . $imagen . '" style="width:150px;object-fit; contain;"></div>';
    } else {
        $empr_logo = '<span><font color="red">SIN LOGO</font></span>';
    }

    $hora      =  date("Y-m-d H:i:s");



    //PRIMERA IFNROMACION DEL REPROTE
    $cabecera = '';

    $cabecera .= '
                '.$hora.'<br><br>
                <table>
                <tr>
                <td rowspan="2" width="30%">' . $empr_logo . '</td>
                <td align="center"><b>Guia Despacho Produccion</b><br></td>
                </tr>
                ';
    $cabecera .= '</table> <br><br><br><br>';

    $detalle.='
               <table border="1" cellpadding="2">
                          
                               <tr  class="bg-primary";>
                               <td  style="width: 18px;"><b>N.-</b></td>
                               <td  style="width: 65px;"><b>Codigo</b></td>
                               <td  style="width: 145px;"><b>Producto</b></td>
                               <td  style="width: 65px;"><b>Lote</b></td>
                               <td  style="width: 50px;"><b>Peso Total</b></td>
                               <td  style="width: 50px;"><b>Cajas</b></td>
                               <td  style="width: 50px;"><b>Cntd.Frutas</b></td>
                               <td  style="width: 50px;"><b>Precio</b></td>
                               <td  style="width: 50px;"><b>Total</b></td>
                               </tr>
                             
                             ';

    $sql="SELECT * from  agricola.despacho_produ where cod_sec_minv='$cod'";

    $total_cajas=0;
    $total_unidades=0;
    $total_precio=0;
    $total_total=0;
    $total_peso=0;




    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $i = 1;
            do {
                $cod_prod = $oIfx->f('cod_prod');

                $cod_lote = $oIfx->f('cod_lote');
                $caja_tmp = $oIfx->f('caja_tmp');
                $cantidad = $oIfx->f('cantidad');
                $precio_tmp = $oIfx->f('precio_tmp');
                $total = $oIfx->f('total');
                $peso_tmp = $oIfx->f('peso_tmp');
                $fecha_reg = $oIfx->f('fecha_reg');
                $tipo_merc = $oIfx->f('tipo_merc');
                $cod_sec_minv = $oIfx->f('cod_sec_minv');
                $estado_despacho = $oIfx->f('estado_despacho');

                if($tipo_merc=='E'){

                    $peso_tmp=$peso_tmp * $caja_tmp;
                
                }else{

                    $peso_tmp=$peso_tmp * $cantidad;
                }

                $total_2=$cantidad*$precio_tmp;

                $sql="SELECT ppblo_nom_ppblo from agricola.saeppblo where ppblo_cod_ppblo='$cod_lote'";
                $lote = consulta_string($sql, 'ppblo_nom_ppblo', $oIfxC, '');


                $sql="SELECT prod_nom_prod from saeprod where prod_cod_prod='$cod_prod'";
                $producto = consulta_string($sql, 'prod_nom_prod', $oIfxC, '');


                $detalle .= '<tr>
                      
                <td style="width: 18px;">'.$i.'</td> 
                <td style="width: 65px;">' . strtoupper($cod_prod) . '</td>
                <td style="width: 145px;">' . strtoupper($producto) . '</td>
                <td style="width: 65px;">' . strtoupper($lote) . '</td>
                <td style="width: 50px;" align="right">' . strtoupper($peso_tmp) . '</td>
                <td style="width: 50px;" align="right">' . strtoupper($caja_tmp) . '</td>
                <td style="width: 50px;" align="right">' . strtoupper($cantidad) . '</td>
                <td style="width: 50px;" align="right">' . strtoupper($precio_tmp) . '</td>
                <td style="width: 50px;" align="right">' . strtoupper($total_2) . '</td>
            
            
                </tr>';

                $total_cajas+=$caja_tmp;
                $total_unidades+=$cantidad;
                $total_precio+=$precio_tmp;
                $total_total+=$total;
                $total_peso+=$peso_tmp;


                $i++;
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $detalle .= '<tr>
                <td></td>
                <td></td>
                <td></td>
                <td style="color:red">TOTALES</td>
                <td align="right" style="color:red">'.$total_peso.'</td>
                <td align="right" style="color:red">'.$total_cajas.'</td>
                <td align="right" style="color:red">'.$total_unidades.'</td>
                <td align="right" style="color:red">'.$total_precio.'</td>
                <td align="right" style="color:red">'.$total_total.'</td>
                </tr>';


    $detalle .= '</table>';


    $sql="SELECT fecha_reg,tipo_merc,cod_clpv from  agricola.despacho_produ where cod_sec_minv='$cod'";
    $fecha = consulta_string($sql, 'fecha_reg', $oIfxC, '');
    $tipo_mercado = consulta_string($sql, 'tipo_merc', $oIfxC, '');
    $tmp_cod_clpv = consulta_string($sql, 'cod_clpv', $oIfxC, '');


    $sql="SELECT clpv_nom_clpv from saeclpv where clpv_cod_clpv='$tmp_cod_clpv'";
    $nombre_cliente = consulta_string($sql, 'clpv_nom_clpv', $oIfxC, '');

    $sql="SELECT mercado_des_mercado from agricola.tipo_mercado where mercado_cod_letra='$tipo_mercado'";
    $mercado = consulta_string($sql, 'mercado_des_mercado', $oIfxC, '');


    $sql="SELECT minv_num_sec from saeminv where minv_num_comp='$cod'";
    $secu = consulta_string($sql, 'minv_num_sec', $oIfxC, '');



    $inf1 .= '
             
                <table>
                <tr>
                <td><b>Fecha: </b>   '.$fecha.'</td>
                </tr>

                <tr>
                <td><b>Cliente: </b>  '.$nombre_cliente.'</td>
                </tr>

                <tr>
                <td><b>Secuencial: </b>  '.$secu.'</td>
                </tr>
                
                <tr>
                <td><b>Tipo de Mercado: </b>  '.$mercado.'</td>
                </tr>
                ';
    $inf1 .= '</table> <br><br>';





    $a=$cabecera.$inf1.$detalle;

  

    return $a;






}



function despacho_pedido($cod){

    global $DSN, $DSN_Ifx;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo();
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();
    $oReturn = new xajaxResponse();
    //echo $tran;exit;


    $idEmpresa = $_SESSION['U_EMPRESA'];
    $idsucursal = $_SESSION['U_SUCURSAL'];


    $today= date("Y-m-d");
 

    $sql = "select empr_ac2_empr, empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr
                from saeempr where empr_cod_empr = $idEmpresa ";
    if ($oIfx->Query($sql)) {


        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
            $empr_ac2_empr = trim($oIfx->f('empr_ac2_empr'));
        }
    }
    $oIfx->Free();


    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;
    $arc_img =  DIR_INCLUDE.'Clases/Formulario/Plugins/reloj/'.$path_img[$count];




    if (file_exists($arc_img)) {
        $imagen = $arc_img;
    } else {
        $imagen = '';
    }
    $logo = '';
    $x = '0px';
    if ($imagen != '') {

        $empr_logo = '<div><img src="' . $imagen . '" style="width:150px;object-fit; contain;"></div>';
    } else {
        $empr_logo = '<span><font color="red">SIN LOGO</font></span>';
    }

    $hora      =  date("Y-m-d H:i:s");



    //PRIMERA IFNROMACION DEL REPROTE
    $cabecera = '';

    $cabecera .= '
                '.$hora.'<br><br>
                <table>
                <tr>
                <td rowspan="2" width="30%">' . $empr_logo . '</td>
                <td align="center"><b>Egreso Bodega</b><br></td>
                </tr>
                ';
    $cabecera .= '</table> <br><br><br><br>';

    $detalle.='
               <table border="1" cellpadding="2">
                          
                               <tr  class="bg-primary";>
                               <td  style="width: 18px;"><b>N.-</b></td>
                               <td  style="width: 65px;"><b>Codigo</b></td>
                               <td  style="width: 220px;"><b>Producto</b></td>
                               <td  style="width: 65px;"><b>Cantidad</b></td>
                               <td  style="width: 65px;"><b>Destino/Uso</b></td>
                                </tr>
                             ';

    $sql="SELECT secuencial,area,fecha_reg,cod_supervisor from  pedidos where id='$cod'";
    $secuencial_1 = consulta_string($sql, 'secuencial', $oIfxC, '');
    $area = consulta_string($sql, 'area', $oIfxC, '');
    $fecha_reg = consulta_string($sql, 'fecha_reg', $oIfxC, '');
    $cod_supervisor = consulta_string($sql, 'cod_supervisor', $oIfxC, '');

    $sql="SELECT concat(empl_nom_empl,' ',empl_ape_empl) as nombre from  saeempl where empl_cod_empl='$cod_supervisor'";
    $nombre_super = consulta_string($sql, 'nombre', $oIfxC, '');
   




    $sql_det="SELECT * from  pedido_tmp where secuencial='$secuencial_1'";

    //echo $secu;exit;



    if ($oIfx->Query($sql_det)) {
        if ($oIfx->NumFilas() > 0) {
            $i = 1;
            do {
                $id = $oIfx->f('id');
                $cod_supervisor = $oIfx->f('cod_supervisor');
                $area = $oIfx->f('area');
                $tipo =  $oIfx->f('tipo');
                $cod_prod = $oIfx->f('cod_prod');
                $cantidad  = $oIfx->f('cantidad');
                $destino = $oIfx->f('destino');


                $sql = "SELECT prod_nom_prod from saeprod where prod_cod_prod='$cod_prod' ";
                $prod_nom_prod = consulta_string($sql, 'prod_nom_prod', $oIfxA, '');

            

            $detalle .= '<tr>
                        <td  style="width: 18px;">' . $i . '</td> 
                        <td  style="width: 65px;" >' . strtoupper($cod_prod) . '</td>
                        <td  style="width: 220px;">' . strtoupper($prod_nom_prod) . '</td>
                        <td  style="width: 65px;">' . strtoupper($cantidad) . '</td>
                        <td  style="width: 65px;">' . strtoupper($destino) . '</td>
                        
                        
                        </tr>';
                
              
                $i++;
            } while ($oIfx->SiguienteRegistro());
        }
    }



    $detalle .= '</table>';


    $sql="SELECT fecha_reg,tipo_merc,cod_clpv from  agricola.despacho_produ where cod_sec_minv='$cod'";
    $fecha = consulta_string($sql, 'fecha_reg', $oIfxC, '');
    $tipo_mercado = consulta_string($sql, 'tipo_merc', $oIfxC, '');
    $tmp_cod_clpv = consulta_string($sql, 'cod_clpv', $oIfxC, '');


   

    $sql="SELECT mercado_des_mercado from agricola.tipo_mercado where mercado_cod_letra='$tipo_mercado'";
    $mercado = consulta_string($sql, 'mercado_des_mercado', $oIfxC, '');


    $sql="SELECT minv_num_sec from saeminv where minv_num_comp='$cod'";
    $secu = consulta_string($sql, 'minv_num_sec', $oIfxC, '');



    $inf1 .= '
             
                <table>
                <tr>
                <td><b>Fecha: </b>   '.$fecha_reg.'</td>
                </tr>

                <tr>
                <td><b>Supervisor: </b>  '.$nombre_super.'</td>
                </tr>

                <tr>
                <td><b>Area: </b>  '.$area.'</td>
                </tr>
                
                <tr>
                <td><b>Secuencial: </b>  '.$secuencial_1.'</td>
                </tr>
                ';
    $inf1 .= '</table> <br><br>';

    $fin = '';
    $fin .= '<br><br><br><br><br><br><table cellpadding="2">
        <tr>
        <td align="center">_____________________________</td>
        <td align="center">_____________________________</td>
      
        </tr>

        <tr >
        <td align="center"><b>SUPERVISOR</b></td>
        <td align="center"><b>BODEGA</b></td>
        </tr>
        ';




    $a=$cabecera.$inf1.$detalle.$fin;



  

    return $a;






}



function stock_func( $idempresa, $idsucursal, $idbodega, $prod_cod, $oIfx ){

    $sql = "SELECT saeprbo.prbo_cod_prod, saeprbo.prbo_dis_prod, 		
            ( select sum(case when d.defi_tip_defi='5' then 
                        c.dmov_can_dmov when c.dmov_can_dmov='0' then 
                        c.dmov_can_dmov when c.dmov_can_dmov='1' then 
                      - c.dmov_can_dmov when c.dmov_can_dmov='6' then 
                       -c.dmov_can_dmov end)
			from  saedmov c,saeminv b,saedefi d where 
			b.minv_cod_empr  = c.dmov_cod_empr and 
                        b.minv_cod_sucu  = c.dmov_cod_sucu and
                        b.minv_num_comp  = c.dmov_num_comp and 
                        c.dmov_cod_prod  = saeprbo.prbo_cod_prod and
                        d.defi_cod_empr  = b.minv_cod_empr and
                        d.defi_cod_tran  = b.minv_cod_tran and
                        b.minv_cod_empr  = $idempresa and
                        (c.dmov_cod_bode = $idbodega ) and  
                        b.minv_fmov     <= '".$date('Y-m-d')."')	ingresos, 
(		select sum(case when d.defi_tip_defi='5' then 
                        c.dmov_can_dmov when c.dmov_can_dmov='0' then 
                        c.dmov_can_dmov when c.dmov_can_dmov='1' then 
                      - c.dmov_can_dmov when c.dmov_can_dmov='6' then 
                        c.dmov_can_dmov end)
                        from  saedmov c,saeminv b,saedefi d where 
                        b.minv_cod_empr  = c.dmov_cod_empr and 
                        b.minv_cod_sucu  = c.dmov_cod_sucu and
                        b.minv_num_comp  = c.dmov_num_comp and 
                        c.dmov_cod_prod  = saeprbo.prbo_cod_prod and
                        d.defi_cod_empr  = b.minv_cod_empr and
                        d.defi_cod_tran  = b.minv_cod_tran and
                        b.minv_cod_empr  = $idempresa  and
                        c.dmov_bod_envi  = $idbodega  and
                        b.minv_fmov     <= '".$date('Y-m-d')."' )	egresos,
            (   SELECT cost_val_unit FROM saecost WHERE 	
                        cost_cod_bode	=  $idbodega and 
                        cost_cod_prod	=  a.prod_cod_prod AND 
                        cost_cod_empr	=  $idempresa and 
                        cost_cod_sucu	=  $idsucursal and 
                        cost_cod_cost 	= ( SELECT max(cost_cod_cost) FROM saecost  WHERE 	
                                                    cost_cod_bode  = $idbodega and 
                                                    cost_cod_prod  = a.prod_cod_prod and 
                                                    cost_fec_cost <= '".$date('Y-m-d')."' AND 
                                                    cost_cod_empr  = $idempresa and 
                                                    cost_cod_sucu  = $idsucursal and	
                                                    cost_val_unit  >  0 )	) costo
                FROM saeprbo, saeprod a  WHERE 
                a.prod_cod_prod = saeprbo.prbo_cod_prod  and  
                a.prod_cod_empr = saeprbo.prbo_cod_empr  and  
                a.prod_cod_sucu = saeprbo.prbo_cod_sucu  and  
                saeprbo.prbo_cod_empr = $idempresa  AND  
                saeprbo.prbo_cod_sucu = $idsucursal  AND 
                prbo_cod_bode         = $idbodega and
                a.prod_cod_prod       = '$prod_cod'";
    $stock = 0;
    if($oIfx->Query($sql)){
        if($oIfx->NumFilas()>0){
            $ingr = vacios($oIfx->f('ingresos'),0);
            $egre = vacios($oIfx->f('egresos'),0);
            $stock= $ingr - $egre;
        }
    }

    return $stock;
}


function recibo_digital($cod){

    global $DSN, $DSN_Ifx;
    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo();
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();
    $oReturn = new xajaxResponse();
    //echo $tran;exit;


    $idempresa = $_SESSION['U_EMPRESA'];
    $idsucursal = $_SESSION['U_SUCURSAL'];


    //----------------------------
    //  IMAGENES DEL RECIBO
    //----------------------------
        //CABECERA DEL RECIBO
        $isp_cabecera = '../imagenes/isp_digital/cab_recib.jpg';
        $cabecera_cont = $isp_cabecera;

        //PAGO PUNTUAL
        $pago_pnt = '../imagenes/isp_digital/puntual.jpg';
        $puntual = $pago_pnt;

                    //var_dump($puntual);exit;
                /*  $sql_id="SELECT nom_clpv,direccion,tipo_contrato_de_cobro,fecha_corte from isp.contrato_clpv where id='6366'";
                    $abonado = consulta_string($sql_id, 'nom_clpv', $oIfxA, '');
                    $direccion = consulta_string($sql_id, 'direccion', $oIfxA, '');
                    $tipo_contrato_de_cobro = consulta_string($sql_id, 'tipo_contrato_de_cobro', $oIfxA, '');
                    $fecha_corte = consulta_string($sql_id, 'fecha_corte', $oIfxA, '');

                    if($tipo_contrato_de_cobro=='POSTPAGO'){

                    }

                    if($tipo_contrato_de_cobro=='PREPAGO'){
                        
                    }
                */
                    
            

    //CABECERA DEL FORMATO
    $cabecera .= '<div><img src="' . $cabecera_cont . '"></div>';

    

    $cabecera .='<table>
                <tr>
                    <td style="width:25px"></td>
                    <td style="width:300px"><h1><b>Datos del cliente</b></h1></td>
                    <td style="width:40px"></td>
                    <td style="width:150px; font-size:10px">
                    <div align="center" style="width:10px; background-color:gray; color:white;">
                        Periodo
                    </div>
                    </td>
                    <td style="width:70px">
                    <div style="width:90px; height:50px;  border-radius:100px; ">
                    
                    <b>'.$periodo.'</b>
                    </div>
                    </td>
                </tr>';
                
              $cabecera .='      <tr>
                    <td style="width:25px"></td>
                    <td style="width:300px; font-size:13px">'.$abonado.'</td>
                    <td style="width:40px"></td>
                    <td style="width:150px; font-size:10px">
                    <div style="background-color:red; color:white; width:90px; height:50px; justify-content:center; align-content:center; border-radius:100px; "align="center">
                        Ultimo dia de pago
                        </div>
                    </td>
                    <td style="width:70px">
                    <div style="width:90px; height:50px;  border-radius:100px; ">
                    
                    <b>'.$ultimo_dia_pago.'</b>
                    </div>
                    </td>
                </tr>

                <tr>
                    <td style="width:25px"></td>
                    <td style="width:300px; font-size:13px">'.$direccion.'</td>
                    <td style="width:40px"></td>
                    <td style="width:150px; font-size:10px">
                    <div style="background-color:gray; color:white; width:90px; height:50px; justify-content:center; align-content:center; border-radius:100px; "align="center">
                        Fecha Corte
                        </div>
                    </td>
                    <td style="width:70px">
                    <div style="width:90px; height:50px;  border-radius:100px; ">
                    
                    <b>'.$fecha_corte.'</b>
                    </div>
                    </td>
                 </tr>

                </table>';


             $cabecera .='
                <table cellpadding="7px">
                    <tr>
                        <td style="background-color:white;width:25px"></td>
                        <td style="background-color:#F2F2E1;width:300px"><b>Descripcion del servicio </b></td>
                        <td style="background-color:#F2F2E1;width:40px"></td>
                        <td style="background-color:#F2F2E1;width:150px;"></td>
                        <td style="background-color:#F2F2E1;width:70px"><b>Valor</b></td>
                    </tr>

                    <tr>
                        <td style="background-color:#FAFAF6; width:25px"></td>
                        <td style="background-color:#FAFAF6; width:300px"align="right"><b>'.$descripcion.'</b></td>
                        <td style="background-color:#FAFAF6; width:40px"><b>'.$cantidad.'</b></td>
                        <td style="background-color:#FAFAF6; width:150px;">'.$periodo.'</td>
                        <td style="background-color:#FAFAF6; width:70px">'.$valor.'</td>
                    </tr>
                    <tr>
                        <td style="background-color:; color:white; width:25px"></td>
                        <td style="background-color:gray; color:white; width:300px"><b>Total a pagar</b></td>
                        <td style="background-color:gray; color:white; width:40px"></td>
                        <td style="background-color:gray; color:white; width:150px;"></td>
                        <td style="background-color:gray; color:white; width:70px; font-size:12px"><b>'.$total.'</b></td>
                    </tr>
                </table><br>';
          
                $cabecera .= '<br>
                <table>
                    <tr>
                        <td style="width:25px"></td>
                        <td style="width:550px"><div ><img src="' . $puntual . '"></div></td>
                    </tr>
                </table><br>';

                $cabecera .= '<br>
                <table >
                    <tr>
                    <th style="width:25px"></th>
                    <th style="background-color:#F2F2E1"><h3>Formas de pago</h3></th>
                    <th></th>
                    </tr>';


                    $sql="SELECT * From fpago_digital where id_empresa='$idempresa' and tipo='F'";
                    if ($oIfx->Query($sql)) {
                        if ($oIfx->NumFilas() > 0) {
                            $i = 1;
                            do {

                                $nom_fpago = $oIfx->f('nom_fpago');
                                $fpago_descripcion = $oIfx->f('fpago_descripcion');
                                $img = $oIfx->f('img');
                                $promocion = $oIfx->f('promocion');



                                $cabecera .= '<tr>
                                                <td style="width:25px"></td>
                                                <td align="center"><b>'.$nom_fpago.'</b></td>
                                                <td align="center"></td>
                                              </tr>
                                              
                                              <tr>
                                                <td style="width:25px"></td>
                                                <td align="center">'.$fpago_descripcion.'</td>
                                                <td style="width:150px;" align="center"><div ><img src="' . $img . '" width="50px" ></div></td>
                                              </tr>';

                                $i++;
                            } while ($oIfx->SiguienteRegistro());
                        }
                    }
    $cabecera .= '   </table>';

    $sql="SELECT promocion from fpago_digital where id_empresa='$idempresa' and tipo='P'";
   
    $promocion = consulta_string($sql, 'promocion', $oIfxA, '');
    $cabecera .= '<div><img src="' . $promocion . '"  width="700px"></div>';
             
    $a=$cabecera;

    return $a;

}

function actualizar_costo_promedio_ponderado_prod($oIfx, $idempresa, $sucursal, $bod, $prod)
{

    // -----------------------------------------------------------------------------------------
    // NUEVO PROCESO CALCULO COSTO PROMEDIO ADRIAN47
    // -----------------------------------------------------------------------------------------  

    $fecha_ini = '2000-01-01';
    $fecha_fin = '2050-01-01';
    $sql_costo_prom = "SELECT * FROM 
								
									(
									SELECT
										prod_cod_prod,
										minv_fmov,
										COALESCE ( minv_fac_prov, minv_num_sec ) minv_fac_prov,
										minv_cm1_minv,
									CASE
											defi_tip_defi 
											WHEN '0' THEN
											'0' 
											WHEN '1' THEN
											'1' 
											WHEN '5' THEN
											'0' 
											WHEN '6' THEN
											'1' 
										END defi_tip_defi,
										minv_cod_tran,
									CASE
										defi_tip_defi 
										WHEN '0' THEN
										dmov_can_dmov 
										WHEN '1' THEN
										- dmov_can_dmov 
										WHEN '5' THEN
										dmov_can_dmov 
										WHEN '6' THEN
										- dmov_can_dmov 
										END dmov_can_dmov,
										dmov_pun_dmov,
										minv_num_comp,
										dmov_cod_dmov
									FROM
										saeprbo,
										saeprod,
										saedmov,
										saeminv,
										saetran,
										saedefi 
									WHERE
										prbo_cod_prod = prod_cod_prod 
										AND prbo_cod_empr = prod_cod_empr 
										AND prbo_cod_sucu = prod_cod_sucu 
										AND prod_cod_prod = dmov_cod_prod 
										AND prod_cod_empr = dmov_cod_empr 
										AND dmov_num_comp = minv_num_comp 
										AND dmov_num_prdo = minv_num_prdo 
										AND dmov_cod_empr = minv_cod_empr 
										AND dmov_cod_ejer = minv_cod_ejer 
										AND minv_cod_tran = tran_cod_tran 
										AND minv_cod_empr = tran_cod_empr 
										AND minv_cod_modu = tran_cod_modu 
										AND tran_cod_tran = defi_cod_tran 
										AND tran_cod_empr = defi_cod_empr 
										AND tran_cod_modu = defi_cod_modu 
										AND prbo_cod_bode = $bod 
										AND prbo_cod_empr = $idempresa 
										AND prbo_cod_sucu = $sucursal 
										AND prbo_cos_prod =  '2' 
										AND dmov_can_dmov <> 0 
										AND prod_cod_prod BETWEEN '$prod' AND '$prod' 
										AND dmov_cod_bode = $bod 
										AND minv_fmov BETWEEN '$fecha_ini' AND '$fecha_fin' 
										AND prod_cod_tpro = '2' 
										AND minv_cod_empr = $idempresa 
										AND defi_tip_defi IN ( '0', '1', '5', '6' ) UNION
									SELECT
										prod_cod_prod,
										minv_fmov,
										COALESCE ( minv_fac_prov, minv_num_sec ) minv_fac_prov,
										minv_cm1_minv,
									CASE
											defi_tip_defi 
											WHEN '0' THEN
											'0' 
											WHEN '1' THEN
											'1' 
											WHEN '5' THEN
											'0' 
											WHEN '6' THEN
											'0' 
										END defi_tip_defi,
										minv_cod_tran,
									CASE
										defi_tip_defi 
										WHEN '0' THEN
										dmov_can_dmov 
										WHEN '1' THEN
										- dmov_can_dmov 
										WHEN '5' THEN
										dmov_can_dmov 
										WHEN '6' THEN
										dmov_can_dmov 
										END dmov_can_dmov,
										dmov_pun_dmov,
										minv_num_comp,
										dmov_cod_dmov
									FROM
										saeprbo,
										saeprod,
										saedmov,
										saeminv,
										saetran,
										saedefi 
									WHERE
										prbo_cod_prod = prod_cod_prod 
										AND prbo_cod_empr = prod_cod_empr 
										AND prbo_cod_sucu = prod_cod_sucu 
										AND prod_cod_prod = dmov_cod_prod 
										AND prod_cod_empr = dmov_cod_empr 
										AND dmov_num_comp = minv_num_comp 
										AND dmov_num_prdo = minv_num_prdo 
										AND dmov_cod_empr = minv_cod_empr 
										AND dmov_cod_ejer = minv_cod_ejer 
										AND minv_cod_tran = tran_cod_tran 
										AND minv_cod_empr = tran_cod_empr 
										AND minv_cod_modu = tran_cod_modu 
										AND tran_cod_tran = defi_cod_tran 
										AND tran_cod_empr = defi_cod_empr 
										AND tran_cod_modu = defi_cod_modu 
										AND prbo_cod_bode = $bod 
										AND prbo_cod_empr = $idempresa 
										AND prbo_cod_sucu = $sucursal 
										AND prbo_cos_prod =  '2' 
										AND dmov_can_dmov <> 0 
										AND prod_cod_prod BETWEEN '$prod' AND '$prod' 
										AND dmov_bod_envi = $bod 
										AND minv_fmov BETWEEN '$fecha_ini' AND '$fecha_fin' 
										AND minv_cod_empr = $idempresa 
										AND defi_tip_defi IN ( '0', '1', '5', '6' ) 
										AND prod_cod_tpro = '2' 
									ORDER BY
										1,
										2,
										4,
										3
									) AS tabla1
									order by prod_cod_prod, minv_fmov, defi_tip_defi, minv_num_comp, minv_cod_tran
                                       ";
    $array_registros_posteriores = array();
    if ($oIfx->Query($sql_costo_prom)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $prod_cod_prod = $oIfx->f('prod_cod_prod');
                $minv_fmov = $oIfx->f('minv_fmov');
                $minv_fac_prov = $oIfx->f('minv_fac_prov');
                $minv_cm1_minv = $oIfx->f('minv_cm1_minv');
                $defi_tip_defi = $oIfx->f('defi_tip_defi');
                $minv_cod_tran = $oIfx->f('minv_cod_tran');
                $dmov_can_dmov = $oIfx->f('dmov_can_dmov');
                $dmov_pun_dmov = $oIfx->f('dmov_pun_dmov');
                $minv_num_comp = $oIfx->f('minv_num_comp');
                $dmov_cod_dmov = $oIfx->f('dmov_cod_dmov');

                $data = array(
                    "prod_cod_prod" => $prod_cod_prod,
                    "minv_fmov" => $minv_fmov,
                    "minv_fac_prov" => $minv_fac_prov,
                    "minv_cm1_minv" => $minv_cm1_minv,
                    "defi_tip_defi" => $defi_tip_defi,
                    "minv_cod_tran" => $minv_cod_tran,
                    "dmov_can_dmov" => $dmov_can_dmov,
                    "dmov_pun_dmov" => $dmov_pun_dmov,
                    "minv_num_comp" => $minv_num_comp,
                    "dmov_cod_dmov" => $dmov_cod_dmov,
                );
                array_push($array_registros_posteriores, $data);
            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();


    $entra_iniciar_calculo = 'N';
    $cantidad_saldo_ad = 0;
    $costo_saldo_ad = 0;
    $costo_prom = 0;
    $total_saldo_ad = 0;

    foreach ($array_registros_posteriores as $key => $data_movimientos_dmov) {
        $prod_cod_prod = $data_movimientos_dmov['prod_cod_prod'];
        $minv_fmov = $data_movimientos_dmov['minv_fmov'];
        $minv_fac_prov = $data_movimientos_dmov['minv_fac_prov'];
        $minv_cm1_minv = $data_movimientos_dmov['minv_cm1_minv'];
        $defi_tip_defi = $data_movimientos_dmov['defi_tip_defi'];
        $minv_cod_tran = $data_movimientos_dmov['minv_cod_tran'];
        $dmov_can_dmov = $data_movimientos_dmov['dmov_can_dmov'];
        $dmov_pun_dmov = $data_movimientos_dmov['dmov_pun_dmov'];
        $minv_num_comp = $data_movimientos_dmov['minv_num_comp'];
        $dmov_cod_dmov = $data_movimientos_dmov['dmov_cod_dmov'];

        if ($defi_tip_defi == 0) {
            // INGRESOS DE INVENTARIO (COMPRAS QUE MODIFICAN EL COSTO PROMEDIO PONDERADO) 
            $cantidad_mov = $dmov_can_dmov;
            $costo_mov = $dmov_pun_dmov;
            $total_mov = number_format($cantidad_mov * $costo_mov, 6, '.', '');

            $cantidad_saldo_ad += $cantidad_mov;
            $total_saldo_ad = ($total_saldo_ad + $total_mov);
            if (empty($cantidad_saldo_ad)) {
                $costo_saldo_ad = $total_saldo_ad;
            } else {
                $costo_saldo_ad = $total_saldo_ad / $cantidad_saldo_ad;
            }

            $costo_prom = number_format($costo_saldo_ad, 6, '.', '');
            $ultimo_costo_compra = $costo_prom;

            // ----------------------------------------------------------------------------------------------------------------------
            // Actualizamos los campos de la saeprbo: prbo_uco_prod => Costo promedio ponderado;   prbo_cto_prod => Ultimo costo de compra
            // ----------------------------------------------------------------------------------------------------------------------

            if ($costo_prom > 0) {
                $costo_prom = number_format($costo_prom, 6, '.', '');
                if (empty($costo_prom)) {
                    $costo_prom = $ultimo_costo_compra;
                }
                $ultimo_costo_compra = number_format($ultimo_costo_compra, 6, '.', '');
                $sql_update_bode = "UPDATE saeprbo set prbo_uco_prod = $costo_prom, prbo_cto_prod = $ultimo_costo_compra where
                                                        prbo_cod_empr = $idempresa and
                                                        prbo_cod_sucu = $sucursal and
                                                        prbo_cod_bode = $bod and
                                                        prbo_cod_prod = '$prod' 
                                                        ";
                $oIfx->QueryT($sql_update_bode);
            }


            $sql_update_dmov = "UPDATE 
                                                    saedmov 
                                                set
                                                    dmov_cost_pro = $costo_prom,
                                                    dmov_nuev_sal = $total_saldo_ad
                                                where
                                                    dmov_num_comp = $minv_num_comp and
                                                    dmov_cod_dmov = $dmov_cod_dmov and
                                                    dmov_cod_prod = '$prod'";
            $oIfx->QueryT($sql_update_dmov);

            // ----------------------------------------------------------------------------------------------------------------------
            // FIN Actualizamos los campos de la saeprbo: prbo_uco_prod => Costo promedio ponderado;   prbo_cto_prod => Ultimo costo de compra
            // ----------------------------------------------------------------------------------------------------------------------




        } else {

            // EGRESOS DE INVENTARIO
            if ($costo_prom > 0) {


                // La cantidad viene en negativo por esto no debemos restar sino sumar
                $cantidad_mov = $dmov_can_dmov;
                $costo_mov = $costo_prom;
                $total_mov = number_format($cantidad_mov * $costo_mov, 6, '.', '');


                $cantidad_saldo_ad += $cantidad_mov;
                $total_saldo_ad = ($total_saldo_ad + $total_mov);
                if (empty($cantidad_saldo_ad)) {
                    $costo_saldo_ad = $total_saldo_ad;
                } else {
                    $costo_saldo_ad = $total_saldo_ad / $cantidad_saldo_ad;
                }

                // ----------------------------------------------------------------------------------------------------------------------
                // Actualizamos los campos de la saedmov: dmov_cun_dmov => Costo del producto al hacer el egreso; dmov_pun_dmov => Mismo de la dmov_cun_dmov; dmov_cto_dmov => Calculo de la cantidad por el costo
                // ----------------------------------------------------------------------------------------------------------------------

                $calculo_can_cost = number_format(abs($dmov_can_dmov) * $costo_prom, 6, '.', '');
                $sql_update_dmov = "UPDATE 
                                                        saedmov 
                                                    set 
                                                        dmov_cun_dmov = $costo_prom, 
                                                        dmov_pun_dmov = $costo_prom, 
                                                        dmov_cto_dmov = $calculo_can_cost, 
                                                        dmov_det1_dmov = 'S',
                                                        dmov_cost_pro = $costo_prom,
                                                        dmov_nuev_sal = $total_saldo_ad
                                                    where
                                                        dmov_num_comp = $minv_num_comp and
                                                        dmov_cod_dmov = $dmov_cod_dmov and
                                                        dmov_cod_prod = '$prod'";
                $oIfx->QueryT($sql_update_dmov);

                // ----------------------------------------------------------------------------------------------------------------------
                // FIN Actualizamos los campos de la saeprbo: prbo_uco_prod => Costo promedio ponderado;   prbo_cto_prod => Ultimo costo de compra
                // ----------------------------------------------------------------------------------------------------------------------


            }
        }

        //
    }



    // -----------------------------------------------------------------------------------------
    // FIN NUEVO PROCESO CALCULO COSTO PROMEDIO ADRIAN47
    // -----------------------------------------------------------------------------------------

    return 'OK';

}

function generar_recepcion_only_read( $idempresa="", $idsucursal="", $cod_prod="", $cliente_nombre="", $informacion_evaluacion){
	global $DSN_Ifx, $DSN;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $oConA = new Dbo;
    $oConA->DSN = $DSN;
    $oConA->Conectar();
    
    $oConB = new Dbo;
    $oConB->DSN = $DSN;
    $oConB->Conectar();

    $idEmpresa = $_SESSION['U_EMPRESA'];
	
	
	$class = new GeneraDetalleInventario();

    // var_dump($informacion_evaluacion);
    // exit;


    // foreach ($informacion_evaluacion as $key => $value) {
    //     var_dump($value);
    //     exit;
    // }


	
	$sql = "select empr_ruc_empr, empr_dir_empr, empr_nom_empr, empr_path_logo from saeempr where empr_cod_empr = $idempresa ";
	if($oIfx->Query($sql)){
		$empr_ruc           = $oIfx->f('empr_ruc_empr');
		$empr_dir           = $oIfx->f('empr_dir_empr');
		$empr_nom           = $oIfx->f('empr_nom_empr');
		$empr_path_logo     = $oIfx->f('empr_path_logo');
		$empr_nom.=' ';
	}
	$sql="SELECT sucu_nom_sucu FROM saesucu WHERE sucu_cod_sucu='$idsucursal'";
	if($oIfx->Query($sql)){
		$sucu_nom = $oIfx->f('sucu_nom_sucu');
	}
	




    $sql = "select prod_nom_prod from saeprod where
					prod_cod_prod = '$cod_prod' ";
	if($oIfx->Query($sql)){
		$prod_nom_prod = $oIfx->f('prod_nom_prod');
	}
	$oIfx->Free();
    
   
    

    $html.='<table style="margin-left:50px; margin-right:50px; margin-top:30px; font-family: Courier;">
				<tr >
					<td style="font-size:18px; text-align: left">'.$empr_nom.'<br><br></td>
				</tr>
				<tr>
					<td  style="font-size:14px; text-align: left">SUCURSAL:'.$sucu_nom.'<br><br></td>
				</tr>
				<tr>
					<td  style="font-size:14px; text-align: left">DIRECCION:'. $empr_dir.'<br><br></td>
				</tr>
				<tr>
					<td style="font-size:14px; text-align: left">RUC:'.$empr_ruc.'<br><br></td>
				</tr>
                <tr>
                    <td style="font-size:14px; text-align: left">PROVEEDOR: '.$cliente_nombre.'<br><br></td>
                </tr>
			
			</table>
			<table border="0" style="width: 100%; margin-left:50px; margin-top:10px; font-family: Courier;">
                <tr>
					<td style="width: 100%; font-size:12px; text-align: left"><strong>Producto: </strong> '.$cod_prod.' - '.$prod_nom_prod.'<br><br></td>
                </tr>
			</table>';
						

            $html.= '   
                    <table style="margin-left:50px; width:90%;border:1px solid black; border-radius: 5px; margin-top:10px" align="left; font-family: Courier;">
                        
                        <tr>
							<td colspan="5" style="width:100%;font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; "><strong>PARAMETROS PARA LA RECEPCION DEL PRODUCTO</strong></td>
						</tr>
                        <tr>
                            <th style="width:40%; font-size:11px;  text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; ">Parametros</th>
                            <th style="width:10%; font-size:11px;  text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; ">Cumple</th>
                            <th style="width:10%; font-size:11px;  text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; ">No Cumple</th>
                            <th style="width:20%; font-size:11px;  text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; ">Observaciones</th>
                        </tr>';


                    foreach ($informacion_evaluacion as $key => $value) {
                        $id_evaluacion_parametro = $value['id_evaluacion_parametros'];
                        $sneval = $value['sneval'];
                        $observ_eval = $value['observ_eval'];


                        $sql = "select nombre_parametro from recepcion_parametros where id = $id_evaluacion_parametro";
			            $nombre_parametro = consulta_string_func($sql, 'nombre_parametro', $oCon, '');


                        $responsable_eval = '';
                        if($nombre_parametro == 'NOMBRE_RECIBE'){
                            $nombre_recibe = $observ_eval;  
                        }else if($nombre_parametro == 'NOMBRE_ENTREGA'){
                            $nombre_entrega = $observ_eval;
                        }else if($nombre_parametro == 'MOTIVO_NOVEDAD'){
                            $motivo_novedad = $observ_eval;
                        }else if($nombre_parametro == 'DESCRIPCION_NOVEDAD'){
                            $descripcion_novedad = $observ_eval; 
                        }else if($nombre_parametro == 'SN_DEVOLUCION'){
                            $sn_devolucion = $sneval;        
                        }else{

                                        $html.= '  <tr>';
                                        $html.= '  <td style="width:30%; font-size:11px;  text-align: left; border-right:1px solid; border-bottom:1px solid; font-family: Courier; ">'.$nombre_parametro.'</td>';

                                        if($sneval == 'S'){
                                            $html.= '  <td style="width:10%; font-size:11px;  text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; ">X</td>
                                            <td style="width:10%; font-size:11px;  text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; "></td>';
                                        }else{
                                            $html.= '  <td style="width:10%; font-size:11px;  text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; "></td>
                                            <td style="width:10%; font-size:11px;  text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; ">X</td>';
                                            $validacion_no_cumple = 'S';
                                        }
                                        


                                        $html.= '  <td style="width:10%; font-size:11px;  text-align: left; border-right:1px solid; border-bottom:1px solid; font-family: Courier; ">'.strtoupper($observ_eval).'</td>';                                
                                        $html.= '  </tr>';

                        }
               
                        
                        
                    }
                    
                    
                    $html.= '</table>';
			    
            if($sn_devolucion == 'N'){
                $sn_devolucion = 'NO';
            }else{
                $sn_devolucion = 'SI';
            }

     
            
                $html.= '
                    <table style="margin-left:50px; width:90%;border:1px solid black; border-radius: 5px; margin-top:10px" align="left; font-family: Courier;">
                    <tr>
                        <td colspan="4" style="width:100%;font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; "><strong>MOTIVO DE LA NOVEDAD</strong></td>
                    </tr>
                    <tr>
                        <td colspan="4" style="width:100%;font-size:14px; text-align: left; border-bottom:1px solid; font-family: Courier; ">'.strtoupper($motivo_novedad).'</td>
                    </tr>
                    <tr>
                        <td colspan="4" style="width:100%;font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; "><strong>DESCRIPCION DE LA NOVEDAD</strong></td>
                    </tr>
                    <tr>
                        <td colspan="4" style="width:100%;font-size:14px; text-align: left; border-bottom:1px solid; font-family: Courier; ">'.strtoupper($descripcion_novedad).'</td>
                    </tr>
                    <tr>
                        <td style="width:30%;font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; ">DEVOLUCION</td>
                        <td style="width:30%;font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; ">'.$sn_devolucion.'</td>
                    </tr>
                    <tr>
                        <td colspan="4" style="width:100%;font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; ">DEVOLUCION REALIZADA</td>
                    </tr>
                    <tr>
                        <td style="width:30%;font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; ">RECIBE</td>
                        <td style="width:30%;font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; ">ENTREGA</td>
                    </tr>
                    <tr>
                        <td style="width:30%; heigth:30%; font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; ">
                            <br>
                            <br>
                            <br>
                            <br>
                            <br>
                            <br>
                            <hr>
                        </td>
                        <td style="width:30%; heigth:30%; font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; ">
                            <br>
                            <br>
                            <br>
                            <br>
                            <br>
                            <br>
                            <hr>
                        </td>
                    </tr>
                    <tr>
                        <td style="width:30%; font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; ">'.strtoupper($nombre_recibe).'</td>
                        <td style="width:30%; font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; ">'.strtoupper($nombre_entrega).'</td>
                    </tr>
                    
                    
                    </table>

                    ';
            
			    
					
		
	return $html;
	
}

function generar_recepcion_parametros_pdf( $idempresa="", $idsucursal="", $minv_num_comp="",  $tran_cod = '', $ejer_cod="", $prdo_cod="", $cod_prod="", $lote=""){
	global $DSN_Ifx, $DSN;

    session_start();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfx2 = new Dbo;
    $oIfx2->DSN = $DSN_Ifx;
    $oIfx2->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    $oConA = new Dbo;
    $oConA->DSN = $DSN;
    $oConA->Conectar();
    
    $oConB = new Dbo;
    $oConB->DSN = $DSN;
    $oConB->Conectar();

    $idEmpresa = $_SESSION['U_EMPRESA'];
	
	
	$class = new GeneraDetalleInventario();
		
	$arrayMinv = $class->generaSaeminv($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $tran_cod, $minv_num_comp);
	
	// $arrayDmov = $class->generaSaedmov($oIfx, $idempresa, $idsucursal, $ejer_cod, $prdo_cod, $minv_num_comp );
	
	//var_dump($arrayRetencion);exit;
	foreach($arrayMinv as $val){				
		$minv_num_sec	= $val[0];
		$minv_cod_clpv  = $val[1];
		$minv_fmov      = $val[2];
		$minv_fac_prov  = $val[3];
		$minv_tot_minv  = $val[4];
		$minv_iva_valo  = $val[5];
		$minv_cm1_minv  = $val[6];
        $minv_hor_minv  = $val[7];
        $minv_cod_mone  = $val[8];
        $minv_nom_clpv  = $val[9];
        $minv_nomb_resp = $val[10];
	}


    /*
    foreach($arrayDmov as $val){				
		$dmov_can_dmov  = $val[5];
		$dmov_reg_sani  = $val[11];
	}
    */
	
	$sql = "select empr_ruc_empr, empr_dir_empr, empr_nom_empr, empr_path_logo from saeempr where empr_cod_empr = $idempresa ";
	if($oIfx->Query($sql)){
		$empr_ruc           = $oIfx->f('empr_ruc_empr');
		$empr_dir           = $oIfx->f('empr_dir_empr');
		$empr_nom           = $oIfx->f('empr_nom_empr');
		$empr_path_logo     = $oIfx->f('empr_path_logo');
		$empr_nom.=' ';
	}
	$sql="SELECT sucu_nom_sucu FROM saesucu WHERE sucu_cod_sucu='$idsucursal'";
	if($oIfx->Query($sql)){
		$sucu_nom = $oIfx->f('sucu_nom_sucu');
	}


    /*
    $sql="SELECT dmov_reg_sani, dmov_can_dmov  FROM saedmov WHERE dmov_num_comp = $minv_num_comp and dmov_cod_prod = '$cod_prod' and dmov_cod_lote = '$lote'";
    if($oIfx->Query($sql)){
		// $sucu_nom = $oIfx->f('sucu_nom_sucu');
        $dmov_can_dmov  = $oIfx->f('dmov_can_dmov');
		$dmov_reg_sani  = $oIfx->f('dmov_reg_sani');
	}
    */


	
	
	$sql = "select tran_des_tran from saetran where
					tran_cod_empr = $idempresa and
					tran_cod_sucu = $idsucursal and
					tran_cod_tran = '$tran_cod' ";
	if($oIfx->Query($sql)){
		$tran_nom_tran = $oIfx->f('tran_des_tran');
	}
	$oIfx->Free();
	setlocale(LC_ALL,"es_ES@euro","es_ES","esp");

    $asto_fec = strftime("%d de %B de %Y", strtotime($asto_fec));


    $sql = "select prod_nom_prod from saeprod where
					prod_cod_prod = '$cod_prod' ";
	if($oIfx->Query($sql)){
		$prod_nom_prod = $oIfx->f('prod_nom_prod');
	}
	$oIfx->Free();
    
    // MONEDA
    $sql = "select mone_des_mone from saemone where mone_cod_empr = $idempresa and mone_cod_mone = $minv_cod_mone ";
    $moneda =  consulta_string_func($sql, 'mone_des_mone', $oIfx, 0);




    $muestreo_por_prod = 0;
    $sql = "SELECT * FROM compra_muestreo";
    if ($oCon->Query($sql)) {
        if ($oCon->NumFilas() > 0) {
            do {

                $min_cajas = $oCon->f('min_cajas');
                $max_cajas = $oCon->f('max_cajas');
                $muestreo_inspeccion_normal = $oCon->f('muestreo_inspeccion_normal');
                // $muestreo_inspeccion_simplificada = $oCon->f('muestreo_inspeccion_simplificada');

                if($min_cajas <= $dmov_can_dmov && $max_cajas >= $dmov_can_dmov){
                    $muestreo_por_prod = $muestreo_inspeccion_normal;
                }

            } while ($oCon->SiguienteRegistro());
        }
    }
    $oCon->Free();

    

    $html.='<table style="margin-left:50px; margin-right:50px; margin-top:30px; font-family: Courier;">
				<tr >
					<td style="font-size:18px; text-align: left">'.$empr_nom.'<br><br></td>
				</tr>
				<tr>
					<td  style="font-size:14px; text-align: left">SUCURSAL:'.$sucu_nom.'<br><br></td>
				</tr>
				<tr>
					<td  style="font-size:14px; text-align: left">DIRECCION:'. $empr_dir.'<br><br></td>
				</tr>
				<tr>
					<td style="font-size:14px; text-align: left">RUC:'.$empr_ruc.'<br><br></td>
				</tr>
                <tr>
                    <td style="font-size:14px; text-align: left">PROVEEDOR: '.$minv_nom_clpv.'<br><br></td>
                </tr>
				<tr>
					<td style="font-size:14px; text-align: left">N.- MOVIMIENTO  '.$tran_nom_tran.' No:'. $minv_num_sec.' ('.$minv_num_comp.')<br><br></td>
				</tr>				
			</table>
			<table border="0" style="width: 100%; margin-left:50px; margin-top:10px; font-family: Courier;">
				<tr>
					<td   colspan="2" style="width: 100%;font-size:12px; text-align: left"><strong>Fecha:</strong> '.$minv_fmov.'</td>
				</tr>
				<tr>
                <!-- <td   style="width: 100%;font-size:12px; text-align: left"><strong>Moneda:</strong> '.$moneda.'</td> -->
				</tr>
				<tr style="display:none">
                <!-- <td  style="width: 100%; font-size:12px; text-align: left" style="display:none"><strong>Monto: </strong>'.number_format(( $minv_tot_minv + $minv_iva_valo ),2,'.',',').'</td> -->
				</tr>			
				<tr>
                <td colspan="2" style="width: 100%; font-size:12px; text-align: left"><strong>Detalle:</strong> '.strtoupper($minv_cm1_minv).'<br><br></td>
                </tr>	
                <tr>
					<td colspan="2" style="width: 100%; font-size:12px; text-align: left"><strong>Producto: </strong> '.$cod_prod.' - '.$prod_nom_prod.'</td>
                </tr>
                <tr>
                    <td style="width: 100%; font-size:12px; text-align: left"><strong>Lote: </strong> '.$lote.'</td>
                </tr>
                <tr>
					<td  style="width: 100%; font-size:12px; text-align: left"><strong>Cantidad Recibida: </strong> '.$dmov_can_dmov.'</td>
                </tr>
                <tr>
					<td style="width: 100%; font-size:12px; text-align: left"><strong>Cantidad Muestreada: </strong> '.$muestreo_por_prod.'</td>
                </tr>	
                <tr>
                    <td style="width: 100%; font-size:12px; text-align: left"><strong>Registro Sanitario: </strong> '.$dmov_reg_sani.'</td>
                </tr>	
                <tr>
			<!--	<td colspan="2" style="width: 100%; font-size:12px; text-align: left"><strong>Tecnico:</strong> '.$minv_ruc_resp.' - '.$minv_nomb_resp.'<br><br></td> -->
                </tr>
                <tr>
			<!-- <td colspan="2" style="width: 100%; font-size:12px; text-align: left"><strong>N.- Contrato:</strong> '.$contrato.'<br><br></td> -->
				</tr>
			</table>';
						

            $html.= '   
                    <table style="margin-left:50px; width:90%;border:1px solid black; border-radius: 5px; margin-top:10px" align="left; font-family: Courier;">
                        
                        <tr>
							<td colspan="5" style="width:100%;font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; "><strong>PARAMETROS PARA LA RECEPCION DEL PRODUCTO</strong></td>
						</tr>
                        <tr>
                            <th style="width:40%; font-size:11px;  text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; ">Parametros</th>
                            <th style="width:10%; font-size:11px;  text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; ">Cumple</th>
                            <th style="width:10%; font-size:11px;  text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; ">No Cumple</th>
                            <th style="width:20%; font-size:11px;  text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; ">Observaciones</th>
                        </tr>';

                        $nombre_recibe = '';
                        $nombre_entrega = '';
                        $motivo_novedad = '';
                        $descripcion_novedad = '';
                        $sn_devolucion = '';
                        $validacion_no_cumple = 'N';
                                    $sql = "SELECT * FROM recepcion_parametros";
                                    
                                    $nombre_anterior = '';
                                    if ($oConA->Query($sql)) {
                                        if ($oConA->NumFilas() > 0) {
                                            do {


                                                $id_parametro = $oConA->f('id');
                                                $nombre_tipo = $oConA->f('nombre_parametro');

                                               

                                                $sql = "SELECT * 
                                                FROM recepcion_compra_eval as c , recepcion_parametros as p
                                                where c.id_recepcion_parametro = p.id and
                                                c.minv_num_comp = $minv_num_comp and 
                                                c.id_recepcion_parametro = '$id_parametro' and
                                                c.cod_prod = '$cod_prod' and c.lote_prod = '$lote'";



                                          
                                                $responsable_eval = '';
                                                if($nombre_tipo == 'NOMBRE_RECIBE'){

                                              
                                                    if ($oConB->Query($sql)) {
                                                        if ($oConB->NumFilas() > 0) {
                                                            do {
                                                                $nombre_recibe = $oConB->f('observacion');
                                                                
                                                            } while ($oConB->SiguienteRegistro());
                                                        }
                                                    }
                                                    $oConB->Free();

                                                    
                                                }else if($nombre_tipo == 'NOMBRE_ENTREGA'){


                                                    if ($oConB->Query($sql)) {
                                                        if ($oConB->NumFilas() > 0) {
                                                            do {
                                                                $nombre_entrega = $oConB->f('observacion');
                                                                
                                                            } while ($oConB->SiguienteRegistro());
                                                        }
                                                    }
                                                    $oConB->Free();
                                                    
                                                    
                                                }else if($nombre_tipo == 'MOTIVO_NOVEDAD'){


                                                    if ($oConB->Query($sql)) {
                                                        if ($oConB->NumFilas() > 0) {
                                                            do {
                                                                $motivo_novedad = $oConB->f('observacion');
                                                                
                                                            } while ($oConB->SiguienteRegistro());
                                                        }
                                                    }
                                                    $oConB->Free();
                                                    
                                                    
                                                }else if($nombre_tipo == 'DESCRIPCION_NOVEDAD'){


                                                    if ($oConB->Query($sql)) {
                                                        if ($oConB->NumFilas() > 0) {
                                                            do {
                                                                $descripcion_novedad = $oConB->f('observacion');
                                                                
                                                            } while ($oConB->SiguienteRegistro());
                                                        }
                                                    }
                                                    $oConB->Free();
                                                    
                                                    
                                                }else if($nombre_tipo == 'SN_DEVOLUCION'){


                                                    if ($oConB->Query($sql)) {
                                                        if ($oConB->NumFilas() > 0) {
                                                            do {
                                                                $sn_devolucion = $oConB->f('sn_estado');
                                                                
                                                            } while ($oConB->SiguienteRegistro());
                                                        }
                                                    }
                                                    $oConB->Free();
                                                    
                                                    
                                                }else{
                                                   
                                                    if ($oConB->Query($sql)) {
                                                        if ($oConB->NumFilas() > 0) {
                                                            do {
                                                                $sn_estado = $oConB->f('sn_estado');
                                                                $observacion = $oConB->f('observacion');
                                                                $nombre_parametro = $oConB->f('nombre_parametro');

                                                                $html.= '  <tr>';
                                                                $html.= '  <td style="width:30%; font-size:11px;  text-align: left; border-right:1px solid; border-bottom:1px solid; font-family: Courier; ">'.$nombre_parametro.'</td>';

                                                                if($sn_estado == 'S'){
                                                                    $html.= '  <td style="width:10%; font-size:11px;  text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; ">X</td>
                                                                    <td style="width:10%; font-size:11px;  text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; "></td>';
                                                                }else{
                                                                    $html.= '  <td style="width:10%; font-size:11px;  text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; "></td>
                                                                    <td style="width:10%; font-size:11px;  text-align: center; border-right:1px solid; border-bottom:1px solid; font-family: Courier; ">X</td>';
                                                                    $validacion_no_cumple = 'S';
                                                                }
                                                                


                                                                $html.= '  <td style="width:10%; font-size:11px;  text-align: left; border-right:1px solid; border-bottom:1px solid; font-family: Courier; ">'.strtoupper($observacion).'</td>';                                
                                                                $html.= '  </tr>';
                                                            } while ($oConB->SiguienteRegistro());
                                                        }
                                                    }
                                                    $oConB->Free();
                                                }
                                                
                                                

                                                $nombre_anterior = $nombre_tipo;

                                            } while ($oConA->SiguienteRegistro());
                                        }
                                    }
                                    $oConA->Free();


                                
            $html.= '</table>';
			    
            if($sn_devolucion == 'N'){
                $sn_devolucion = 'NO';
            }else{
                $sn_devolucion = 'SI';
            }

         
                $html.= '
                    <table style="margin-left:50px; width:90%;border:1px solid black; border-radius: 5px; margin-top:10px" align="left; font-family: Courier;">
                    <tr>
                        <td colspan="4" style="width:100%;font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; "><strong>MOTIVO DE LA NOVEDAD</strong></td>
                    </tr>
                    <tr>
                        <td colspan="4" style="width:100%;font-size:14px; text-align: left; border-bottom:1px solid; font-family: Courier; ">'.strtoupper($motivo_novedad).'</td>
                    </tr>
                    <tr>
                        <td colspan="4" style="width:100%;font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; "><strong>DESCRIPCION DE LA NOVEDAD</strong></td>
                    </tr>
                    <tr>
                        <td colspan="4" style="width:100%;font-size:14px; text-align: left; border-bottom:1px solid; font-family: Courier; ">'.strtoupper($descripcion_novedad).'</td>
                    </tr>
                    <tr>
                        <td style="width:30%;font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; ">DEVOLUCION</td>
                        <td style="width:30%;font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; ">'.$sn_devolucion.'</td>
                    </tr>
                    <tr>
                        <td colspan="4" style="width:100%;font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; ">DEVOLUCION REALIZADA</td>
                    </tr>
                    <tr>
                        <td style="width:30%;font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; ">RECIBE</td>
                        <td style="width:30%;font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; ">ENTREGA</td>
                    </tr>
                    <tr>
                        <td style="width:30%; heigth:30%; font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; ">
                            <br>
                            <br>
                            <br>
                            <br>
                            <br>
                            <br>
                            <hr>
                        </td>
                        <td style="width:30%; heigth:30%; font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; ">
                            <br>
                            <br>
                            <br>
                            <br>
                            <br>
                            <br>
                            <hr>
                        </td>
                    </tr>
                    <tr>
                        <td style="width:30%; font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; ">'.strtoupper($nombre_recibe).'</td>
                        <td style="width:30%; font-size:14px; text-align: center; border-bottom:1px solid; font-family: Courier; ">'.strtoupper($nombre_entrega).'</td>
                    </tr>
                    
                    
                    </table>

                    ';
        
            
					
		
	return $html;
	
}




function verifica_serie_prod($idempresa = 0, $idproducto = '', $lote = '')
{
    //Definiciones
    global $DSN_Ifx;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oIfxC = new Dbo;
    $oIfxC->DSN = $DSN_Ifx;
    $oIfxC->Conectar();

    $oReturn = new xajaxResponse();

    // -------------------------------------------------------------------------------
    // Consultamos si existe la serie en la bodega solicitada
    // -------------------------------------------------------------------------------

    $lote = trim($lote);
    $id_user = $_SESSION['U_ID'];
    $fecha_ini = '2000-01-01';
    $fecha_fin = '2050-01-01';
    $serie_bodega_array = array();

    $sql = "DELETE from tmp_prod_lote_web where user_cod_web = $id_user";
    $oIfx->QueryT($sql);
    // -----------
    // SUCURSALES
    // -----------
    $sql_sucursales = "SELECT * from saesucu where sucu_cod_empr = $idempresa";
    if ($oIfx->Query($sql_sucursales)) {
        if ($oIfx->NumFilas() > 0) {
            do {

                $idsucursal = $oIfx->f('sucu_cod_sucu');

                // -----------
                // BODEGAS
                // -----------
                $sql_bodegas = "SELECT * from saebode
                                    inner join saesubo
                                        on subo_cod_bode = bode_cod_bode
                                     where subo_cod_sucu = $idsucursal";
                $cont_bode = 0;
                if ($oIfxA->Query($sql_bodegas)) {
                    if ($oIfxA->NumFilas() > 0) {
                        do {

                            $idbodega = $oIfxA->f('bode_cod_bode');

                            $sql_sp = "SELECT * from sp_lotes_productos_web( $idempresa, $idsucursal, $idbodega, '$fecha_ini', '$fecha_fin', '$idproducto', '$idproducto', '2' , $id_user, '$lote')";
                            $oIfxC->Query($sql_sp);

                            $cont_bode++;
                        } while ($oIfxA->SiguienteRegistro());
                    }
                }
                $oIfxA->Free();
                // -----------
                // FIN BODEGAS
                // -----------

                
          

            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();
    // -----------
    // FIN SUCURSALES
    // -----------


    // -----------
    // PRODUCTO
    // -----------
    $sql_nombre_producto = "SELECT prod_nom_prod from saeprod where prod_cod_prod = '$idproducto'";
    $prod_nom_prod = consulta_string_func($sql_nombre_producto, 'prod_nom_prod', $oIfx, '');
    $prod_nom_prod = '(' . $idproducto . ') ' . $prod_nom_prod;
    // -----------
    // FIN PRODUCTO
    // -----------
    

    $sql_busca_lote = "SELECT sum(cant_lote) as cant, num_lote,  MAX(fecha_ela_lote) as felab, MAX(fecha_cad_lote) as fcad, 
                                        prod_cod_prod, prod_nom_prod, costo, bode_cod_bode
                                        from tmp_prod_lote_web where
                                        user_cod_web  = $id_user and
                                        --bode_cod_bode = $idbodega and
                                        empr_cod_empr = $idempresa and
                                        --sucu_cod_sucu = $idsucursal and
                                        prod_cod_prod = '$idproducto' and
                                        num_lote = '$lote'
                                        group by 2, 5, 6, 7, 8
                                        having  sum(cant_lote) <> 0
                                        order by fcad 
                                        limit 800
                                        ";

    if ($oIfx->Query($sql_busca_lote)) {
        if ($oIfx->NumFilas() > 0) {
            do {

                $idbodega_sp = $oIfx->f('bode_cod_bode');
                $cantidad = $oIfx->f('cant');

                $sql_nombre_bodega = "SELECT bode_nom_bode from saebode where bode_cod_bode = $idbodega_sp";
                $bode_nom_bode = consulta_string_func($sql_nombre_bodega, 'bode_nom_bode', $oIfxA, '');
                $bode_nom_bode = '(' . $idbodega_sp . ') ' . $bode_nom_bode;

                $data = array(
                    "bodega" => $bode_nom_bode,
                    "producto" => $prod_nom_prod,
                    "lote" => $lote,
                    "cantidad" => $cantidad
                );
                array_push($serie_bodega_array, $data);

            } while ($oIfx->SiguienteRegistro());
        }
    }
    $oIfx->Free();

   



    // -------------------------------------------------------------------------------
    // FIN Consultamos si existe la serie en la bodega solicitada
    // -------------------------------------------------------------------------------



    return $serie_bodega_array;
}





function reporte_factura_export_dorfzaun($id = '', $nombre_archivo = '', $idSucursal ='', &$rutaPdf = '') {
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    //$idSucursal = $_SESSION['U_SUCURSAL'];

    //CAMPOS APROBACION
    $sqlgein="SELECT count(*) as conteo
     FROM INFORMATION_SCHEMA.COLUMNS
     WHERE COLUMN_NAME = 'empr_fac_empr' AND TABLE_NAME = 'saeempr'";
    $ctralter=consulta_string($sqlgein,'conteo',$oCon,0);
    if($ctralter==0){
        $sqlalter="alter table saeempr add  empr_fac_empr varchar(1)";
        $oCon->QueryT($sqlalter);
    }


    $sqlgein="SELECT count(*) as conteo
     FROM INFORMATION_SCHEMA.COLUMNS
     WHERE COLUMN_NAME = 'empr_det_fac' AND TABLE_NAME = 'saeempr'";
    $ctralter=consulta_string($sqlgein,'conteo',$oCon,0);
    if($ctralter==0){
        $sqlalter="alter table saeempr add  empr_det_fac text";
        $oCon->QueryT($sqlalter);
    }

    //VALIDAICON DETALLE

    $sqlfa="select para_dfa_para from saepara where para_cod_empr= $idEmpresa and para_cod_sucu=$idSucursal";
    $para_dfa_para=consulta_string($sqlfa,'para_dfa_para',$oCon,'');

    $sqlfa="select empr_fac_empr, empr_det_fac from saeempr where empr_cod_empr=$idEmpresa ";
    $obfact=consulta_string($sqlfa,'empr_fac_empr',$oCon,'');
    $obdetfact=consulta_string($sqlfa,'empr_det_fac',$oCon,'');

    $sql = "select empr_sn_conta, empr_cod_pais,empr_cm1_empr, empr_rimp_sn, empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr,empr_tel_resp, empr_ac1_empr, empr_ac2_empr, empr_mai_empr, empr_tip_empr
                                            from saeempr where empr_cod_empr = $idEmpresa ";


    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            $tel_empresa = $oIfx->f('empr_tel_resp');
            $empr_mai_empr = $oIfx->f('empr_mai_empr');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';
            $empr_rimp_sn = $oIfx->f('empr_rimp_sn');
            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
            $empr_ac1_empr = $oIfx->f('empr_ac1_empr');
            $empr_ac2_empr = $oIfx->f('empr_ac2_empr');
            $empr_cm1_empr = $oIfx->f('empr_cm1_empr');
            $empr_cod_pais = $oIfx->f('empr_cod_pais');
            $empr_tip_empr = $oIfx->f('empr_tip_empr');
            $empr_sn_conta = $oIfx->f('empr_sn_conta');
        }
    }
    $oIfx->Free();

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis, sucu_telf_secu  from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
            $sucu_telf_secu = $oIfx->f('sucu_telf_secu');
        }
    }
    $oIfx->Free();

    //VALIDACION SUSCURSALES

    $sqls="select count(*) as cont from saesucu";
    $contsucu=consulta_string($sqls,'cont',$oIfx,0);

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }

    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;



    // $path_logo_img = DIR_FACTELEC . 'imagenes/logos/' . $path_img[$count];
    $path_logo_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];
    if (file_exists($path_logo_img)) {
        //echo "El fichero $nombre_fichero existe";
    } else {
        //echo "El fichero $nombre_fichero no existe";
        $path_logo_img = "https://turbologo.com/articles/wp-content/uploads/2019/05/no-logo.png";
    }
    
    $font_family = 'Monterchi Serif Trial';
    $logo .= '<table style="width: 100%; margin: 0px;">';
    $logo .= '<tr>';
    $logo .= '<td align="left" style="width: 55%; border:0px solid white; border-radius: 5px; margin: 0px;">';
    $logo .= '<table width: 55%; valign="center" style="margin: 0px;">';
    $logo .= '<tr><td style="margin-top: 0px;"><img width="250px;"  src="' . $path_logo_img . '"></td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="left" style="font-size: 15px;"><b>Emisor:</b> ' . $razonSocial . '</td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>RUC:</b> ' . $ruc_empr . '</td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="left" style="font-size: 13px;" width="500"><b>Matriz:</b> ' . $dirMatriz . '</td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';


    //selecciona sucursales y direcciones
    $sql_sucu_matriz = "select sucu_dir_sucu from saesucu where sucu_nom_sucu ='MATRIZ'";
    $matriz = consulta_string($sql_sucu_matriz, 'sucu_dir_sucu', $oIfx, '');
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    $emprce="select empr_num_resu from saeempr where empr_cod_empr=$idEmpresa";
    $contribuyente= consulta_string($emprce, 'empr_num_resu', $oIfx, '');
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                //$logo .= '<tr><td align="center" style="font-size: 12px">' . $sucu_nom_sucu . ': ' . htmlentities($sucu_dir_sucu) . '</td></tr>';
                //$logo .= '<tr><td align="center" style="font-size: 13px">SUCURSAL : ' . $sucu_nom_sucu . '</td></tr>';

                ///$logo .= '<tr><td style="position:top; width:50px;"><h4>Direccion Matriz:</h4></td></tr><br>';
                //$logo .= '<tr><td>' . htmlentities($dirMatriz) . '</td></tr>';
                if( $contsucu>1){
                    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>Sucursal:</b> ' . $sucu_nom_sucu . '</td></tr>';

                    $logo .= '<tr><td align="left" style="font-size: 13px;" width="500" ><b>Direcci&oacute;n Sucursal:</b>' . $sucu_dir_sucu.'</td></tr>';
                }





            } while ($oIfx->SiguienteRegistro());
        }
    }
    //$logo .= '<tr><td>&nbsp;</td></tr>';

    //DATOS ADICIONALES
    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>Correo:</b> ' .  $empr_mai_empr . '</td></tr>';

    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>Tel&eacute;fono:</b> ' . $sucu_telf_secu . '</td></tr>';


    if ($empr_tip_empr == 'S') {
        $logo .= '<tr><td align="left" style="font-size: 12px;"><b>Contribuyente Especial #:</b> ' . $empr_num_resu . '</td></tr>';
    }//fin if*/
    /*if($empr_conta_sn=='SI'){
        $logo .= '<tr><td align="center" style="font-size: 12px;"><b>Contribuyente Especial #:</b> '.$contribuyente.'</td></tr>';
    }*/

    if(!empty($empr_ac2_empr)){
        $empr_ac2_empr = '<b>Agente de Retención Resolución Nro:</b> '.$empr_ac2_empr;
    }
    /*else{
        $empr_ac2_empr ='<b>AGENTE DE RETENCI&Oacute;N:</b> NO';
    }*/


    if($empr_conta_sn=='SI'){
        if($empr_sn_conta=='S'){
            $empr_sn_conta ='SI';
        }
        else{
            $empr_sn_conta ='NO';
        }
        $logo .= '<tr><td align="center" style="font-size: 12px;">Obligado a llevar Contabilidad :' . $empr_sn_conta . '</td></tr>';
    }
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    if($empr_rimp_sn=="S"){
        $logo .= '<tr><td align="left" style="font-size: 12px;"><b>CONTRIBUYENTE R&Eacute;GIMEN RIMPE</b></td></tr>';
    }
    $logo .= '<tr><td align="left" style="font-size: 12px;">'.$empr_ac2_empr.'</td></tr>';

    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= ' </table>';
    $logo .= '</td>';

    $sqlFac = "select * from saefact where fact_cod_fact = $id;";

    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $fact_nse_fact = $oIfx->f('fact_nse_fact');
                $fact_num_preimp = $oIfx->f('fact_num_preimp');
                $fact_auto_sri = $oIfx->f('fact_auto_sri');
                $fact_fech_sri = $oIfx->f('fact_fech_sri');
                $fact_nom_cliente = $oIfx->f('fact_nom_cliente');
                $fact_fech_fact = fecha_mysql_func($oIfx->f('fact_fech_fact'));
                $fact_ruc_clie = $oIfx->f('fact_ruc_clie');
                $fact_tlf_cliente = $oIfx->f('fact_tlf_cliente');
                $fact_dir_clie = htmlentities($oIfx->f('fact_dir_clie'));
                $fact_email_clpv = str_replace(' ', '', $oIfx->f("fact_email_clpv"));
                $fact_con_miva = $oIfx->f('fact_con_miva');
                $fact_sin_miva = $oIfx->f('fact_sin_miva');
                $fact_tot_fact = $oIfx->f('fact_tot_fact');
                $fact_iva = $oIfx->f('fact_iva');
                $fact_ice = $oIfx->f('fact_ice');
                $fact_clav_sri  = $oIfx->f('fact_clav_sri');
                $fact_dsg_valo  = $oIfx->f('fact_dsg_valo');
                $fact_cm1_fact  = trim($oIfx->f("fact_cm1_fact"));
                $fact_cm2_fact  = $oIfx->f("fact_cm2_fact");
                $fact_cm4_fact  = $oIfx->f("fact_cm4_fact");
                $orden_compra   = $oIfx->f("fact_opc_fact");
                $fact_cod_clpv  = $oIfx->f("fact_cod_clpv");
                $fact_cod_ccli  = $oIfx->f("fact_cod_ccli");
                $fact_dia_plazo = $oIfx->f("fact_dia_fact");
                $fact_fech_venc = fecha_mysql_func($oIfx->f("fact_fech_venc"));
                $fact_cm3_fact  = $oIfx->f("fact_cm3_fact");
                $fact_cod_contr = $oIfx->f("fact_cod_contr");

                $fact_term_expor = $oIfx->f('fact_term_expor');
                if(empty($fact_term_expor)){
                    $fact_term_expor='NULL';
                }
                $fact_cod_pais = $oIfx->f('fact_cod_pais');
                $fact_cod_ffue = $oIfx->f('fact_cod_ffue');
                if(empty($fact_cod_ffue)){
                    $fact_cod_ffue='NULL';
                }
                $fact_fec_emb = $oIfx->f('fact_fec_emb');
                $fact_prto_emb = $oIfx->f('fact_prto_emb');
                if(empty($fact_prto_emb)){
                    $fact_prto_emb='NULL';
                }
                $fact_prto_dest = $oIfx->f('fact_prto_dest');
                if(empty($fact_prto_dest)){
                    $fact_prto_dest='NULL';
                }
                $fact_fle_fact = $oIfx->f('fact_fle_fact');
                $fact_otr_fact = $oIfx->f('fact_otr_fact');
                $fact_fin_fact = $oIfx->f('fact_fin_fact');

                $id_usuario_w = $oIfx->f("fact_user_web");
                $sql = "select usuario_user, usuario_nombre, usuario_apellido  from comercial.usuario where usuario_id = '$id_usuario_w' ";
                if($oCon->Query($sql)){
                    if($oCon->NumFilas() > 0){
                        $usuario=$codigo = $oCon->f('usuario_nombre').' '.$oCon->f('usuario_apellido');
                    }
                }

                //PAIS
                if ($fact_cod_pais == '') {
                    $fact_cod_pais = 0;
                }
                $sql_pais = "select pais_des_pais from saepais where pais_cod_pais = $fact_cod_pais";
                $pais = consulta_string_func($sql_pais, 'pais_des_pais', $oIfxA, '--');

                //EMBARQUE ORIGEN
                $sql_emb_1 = "select prto_des_prto from saeprto where prto_cod_prto = $fact_prto_emb";
                $prto_1 = consulta_string_func($sql_emb_1, 'prto_des_prto', $oIfxA, '--');

                //EMBARQUE DESTINO
                $sql_emb_2 = "select prto_des_prto from saeprto where prto_cod_prto = $fact_prto_dest";
                $prto_2 = consulta_string_func($sql_emb_2, 'prto_des_prto', $oIfxA, '--');

                // Icoterm
                $sql_tem = "select id, nombre from comercial.incoterm where id = $fact_term_expor;";
                $term = consulta_string_func($sql_tem, 'nombre', $oIfxA, '');

                // DAE
                $sql_fue = "select ffue_fue_ffue    from saeffue where
                                ffue_cod_ffue  = $fact_cod_ffue ";
                $dae = consulta_string_func($sql_fue, 'ffue_fue_ffue', $oIfxA, '');


                $logo .= '<b><td style="width: 45%; border: 0px solid black; border-radius: 5px;" align="right">';
                $logo .= ' <table align="center" style="font-size: 15px;">';
                $logo .= ' <tr>';
                $logo .= '<td style="border-bottom: 0px inset black; font-size: 20px !important">FACTURA</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>Serie:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . substr($fact_nse_fact, 0, 3) . '-' . substr($fact_nse_fact, 3, 6) . ' <label style="color: red">' . $fact_num_preimp . '</label></td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>Autorización:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fact_auto_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>Fecha Autorización:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fact_fech_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td >Ambiente:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $ambiente_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td >Emision:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $emision_sri . '</td>';
                $logo .= ' </tr>';

                //verifica si existe clave de acceso
                if ($fact_clav_sri != '') {
                    $nombArch = $fact_nse_fact . $fact_num_preimp;
                    //$nombArch = '0112201401179141325300110010010000048101234567818';
                    $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';

                    new barCodeGenrator($fact_clav_sri, 1, $rutaCodi, 450, 100, true);

                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="right" style="font-size: 12px;">Clave De Acceso</td>';
                    $logo .= '</tr>';
                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="center"> <img width="400px;" src="' . $rutaCodi . '"/></td>';
                    $logo .= '</tr>';
                }

                $logo .= ' </table>';
                $logo .= '</td></b>';
                $logo .= '</tr>';
                $logo .= '</table>';
                $logo .= ' <br>';

                $logo .= ' <hr>';
                $logo .= ' <br>';
                $logo .= ' <br>';

                $cliente .= ' <table style="width: 100%; border:0px solid white; border-radius: 5px; padding: 0px; font-size: 15x;">';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 13%;">CLIENTE:</td></b>';
                $cliente .= ' <td style="width: 45%; ">' . $fact_nom_cliente . '</td>';
                $cliente .= ' <b><td style="width: 15%; ">FECHA EMISION:</td></b>';
                $cliente .= ' <td style="width: 27% ">' . $fact_fech_fact . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 13%;">RUC:</td></b>';
                $cliente .= ' <td style="width: 45%; ">' . $fact_ruc_clie . '</td>';
                $cliente .= ' <b><td style="width: 15%; ">TELEFONO</td></b>';
                $cliente .= ' <td style="width: 27% ">' . $fact_tlf_cliente . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 13%;">DIRECCION:</td></b>';
                $cliente .= ' <td style="width: 45%; ">' . $fact_dir_clie . '</td>';
                $cliente .= ' <b><td style="width: 15%; ">EMAIL:</td></b>';
                $cliente .= ' <td style="width: 27% ">' . $fact_email_clpv . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 13%;">PAIS ORIGEN:</td></b>';
                $cliente .= ' <td style="width: 45%; ">ECUADOR</td>';
                $cliente .= ' <b><td style="width: 15%; ">PUERTO ORIGEN:</td></b>';
                $cliente .= ' <td style="width: 27% ">' . $prto_1 . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 13%;">FECHA EMB:</td></b>';
                $cliente .= ' <td style="width: 45%; ">' . $fact_fec_emb . '</td>';
                $cliente .= ' <b><td style="width: 15%; ">PUERTO DESTINO:</td></b>';
                $cliente .= ' <td style="width: 27% ">' . $prto_2 . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 13%;">PAIS DESTINO:</td></b>';
                $cliente .= ' <td style="width: 45%; ">' . $pais . '</td>';
                $cliente .= ' <b><td style="width: 13%; "></td></b>';
                $cliente .= ' <td style="width: 29% "></td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 13%;">INCOTERM:</td></b>';
                $cliente .= ' <td style="width: 45%; ">' . $term . '</td>';
                $cliente .= ' <b><td style="width: 13%; "></td></b>';
                $cliente .= ' <td style="width: 29% "></td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 13%;">DAE:</td></b>';
                $cliente .= ' <td style="width: 45%; ">' . $dae . '</td>';
                $cliente .= ' <b><td style="width: 13%; "></td></b>';
                $cliente .= ' <td style="width: 29% "></td>';
                $cliente .= ' </tr>';

                // -------------------------------------------------------------------------
                // campos fedexport solucion temporal borrar
                // -------------------------------------------------------------------------
                if($ruc_empr == 1790312143001 || $ruc_empr == 1791870158001){

                    $sql_oc = "SELECT orden_compra from contrato_clpv where id_clpv = $fact_cod_clpv and
                                id_empresa = $idEmpresa";
                    $orden_compra = consulta_string_func($sql_oc, 'orden_compra', $oIfxA, '');

                    $cliente .= ' <tr>';
                    $cliente .= ' <b><td style="width: 10% ">:</td></b>';
                    $cliente .= ' <td style="width: 48% "></td>';
                    $cliente .= ' <b><td style="width: 13% ">ORDEN DE COMPRA:</td></b>';
                    $cliente .= ' <td style="width: 29% ">' . $orden_compra . '</td>';
                    $cliente .= ' </tr>';

                }
                // -------------------------------------------------------------------------
                // FIn campos fedexport solucion temporar borrar
                // -------------------------------------------------------------------------


                $cliente .= ' </table>';

                $cliente .= ' <br>';
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $oIfx->Free();

    $sqlDeta = "select * from saedfac where dfac_cod_fact = $id and 
                dfac_cod_sucu = $idSucursal and 
                dfac_cod_empr = $idEmpresa  ";

    $deta .= ' <table style="width: 100%; font-size: 13px; border-radius: 5px; border-collapse: collapse;" border="0">';
    $deta .= ' <tr>';
    $deta .= ' <b> <td style="width: 16%;" align="center" border="1"><label style="">CODIGO</label></td> </b>';
    
    $deta .= ' <b> <td style="width: 15%;" align="center" border="1"><label style="">COD. CLIENTE</label></td> </b>';
    
    $deta .= ' <b> <td style="width: 35%;" align="center" border="1"><label style="">DESCRIPCION</label></td> </b>';
    
    $deta .= ' <b> <td style="width:  8%;" align="center" border="1"><label style="">CANT.</label></td> </b>';
    $deta .= ' <b> <td style="width:  8%;" align="center" border="1"><label style="">PRECIO</label></td> </b>';
    $deta .= ' <b> <td style="width:  8%;" align="center" border="1"><label style="">DSCTO %</label></td> </b>';
    $deta .= ' <b> <td style="width: 10%;" align="center" border="1"><label style="">TOTAL</label></td> </b>';
    $deta .= ' </tr>';

    $total_cant=0;

    if ($oIfx->Query($sqlDeta)) {
        if ($oIfx->NumFilas() > 0) {
            $porcIva = '';
            do {
                $dfac_cod_prod = $oIfx->f('dfac_cod_prod');
                $dfac_nom_prod = $oIfx->f('dfac_nom_prod');
                $dfac_cant_dfac = $oIfx->f('dfac_cant_dfac');
                $total_cant+=$dfac_cant_dfac;
                $dfac_precio_dfac = $oIfx->f('dfac_precio_dfac');
                $dfac_des1_dfac = $oIfx->f('dfac_des1_dfac');
                $dfac_des2_dfac = $oIfx->f('dfac_des2_dfac');
                $dfac_por_dsg = $oIfx->f('dfac_por_dsg');
                $dfac_mont_total = $oIfx->f('dfac_mont_total');
                $dfac_num_comp = $oIfx->f('dfac_tip_dfac');
                $dfac_por_iva = $oIfx->f('dfac_por_iva');
                $dfac_det_dfac = $oIfx->f('dfac_det_dfac');

                if ($dfac_por_iva > 0) {
                    $porcIva = $dfac_por_iva;
                }

                $descuento = $dfac_des1_dfac + $dfac_des2_dfac + $dfac_por_dsg;
                if ($descuento > 0)
                    $descuento = ($dfac_precio_dfac * $dfac_cant_dfac) - ($dfac_mont_total);
                else
                    $descuento = 0;

                $totalDescuento = $totalDescuento + $descuento;


                if ($dfac_por_dsg > 0) {
                    $descuento1 = ($dfac_precio_dfac * $dfac_cant_dfac * $dfac_des1_dfac) / 100;
                    $descuento2 = 0;
                    $descuento3 = 0;

                    $dfac_mont_total = number_format((($dfac_precio_dfac * $dfac_cant_dfac) - ($descuento1 + $descuento2 + $descuento3)), 2, '.', '');

                }

                $dfac_det_dfac=str_replace(',',', ',$dfac_det_dfac);
                $dfac_nom_prod=str_replace(',',', ',$dfac_nom_prod);

                $deta .= ' <tr>';
                $deta .= ' <td style="width: 16%; border-right: 0.5px solid #000">' . $dfac_cod_prod . '</td>';
                $deta .= ' <td style="width: 15%; border-right: 0.5px solid #000">' . $dfac_det_dfac . '</td>';
                $deta .= ' <td style="width: 35%; border-right: 0.5px solid #000">' . $dfac_nom_prod . '</td>';
                $deta .= ' <td style="width: 8%; border-right: 0.5px solid #000; float: right;" align="right">' . round($dfac_cant_dfac, 2) . '</td>';
                $deta .= ' <td style="width: 8%; border-right: 0.5px solid #000; float: right;" align="right">' . number_format($dfac_precio_dfac, 2, '.', ',') . '</td>';
                $deta .= ' <td style="width: 8%; border-right: 0.5px solid #000; float: right;" align="right">' . round($dfac_des1_dfac, 0) . '</td>';
                $deta .= ' <td style="width: 10%;" align="right">' . number_format($dfac_mont_total, 2, '.', ',') . '</td>';
                $deta .= ' </tr>';
            
            }while ($oIfx->SiguienteRegistro());
            $deta .= ' <tr>';
            $deta .= ' <td colspan="3" align="right">TOTAL CANT:</td>';
            $deta .= ' <td  align="right">' . number_format($total_cant, 4, '.', ',') . '</td>';
            $deta .= '<td></td>';
            $deta .= '<td></td>';
            $deta .= '<td></td>';
            $deta .= ' </tr>';
        }
    }

    $deta .= ' </table>';

  

    $totales .='<table style="width: 100%;  font-size: 13px; margin-top: 3px;  align="center">';
    $totales .='<tr>
    <td  style="width: 50%; align="left"></td>
    <td style="width: 50%; align="left">';

    $totales .= ' <table style="width: 195%; font-size: 13px; border-radius: 5px; border-collapse: collapse;"  border=0 align="right">';



    $totales .= ' <tr>';
    $totales .= ' <b> <td style="width: 25%;">SUBTOTAL:</td> </b>';
    $totales .= ' <td style="width: 10%;" align="right">' . number_format($fact_con_miva+$fact_sin_miva+$fact_dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>DESCUENTO:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td style="width: 25%;">SUBTOTAL SIN IMPUESTOS:</td> </b>';
    $totales .= ' <td style="width: 10%;" align="right">' . number_format($fact_con_miva+$fact_sin_miva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>IVA ' . round($porcIva) . '%:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_iva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>ICE:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_ice, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>IRBP:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_val_irbp, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>FLETE INTERNACIONAL:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_fle_fact, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>SEGURO INTERNACIONAL:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_otr_fact, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>GASTO TRANSPORTE:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_fin_fact, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>TOTAL USD:</td> </b>';
    $fact_tot_fact = $fact_con_miva + $fact_iva+ $fact_sin_miva + $fact_val_irbp + $fact_fle_fact + $fact_otr_fact + $fact_fin_fact;
    $totales .= ' <td align="right">' . number_format($fact_tot_fact, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' </table>';



    $totales.='</td>
    </tr>';
    $totales .='</table>';



    $sqltmp ='';
    if (!empty($fact_cod_contr)) {
        $sqltmp ="id_contrato = $fact_cod_contr AND";
    }

    $total = number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_fle_fact + $fact_otr_fact + $fact_fin_fact - $totalDescuento, 2, '.', '');
    $V = new EnLetras();
    $con_letra = strtoupper($V->ValorEnLetras($total, 'dolar'));

    //query forma de pago
    $sqlFPago = "select fp.fpag_cod_fpagop, fx.fxfp_val_fxfp, fx.fxfp_num_dias,
				fpg.fpagop_des_fpagop
				from saefact f, saefxfp fx, saefpag fp, saefpagop fpg
				where 
                f.fact_cod_fact = fx.fxfp_cod_fact and
				fp.fpag_cod_fpag = fx.fxfp_cod_fpag and
                f.fact_cod_empr = fpg.fpagop_cod_empr and
				fp.fpag_cod_fpagop = fpg.fpagop_cod_fpagop and
				f.fact_cod_empr = $idEmpresa and
				f.fact_cod_sucu = $idSucursal and
				f.fact_cod_fact = $id";
    if ($oIfx->Query($sqlFPago)) {
        if ($oIfx->NumFilas() > 0) {
            $tablePago .= '<table style="width: 65%; border-collapse: collapse; margin-top: 10px; text-align: left;" border="0">';
            $tablePago .= '<tr>';
            $tablePago .= '<th style="width: 80%;" border="1"><label style="">FORMA PAGO</label></th>';
            $tablePago .= '<th style="width: 19%;" border="1"><label style="">VALOR</label></th>';
            $tablePago .= '</tr>';
            do {
                $fpag_cod_fpagop    = $oIfx->f('fpag_cod_fpagop');
                $fxfp_val_fxfp      = $oIfx->f('fxfp_val_fxfp');
                $fxfp_num_dias      = $oIfx->f('fxfp_num_dias');
                $fpagop_des_fpagop  = $oIfx->f('fpagop_des_fpagop');

                $tablePago .= '<tr>';
                $tablePago .= '<td style="width: 80%;">' . $fpag_cod_fpagop . ' ' . htmlentities($fpagop_des_fpagop) . '</td>';
                $tablePago .= '<td style="width: 19%;" align="left">' . number_format($fxfp_val_fxfp, 2, '.', '') . '</td>';
                $tablePago .= '</tr>';
            } while ($oIfx->SiguienteRegistro());
            $tablePago .= '</table>';
        }
    }
    $oIfx->Free();


    if(!empty($fact_cm1_fact)){
        $fact_cm1_fact='<b>Observaciones:</b> '.$fact_cm1_fact;

        $tablePago .= '<br>';
        $tablePago .= '<br>';
        $tablePago .= '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;" border="1">';
        $tablePago .= '<tr>';
        $tablePago .= '<td style="width: 100%;">'.$fact_cm1_fact.'</td>';
        $tablePago .= '</tr>'; 
        $tablePago .= '</table>';
    }







    if(!empty($empr_cm1_empr)){
        $msjCliente = $empr_cm1_empr;

        $msjCliente=str_replace('&&&correo&&&',$empr_mai_empr,$msjCliente);

        // LEEYNDA
        $tableLeyenda .= '<br /> <br /> <br />';
        $tableLeyenda .= '<table style="width: 98%; border-collapse: collapse; margin-top: 10px;" border="0">';
        $tableLeyenda .= '<tr>';
        $tableLeyenda .= '<td style="width: 98%;" align="center">'.$msjCliente.'</td>';
        $tableLeyenda .= '</tr>';
        $tableLeyenda .= '</table>';


    }

    if($obfact=='S'){

        $tableLeyenda .= '<table style="width: 98%; border-collapse: collapse; margin-top: 0px;" border="0">';
        $tableLeyenda .= '<tr>';
        $tableLeyenda .= '<td style="width: 98%;" align="left">'.$obdetfact.'</td>';
        $tableLeyenda .= '</tr>';
        $tableLeyenda .= '</table>';

    }

    $legend = '<page_footer>
        <table align="center" style="width: 80%">
            <tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">Este comprobante electronico ha sido generado a traves de Sisconti S.A. - Facturacion Electronica</td>
            </tr>
			<tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">www.sisconti.com</td>
            </tr>
        </table>
    </page_footer>';

    $documento .= '<page backimgw="70%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
    $documento .= $logo . $cliente . $deta . $totales . $tablePago. $tableLeyenda;
    //$documento .= $legend;
    $documento .= '</page>';


    //file_put_contents("C:/prueba/documento.html", $documento);

    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;

    return $documento;
}

function reporte_factura_dorfzaun($id = '', $nombre_archivo = '', $idSucursal ='', &$rutaPdf = '') {
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();


    $idEmpresa = $_SESSION['U_EMPRESA'];
    //$idSucursal = $_SESSION['U_SUCURSAL'];

     //CAMPOS APROBACION
     $sqlgein="SELECT count(*) as conteo
     FROM INFORMATION_SCHEMA.COLUMNS
     WHERE COLUMN_NAME = 'empr_fac_empr' AND TABLE_NAME = 'saeempr'";
     $ctralter=consulta_string($sqlgein,'conteo',$oCon,0);
     if($ctralter==0){
         $sqlalter="alter table saeempr add  empr_fac_empr varchar(1)";
         $oCon->QueryT($sqlalter);
     }


     $sqlgein="SELECT count(*) as conteo
     FROM INFORMATION_SCHEMA.COLUMNS
     WHERE COLUMN_NAME = 'empr_det_fac' AND TABLE_NAME = 'saeempr'";
     $ctralter=consulta_string($sqlgein,'conteo',$oCon,0);
     if($ctralter==0){
         $sqlalter="alter table saeempr add  empr_det_fac text";
         $oCon->QueryT($sqlalter);
     }

     $sqlfa="select empr_fac_empr, empr_det_fac from saeempr where empr_cod_empr=$idEmpresa ";
     $obfact=consulta_string($sqlfa,'empr_fac_empr',$oCon,'');
     $obdetfact=consulta_string($sqlfa,'empr_det_fac',$oCon,'');

    $sql = "select empr_sn_conta, empr_cod_pais,empr_cm1_empr, empr_rimp_sn, empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr,empr_tel_resp, empr_ac1_empr, empr_ac2_empr, empr_mai_empr, empr_tip_empr
                                            from saeempr where empr_cod_empr = $idEmpresa ";

    //VALIDAICON DETALLE

    $sqlfa="select para_dfa_para from saepara where para_cod_empr= $idEmpresa and para_cod_sucu=$idSucursal";
    $para_dfa_para=consulta_string($sqlfa,'para_dfa_para',$oCon,'');

  
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            $tel_empresa = $oIfx->f('empr_tel_resp');
            $empr_mai_empr = $oIfx->f('empr_mai_empr');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';
            $empr_rimp_sn = $oIfx->f('empr_rimp_sn');
            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
            $empr_ac1_empr = $oIfx->f('empr_ac1_empr');
            $empr_ac2_empr = $oIfx->f('empr_ac2_empr');
            $empr_cm1_empr = $oIfx->f('empr_cm1_empr');
            $empr_cod_pais = $oIfx->f('empr_cod_pais');
            $empr_tip_empr = $oIfx->f('empr_tip_empr');
            $empr_sn_conta = $oIfx->f('empr_sn_conta');
        }
    }
    $oIfx->Free();


    

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis, sucu_telf_secu  from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
            $sucu_telf_secu = $oIfx->f('sucu_telf_secu');
        }
    }
    $oIfx->Free();

    //VALIDACION SUSCURSALES

    $sqls="select count(*) as cont from saesucu";
    $contsucu=consulta_string($sqls,'cont',$oIfx,0);

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }

    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;



    // $path_logo_img = DIR_FACTELEC . 'imagenes/logos/' . $path_img[$count];
    $path_logo_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];
    if (file_exists($path_logo_img)) {
        //echo "El fichero $nombre_fichero existe";
    } else {
        //echo "El fichero $nombre_fichero no existe";
        $path_logo_img = "https://turbologo.com/articles/wp-content/uploads/2019/05/no-logo.png";
    }
    //https://turbologo.com/articles/wp-content/uploads/2019/05/no-logo.png


    $logo .= '<table style="width: 100%; margin: 0px;">';
    $logo .= '<tr>';
    $logo .= '<td align="left" style="width: 50%; border:0px solid white; border-radius: 5px; margin: 0px;">';
    $logo .= '<table width: 50%; valign="left" style="margin: 0px;">';
    $logo .= '<tr><td style="margin-top: 0px;"><img width="250px;"  src="' . $path_logo_img . '"></td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="left" style="font-size: 15px;"><b>Emisor: ' . $razonSocial . '</b></td></tr>';

    $sqlxml = "select ixml_tit_ixml, ixml_det_ixml from saeixml where ixml_cod_empr=$idEmpresa 
				and ixml_est_deleted ='S' and ixml_sn_pdf='S' order by ixml_ord_ixml";

				if ($oIfx->Query($sqlxml)) {
					if ($oIfx->NumFilas() > 0) {
						do {
							$titulo  = $oIfx->f('ixml_tit_ixml');
							$detalle = $oIfx->f('ixml_det_ixml');
                            $logo .= '<tr><td align="center" style="font-size: 14px;" width="300"><b>'.$titulo.'</b> ' . $detalle . '</td></tr>';
						} while ($oIfx->SiguienteRegistro());
					}
				}
	$oIfx->Free();


    //$logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>RUC:</b> ' . $ruc_empr . '</td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="left" style="font-size: 13px;" width="500"><b>Matriz:</b> ' . $dirMatriz . '</td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';


    //selecciona sucursales y direcciones
    $sql_sucu_matriz = "select sucu_dir_sucu from saesucu where sucu_nom_sucu ='MATRIZ'";
    $matriz = consulta_string($sql_sucu_matriz, 'sucu_dir_sucu', $oIfx, '');
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    $emprce="select empr_num_resu from saeempr where empr_cod_empr=$idEmpresa";
    $contribuyente= consulta_string($emprce, 'empr_num_resu', $oIfx, '');
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                //$logo .= '<tr><td align="center" style="font-size: 12px">' . $sucu_nom_sucu . ': ' . htmlentities($sucu_dir_sucu) . '</td></tr>';
                //$logo .= '<tr><td align="center" style="font-size: 13px">SUCURSAL : ' . $sucu_nom_sucu . '</td></tr>';

                ///$logo .= '<tr><td style="position:top; width:50px;"><h4>Direccion Matriz:</h4></td></tr><br>';
                //$logo .= '<tr><td>' . htmlentities($dirMatriz) . '</td></tr>';
                if( $contsucu>1){
                    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>Sucursal:</b> ' . $sucu_nom_sucu . '</td></tr>';

                    $logo .= '<tr><td align="left" style="font-size: 13px;" width="500" ><b>Direcci&oacute;n Sucursal:</b>' . $sucu_dir_sucu.'</td></tr>';
                }





            } while ($oIfx->SiguienteRegistro());
        }
    }
    //$logo .= '<tr><td>&nbsp;</td></tr>';

    //DATOS ADICIONALES
    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>Correo:</b> ' .  $empr_mai_empr . '</td></tr>';

    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>Tel&eacute;fono:</b> ' . $sucu_telf_secu . '</td></tr>';


    if ($empr_tip_empr == 'S') {
        $logo .= '<tr><td align="left" style="font-size: 12px;"><b>Contribuyente Especial #:</b> ' . $empr_num_resu . '</td></tr>';
    }//fin if*/
    /*if($empr_conta_sn=='SI'){
        $logo .= '<tr><td align="center" style="font-size: 12px;"><b>Contribuyente Especial #:</b> '.$contribuyente.'</td></tr>';
    }*/

    if(!empty($empr_ac2_empr)){
        $empr_ac2_empr = '<b>Agente de Retención Resolución Nro:</b> '.$empr_ac2_empr;
    }
    /*else{
        $empr_ac2_empr ='<b>AGENTE DE RETENCI&Oacute;N:</b> NO';
    }*/


    if($empr_conta_sn=='SI'){
        if($empr_sn_conta=='S'){
            $empr_sn_conta ='SI';
        }
        else{
            $empr_sn_conta ='NO';
        }
        $logo .= '<tr><td align="center" style="font-size: 12px;">Obligado a llevar Contabilidad :' . $empr_sn_conta . '</td></tr>';
    }
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    if($empr_rimp_sn=="S"){
        $logo .= '<tr><td align="left" style="font-size: 12px;"><b>CONTRIBUYENTE R&Eacute;GIMEN RIMPE</b></td></tr>';
    }
    $logo .= '<tr><td align="left" style="font-size: 12px;">'.$empr_ac2_empr.'</td></tr>';

    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= ' </table>';
    $logo .= '</td>';

    $sqlFac = "select * from saefact where fact_cod_fact = $id;";

    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $fact_nse_fact = $oIfx->f('fact_nse_fact');
                $fact_num_preimp = $oIfx->f('fact_num_preimp');
                $fact_auto_sri = $oIfx->f('fact_auto_sri');
                $fact_fech_sri = $oIfx->f('fact_fech_sri');
                $fact_nom_cliente = $oIfx->f('fact_nom_cliente');
                $fact_fech_fact = fecha_mysql_func($oIfx->f('fact_fech_fact'));
                $fact_ruc_clie = $oIfx->f('fact_ruc_clie');
                $fact_tlf_cliente = $oIfx->f('fact_tlf_cliente');
                $fact_dir_clie = htmlentities($oIfx->f('fact_dir_clie'));
                $fact_email_clpv = str_replace(' ', '', $oIfx->f("fact_email_clpv"));
                $fact_con_miva = $oIfx->f('fact_con_miva');
                $fact_sin_miva = $oIfx->f('fact_sin_miva');
                $fact_tot_fact = $oIfx->f('fact_tot_fact');
                $fact_iva = $oIfx->f('fact_iva');
                $fact_ice = $oIfx->f('fact_ice');
                $fact_clav_sri  = $oIfx->f('fact_clav_sri');
                $fact_dsg_valo  = $oIfx->f('fact_dsg_valo');
                $fact_cm1_fact  = trim($oIfx->f("fact_cm1_fact"));
                $fact_cm2_fact  = $oIfx->f("fact_cm2_fact");
                $fact_cm4_fact  = $oIfx->f("fact_cm4_fact");
                $orden_compra   = $oIfx->f("fact_opc_fact");
                $fact_cod_clpv  = $oIfx->f("fact_cod_clpv");
                $fact_cod_ccli  = $oIfx->f("fact_cod_ccli");
                $fact_dia_plazo = $oIfx->f("fact_dia_fact");
                $fact_fech_venc = fecha_mysql_func($oIfx->f("fact_fech_venc"));
                $fact_cm3_fact  = $oIfx->f("fact_cm3_fact");
                $fact_cod_contr = $oIfx->f("fact_cod_contr");


                $id_usuario_w = $oIfx->f("fact_user_web");
                $sql = "select usuario_user, usuario_nombre, usuario_apellido  from comercial.usuario where usuario_id = '$id_usuario_w' ";
                if($oCon->Query($sql)){
                    if($oCon->NumFilas() > 0){
                        $usuario=$codigo = $oCon->f('usuario_nombre').' '.$oCon->f('usuario_apellido');
                    }
                }

                $fact_tip_vent = $oIfx->f("fact_tip_vent");
                $sql = "select tcmp_cod_tcmp, tcmp_des_tcmp from saetcmp where tcmp_cod_tcmp = '$fact_tip_vent';";
                $tipo_text_fac= consulta_string($sql,'tcmp_des_tcmp', $oCon,'FACTURA');



                $logo .= '<td style="width: 50%; border: 0px solid white; border-radius: 5px;" align="right">';
                $logo .= ' <table align="center" style="font-size: 15px;">';
                $logo .= ' <tr>';
                $logo .= '<td style="border-bottom: 0px inset black; font-size: 20px !important"><b>'.$tipo_text_fac.'</b></td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>Serie:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . substr($fact_nse_fact, 0, 3) . '-' . substr($fact_nse_fact, 3, 6) . ' <label style="color: red">' . $fact_num_preimp . '</label></td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>Autorización:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fact_auto_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>Fecha Autorización:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fact_fech_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td >Ambiente:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $ambiente_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td >Emision:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $emision_sri . '</td>';
                $logo .= ' </tr>';

                //verifica si existe clave de acceso
                if ($fact_clav_sri != '') {
                    $nombArch = $fact_nse_fact . $fact_num_preimp;
                    //$nombArch = '0112201401179141325300110010010000048101234567818';
                    $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';

                    new barCodeGenrator($fact_clav_sri, 1, $rutaCodi, 450, 100, true);

                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="right" style="font-size: 12px;">Clave De Acceso</td>';
                    $logo .= '</tr>';
                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="center"> <img width="400px;" src="' . $rutaCodi . '"/></td>';
                    $logo .= '</tr>';
                }

                $logo .= ' </table>';
                $logo .= '</td>';
                $logo .= '</tr>';


                $logo .= ' <br>';
                $logo .= ' <br>';
                $logo .= '<hr>';


                $logo .= '</table>';
                $logo .= ' <br>';

                $cliente .= ' <table style="width: 100%; border:0px solid white; border-radius: 5px; padding: 2px; font-size: 15x;">';
                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10%;">CLIENTE:</td></b>';
                $cliente .= ' <td style="width: 48%; ">' . $fact_nom_cliente . '</td>';
                $cliente .= ' <b><td style="width: 13%; ">FECHA EMISION:</td></b>';
                $cliente .= ' <td style="width: 29% ">' . $fact_fech_fact . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% ">RUC:</td></b>';
                $cliente .= ' <td style="width: 48% ">' . $fact_ruc_clie . '</td>';
                $cliente .= ' <b><td style="width: 13% ">TELEFONO:</td></b>';
                $cliente .= ' <td style="width: 29% ">' . $fact_tlf_cliente . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% ">DIRECCION:</td></b>';
                $cliente .= ' <td style="width: 48% ">' . $fact_dir_clie . '</td>';
                $cliente .= ' <b><td style="width: 13% ">EMAIL:</td></b>';
                $cliente .= ' <td style="width: 29% ">' . $fact_email_clpv . '</td>';
                $cliente .= ' </tr>';


                // -------------------------------------------------------------------------
                // campos fedexport solucion temporal borrar
                // -------------------------------------------------------------------------
                if($ruc_empr == 1790312143001 || $ruc_empr == 1791870158001){

                    $sql_oc = "SELECT orden_compra from contrato_clpv where id_clpv = $fact_cod_clpv and
                                id_empresa = $idEmpresa";
                    $orden_compra = consulta_string_func($sql_oc, 'orden_compra', $oIfxA, '');

                    $cliente .= ' <tr>';
                    $cliente .= ' <b><td style="width: 10% ">:</td></b>';
                    $cliente .= ' <td style="width: 48% "></td>';
                    $cliente .= ' <b><td style="width: 13% ">ORDEN DE COMPRA:</td></b>';
                    $cliente .= ' <td style="width: 29% ">' . $orden_compra . '</td>';
                    $cliente .= ' </tr>';

                }
                // -------------------------------------------------------------------------
                // FIn campos fedexport solucion temporar borrar
                // -------------------------------------------------------------------------


                $cliente .= ' </table>';

                $cliente .= ' <br>';
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $oIfx->Free();

    $sqlDeta = "select * from saedfac where dfac_cod_fact = $id and 
                dfac_cod_sucu = $idSucursal and 
                dfac_cod_empr = $idEmpresa  ";

    $deta .= ' <table style="width: 100%; font-size: 13px; border-radius: 5px; border-collapse: collapse;" border="0">';
    $deta .= ' <tr>';
    $deta .= ' <b><td style="width: 16%;" align="center" border="1"><label style="color: ">CODIGO</label></td></b>';
    if($para_dfa_para==1){
    $deta .= ' <b> <td style="width: 50%;" align="center" border="1"><label style="color: ">DESCRIPCION</label></td> </b>';
    }
    else{
        $deta .= ' <b> <td style="width: 30%;" align="center" border="1"><label style="color: ">DESCRIPCION</label></td> </b>';
    }
    if($para_dfa_para==0){
    $deta .= ' <b> <td style="width: 20%;" align="center" border="1"><label style="color: ">DETALLE</label></td> </b>';
    }
    $deta .= ' <b> <td style="width:  8%;" align="center" border="1"><label style="color: ">CANT.</label></td> </b>';
    $deta .= ' <b> <td style="width:  8%;" align="center" border="1"><label style="color: ">PRECIO</label></td> </b>';
    $deta .= ' <b> <td style="width:  8%;" align="center" border="1"><label style="color: ">DSCTO %</label></td> </b>';
    $deta .= ' <b> <td style="width: 10%;" align="center" border="1"><label style="color: ">TOTAL</label></td> </b>';
    $deta .= ' </tr>';
    $total_cant=0;
    if ($oIfx->Query($sqlDeta)) {
        if ($oIfx->NumFilas() > 0) {
            $porcIva = '';
            do {
                $dfac_cod_prod = $oIfx->f('dfac_cod_prod');
                $dfac_nom_prod = $oIfx->f('dfac_nom_prod');
                $dfac_cant_dfac = $oIfx->f('dfac_cant_dfac');
                $total_cant+=$dfac_cant_dfac;
                $dfac_precio_dfac = $oIfx->f('dfac_precio_dfac');
                $dfac_des1_dfac = $oIfx->f('dfac_des1_dfac');
                $dfac_des2_dfac = $oIfx->f('dfac_des2_dfac');
                $dfac_por_dsg = $oIfx->f('dfac_por_dsg');
                $dfac_mont_total = $oIfx->f('dfac_mont_total');
                $dfac_num_comp = $oIfx->f('dfac_tip_dfac');
                $dfac_por_iva = $oIfx->f('dfac_por_iva');
                $dfac_det_dfac = $oIfx->f('dfac_det_dfac');

                if ($dfac_por_iva > 0) {
                    $porcIva = $dfac_por_iva;
                }

                $descuento = $dfac_des1_dfac + $dfac_des2_dfac + $dfac_por_dsg;
                if ($descuento > 0)
                    $descuento = ($dfac_precio_dfac * $dfac_cant_dfac) - ($dfac_mont_total);
                else
                    $descuento = 0;

                $totalDescuento = $totalDescuento + $descuento;


                if ($dfac_por_dsg > 0) {
                    $descuento1 = ($dfac_precio_dfac * $dfac_cant_dfac * $dfac_des1_dfac) / 100;
                    $descuento2 = 0;
                    $descuento3 = 0;

                    $dfac_mont_total = number_format((($dfac_precio_dfac * $dfac_cant_dfac) - ($descuento1 + $descuento2 + $descuento3)), 2, '.', '');

                }
                

                $deta .= ' <tr>';
                $deta .= ' <td style="width: 16%; border-right: 0.5px solid #000">' . $dfac_cod_prod . '</td>';
                if($para_dfa_para==1){
                    if(empty($dfac_det_dfac)){
                        $dfac_det_dfac=$dfac_nom_prod;
                    }
                    $deta .= ' <td style="width: 30%; border-right: 0.5px solid #000">' . $dfac_det_dfac . '</td>';     
                }
                

                if($para_dfa_para==0){
                $deta .= ' <td style="width: 30%; border-right: 0.5px solid #000">' . $dfac_nom_prod . '</td>';
                $deta .= ' <td style="width: 20%; border-right: 0.5px solid #000">' . $dfac_det_dfac . '</td>';
                }
                $deta .= ' <td style="width: 8%; border-right: 0.5px solid #000; float: right;" align="right">' . number_format($dfac_cant_dfac, 4, '.', ',') . '</td>';
                $deta .= ' <td style="width: 8%; border-right: 0.5px solid #000; float: right;" align="right">' . number_format($dfac_precio_dfac, 4, '.', ',') . '</td>';
                $deta .= ' <td style="width: 8%; border-right: 0.5px solid #000; float: right;" align="right">' . round($dfac_des1_dfac, 0) . '</td>';
                $deta .= ' <td style="width: 10%;" align="right">' . number_format($dfac_mont_total, 4, '.', ',') . '</td>';
                $deta .= ' </tr>';
            }while ($oIfx->SiguienteRegistro());
            if($ruc_empr == '0190020304001' || $ruc_empr == '0190314294001'){
                $deta .= ' <tr>';
                $deta .= ' <td  colspan="2" align="right">TOTAL CANT:</td>';
                $deta .= ' <td  align="right">' . number_format($total_cant, 4, '.', ',') . '</td>';
                $deta .= ' <td></td>';
                $deta .= ' <td></td>';
                $deta .= ' <td></td>';
                $deta .= ' </tr>';
            

            }
        }
    }

    $deta .= ' </table>';

    if(!empty($fact_cm1_fact)){
        $fact_cm1_fact='<b>Observaciones:</b> '.$fact_cm1_fact;
    }

    $totales .='<table style="width: 100%;  font-size: 13px; margin-top: 3px;  align="center">';
    $totales .='<tr>
    <td  style="width: 50%; align="left"> '.$fact_cm1_fact.' </td>
    <td style="width: 50%; align="left">';

    $totales .= ' <table style="width: 195%; font-size: 13px; border-radius: 5px; border-collapse: collapse;" align="right">';



    $totales .= ' <tr>';
    $totales .= ' <b> <td style="width: 25%;">SUBTOTAL:</td> </b>';
    $totales .= ' <td style="width: 10%;" align="right">' . number_format($fact_con_miva+$fact_sin_miva+$fact_dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>DESCUENTO:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td style="width: 25%;">SUBTOTAL SIN IMPUESTOS:</td> </b>';
    $totales .= ' <td style="width: 10%;" align="right">' . number_format($fact_con_miva+$fact_sin_miva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>IVA ' . round($porcIva) . '%:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_iva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>ICE:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_ice, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>IRBP:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_val_irbp, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' <tr>';
    $totales .= ' <b> <td>TOTAL USD:</td> </b>';
    $fact_tot_fact = $fact_con_miva + $fact_iva+$fact_sin_miva + $fact_val_irbp;
    $totales .= ' <td align="right">' . number_format($fact_tot_fact, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' </table>';


    $totales.='</td>
    </tr>';
    $totales .='</table>';



    $sqltmp ='';
    if (!empty($fact_cod_contr)) {
        $sqltmp ="id_contrato = $fact_cod_contr AND";
    }

    $total = number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_fle_fact + $fact_otr_fact + $fact_fin_fact - $totalDescuento, 2, '.', '');
    $V = new EnLetras();
    $con_letra = strtoupper($V->ValorEnLetras($total, 'dolar'));

    //query forma de pago
    $sqlFPago = "select fp.fpag_cod_fpagop, fx.fxfp_val_fxfp, fx.fxfp_num_dias,
				fpg.fpagop_des_fpagop
				from saefact f, saefxfp fx, saefpag fp, saefpagop fpg
				where 
                f.fact_cod_fact = fx.fxfp_cod_fact and
				fp.fpag_cod_fpag = fx.fxfp_cod_fpag and
                f.fact_cod_empr = fpg.fpagop_cod_empr and
				fp.fpag_cod_fpagop = fpg.fpagop_cod_fpagop and
				f.fact_cod_empr = $idEmpresa and
				f.fact_cod_sucu = $idSucursal and
				f.fact_cod_fact = $id";
    if ($oIfx->Query($sqlFPago)) {
        if ($oIfx->NumFilas() > 0) {

            //$deta .= ' <b> <td style="width: 10%; background-color: black" align="center"><label style="color: white">TOTAL</label></td> </b>';

            $tablePago .= '<table style="width: 60%; border-collapse: collapse; margin-top: 10px; text-align: left">';
            $tablePago .= '<tr>';
            $tablePago .= '<th style="width: 75%;" border="1"><label style="color: ">FORMA PAGO</label></th>';
            $tablePago .= '<th style="width: 24.5%;" border="1"><label style="color: ">VALOR</label></th>';
            $tablePago .= '</tr>';
            do {
                $fpag_cod_fpagop    = $oIfx->f('fpag_cod_fpagop');
                $fxfp_val_fxfp      = $oIfx->f('fxfp_val_fxfp');
                $fxfp_num_dias      = $oIfx->f('fxfp_num_dias');
                $fpagop_des_fpagop  = $oIfx->f('fpagop_des_fpagop');

                $tablePago .= '<tr>';
                $tablePago .= '<td style="width: 75%;">' . $fpag_cod_fpagop . ' ' . htmlentities($fpagop_des_fpagop) . '</td>';
                $tablePago .= '<td style="width: 24.5%;">' . number_format($fxfp_val_fxfp, 2, '.', '') . '</td>';
                $tablePago .= '</tr>';
            } while ($oIfx->SiguienteRegistro());
            $tablePago .= '</table>';
        }
    }
    $oIfx->Free();

    if(!empty($empr_cm1_empr)){
        $msjCliente = $empr_cm1_empr;

        $msjCliente=str_replace('&&&correo&&&',$empr_mai_empr,$msjCliente);

        // LEEYNDA
        $tableLeyenda .= '<br /> <br /> <br />';
        $tableLeyenda .= '<table style="width: 98%; border-collapse: collapse; margin-top: 10px;" border="0">';
        $tableLeyenda .= '<tr>';
        $tableLeyenda .= '<td style="width: 98%;" align="center">'.$msjCliente.'</td>';
        $tableLeyenda .= '</tr>';
        $tableLeyenda .= '</table>';


    }

    if($obfact=='S'){

        $tableLeyenda .= '<table style="width: 98%; border-collapse: collapse; margin-top: 0px;" border="0">';
        $tableLeyenda .= '<tr>';
        $tableLeyenda .= '<td style="width: 98%;" align="left">'.$obdetfact.'</td>';
        $tableLeyenda .= '</tr>';
        $tableLeyenda .= '</table>';

    }

    $legend = '<page_footer>
        <table align="center" style="width: 80%">
            <tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">Este comprobante electronico ha sido generado a traves de Sisconti S.A. - Facturacion Electronica</td>
            </tr>
			<tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">www.sisconti.com</td>
            </tr>
        </table>
    </page_footer>';

    $documento .= '<page backimgw="70%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
    $documento .= $logo . $cliente . $deta . $totales . $tablePago. $tableLeyenda;
    //$documento .= $legend;
    $documento .= '</page>';


    //file_put_contents("C:/prueba/documento.html", $documento);

    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;

    return $documento;
}




// --------------------------------------------------------------------------------------------------------------
// Documentos y formatos de las socilitudes de pago
// --------------------------------------------------------------------------------------------------------------
function genera_pdf_doc_pago($pedi,$id, $aForm = '')
{
    session_start();
    global $DSN_Ifx, $DSN;

    $oIfxA = new Dbo();
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oIfxB = new Dbo();
    $oIfxB->DSN = $DSN_Ifx;
    $oIfxB->Conectar();

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();

    unset($_SESSION['pdf']);

    $oReturn = new xajaxResponse();
    //$idempresa = $aForm['empresa'];
    $idempresa = $_SESSION['U_EMPRESA'];
    $idsucursal = $aForm['sucursal'];
    $usuario_web = $_SESSION['U_ID'];

    $sql = "select empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr
    from saeempr where empr_cod_empr = $idempresa ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');


            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';

            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
        }
    }
    $oIfx->Free();
    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;
    $arc_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];

    if (file_exists($arc_img)) {
        $imagen = $arc_img;
    } else {
        $imagen = '';
    }
    $logo = '';
    $x = '0px';
    if ($imagen != '') {

        $logo = '<div>
            <img src="' . $imagen . '" style="
            width:100px;
            object-fit; contain;">
            </div>';
        $x = '0px';
    }
    else{
        $logo='<span><font color="red">SIN LOGO</font></span>';
    }



    $html.='<table  border="1"  cellpadding="1" >
    <tr>
    <td  align="center">'.$logo.' </td>';



    //$sqlusua = "select empl_cod_empl from comercial.usuario where usuario_id=$usuario_web";

    $sqlusua = "select pgs_cod_empl from saepgs where pgs_cod_pgs=$pedi";
    $cedusua = consulta_string_func($sqlusua, 'pgs_cod_empl', $oCon, 0);
   
    $sqlf="select concat(usuario_nombre,' ',usuario_apellido) as apenomb, firma_empl from comercial.usuario where empl_cod_empl='$cedusua' ";
    $responsable = consulta_string_func($sqlf, 'apenomb', $oIfx, '');

    /*$sqlres = "select empl_ape_empl,empl_nom_empl  from saeempl where empl_cod_empl='$cedusua'";

    $ape = consulta_string_func($sqlres, 'empl_ape_empl', $oIfx, '');
    $nom = consulta_string_func($sqlres, 'empl_nom_empl', $oIfx, '');
    $responsable = $nom . ' ' . $ape;*/


    $spedi = "select pgs_tip_pago, pgs_ope_pgs,pgs_tot_pgs, pgs_tipo_pgs,pgs_carea_pgs, pgs_ger_soli, pgs_cod_ccos,pgs_moti_pgs from saepgs where pgs_cod_pgs=$pedi";
    $cpedi = consulta_string_func($spedi, 'pgs_carea_pgs', $oIfxA, '');
    $area = consulta_string_func($spedi, 'pgs_ger_soli', $oIfxA, '');
    $tipo = consulta_string_func($spedi, 'pgs_tip_pago', $oIfxA, '');
    $motivo = consulta_string_func($spedi, 'pgs_moti_pgs', $oIfxA, '');
    $operacion = consulta_string_func($spedi, 'pgs_ope_pgs', $oIfxA, '');

    $ccos = consulta_string_func($spedi, 'pgs_cod_ccos', $oIfxA, '');
    $scos = "select ccosn_nom_ccosn from saeccosn where ccosn_cod_ccosn='$ccos'";
    $ncosn = consulta_string_func($scos, 'ccosn_nom_ccosn', $oIfxA, '');


    $total = number_format(consulta_string_func($spedi, 'pgs_tot_pgs', $oIfxA, ''),2);


    //CONSULTA DE LOS CAMPOS

    $sql = "select dpgs_det_dpgs, dpgs_fdes_dpgs, dpgs_fhas_dpgs, dpgs_hosp_dpgs,
      dpgs_ben_dpgs,dpgs_ali_dpgs,dpgs_ter_dpgs, dpgs_ext_dpgs, dpgs_vadi_dpgs,
      dpgs_vapr_dpgs, dpgs_dest_dpgs,dpgs_fval_dpgs, dpgs_nfac_dpgs, dpgs_pruc_dpgs,
      dpgs_npro_dpgs, dpgs_ncom_dpgs, dpgs_vpag_dpgs, dpgs_dcri_dpgs, dpgs_ant_dpgs,
      dpgs_pmes_dpgs, dpgs_mont_dpgs, dpgs_tip_tc, dpgs_cod_ccos
      from saedpgs where dpgs_cod_pgs=$pedi";

    $sqlpag="select nombre from comercial.cre_tipo_solicitud where id=$tipo";
    $ntipo=consulta_string_func($sqlpag,'nombre',$oCon,'');

    //FORMATOS REPORTES SOLICITUDES

    //VIATICOS

    if ($tipo == 1) {

        $sqlf="select minr_fec_serv from saeminr where minr_cod_solicitud=$pedi order by minr_fec_emis desc limit 1
        ";
        $fviatico = consulta_string_func($sqlf, 'minr_fec_serv', $oIfxA, '');
        if(!empty($fviatico)){
            $fviatico =date('d-m-Y',strtotime($fviatico));
        }
        else{
            $fviatico ='';
        }

        $shosp = "select sum(dpgs_hosp_dpgs) as shosp from saedpgs where dpgs_cod_pgs=$pedi";
        $thosp = consulta_string_func($shosp, 'shosp', $oIfxA, 0);
        $thosp=number_format($thosp,2);

        $sali = "select sum(dpgs_ali_dpgs) as sali from saedpgs where dpgs_cod_pgs=$pedi";
        $tali = consulta_string_func($sali, 'sali', $oIfxA, 0);
        $tali=number_format($tali,2);

        $ster = "select sum(dpgs_ter_dpgs) as ster from saedpgs where dpgs_cod_pgs=$pedi";
        $tter = consulta_string_func($ster, 'ster', $oIfxA, 0);
        $tter=number_format($tter,2);

        $sext = "select sum(dpgs_ext_dpgs) as sext from saedpgs where dpgs_cod_pgs=$pedi";
        $text = consulta_string_func($sext, 'sext', $oIfxA, 0);
        $text=number_format($text,2);

        $svapr = "select sum(dpgs_vapr_dpgs) as svapr from saedpgs where dpgs_cod_pgs=$pedi";
        $tvapr = consulta_string_func($svapr, 'svapr', $oIfxA, 0);
        $tvpar=number_format($tvpar,2);


        if ($oIfx->Query($sql)) {
            if ($oIfx->NumFilas() > 0) {
                $via .= '<table  border="1" cellpadding="1">';

                $via .= '<tr style="background-color: #e02126;">
        <td align="center" colspan="9"><font color ="#ffffff"><strong>' . $ntipo . '</strong></font></td>
        </tr>';

                do {


                    $beneficiario = $oIfx->f('dpgs_ben_dpgs');
                    $dpgs_cod_ccos = $oIfx->f('dpgs_cod_ccos');

                    $scos_det = "select ccosn_nom_ccosn from saeccosn where ccosn_cod_ccosn='$dpgs_cod_ccos'";
                    $ncosn = consulta_string_func($scos_det, 'ccosn_nom_ccosn', $oIfxA, '');

                    $sqlres = "select empl_ape_empl,empl_nom_empl  from saeempl where empl_cod_empl='$beneficiario'";

                    $ape = consulta_string_func($sqlres, 'empl_ape_empl', $oIfxA, '');
                    $nom = consulta_string_func($sqlres, 'empl_nom_empl', $oIfxA, '');
                    $nombre = $nom . ' ' . $ape;

                    if(empty($nom)){

                        $sqlprove="select clpv_nom_clpv from saeclpv where clpv_ruc_clpv='$beneficiario'";
                        $nombre = consulta_string_func($sqlprove, 'clpv_nom_clpv', $oIfxA, '');

                        if(empty($nombre)){
                            $nombre='BENEFICIARIO NO ENCONTRADO';
                        }

                    }



                    $fdes = $oIfx->f('dpgs_fdes_dpgs');
                    $afdes=explode('-',$fdes);
                    $fdes=$afdes[2].'-'.$afdes[1].'-'.$afdes[0];
                    $fhasta = $oIfx->f('dpgs_fhas_dpgs');
                    $afhasta=explode('-',$fhasta);
                    $fhasta=$afhasta[2].'-'.$afhasta[1].'-'.$afhasta[0];

                    $dias = dias_pasados($fdes, $fhasta);

                    $hosp = $oIfx->f('dpgs_hosp_dpgs');
                    $hosp=number_format($hosp,2);
                    $ali = $oIfx->f('dpgs_ali_dpgs');
                    $ali=number_format($ali,2);
                    $ter = $oIfx->f('dpgs_ter_dpgs');
                    $ter=number_format($ter,2);
                    $ext = $oIfx->f('dpgs_ext_dpgs');
                    $ext=number_format($ext,2);
                    $vapro = $oIfx->f('dpgs_vapr_dpgs');
                    $vapro=number_format($vapro,2);
                    $vadi = $oIfx->f('dpgs_vadi_dpgs');
                    $vadi=number_format($vadi,2);
                    $det = $oIfx->f('dpgs_det_dpgs');

                    $des = $oIfx->f('dpgs_dest_dpgs');

                    $sql = "select provz_cod_zona from saeprovz where provz_nom_provc='$des'";
                    $zona = consulta_string_func($sql, 'provz_cod_zona', $oIfxA, '');



                    $via .= '<tr>
        <td  align="left" colspan="5"><font color ="red"><strong>Beneficiario:</strong></font>&nbsp;&nbsp;&nbsp;' . $nombre . '</td>
        <td align="left" colspan="4" ><font color ="red"><strong>No. C&eacute;dula de Ciudadan&iacute;a del Empleado:</strong></font>&nbsp;&nbsp;&nbsp;' . $beneficiario . '</td>
        </tr>';
                    $via .= '<tr>
        <td  align="rigth" colspan="3"><font color ="red"><strong>Destino:&nbsp;&nbsp;</strong></font></td>
        <td  align="center" colspan="2">' . $des . '</td>
        <td  align="left" colspan="4"><font color ="red"><strong>Motivo:</strong></font>&nbsp;&nbsp;&nbsp;' . $motivo . '</td>
        </tr>';


                    $via .= '<tr>
        <td  colspan="3" align="rigth"><font color ="red"><strong>Centro de Costos:&nbsp;&nbsp;</strong></font></td>
        <td  colspan="6" align="center">' . $ncosn . '</td>
        </tr>';
                    $via .= '<tr>
        <td rowspan="2" align="center"><font color ="red"><strong>Zona</strong></font></td>
        <td  colspan="2" align="center"><font color ="red"><strong>Fecha</strong></font></td>
        <td rowspan="2" align="center"><font color ="red"><strong>D&iacute;as</strong></font></td>
        <td colspan="4"></td>
        <td rowspan="2" align="center"><font color ="red"><strong>Valor<br>Aprobado</strong></font></td>
        </tr>';

                    $via .= '<tr>
        <td align="center"><font color ="red"><strong>Desde</strong></font></td>
        <td align="center"><font color ="red"><strong>Hasta</strong></font></td>
        <td align="center"><font color ="red"><strong>Hospedaje</strong></font></td>
        <td align="center"><font color ="red"><strong>Alimentaci&oacute;n</strong></font></td>
        <td align="center"><font color ="red"><strong>Terrestre</strong></font></td>
        <td align="center"><font color ="red"><strong>Exterior</strong></font></td>
        </tr>';
                    $via .= '<tr>
        <td  align="center">' . $zona . '</td>
        <td  align="center">' . $fdes . '</td>
        <td  align="center">' . $fhasta . '</td>
        <td  align="center">' . $dias . '</td>
        <td  align="center">' . $hosp . '</td>
        <td  align="center">' . $ali . '</td>
        <td  align="center">' . $ter . '</td>
        <td  align="center">' . $ext . '</td>
        <td  align="center">' . ($vapro - $vadi) . '</td>
        </tr>';
                    $via .= '<tr>
        <td  align="center" colspan="2"><strong>Valores Adicionales</strong></td>
        <td  align="center" colspan="6">' . $det . '</td>
        <td  align="center">' . $vadi . '</td>
        </tr>';

                } while ($oIfx->SiguienteRegistro());
                $via .= '<tr>
      <td  align="center"></td>
      <td  align="center"></td>
      <td  align="center"></td>
      <td  align="center"></td>
      <td  align="center"></td>
      <td  align="center"></td>
      <td  align="center"></td>
      <td  align="center"></td>
      <td  align="center"></td>
      </tr>';
                $via .= '<tr>
      <td  align="center"><strong>Total</strong></td>
      <td  align="center"></td>
      <td  align="center"></td>
      <td  align="center"></td>
      <td  align="center">' . $thosp . '</td>
      <td  align="center">' . $tali . '</td>
      <td  align="center">' . $tter . '</td>
      <td  align="center">' . $text . '</td>
      <td  align="center">' . ($tvapr - $vadi) . '</td>
        </tr>';

                $via .= '<tr>
      <td  align="center" colspan="7"></td>
      <td  align="center"><strong>Total</strong></td>
      <td align="center">' . $total . '</td>
      </tr>';
                $via .= '</table>';


            }
        }

    }//CIERRE IF VIATICOS
    else {
        $via = '';
    }

    //FONDOS

    if ($tipo == 2 ) {

        if ($oIfx->Query($sql)) {
            if ($oIfx->NumFilas() > 0) {
                $fon .= '<table  border="1" cellpadding="1">';

                $fon .= '<tr style="background-color: #e02126;">
                <td align="center" colspan="9"><font color ="#ffffff"><strong>' . $ntipo . '</strong></font></td>
                </tr>';
                do {

                    $beneficiario = $oIfx->f('dpgs_ben_dpgs');
                    $valor = $oIfx->f('dpgs_fval_dpgs');
                    $valor=number_format($valor,2);

                    $sqlres = "select empl_ape_empl,empl_nom_empl  from saeempl where empl_cod_empl='$beneficiario'";

                    $ape = consulta_string_func($sqlres, 'empl_ape_empl', $oIfxA, '');
                    $nom = consulta_string_func($sqlres, 'empl_nom_empl', $oIfxA, '');
                    $nombre = $nom . ' ' . $ape;

                    if(empty($nom)){

                        $sqlprove="select clpv_nom_clpv from saeclpv where clpv_ruc_clpv='$beneficiario'";
                        $nombre = consulta_string_func($sqlprove, 'clpv_nom_clpv', $oIfxA, '');

                        if(empty($nombre)){
                            $nombre='BENEFICIARIO NO ENCONTRADO';
                        }

                    }



                    $fon .= '<tr>
        <td  align="left" colspan="5"><font color ="red"><strong>Beneficiario:</strong></font>&nbsp;&nbsp;&nbsp;' . $nombre . '</td>
        <td align="left" colspan="4" ><font color ="red"><strong>No. C&eacute;dula de Ciudadan&iacute;a del Empleado:</strong></font>&nbsp;&nbsp;&nbsp;' . $beneficiario . '</td>
        </tr>';
                    $fon .= '<tr>
        <td  align="rigth" colspan="3"><font color ="red"><strong>Valor:&nbsp;&nbsp;</strong></font></td>
        <td  align="center" colspan="2">' . $valor . '</td>
        <td  align="left" colspan="4"><font color ="red"><strong>Motivo:</strong></font>&nbsp;&nbsp;&nbsp;' . $motivo . '</td>
        </tr>';


                    $fon .= '<tr>
        <td  colspan="3" align="rigth"><font color ="red"><strong>Centro de Costos:&nbsp;&nbsp;</strong></font></td>
        <td  colspan="6" align="center">' . $ncosn . '</td>
        </tr>';

                } while ($oIfx->SiguienteRegistro());
                $fon .= '</table>';
            }
        }

    }//CIERRE IF FONDOS
    else {
        $fon = '';
    }


    //REEMBOLSOS

    if ($tipo == 3) {

        $svpag = "select sum(dpgs_vpag_dpgs) as svpag from saedpgs where dpgs_cod_pgs=$pedi";

        $tvpag = consulta_string_func($svpag, 'svpag', $oIfxA, 0);
        $tvpag=number_format($tvpag,2);

        if ($oIfx->Query($sql)) {
            if ($oIfx->NumFilas() > 0) {
                $nfact = $oIfx->f('dpgs_nfac_dpgs');
                $beneficiario = $oIfx->f('dpgs_ben_dpgs');
                $valor = $oIfx->f('dpgs_fval_dpgs');

                $sqlres = "select empl_ape_empl,empl_nom_empl  from saeempl where empl_cod_empl='$beneficiario'";

                $ape = consulta_string_func($sqlres, 'empl_ape_empl', $oIfxA, '');
                $nom = consulta_string_func($sqlres, 'empl_nom_empl', $oIfxA, '');
                $nombre = $nom . ' ' . $ape;
                if(empty($nom)){

                    $sqlprove="select clpv_nom_clpv from saeclpv where clpv_ruc_clpv='$beneficiario'";
                    $nombre = consulta_string_func($sqlprove, 'clpv_nom_clpv', $oIfxA, '');

                    if(empty($nombre)){
                        $nombre='BENEFICIARIO NO ENCONTRADO';
                    }

                }

                $rem .= '<table  border="1" cellpadding="1">';
                $rem .= '<tr style="background-color: #e02126;">
        <td align="center" colspan="4"><font color ="#ffffff"><strong>' . $ntipo . '</strong></font></td>
        </tr>';

                $rem .= '<tr>
        <td  align="left" colspan="2"><font color ="red"><strong>Beneficiario:</strong></font>&nbsp;&nbsp;&nbsp;' . $nombre . '</td>
        <td align="left" colspan="2" ><font color ="red"><strong>No. C&eacute;dula de Ciudadan&iacute;a del Empleado:</strong></font>&nbsp;&nbsp;&nbsp;' . $beneficiario . '</td>
        </tr>';
                $rem .= '<tr>
        <td  align="center" ><font color ="red"><strong>Seleccione la operaci&oacute;n</strong></font></td>
        <td  align="center">' . $operacion . '</td>
        <td  align="left" colspan="2"><font color ="red"><strong>Motivo:</strong></font>&nbsp;&nbsp;&nbsp;' . $motivo . '</td>
        </tr>';

                $rem .= '<tr>
        <td  align="rigth"><font color ="red"><strong>Centro de Costos:&nbsp;&nbsp;</strong></font></td>
        <td  align="center">' . $ncosn . '</td>
        <td  align="rigth"><font color ="red"><strong>Factura:&nbsp;&nbsp;</strong></font></td>
        <td  align="rigth">' . $nfact . '</td>
        </tr>';

                $rem .= '<tr>
        <td align="center" ><font color ="red"><strong>RUC</strong></font></td>
        <td align="center" ><font color ="red"><strong>Nombre<br>Proveedor</strong></font></td>
        <td align="center" ><font color ="red"><strong>No. Comprobante</strong></font></td>
        <td align="center" ><font color ="red"><strong>Valor Pagado</strong></font></td>      
        </tr>';

                do {

                    $ruc = $oIfx->f('dpgs_pruc_dpgs');
                    $npro = $oIfx->f('dpgs_npro_dpgs');
                    $ncom = $oIfx->f('dpgs_ncom_dpgs');
                    $vpag = $oIfx->f('dpgs_vpag_dpgs');
                    $vpag=number_format($vpag,2);




                    $rem .= '<tr>
            <td align="center" >' . $ruc . '</td>
            <td align="center" >' . $npro . '</td>
            <td align="center" >' . $ncom . '</td>
            <td align="center" >' . $vpag . '</td>      
            </tr>';

                } while ($oIfx->SiguienteRegistro());
                $rem .= '<tr>
          <td align="center" ><strong>Total</strong></td>
          <td align="center" ></td>
          <td align="center" ></td>
          <td align="center" >' . $tvpag . '</td>      
          </tr>';
                $rem .= '</table>';
            }
        }
    }//CIERRE IF REEMBOLSOS
    else {

        $rem = '';

    }

    //FACTURAS

    if ($tipo == 4) {

        $svpag = "select sum(dpgs_vpag_dpgs) as svpag from saedpgs where dpgs_cod_pgs=$pedi";
        $tvpag = consulta_string_func($svpag, 'svpag', $oIfxA, 0);

        $sql_cod_empl = "select pgs_cod_empl from saepgs where pgs_cod_pgs=$pedi";
        $pgs_cod_empl = consulta_string_func($sql_cod_empl, 'pgs_cod_empl', $oIfxA, '');

        $sql_empl = "select empl_ape_nomb from saeempl where empl_cod_empl='$pgs_cod_empl'";
        $empl_ape_nomb = consulta_string_func($sql_empl, 'empl_ape_nomb', $oIfxA, '');

        $tvpag=number_format($tvpag,2);
        if ($oIfx->Query($sql)) {
            if ($oIfx->NumFilas() > 0) {
                $nfact = $oIfx->f('dpgs_nfac_dpgs');
                $descripcion = $oIfx->f('dpgs_dcri_dpgs');

                $pfac .= '<table  border="1" cellpadding="1">';
                $pfac .= '<tr style="background-color: #e02126;">
        <td align="center" colspan="4"><font color ="#ffffff"><strong>' . $ntipo . '</strong></font></td>
        </tr>';

                $pfac .= '<tr>
        <td  align="left" colspan="2"><font color ="red"><strong>Responsable:</strong></font>&nbsp;&nbsp;&nbsp;' . $empl_ape_nomb . '</td>
        <td align="left" colspan="2" ><font color ="red"><strong>No. C&eacute;dula de Ciudadan&iacute;a del Empleado:</strong></font>&nbsp;&nbsp;&nbsp;' . $pgs_cod_empl . '</td>
        </tr>';

                $pfac .= '<tr>
        <td  width="15%" align="rigth"><font color ="red"><strong>Centro de Costos:&nbsp;&nbsp;</strong></font></td>
        <td  width="20%" align="center">' . $ncosn . '</td>
        <td  width="15%" align="left"><font color ="red"><strong>Descripci&oacute;n</strong></font></td>
        <td  width="50%" align="left">' . $descripcion . '</td>
        </tr>';

                $pfac .= '<tr>
        <td align="center" ><font color ="red"><strong>RUC</strong></font></td>
        <td align="center" ><font color ="red"><strong>Nombre<br>Proveedor</strong></font></td>
        <td align="center" ><font color ="red"><strong>No. Comprobante</strong></font></td>
        <td align="center" ><font color ="red"><strong>Valor Pagado</strong></font></td>      
        </tr>';

                do {

                    $ruc = $oIfx->f('dpgs_pruc_dpgs');
                    $npro = $oIfx->f('dpgs_npro_dpgs');
                    $ncom = $oIfx->f('dpgs_ncom_dpgs');
                    $vpag = $oIfx->f('dpgs_vpag_dpgs');
                    $vpag=number_format($vpag,2);

                    $beneficiario = $oIfx->f('dpgs_ben_dpgs');
                    $valor = $oIfx->f('dpgs_fval_dpgs');
                    $valor=number_format($valor,2);

                    $sqlres = "select empl_ape_empl,empl_nom_empl  from saeempl where empl_cod_empl='$beneficiario'";

                    $ape = consulta_string_func($sqlres, 'empl_ape_empl', $oIfxA, '');
                    $nom = consulta_string_func($sqlres, 'empl_nom_empl', $oIfxA, '');
                    $nombre = $nom . ' ' . $ape;

                    if(empty($nom)){

                        $sqlprove="select clpv_nom_clpv from saeclpv where clpv_ruc_clpv='$beneficiario'";
                        $nombre = consulta_string_func($sqlprove, 'clpv_nom_clpv', $oIfxA, '');

                        if(empty($nombre)){
                            $nombre='BENEFICIARIO NO ENCONTRADO';
                        }

                    }


                    $pfac .= '<tr>
            <td align="center" >' . $ruc . '</td>
            <td align="center" >' . $npro . '</td>
            <td align="center" >' . $ncom . '</td>
            <td align="center" >' . $vpag . '</td>      
            </tr>';

                } while ($oIfx->SiguienteRegistro());
                $pfac .= '<tr>
          <td align="center" ><strong>Total</strong></td>
          <td align="center" ></td>
          <td align="center" ></td>
          <td align="center" >' . $tvpag . '</td>      
          </tr>';
                $pfac .= '</table>';
            }
        }
    }//CIERRE PAGO FACTURAS
    else {

        $pfac = '';

    }

    //NOMINA

    if ($tipo == 5) {
        $svpag = "select sum(dpgs_mont_dpgs) as monto from saedpgs where dpgs_cod_pgs=$pedi";
        $tmonto = consulta_string_func($svpag, 'monto', $oIfxA, 0);
        $tmonto=number_format($tmonto,2);

        if ($oIfx->Query($sql)) {
            if ($oIfx->NumFilas() > 0) {
                $ant = $oIfx->f('dpgs_ant_dpgs');


                $descripcion = $oIfx->f('dpgs_dcri_dpgs');

                $pnom .= '<table  border="1" cellpadding="1">';
                $pnom .= '<tr style="background-color: #e02126;">
        <td align="center" colspan="4"><font color ="#ffffff"><strong>' . $ntipo . '</strong></font></td>
        </tr>';

                $pnom .= '<tr>
        <td   width="50%" align="left" colspan="2"><font color ="red"><strong>Responsable:</strong></font>&nbsp;&nbsp;&nbsp;' . $responsable . '</td>
        <td  width="50%" align="left"><font color ="red"><strong>Descripci&oacute;n:&nbsp;&nbsp;&nbsp;</strong></font>' . $descripcion . '</td>
        </tr>';

                $pnom .= '<tr>
        
        <td  width="70%" align="left"></td>
        <td  width="30%" align="left"><font color ="red"><strong>&nbsp;&nbsp;Anticipo:&nbsp;&nbsp;</strong></font>' . $ant . '</td>

        </tr>';


                do {

                    $beneficiario = $oIfx->f('dpgs_ben_dpgs');
                    $sqlres = "select empl_ape_empl,empl_nom_empl  from saeempl where empl_cod_empl='$beneficiario'";
                    $ape = consulta_string_func($sqlres, 'empl_ape_empl', $oIfxA, '');
                    $nom = consulta_string_func($sqlres, 'empl_nom_empl', $oIfxA, '');
                    $nombre = $nom . ' ' . $ape;
                    if(empty($nom)){

                        $sqlprove="select clpv_nom_clpv from saeclpv where clpv_ruc_clpv='$beneficiario'";
                        $nombre = consulta_string_func($sqlprove, 'clpv_nom_clpv', $oIfxA, '');

                        if(empty($nombre)){
                            $nombre='BENEFICIARIO NO ENCONTRADO';
                        }

                    }


                    $mes = $oIfx->f('dpgs_pmes_dpgs');
                    $monto = $oIfx->f('dpgs_mont_dpgs');
                    $monto=number_format($monto,2);


                    if ($ant == 'SI') {


                        $pnom .= '<tr>
                <td  align="left" width="60%"><font color ="red"><strong>Beneficiario:</strong></font>&nbsp;&nbsp;&nbsp;' . $nombre . '</td>
                    <td align="left" width="40%"><font color ="red"><strong>No. C&eacute;dula de Ciudadan&iacute;a del Empleado:</strong></font>&nbsp;&nbsp;&nbsp;' . $beneficiario . '</td>
                    </tr>';

                        $pnom .= '<tr>
                <td width="30%" align="center"><font color ="red"><strong>Plazo(meses)</strong></font></td>
                <td width="20%" align="center" >' . $mes . '</td>
                <td width="30%" align="center"><font color ="red"><strong>Monto</strong></font></td>
                <td width="20%" align="center" >' . $monto . '</td>
                </tr>';

                    } else {
                        $pnom .= '<tr>
                <td  align="center" width="50%"><font color ="red"><strong>Valor:</strong></font></td>
                    <td align="center" width="50%">' . $monto . '</td>
                    </tr>';
                    }


                } while ($oIfx->SiguienteRegistro());

                if ($ant == 'SI') {
                    $pnom .= '<tr>
        <td align="center" ><strong>Total</strong></td>
        <td></td>
        <td></td>
        <td align="center" >' . $total . '</td>      
        </tr>';
                } else {
                    $pnom .= '<tr>
        <td align="center" ><strong>Total</strong></td>
        <td align="center" >' . $total . '</td>      
        </tr>';

                }
                $pnom .= '</table>';
            }
        }


    }//CIERRE PAGO NOMINA
    else {

        $pnom = '';

    }

    //ANTICIPO PROVEEDORES -ANTICIPO JUNTAS-NOTAS DE CREDITO

    if ($tipo == 7 ||$tipo== 9||$tipo== 11) {

        if ($oIfx->Query($sql)) {
            if ($oIfx->NumFilas() > 0) {
                $antpro .= '<table  border="1" cellpadding="1">';

                $antpro .= '<tr style="background-color: #e02126;">
                <td align="center" colspan="9"><font color ="#ffffff"><strong>' . $ntipo . '</strong></font></td>
                </tr>';
                do {

                    $beneficiario = $oIfx->f('dpgs_pruc_dpgs');
                    $valor = $oIfx->f('dpgs_vpag_dpgs');
                    $valor=number_format($valor,2);

                    $sqlprove="select clpv_nom_clpv from saeclpv where clpv_ruc_clpv='$beneficiario'";


                    $nombre = consulta_string_func($sqlprove, 'clpv_nom_clpv', $oIfxA, '');



                    $antpro .= '<tr>
        <td  align="left" colspan="5"><font color ="red"><strong>Beneficiario:</strong></font>&nbsp;&nbsp;&nbsp;' . $nombre . '</td>
        <td align="left" colspan="4" ><font color ="red"><strong>No. C&eacute;dula de Ciudadan&iacute;a del Empleado:</strong></font>&nbsp;&nbsp;&nbsp;' . $beneficiario . '</td>
        </tr>';
                    $antpro .= '<tr>
        <td  align="rigth" colspan="3"><font color ="red"><strong>Valor:&nbsp;&nbsp;</strong></font></td>
        <td  align="center" colspan="2">' . $valor . '</td>
        <td  align="left" colspan="4"><font color ="red"><strong>Motivo:</strong></font>&nbsp;&nbsp;&nbsp;' . $motivo . '</td>
        </tr>';


                    $antpro .= '<tr>
        <td  colspan="3" align="rigth"><font color ="red"><strong>Centro de Costos:&nbsp;&nbsp;</strong></font></td>
        <td  colspan="6" align="center">' . $ncosn . '</td>
        </tr>';

                } while ($oIfx->SiguienteRegistro());
                $antpro .= '</table>';
            }
        }

    }//CIERRE IF FONDOS
    else {
        $antpro = '';
    }

    //OTROS -OTROS TC

    if ($tipo == 8 || $tipo == 10) {

        if ($oIfx->Query($sql)) {
            if ($oIfx->NumFilas() > 0) {
                $otros .= '<table  border="1" cellpadding="1">';

                $otros .= '<tr style="background-color: #e02126;">
                <td align="center" colspan="9"><font color ="#ffffff"><strong>' . $ntipo . '</strong></font></td>
                </tr>';
                do {

                    $valor = $oIfx->f('dpgs_vpag_dpgs');
                    $valor=number_format($valor,2);


                    $otros .= '<tr>
        <td  align="rigth" colspan="3"><font color ="red"><strong>Valor:&nbsp;&nbsp;</strong></font></td>
        <td  align="center" colspan="2">' . $valor . '</td>
        <td  align="left" colspan="4"><font color ="red"><strong>Motivo:</strong></font>&nbsp;&nbsp;&nbsp;' . $motivo . '</td>
        </tr>';


                    $otros .= '<tr>
        <td  colspan="3" align="rigth"><font color ="red"><strong>Centro de Costos:&nbsp;&nbsp;</strong></font></td>
        <td  colspan="6" align="center">' . $ncosn . '</td>
        </tr>';
                    $tiptc=intval($oIfx->f('dpgs_tip_tc'));
                    if($tiptc>0){
                        if($tiptc==1){
                            $nombtc='PASAJE AEREO';
                        }
                        elseif($tiptc==2){
                            $nombtc='OTROS TC';

                        }

                        $otros .= '<tr>
                    <td  colspan="3" align="rigth"><font color ="red"><strong>Tipo TC:&nbsp;&nbsp;</strong></font></td>
                    <td  colspan="6" align="center">' . $nombtc . '</td>
                    </tr>';

                    }

                } while ($oIfx->SiguienteRegistro());
                $otros .= '</table>';
            }
        }

    }//CIERRE IF FONDOS
    else {
        $otros = '';
    }








    if (!empty($pedi)) {

        //SOLICITANTE
        $sqlsol = "select pgs_cod_empl,pgs_fec_pgs from saepgs  where pgs_cod_pgs=$pedi";
        $csol = consulta_string_func($sqlsol, 'pgs_cod_empl', $oIfxA, '');


        $array_firma = firma_nomb_empleado($csol);

        foreach ($array_firma as $firma) {

            $logo1 = $firma[0];
            $soli = $firma[1];

        }

        //AUTORIZADOR GERENCIAL

        $sqlger = "select pgs_ager_pgs,pgs_fec_ger from saepgs  where pgs_cod_pgs=$pedi";
        $cger = consulta_string_func($sqlger, 'pgs_ager_pgs', $oIfxA, '');
        $fger = consulta_string_func($sqlger, 'pgs_fec_ger', $oIfxA, '');
        $fger= date('d-m-Y',strtotime($fger));
        $array_firma = firma_nomb_empleado($cger);
        foreach ($array_firma as $firma) {
            $logo2 = $firma[0];
            $eval = $firma[1];
        }

        // Post Aprobacion
        $sqlPostGer = "select pgs_ager_post,pgs_fec_postger from saepgs  where pgs_cod_pgs=$pedi";
        $cgerpost = consulta_string_func($sqlPostGer, 'pgs_ager_post', $oIfxA, '');
        $fgerpost = consulta_string_func($sqlPostGer, 'pgs_fec_postger', $oIfxA, '');
        $fgerpost = date('d-m-Y',strtotime($fgerpost));
        $array_firma = firma_nomb_empleado($cgerpost);
        foreach ($array_firma as $firma) {

            $logo2post = $firma[0];
            $evalpost = $firma[1];

        }

        //AUTORIZADOR FINANCIERO

        $sqlfin = "select pgs_afin_pgs,pgs_fec_fin from saepgs  where pgs_cod_pgs=$pedi";
        $cfin = consulta_string_func($sqlfin, 'pgs_afin_pgs', $oIfxA, '');
        $ffin = consulta_string_func($sqlfin, 'pgs_fec_fin', $oIfxA, '');
        $ffin= date('d-m-Y',strtotime($ffin));
        $array_firma = firma_nomb_empleado($cfin);
        foreach ($array_firma as $firma) {
            $logo3 = $firma[0];
            $adj = $firma[1];
        }


        // Post Aprobacion
        $sqlPostfin = "select pgs_afin_post,pgs_fec_postfin from saepgs  where pgs_cod_pgs=$pedi";
        $cfinpost = consulta_string_func($sqlPostfin, 'pgs_afin_post', $oIfxA, '');
        $ffinpost = consulta_string_func($sqlPostfin, 'pgs_fec_postfin', $oIfxA, '');
        $ffinpost= date('d-m-Y',strtotime($ffinpost));
        $array_firma = firma_nomb_empleado($cfinpost);
        foreach ($array_firma as $firma) {
            $logo3post = $firma[0];
            $adjpost = $firma[1];
        }


        //AUTORIZADOR GAF

        $sqlgaf = "select pgs_agaf_pgs,pgs_fec_gaf from saepgs  where pgs_cod_pgs=$pedi";
        $cgaf = consulta_string_func($sqlgaf, 'pgs_agaf_pgs', $oIfxA, '');
        $fgaf = consulta_string_func($sqlgaf, 'pgs_fec_gaf', $oIfxA, '');
        $fgaf= date('d-m-Y',strtotime($fgaf));
        $array_firma = firma_nomb_empleado($cgaf);
        foreach ($array_firma as $firma) {
            $logo4 = $firma[0];
            $gaf = $firma[1];
        }


        // Post Aprobacion
        $sqlPostgaf = "select pgs_agaf_post,pgs_fec_postgaf from saepgs  where pgs_cod_pgs=$pedi";
        $cgafpost = consulta_string_func($sqlPostgaf, 'pgs_agaf_post', $oIfxA, '');
        $fgafpost = consulta_string_func($sqlPostgaf, 'pgs_fec_postgaf', $oIfxA, '');
        $fgafpost= date('d-m-Y',strtotime($fgafpost));
        $array_firma = firma_nomb_empleado($cgafpost);
        foreach ($array_firma as $firma) {
            $logo4post = $firma[0];
            $gafpost = $firma[1];
        }

        //VALIDACION DE ESTADOS FIRMAS

        $sql="select pgs_est_pgs, pgs_est_post, pgs_est_soli, pgs_est_post_soli from saepgs where pgs_cod_pgs=$pedi";
        $est=consulta_string_func($sql, 'pgs_est_pgs', $oIfxA,0);
        $estpost=consulta_string_func($sql, 'pgs_est_post', $oIfxA,0);
        $pgs_est_soli=consulta_string_func($sql, 'pgs_est_soli', $oIfxA,0);
        $pgs_est_post_soli=consulta_string_func($sql, 'pgs_est_post_soli', $oIfxA,0);

        if($est==0){
            //FINANCIERA
            $logo3='';
            $adj='';
            $ffin='';
            //GERENCIA
            $logo2='';
            $eval='';
            $fger='';
            //GAF
            $logo4='';
            $gaf='';
            $fgaf='';

        }
        elseif($est==1){
            //GERENCIA
            $logo2='';
            $eval='';
            $fger='';
            //GAF
            $logo4='';
            $gaf='';
            $fgaf='';

        }
        elseif($est==2){
            //GAF
            $logo4='';
            $gaf='';
            $fgaf='';

        }

        // Validacion de firmas post aprobacion
        if($estpost==0){
            //FINANCIERA
            $logo3post='';
            $adjpost='';
            $ffinpost='';
            //GERENCIA
            $logo2post='';
            $evalpost='';
            $fgerpost='';
            //GAF
            $logo4post='';
            $gafpost='';
            $fgafpost='';

        }
        elseif($estpost==1){
            //GERENCIA
            $logo2post='';
            $evalpost='';
            $fgerpost='';
            //GAF
            $logo4post='';
            $gafpost='';
            $fgafpost='';

        }
        elseif($estpost==2){
            //GAF
            $logo4post='';
            $gafpost='';
            $fgafpost='';

        }


        //FECHA DE AUTORIZACION
        $fsol = consulta_string_func($sqlsol, 'pgs_fec_pgs', $oIfxA, '');

        $fsol = date("d-m-Y", strtotime($fsol));

        $html .= '<td style="font-size:80%;"align="center"><br><br><br><b>SOLICITUD DE PAGO Y / O DESPACHO</b><br> No. ' . $cpedi . '</td>   
    </tr> 
    <tr>
    <td style="font-size:80%;"align="left"><b>&nbsp;&nbsp;FECHA DE SOLICITUD: </b>' . $fsol . '</td>
    <td style="font-size:80%;"align="center"><b>&nbsp;&nbsp;AREA O PROYECTO SOLICITANTE:&nbsp;&nbsp;</b>' . $area . '</td>
    </tr>
    <tr>
    <td style="font-size:80%;"align="rigth"></td>
    </tr>
    </table>';

        //VARIABLES DE LAS TABLAS POR TIPO DE PAGO
        $html .= '' . $via . ' ' . $fon . ' ' . $rem . '' . $pfac . ' ' . $pnom . ' '.$antpro.' '.$otros.'';

        $html .= '
            <table  border="1"  cellpadding="1" >

            <tr>
                <td style="font-size:80%;" align="left" style="background-color: #e02126;"><font color ="#ffffff">Elaborado por:</font></td>
                <td style="font-size:80%;" align="left" style="background-color: #e02126;"><font color ="#ffffff">Presupuestado por:</font></td>
                <td style="font-size:80%;" align="left" style="background-color: #e02126;"><font color ="#ffffff">Aprobado por:</font></td>
                <td style="font-size:80%;" align="left" style="background-color: #e02126;"><font color ="#ffffff">Autorizado Aprobada por:</font></td>
            </tr>';

        $html .= '
            <tr>
                <td style="font-size:80%;" align="center" ><br><br><br><strong>' . $logo1 . '<br>____________________<br>' . $soli . '</strong><br>Fecha: '.$fsol.'<br><br></td>
                <td style="font-size:80%;" align="center" ><br><br><br><strong>' . $logo3 . '<br>____________________<br>' . $adj . '</strong><br>Fecha: '.$ffin.'<br><br></td>
                <td style="font-size:80%;" align="center" ><br><br><br><strong>' . $logo2 . '<br>____________________<br>' . $eval . '</strong><br>Fecha: '.$fger.'<br><br></td>
                <td style="font-size:80%;" align="center" ><br><br><br><strong>' . $logo4 . '<br>____________________<br>' . $gaf . '</strong><br>Fecha: '.$fgaf.'<br><br></td>
            </tr>

            <tr>
                <td style="font-size:80%;" align="center"><font color ="red"><strong>Solicitado Coordinador </strong></font></td>
                <td style="font-size:80%;" align="center"><font color ="red"><strong>Aprobaci&oacute;n Presupuestaria</strong></font></td>
                <td style="font-size:80%;" align="center"><font color ="red"><strong>Aprobaci&oacute;n Gerencia</strong></font></td>
                <td style="font-size:80%;" align="center"><font color ="red"><strong>Autorizaci&oacute;n GAF</strong></font></td>
            </tr>';

        // Verificamos que solamente cuando la post aprobacion de inicie, aparesca el otro cuadro de firmas
        if($pgs_est_post_soli > 0){
            $html .= '
                        <tr>
                            <td style="font-size:80%;" align="center" ><br><br><br><strong>' . $logo1 . '<br>____________________<br>' . $soli . '</strong><br>Fecha: '.$fviatico.'<br><br></td>
                            <td style="font-size:80%;" align="center" ><br><br><br><strong>' . $logo3post . '<br>____________________<br>' . $adjpost . '</strong><br>Fecha: '.$ffinpost.'<br><br></td>
                            <td style="font-size:80%;" align="center" ><br><br><br><strong>' . $logo2post . '<br>____________________<br>' . $evalpost . '</strong><br>Fecha: '.$fgerpost.'<br><br></td>
                            <td style="font-size:80%;" align="center" ><br><br><br><strong>' . $logo4post . '<br>____________________<br>' . $gafpost . '</strong><br>Fecha: '.$fgafpost.'<br><br></td>
                        </tr>

                        <tr>
                            <td style="font-size:80%;" align="center"><font color ="red"><strong>Solicitado Coordinador </strong></font></td>
                            <td style="font-size:80%;" align="center"><font color ="red"><strong>Aprobaci&oacute;n Post Presupuestaria</strong></font></td>
                            <td style="font-size:80%;" align="center"><font color ="red"><strong>Aprobaci&oacute;n Post Gerencia</strong></font></td>
                            <td style="font-size:80%;" align="center"><font color ="red"><strong>Autorizaci&oacute;n Post GAF</strong></font></td>
                        </tr>';
        }


        $html .= '</table>';



        if($id==1){
            return $html;

        }
        else{



            $pdf = new TCPDF('P', 'mm', 'A4', true, 'UTF-8', false);
            $pdf->setPrintHeader(false);
            $pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);
            //$pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);
            $pdf->SetMargins(10,5, 10, true);
            // set auto page breaks
            $pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);
            // set image scale factor
            $pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);
            // set font
            $pdf->SetFont('helvetica', 'N', 10);
            // add a page
            $pdf->AddPage();
            $pdf->writeHTMLCell(0, 0, '', '',$html, 0, 1, 0, true, '', true);


            $docu = 'solicitud_pago' . $pedi . '.pdf';
            $ruta = DIR_FACTELEC . 'Include/archivos';
            if (!file_exists($ruta)){
                mkdir($ruta);
            }
            $ruta = DIR_FACTELEC . 'Include/archivos/solicitudes_pagos';
            if (!file_exists($ruta)){
                mkdir($ruta);
            }

            $ruta=  DIR_FACTELEC . 'Include/archivos/solicitudes_pagos/'.$docu;
            $pdf->Output($ruta, 'F');
            return $ruta;

        }

    } else {
        $oReturn->alert('Seleccione un pedido..');


    }




}

// --------------------------------------------------------------------------------------------------------------
// FIN Documentos y formatos de las socilitudes de pago
// --------------------------------------------------------------------------------------------------------------

function reporte_factura_externo($id = '', $nombre_archivo = '', $idSucursal ='', &$rutaPdf = '',$idEmpresa) {
    global $DSN_Ifx, $DSN;

    if (session_status() !== PHP_SESSION_ACTIVE) {session_start();}

    $oIfx = new Dbo;
    $oIfx->DSN = $DSN_Ifx;
    $oIfx->Conectar();

    $oIfxA = new Dbo;
    $oIfxA->DSN = $DSN_Ifx;
    $oIfxA->Conectar();

    $oCon = new Dbo;
    $oCon->DSN = $DSN;
    $oCon->Conectar();


    //$idEmpresa = $_SESSION['U_EMPRESA'];
    //$idSucursal = $_SESSION['U_SUCURSAL'];

     //CAMPOS APROBACION
     $sqlgein="SELECT count(*) as conteo
     FROM INFORMATION_SCHEMA.COLUMNS
     WHERE COLUMN_NAME = 'empr_fac_empr' AND TABLE_NAME = 'saeempr'";
     $ctralter=consulta_string($sqlgein,'conteo',$oCon,0);
     if($ctralter==0){
         $sqlalter="alter table saeempr add  empr_fac_empr varchar(1)";
         $oCon->QueryT($sqlalter);
     }


     $sqlgein="SELECT count(*) as conteo
     FROM INFORMATION_SCHEMA.COLUMNS
     WHERE COLUMN_NAME = 'empr_det_fac' AND TABLE_NAME = 'saeempr'";
     $ctralter=consulta_string($sqlgein,'conteo',$oCon,0);
     if($ctralter==0){
         $sqlalter="alter table saeempr add  empr_det_fac text";
         $oCon->QueryT($sqlalter);
     }

     $sqlfa="select empr_fac_empr, empr_det_fac from saeempr where empr_cod_empr=$idEmpresa ";
     $obfact=consulta_string($sqlfa,'empr_fac_empr',$oCon,'');
     $obdetfact=consulta_string($sqlfa,'empr_det_fac',$oCon,'');

    $sql = "select empr_sn_conta, empr_cod_pais,empr_cm1_empr, empr_rimp_sn, empr_nom_empr, empr_ruc_empr , empr_dir_empr, empr_conta_sn, empr_num_resu, empr_path_logo, empr_iva_empr,empr_tel_resp, empr_ac1_empr, empr_ac2_empr, empr_mai_empr, empr_tip_empr, empr_cm2_empr
                                            from saeempr where empr_cod_empr = $idEmpresa ";

    //VALIDACION DETALLE

    $sqlfa="select para_dfa_para from saepara where para_cod_empr= $idEmpresa and para_cod_sucu=$idSucursal";
    $para_dfa_para=consulta_string($sqlfa,'para_dfa_para',$oCon,'');

  
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $razonSocial = trim($oIfx->f('empr_nom_empr'));
            $ruc_empr = $oIfx->f('empr_ruc_empr');
            $dirMatriz = trim($oIfx->f('empr_dir_empr'));
            $empr_path_logo = $oIfx->f('empr_path_logo');
            $tel_empresa = $oIfx->f('empr_tel_resp');
            $empr_mai_empr = $oIfx->f('empr_mai_empr');
            if ($oIfx->f('empr_conta_sn') == 'S')
                $empr_conta_sn = 'SI';
            else
                $empr_conta_sn = 'NO';
            $empr_rimp_sn = $oIfx->f('empr_rimp_sn');
            $empr_num_resu = $oIfx->f('empr_num_resu');
            $empr_iva_empr = $oIfx->f('empr_iva_empr');
            $empr_ac1_empr = $oIfx->f('empr_ac1_empr');
            $empr_ac2_empr = $oIfx->f('empr_ac2_empr');
            $empr_cm1_empr = $oIfx->f('empr_cm1_empr');
            $empr_cod_pais = $oIfx->f('empr_cod_pais');
            $empr_tip_empr = $oIfx->f('empr_tip_empr');
            $empr_cm2_empr = $oIfx->f('empr_cm2_empr');
            $empr_sn_conta = $oIfx->f('empr_sn_conta');
            
        }
    }
    $oIfx->Free();


    

    //  AMBIENTE - EMISION
    $sql = "select sucu_tip_ambi, sucu_tip_emis, sucu_telf_secu  from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    if ($oIfx->Query($sql)) {
        if ($oIfx->NumFilas() > 0) {
            $ambiente_sri = $oIfx->f('sucu_tip_ambi');
            $emision_sri = $oIfx->f('sucu_tip_emis');
            $sucu_telf_secu = $oIfx->f('sucu_telf_secu');
        }
    }
    $oIfx->Free();

    //VALIDACION SUSCURSALES

    $sqls="select count(*) as cont from saesucu";
    $contsucu=consulta_string($sqls,'cont',$oIfx,0);

    if ($ambiente_sri == 1) {
        $ambiente_sri = 'PRUEBAS';
    } elseif ($ambiente_sri == 2) {
        $ambiente_sri = 'PRODUCCION';
    }

    if ($emision_sri == 1) {
        $emision_sri = 'NORMAL';
    } elseif ($emision_sri == 2) {
        $emision_sri = 'POR INDISPONIBLIDAD DEL SISTEMA';
    }

    $path_img = explode("/", $empr_path_logo);
    $count = count($path_img) - 1;



    // $path_logo_img = DIR_FACTELEC . 'imagenes/logos/' . $path_img[$count];
    $path_logo_img = DIR_FACTELEC . 'Include/Clases/Formulario/Plugins/reloj/' . $path_img[$count];
    if (file_exists($path_logo_img)) {
        //echo "El fichero $nombre_fichero existe";
    } else {
        //echo "El fichero $nombre_fichero no existe";
        $path_logo_img = "https://turbologo.com/articles/wp-content/uploads/2019/05/no-logo.png";
    }
    //https://turbologo.com/articles/wp-content/uploads/2019/05/no-logo.png


    $logo .= '<table style="width: 100%; margin: 0px;">';
    $logo .= '<tr>';
    $logo .= '<td align="center" style="width: 55%; border:1px solid black; border-radius: 5px; margin: 0px;">';
    $logo .= '<table width: 55%; valign="center" style="margin: 0px;">';
    $logo .= '<tr><td style="margin-top: 0px;"><img width="250px;"  src="' . $path_logo_img . '"></td></tr>';
    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="left" style="font-size: 15px;" width="300"><b>Emisor:</b> ' . $razonSocial . '</td></tr>';

    $sqlxml = "select ixml_tit_ixml, ixml_det_ixml from saeixml where ixml_cod_empr=$idEmpresa 
				and ixml_est_deleted ='S' and ixml_sn_pdf='S' order by ixml_ord_ixml";

				if ($oIfx->Query($sqlxml)) {
					if ($oIfx->NumFilas() > 0) {
						do {
							$titulo  = $oIfx->f('ixml_tit_ixml');
							$detalle = $oIfx->f('ixml_det_ixml');
                            $logo .= '<tr><td align="center" style="font-size: 14px;" width="300"><b>'.$titulo.'</b> ' . $detalle . '</td></tr>';
						} while ($oIfx->SiguienteRegistro());
					}
				}
	$oIfx->Free();


    //$logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>RUC:</b> ' . $ruc_empr . '</td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= '<tr><td align="left" style="font-size: 13px;" width="500"><b>Matriz:</b> ' . $dirMatriz . '</td></tr>';
    //$logo .= '<tr><td>&nbsp;</td></tr>';


    //selecciona sucursales y direcciones
    $sql_sucu_matriz = "select sucu_dir_sucu from saesucu where sucu_nom_sucu ='MATRIZ'";
    $matriz = consulta_string($sql_sucu_matriz, 'sucu_dir_sucu', $oIfx, '');
    $sql_sucu = "select sucu_nom_sucu, sucu_dir_sucu from saesucu where sucu_cod_empr = $idEmpresa and sucu_cod_sucu = $idSucursal ";
    $emprce="select empr_num_resu from saeempr where empr_cod_empr=$idEmpresa";
    $contribuyente= consulta_string($emprce, 'empr_num_resu', $oIfx, '');
    if ($oIfx->Query($sql_sucu)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $sucu_nom_sucu = $oIfx->f('sucu_nom_sucu');
                $sucu_dir_sucu = $oIfx->f('sucu_dir_sucu');

                //$logo .= '<tr><td align="center" style="font-size: 12px">' . $sucu_nom_sucu . ': ' . htmlentities($sucu_dir_sucu) . '</td></tr>';
                //$logo .= '<tr><td align="center" style="font-size: 13px">SUCURSAL : ' . $sucu_nom_sucu . '</td></tr>';

                ///$logo .= '<tr><td style="position:top; width:50px;"><h4>Direccion Matriz:</h4></td></tr><br>';
                //$logo .= '<tr><td>' . htmlentities($dirMatriz) . '</td></tr>';
                if( $contsucu>1){
                    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>Sucursal:</b> ' . $sucu_nom_sucu . '</td></tr>';

                    $logo .= '<tr><td align="left" style="font-size: 13px;" width="500" ><b>Direcci&oacute;n Sucursal:</b>' . $sucu_dir_sucu.'</td></tr>';
                }





            } while ($oIfx->SiguienteRegistro());
        }
    }
    //$logo .= '<tr><td>&nbsp;</td></tr>';

    //DATOS ADICIONALES
    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>Correo:</b> ' .  $empr_mai_empr . '</td></tr>';

    $logo .= '<tr><td align="left" style="font-size: 13px;"><b>Tel&eacute;fono:</b> ' . $sucu_telf_secu . '</td></tr>';


    if ($empr_tip_empr == 'S') {
        $logo .= '<tr><td align="left" style="font-size: 12px;"><b>Contribuyente Especial #:</b> ' . $empr_num_resu . '</td></tr>';
    }//fin if*/
    /*if($empr_conta_sn=='SI'){
        $logo .= '<tr><td align="center" style="font-size: 12px;"><b>Contribuyente Especial #:</b> '.$contribuyente.'</td></tr>';
    }*/

    if(!empty($empr_ac2_empr)){
        $empr_ac2_empr = '<b>Agente de Retención Resolución Nro:</b> '.$empr_ac2_empr;
    }
    /*else{
        $empr_ac2_empr ='<b>AGENTE DE RETENCI&Oacute;N:</b> NO';
    }*/


    if($empr_conta_sn=='SI'){
        if($empr_sn_conta=='S'){
            $empr_sn_conta ='SI';
        }
        else{
            $empr_sn_conta ='NO';
        }
        $logo .= '<tr><td align="center" style="font-size: 12px;">Obligado a llevar Contabilidad :' . $empr_sn_conta . '</td></tr>';
    }
    //$logo .= '<tr><td>&nbsp;</td></tr>';
    if($empr_rimp_sn=="S"){
        $logo .= '<tr><td align="left" style="font-size: 12px;"><b>CONTRIBUYENTE R&Eacute;GIMEN RIMPE</b></td></tr>';
    }
    $logo .= '<tr><td align="left" style="font-size: 12px;">'.$empr_ac2_empr.'</td></tr>';

    if(!empty($empr_cm2_empr)){
        $logo .= '<tr><td align="left" style="font-size: 12px;"><b>'.$empr_cm2_empr.'</b></td></tr>';
    }

    $logo .= '<tr><td>&nbsp;</td></tr>';
    $logo .= ' </table>';
    $logo .= '</td>';

   
    $sqlgein = "SELECT count(*) as conteo
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE COLUMN_NAME = 'json_cab_pedi' AND TABLE_NAME = 'apipedi' AND TABLE_SCHEMA='apicomercial'";
    $ctralter = consulta_string($sqlgein, 'conteo', $oCon, 0);


    $sqlFac = "select * from saefact where fact_cod_fact = $id;";

    if ($oIfx->Query($sqlFac)) {
        if ($oIfx->NumFilas() > 0) {
            do {
                $fact_nse_fact = $oIfx->f('fact_nse_fact');
                $fact_num_preimp = $oIfx->f('fact_num_preimp');
                $fact_auto_sri = $oIfx->f('fact_auto_sri');
                $fact_fech_sri = $oIfx->f('fact_fech_sri');
                $fact_nom_cliente = $oIfx->f('fact_nom_cliente');
                $fact_fech_fact = fecha_mysql_func($oIfx->f('fact_fech_fact'));
                $fact_ruc_clie = $oIfx->f('fact_ruc_clie');
                $fact_tlf_cliente = $oIfx->f('fact_tlf_cliente');
                $fact_dir_clie = htmlentities($oIfx->f('fact_dir_clie'));
                $fact_email_clpv = str_replace(' ', '', $oIfx->f("fact_email_clpv"));
                $fact_con_miva = $oIfx->f('fact_con_miva');
                $fact_sin_miva = $oIfx->f('fact_sin_miva');
                $fact_tot_fact = $oIfx->f('fact_tot_fact');
                $fact_iva = $oIfx->f('fact_iva');
                $fact_ice = $oIfx->f('fact_ice');
                $fact_fina_fact = $oIfx->f('fact_fina_fact');
                $fact_clav_sri  = $oIfx->f('fact_clav_sri');
                $fact_dsg_valo  = $oIfx->f('fact_dsg_valo');
                $fact_cm1_fact  = trim($oIfx->f("fact_cm1_fact"));
                $fact_cm2_fact  = $oIfx->f("fact_cm2_fact");
                $fact_cm4_fact  = $oIfx->f("fact_cm4_fact");
                $orden_compra   = $oIfx->f("fact_opc_fact");
                $fact_cod_clpv  = $oIfx->f("fact_cod_clpv");
                $fact_cod_ccli  = $oIfx->f("fact_cod_ccli");
                $fact_dia_plazo = $oIfx->f("fact_dia_fact");
                $fact_fech_venc = fecha_mysql_func($oIfx->f("fact_fech_venc"));
                $fact_cm3_fact  = $oIfx->f("fact_cm3_fact");
                $fact_cod_contr = $oIfx->f("fact_cod_contr");


                $id_usuario_w = $oIfx->f("fact_user_web");
                $sql = "select usuario_user, usuario_nombre, usuario_apellido  from comercial.usuario where usuario_id = '$id_usuario_w' ";
                if($oCon->Query($sql)){
                    if($oCon->NumFilas() > 0){
                        $usuario=$codigo = $oCon->f('usuario_nombre').' '.$oCon->f('usuario_apellido');
                    }
                }

                $fact_tip_vent = $oIfx->f("fact_tip_vent");
                $sql = "select tcmp_cod_tcmp, tcmp_des_tcmp from saetcmp where tcmp_cod_tcmp = '$fact_tip_vent';";
                $tipo_text_fac= consulta_string($sql,'tcmp_des_tcmp', $oCon,'FACTURA');


                 //VALIDACION CODIGO DE ORDEN PEDIDOS FOOTLOOSE

                if ($ctralter != 0){
                    $fact_cod_pedf=$oIfx->f("fact_cod_pedf");
                    if(empty($fact_cod_pedf)){
                        $fact_cod_pedf='NULL';
                    }        

                    $sql="select pedi_id_json from saepedf where pedf_cod_pedf=$fact_cod_pedf";
                    $id_json=consulta_string($sql,'pedi_id_json', $oCon,'');

               

                    ///CODIGO DE LA ORDEN "codigo_order"
                    $sqlor="select json_cab_pedi from apicomercial.apipedi where json_id_pedi='$id_json'";
                    if ($oCon->Query($sqlor)) {
                        if ($oCon->NumFilas() > 0) {
                            $json_cab_pedi=json_decode($oCon->f('json_cab_pedi',false));
                            $codigo_orden=$json_cab_pedi->codigo_order;
        
                             
                        }
                        else{
                            $codigo_orden='';
                        }
                    }
                    
                        
                    }
                    else{
                        $codigo_orden="";
                    }

                $logo .= '<b><td style="width: 45%; border: 1px solid black; border-radius: 5px;" align="center">';
                $logo .= ' <table align="center" style="font-size: 15px;">';
                $logo .= ' <tr>';
                $logo .= '<td style="border-bottom: 1px inset black;">'.$tipo_text_fac.'</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>SERIE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . substr($fact_nse_fact, 0, 3) . '-' . substr($fact_nse_fact, 3, 6) . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="font-size: 17px; color: red; border-bottom: 1;">' . $fact_num_preimp . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fact_auto_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1">FECHA AUTORIZACION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td>' . $fact_fech_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= '<td style="border-top:1" >AMBIENTE:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $ambiente_sri . '</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td style="border-top:1" >EMISION:</td>';
                $logo .= ' </tr>';
                $logo .= ' <tr>';
                $logo .= ' <td>' . $emision_sri . '</td>';
                $logo .= ' </tr>';

                //verifica si existe clave de acceso
                if ($fact_clav_sri != '') {
                    $nombArch = $fact_nse_fact . $fact_num_preimp;
                    //$nombArch = '0112201401179141325300110010010000048101234567818';
                    // $rutaCodi = DIR_FACTELEC . 'Include/archivos/' . $nombArch . '.gif';
                    $rutaCodi = '../Include/archivos/' . $nombArch . '.gif';

                    new barCodeGenrator($fact_clav_sri, 1, $rutaCodi, 450, 100, true);

                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="center" style="font-size: 12px;">CLAVE DE ACCESO</td>';
                    $logo .= '</tr>';
                    $logo .= '<tr>';
                    $logo .= '<td colspan=2 align="center"> <img width="400px;" src="' . $rutaCodi . '"/></td>';
                    $logo .= '</tr>';
                }

                $logo .= ' </table>';
                $logo .= '</td></b>';
                $logo .= '</tr>';
                $logo .= '</table>';
                $logo .= ' <br>';

                $cliente .= ' <table style="width: 100%; border:1px solid black; border-radius: 5px; padding: 2px; font-size: 15x;">';
                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10%;">CLIENTE:</td></b>';
                $cliente .= ' <td style="width: 40%; ">' . $fact_nom_cliente . '</td>';
                $cliente .= ' <b><td style="width: 13%; ">FECHA EMISION:</td></b>';
                $cliente .= ' <td style="width: 37% ">' . $fact_fech_fact . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% ">RUC:</td></b>';
                $cliente .= ' <td style="width: 40% ">' . $fact_ruc_clie . '</td>';
                $cliente .= ' <b><td style="width: 13% ">TELEFONO:</td></b>';
                $cliente .= ' <td style="width: 37% ">' . $fact_tlf_cliente . '</td>';
                $cliente .= ' </tr>';

                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% ">DIRECCION:</td></b>';
                $cliente .= ' <td style="width: 40% ">' . $fact_dir_clie . '</td>';
                $cliente .= ' <b><td style="width: 13% ">EMAIL:</td></b>';
                $cliente .= ' <td style="width: 37% ">' . $fact_email_clpv . '</td>';
                $cliente .= ' </tr>';

                if(!empty($codigo_orden)){
                $cliente .= ' <tr>';
                $cliente .= ' <b><td style="width: 10% ">CODIGO DE ORDEN:</td></b>';
                $cliente .= ' <td style="width: 90% " colspan="3">' . $codigo_orden . '</td>';

                $cliente .= ' </tr>';
                }


                // -------------------------------------------------------------------------
                // campos fedexport solucion temporal borrar
                // -------------------------------------------------------------------------
                if($ruc_empr == 1790312143001 || $ruc_empr == 1791870158001){

                    $sql_oc = "SELECT orden_compra from contrato_clpv where id_clpv = $fact_cod_clpv and
                                id_empresa = $idEmpresa";
                    $orden_compra = consulta_string_func($sql_oc, 'orden_compra', $oIfxA, '');

                    $cliente .= ' <tr>';
                    $cliente .= ' <b><td style="width: 10% ">:</td></b>';
                    $cliente .= ' <td style="width: 48% "></td>';
                    $cliente .= ' <b><td style="width: 13% ">ORDEN DE COMPRA:</td></b>';
                    $cliente .= ' <td style="width: 29% ">' . $orden_compra . '</td>';
                    $cliente .= ' </tr>';

                }
                // -------------------------------------------------------------------------
                // FIn campos fedexport solucion temporar borrar
                // -------------------------------------------------------------------------


                $cliente .= ' </table>';

                $cliente .= ' <br>';
            } while ($oIfx->SiguienteRegistro());
        }
    }

    $oIfx->Free();

    $sqlDeta = "select * from saedfac where dfac_cod_fact = $id and 
                dfac_cod_sucu = $idSucursal and 
                dfac_cod_empr = $idEmpresa  ";


    $deta .= ' <table style="width: 100%; font-size: 13px; border-radius: 5px; border-collapse: collapse;" border="1">';
    $deta .= ' <tr>';
    $deta .= ' <b> <td style="width: 16%;" align="center">CODIGO</td> </b>';
    if($ctralter != 0){
        $deta .= ' <b> <td style="width: 12%;" align="center">CODIGO UNICO</td> </b>';
    }
    if($para_dfa_para==1){

    if($ctralter != 0){
        $deta .= ' <b> <td style="width: 38%;" align="center">DESCRIPCION</td> </b>';
    }
    else{
        $deta .= ' <b> <td style="width: 50%;" align="center">DESCRIPCION</td> </b>';
    }

    }
    else{
        if($ctralter != 0){
            $deta .= ' <b> <td style="width: 18%;" align="center">DESCRIPCION</td> </b>';
        }
        else{
            $deta .= ' <b> <td style="width: 30%;" align="center">DESCRIPCION</td> </b>';
        }
       
    }
    if($para_dfa_para==0){
    $deta .= ' <b> <td style="width: 20%;" align="center">DETALLE</td> </b>';
    }
    $deta .= ' <b> <td style="width:  8%;" align="center">CANT.</td> </b>';
    $deta .= ' <b> <td style="width:  8%;" align="center">PRECIO</td> </b>';
    $deta .= ' <b> <td style="width:  8%;" align="center">DSCTO</td> </b>';
    $deta .= ' <b> <td style="width: 10%;" align="center">TOTAL</td> </b>';
    $deta .= ' </tr>';
    $total_cant=0;
    if ($oIfx->Query($sqlDeta)) {
        if ($oIfx->NumFilas() > 0) {
            $porcIva = '';
            do {
                $dfac_cod_prod = $oIfx->f('dfac_cod_prod');
                $dfac_cod_lote = $oIfx->f('dfac_cod_lote');
                $dfac_nom_prod = $oIfx->f('dfac_nom_prod');
                $dfac_cant_dfac = $oIfx->f('dfac_cant_dfac');
                $total_cant+=$dfac_cant_dfac;
                $dfac_precio_dfac = $oIfx->f('dfac_precio_dfac');
                $dfac_des1_dfac = $oIfx->f('dfac_des1_dfac');
                $dfac_des2_dfac = $oIfx->f('dfac_des2_dfac');
                $dfac_por_dsg = $oIfx->f('dfac_por_dsg');
                $dfac_mont_total = $oIfx->f('dfac_mont_total');
                $dfac_num_comp = $oIfx->f('dfac_tip_dfac');
                $dfac_por_iva = $oIfx->f('dfac_por_iva');
                $dfac_det_dfac = $oIfx->f('dfac_det_dfac');

                if ($dfac_por_iva > 0) {
                    $porcIva = $dfac_por_iva;
                }

                $descuento = $dfac_des1_dfac + $dfac_des2_dfac + $dfac_por_dsg;
                if ($descuento > 0)
                    $descuento = ($dfac_precio_dfac * $dfac_cant_dfac) - ($dfac_mont_total);
                else
                    $descuento = 0;

                $totalDescuento = $totalDescuento + $descuento;


                if ($dfac_por_dsg > 0) {
                    $descuento1 = ($dfac_precio_dfac * $dfac_cant_dfac * $dfac_des1_dfac) / 100;
                    $descuento2 = 0;
                    $descuento3 = 0;

                    $dfac_mont_total = number_format((($dfac_precio_dfac * $dfac_cant_dfac) - ($descuento1 + $descuento2 + $descuento3)), 2, '.', '');

                }

                $dfac_det_dfac=str_replace(',',', ',$dfac_det_dfac);
                $dfac_nom_prod=str_replace(',',', ',$dfac_nom_prod);


                $deta .= ' <tr>';
                $deta .= ' <td style="width: 16%;">' . $dfac_cod_prod . '</td>';
                if($ctralter != 0){
                    $deta .= ' <td style="width: 12%;">' . $dfac_cod_lote . '</td>';
                }
                if($para_dfa_para==1){
                    if(empty($dfac_det_dfac)){
                        $dfac_det_dfac=$dfac_nom_prod;
                    }
                    if($ctralter != 0){
                        $deta .= ' <td style="width: 38%;">' . $dfac_det_dfac . '</td>';
                      }
                    else{
                            $deta .= ' <td style="width: 50%;">' . $dfac_det_dfac . '</td>';  
                        }

                  
                }
                

                if($para_dfa_para==0){
                    if($ctralter != 0){
                        $deta .= ' <td style="width: 18%;">' . $dfac_nom_prod . '</td>';

                    }
                    else{
                        $deta .= ' <td style="width: 30%;">' . $dfac_nom_prod . '</td>';  
                    }
              
                    $deta .= ' <td style="width: 20%;">' . $dfac_det_dfac . '</td>';  
              
                }
             $total=number_format($dfac_cant_dfac*$dfac_precio_dfac,4,'.',',');
                if(empty($dfac_des1_dfac)){
                    $dfac_des1_dfac=0;
                }
                $descuento=$total*$dfac_des1_dfac/100;

                /*$total_con_des=$total-$descuento;

                if($total>=$dfac_mont_total){
                    $total_dfac=$total_con_des;
                }else{
                    $total_dfac=$dfac_mont_total;
                }*/

                $deta .= ' <td style="width: 8%;" align="right">' . number_format($dfac_cant_dfac, 4, '.', ',') . '</td>';
                $deta .= ' <td style="width: 8%;" align="right">' . number_format($dfac_precio_dfac, 4, '.', ',') . '</td>';
                $deta .= ' <td style="width: 8%;" align="right">' . number_format($descuento, 4, '.', ',') . '</td>';
                $deta .= ' <td style="width: 10%;" align="right">' . number_format($dfac_mont_total, 4, '.', ',') . '</td>';
                $deta .= ' </tr>';
            }while ($oIfx->SiguienteRegistro());
            if($ruc_empr == '0190020304001' || $ruc_empr == '0190314294001'){
                $deta .= ' <tr>';
                $deta .= ' <td  colspan="2" align="right">TOTAL CANT:</td>';
                $deta .= ' <td  align="right">' . number_format($total_cant, 4, '.', ',') . '</td>';
                $deta .= ' <td></td>';
                $deta .= ' <td></td>';
                $deta .= ' <td></td>';
                $deta .= ' </tr>';
            

            }
        }
    }

    $deta .= ' </table>';

    if(!empty($fact_cm1_fact)){
        $fact_cm1_fact='<b>Observaciones:</b> '.$fact_cm1_fact;
    }

    $totales .='<table style="width: 100%;  font-size: 13px; margin-top: 3px;  align="center">';
    $totales .='<tr>
    <td  style="width: 50%; align="left"> '.$fact_cm1_fact.' </td>
    <td style="width: 50%; align="left">';

    $totales .= ' <table style="width: 195%; font-size: 13px; border-radius: 5px; border-collapse: collapse;"  border=1 align="right">';



    $totales .= ' <tr>';
    $totales .= ' <b> <td style="width: 25%;">SUBTOTAL:</td> </b>';
    $totales .= ' <td style="width: 10%;" align="right">' . number_format($fact_con_miva+$fact_sin_miva+$fact_dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>DESCUENTO:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_dsg_valo, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td style="width: 25%;">SUBTOTAL SIN IMPUESTOS:</td> </b>';
    $totales .= ' <td style="width: 10%;" align="right">' . number_format($fact_con_miva+$fact_sin_miva-$fact_ice, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>IVA ' . round($porcIva) . '%:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_iva, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>ICE:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_ice, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>IRBP:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_val_irbp, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>INTERES:</td> </b>';
    $totales .= ' <td align="right">' . number_format($fact_fina_fact, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';

    $totales .= ' <tr>';
    $totales .= ' <b> <td>TOTAL:</td> </b>';
    $fact_tot_fact = $fact_con_miva + $fact_iva+$fact_sin_miva + $fact_val_irbp + $fact_fina_fact;
    $totales .= ' <td align="right">' . number_format($fact_tot_fact, 2, '.', ',') . '</td>';
    $totales .= ' </tr>';
    $totales .= ' </table>';


    $totales.='</td>
    </tr>';
    $totales .='</table>';



    $sqltmp ='';
    if (!empty($fact_cod_contr)) {
        $sqltmp ="id_contrato = $fact_cod_contr AND";
    }

    $total = number_format($fact_con_miva + $fact_sin_miva + $fact_iva + $fact_fle_fact + $fact_otr_fact + $fact_fin_fact - $totalDescuento, 2, '.', '');
    $V = new EnLetras();
    $con_letra = strtoupper($V->ValorEnLetras($total, 'dolar'));

    //query forma de pago
    $sqlFPago = "select fp.fpag_cod_fpagop, fx.fxfp_val_fxfp, fx.fxfp_num_dias,
				fpg.fpagop_des_fpagop
				from saefact f, saefxfp fx, saefpag fp, saefpagop fpg
				where 
                f.fact_cod_fact = fx.fxfp_cod_fact and
				fp.fpag_cod_fpag = fx.fxfp_cod_fpag and
                f.fact_cod_empr = fpg.fpagop_cod_empr and
				fp.fpag_cod_fpagop = fpg.fpagop_cod_fpagop and
				f.fact_cod_empr = $idEmpresa and
				f.fact_cod_sucu = $idSucursal and
				f.fact_cod_fact = $id order by fx.fxfp_cod_fxfp";
    if ($oIfx->Query($sqlFPago)) {
        if ($oIfx->NumFilas() > 0) {
            $tablePago .= '<table style="width: 60%; border-collapse: collapse; margin-top: 10px;" border="1">';
            $tablePago .= '<tr>';
            $tablePago .= '<th style="width: 70%;">FORMA PAGO</th>';
            $tablePago .= '<th style="width: 30%;">VALOR</th>';
            $tablePago .= '<th style="width: 30%;">PLAZO</th>';
            $tablePago .= '<th style="width: 30%;">UNIDAD</th>';
            $tablePago .= '</tr>';
            do {
                $fpag_cod_fpagop    = $oIfx->f('fpag_cod_fpagop');
                $fxfp_val_fxfp      = $oIfx->f('fxfp_val_fxfp');
                $fxfp_num_dias      = $oIfx->f('fxfp_num_dias');
                $fpagop_des_fpagop  = $oIfx->f('fpagop_des_fpagop');

                $tablePago .= '<tr>';
                $tablePago .= '<td style="width: 70%;">' . $fpag_cod_fpagop . ' ' . htmlentities($fpagop_des_fpagop) . '</td>';
                $tablePago .= '<td style="width: 30%;" align="right">' . number_format($fxfp_val_fxfp, 2, '.', '') . '</td>';
                $tablePago .= '<td style="width: 30%;" align="right">' . round($fxfp_num_dias) . '</td>';
                $tablePago .= '<td style="width: 30%;" align="right">dias</td>';
                
                $tablePago .= '</tr>';
            } while ($oIfx->SiguienteRegistro());
            $tablePago .= '</table>';
        }
    }
    $oIfx->Free();

    if(!empty($empr_cm1_empr)){
        $msjCliente = $empr_cm1_empr;

        $msjCliente=str_replace('&&&correo&&&',$empr_mai_empr,$msjCliente);

        // LEEYNDA
        $tableLeyenda .= '<br /> <br /> <br />';
        $tableLeyenda .= '<table style="width: 98%; border-collapse: collapse; margin-top: 10px;" border="0">';
        $tableLeyenda .= '<tr>';
        $tableLeyenda .= '<td style="width: 98%;" align="center">'.$msjCliente.'</td>';
        $tableLeyenda .= '</tr>';
        $tableLeyenda .= '</table>';


    }

    if($obfact=='S'){

        $tableLeyenda .= '<table style="width: 98%; border-collapse: collapse; margin-top: 0px;" border="0">';
        $tableLeyenda .= '<tr>';
        $tableLeyenda .= '<td style="width: 98%;" align="left">'.$obdetfact.'</td>';
        $tableLeyenda .= '</tr>';
        $tableLeyenda .= '</table>';

    }

    $legend = '<page_footer>
        <table align="center" style="width: 80%">
            <tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">Este comprobante electronico ha sido generado a traves de Sisconti S.A. - Facturacion Electronica</td>
            </tr>
			<tr>
                <td style="font-size: 12px; color: #6B6565; background-color: transparent;" align="center">www.sisconti.com</td>
            </tr>
        </table>
    </page_footer>';

    $documento .= '<page backimgw="70%" backtop="10mm" backbottom="10mm" backleft="20mm" backright="10mm">';
    $documento .= $logo . $cliente . $deta . $totales . $tablePago. $tableLeyenda;
    $documento .= $legend;
    $documento .= '</page>';

   

    //file_put_contents("C:/prueba/documento.html", $documento);

    $html2pdf = new HTML2PDF('P', 'A3', 'fr');
    $html2pdf->WriteHTML($documento);
    $ruta = DIR_FACTELEC . 'Include/archivos/' . $nombre_archivo . '.pdf';
    $html2pdf->Output($ruta, 'F');
    $rutaPdf = $ruta;

    return $documento;
}


?>